<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v78.2 (Golden Config)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .step-section { display: none; animation: fadeIn 0.4s ease-out; }
    .step-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .input-label { display: block; font-weight: 600; color: #475569; margin-bottom: 0.25rem; font-size: 0.95rem; }
    .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 0.6rem 1rem; border-radius: 0.5rem; color: #1e293b; }
    .input-field:focus { border-color: #3b82f6; outline: none; ring: 2px solid rgba(59, 130, 246, 0.2); }
    .btn-primary { background: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; width: 100%; }
    .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #475569; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; width: 100%; }
    .help-link { color: #3b82f6; font-size: 0.85rem; text-decoration: underline; cursor: pointer; margin-top: 0.25rem; display: inline-block; }
    .help-box { display: none; background: #eff6ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; border: 1px solid #dbeafe; font-size: 0.9rem; color: #1e40af; }
    .progress-dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; background: #cbd5e1; transition: all 0.3s; }
    .progress-dot.active { background: #3b82f6; transform: scale(1.2); }
    .file-status { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-err { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <div class="text-center mb-8">
    <h1 class="text-3xl font-extrabold text-slate-800">OTG AppSuite Factory</h1>
    <p class="text-slate-500">v78.2 | Golden Configuration</p>
  </div>

  <div class="card max-w-3xl w-full p-8 relative">
    
    <div class="flex justify-center gap-4 mb-8">
      <div id="dot1" class="progress-dot active"></div>
      <div id="dot2" class="progress-dot"></div>
      <div id="dot3" class="progress-dot"></div>
      <div id="dot4" class="progress-dot"></div>
      <div id="dot5" class="progress-dot"></div>
    </div>

    <form id="factoryForm" onsubmit="return false;">

      <div id="step1" class="step-section active">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span> Organisation Setup
        </h2>
        <div class="space-y-5">
          <div>
            <label class="input-label">Organisation Name</label>
            <input type="text" id="orgName" class="input-field" placeholder="e.g. Acme Care" required>
          </div>
          <div>
            <label class="input-label">App Icon / Logo</label>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center border overflow-hidden">
                <img id="logoPreview" class="w-full h-full object-cover hidden">
                <span id="logoPlaceholder" class="text-2xl">üñºÔ∏è</span>
              </div>
              <input type="file" id="fLogo" class="text-sm text-slate-500" onchange="handleLogo(this)">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg">
             <div>
                <label class="input-label">Country Code</label>
                <input type="number" id="countryCode" class="input-field" value="64" placeholder="64">
             </div>
             <div>
                <label class="input-label">Timezone</label>
                <input type="text" id="timezone" class="input-field" value="Pacific/Auckland">
             </div>
          </div>
          <button onclick="nextStep(2)" class="btn-primary mt-2">Next: Safety & Features ‚Üí</button>
        </div>
      </div>

      <div id="step2" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span> Safety Protocols
        </h2>

        <div class="space-y-6">
          
          <div class="bg-red-50 p-4 rounded-lg border border-red-100">
             <label class="input-label text-red-900">Overdue Allowance (Escalation Minutes)</label>
             <input type="number" id="escMins" class="input-field border-red-200 focus:border-red-500" value="15">
             <p class="text-xs text-red-700 mt-1">If a worker is overdue by this many minutes, the Alarm is raised.</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
              <div>
                  <label class="input-label">Vehicle Checks</label>
                  <select id="vehEnabled" class="input-field" onchange="toggleVehInterval()">
                      <option value="true" selected>Enabled</option>
                      <option value="false">Disabled</option>
                  </select>
              </div>
              <div id="vehIntContainer">
                  <label class="input-label">Check Interval (Days)</label>
                  <input type="number" id="vehInterval" class="input-field" value="7">
              </div>
          </div>

          <div>
              <label class="input-label">Mileage Tracking</label>
              <select id="mileageEnabled" class="input-field">
                  <option value="true" selected>Enabled (GPS Odometer)</option>
                  <option value="false">Disabled</option>
              </select>
          </div>

          <hr class="border-slate-200">

          <div>
            <label class="input-label">Statistics Frequency</label>
            <select id="statsFreq" class="input-field">
                <option value="MONTHLY" selected>Monthly (1st of Month)</option>
                <option value="WEEKLY">Weekly (Monday)</option>
                <option value="DAILY">Daily (Midnight)</option>
            </select>
          </div>

          <div>
            <div class="flex justify-between items-center">
              <label class="input-label">Enable AI Grammar Check</label>
              <input type="checkbox" id="enableAi" class="w-5 h-5 text-blue-600" onchange="toggleAiUI()">
            </div>
            <div id="aiConfigBox" class="hidden mt-2">
               <input type="text" id="geminiKey" class="input-field" placeholder="Gemini API Key...">
               <div onclick="toggleHelp('helpGemini')" class="help-link">Get Free Key</div>
               <div id="helpGemini" class="help-box">Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-bold underline">Google AI Studio</a> to create a free API key.</div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="nextStep(1)" class="btn-secondary">Back</button>
            <button onclick="nextStep(3)" class="btn-primary">Next: Services ‚Üí</button>
          </div>
        </div>
      </div>

      <div id="step3" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">3</span> External Services
        </h2>
        <div class="space-y-5">
          <div>
            <label class="input-label">Master Secret Key</label>
            <div class="flex gap-2"><input type="text" id="secretKey" class="input-field bg-slate-50" readonly><button onclick="generateKey()" class="px-3 bg-slate-200 rounded">‚Üª</button></div>
          </div>
          <div>
            <label class="input-label">OpenRouteService Key (Maps)</label>
            <input type="text" id="orsKey" class="input-field" placeholder="5b3ce...">
            <div onclick="toggleHelp('helpOrs')" class="help-link">Get Free Map Key</div>
            <div id="helpOrs" class="help-box">Visit <a href="https://openrouteservice.org" target="_blank" class="font-bold underline">OpenRouteService.org</a></div>
          </div>
          <div>
            <label class="input-label">TextBelt Key (SMS)</label>
            <input type="text" id="textbeltKey" class="input-field" placeholder="textbelt_...">
            <div onclick="toggleHelp('helpSms')" class="help-link">SMS Info</div>
            <div id="helpSms" class="help-box">Leave blank for Free Mode (1 SMS/day). Buy key at TextBelt.com for reliability.</div>
          </div>
          <div>
            <label class="input-label">Google Drive Folder ID</label>
            <input type="text" id="folderId" class="input-field" placeholder="1vKz...">
            <div onclick="toggleHelp('helpDrive')" class="help-link">Finding Folder ID</div>
            <div id="helpDrive" class="help-box">Open Drive Folder -> Copy the code after the last slash in the URL bar.</div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="nextStep(2)" class="btn-secondary">Back</button>
            <button onclick="nextStep(4)" class="btn-primary">Next: Build ‚Üí</button>
          </div>
        </div>
      </div>

      <div id="step4" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">4</span> System Assets
        </h2>
        <div id="autoLoadSection" class="text-center py-6">
            <div class="mb-4 text-slate-600">Scanning local directory...</div>
            <div class="space-y-2 text-left max-w-md mx-auto">
                <div id="status_worker" class="file-status"><span>Worker App</span> <span class="status-badge status-pending">...</span></div>
                <div id="status_monitor" class="file-status"><span>Monitor App</span> <span class="status-badge status-pending">...</span></div>
                <div id="status_backend" class="file-status"><span>Backend Script</span> <span class="status-badge status-pending">...</span></div>
                <div id="status_guide" class="file-status"><span>User Guide</span> <span class="status-badge status-pending">...</span></div>
                <div id="status_manual" class="file-status"><span>Admin Manual</span> <span class="status-badge status-pending">...</span></div>
            </div>
            <div id="manualUpload" class="hidden mt-6 pt-6 border-t border-slate-200">
                <p class="text-red-500 text-sm mb-2 font-bold">‚ö†Ô∏è Auto-load blocked. Please upload manually.</p>
                <input type="file" id="fManualUpload" multiple class="block w-full text-sm text-slate-500" onchange="handleManualUpload(this)">
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="nextStep(3)" class="btn-secondary">Back</button>
            <button id="btnGenerate" onclick="generateApp()" class="btn-primary opacity-50 cursor-not-allowed" disabled>üöÄ DOWNLOAD SYSTEM</button>
        </div>
      </div>

      <div id="step5" class="step-section text-center py-10">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-slate-800">System Ready</h2>
        <p class="text-slate-500 mb-6">ZIP file downloaded.</p>
        <div class="bg-slate-800 text-slate-300 p-6 rounded text-left font-mono text-sm overflow-x-auto">
            1. Extract ZIP.<br>2. Create Google Sheet + Script.<br>3. Paste 'backend.js'.<br>4. Deploy Web App (Exec: Me, Access: Anyone).<br>5. Copy URL -> Worker App Wizard.
        </div>
        <button onclick="location.reload()" class="mt-6 text-slate-400 underline">Start Over</button>
      </div>

    </form>
  </div>

<script>
  let TEMPLATES = {'worker_template.html':null,'monitor_template.html':null,'backend_template.js':null,'guide_template.html':null,'ops_manual_template.html':null};
  window.onload=function(){generateKey();};
  function toggleHelp(id){const el=document.getElementById(id);el.style.display=el.style.display==='block'?'none':'block';}
  function toggleAiUI(){const c=document.getElementById('enableAi');document.getElementById('aiConfigBox').classList.toggle('hidden',!c.checked);}
  function toggleVehInterval(){const v=document.getElementById('vehEnabled').value;document.getElementById('vehIntContainer').classList.toggle('hidden',v==='false');}
  function generateKey(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<32;i++)r+=c.charAt(Math.floor(Math.random()*c.length));document.getElementById('secretKey').value=r;}
  function nextStep(n){document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));document.getElementById('step'+n).classList.add('active');document.querySelectorAll('.progress-dot').forEach((d,i)=>{d.classList.toggle('active',i<n)});if(n===4)attemptAutoLoad();}
  function handleLogo(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{TEMPLATES.logo=e.target.result;document.getElementById('logoPreview').src=e.target.result;document.getElementById('logoPreview').classList.remove('hidden');document.getElementById('logoPlaceholder').classList.add('hidden');};r.readAsDataURL(i.files[0]);}}
  
  async function attemptAutoLoad(){
      const files=[{id:'worker',f:'worker_template.html'},{id:'monitor',f:'monitor_template.html'},{id:'backend',f:'backend_template.js'},{id:'guide',f:'guide_template.html'},{id:'manual',f:'ops_manual_template.html'}];
      let success=0;
      for(let item of files){
          const b=document.querySelector(`#status_${item.id} .status-badge`);
          try{
              const r=await fetch('./'+item.f);
              if(!r.ok)throw new Error("404");
              TEMPLATES[item.f]=await r.text();
              b.className="status-badge status-ok";b.innerText="LOADED";success++;
          }catch(e){b.className="status-badge status-err";b.innerText="NOT FOUND";}
      }
      checkReady(success===5);
  }
  function checkReady(ok){
      const b=document.getElementById('btnGenerate');
      if(ok){b.disabled=false;b.classList.remove('opacity-50','cursor-not-allowed');document.getElementById('manualUpload').classList.add('hidden');}
      else{document.getElementById('manualUpload').classList.remove('hidden');if(Object.values(TEMPLATES).every(v=>v!==null)){b.disabled=false;b.classList.remove('opacity-50','cursor-not-allowed');}}
  }
  function handleManualUpload(input){
      Array.from(input.files).forEach(f=>{
          if(TEMPLATES.hasOwnProperty(f.name)){
              const r=new FileReader();
              r.onload=e=>{
                  TEMPLATES[f.name]=e.target.result;
                  let id=f.name.split('_')[0];
                  if(id==='ops')id='manual';
                  document.querySelector(`#status_${id} .status-badge`).className="status-badge status-ok";
                  document.querySelector(`#status_${id} .status-badge`).innerText="UPLOADED";
                  if(Object.values(TEMPLATES).every(v=>v!==null))checkReady(true);
              };
              r.readAsText(f);
          }
      });
  }

  async function generateApp(){
      const zip=new JSZip();
      const C={
          ORG:document.getElementById('orgName').value,
          SECRET:document.getElementById('secretKey').value,
          WORKER_KEY:"W_"+Math.random().toString(36).substr(2,9),
          ORS:document.getElementById('orsKey').value||"",
          GEMINI:document.getElementById('geminiKey').value||"",
          TEXTBELT:document.getElementById('textbeltKey').value||"",
          FOLDER:document.getElementById('folderId').value||"",
          ENABLE_AI:document.getElementById('enableAi').checked?"true":"false",
          COUNTRY:document.getElementById('countryCode').value||"64",
          TIMEZONE:document.getElementById('timezone').value||"Pacific/Auckland",
          STATS_FREQ:document.getElementById('statsFreq').value||"MONTHLY",
          ESCALATION:document.getElementById('escMins').value||"15",
          VEH_ENABLED:document.getElementById('vehEnabled').value,
          VEH_INT:document.getElementById('vehInterval').value||"7",
          MILEAGE:document.getElementById('mileageEnabled').value,
          LOGO:TEMPLATES.logo||""
      };

      // Backend Injection
      let backend=TEMPLATES['backend_template.js']
          .replace(/%%SECRET_KEY%%/g,C.SECRET).replace(/%%WORKER_KEY%%/g,C.WORKER_KEY)
          .replace(/%%ORS_API_KEY%%/g,C.ORS).replace(/%%GEMINI_API_KEY%%/g,C.GEMINI)
          .replace(/%%TEXTBELT_API_KEY%%/g,C.TEXTBELT).replace(/%%PHOTOS_FOLDER_ID%%/g,C.FOLDER)
          .replace(/%%ORGANISATION_NAME%%/g,C.ORG).replace(/%%TIMEZONE%%/g,C.TIMEZONE)
          .replace(/%%COUNTRY_CODE%%/g,C.COUNTRY).replace(/%%STATS_FREQ%%/g,C.STATS_FREQ)
          .replace(/%%ESCALATION_MINUTES%%/g,C.ESCALATION).replace(/%%ENABLE_AI%%/g,C.ENABLE_AI);
      zip.file("backend.js",backend);

      // Worker Injection
      let worker=TEMPLATES['worker_template.html']
          .replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%COUNTRY_CODE%%/g,C.COUNTRY)
          .replace(/%%LOGO_DATA%%/g,C.LOGO).replace(/%%WORKER_KEY%%/g,C.WORKER_KEY)
          .replace(/%%ORS_API_KEY%%/g,C.ORS)
          .replace(/%%ESCALATION_MINUTES%%/g,C.ESCALATION)
          .replace(/%%VEH_ENABLED%%/g,C.VEH_ENABLED).replace(/%%VEH_INTERVAL%%/g,C.VEH_INT)
          .replace(/%%MILEAGE_ENABLED%%/g,C.MILEAGE);
      const wf=zip.folder("WorkerApp");
      wf.file("index.html",worker);
      const sw=`const CACHE_NAME='otg-v78.2';const u=['./','./index.html','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(u)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>{return r||fetch(e.request)}))});`;
      wf.file("sw.js",sw);
      wf.file("manifest.json",JSON.stringify({name:C.ORG,short_name:"Safety",start_url:"./index.html",display:"standalone",background_color:"#111827",theme_color:"#1e40af",icons:[{src:"icon.png",sizes:"192x192",type:"image/png"},{src:"icon.png",sizes:"512x512",type:"image/png"}]}));
      wf.file("USER_GUIDE.html",TEMPLATES['guide_template.html'].replace(/%%ORG_NAME%%/g,C.ORG));
      if(C.LOGO)wf.file("icon.png",C.LOGO.split(',')[1],{base64:true});

      // Monitor Injection
      zip.folder("MonitorApp").file("index.html",TEMPLATES['monitor_template.html'].replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%LOGO_URL%%/g,C.LOGO));
      
      // Manual Injection
      zip.file("ADMIN_MANUAL.html",TEMPLATES['ops_manual_template.html'].replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%SECRET_KEY%%/g,C.SECRET).replace(/%%WORKER_KEY%%/g,C.WORKER_KEY));

      zip.generateAsync({type:"blob"}).then(c=>{
          const l=document.createElement("a");l.href=URL.createObjectURL(c);l.download=`OTG_AppSuite_${C.ORG.replace(/\s+/g,'_')}.zip`;l.click();nextStep(5);
      });
  }
</script>
</body>
</html>
