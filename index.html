<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.35 (Master Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; font-weight: 700; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #94a3b8; border-bottom: 4px solid transparent; transition: all 0.2s; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; font-weight: 700; }
    .drop-zone { border: 4px dashed #475569; border-radius: 16px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .preset-swatch { width: 56px; height: 56px; border-radius: 12px; cursor: pointer; border: 3px solid rgba(255,255,255,0.2); transition: all 0.1s; display: flex; overflow: hidden; }
    .swatch-half { flex: 1; height: 100%; }
    .help-text { color: #ffffff !important; font-weight: 800; font-size: 11px; margin-top: 4px; line-height: 1.3; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2 uppercase">‚ö†Ô∏è Safety Notice</h2>
          <div class="space-y-4 text-gray-200 text-sm mb-6 font-bold">
              <p>Active Use tracking requires staff to keep the app active on the device. Emergency alerts require internet data and valid API keys.</p>
          </div>
          <div class="pt-4 border-t border-gray-700 font-bold">
              <label class="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-300 uppercase">I accept these requirements.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-4 bg-gray-700 text-gray-500 font-extrabold rounded-xl transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="modal-backdrop">
      <div class="modal-content border-blue-500">
          <h2 class="text-xl font-extrabold text-white mb-4 uppercase">üìÇ Folder ID Help</h2>
          <p class="text-sm text-white font-bold mb-4">Copy the string at the end of your Drive folder URL:</p>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all font-bold">drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong></div>
          <button onclick="closeModal('driveHelpModal')" class="w-full py-3 bg-blue-600 text-white font-extrabold rounded-xl">Got it</button>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2 uppercase">OTG AppSuite Factory</h1>
      <p class="text-white font-extrabold tracking-widest text-sm uppercase">Lone Worker Compiler v79.35</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Build</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-6">
              <div><label class="block text-blue-300 font-extrabold mb-1 text-xs uppercase tracking-widest">1. Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              <div><label class="block text-blue-300 font-extrabold text-xs uppercase mb-1">2. App Icon Label</label><input type="text" id="appName" maxlength="12" class="input-field text-center font-black text-green-400" value="Safety" oninput="saveInput(this)"></div>
              <div class="p-4 bg-gray-900 rounded-2xl border border-gray-700 shadow-inner"><h3 class="text-white font-black mb-4 uppercase text-[10px] tracking-widest">üîê Security Keys</h3><div class="mb-4"><label class="block text-blue-300 font-extrabold mb-1 text-xs">Secret Admin Key</label><input type="text" id="secretKey" class="input-field text-yellow-400 py-2" oninput="saveInput(this)"></div><div><label class="block text-blue-300 font-extrabold mb-1 text-xs">Worker App Key</label><input type="text" id="workerKey" class="input-field text-green-400 py-2" oninput="saveInput(this)"></div></div>
              <div><label class="block text-blue-300 font-extrabold mb-1 text-xs uppercase tracking-widest">3. Regional Logic</label><select id="countrySelect" class="input-field cursor-pointer py-3 text-sm font-black" onchange="updateRegionInfo()"><option value="+64">New Zealand (+64)</option><option value="+61">Australia (+61)</option><option value="+44">United Kingdom (+44)</option><option value="+1">USA / Canada (+1)</option></select><div class="mt-2 bg-gray-900 p-3 rounded text-[10px] text-white grid grid-cols-2 gap-2 border border-gray-800 font-black font-mono"><p>Timezone: <span id="detectedTz" class="text-blue-400">...</span></p><p>Term: <span id="vehTermDisplay" class="text-green-400">WOF</span></p><p>Voice: <span id="voiceLocaleDisplay" class="text-yellow-400">en-NZ</span></p><p>Prefix: <span id="phoneFmtDisplay" class="text-purple-400">+64</span></p></div><input type="hidden" id="timezoneVal"></div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-extrabold mb-3 text-sm uppercase tracking-widest">4. App Branding</label>
              <div id="dropZone" class="drop-zone w-40 h-40 mx-auto rounded-full flex items-center justify-center mb-4 border-4" onclick="document.getElementById('logoInput').click()"><img id="logoImg" class="hidden h-full w-full object-cover"><span id="logoText" class="text-white text-[11px] uppercase font-black px-4 leading-tight">Click to Upload Logo</span></div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)"><input type="hidden" id="logoUrl" oninput="saveInput(this)">

              <div id="paletteArea" class="hidden w-full bg-gray-900/50 p-6 rounded-3xl border border-gray-700 shadow-inner">
                <div class="flex justify-between items-center mb-4"><span class="text-[10px] text-gray-200 font-black uppercase tracking-widest">1. Brand Pairs</span><button onclick="triggerResample()" class="text-[10px] text-blue-400 font-black hover:underline">‚Üª Resample</button></div>
                <div class="flex gap-4 justify-center mb-6" id="logoClusterSwatches"></div>
                <div class="pt-6 border-t border-gray-800 flex gap-10 justify-center items-center mb-8">
                    <div class="flex flex-col items-center gap-2"><div id="primaryColorBox" class="w-10 h-10 rounded-xl border border-white/20"></div><span class="text-[8px] text-gray-400 font-black uppercase">Primary</span></div>
                    <div class="flex flex-col items-center gap-2"><div id="accentColorBox" class="w-10 h-10 rounded-xl border border-white/20"></div><span class="text-[8px] text-gray-400 font-black uppercase">Accent</span></div>
                </div>

                <h3 class="text-white font-black mb-4 uppercase text-[10px] tracking-widest text-center">üì± Live App Preview</h3>
                <div id="appMockup" class="mx-auto w-64 h-[400px] rounded-[2.5rem] border-[6px] border-gray-900 bg-[#111827] shadow-2xl overflow-hidden relative">
                    <div id="mockHeader" class="h-10 border-b border-gray-700 flex items-center px-4 justify-between bg-[#111827]"><div class="flex items-center gap-2"><img id="mockLogo" src="" class="w-4 h-4 rounded-sm bg-white object-contain hidden"><span id="mockOrgName" class="text-[10px] font-bold text-white truncate max-w-[100px]">Organisation</span></div><div class="w-2 h-2 rounded-full bg-gray-700"></div></div>
                    <div class="p-4 space-y-4"><div id="mockTravelCard" class="h-8 rounded-lg border border-gray-700"></div><div id="mockAccentCard" class="h-20 border-2 rounded-lg p-2 shadow-lg"></div></div> 
                    <div id="mockFooter" class="absolute bottom-0 w-full p-4 border-t border-gray-700 bg-[#111827]"><div id="mockMainBtn" class="h-10 w-full rounded-xl flex items-center justify-center font-black text-[10px] text-white uppercase shadow-lg">Start Visit</div></div>
                </div>

                <p class="text-[10px] text-gray-400 mt-6 uppercase font-black mb-3 tracking-[0.2em] text-center border-t border-gray-800 pt-4">Enterprise Safe Fallbacks</p>
                <div class="flex gap-4 justify-center" id="fallbackSwatches">
                    <div class="preset-swatch" onclick="applyPreset('#1e40af', '#3b82f6', this)"><div class="swatch-half bg-[#1e40af]"></div><div class="swatch-half bg-[#3b82f6]"></div></div>
                    <div class="preset-swatch" onclick="applyPreset('#064e3b', '#10b981', this)"><div class="swatch-half bg-[#064e3b]"></div><div class="swatch-half bg-[#10b981]"></div></div>
                    <div class="preset-swatch" onclick="applyPreset('#450a0a', '#ef4444', this)"><div class="swatch-half bg-[#450a0a]"></div><div class="swatch-half bg-[#ef4444]"></div></div>
                </div>
              </div> 
            </div>
          </div> <div class="highlight-box border-blue-500/30 mt-8">
            <div class="flex items-center gap-3 mb-6">üõ°Ô∏è<h3 class="text-xl font-black text-white uppercase tracking-widest">Safety & Fleet Options</h3></div>
            <div class="grid md:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <div><label class="block text-white font-black text-xs uppercase mb-2">Alarm Grace Period (Mins)</label><input type="number" id="escalationMins" value="15" class="input-field w-24 text-center font-black" oninput="saveInput(this)"></div>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer font-black uppercase text-xs"><input type="checkbox" id="chkMileage" onchange="saveInput(this)" checked> Mileage Tracking</label>
                        <label class="flex items-center gap-3 cursor-pointer font-black uppercase text-xs"><input type="checkbox" id="chkVehicle" onchange="saveInput(this)" checked> Vehicle Maintenance</label>
                        <label class="flex items-start gap-3 cursor-pointer pt-4 border-t border-gray-700"><input type="checkbox" id="chkRedaction" class="mt-1 w-6 h-6 rounded bg-gray-700" onchange="saveInput(this)" checked><div><span class="text-sm font-black text-white uppercase tracking-widest">AI Privacy Redaction</span><p class="text-[10px] text-red-400 font-black uppercase mt-1">Removes names before sending to AI.</p></div></label>
                    </div>
                </div>
                <div class="space-y-6">
                    <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase">Textbelt Key</label><a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="input-field py-2 text-xs font-mono font-bold" oninput="saveInput(this)"></div>
                    <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase">Gemini AI Key</label><a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a></div><input type="text" id="geminiKey" class="input-field py-2 text-xs font-mono font-bold" oninput="saveInput(this)"></div>
                    <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase">ORS Key</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="input-field py-2 text-xs font-mono font-bold" oninput="saveInput(this)"></div>
                    <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase">Drive Folder ID</label><a onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link">Where?</a></div><input type="text" id="folderId" class="input-field py-2 text-xs font-mono font-bold" oninput="saveInput(this)"></div>
                </div>
            </div>
          </div>

          <div class="flex justify-end pt-12"><button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12 shadow-2xl font-black uppercase">Next: Database Setup ‚Üí</button></div>
        </div> <div id="step2" class="step-section">
            <div class="highlight-box border-green-500/30 text-center py-12">
                <h2 class="text-3xl font-black text-white mb-6 uppercase tracking-tighter">Option A: Automated Setup</h2>
                <button onclick="openMagicLink()" class="btn btn-success text-xl px-16 py-6 shadow-2xl transform hover:-translate-y-1 font-black uppercase tracking-widest">‚ú® Create Database Copy</button>
            </div>
            <div class="border border-gray-700 rounded-2xl p-6 bg-gray-900/30 shadow-inner mt-8">
                <button onclick="document.getElementById('manualSetup').classList.toggle('hidden')" class="w-full flex justify-between items-center text-gray-400 hover:text-white font-black uppercase tracking-[0.2em] text-xs"><span>Option B: Manual Setup Blueprints</span><span>‚ñº</span></button>
                <div id="manualSetup" class="hidden mt-8 space-y-6">
                    <div class="grid md:grid-cols-2 gap-6 text-center font-black">
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-blue-400 text-xs mb-3 uppercase tracking-widest">Visits Tab</h3><button onclick="copyData('Visits')" class="w-full bg-blue-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-green-400 text-xs mb-3 uppercase tracking-widest">Staff Tab</h3><button onclick="copyData('Staff')" class="w-full bg-green-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-yellow-400 text-xs mb-3 uppercase tracking-widest">Sites Tab</h3><button onclick="copyData('Sites')" class="w-full bg-yellow-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-purple-400 text-xs mb-3 uppercase tracking-widest">Templates Tab</h3><button onclick="copyData('Templates')" class="w-full bg-purple-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between pt-12"><button onclick="gotoStep(1)" class="text-white font-black uppercase text-xs">Back</button><button onclick="gotoStep(3)" class="btn btn-primary font-black uppercase">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-10">
            <div class="highlight-box border-purple-500/30 text-center">
                <h2 class="text-3xl font-black text-white mb-8 uppercase tracking-tighter">1. Connect System Brain</h2>
                <button onclick="copyScript()" class="btn bg-blue-600 text-white w-full py-4 text-lg font-black shadow-2xl uppercase">üìã COPY SYSTEM CODE</button>
                <div id="codeContainer" class="hidden mt-4 text-left"><pre id="codeDisplay" class="code-scroll">Generating...</pre></div>
                
                <div class="mt-12 space-y-6 pt-8 border-t border-gray-800">
                    <label class="block text-green-400 font-black uppercase tracking-widest text-sm mb-4">2. Paste Deployment URL Here:</label>
                    <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)">
                    <button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white w-full py-4 font-black shadow-2xl uppercase">üì° TEST SYSTEM CONNECTION</button>
                    <div id="testResult" class="hidden mt-4 p-4 rounded-xl font-black text-center uppercase"></div>
                </div>
            </div>
            <div class="flex justify-between pt-12"><button onclick="gotoStep(2)" class="text-white font-black uppercase text-xs">Back</button><button onclick="gotoStep(4)" class="btn btn-primary font-black uppercase">Next: Build Bundle ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center"><div class="highlight-box"><h2 class="text-3xl font-black text-white mb-4 uppercase">Step 4: Compiling</h2><button onclick="downloadZip()" class="btn btn-primary text-xl px-16 py-6 shadow-2xl uppercase font-black">üöÄ Build AppSuite (.ZIP)</button></div><div class="flex justify-start pt-12"><button onclick="gotoStep(3)" class="text-white font-black uppercase text-xs">Back</button></div></div>
        <div id="step5" class="step-section"><div class="highlight-box"><h2 class="text-3xl font-black text-white mb-8 uppercase text-center">Step 5: Deployment Pack</h2><div id="launchPack" class="grid md:grid-cols-2 gap-8"><div><h4 class="text-xs font-black uppercase text-slate-400 mb-4">Install QR</h4><img id="qrImage" src="" class="mx-auto bg-white p-4 rounded-xl w-44 h-44"></div><div><h4 class="text-xs font-black uppercase text-slate-400 mb-4">Announcement Body</h4><textarea id="launchEmail" class="w-full h-44 bg-slate-900 border border-slate-700 rounded-lg p-4 text-xs text-gray-300" readonly></textarea></div></div></div></div>

      </div>
    </div>
  </div>

<script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    const BLUEPRINTS = {
        Visits: `Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tAlarm Status\tNotes\tLocation Name\tLocation Address\tGPS Timestamp\tBattery Level\tPhoto 1`,
        Staff: `Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck`,
        Sites: `Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone`,
        Templates: `Type\tTemplate Name\tAssigned To\tEmail Recipient\tQuestion 1\tQuestion 2`,
    };
    let TEMPLATES = {};
    const REGION_DATA = { "+64": { term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" }, "+61": { term: "Rego", locale: "en-AU", tz: "Australia/Sydney" }, "+44": { term: "Inspection", locale: "en-GB", tz: "Europe/London" }, "+1": { term: "Inspection", locale: "en-US", tz: "America/New_York" } };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        const mc = document.getElementById('mainContent'); if(mc) mc.classList.remove('blur-sm');
        loadPersistedData();
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) { try { const r = await fetch(f + "?v=" + Date.now()); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){} }
    };

    // FIXED: Full injection chain for ALL 12 required keys
    function generateScript() {
        if(!TEMPLATES.backend) return;
        const d = document.getElementById('codeDisplay'); if(!d) return;
        d.textContent = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value)
            .replace('%%ENABLE_REDACTION%%', document.getElementById('chkRedaction').checked)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term)
            .replace('%%COUNTRY_PREFIX%%', document.getElementById('countrySelect').value)
            .replace('%%LOCALE%%', selectedConfig.locale);
    }

    // SYSTEM CONNECTION TEST
    function testConnection() {
        const url = document.getElementById('webAppUrl').value, res = document.getElementById('testResult');
        if(!url) return; res.classList.remove('hidden'); res.textContent = "Testing..."; res.className = "mt-4 p-4 rounded-xl bg-gray-900 text-yellow-400 font-black uppercase";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value)).then(r => r.json()).then(d => {
            if(d.status === "success") { res.textContent = "‚úÖ Success!"; res.className = "mt-4 p-4 rounded-xl bg-green-900 text-white font-black"; }
        }).catch(() => { res.textContent = "‚ùå Failed."; res.className = "mt-4 p-4 rounded-xl bg-red-900 text-white font-black"; });
    }

    // NULL-SAFE UI UPDATES
    function updateRegionInfo() {
        const sel = document.getElementById('countrySelect'); if(!sel) return;
        selectedConfig = REGION_DATA[sel.value] || REGION_DATA["+64"];
        const tz = document.getElementById('detectedTz'), term = document.getElementById('vehTermDisplay'), ph = document.getElementById('phoneFmtDisplay'), voc = document.getElementById('voiceLocaleDisplay');
        if(tz) tz.textContent = selectedConfig.tz; if(term) term.textContent = selectedConfig.term; if(voc) voc.textContent = selectedConfig.locale; if(ph) ph.textContent = sel.value;
        const tzv = document.getElementById('timezoneVal'); if(tzv) tzv.value = selectedConfig.tz;
    }

    function updateMockupUI() {
        const org = document.getElementById('orgName'), logo = document.getElementById('logoUrl'), p = localStorage.getItem('otg_theme_primary') || "#1e40af", a = localStorage.getItem('otg_theme_accent') || "#3b82f6";
        const mon = document.getElementById('mockOrgName'); if(mon && org) mon.innerText = org.value || "Organisation";
        const ml = document.getElementById('mockLogo'); if(ml && logo && logo.value) { ml.src = logo.value; ml.classList.remove('hidden'); }
        const h = document.getElementById('mockHeader'), f = document.getElementById('mockFooter'), b = document.getElementById('mockMainBtn');
        if(h) h.style.backgroundColor = p; if(f) f.style.backgroundColor = p; if(b) b.style.backgroundColor = a;
        const ac = document.getElementById('mockAccentCard'); if(ac) { ac.style.borderColor = a; ac.style.backgroundColor = a + '33'; }
    }

    // REMAINING UTILITIES
    function copyScript() { generateScript(); const d = document.getElementById('codeDisplay'); if(d){ navigator.clipboard.writeText(d.textContent); alert("Copied!"); } }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); const s = document.getElementById('step'+n); if(s) s.classList.add('active'); for(let i=1; i<=5; i++){ const t = document.getElementById('tab'+i); if(t) t.classList.toggle('active', i===n); } if(n===3) generateScript(); }
    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value); if(el.id==='orgName'||el.id==='logoUrl') updateMockupUI(); }
    function loadPersistedData() { ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'textbeltKey', 'orsKey', 'folderId', 'escalationMins', 'countrySelect', 'appName'].forEach(id => { const el = document.getElementById(id), v = localStorage.getItem('otg_' + id); if(el && v) el.value = v; }); }
    function closeModal(id) { const m = document.getElementById(id); if(m) m.style.display = 'none'; document.getElementById('mainContent').classList.remove('blur-sm'); }
    function toggleEnterBtn() { const chk = document.getElementById('chkAccept'); const btn = document.getElementById('btnEnter'); if(chk && btn) btn.disabled = !chk.checked; }
    function copyData(k) { navigator.clipboard.writeText(BLUEPRINTS[k]); alert(k + " Blueprint Copied!"); }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function setupDragDrop() { /* Drag drop logic */ }
    function handleLogo(input) { /* Logo reader logic */ }
    function triggerResample() { /* Color extraction logic */ }
    function applyPreset(p, a, el) { localStorage.setItem('otg_theme_primary', p); localStorage.setItem('otg_theme_accent', a); updateMockupUI(); }
    function downloadZip() { alert("Compiling AppSuite..."); }
</script>
</body>
</html>
