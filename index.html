<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTG Factory v70.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .step-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 20px; transition: all 0.2s; }
        .step-card:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .step-num { background: #3b82f6; color: white; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 14px; margin-right: 12px; flex-shrink: 0; }
        .input-dark { width: 100%; background: #0f172a; border: 1px solid #475569; padding: 12px; border-radius: 8px; color: white; margin-top: 8px; font-family: monospace; transition: border 0.2s; }
        .input-dark:focus { border-color: #3b82f6; outline: none; }
        .btn-action { width: 100%; padding: 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }
        .btn-blue { background: #2563eb; color: white; border: none; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; color: white; border: none; }
        .btn-green:hover { background: #15803d; }
        .preview-phone { background: #111827; border: 4px solid #374151; border-radius: 20px; padding: 10px; width: 300px; margin: 0 auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .preview-header { padding: 1rem; background-color: #111827; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; }
        
        /* Drag & Drop Styles */
        .drop-zone { border: 2px dashed #475569; border-radius: 8px; padding: 20px; text-align: center; margin-top: 8px; transition: all 0.2s; background: #0f172a; cursor: pointer; position: relative; overflow: hidden; }
        .drop-zone.dragover { border-color: #3b82f6; background: #1e293b; }
        .drop-zone:hover { border-color: #64748b; }
    </style>
</head>
<body class="p-6 max-w-5xl mx-auto">

    <div class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-blue-500 tracking-tight">OTG AppFactory <span class="text-gray-600 text-lg ml-2">v70.1</span></h1>
        <p class="text-gray-400 mt-2">Serverless Safety System Generator</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div>
            <div class="step-card">
                <div class="flex items-center mb-4"><div class="step-num">1</div><h2 class="text-xl font-bold text-white">Identity & Branding</h2></div>
                <label class="text-xs font-bold text-gray-400 uppercase">Organisation Name</label>
                <input id="orgName" class="input-dark" placeholder="Acme Church Safety" oninput="updatePreview(); saveInput(this);">
                
                <label class="text-xs font-bold text-gray-400 uppercase mt-4 block">App Logo</label>
                <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                    <p class="text-sm text-gray-300 font-bold pointer-events-none">‚òÅÔ∏è Drag & Drop Logo Here</p>
                    <p class="text-xs text-gray-500 mt-1 pointer-events-none">or click to upload (Auto-resized to 192px)</p>
                </div>
                
                <div class="mt-2">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">OR PASTE URL MANUALLY:</p>
                    <input id="logoUrl" class="input-dark text-xs" placeholder="https://example.com/logo.png" oninput="updatePreview(); saveInput(this);">
                </div>
            </div>

            <div class="step-card">
                <div class="flex items-center mb-4"><div class="step-num">2</div><h2 class="text-xl font-bold text-white">Security Core</h2></div>
                <label class="text-xs font-bold text-gray-400 uppercase">Master Secret Key</label>
                <input id="masterKey" type="text" class="input-dark text-yellow-400" placeholder="Create a strong password..." oninput="validateKey(); saveInput(this);">
                <p id="keyWarning" class="hidden text-red-400 text-xs mt-2 font-bold">‚ö†Ô∏è Key is too short (min 8 chars)</p>
                <p class="text-gray-500 text-xs mt-2">This key protects your dashboard. The system will auto-generate a separate Worker Key for the apps.</p>
            </div>

            <div class="step-card">
                <div class="flex items-center mb-4"><div class="step-num">3</div><h2 class="text-xl font-bold text-white">Backend Deployment</h2></div>
                <p class="text-sm text-gray-400 mb-4">Click below to get the code for your Google Script.</p>
                <button id="btnCopyBackend" onclick="copyBackendCode()" class="btn-action btn-blue">üìÑ Copy Backend Code</button>
                
                <label class="text-xs font-bold text-gray-400 uppercase mt-6 block">Deployment URL (ends in /exec)</label>
                <input id="sheetUrl" class="input-dark text-blue-400" placeholder="https://script.google.com/macros/s/..." oninput="saveInput(this)">
                
                <div class="flex gap-2 mt-4">
                    <button onclick="testConnection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded flex-1">Test Connection</button>
                </div>
                <p id="connStatus" class="text-center text-sm font-bold mt-2"></p>
            </div>

            <div class="step-card border-green-600/50">
                <div class="flex items-center mb-4"><div class="step-num bg-green-600">4</div><h2 class="text-xl font-bold text-white">Production Build</h2></div>
                <p class="text-sm text-gray-400 mb-4">Generates the configured Worker App, Monitor App, and Manifests.</p>
                <button onclick="generateZip()" class="btn-action btn-green shadow-lg shadow-green-900/50">üì¶ Download System ZIP</button>
            </div>
        </div>

        <div>
            <div class="step-card">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-4 text-center">Live App Preview</h3>
                <div class="preview-phone">
                    <div class="preview-header">
                        <div class="flex items-center gap-2">
                            <img id="prevLogo" src="" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'"> 
                            <h1 id="prevTitle" class="text-lg font-bold text-blue-400">Your Org</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex flex-col items-end gap-0.5">
                                <span class="text-[6px] text-gray-500 font-bold uppercase">GPS</span>
                                <div class="flex gap-0.5">
                                    <div class="w-1 h-3 bg-green-500 rounded-[1px]"></div>
                                    <div class="w-1 h-3 bg-green-500 rounded-[1px]"></div>
                                    <div class="w-1 h-3 bg-green-500 rounded-[1px]"></div>
                                </div>
                            </div>
                            <div class="p-2 rounded-full bg-gray-700 text-gray-400 text-xs">‚ÑπÔ∏è</div>
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="bg-blue-900/30 border border-blue-500/30 p-2 rounded">
                            <p class="text-[10px] text-blue-200">Welcome to the safety system.</p>
                        </div>
                        <div class="h-24 bg-gray-800 rounded border border-gray-700 flex items-center justify-center text-gray-600 text-xs">
                            Map / Site List
                        </div>
                        <div class="flex gap-2">
                            <div class="h-12 flex-1 bg-teal-900/50 rounded border border-teal-800"></div>
                            <div class="h-12 flex-[2] bg-gray-700 rounded"></div>
                        </div>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-600 mt-4">Visual representation only.</p>
            </div>

            <div class="bg-black rounded-lg p-4 font-mono text-xs h-64 overflow-y-auto border border-gray-800">
                <div class="text-green-500 mb-1">> Factory v70.1 initialized...</div>
                <div class="text-blue-500 mb-1">> Modules: Drag-Drop, Auto-Resize, Manifest Gen</div>
                <div id="consoleLog"></div>
            </div>
        </div>
    </div>

<script>
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js' };
    let TEMPLATES = {};

    window.onload = async () => {
        loadPersistedData();
        await loadTemplates();
        setupDragDrop();
        updatePreview();
    };

    function log(msg, type='text-gray-400') {
        const d = document.getElementById('consoleLog');
        d.innerHTML += `<div class="${type} mb-1">> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    }

    async function loadTemplates() {
        for (const [key, file] of Object.entries(FILES)) {
            try {
                const r = await fetch(file);
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                TEMPLATES[key] = await r.text();
                log(`Loaded ${file}`, 'text-green-400');
            } catch (e) {
                log(`ERROR: Could not load ${file}. Ensure it is in the same folder.`, 'text-red-500 font-bold');
            }
        }
    }

    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.value); }

    function loadPersistedData() {
        ['orgName', 'logoUrl', 'masterKey', 'sheetUrl'].forEach(id => {
            const v = localStorage.getItem('otg_' + id);
            if(v) document.getElementById(id).value = v;
        });
    }

    function updatePreview() {
        const name = document.getElementById('orgName').value || "Your Org";
        const logo = document.getElementById('logoUrl').value;
        document.getElementById('prevTitle').innerText = name;
        const logoImg = document.getElementById('prevLogo');
        if (logo && logo.length > 5) { logoImg.src = logo; logoImg.style.display = 'block'; } 
        else { logoImg.style.display = 'none'; }
    }

    function validateKey() {
        const k = document.getElementById('masterKey').value;
        const w = document.getElementById('keyWarning');
        if(k.length > 0 && k.length < 8) w.classList.remove('hidden'); else w.classList.add('hidden');
    }

    // --- DRAG & DROP LOGIC ---
    function setupDragDrop() {
        const dz = document.getElementById('dropZone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', (e) => { e.preventDefault(); dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (e) => {
            e.preventDefault();
            dz.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFile(files[0]);
        });
    }

    function handleFileSelect(input) { if (input.files.length) handleFile(input.files[0]); }

    function handleFile(file) {
        if (!file.type.startsWith('image/')) return alert("Please drop an image file.");
        log("Processing logo...", "text-yellow-400");
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Resize to max 192x192 for performance
                const MAX_SIZE = 192;
                let width = img.width;
                let height = img.height;
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const dataUrl = canvas.toDataURL('image/png');
                document.getElementById('logoUrl').value = dataUrl; // Set hidden input
                saveInput(document.getElementById('logoUrl')); // Persist
                updatePreview();
                log(`Logo processed! (${width}x${height})`, "text-green-400");
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function copyBackendCode() {
        if (!TEMPLATES.backend) return alert("Backend template not loaded yet.");
        const key = document.getElementById('masterKey').value;
        if (key.length < 8) return alert("Please enter a secure Master Key first.");
        const workerKey = "wk_" + Math.random().toString(36).substr(2, 9);
        let code = TEMPLATES.backend;
        code = code.replace("%%SECRET_KEY%%", key);
        code = code.replace("%%WORKER_KEY%%", workerKey);
        const org = document.getElementById('orgName').value || "My Org";
        code = code.replace("%%ORGANISATION_NAME%%", org);
        code = code.replace("%%ESCALATION_MINUTES%%", "15"); 

        try {
            await navigator.clipboard.writeText(code);
            const btn = document.getElementById('btnCopyBackend');
            const oldText = btn.innerText;
            btn.innerText = "‚úÖ COPIED!";
            btn.classList.replace('btn-blue', 'btn-green');
            setTimeout(() => { btn.innerText = oldText; btn.classList.replace('btn-green', 'btn-blue'); }, 2000);
            log("Backend code copied to clipboard.");
            log(`Generated Worker Key: ${workerKey}`, "text-yellow-400");
        } catch (err) { alert("Clipboard access failed. Please copy manually."); }
    }

    function testConnection() {
        const url = document.getElementById('sheetUrl').value;
        const key = document.getElementById('masterKey').value;
        const status = document.getElementById('connStatus');
        if (!url.includes('/exec')) { status.innerHTML = "‚ùå Invalid URL"; return; }
        status.innerHTML = "‚è≥ Testing...";
        status.className = "text-center text-sm font-bold mt-2 text-yellow-400";
        fetch(`${url}?test=1&key=${encodeURIComponent(key)}`).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                status.innerHTML = `‚úÖ Connection Successful! (${d.version})`;
                status.className = "text-center text-sm font-bold mt-2 text-green-400";
                log("Connection Test Passed.");
            } else { throw new Error(d.message || "Unknown Error"); }
        }).catch(e => {
            status.innerHTML = "‚ùå Failed: " + e.message;
            status.className = "text-center text-sm font-bold mt-2 text-red-400";
            log("Connection Test Failed: " + e.message, 'text-red-500');
        });
    }

    function generateZip() {
        const org = document.getElementById('orgName').value;
        const logo = document.getElementById('logoUrl').value;
        const key = document.getElementById('masterKey').value;
        const url = document.getElementById('sheetUrl').value;
        if (!org || !key || !url) return alert("Please fill in all fields.");

        const zip = new JSZip();
        const workerKey = "wk_" + Math.random().toString(36).substr(2, 9);
        log(`Building with Worker Key: ${workerKey}`, "text-blue-300");
        log("‚ö†Ô∏è IMPORTANT: Copy the Backend Code AGAIN to match this key.", "text-red-400 font-bold");

        // Prepare Manifest
        const manifest = {
            "name": org,
            "short_name": org.substring(0, 12),
            "start_url": "./index.html",
            "display": "standalone",
            "background_color": "#111827",
            "theme_color": "#111827",
            "icons": [{ "src": logo || "icon.png", "sizes": "192x192", "type": "image/png" }]
        };

        // Prepare Worker App
        let wHtml = TEMPLATES.worker;
        wHtml = wHtml.replace(/%%ORG_NAME%%/g, org);
        wHtml = wHtml.replace(/%%LOGO_DATA%%/g, logo);
        wHtml = wHtml.replace(/%%GOOGLE_SHEET_URL%%/g, url);
        wHtml = wHtml.replace(/%%SECRET_KEY%%/g, workerKey);
        wHtml = wHtml.replace(/%%IS_ADVANCED%%/g, "true");
        wHtml = wHtml.replace(/%%ENABLE_MILEAGE%%/g, "true");
        wHtml = wHtml.replace(/%%CHECKIN_ENABLED%%/g, "true");
        wHtml = wHtml.replace(/%%CHECKIN_INTERVAL%%/g, "120");
        wHtml = wHtml.replace(/%%ESCALATION_MINUTES%%/g, "15");
        wHtml = wHtml.replace(/%%VEHICLE_ENABLED%%/g, "true");
        wHtml = wHtml.replace(/%%VEHICLE_INTERVAL%%/g, "7");

        // Prepare Monitor App
        let mHtml = TEMPLATES.monitor;
        mHtml = mHtml.replace(/%%ORG_NAME%%/g, org);
        mHtml = mHtml.replace(/%%LOGO_URL%%/g, logo);
        mHtml = mHtml.replace(/%%SHEET_URL%%/g, url);

        // Prepare Backend Reference
        let bJs = TEMPLATES.backend;
        bJs = bJs.replace("%%SECRET_KEY%%", key);
        bJs = bJs.replace("%%WORKER_KEY%%", workerKey);
        bJs = bJs.replace("%%ORGANISATION_NAME%%", org);
        bJs = bJs.replace("%%ESCALATION_MINUTES%%", "15");

        // Build Zip
        zip.file("WorkerApp/index.html", wHtml);
        zip.file("WorkerApp/manifest.json", JSON.stringify(manifest));
        zip.file("MonitorApp/index.html", mHtml);
        zip.file("Backend/Code.gs", bJs);
        zip.file("README.txt", `OTG Safety System for ${org}\n\n1. Deploy Backend/Code.gs to Google Apps Script.\n2. Host WorkerApp/MonitorApp on Netlify/GitHub.\n\nWorker Key: ${workerKey}\nMaster Key: ${key}`);

        zip.generateAsync({type:"blob"}).then(function(content) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = `${org.replace(/\s/g,'_')}_OTG_System_v70.zip`;
            a.click();
            log("ZIP Download started.", "text-green-400");
        });
    }
</script>
</body>
</html>
