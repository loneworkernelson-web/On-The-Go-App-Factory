<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.26 (Global)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; }
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .checklist-checkbox { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
    .preset-swatch { width: 36px; height: 36px; border-radius: 8px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: all 0.1s; display: flex; overflow: hidden; }
    .preset-swatch:hover { transform: scale(1.1); border-color: #3b82f6; }
    .preset-swatch.selected { outline: 4px solid #3b82f6; outline-offset: 2px; transform: scale(1.05); }
    .swatch-half { flex: 1; height: 100%; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps. Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v79.26 (Global Edition)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              
              <div>
                  <div class="flex justify-between items-center mb-2">
                      <label class="block text-blue-300 font-bold text-sm uppercase">App Icon Label</label>
                      <span class="text-xs text-gray-500" id="charCount">6/12</span>
                  </div>
                  <input type="text" id="appName" maxlength="12" class="input-field text-center font-bold text-green-400 border-green-600/50" value="Safety" oninput="updateCharCount(this); saveInput(this)">
                  <p class="text-[10px] text-gray-500 mt-1">Short name for the phone Home Screen.</p>
              </div>

              <div class="p-4 bg-gray-900 rounded-lg border border-gray-700 shadow-inner">
                  <h3 class="text-white font-bold mb-4 uppercase text-xs tracking-widest">üîê Safety Connection Keys</h3>
                  <div class="mb-4">
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Secret Key (Admin Only)</label>
                      <div class="flex gap-2">
                          <input type="text" id="secretKey" class="input-field text-yellow-400 font-mono text-sm" oninput="saveInput(this); validateKey();">
                          <button onclick="generateMemorableKey('secretKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white">üîÑ</button>
                      </div>
                      <p class="text-[10px] text-gray-500 mt-1">Protects your database. <strong>Admin use only.</strong></p>
                  </div>
                  <div>
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Worker Key (App Setup)</label>
                      <div class="flex gap-2">
                          <input type="text" id="workerKey" class="input-field text-green-400 font-mono text-sm" oninput="saveInput(this)">
                          <button onclick="generateMemorableKey('workerKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white">üîÑ</button>
                      </div>
                      <p class="text-[10px] text-gray-500 mt-1">Baked into the app so workers connect automatically.</p>
                  </div>
              </div>

              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">3. Regional Logic</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option>
                      <option value="+61">Australia (+61)</option>
                      <option value="+44">United Kingdom (+44)</option>
                      <option value="+1">USA / Canada (+1)</option>
                      <option value="">Other (Universal)</option>
                  </select>
                  <div class="mt-2 bg-gray-900 p-3 rounded text-[10px] text-gray-400 grid grid-cols-2 gap-2 border border-gray-800">
                      <p>Timezone: <span id="detectedTz" class="text-blue-400">Loading...</span></p>
                      <p>Term: <span id="vehTermDisplay" class="text-green-400">WOF</span></p>
                      <p>Voice: <span id="voiceLocaleDisplay" class="text-yellow-400">en-NZ</span></p>
                      <p>Format: <span id="phoneFmtDisplay" class="text-purple-400">+64...</span></p>
                  </div>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">4. App Logo & Branding</label>
              <div id="dropZone" class="drop-zone w-full mb-4" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto rounded-full flex items-center justify-center overflow-hidden">
                    <img id="logoImg" class="hidden h-full w-full object-cover">
                    <span id="logoText" class="text-gray-500 text-sm">Drag & Drop Logo</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <input type="hidden" id="logoUrl" oninput="saveInput(this)">

              <div id="paletteArea" class="hidden w-full bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                  <div class="mb-4 text-left">
                      <div class="flex justify-between items-center mb-1">
                          <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">1. Extract Branding</span>
                          <button onclick="triggerResample()" class="text-[10px] text-blue-400 font-bold hover:underline">‚Üª Resample</button>
                      </div>
                      <p class="text-[9px] text-gray-500 leading-tight">Identify colors from your logo. Neutrals are filtered.</p>
                  </div>
                  <div class="mb-4"><div class="flex gap-3 justify-center mb-2" id="logoClusterSwatches"></div></div>
                  <div class="pt-3 border-t border-gray-800">
                      <p class="text-[8px] text-gray-500 font-bold uppercase mb-2">Enterprise Safe Fallbacks</p>
                      <div class="flex gap-2 justify-center">
                          <div class="preset-swatch" onclick="applyPreset('#1e40af', '#3b82f6', this)" title="Blue"><div class="swatch-half bg-[#1e40af]"></div><div class="swatch-half bg-[#3b82f6]"></div></div>
                          <div class="preset-swatch" onclick="applyPreset('#064e3b', '#10b981', this)" title="Green"><div class="swatch-half bg-[#064e3b]"></div><div class="swatch-half bg-[#10b981]"></div></div>
                          <div class="preset-swatch" onclick="applyPreset('#450a0a', '#ef4444', this)" title="Red"><div class="swatch-half bg-[#450a0a]"></div><div class="swatch-half bg-[#ef4444]"></div></div>
                          <div class="preset-swatch" onclick="applyPreset('#1e293b', '#64748b', this)" title="Slate"><div class="swatch-half bg-[#1e293b]"></div><div class="swatch-half bg-[#64748b]"></div></div>
                      </div>
                  </div>
              </div>
            </div>
          </div>

          <div class="highlight-box border-blue-500/30 mt-8">
             <div class="flex items-center gap-3 mb-4"><span class="text-2xl">üõ°Ô∏è</span><h3 class="text-xl font-bold text-white">Safety & Fleet Options</h3></div>
             <div class="grid md:grid-cols-2 gap-6">
                 <div class="space-y-4">
                     <div>
                         <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Alarm Grace Period (Mins)</label>
                         <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)">
                         <p class="text-[10px] text-gray-500 mt-1">Extra time for worker to mark "Safe" before alarm.</p>
                     </div>
                     <div>
                        <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Periodic Check-in</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="chkCheckin" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleCheckin(); saveInput(this)">
                            <span class="text-sm font-bold text-gray-300">Enable?</span>
                            <div id="checkinOptions" class="hidden flex items-center gap-2 ml-2">
                                <input type="number" id="checkinMins" value="60" min="5" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-24 text-center font-bold" oninput="saveInput(this)"><span class="text-xs text-gray-400">mins</span>
                            </div>
                        </div>
                     </div>
                 </div>
                 <div class="space-y-4">
                     <div><label class="block text-gray-400 text-xs font-bold uppercase">SMS Key (Textbelt)</label><input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)"></div>
                     <div><label class="block text-gray-400 text-xs font-bold uppercase">AI Key (Gemini)</label><input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)"></div>
                     <div><label class="block text-gray-400 text-xs font-bold uppercase">Mileage Key (ORS)</label><input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)"></div>
                 </div>
             </div>
             <div class="mt-6 pt-6 border-t border-gray-700"><div class="flex items-start gap-3"><input type="checkbox" id="chkVehicle" class="mt-1 w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleVehicle(); saveInput(this)" checked><div><label class="text-white font-bold block">Vehicle Tracking</label><p class="text-xs text-gray-400">Tracks WOF/Rego logic.</p></div></div></div>
          </div>
          <div class="flex justify-end pt-6"><button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12">Next: Database Setup ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
            <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-8 rounded-2xl border border-blue-500 shadow-xl text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Option A: Automated Copy</h2>
                <div class="bg-yellow-900/50 border-l-4 border-yellow-500 p-4 mb-6 text-left max-w-2xl mx-auto rounded-r">
                    <p class="font-bold text-yellow-300 text-sm italic">‚≠ê Recommended for Beginners</p>
                    <ol class="list-decimal ml-5 mt-2 space-y-2 text-xs text-gray-300">
                        <li>Be signed into your target Google Account.</li>
                        <li>Click "Make a Copy" in the new tab.</li>
                    </ol>
                </div>
                <button onclick="openMagicLink()" class="btn btn-success text-xl px-10 py-5">‚ú® Create Database Copy</button>
            </div>
            <div class="mt-4 p-6 bg-blue-900/20 border border-blue-500/30 rounded-xl">
                <h4 class="font-bold text-blue-300 text-sm uppercase mb-2 tracking-wider">üí° Crucial: Identity Matching</h4>
                <p class="text-sm text-gray-300">Staff names in the sheet must match app entry exactly.</p>
            </div>
            <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(3)" class="btn btn-primary text-lg">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
              <h3 class="font-bold text-green-400 text-lg">1. Install System "Brain"</h3>
              <p class="text-xs text-gray-400">Extensions > Apps Script. Delete text and Paste.</p>
              <button onclick="copyScript()" class="btn bg-blue-600 text-white w-full font-bold">üìã COPY SYSTEM CODE</button>
              <div id="codeContainer" class="hidden mt-2"><pre id="codeDisplay" class="code-scroll">Generating...</pre></div>
          </div>
          <div class="bg-gray-900 p-6 rounded-xl border border-purple-600/50 space-y-4">
              <h3 class="font-bold text-purple-400 text-lg">2. Set Watchdog Alarms</h3>
              <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-500/30">
                  <h4 class="font-bold text-white text-sm mb-2">The Privacy Shredder</h4>
                  <p class="text-xs text-gray-300">Function: <strong>cleanupPrivateSentNotes</strong> | Time: <strong>Every Hour</strong>.</p>
              </div>
          </div>
          <div id="urlInputSection" class="space-y-4">
              <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="Paste /exec URL here" oninput="saveInput(this)">
              <button onclick="testConnection()" class="btn bg-yellow-600 text-white w-full font-bold">üì° TEST SYSTEM CONNECTION</button>
              <div id="testResult" class="hidden mt-4 p-4 rounded-xl text-center font-bold"></div>
          </div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50">Next: Download App ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
            <h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2>
            <button onclick="downloadZip()" class="btn btn-success py-5 text-2xl w-full max-w-md shadow-xl">Download Lone_Worker_Apps.zip</button>
            <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-4">1. Host with Netlify</h2>
                <p class="text-sm text-gray-300">Unzip and Drag <strong>WorkerApp</strong> to Netlify Drop.</p>
            </div>
            <div class="bg-indigo-900/30 p-8 rounded-xl border border-indigo-500/50">
                <h2 class="text-2xl font-bold text-white mb-4">2. Launch Pack</h2>
                <input type="url" id="workerAppUrl" class="input-field mb-4" placeholder="Paste Netlify URL here" oninput="generateLaunchPack()">
                <div id="launchPack" class="hidden grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2"><textarea id="launchEmail" class="w-full h-40 bg-gray-900 border border-indigo-500/50 rounded p-4 text-xs text-gray-300" readonly></textarea></div>
                    <div class="bg-white p-4 rounded-lg flex flex-col items-center"><img id="qrImage" src="" class="w-32 h-32 mb-2"><p class="text-gray-900 text-[10px] font-bold">Setup QR Code</p></div>
                </div>
            </div>
            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    let TEMPLATES = {};

    const REGION_DATA = { "+64": { term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" }, "+61": { term: "Rego", locale: "en-AU", tz: "Australia/Sydney" }, "+44": { term: "Inspection", locale: "en-GB", tz: "Europe/London" }, "+1": { term: "Inspection", locale: "en-US", tz: "America/New_York" }, "": { term: "Inspection", locale: "en-US", tz: "UTC" } };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        document.getElementById('mainContent').classList.remove('blur-sm');
        document.getElementById('disclaimerModal').style.display = 'none';
        loadPersistedData();
        if(!document.getElementById('secretKey').value) generateMemorableKey('secretKey');
        if(!document.getElementById('workerKey').value) generateMemorableKey('workerKey');
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) { try { const r = await fetch(f); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){ console.error(e); } }
    };

    function handleLogo(input) { if (input.files[0]) { const r = new FileReader(); r.onload = function(e) { const img = new Image(); img.onload = function() { const c = document.createElement('canvas'); c.width = 192; c.height = 192; const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192); const d = c.toDataURL('image/png'); document.getElementById('logoImg').src = d; document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoText').textContent = "‚úÖ Logo Ready"; document.getElementById('logoUrl').value = d; saveInput(document.getElementById('logoUrl')); triggerResample(); }; img.src = e.target.result; }; r.readAsDataURL(input.files[0]); } }

    function triggerResample() {
        const img = document.getElementById('logoImg'); if (!img.src || img.src.length < 100) return;
        const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
        const data = ctx.getImageData(30, 30, 132, 132).data; const clusters = [];
        for (let i = 0; i < data.length; i += 12) {
            if (data[i + 3] < 180) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const max = Math.max(r, g, b), min = Math.min(r, g, b), sat = (max - min) / max, bri = max / 255;
            if (sat < 0.22 || bri > 0.90 || bri < 0.15) continue;
            const key = `${Math.round(r/25)*25},${Math.round(g/25)*25},${Math.round(b/25)*25}`;
            let existing = clusters.find(c => c.key === key);
            if(existing) existing.count++; else clusters.push({key, count: 1, rgb: [r,g,b]});
        }
        clusters.sort((a,b) => b.count - a.count);
        const container = document.getElementById('logoClusterSwatches'); container.innerHTML = '';
        clusters.slice(0, 3).forEach((cluster, idx) => {
            const primary = rgbToHex(`rgb(${cluster.rgb.join(',')})`);
            const swatch = document.createElement('div'); swatch.className = "preset-swatch";
            swatch.innerHTML = `<div class="swatch-half" style="background:${primary}"></div><div class="swatch-half" style="background:${primary}"></div>`;
            swatch.onclick = function() { applyPreset(primary, primary, this); };
            container.appendChild(swatch);
            if(idx === 0) applyPreset(primary, primary, swatch);
        });
        document.getElementById('paletteArea').classList.remove('hidden');
    }

    function rgbToHex(rgb) { const match = rgb.match(/\d+/g); return "#" + match.slice(0,3).map(x => parseInt(x).toString(16).padStart(2, '0')).join(''); }

    function applyPreset(primary, accent, el) {
        document.getElementById('primaryColorBox').style.backgroundColor = primary;
        document.getElementById('accentColorBox').style.backgroundColor = accent;
        localStorage.setItem('otg_theme_primary', primary);
        localStorage.setItem('otg_theme_accent', accent);
        document.querySelectorAll('.preset-swatch').forEach(s => s.classList.remove('selected'));
        if(el) el.classList.add('selected');
    }

    function generateMemorableKey(id) { document.getElementById(id).value = id === 'workerKey' ? "wk_" + Math.random().toString(36).substr(2, 9) : "ADM-" + Math.floor(1000 + Math.random() * 9000); saveInput(document.getElementById(id)); }
    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value); }
    function validateKey() { document.getElementById('keyStrength').innerText = document.getElementById('secretKey').value.length < 6 ? "Weak" : "Good"; }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function toggleCheck(el) { el.classList.toggle('checked'); el.querySelector('input').checked = el.classList.contains('checked'); showUrlInput(); }
    function showUrlInput() { if(Array.from(document.querySelectorAll('.checklist-checkbox')).every(i => i.checked)) document.getElementById('urlInputSection').classList.remove('hidden'); }
    function loadPersistedData() { ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'checkinMins', 'vehFreq', 'countrySelect', 'appName'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); }
    function updateRegionInfo() { const sel = document.getElementById('countrySelect').value; selectedConfig = REGION_DATA[sel] || REGION_DATA[""]; document.getElementById('detectedTz').textContent = selectedConfig.tz; document.getElementById('vehTermDisplay').textContent = selectedConfig.term; document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale; document.getElementById('timezoneVal').value = selectedConfig.tz; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('mainContent').classList.remove('blur-sm'); }
    function toggleEnterBtn() { document.getElementById('btnEnter').disabled = !document.getElementById('chkAccept').checked; }
    function setupDragDrop() { const dz = document.getElementById('dropZone'); dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('border-blue-500'); }); dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); }); }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); for(let i=1; i<=5; i++) document.getElementById('tab'+i).classList.toggle('active', i===n); if(n===3) generateScript(); }
    function toggleCheckin() { document.getElementById('checkinOptions').classList.toggle('hidden', !document.getElementById('chkCheckin').checked); }
    function toggleVehicle() { document.getElementById('vehOptions').classList.toggle('hidden', !document.getElementById('chkVehicle').checked); }
    function copyScript() { generateScript(); navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Copied!"); }
    
    function generateScript() {
        if(!TEMPLATES.backend) return;
        document.getElementById('codeDisplay').textContent = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term)
            .replace('%%LOCALE%%', selectedConfig.locale);
    }

    async function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const resBox = document.getElementById('testResult');
        resBox.classList.remove('hidden'); resBox.textContent = "Testing...";
        try {
            const r = await fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value));
            const d = await r.json();
            if(d.status === "success") {
                resBox.textContent = "‚úÖ Success!"; resBox.className = "mt-4 p-4 rounded-xl text-center bg-green-900 text-white font-bold";
                document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50');
            } else throw new Error();
        } catch(e) { resBox.textContent = "‚ùå Connection Failed."; resBox.className = "mt-4 p-4 rounded-xl text-center bg-red-900 text-white font-bold"; }
    }

    function downloadZip() {
        const zip = new JSZip(); 
        const org = document.getElementById('orgName').value; 
        const logoData = document.getElementById('logoUrl').value;
        const primaryColor = localStorage.getItem('otg_theme_primary') || "#1e40af";
        
        let wHtml = TEMPLATES.worker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%GOOGLE_SHEET_URL%%/g, document.getElementById('webAppUrl').value)
            .replace(/%%LOGO_DATA%%/g, logoData)
            .replace(/%%SECRET_KEY%%/g, document.getElementById('workerKey').value)
            .replace(/%%CHECKIN_ENABLED%%/g, document.getElementById('chkCheckin').checked)
            .replace(/#1e40af/g, primaryColor);

        const logoBlob = dataURLtoBlob(logoData);
        const manifest = { name: org, short_name: "Safety", start_url: "index.html", display: "standalone", theme_color: primaryColor, icons: [{ src: "icon.png", sizes: "192x192", type: "image/png" }] };
        const workerFolder = zip.folder("WorkerApp");
        workerFolder.file("index.html", wHtml);
        workerFolder.file("manifest.json", JSON.stringify(manifest, null, 2));
        workerFolder.file("icon.png", logoBlob);
        zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
        zip.generateAsync({type:"blob"}).then(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = org.replace(/ /g, '_') + "_Lone_Worker_Apps.zip"; a.click();
        });
    }

    function dataURLtoBlob(dataurl) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--) u8arr[n] = bstr.charCodeAt(n);
        return new Blob([u8arr], {type:mime});
    }

    function generateLaunchPack() {
        const url = document.getElementById('workerAppUrl').value;
        if(url.length > 10) {
            document.getElementById('launchPack').classList.remove('hidden');
            document.getElementById('launchEmail').value = `Hi Team,\n\nSetup your new safety app by following this link on your phone:\n${url}\n\nImportant: Use your name EXACTLY as it appears in our records.`;
        }
    }
  </script>
</body>
</html>
