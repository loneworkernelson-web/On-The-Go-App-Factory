<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.26 (Global)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; }
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .drop-zone.dragover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .checklist-checkbox { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
    .preset-swatch { width: 36px; height: 36px; border-radius: 8px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: all 0.1s; display: flex; overflow: hidden; }
    .preset-swatch:hover { transform: scale(1.1); border-color: #3b82f6; }
    .preset-swatch.selected { outline: 4px solid #3b82f6; outline-offset: 2px; transform: scale(1.05); }
    .swatch-half { flex: 1; height: 100%; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps (especially iOS). Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
      <div class="bg-gray-800 p-8 rounded-xl border border-blue-500 max-w-md">
          <h2 class="text-xl font-bold text-white mb-4">üìÇ How to get a Drive Folder ID</h2>
          <ol class="list-decimal pl-5 space-y-3 text-gray-300 text-sm mb-6">
              <li>Open Google Drive in your browser.</li>
              <li>Create a new folder (e.g., "Safety Photos").</li>
              <li>Double-click to open the folder.</li>
              <li>Look at the URL bar. Copy the text AFTER <code>folders/</code>.</li>
          </ol>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all">
              drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong>
          </div>
          <button onclick="document.getElementById('driveHelpModal').style.display='none'" class="w-full py-2 bg-blue-600 text-white font-bold rounded">Got it</button>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v79.26 (Global Edition)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              
              <div>
                  <div class="flex justify-between items-center mb-2">
                      <label class="block text-blue-300 font-bold text-sm uppercase">App Icon Label</label>
                      <span class="text-xs text-gray-500" id="charCount">6/12</span>
                  </div>
                  <input type="text" id="appName" maxlength="12" class="input-field text-center font-bold text-green-400 border-green-600/50" value="Safety" oninput="updateCharCount(this); saveInput(this)">
                  <p class="text-[10px] text-gray-500 mt-1">Short name for the phone Home Screen (Max 12 chars).</p>
              </div>

<div class="p-4 bg-gray-900 rounded-lg border border-gray-700 shadow-inner">
                  <h3 class="text-white font-bold mb-4 uppercase text-xs tracking-widest">üîê Safety Connection Keys</h3>
                  
                  <div class="mb-4">
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Secret Key (Admin Only)</label>
                      <div class="flex gap-2">
                          <input type="text" id="secretKey" class="input-field text-yellow-400 font-mono tracking-wider text-sm" oninput="saveInput(this); validateKey();">
                          <button onclick="generateMemorableKey('secretKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white" title="Generate New Key">üîÑ</button>
                      </div>
                      <p class="text-[10px] text-gray-500 mt-1">Protects your database. <strong>Do not share this with workers.</strong></p>
                  </div>

                  <div>
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Worker Key (App Setup)</label>
                      <div class="flex gap-2">
                          <input type="text" id="workerKey" class="input-field text-green-400 font-mono tracking-wider text-sm" oninput="saveInput(this)">
                          <button onclick="generateMemorableKey('workerKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white" title="Generate New Key">üîÑ</button>
                      </div>
                      <p class="text-[10px] text-gray-500 mt-1">The "Handshake" key. This is baked into the app so workers connect automatically.</p>
                      <div class="mt-3 text-[10px] bg-orange-900/30 border border-orange-700/50 p-3 rounded text-orange-200">
                          <strong>üí° UPDATE TIP:</strong> If you are updating an existing system, paste your <u>OLD</u> Worker Key here to keep current staff connected.
                      </div>
                  </div>
              </div>

<div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">3. Regional Logic</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option>
                      <option value="+61">Australia (+61)</option>
                      <option value="+44">United Kingdom (+44)</option>
                      <option value="+1">USA / Canada (+1)</option>
                      <option value="">Other (Universal)</option>
                  </select>
                  <div class="mt-2 bg-gray-900 p-3 rounded text-[10px] text-gray-400 grid grid-cols-2 gap-2 border border-gray-800">
                      <p>Timezone: <span id="detectedTz" class="text-blue-400 font-mono">Loading...</span></p>
                      <p>Local Term: <span id="vehTermDisplay" class="text-green-400 font-mono">WOF</span></p>
                      <p>Voice Locale: <span id="voiceLocaleDisplay" class="text-yellow-400 font-mono">en-NZ</span></p>
                      <p>Safety Format: <span id="phoneFmtDisplay" class="text-purple-400 font-mono">+64...</span></p>
                  </div>
              </div>
            </div> <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">4. App Logo & Branding</label>
              <div id="dropZone" class="drop-zone w-full mb-4" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto rounded-full flex items-center justify-center overflow-hidden">
                    <img id="logoImg" class="hidden h-full w-full object-cover">
                    <span id="logoText" class="text-gray-500 text-sm">Drag & Drop Logo</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <input type="hidden" id="logoUrl" oninput="saveInput(this)">

              <div id="paletteArea" class="hidden w-full bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                  <div class="mb-4 text-left">
                      <div class="flex justify-between items-center mb-1">
                          <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Extract Branding</span>
                          <button onclick="triggerResample()" class="text-[10px] text-blue-400 font-bold hover:underline">‚Üª Resample</button>
                      </div>
                  </div>
                  <div class="flex gap-3 justify-center mb-4" id="logoClusterSwatches"></div>
                  <div class="pt-3 border-t border-gray-800 flex gap-4 justify-center items-center">
                      <div class="flex flex-col items-center gap-1">
                          <div id="primaryColorBox" class="w-8 h-8 rounded border border-white/20 shadow-lg"></div>
                          <span class="text-[7px] text-gray-500 font-bold uppercase tracking-tighter">Primary</span>
                      </div>
                      <div class="flex flex-col items-center gap-1">
                          <div id="accentColorBox" class="w-8 h-8 rounded border border-white/20 shadow-lg"></div>
                          <span class="text-[7px] text-gray-500 font-bold uppercase tracking-tighter">Accent</span>
                      </div>
                  </div>
              </div>
            </div>
          </div> <div class="highlight-box border-blue-500/30 mt-8">
             <div class="flex items-center gap-3 mb-4">
                 <span class="text-2xl">üõ°Ô∏è</span>
                 <h3 class="text-xl font-bold text-white">Safety & Fleet Options</h3>
             </div>
             </div>

          <div class="flex justify-end pt-6">
              <button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12">Next: Database Setup ‚Üí</button>
          </div>
        </div>
           <div>
               <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Alarm Grace Period (Mins)</label>
               <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)">
               <p class="text-[10px] text-gray-500 mt-1">Extra time given to a worker to mark themselves "Safe" before the emergency alarm fires.</p>
           </div>
           
           <div>
              <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Periodic Check-in</label>
              <div class="flex items-center gap-2">
                  <input type="checkbox" id="chkCheckin" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleCheckin(); saveInput(this)">
                  <span class="text-sm font-bold text-gray-300">Enable?</span>
                  <div id="checkinOptions" class="hidden flex items-center gap-2 ml-2">
                      <input type="number" id="checkinMins" value="60" min="5" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-24 text-center font-bold" oninput="saveInput(this)">
                      <span class="text-xs text-gray-400">mins</span>
                  </div>
              </div>
              <p class="text-[10px] text-gray-500 mt-1">Forces the app to ask "Are you OK?" at this set interval.</p>
           </div>
       </div>

    <div class="space-y-4">
           <div>
               <div class="flex justify-between items-end mb-1">
                   <label class="block text-gray-400 text-xs font-bold uppercase">SMS Alert Key (Textbelt)</label>
                   <a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a>
               </div>
               <input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)">
           </div>
           
           <div>
               <div class="flex justify-between items-end mb-1">
                   <label class="block text-gray-400 text-xs font-bold uppercase">AI Report Key (Gemini)</label>
                   <a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a>
               </div>
               <input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)">
           </div>

           <div>
               <div class="flex justify-between items-end mb-1">
                   <label class="block text-gray-400 text-xs font-bold uppercase">Mileage Key (OpenRouteService)</label>
                   <a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a>
               </div>
               <input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional" oninput="saveInput(this)">
               <p class="text-[10px] text-gray-500 mt-1">Required for road-accurate mileage. <strong>Hidden from workers for security.</strong></p>
           </div>
       </div>

   <div class="mt-6 pt-6 border-t border-gray-700 space-y-4">
      <div class="flex items-start gap-3">
          <input type="checkbox" id="chkVehicle" class="mt-1 w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleVehicle(); saveInput(this)" checked>
          <div>
              <label class="text-white font-bold block">Enable Vehicle Safety Tracking</label>
              <p class="text-xs text-gray-400">Tracks <span class="dynamic-wof">WOF</span>/Rego and requires periodic safety checks from the driver.</p>
              <div id="vehOptions" class="mt-2 text-sm text-gray-400 flex items-center gap-2">
                  <span>Check Every:</span>
                  <input type="number" id="vehFreq" value="120" class="bg-gray-800 border border-gray-600 rounded p-1 w-16 text-center text-white font-bold" oninput="saveInput(this)">
                  <span>Days</span>
              </div>
          </div>
      </div>
   </div>
</div>
         <div class="flex justify-end pt-6">
              <button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12">Next: Database Setup ‚Üí</button>
          </div>
        </div> <div id="step2" class="step-section space-y-8">
            
            <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-8 rounded-2xl border border-blue-500 shadow-xl text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Option A: The Automated Way</h2>
                <div class="bg-yellow-900/50 border-l-4 border-yellow-500 p-4 mb-6 text-left max-w-2xl mx-auto rounded-r">
                    <p class="font-bold text-yellow-300 text-sm italic">‚≠ê Recommended for Beginners</p>
                    <ol class="list-decimal ml-5 mt-2 space-y-2 text-xs text-gray-300">
                        <li>Ensure you are signed into the <strong>Google Account</strong> you want to own this system.</li>
                        <li>Click the <strong>Magic Link</strong> button below.</li>
                        <li>A new tab opens. Click the blue <strong>"Make a Copy"</strong> button.</li>
                        <li>Your database is now created! <strong>Keep that tab open</strong> for the next step.</li>
                    </ol>
                </div>
                <button onclick="openMagicLink()" class="btn btn-success text-xl px-10 py-5 shadow-lg transform hover:-translate-y-1 hover:shadow-2xl">‚ú® Create Database Copy</button>
                <p id="magicLinkError" class="hidden text-red-400 text-sm mt-4 font-bold bg-red-900/50 p-2 rounded">‚ö†Ô∏è Admin: Please configure MASTER_SHEET_URL in index.html</p>
            </div>

            <div class="border border-gray-700 rounded-xl p-4">
                <button onclick="document.getElementById('manualSetup').classList.toggle('hidden')" class="w-full flex justify-between items-center text-gray-400 hover:text-white font-bold">
                    <span class="text-sm uppercase tracking-widest">Option B: Manual Setup (Advanced)</span>
                    <span>‚ñº</span>
                </button>
                <div id="manualSetup" class="hidden mt-6 space-y-6">
                    <div class="text-center"><a href="https://sheets.new" target="_blank" class="btn bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 text-sm">1. Create Blank Sheet</a></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                            <h3 class="font-bold text-blue-400 text-sm">A. 'Visits' Tab</h3>
                            <button onclick="copyVisitsHeaders()" class="w-full bg-blue-700 text-white py-2 rounded mt-2 text-xs font-bold">Copy Headers</button>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                            <h3 class="font-bold text-purple-400 text-sm">B. 'Templates' Tab</h3>
                            <button onclick="copyTemplatesSetup()" class="w-full bg-purple-700 text-white py-2 rounded mt-2 text-xs font-bold">Copy Data</button>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                            <h3 class="font-bold text-green-400 text-sm">C. 'Sites' Tab</h3>
                            <button onclick="copySitesSetup()" class="w-full bg-green-700 text-white py-2 rounded mt-2 text-xs font-bold">Copy Data</button>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                            <h3 class="font-bold text-red-400 text-sm">D. 'Staff' Tab</h3>
                            <button onclick="copyStaffSetup()" class="w-full bg-red-800 text-white py-2 rounded mt-2 text-xs font-bold">Copy Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-6 bg-blue-900/20 border border-blue-500/30 rounded-xl">
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-2xl">üí°</span>
                    <h4 class="font-bold text-blue-300 text-sm uppercase tracking-wider">Crucial: Strict Identity Matching</h4>
                </div>
                <p class="text-sm text-gray-300 leading-relaxed mb-4">
                    To connect, the worker's name in the <strong>'Staff'</strong> sheet must match what they type into the app <strong>exactly</strong> (case-sensitive).
                </p>
                <div class="grid grid-cols-2 gap-4 text-xs font-mono">
                    <div class="p-2 bg-green-900/30 rounded border border-green-500/30 text-green-400">‚úÖ MATCH: "Jane Doe"</div>
                    <div class="text-red-400 p-2 bg-red-900/30 rounded border border-red-500/30">‚ùå FAIL: "jane doe" or "Jane"</div>
                </div>
            </div>

            <div class="flex justify-between pt-6">
                <button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button>
                <button onclick="gotoStep(3)" class="btn btn-primary text-lg">Next: Cloud System ‚Üí</button>
            </div>
        </div>


### **Why this happened**
In your current file, the Step 1 closing `</div>` was placed before the "Next: Database" button. Because the button was sitting "loose" in the code, the browser didn't know it was part of Step 1 and kept it visible. More importantly, Step 2 was effectively empty because its content was also being rendered outside its hidden container.

### **Verification**
1. Apply the patch above.
2. Refresh the Factory; **Step 1** should now only show Branding, Keys, and Safety Options.
3. Click **"Next: Database Setup"**; the full instructions for the Magic Link and manual setup will now appear correctly.

Would you like me to check the **Step 5 (Deployment)** logic next to ensure the **QR Code** and **Onboarding Email** are working correctly for the trial organizations?
<div id="step3" class="step-section space-y-6">
  
  <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
      <h3 class="font-bold text-green-400 text-lg">1. Install the System "Brain"</h3>
      <p class="text-xs text-gray-400">This code handles all the safety logic. Follow these exact steps:</p>
      
      <div class="space-y-3">
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Click the <strong>Blue Button</strong> below to copy the code.</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Go to your Google Sheet. Click <strong>Extensions</strong>, then <strong>Apps Script</strong>.</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Delete any text already in the window (like <code>function myFunction()</code>).</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm"><strong>Paste</strong> your copied code and click the <strong>Floppy Disk icon</strong> (Save).</span>
          </div>
      </div>

      <div class="flex items-center gap-4 mt-4">
          <button onclick="copyScript()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg flex-1">üìã COPY SYSTEM CODE</button>
          <button onclick="document.getElementById('codeContainer').classList.toggle('hidden')" class="text-xs text-gray-500 underline">View Code</button>
      </div>
      <div id="codeContainer" class="hidden relative mt-2"><pre id="codeDisplay" class="code-scroll h-48">Generating...</pre></div>
  </div>

  <div class="bg-gray-900 p-6 rounded-xl border border-purple-600/50 space-y-4">
      <div class="flex items-center gap-3"><span class="text-2xl">‚è∞</span><div><h3 class="font-bold text-purple-400 text-lg">2. Set the Watchdog Alarms</h3><p class="text-xs text-gray-400">Triggers automate the safety checks so you don't have to watch manually.</p></div></div>
      
      <div class="space-y-4">
          <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30">
              <h4 class="font-bold text-white text-sm mb-3">A. The Safety Watchdog (Overdue Alarms)</h4>
              <ol class="list-decimal ml-5 space-y-2 text-xs text-gray-300">
                  <li>Click the <strong>Alarm Clock icon</strong> (Triggers) on the left sidebar.</li>
                  <li>Click <strong>+ Add Trigger</strong> (bottom right).</li>
                  <li>Function: <strong>checkOverdueVisits</strong> | Event: <strong>Time-driven</strong>.</li>
                  <li>Type: <strong>Minutes timer</strong> | Interval: <strong>Every 10 minutes</strong>. Click <strong>Save</strong>.</li>
              </ol>
          </div>

          <div class="bg-purple-900/30 border border-purple-500/50 p-4 rounded-xl">
              <h4 class="font-bold text-purple-300 text-sm mb-3">B. The Privacy Shredder (Note to Self)</h4>
              <ol class="list-decimal ml-5 space-y-2 text-xs text-gray-300">
                  <li>Click <strong>+ Add Trigger</strong> again.</li>
                  <li>Choose <strong>cleanupPrivateSentNotes</strong> as the function.</li>
                  <li>Event: <strong>Time-driven</strong> | Type: <strong>Hour timer</strong>.</li>
                  <li>Interval: <strong>Every hour</strong>. Click <strong>Save</strong>.</li>
              </ol>
          </div>

          <div class="bg-blue-900/30 border border-blue-500/30 p-4 rounded-xl text-xs text-gray-300">
              <p class="font-bold text-blue-300 mb-2 italic">üÜò Google Security Warnings</p>
              <p>When saving, Google will ask to verify your account. <strong>This is normal:</strong></p>
              <ul class="list-disc ml-5 mt-2 space-y-1">
                  <li>Click <strong>Advanced</strong> -> <strong>Go to OTG Safety System (unsafe)</strong>.</li>
                  <li>Scroll down and click <strong>Allow</strong>.</li>
              </ul>
          </div>
      </div>
  </div>

  <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
      <h3 class="font-bold text-yellow-400 text-lg">3. Switch the System "ON"</h3>
      <div class="space-y-3">
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Click <strong>Deploy > New Deployment</strong> (top right).</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Select type: <strong>Web App</strong> | Execute as: <strong>Me</strong>.</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm font-bold text-yellow-300 underline">Set "Who has access" to "Anyone".</span>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this); showUrlInput()"><input type="checkbox" class="checklist-checkbox">
            <span class="text-sm">Click <strong>Deploy</strong> and copy the <strong>Web App URL</strong>.</span>
          </div>
      </div>
  </div>

  <div id="urlInputSection" class="hidden opacity-0 transition-opacity duration-500">
      <label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste the /exec URL here:</label>
      <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)">
      <div class="flex justify-center gap-4 mt-6">
        <button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 px-10 rounded-xl shadow-lg">üì° TEST SYSTEM CONNECTION</button>
      </div>
      <div id="testResult" class="hidden mt-4 p-4 rounded-xl text-center font-bold"></div>
  </div>

  <div class="flex justify-between pt-6">
      <button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button>
      <button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download App ‚Üí</button>
  </div>
</div>
        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div><h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2><p class="text-gray-400">Files generated for: <span id="finalAppName" class="text-blue-400">App</span></p></div>
          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">Download On-The-Go_Lone_Worker_Apps.zip</button>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">üöÄ</span><div><h2 class="text-2xl font-bold text-white">1. Host with Netlify (Free)</h2></div></div>
                <div class="bg-orange-900/50 border border-orange-500 p-4 rounded mb-6"><h4 class="font-bold text-orange-400 mb-1">‚ö†Ô∏è DON'T LOSE YOUR APP!</h4><p class="text-sm text-gray-300">If you just drag-and-drop without an account, your app will <strong>delete itself after 1 hour</strong>.</p></div>
                <ol class="list-decimal pl-6 space-y-4 text-sm text-gray-300">
                    <li>Go to <a href="https://app.netlify.com/drop" target="_blank" class="text-blue-400 underline font-bold">app.netlify.com/drop</a>.</li>
                    <li>Drag the <strong>WorkerApp</strong> folder from your ZIP into the browser.</li>
                    <li><strong>IMMEDIATELY</strong> click "Sign up to claim this site".</li>
                    <li>Click <strong>Site Settings > Change Site Name</strong> to something friendly (e.g. <code>my-org-safety.netlify.app</code>).</li>
                </ol>
            </div>

            <div class="bg-indigo-900/30 p-8 rounded-xl border border-indigo-500/50">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">‚úâÔ∏è</span><div><h2 class="text-2xl font-bold text-white">2. Launch Pack</h2></div></div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-indigo-300 text-xs font-bold uppercase mb-1">Paste your Worker App URL (from Netlify)</label>
                        <input type="url" id="workerAppUrl" class="input-field" placeholder="https://my-safety-app.netlify.app" oninput="generateLaunchPack()">
                    </div>
                    
                    <div id="launchPack" class="hidden grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-indigo-300 text-xs font-bold uppercase mb-1">Draft Email</label>
                            <textarea id="launchEmail" class="w-full h-40 bg-gray-900 border border-indigo-500/50 rounded p-4 text-sm text-gray-300 font-mono" readonly></textarea>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('launchEmail').value); alert('Email copied!');" class="mt-2 btn btn-xs bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Copy Email Text</button>
                        </div>
                        <div class="flex flex-col items-center justify-center bg-white p-4 rounded-lg">
                            <img id="qrImage" src="" class="w-32 h-32 mb-2">
                            <p class="text-gray-900 text-xs font-bold text-center">Right-Click to Save<br>for Posters</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    let TEMPLATES = {};

    const REGION_DATA = {
        "+64": { name: "New Zealand", term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" },
        "+61": { name: "Australia", term: "Rego", locale: "en-AU", tz: "Australia/Sydney" },
        "+44": { name: "United Kingdom", term: "Inspection", locale: "en-GB", tz: "Europe/London" },
        "+1":  { name: "USA / Canada", term: "Inspection", locale: "en-US", tz: "America/New_York" },
        "":    { name: "Universal", term: "Inspection", locale: "en-US", tz: "UTC" }
    };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        document.getElementById('mainContent').classList.remove('blur-sm');
        document.getElementById('disclaimerModal').style.display = 'none';
        loadPersistedData();
        if(!document.getElementById('secretKey').value) generateMemorableKey('secretKey');
        if(!document.getElementById('workerKey').value) generateMemorableKey('workerKey');
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) {
            try { 
                const r = await fetch(f); 
                if (r.ok) TEMPLATES[k] = await r.text();
            } catch(e){ console.error(e); }
        }
    };

    function handleLogo(input) {
        if (input.files[0]) {
            const r = new FileReader();
            r.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const c = document.createElement('canvas'); c.width = 192; c.height = 192;
                    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const d = c.toDataURL('image/png');
                    document.getElementById('logoImg').src = d; document.getElementById('logoImg').classList.remove('hidden');
                    document.getElementById('logoText').textContent = "‚úÖ Logo Ready"; document.getElementById('logoUrl').value = d;
                    saveInput(document.getElementById('logoUrl'));
                    triggerResample();
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function triggerResample() {
        const img = document.getElementById('logoImg'); if (!img.src || img.src.length < 100) return;
        const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
        const data = ctx.getImageData(30, 30, 132, 132).data; const clusters = [];
        for (let i = 0; i < data.length; i += 12) {
            if (data[i + 3] < 180) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const max = Math.max(r, g, b), min = Math.min(r, g, b), sat = (max - min) / max, bri = max / 255;
            if (sat < 0.22 || bri > 0.90 || bri < 0.15) continue;
            const key = `${Math.round(r/25)*25},${Math.round(g/25)*25},${Math.round(b/25)*25}`;
            let existing = clusters.find(c => c.key === key);
            if(existing) existing.count++; else clusters.push({key, count: 1, rgb: [r,g,b]});
        }
        clusters.sort((a,b) => b.count - a.count);
        const distinct = [];
        for(let c of clusters) {
            if(distinct.length >= 3) break;
            const isTooSimilar = distinct.some(d => {
                const diff = Math.sqrt(Math.pow(c.rgb[0]-d.rgb[0],2) + Math.pow(c.rgb[1]-d.rgb[1],2) + Math.pow(c.rgb[2]-d.rgb[2],2));
                return diff < 60;
            });
            if(!isTooSimilar) distinct.push(c);
        }
        const container = document.getElementById('logoClusterSwatches'); container.innerHTML = '';
        if(distinct.length > 0) {
            distinct.forEach((cluster, idx) => {
                const primary = rgbToHex(`rgb(${cluster.rgb.join(',')})`);
                const accent = idx < distinct.length - 1 ? rgbToHex(`rgb(${distinct[idx+1].rgb.join(',')})`) : primary;
                const swatch = document.createElement('div'); swatch.className = "preset-swatch";
                swatch.innerHTML = `<div class="swatch-half" style="background:${primary}"></div><div class="swatch-half" style="background:${accent}"></div>`;
                swatch.onclick = function() { applyPreset(primary, accent, this); };
                container.appendChild(swatch);
                if(idx === 0) applyPreset(primary, accent, swatch);
            });
        }
        document.getElementById('paletteArea').classList.remove('hidden');
    }

    function rgbToHex(rgb) { const match = rgb.match(/\d+/g); return "#" + match.slice(0,3).map(x => parseInt(x).toString(16).padStart(2, '0')).join(''); }

    function applyPreset(primary, accent, el) {
        document.getElementById('primaryColorBox').style.backgroundColor = primary;
        document.getElementById('accentColorBox').style.backgroundColor = accent;
        localStorage.setItem('otg_theme_primary', primary);
        localStorage.setItem('otg_theme_accent', accent);
        document.querySelectorAll('.preset-swatch').forEach(s => s.classList.remove('selected'));
        if(el) el.classList.add('selected');
    }

    function generateMemorableKey(targetId) {
        const adjs = ['Safe','Swift','Blue','Red','Gold','Green','Bright','Firm','Iron','Steel'];
        const nouns = ['Guard','Watch','Shield','Falcon','Eagle','Hawk','Post','Base','Fort','Gate'];
        const num = Math.floor(Math.random() * 90) + 10;
        let val = targetId === 'workerKey' ? "wk_" + Math.random().toString(36).substr(2, 9) : `${adjs[Math.floor(Math.random()*adjs.length)]}-${nouns[Math.floor(Math.random()*nouns.length)]}-${num}`;
        document.getElementById(targetId).value = val; saveInput(document.getElementById(targetId)); if(targetId === 'secretKey') validateKey();
    }

    function saveInput(el) { if(el.type === 'checkbox') localStorage.setItem('otg_' + el.id, el.checked); else localStorage.setItem('otg_' + el.id, el.value); }
    function updateCharCount(el) { document.getElementById('charCount').innerText = `${el.value.length}/${el.maxLength}`; }
    function validateKey() { const k = document.getElementById('secretKey').value; const el = document.getElementById('keyStrength'); if(k.length < 8) { el.innerText = "‚ö†Ô∏è Strength: Weak"; el.className = "text-xs mt-2 font-bold text-red-400"; } else { el.innerText = "‚úÖ Strength: Good"; el.className = "text-xs mt-2 font-bold text-green-400"; } }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function toggleCheck(el) { el.classList.toggle('checked'); el.querySelector('input').checked = el.classList.contains('checked'); }
    function showUrlInput() { if(Array.from(document.querySelectorAll('.checklist-checkbox')).every(i => i.checked)) { document.getElementById('urlInputSection').classList.remove('hidden'); setTimeout(()=>document.getElementById('urlInputSection').classList.remove('opacity-0'),100); }}
    
    function loadPersistedData() { 
        ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'checkinMins', 'vehFreq', 'countrySelect', 'appName'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); 
        ['chkTravelReport', 'chkRedaction', 'chkVehicle', 'chkCheckin'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v !== null) document.getElementById(id).checked = (v === 'true'); });
    }
    
    function updateRegionInfo() {
        const sel = document.getElementById('countrySelect').value; selectedConfig = REGION_DATA[sel] || REGION_DATA[""];
        document.getElementById('detectedTz').textContent = selectedConfig.tz; document.getElementById('timezoneVal').value = selectedConfig.tz;
        document.getElementById('vehTermDisplay').textContent = selectedConfig.term; document.getElementById('phoneFmtDisplay').textContent = sel + "...";
        document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale; saveInput(document.getElementById('countrySelect'));
    }

    function toggleEnterBtn() { const chk = document.getElementById('chkAccept'); document.getElementById('btnEnter').disabled = !chk.checked; }
    function setupDragDrop() { const dz = document.getElementById('dropZone'); dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('border-blue-500'); }); dz.addEventListener('dragleave', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); }); dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); }); }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); for(let i=1; i<=5; i++){ const t = document.getElementById('tab'+i); if(i===n){t.classList.add('active'); if(n===3)generateScript();}else{t.classList.remove('active');} } }
    function toggleCheckin() { document.getElementById('checkinOptions').style.display = document.getElementById('chkCheckin').checked ? 'flex' : 'none'; }
    function toggleVehicle() { document.getElementById('vehOptions').style.display = document.getElementById('chkVehicle').checked ? 'block' : 'none'; }
    
    function copyVisitsHeaders() { navigator.clipboard.writeText("Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4"); alert("Copied!"); }
    function copyTemplatesSetup() { navigator.clipboard.writeText("Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?\nREPORT\tVehicle Safety Check\tALL\t\t[TEXT] Registration Plate\t[YESNO] Current Rego & WOF?\t[DATE] WOF Expiry\t[GPS] Inspection Location\t[HEADING] Tyres\t[TEXT] Tread Depth (New/Good/Low)\t[PHOTO] Tread Photo\t[TEXT] Tyre Pressures (PSI)\t[HEADING] Under Hood\t[YESNO] Oil Level OK?\t[PHOTO] Oil Level\t[YESNO] Coolant/Water OK?\t[PHOTO] Coolant Level\t[YESNO] Brake Fluid OK?\t[PHOTO] Brake Fluid\nREPORT\tTravel Report\tALL\t\t[NUMBER] Distance (km)\t[TEXT] Trip Details\t[PHOTO] Odometer Photo"); alert("Copied!"); }
    function copySitesSetup() { navigator.clipboard.writeText("Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes\nALL\tStandard Visit\tAcme Corp\tHead Office\t123 Main St\tSteve\t021123456\tsteve@acme.com\tGate Code: 4455"); alert("Copied!"); }
    function copyStaffSetup() { navigator.clipboard.writeText("Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry\nJohn Doe\tDriver\tActive\t\t\t\t"); alert("Copied!"); }

    function generateScript() {
    if(!TEMPLATES.backend) return;
    const code = TEMPLATES.backend
        .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
        .replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
        .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
        .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
        .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
        .replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
        .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
        .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value || "Pacific/Auckland")
        .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value)
        .replace('%%ENABLE_REDACTION%%', document.getElementById('chkRedaction').checked)
        .replace('%%VEHICLE_TERM%%', selectedConfig.term)
        .replace('%%COUNTRY_PREFIX%%', document.getElementById('countrySelect').value)
        .replace('%%LOCALE%%', selectedConfig.locale); // Universal Regional Logic
    document.getElementById('codeDisplay').textContent = code;
}
    
    function copyScript() { if(document.getElementById('codeDisplay').textContent === "Generating code...") generateScript(); setTimeout(() => { navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Copied!"); }, 100); }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const resBox = document.getElementById('testResult');
        resBox.classList.remove('hidden'); resBox.textContent = "Testing..."; resBox.className = "mt-4 p-4 rounded-lg text-center bg-gray-900 text-yellow-400 font-bold";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value)).then(res => res.json()).then(data => { if(data.status === "success") { resBox.textContent = "‚úÖ Success!"; resBox.className = "mt-4 p-4 rounded-lg text-center bg-green-900 text-white font-bold"; document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50', 'cursor-not-allowed'); document.getElementById('finalAppName').innerText = document.getElementById('orgName').value; } else throw new Error(); }).catch(() => { resBox.textContent = "‚ùå Connection Failed. Check permissions."; resBox.className = "mt-4 p-4 rounded-lg text-center bg-red-900 text-white font-bold"; });
    }

    function processGuideTemplate(html) {
        if(!html) return ""; let out = html.replace(/%%ORG_NAME%%/g, document.getElementById('orgName').value).replace(/%%ESCALATION_MINUTES%%/g, document.getElementById('escalationMins').value).replace(/%%VEHICLE_TERM%%/g, selectedConfig.term);
        const processBlock = (tag, isActive) => { const regex = new RegExp(`([\\s\\S]*?)`, 'g'); out = out.replace(regex, (m, c) => isActive ? c : ""); };
        processBlock('VEHICLE', document.getElementById('chkVehicle').checked); return out;
    }

    function downloadZip() {
    const zip = new JSZip(); 
    const org = document.getElementById('orgName').value; 
    const appName = document.getElementById('appName').value || "Safety"; 
    const url = document.getElementById('webAppUrl').value; 
    const secret = document.getElementById('secretKey').value; 
    const worker = document.getElementById('workerKey').value; 
    const logoData = document.getElementById('logoUrl').value; 
    const primaryColor = localStorage.getItem('otg_theme_primary') || "#1e40af";
    const accentColor = localStorage.getItem('otg_theme_accent') || "#3b82f6";
    
    let wHtml = TEMPLATES.worker
        .replace(/%%ORG_NAME%%/g, org)
        .replace(/%%APP_NAME%%/g, appName)
        .replace(/%%GOOGLE_SHEET_URL%%/g, url)
        .replace(/%%LOGO_DATA%%/g, logoData)
        .replace(/%%SECRET_KEY%%/g, worker)
        .replace(/%%IS_ADVANCED%%/g, "true")
        .replace(/%%ENABLE_MILEAGE%%/g, "true")
        .replace(/%%CHECKIN_ENABLED%%/g, document.getElementById('chkCheckin').checked)
        .replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value)
        .replace(/%%ESCALATION_MINUTES%%/g, document.getElementById('escalationMins').value)
        .replace(/%%VEHICLE_ENABLED%%/g, document.getElementById('chkVehicle').checked)
        .replace(/%%VEHICLE_INTERVAL%%/g, document.getElementById('vehFreq').value)
        .replace(/%%COUNTRY_PREFIX%%/g, document.getElementById('countrySelect').value)
        .replace(/%%REQ_TRAVEL_REPORT%%/g, document.getElementById('chkTravelReport').checked)
        .replace(/%%VEHICLE_TERM%%/g, selectedConfig.term)
        .replace(/%%VOICE_LOCALE%%/g, selectedConfig.locale)
        .replace(/#1e40af/g, primaryColor)
        .replace(/#3b82f6/g, accentColor);

    // FIX: Convert logo to physical file for Manifest compliance
    const logoBlob = dataURLtoBlob(logoData);
    const manifest = { 
        name: org, 
        short_name: appName, 
        start_url: "index.html", 
        display: "standalone", 
        background_color: "#111827", 
        theme_color: primaryColor, 
        icons: [ 
            { src: "icon.png", sizes: "192x192", type: "image/png" }, 
            { src: "icon.png", sizes: "512x512", type: "image/png" } 
        ] 
    };

    // FIX: Service Worker now caches the physical icon and manifest
    const swCode = `const CACHE_NAME = 'otg-v${Date.now()}'; 
        const urlsToCache = ['./','./index.html','./manifest.json','./icon.png']; 
        self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache)))); 
        self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));`;

    const workerFolder = zip.folder("WorkerApp");
    workerFolder.file("index.html", wHtml);
    workerFolder.file("sw.js", swCode);
    workerFolder.file("manifest.json", JSON.stringify(manifest, null, 2));
    workerFolder.file("icon.png", logoBlob);
    workerFolder.file("USER_GUIDE.html", TEMPLATES.guide.replace(/%%ORG_NAME%%/g, org));

    zip.folder("MonitorApp").file("index.html", TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_URL%%/g, logoData).replace(/%%VEHICLE_TERM%%/g, selectedConfig.term));
    zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
    zip.file("OPERATIONS_MANUAL.html", TEMPLATES.manual.replace(/%%ORG_NAME%%/g, org).replace(/%%SECRET_KEY%%/g, secret).replace(/%%WORKER_KEY%%/g, worker));
    
    zip.generateAsync({type:"blob"}).then(b => {
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = org.replace(/[^a-z0-9]/gi, '_') + "_Lone_Worker_Apps.zip"; a.click();
    });
}

// FIX: Helper to convert DataURL to Binary Blob
function dataURLtoBlob(dataurl) {
    var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    while(n--) { u8arr[n] = bstr.charCodeAt(n); }
    return new Blob([u8arr], {type:mime});
}
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function generateLaunchPack() { const url = document.getElementById('workerAppUrl').value; if(url.length < 10) return; document.getElementById('launchPack').classList.remove('hidden'); }
  </script>
</body>
</html>







