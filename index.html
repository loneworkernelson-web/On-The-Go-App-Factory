<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.35 (Master Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; font-weight: 700; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #94a3b8; border-bottom: 4px solid transparent; transition: all 0.2s; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; font-weight: 700; }
    .drop-zone { border: 4px dashed #475569; border-radius: 16px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .checklist-checkbox { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
    .preset-swatch { width: 56px; height: 56px; border-radius: 12px; cursor: pointer; border: 3px solid rgba(255,255,255,0.2); transition: all 0.1s; display: flex; overflow: hidden; }
    .preset-swatch:hover { transform: scale(1.1); border-color: #3b82f6; }
    .preset-swatch.selected { outline: 4px solid #3b82f6; outline-offset: 3px; transform: scale(1.05); border-color: white; }
    .swatch-half { flex: 1; height: 100%; }
    /* HIGH CONTRAST INSTRUCTION TEXT */
    .help-text { color: #ffffff !important; font-weight: 800; font-size: 11px; margin-top: 4px; line-height: 1.3; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Safety Notice</h2>
          <div class="space-y-4 text-gray-200 text-sm mb-6 font-bold">
              <p>The <strong>OTG AppSuite</strong> is a professional serverless safety solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>Active Use:</strong> Tracking requires staff to keep the app active on the device.</li>
                  <li><strong>Connectivity:</strong> Emergency alerts require internet data and valid API keys.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700 font-bold">
              <label class="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-300">I accept these technical and safety requirements.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-4 bg-gray-700 text-gray-500 font-extrabold rounded-xl transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="modal-backdrop">
      <div class="modal-content border-blue-500">
          <h2 class="text-xl font-extrabold text-white mb-4">üìÇ How to get a Drive Folder ID</h2>
          <p class="text-sm text-white font-bold mb-4">Open your Google Drive folder. Copy the long string of letters and numbers at the very end of the URL.</p>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all font-bold">
              drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong>
          </div>
          <button onclick="closeModal('driveHelpModal')" class="w-full py-3 bg-blue-600 text-white font-extrabold rounded-xl">Got it</button>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-white font-extrabold tracking-widest text-sm uppercase">v79.35 | Master Edition (Full Feature Restoration)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Build & Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-6">
              <div>
                  <label class="block text-blue-300 font-extrabold mb-1 text-xs uppercase tracking-widest">1. Organisation Name</label>
                  <input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)">
                  <p class="help-text italic">Appears in app headers, report emails, and generated safety manuals.</p>
              </div>
              
              <div>
                  <div class="flex justify-between items-center mb-1">
                      <label class="block text-blue-300 font-extrabold text-xs uppercase tracking-widest">2. App Icon Label</label>
                      <span class="text-[11px] text-gray-300 font-black" id="charCount">6/12</span>
                  </div>
                  <input type="text" id="appName" maxlength="12" class="input-field text-center font-black text-green-400 border-green-600/50" value="Safety" oninput="updateCharCount(this); saveInput(this)">
                  <p class="help-text italic">The short name workers see under the app icon on their phone (Max 12 chars).</p>
              </div>

              <div class="p-4 bg-gray-900 rounded-2xl border border-gray-700 shadow-inner">
                  <h3 class="text-white font-black mb-4 uppercase text-[10px] tracking-widest border-b border-gray-800 pb-2">üîê Security Connection Keys</h3>
                  <div class="mb-4">
                      <label class="block text-blue-300 font-extrabold mb-1 text-xs">Secret Key (Admin Only)</label>
                      <div class="flex gap-2"><input type="text" id="secretKey" class="input-field text-yellow-400 font-mono text-sm py-2" oninput="saveInput(this); validateKey();"><button onclick="generateMemorableKey('secretKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white py-2">üîÑ</button></div>
                      <p class="help-text italic">Used by administrators to access the spreadsheet. <strong>Do not share with staff.</strong></p>
                  </div>
                  <div>
                      <label class="block text-blue-300 font-extrabold mb-1 text-xs">Worker Key (App Setup)</label>
                      <div class="flex gap-2"><input type="text" id="workerKey" class="input-field text-green-400 font-mono text-sm py-2" oninput="saveInput(this)"><button onclick="generateMemorableKey('workerKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white py-2">üîÑ</button></div>
                      <p class="help-text italic">The "Handshake" key baked into the worker app to allow zero-config login.</p>
                  </div>
              </div>

              <div>
                  <label class="block text-blue-300 font-extrabold mb-1 text-xs uppercase tracking-widest">3. Regional Logic</label>
                  <select id="countrySelect" class="input-field cursor-pointer py-3 text-sm font-black" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option><option value="+61">Australia (+61)</option><option value="+44">United Kingdom (+44)</option><option value="+1">USA / Canada (+1)</option>
                  </select>
                  <div class="mt-2 bg-gray-900 p-3 rounded text-[10px] text-white grid grid-cols-2 gap-2 border border-gray-800 font-black font-mono">
                      <p>Timezone: <span id="detectedTz" class="text-blue-400">...</span></p><p>Term: <span id="vehTermDisplay" class="text-green-400">WOF</span></p>
                      <p>Voice: <span id="voiceLocaleDisplay" class="text-yellow-400">en-NZ</span></p><p>Prefix: <span id="phoneFmtDisplay" class="text-purple-400">+64</span></p>
                  </div>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-extrabold mb-3 text-sm uppercase tracking-widest">4. App Branding (Customise)</label>
              <div id="dropZone" class="drop-zone w-40 h-40 mx-auto rounded-full flex items-center justify-center mb-4 border-4" onclick="document.getElementById('logoInput').click()">
                <img id="logoImg" class="hidden h-full w-full object-cover">
                <span id="logoText" class="text-white text-[11px] uppercase font-black px-4 leading-tight">Drag Logo Here or Click to Upload</span>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)"><input type="hidden" id="logoUrl" oninput="saveInput(this)">

              <div id="paletteArea" class="hidden w-full bg-gray-900/50 p-6 rounded-3xl border border-gray-700 shadow-inner">
                  <div class="mb-4 text-left">
                      <div class="flex justify-between items-center mb-1">
                          <span class="text-[10px] text-gray-200 font-black uppercase tracking-widest leading-none">1. Extract Brand Pairs</span>
                          <button onclick="triggerResample()" class="text-[10px] text-blue-400 font-black hover:underline leading-none">‚Üª Resample</button>
                      </div>
                      <p class="help-text italic">Click 'Resample' to identify logical Primary and Accent pairs from your logo.</p>
                  </div>
                  
                  <div class="mb-6">
                      <span class="block text-[10px] text-gray-200 font-black uppercase tracking-widest mb-3 text-left">2. Choose Preferred Scheme</span>
                      <div class="flex gap-4 justify-center" id="logoClusterSwatches"></div>
                  </div>

                  <div class="pt-4 border-t border-gray-800 flex gap-10 justify-center items-center">
                      <div class="flex flex-col items-center gap-1"><div id="primaryColorBox" class="w-12 h-12 rounded-xl border-2 border-white/40 shadow-2xl"></div><span class="text-[9px] text-white font-black uppercase">Primary</span></div>
                      <div class="flex flex-col items-center gap-1"><div id="accentColorBox" class="w-12 h-12 rounded-xl border-2 border-white/40 shadow-2xl"></div><span class="text-[9px] text-white font-black uppercase">Accent</span></div>
                  </div>
                  
                  <p class="text-[10px] text-gray-400 mt-6 uppercase font-black mb-3 tracking-[0.2em] text-center border-t border-gray-800 pt-4">Enterprise Safe Fallbacks</p>
                  <div class="flex gap-4 justify-center" id="fallbackSwatches">
                      <div class="preset-swatch" onclick="applyPreset('#1e40af', '#3b82f6', this)" title="Blue"><div class="swatch-half bg-[#1e40af]"></div><div class="swatch-half bg-[#3b82f6]"></div></div>
                      <div class="preset-swatch" onclick="applyPreset('#064e3b', '#10b981', this)" title="Green"><div class="swatch-half bg-[#064e3b]"></div><div class="swatch-half bg-[#10b981]"></div></div>
                      <div class="preset-swatch" onclick="applyPreset('#450a0a', '#ef4444', this)" title="Red"><div class="swatch-half bg-[#450a0a]"></div><div class="swatch-half bg-[#ef4444]"></div></div>
                      <div class="preset-swatch" onclick="applyPreset('#1e293b', '#64748b', this)" title="Slate"><div class="swatch-half bg-[#1e293b]"></div><div class="swatch-half bg-[#64748b]"></div></div>
                  </div>
              </div>
            </div>
          </div>

          <div class="highlight-box border-blue-500/30 mt-8">
             <div class="flex items-center gap-3 mb-6"><span class="text-2xl">üõ°Ô∏è</span><h3 class="text-xl font-black text-white uppercase tracking-widest">Safety & Fleet Options</h3></div>
             <div class="grid md:grid-cols-2 gap-10">
                 <div class="space-y-6">
                     <div>
                         <label class="block text-white font-black text-xs uppercase tracking-widest">Alarm Grace Period (Mins)</label>
                         <input type="number" id="escalationMins" value="15" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-black text-xl" oninput="saveInput(this)">
                         <p class="help-text italic leading-tight">Time allowed for workers to mark themselves "Safe" before the emergency alert fires.</p>
                     </div>
                     <div class="space-y-4">
                        <div>
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="chkCheckin" class="w-6 h-6 rounded bg-gray-700" onchange="toggleCheckin(); saveInput(this)"><span class="text-sm font-black text-gray-200">Periodic Check-in</span></label>
                            <div id="checkinOptions" class="hidden ml-9 mt-1 items-center gap-2 font-black"><input type="number" id="checkinMins" value="60" class="bg-gray-800 border border-gray-600 rounded p-1 w-16 text-center text-white" oninput="saveInput(this)"><span>mins</span></div>
                        </div>
                        <div>
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="chkVehicle" class="w-6 h-6 rounded bg-gray-700" onchange="toggleVehicle(); saveInput(this)" checked><span class="text-sm font-black text-gray-200">Vehicle Maintenance Tracking</span></label>
                            <div id="vehOptions" class="ml-9 mt-1 text-[11px] text-white font-black italic">Repeats every <input type="number" id="vehFreq" value="120" class="bg-gray-800 border border-gray-600 rounded p-1 w-12 text-center" oninput="saveInput(this)"> Days.</div>
                        </div>
                        <label class="flex items-start gap-3 cursor-pointer pt-4 border-t border-gray-700"><input type="checkbox" id="chkRedaction" class="mt-1 w-6 h-6 rounded bg-gray-700" onchange="saveInput(this)" checked><div><span class="text-sm font-black text-white uppercase tracking-widest">AI Privacy Redaction</span><p class="text-[10px] text-red-400 font-black uppercase leading-tight mt-1 tracking-widest">Crucial: Removes staff names before sending notes to Gemini AI.</p></div></label>
                     </div>
                 </div>
                 <div class="space-y-6">
                     <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase tracking-widest">Textbelt Key (SMS Alerts)</label><a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="input-field py-2 text-xs font-mono font-bold" placeholder="Optional" oninput="saveInput(this)"><p class="help-text italic leading-tight">Essential for sending high-priority SMS alerts to contacts if an alarm fires.</p></div>
                     <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase tracking-widest">Gemini AI Key (Grammar)</label><a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a></div><input type="text" id="geminiKey" class="input-field py-2 text-xs font-mono font-bold" placeholder="Optional" oninput="saveInput(this)"><p class="help-text italic leading-tight">Used to automatically professionalise worker reports and fix spelling.</p></div>
                     <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase tracking-widest">ORS Key (Mileage Tracking)</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="input-field py-2 text-xs font-mono font-bold" placeholder="Optional" oninput="saveInput(this)"><p class="help-text italic leading-tight">Required for road-accurate mileage tracking. This key is hidden from workers.</p></div>
                     <div><div class="flex justify-between items-end mb-1"><label class="text-[11px] font-black text-indigo-300 uppercase tracking-widest">Photo Folder ID</label><a onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link">Where is this?</a></div><input type="text" id="folderId" class="input-field py-2 text-xs font-mono font-bold" placeholder="Optional" oninput="saveInput(this)"><p class="help-text italic leading-tight">Organises all report photos into a dedicated Drive folder for the Diocese.</p></div>
                 </div>
             </div>
          </div>
          <div class="flex justify-end pt-6"><button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12 shadow-2xl font-black uppercase tracking-widest">Next: Database Setup ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
            <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-10 rounded-3xl border border-blue-500 shadow-xl text-center">
                <h2 class="text-3xl font-black text-white mb-2 uppercase tracking-widest">Option A: The Automated Way</h2>
                <div class="bg-yellow-900/40 border-l-8 border-yellow-500 p-5 mb-8 text-left max-w-2xl mx-auto rounded-r font-black">
                    <p class="text-yellow-300 text-sm flex items-center gap-2 italic tracking-widest uppercase">‚≠ê Recommended for Trial Owners</p>
                    <p class="text-white text-xs mt-2 leading-relaxed uppercase tracking-tighter">Sign into the dedicated <strong>Google Account</strong> you want to own this system before clicking below.</p>
                </div>
                <button onclick="openMagicLink()" class="btn btn-success text-xl px-12 py-6 shadow-2xl transform hover:-translate-y-2 font-black uppercase tracking-widest">‚ú® Create Database Copy</button>
            </div>
            <div class="border border-gray-700 rounded-2xl p-6 bg-gray-900/30 shadow-inner">
                <button onclick="document.getElementById('manualSetup').classList.toggle('hidden')" class="w-full flex justify-between items-center text-gray-400 hover:text-white font-black uppercase tracking-[0.2em] text-xs"><span>Option B: Manual Setup Blueprints</span><span>‚ñº</span></button>
                <div id="manualSetup" class="hidden mt-8 space-y-6">
                    <div class="grid md:grid-cols-2 gap-6 text-center font-black">
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-blue-400 text-xs mb-3 uppercase tracking-widest">Visits Tab</h3><button onclick="copyData('Visits')" class="w-full bg-blue-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-purple-400 text-xs mb-3 uppercase tracking-widest">Templates Tab</h3><button onclick="copyData('Templates')" class="w-full bg-purple-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-lg"><h3 class="text-green-400 text-xs mb-3 uppercase tracking-widest">Sites Tab</h3><button onclick="copyData('Sites')" class="w-full bg-green-700 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-6 rounded-2xl border border-red-600 shadow-lg"><h3 class="text-red-400 text-xs mb-3 uppercase tracking-widest">Staff Tab</h3><button onclick="copyData('Staff')" class="w-full bg-red-800 text-white py-2 rounded-lg text-xs uppercase font-black">Copy Blueprint</button></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-8 bg-blue-900/20 border border-blue-500/30 rounded-3xl font-black shadow-inner"><h4 class="font-black text-blue-300 text-sm uppercase mb-3 tracking-widest">üí° Identity Matching</h4><p class="text-sm text-white leading-relaxed uppercase tracking-tighter">Worker names in the <strong>'Staff'</strong> sheet must match what they type into the app <strong>exactly</strong> (case-sensitive).</p></div>
            <div class="flex justify-between pt-8"><button onclick="gotoStep(1)" class="text-white font-black uppercase tracking-widest text-xs">Back</button><button onclick="gotoStep(3)" class="btn btn-primary text-lg shadow-2xl font-black uppercase tracking-widest">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-10">
          <div class="bg-gray-900 p-8 rounded-3xl border border-gray-600 space-y-6 shadow-2xl">
              <h3 class="font-black text-green-400 text-xl uppercase tracking-widest">1. Install System "Brain"</h3>
              <p class="text-sm text-white font-black italic">This script handles all safety logic and database synchronization.</p>
              <div class="space-y-3">
                  <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox"><span class="text-sm text-white font-black uppercase tracking-tighter">Click "Copy Code" below.</span></div>
                  <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox"><span class="text-sm text-white font-black uppercase tracking-tighter">Go to Spreadsheet > <strong>Extensions > Apps Script</strong>.</span></div>
                  <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox"><span class="text-sm text-white font-black uppercase tracking-tighter">Delete any text already in the editor.</span></div>
                  <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox"><span class="text-sm text-white font-black uppercase tracking-tighter"><strong>Paste</strong> the code and click <strong>Save</strong> (Disk Icon).</span></div>
              </div>
              <button onclick="copyScript()" class="btn bg-blue-600 text-white w-full font-black shadow-2xl py-4 uppercase tracking-widest text-lg">üìã COPY SYSTEM CODE</button>
              <div id="codeContainer" class="hidden mt-4"><pre id="codeDisplay" class="code-scroll">Generating...</pre></div>
          </div>

          <div class="bg-gray-900 p-8 rounded-3xl border border-purple-600/50 space-y-6 shadow-2xl">
              <h3 class="font-black text-purple-400 text-xl uppercase tracking-widest">2. Set the Watchdog Alarms (Triggers)</h3>
              <p class="text-sm text-white font-black italic leading-relaxed uppercase tracking-tighter">Follow these steps exactly to automate your safety checks:</p>
              <div class="grid md:grid-cols-2 gap-8">
                  <div class="bg-gray-800 p-6 rounded-3xl border border-purple-500/30 shadow-lg">
                      <h4 class="font-black text-white text-xs mb-4 uppercase tracking-[0.2em]">A. Safety Watchdog</h4>
                      <ol class="list-decimal ml-5 space-y-2 text-[12px] text-white font-black uppercase tracking-tighter leading-tight">
                          <li>Click the <strong>Alarm Clock Icon</strong> (Triggers) on the sidebar.</li>
                          <li>Click <strong>+ Add Trigger</strong> (bottom right).</li>
                          <li>Function: <strong>checkOverdueVisits</strong>.</li>
                          <li>Source: <strong>Time-driven</strong>.</li>
                          <li>Type: <strong>Minutes timer</strong> | <strong>Every 10 minutes</strong>.</li>
                      </ol>
                  </div>
                  <div class="bg-indigo-900/30 p-6 rounded-3xl border border-indigo-500/30 shadow-lg">
                      <h4 class="font-black text-white text-xs mb-4 uppercase tracking-[0.2em]">B. Privacy Shredder</h4>
                      <ol class="list-decimal ml-5 space-y-2 text-[12px] text-white font-black uppercase tracking-tighter leading-tight">
                          <li>Add a second trigger.</li>
                          <li>Choose <strong>cleanupPrivateSentNotes</strong>.</li>
                          <li>Source: <strong>Time-driven</strong>.</li>
                          <li>Type: <strong>Hour timer</strong> | <strong>Every Hour</strong>.</li>
                          <li>Click <strong>Save</strong>.</li>
                      </ol>
                  </div>
              </div>
          </div>

          <div id="urlInputSection" class="space-y-6 pt-8 border-t border-gray-700">
              <label class="block text-green-400 font-black text-center uppercase tracking-[0.3em] text-sm">3. Paste your Web App URL here:</label>
              <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50 text-xl" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)">
              <div class="flex justify-center">
                  <button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-black py-5 px-16 rounded-2xl shadow-2xl uppercase tracking-widest text-lg">üì° TEST SYSTEM CONNECTION</button>
              </div>
              <div id="testResult" class="hidden mt-4 p-4 rounded-xl text-center font-black uppercase tracking-widest"></div>
          </div>
          <div class="flex justify-between pt-8"><button onclick="gotoStep(2)" class="text-white font-black uppercase tracking-widest text-xs">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed shadow-2xl font-black uppercase tracking-widest">Next: Build App ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-12 py-12">
            <div class="text-emerald-400 text-8xl mb-4 animate-bounce">‚ú®</div>
            <h2 class="text-5xl font-black text-white uppercase tracking-widest">Production Build Ready</h2>
            <p class="help-text text-xl">Your ZIP will contain the Worker App (with sw.js), User Guide, and Private Backend Code.</p>
            <button onclick="downloadZip()" class="btn btn-success py-8 text-3xl w-full max-w-2xl shadow-2xl transform hover:scale-105 transition-all font-black uppercase tracking-widest">Download OTG_AppSuite.zip</button>
            <div class="flex justify-between pt-12"><button onclick="gotoStep(3)" class="text-white font-black uppercase tracking-widest text-xs">Back</button><button onclick="gotoStep(5)" class="btn btn-primary shadow-2xl font-black uppercase tracking-widest">Next: Deployment ‚Üí</button></div>
        </div>

<div id="step5" class="step-section space-y-12">
            <div class="bg-gray-900 p-10 rounded-3xl border border-gray-700 shadow-2xl">
                <div class="flex items-center gap-4 mb-6">
                    <span class="text-4xl">üöÄ</span>
                    <h2 class="text-3xl font-black text-white uppercase tracking-widest">Host the Worker App</h2>
                </div>
                
                <div class="bg-red-900/40 border-l-8 border-red-600 p-5 mb-10 font-black uppercase tracking-tighter">
                    <p class="text-red-400 text-sm leading-relaxed italic">‚ö†Ô∏è CRITICAL: Once uploaded, you MUST click "Sign up to claim your site" immediately. Without a free account, the link will expire and your workers will be locked out after 1 hour.</p>
                </div>
                
                <div class="grid gap-10">
                    <div class="flex gap-6">
                        <div class="w-12 h-12 rounded-2xl bg-blue-600 flex items-center justify-center font-black text-xl shrink-0 shadow-lg border-2 border-blue-400">1</div>
                        <div>
                            <p class="text-blue-300 font-black uppercase tracking-[0.2em] text-[10px] mb-1">Prepare the Package</p>
                            <p class="text-white font-bold text-sm leading-relaxed">Extract (unzip) the <strong>AppSuite.zip</strong> file you just downloaded. Inside, locate the folder named <strong>"WorkerApp"</strong>. This folder contains your personal production code and the <strong>USER_GUIDE.html</strong> for your staff.</p>
                        </div>
                    </div>

                    <div class="flex gap-6">
                        <div class="w-12 h-12 rounded-2xl bg-blue-600 flex items-center justify-center font-black text-xl shrink-0 shadow-lg border-2 border-blue-400">2</div>
                        <div>
                            <p class="text-blue-300 font-black uppercase tracking-[0.2em] text-[10px] mb-1">One-Drag Deployment</p>
                            <p class="text-white font-bold text-sm leading-relaxed">Open <a href="https://app.netlify.com/drop" target="_blank" class="text-blue-400 underline font-black">Netlify Drop</a> in a new tab. Drag the entire <strong>WorkerApp</strong> folder onto the page. Netlify will instantly provide a temporary public URL.</p>
                        </div>
                    </div>

                    <div class="flex gap-6">
                        <div class="w-12 h-12 rounded-2xl bg-blue-600 flex items-center justify-center font-black text-xl shrink-0 shadow-lg border-2 border-blue-400">3</div>
                        <div>
                            <p class="text-blue-300 font-black uppercase tracking-[0.2em] text-[10px] mb-1">Final Branding</p>
                            <p class="text-white font-bold text-sm leading-relaxed">Once logged in, go to <strong>Site Overview > Site Settings > Change Site Name</strong>. Enter a professional URL like <code>nelson-diocese-safety.netlify.app</code> to make the link official.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-indigo-900/30 p-10 rounded-3xl border border-indigo-500/50 shadow-2xl">
                <div class="flex items-center gap-4 mb-6">
                    <span class="text-4xl">üì¢</span>
                    <h2 class="text-3xl font-black text-white uppercase tracking-widest">Staff Onboarding Pack</h2>
                </div>
                <p class="text-gray-200 font-bold text-sm mb-8 leading-relaxed">Paste your final, professional Netlify URL below. This will generate your official "Welcome" pack for your staff trial.</p>
                
                <div class="mb-10">
                    <label class="block text-[10px] text-indigo-300 font-black uppercase tracking-widest mb-2 ml-1">Your Final Production URL</label>
                    <input type="url" id="workerAppUrl" class="input-field shadow-inner font-black border-2 border-indigo-500/30 bg-gray-900 focus:border-blue-500 placeholder-gray-600" placeholder="https://your-org-safety.netlify.app" oninput="generateLaunchPack()">
                </div>

                <div id="launchPack" class="hidden grid md:grid-cols-3 gap-10">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-gray-400 font-black uppercase tracking-widest mb-3 ml-1">Official Welcome Email</label>
                        <textarea id="launchEmail" class="w-full h-56 bg-gray-900 border border-indigo-500/50 rounded-2xl p-6 text-sm text-white font-mono shadow-inner font-bold leading-relaxed" readonly></textarea>
                        <div class="mt-4 flex items-center gap-3">
                            <span class="px-3 py-1 bg-indigo-900/50 text-indigo-300 text-[10px] font-black uppercase rounded-lg border border-indigo-500/30">Onboarding Pack Ready</span>
                            <span class="text-[10px] text-gray-500 font-bold">Copy this email and send to your staff team.</span>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl flex flex-col items-center justify-center shadow-2xl border-4 border-white transition-transform hover:scale-105">
                        <img id="qrImage" src="" class="w-44 h-44 mb-4">
                        <p class="text-gray-900 text-[10px] font-black uppercase tracking-widest text-center leading-tight">Worker App<br>Setup QR Code</p>
                        <p class="text-gray-500 text-[8px] font-bold mt-2 uppercase tracking-tighter">(Right-click image to save)</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-start pt-8">
                <button onclick="gotoStep(4)" class="text-white/50 hover:text-white font-black uppercase tracking-[0.2em] text-[10px] transition-colors group flex items-center gap-2">
                    <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Return to Build Configuration
                </button>
            </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    const BLUEPRINTS = {
        Visits: `Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4`,
        Staff: `Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry`,
        Sites: `Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes`,
        Templates: `Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?`,
    };
    let TEMPLATES = {};
    const REGION_DATA = { "+64": { term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" }, "+61": { term: "Rego", locale: "en-AU", tz: "Australia/Sydney" }, "+44": { term: "Inspection", locale: "en-GB", tz: "Europe/London" }, "+1": { term: "Inspection", locale: "en-US", tz: "America/New_York" } };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        document.getElementById('mainContent').classList.remove('blur-sm');
        document.getElementById('disclaimerModal').style.display = 'none';
        loadPersistedData();
        if(!document.getElementById('secretKey').value) generateMemorableKey('secretKey');
        if(!document.getElementById('workerKey').value) generateMemorableKey('workerKey');
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) { try { const r = await fetch(f + "?v=" + Date.now()); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){} }
    };

    function updateCharCount(el) { document.getElementById('charCount').innerText = `${el.value.length}/${el.maxLength}`; }

    function handleLogo(input) {
        if (input.files[0]) {
            const r = new FileReader(); r.onload = e => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); c.width = 192; c.height = 192;
                    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const d = c.toDataURL('image/png'); document.getElementById('logoImg').src = d; 
                    document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoUrl').value = d;
                    saveInput(document.getElementById('logoUrl')); triggerResample();
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
    }

function triggerResample() {
        const img = document.getElementById('logoImg'); if (!img.src || img.src.length < 100) return;
        const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
        const data = ctx.getImageData(30, 30, 132, 132).data; const clusters = [];
        for (let i = 0; i < data.length; i += 16) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const max = Math.max(r, g, b), min = Math.min(r, g, b), sat = (max - min) / max;
            if (sat < 0.25 || max < 30 || max > 240) continue;
            const key = `${Math.round(r/30)*30},${Math.round(g/30)*30},${Math.round(b/30)*30}`;
            let existing = clusters.find(c => c.key === key);
            if(existing) existing.count++; else clusters.push({key, count: 1, rgb: [r,g,b]});
        }
        clusters.sort((a,b) => b.count - a.count);
        const distinct = clusters.slice(0, 4);
        const container = document.getElementById('logoClusterSwatches'); container.innerHTML = '';
        
        distinct.forEach((c, idx) => {
            if (idx >= 3) return;
            const primary = "#" + c.rgb.map(x => x.toString(16).padStart(2, '0')).join('');
            const next = distinct[idx+1] || distinct[0] || {rgb: [255,255,255]};
            const accent = "#" + next.rgb.map(x => x.toString(16).padStart(2, '0')).join('');
            
            const swatch = document.createElement('div'); swatch.className = "preset-swatch";
            swatch.innerHTML = `<div class="swatch-half" style="background:${primary}"></div><div class="swatch-half" style="background:${accent}"></div>`;
            swatch.onclick = () => applyPreset(primary, accent, swatch);
            container.appendChild(swatch);
            if(idx === 0) applyPreset(primary, accent, swatch);
        });

        // RESTORED: This line is required to make the branding section visible!
        document.getElementById('paletteArea').classList.remove('hidden');
    }

    function applyPreset(p, a, el) {
        document.getElementById('primaryColorBox').style.backgroundColor = p;
        document.getElementById('accentColorBox').style.backgroundColor = a;
        localStorage.setItem('otg_theme_primary', p); localStorage.setItem('otg_theme_accent', a);
        document.querySelectorAll('.preset-swatch').forEach(s => s.classList.remove('selected'));
        if(el) el.classList.add('selected');
    }

    function generateMemorableKey(id) { document.getElementById(id).value = id === 'workerKey' ? "wk_" + Math.random().toString(36).substr(2, 9) : "ADM-" + Math.floor(1000 + Math.random() * 9000); saveInput(document.getElementById(id)); if(id==='secretKey') validateKey(); }
    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value); }
    function copyData(k) { navigator.clipboard.writeText(BLUEPRINTS[k]); alert(k + " Blueprint Copied!"); }
    function validateKey() { }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function toggleCheck(el) { el.classList.toggle('checked'); el.querySelector('input').checked = el.classList.contains('checked'); }
    function loadPersistedData() { ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'countrySelect', 'appName'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); ['chkRedaction', 'chkVehicle', 'chkCheckin'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v !== null) document.getElementById(id).checked = (v === 'true'); }); }
    function updateRegionInfo() { const sel = document.getElementById('countrySelect').value; selectedConfig = REGION_DATA[sel] || REGION_DATA["+64"]; document.getElementById('detectedTz').textContent = selectedConfig.tz; document.getElementById('vehTermDisplay').textContent = selectedConfig.term; document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale; document.getElementById('phoneFmtDisplay').textContent = sel; document.getElementById('timezoneVal').value = selectedConfig.tz; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('mainContent').classList.remove('blur-sm'); }
    function toggleEnterBtn() { document.getElementById('btnEnter').disabled = !document.getElementById('chkAccept').checked; }
    function setupDragDrop() { const dz = document.getElementById('dropZone'); dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('border-blue-500'); }); dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); }); }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); for(let i=1; i<=5; i++) document.getElementById('tab'+i).classList.toggle('active', i===n); if(n===3) generateScript(); }
    function toggleCheckin() { document.getElementById('checkinOptions').classList.toggle('hidden', !document.getElementById('chkCheckin').checked); }
    function toggleVehicle() { document.getElementById('vehOptions').classList.toggle('hidden', !document.getElementById('chkVehicle').checked); }
    function copyScript() { generateScript(); navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Copied!"); }
    
    function generateScript() {
        if(!TEMPLATES.backend) return;
        document.getElementById('codeDisplay').textContent = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value).replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value).replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value).replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value).replace('%%ENABLE_REDACTION%%', document.getElementById('chkRedaction').checked)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term).replace('%%COUNTRY_PREFIX%%', document.getElementById('countrySelect').value)
            .replace('%%LOCALE%%', selectedConfig.locale);
    }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const resBox = document.getElementById('testResult');
        resBox.classList.remove('hidden'); resBox.textContent = "Testing..."; resBox.className = "mt-4 p-4 rounded-xl text-center bg-gray-900 text-yellow-400 font-black uppercase";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value)).then(r => r.json()).then(d => {
            if(d.status === "success") {
                resBox.textContent = "‚úÖ Success!"; resBox.className = "mt-4 p-4 rounded-xl text-center bg-green-900 text-white font-black block shadow-2xl uppercase";
                document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50', 'cursor-not-allowed');
            } else throw new Error();
        }).catch(() => { resBox.textContent = "‚ùå Connection Failed. Check your URL."; resBox.className = "mt-4 p-4 rounded-xl text-center bg-red-900 text-white font-black block uppercase"; });
    }

    function downloadZip() {
        const zip = new JSZip(); 
        const org = document.getElementById('orgName').value;
        const appShort = document.getElementById('appName').value || "Safety";
        const url = document.getElementById('webAppUrl').value;
        const logoData = document.getElementById('logoUrl').value;
        const primary = localStorage.getItem('otg_theme_primary') || "#1e40af";
        const accent = localStorage.getItem('otg_theme_accent') || "#3b82f6";
        
        // FIX: Re-added all 18 missing injection handlers
        let wHtml = TEMPLATES.worker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%ORGANISATION_NAME%%/g, org)
            .replace(/%%APP_NAME%%/g, appShort)
            .replace(/%%GOOGLE_SHEET_URL%%/g, url)
            .replace(/%%SECRET_KEY%%/g, document.getElementById('workerKey').value)
            .replace(/%%IS_ADVANCED%%/g, "true")
            .replace(/%%ENABLE_MILEAGE%%/g, document.getElementById('orsKey').value ? "true" : "false")
            .replace(/%%CHECKIN_ENABLED%%/g, document.getElementById('chkCheckin').checked)
            .replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value)
            .replace(/%%ESCALATION_MINUTES%%/g, document.getElementById('escalationMins').value)
            .replace(/%%VEHICLE_ENABLED%%/g, document.getElementById('chkVehicle').checked)
            .replace(/%%VEHICLE_INTERVAL%%/g, document.getElementById('vehFreq').value)
            .replace(/%%COUNTRY_PREFIX%%/g, document.getElementById('countrySelect').value)
            .replace(/%%REQ_TRAVEL_REPORT%%/g, "true")
            .replace(/%%VEHICLE_TERM%%/g, document.getElementById('vehTermDisplay').innerText)
            .replace(/%%VOICE_LOCALE%%/g, document.getElementById('voiceLocaleDisplay').innerText)
            .replace(/%%LOGO_DATA%%/g, logoData)
            .replace(/#111827/g, primary) // Update background
            .replace(/#1e40af/g, primary) 
            .replace(/#3b82f6/g, accent);
        

const swCode = `
const CACHE_NAME = 'otg-safety-v81.36';
const CRITICAL_ASSETS = [
  './',
  './index.html',
  './manifest.json',
  './icon.png',
  'https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js',
  'https://cdn.tailwindcss.com'
];

// 1. INSTALL: Force-cache the logo and safety shell immediately
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      console.log('Finalizing Offline Safety Cache...');
      return cache.addAll(CRITICAL_ASSETS);
    }).then(() => self.skipWaiting())
  );
});

// 2. FETCH: Serve from cache first to ensure branding works in Dead Zones
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      // If found in cache, return it
      if (response) return response;

      // If not, fetch from network
      return fetch(event.request).then((networkResponse) => {
        // Only cache valid responses
        if (!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'basic') {
          // If it's a CORS request (like Tailwind), we use 'opaque' caching
          return networkResponse;
        }

        const responseToCache = networkResponse.clone();
        caches.open(CACHE_NAME).then((cache) => {
          cache.put(event.request, responseToCache);
        });

        return networkResponse;
      });
    })
  );
});

// 3. ACTIVATE: Clear old versions when you release a new Factory build
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(key => key !== CACHE_NAME).map(key => caches.delete(key))
    )).then(() => self.clients.claim())
  );
});`;
     
        const manifest = { 
            name: org, 
            short_name: appShort, 
            start_url: "./index.html", 
            display: "standalone", 
            theme_color: primary, 
            icons: [
                { src: "icon.png", sizes: "192x192", type: "image/png" },
                { src: "icon.png", sizes: "512x512", type: "image/png" }
            ] 
        };

        const workerFolder = zip.folder("WorkerApp");
        workerFolder.file("index.html", wHtml);
        workerFolder.file("sw.js", swCode);
        workerFolder.file("manifest.json", JSON.stringify(manifest, null, 2));
        workerFolder.file("icon.png", logoData.split(',')[1], {base64:true});
        workerFolder.file("USER_GUIDE.html", TEMPLATES.guide.replace(/%%ORG_NAME%%/g, org));
        
        zip.folder("MonitorApp").file("index.html", TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_URL%%/g, logoData));
        zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
        zip.file("OPERATIONS_MANUAL.html", TEMPLATES.manual.replace(/%%ORG_NAME%%/g, org).replace(/%%SECRET_KEY%%/g, document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value));
        
        zip.generateAsync({type:"blob"}).then(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = org.replace(/ /g,'_') + "_AppSuite.zip"; a.click();
        });
    }

    function generateLaunchPack() {
        const urlInput = document.getElementById('workerAppUrl');
        const url = urlInput.value.trim();
        const org = document.getElementById('orgName').value;
        
        if(url.length > 10 && url.startsWith('http')) {
            document.getElementById('launchPack').classList.remove('hidden');
            
// Use single quotes and (+) to build the string. This prevents internal quotes from crashing the script.
const emailBody = 'Hello Team,\n\n' +
    'We are launching our new Lone-Worker Safety System for ' + (typeof org !== 'undefined' ? org : 'the organisation') + '.\n\n' +
    'Please install your personal safety app by following these steps on your phone:\n\n' +
    '1. Open this link: ' + (typeof url !== 'undefined' ? url : '') + '\n' +
    '2. Once open, tap the \'Share\' or \'Menu\' icon and select \'Add to Home Screen\'.\n' +
    '3. Launch the app from your home screen and complete the one-time Setup Wizard.\n\n' +
    'Important: Use your full name exactly as it appears in our records to ensure your safety alerts are correctly matched.\n\n' +
    'Stay safe,\n' +
    'Management';
    
    document.getElementById('launchEmail').value = emailBody;
            
            // High-resolution QR generation with High Error Correction
            document.getElementById('qrImage').src = "https://api.qrserver.com/v1/create-qr-code/?size=250x250&ecc=H&margin=1&data=" + encodeURIComponent(url);
            
            urlInput.classList.remove('border-indigo-500/30');
            urlInput.classList.add('border-green-500/50');
        } else {
            document.getElementById('launchPack').classList.add('hidden');
            urlInput.classList.remove('border-green-500/50');
            urlInput.classList.add('border-indigo-500/30');
        }
    }
</script>
</body>
</html>


