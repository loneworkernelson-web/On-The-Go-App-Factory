<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.28 (Master Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .checklist-checkbox { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
    .preset-swatch { width: 36px; height: 36px; border-radius: 8px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: all 0.1s; display: flex; overflow: hidden; }
    .preset-swatch:hover { transform: scale(1.1); border-color: #3b82f6; }
    .preset-swatch.selected { outline: 4px solid #3b82f6; outline-offset: 2px; transform: scale(1.05); }
    .swatch-half { flex: 1; height: 100%; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a serverless "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>Active Monitoring:</strong> GPS tracking requires the worker app to be kept open or active.</li>
                  <li><strong>API Connectivity:</strong> SMS alerts and AI summaries require active data and valid API keys.</li>
                  <li><strong>No SLA:</strong> This is an open-source tool relying on Google/Netlify free tiers.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I understand and accept the safety limitations.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v79.28 | Master Edition (Full Feature Restoration)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Build & Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              
              <div>
                  <div class="flex justify-between items-center mb-2">
                      <label class="block text-blue-300 font-bold text-sm uppercase">App Icon Label</label>
                      <span class="text-xs text-gray-500" id="charCount">6/12</span>
                  </div>
                  <input type="text" id="appName" maxlength="12" class="input-field text-center font-bold text-green-400 border-green-600/50" value="Safety" oninput="updateCharCount(this); saveInput(this)">
                  <p class="text-[10px] text-gray-500 mt-1">Short name for the phone Home Screen (Max 12 chars).</p>
              </div>

              <div class="p-4 bg-gray-900 rounded-lg border border-gray-700 shadow-inner">
                  <h3 class="text-white font-bold mb-4 uppercase text-xs tracking-widest">üîê Security Keys</h3>
                  <div class="mb-4">
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Secret Key (Admin Only)</label>
                      <div class="flex gap-2"><input type="text" id="secretKey" class="input-field text-yellow-400 font-mono text-sm" oninput="saveInput(this); validateKey();"><button onclick="generateMemorableKey('secretKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white">üîÑ</button></div>
                      <p class="text-[10px] text-gray-500 mt-1">Protects your database. <strong>Do not share with staff.</strong></p>
                  </div>
                  <div>
                      <label class="block text-blue-300 font-bold mb-2 text-sm">Worker Key (App Handshake)</label>
                      <div class="flex gap-2"><input type="text" id="workerKey" class="input-field text-green-400 font-mono text-sm" oninput="saveInput(this)"><button onclick="generateMemorableKey('workerKey')" class="btn bg-gray-700 hover:bg-gray-600 text-white">üîÑ</button></div>
                      <p class="text-[10px] text-gray-500 mt-1">Baked into the app. Workers connect automatically.</p>
                  </div>
              </div>

              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">3. Regional Logic</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option><option value="+61">Australia (+61)</option><option value="+44">United Kingdom (+44)</option><option value="+1">USA / Canada (+1)</option>
                  </select>
                  <div class="mt-2 bg-gray-900 p-3 rounded text-[10px] text-gray-400 grid grid-cols-2 gap-2 border border-gray-800">
                      <p>Timezone: <span id="detectedTz" class="text-blue-400">...</span></p><p>Local Term: <span id="vehTermDisplay" class="text-green-400">WOF</span></p>
                      <p>Voice: <span id="voiceLocaleDisplay" class="text-yellow-400">en-NZ</span></p><p>Format: <span id="phoneFmtDisplay" class="text-purple-400">+64...</span></p>
                  </div>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">4. App Logo & Branding</label>
              <div id="dropZone" class="drop-zone w-32 h-32 mx-auto rounded-full flex items-center justify-center mb-4" onclick="document.getElementById('logoInput').click()">
                <img id="logoImg" class="hidden h-full w-full object-cover">
                <span id="logoText" class="text-gray-500 text-[10px] uppercase font-bold">Upload Logo</span>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)"><input type="hidden" id="logoUrl" oninput="saveInput(this)">

              <div id="paletteArea" class="hidden w-full bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                  <div class="flex justify-between items-center mb-2"><span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Identify Brand Colors</span><button onclick="triggerResample()" class="text-[10px] text-blue-400 font-bold hover:underline">‚Üª Resample</button></div>
                  <div class="flex gap-3 justify-center mb-4" id="logoClusterSwatches"></div>
                  <div class="pt-3 border-t border-gray-800 flex gap-4 justify-center items-center">
                      <div class="flex flex-col items-center gap-1"><div id="primaryColorBox" class="w-8 h-8 rounded border border-white/20"></div><span class="text-[7px] text-gray-400 font-bold uppercase">Primary</span></div>
                      <div class="flex flex-col items-center gap-1"><div id="accentColorBox" class="w-8 h-8 rounded border border-white/20"></div><span class="text-[7px] text-gray-400 font-bold uppercase">Accent</span></div>
                  </div>
                  <p class="text-[8px] text-gray-500 mt-4 uppercase font-bold mb-2 tracking-widest text-center">Enterprise Safe Fallbacks</p>
                  <div class="flex gap-2 justify-center" id="fallbackSwatches">
                      <div class="preset-swatch" onclick="applyPreset('#1e40af', '#3b82f6', this)"><div class="swatch-half bg-[#1e40af]"></div><div class="swatch-half bg-[#3b82f6]"></div></div>
                      <div class="preset-swatch" onclick="applyPreset('#064e3b', '#10b981', this)"><div class="swatch-half bg-[#064e3b]"></div><div class="swatch-half bg-[#10b981]"></div></div>
                      <div class="preset-swatch" onclick="applyPreset('#450a0a', '#ef4444', this)"><div class="swatch-half bg-[#450a0a]"></div><div class="swatch-half bg-[#ef4444]"></div></div>
                  </div>
              </div>
            </div>
          </div>

          <div class="highlight-box border-blue-500/30 mt-8">
             <div class="flex items-center gap-3 mb-4"><span class="text-2xl">üõ°Ô∏è</span><h3 class="text-xl font-bold text-white">Safety & Fleet Options</h3></div>
             <div class="grid md:grid-cols-2 gap-6">
                 <div class="space-y-4">
                     <div><label class="block text-gray-400 text-xs font-bold uppercase mb-1">Alarm Grace Period (Mins)</label><input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)"></div>
                     <div><label class="flex items-center gap-2"><input type="checkbox" id="chkCheckin" class="w-5 h-5 rounded" onchange="toggleCheckin(); saveInput(this)"><span class="text-white font-bold">Enable Check-in?</span></label><div id="checkinOptions" class="hidden mt-2 ml-7 items-center gap-2"><input type="number" id="checkinMins" value="60" class="input-field py-2 w-24 text-center" oninput="saveInput(this)"><span class="text-xs text-gray-400">mins</span></div></div>
                     <div><label class="flex items-center gap-2"><input type="checkbox" id="chkVehicle" class="w-5 h-5 rounded" onchange="toggleVehicle(); saveInput(this)" checked><span class="text-white font-bold">Vehicle Safety Checks</span></label><div id="vehOptions" class="mt-1 ml-7 text-xs text-gray-400">Repeat every <input type="number" id="vehFreq" value="120" class="bg-gray-800 border border-gray-600 rounded p-1 w-12 text-center" oninput="saveInput(this)"> Days.</div></div>
                 </div>
                 <div class="space-y-4">
                     <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-[10px] uppercase">Textbelt (SMS Alerts)</label><a href="https://textbelt.com/#pricing" target="_blank" class="text-[10px] text-blue-400 underline">Get Key</a></div><input type="text" id="textbeltKey" class="input-field py-2 text-xs" placeholder="Optional" oninput="saveInput(this)"></div>
                     <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-[10px] uppercase">Gemini AI (Report Polish)</label><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-blue-400 underline">Get Key</a></div><input type="text" id="geminiKey" class="input-field py-2 text-xs" placeholder="Optional" oninput="saveInput(this)"></div>
                     <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-[10px] uppercase">ORS (Road Mileage)</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="text-[10px] text-blue-400 underline">Get Key</a></div><input type="text" id="orsKey" class="input-field py-2 text-xs" placeholder="Optional" oninput="saveInput(this)"></div>
                 </div>
             </div>
          </div>
          <div class="flex justify-end pt-6"><button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12">Next: Database Setup ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
            <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-8 rounded-2xl border border-blue-500 shadow-xl text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Option A: The Magic Copy</h2>
                <button onclick="openMagicLink()" class="btn btn-success text-xl px-10 py-5 shadow-lg transform hover:-translate-y-1">‚ú® Create Database Copy</button>
            </div>
            <div class="border border-gray-700 rounded-xl p-4">
                <button onclick="document.getElementById('manualSetup').classList.toggle('hidden')" class="w-full flex justify-between items-center text-gray-400 hover:text-white font-bold"><span>Option B: Manual Setup (Tab Blueprints)</span><span>‚ñº</span></button>
                <div id="manualSetup" class="hidden mt-6 space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-blue-400 text-sm">'Visits' Tab</h3><button onclick="copyData('Visits')" class="w-full bg-blue-700 text-white py-2 rounded mt-2 text-xs">Copy Headers</button></div>
                        <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-purple-400 text-sm">'Templates' Tab</h3><button onclick="copyData('Templates')" class="w-full bg-purple-700 text-white py-2 rounded mt-2 text-xs">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-green-400 text-sm">'Sites' Tab</h3><button onclick="copyData('Sites')" class="w-full bg-green-700 text-white py-2 rounded mt-2 text-xs">Copy Blueprint</button></div>
                        <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-red-400 text-sm">'Staff' Tab</h3><button onclick="copyData('Staff')" class="w-full bg-red-800 text-white py-2 rounded mt-2 text-xs">Copy Blueprint</button></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-6 bg-blue-900/20 border border-blue-500/30 rounded-xl"><h4 class="font-bold text-blue-300 text-sm uppercase mb-2 tracking-widest">üí° Identity Matching</h4><p class="text-sm text-gray-300">Names in the 'Staff' tab must match app entry <strong>exactly</strong> (case-sensitive).</p></div>
            <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(3)" class="btn btn-primary text-lg">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
              <h3 class="font-bold text-green-400 text-lg">1. Install System "Brain"</h3>
              <div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" class="checklist-checkbox"><span class="text-sm">Delete existing script and <strong>Paste</strong> the code.</span></div>
              <button onclick="copyScript()" class="btn bg-blue-600 text-white w-full">üìã COPY SYSTEM CODE</button>
              <div id="codeContainer" class="hidden mt-2"><pre id="codeDisplay" class="code-scroll">Generating...</pre></div>
          </div>
          <div class="bg-gray-900 p-6 rounded-xl border border-purple-600/50 space-y-4">
              <h3 class="font-bold text-purple-400 text-lg">2. Set Watchdog Alarms</h3>
              <div class="grid md:grid-cols-2 gap-4 text-[10px]">
                  <div class="bg-purple-900/30 p-3 rounded border border-purple-500/30"><strong>Overdue Alarms:</strong> checkOverdueVisits | Every 10m.</div>
                  <div class="bg-indigo-900/30 p-3 rounded border border-indigo-500/30"><strong>Privacy Shredder:</strong> cleanupPrivateSentNotes | Every 1h.</div>
              </div>
          </div>
          <div id="urlInputSection" class="space-y-4">
              <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300" placeholder="Paste /exec URL here" oninput="saveInput(this)">
              <button onclick="testConnection()" class="btn bg-yellow-600 text-white w-full">üì° TEST SYSTEM CONNECTION</button>
              <div id="testResult" class="hidden mt-4 p-4 rounded text-center font-bold"></div>
          </div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
            <h2 class="text-4xl font-bold text-white mb-2">Build Ready</h2>
            <button onclick="downloadZip()" class="btn btn-success py-5 text-2xl w-full max-w-md shadow-xl">Download OTG_Lone_Worker_Apps.zip</button>
            <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-4">1. Host with Netlify (Free)</h2>
                <p class="text-sm text-gray-300">Drag the <strong>WorkerApp</strong> folder from your ZIP into <a href="https://app.netlify.com/drop" target="_blank" class="text-blue-400 underline font-bold">Netlify Drop</a>.</p>
            </div>
            <div class="bg-indigo-900/30 p-8 rounded-xl border border-indigo-500/50">
                <h2 class="text-2xl font-bold text-white mb-4">2. Launch Pack</h2>
                <input type="url" id="workerAppUrl" class="input-field mb-4" placeholder="Paste your Netlify URL here" oninput="generateLaunchPack()">
                <div id="launchPack" class="hidden grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2"><textarea id="launchEmail" class="w-full h-40 bg-gray-900 border border-indigo-500/50 rounded p-4 text-xs text-gray-300" readonly></textarea></div>
                    <div class="bg-white p-4 rounded-lg flex flex-col items-center"><img id="qrImage" src="" class="w-32 h-32 mb-2"><p class="text-gray-900 text-[10px] font-bold">Setup QR Code</p></div>
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    const BLUEPRINTS = {
        Visits: `Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4`,
        Staff: `Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry`,
        Sites: `Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes`,
        Templates: `Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?`,
    };
    let TEMPLATES = {};
    const REGION_DATA = { "+64": { term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" }, "+61": { term: "Rego", locale: "en-AU", tz: "Australia/Sydney" }, "+44": { term: "Inspection", locale: "en-GB", tz: "Europe/London" }, "+1": { term: "Inspection", locale: "en-US", tz: "America/New_York" } };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        document.getElementById('mainContent').classList.remove('blur-sm');
        document.getElementById('disclaimerModal').style.display = 'none';
        loadPersistedData();
        if(!document.getElementById('secretKey').value) generateMemorableKey('secretKey');
        if(!document.getElementById('workerKey').value) generateMemorableKey('workerKey');
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) { try { const r = await fetch(f); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){} }
    };

    function updateCharCount(el) { document.getElementById('charCount').innerText = `${el.value.length}/${el.maxLength}`; }

    function handleLogo(input) {
        if (input.files[0]) {
            const r = new FileReader(); r.onload = e => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); c.width = 192; c.height = 192;
                    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const d = c.toDataURL('image/png'); document.getElementById('logoImg').src = d; 
                    document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoUrl').value = d;
                    saveInput(document.getElementById('logoUrl')); triggerResample();
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function triggerResample() {
        const img = document.getElementById('logoImg'); if (!img.src || img.src.length < 100) return;
        const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
        const data = ctx.getImageData(30, 30, 132, 132).data; const clusters = [];
        for (let i = 0; i < data.length; i += 12) {
            if (data[i + 3] < 180) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const max = Math.max(r, g, b), min = Math.min(r, g, b), sat = (max - min) / max, bri = max / 255;
            if (sat < 0.22 || bri > 0.90 || bri < 0.15) continue;
            const key = `${Math.round(r/25)*25},${Math.round(g/25)*25},${Math.round(b/25)*25}`;
            let existing = clusters.find(c => c.key === key);
            if(existing) existing.count++; else clusters.push({key, count: 1, rgb: [r,g,b]});
        }
        clusters.sort((a,b) => b.count - a.count);
        const distinct = [];
        for(let c of clusters) {
            if(distinct.length >= 3) break;
            const isTooSimilar = distinct.some(d => Math.sqrt(Math.pow(c.rgb[0]-d.rgb[0],2) + Math.pow(c.rgb[1]-d.rgb[1],2) + Math.pow(c.rgb[2]-d.rgb[2],2)) < 60);
            if(!isTooSimilar) distinct.push(c);
        }
        const container = document.getElementById('logoClusterSwatches'); container.innerHTML = '';
        distinct.forEach((c, idx) => {
            const hex = "#" + c.rgb.map(x => x.toString(16).padStart(2, '0')).join('');
            const swatch = document.createElement('div'); swatch.className = "preset-swatch";
            swatch.innerHTML = `<div class="swatch-half" style="background:${hex}"></div><div class="swatch-half" style="background:${hex}"></div>`;
            swatch.onclick = function() { applyPreset(hex, hex, this); };
            container.appendChild(swatch);
            if(idx === 0) applyPreset(hex, hex, swatch);
        });
        document.getElementById('paletteArea').classList.remove('hidden');
    }

    function applyPreset(p, a, el) {
        document.getElementById('primaryColorBox').style.backgroundColor = p;
        document.getElementById('accentColorBox').style.backgroundColor = a;
        localStorage.setItem('otg_theme_primary', p); localStorage.setItem('otg_theme_accent', a);
        document.querySelectorAll('.preset-swatch').forEach(s => s.classList.remove('selected'));
        if(el) el.classList.add('selected');
    }

    function generateMemorableKey(id) { document.getElementById(id).value = id === 'workerKey' ? "wk_" + Math.random().toString(36).substr(2, 9) : "ADM-" + Math.floor(1000 + Math.random() * 9000); saveInput(document.getElementById(id)); }
    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value); }
    function copyData(k) { navigator.clipboard.writeText(BLUEPRINTS[k]); alert(k + " Blueprint Copied!"); }
    function validateKey() { document.getElementById('keyStrength').innerText = document.getElementById('secretKey').value.length < 6 ? "Weak" : "Good"; }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function toggleCheck(el) { el.classList.toggle('checked'); el.querySelector('input').checked = el.classList.contains('checked'); }
    function loadPersistedData() { ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'escalationMins', 'countrySelect', 'appName'].forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); }
    function updateRegionInfo() { const sel = document.getElementById('countrySelect').value; selectedConfig = REGION_DATA[sel] || REGION_DATA["+64"]; document.getElementById('detectedTz').textContent = selectedConfig.tz; document.getElementById('vehTermDisplay').textContent = selectedConfig.term; document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale; document.getElementById('timezoneVal').value = selectedConfig.tz; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('mainContent').classList.remove('blur-sm'); }
    function toggleEnterBtn() { document.getElementById('btnEnter').disabled = !document.getElementById('chkAccept').checked; }
    function setupDragDrop() { const dz = document.getElementById('dropZone'); dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('border-blue-500'); }); dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); }); }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); for(let i=1; i<=5; i++) document.getElementById('tab'+i).classList.toggle('active', i===n); if(n===3) generateScript(); }
    function toggleCheckin() { document.getElementById('checkinOptions').classList.toggle('hidden', !document.getElementById('chkCheckin').checked); }
    function toggleVehicle() { document.getElementById('vehOptions').classList.toggle('hidden', !document.getElementById('chkVehicle').checked); }
    function copyScript() { generateScript(); navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Copied!"); }
    
    function generateScript() {
        if(!TEMPLATES.backend) return;
        document.getElementById('codeDisplay').textContent = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term)
            .replace('%%LOCALE%%', selectedConfig.locale);
    }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value)).then(r => r.json()).then(d => {
            if(d.status === "success") {
                document.getElementById('testResult').textContent = "‚úÖ Success!"; document.getElementById('testResult').className = "mt-4 p-4 rounded bg-green-900 text-white font-bold block";
                document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50');
            } else throw new Error();
        }).catch(() => { document.getElementById('testResult').textContent = "‚ùå Connection Failed."; document.getElementById('testResult').className = "mt-4 p-4 rounded bg-red-900 text-white font-bold block"; });
    }

    function downloadZip() {
        const zip = new JSZip(); const org = document.getElementById('orgName').value; const appShort = document.getElementById('appName').value || "Safety"; const logoData = document.getElementById('logoUrl').value;
        const primaryColor = localStorage.getItem('otg_theme_primary') || "#1e40af";
        let wHtml = TEMPLATES.worker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%APP_NAME%%/g, appShort)
            .replace(/%%GOOGLE_SHEET_URL%%/g, document.getElementById('webAppUrl').value)
            .replace(/%%LOGO_DATA%%/g, logoData)
            .replace(/%%SECRET_KEY%%/g, document.getElementById('workerKey').value)
            .replace(/#1e40af/g, primaryColor);
        
        const manifest = { name: org, short_name: appShort, start_url: "index.html", display: "standalone", theme_color: primaryColor, icons: [{ src: "icon.png", sizes: "192x192", type: "image/png" }] };
        const workerFolder = zip.folder("WorkerApp");
        workerFolder.file("index.html", wHtml);
        workerFolder.file("manifest.json", JSON.stringify(manifest, null, 2));
        workerFolder.file("icon.png", logoData.split(',')[1], {base64:true});
        zip.folder("MonitorApp").file("index.html", TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, document.getElementById('webAppUrl').value).replace(/%%LOGO_URL%%/g, logoData));
        zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
        zip.file("OPERATIONS_MANUAL.html", TEMPLATES.manual.replace(/%%ORG_NAME%%/g, org).replace(/%%SECRET_KEY%%/g, document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value));
        zip.generateAsync({type:"blob"}).then(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = org.replace(/ /g, '_') + "_Lone_Worker_Apps.zip"; a.click();
        });
    }

    function generateLaunchPack() {
        const url = document.getElementById('workerAppUrl').value;
        if(url.length > 10) {
            document.getElementById('launchPack').classList.remove('hidden');
            document.getElementById('launchEmail').value = `Follow this link to install your safety app:\n${url}\n\nImportant: Use your name EXACTLY as it appears in our records.`;
        }
    }
  </script>
</body>
</html>
