<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v78.19 (Novice Guided)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; }
    .file-status { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #1e293b; border: 1px solid #334155; border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.85rem; }
    .status-badge { padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 0.7rem; }
    .status-pending { background: #334155; color: #94a3b8; }
    .status-ok { background: #064e3b; color: #34d399; }
    .status-err { background: #450a0a; color: #fca5a5; }
    .step-badge { background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps. Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="modal-backdrop">
      <div class="modal-content border-blue-500">
          <h2 class="text-xl font-bold text-white mb-4">üìÇ Finding Drive Folder ID</h2>
          <ol class="list-decimal pl-5 space-y-3 text-gray-300 text-sm mb-6">
              <li>Open Google Drive folder.</li>
              <li>Look at the URL bar.</li>
              <li>Copy the string after <code>folders/</code>.</li>
          </ol>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all">
              drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong>
          </div>
          <button onclick="closeModal('driveHelpModal')" class="w-full py-2 bg-blue-600 text-white font-bold rounded">Got it</button>
      </div>
  </div>

  <div class="max-w-5xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v78.19 | Golden Master (Global)</p>
    </header>

    <div class="bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Spreadsheet</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Backend</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-8">
        
        <div id="step1" class="step-section active space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div><label class="block text-gray-400 text-xs font-bold uppercase mb-1">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              <div><label class="block text-gray-400 text-xs font-bold uppercase mb-1">Secret Key</label><input type="text" id="secretKey" class="input-field text-yellow-400" placeholder="Generating..." oninput="saveInput(this)"></div>
              <div class="grid grid-cols-2 gap-4">
                  <div><label class="block text-gray-400 text-xs font-bold uppercase mb-1">Country</label><select id="countrySelect" class="input-field" onchange="saveInput(this)"><option value="+64">NZ (+64)</option><option value="+61">AU (+61)</option><option value="+44">UK (+44)</option><option value="+1">US (+1)</option></select></div>
                  <div>
                      <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Timezone</label>
                      <select id="timezoneVal" class="input-field" onchange="saveInput(this)">
                          <option value="Pacific/Auckland">Pacific/Auckland (NZ)</option>
                          <option value="Australia/Sydney">Australia/Sydney</option>
                          <option value="Australia/Melbourne">Australia/Melbourne</option>
                          <option value="Australia/Brisbane">Australia/Brisbane</option>
                          <option value="Australia/Perth">Australia/Perth</option>
                          <option value="Europe/London">Europe/London (UK)</option>
                          <option value="America/New_York">America/New_York (EST)</option>
                          <option value="America/Chicago">America/Chicago (CST)</option>
                          <option value="America/Denver">America/Denver (MST)</option>
                          <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                          <option value="UTC">UTC (Universal)</option>
                      </select>
                  </div>
              </div>
            </div>
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-gray-400 text-xs font-bold uppercase mb-2">App Logo</label>
              <div id="dropZone" class="drop-zone w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-24 w-24 mx-auto rounded-full flex items-center justify-center overflow-hidden bg-gray-700">
                    <img id="logoImg" class="hidden h-full w-full object-cover"><span id="logoText" class="text-xs">Click to Upload</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)"><input type="hidden" id="logoUrl" oninput="saveInput(this)">
            </div>
          </div>

          <div class="highlight-box border-blue-500/30 space-y-4">
             <h3 class="text-lg font-bold text-white">Safety & Features</h3>
             <div class="grid md:grid-cols-2 gap-4">
                 <div><label class="block text-gray-400 text-xs font-bold uppercase">Escalation Allowance (Mins)</label><input type="number" id="escalationMins" value="15" class="input-field" oninput="saveInput(this)"></div>
                 <div><label class="block text-gray-400 text-xs font-bold uppercase">Stats Frequency</label><select id="statsFreq" class="input-field" onchange="saveInput(this)"><option value="MONTHLY">Monthly</option><option value="WEEKLY">Weekly</option><option value="DAILY">Daily</option></select></div>
             </div>
             <div class="flex items-center gap-4 pt-2 border-t border-gray-600">
                <div class="flex items-center gap-2"><input type="checkbox" id="chkVehicle" class="w-4 h-4" onchange="toggleVehicle(); saveInput(this)" checked><span class="text-sm font-bold">Vehicle Checks</span></div>
                <div id="vehOptions" class="flex items-center gap-2 text-sm"><input type="number" id="vehFreq" value="90" class="bg-gray-700 rounded p-1 w-16 text-center text-white" oninput="saveInput(this)"><span>Days</span></div>
             </div>
             <div class="flex items-center gap-2"><input type="checkbox" id="chkTravelReport" class="w-4 h-4" onchange="saveInput(this)" checked><span class="text-sm font-bold">Req. Form on Travel End?</span></div>
             
             <div class="grid md:grid-cols-2 gap-4 pt-2">
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-xs uppercase">Textbelt Key (SMS)</label><a href="https://textbelt.com/" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="input-field text-sm" placeholder="Optional" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><div class="flex items-center gap-2"><input type="checkbox" id="enableAi" class="w-4 h-4" onchange="saveInput(this); toggleAiInput()"><label class="block text-gray-500 text-xs uppercase cursor-pointer" for="enableAi">Enable AI Grammar</label></div><a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a></div><input type="text" id="geminiKey" class="input-field text-sm opacity-50" disabled placeholder="Optional: Paste Gemini API Key..." oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-xs uppercase">ORS Key (Maps)</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="input-field text-sm" placeholder="Optional: For Road Mileage" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-500 text-xs uppercase">Drive Folder ID</label><span onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link cursor-pointer">Where is this?</span></div><input type="text" id="folderId" class="input-field text-sm" placeholder="Optional: For Photos" oninput="saveInput(this)"></div>
             </div>
          </div>
          <div class="flex justify-end"><button onclick="gotoStep(2)" class="btn btn-primary">Next: Spreadsheet ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-6">
          <div class="text-center"><a href="https://sheets.new" target="_blank" class="btn btn-success text-lg">1. Create New Google Sheet</a><p class="text-gray-400 text-xs mt-2">Suggestion: Name it "OTG Safety DB"</p></div>
          <div class="bg-blue-900/20 p-3 rounded border border-blue-500/50 text-xs text-blue-200 text-center">Create these 5 tabs. Use buttons to copy Tab-Separated Data (Header + Example + Guides) to paste into Cell A1.</div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-blue-400">A. Visits Tab</h3><button onclick="copyData('Visits')" class="w-full btn bg-blue-700 hover:bg-blue-600 text-white text-xs py-2 mt-2">Copy Blueprint</button></div>
            <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-purple-400">B. Templates Tab</h3><button onclick="copyData('Templates')" class="w-full btn bg-purple-700 hover:bg-purple-600 text-white text-xs py-2 mt-2">Copy Blueprint</button></div>
            <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-green-400">C. Sites Tab</h3><button onclick="copyData('Sites')" class="w-full btn bg-green-700 hover:bg-green-600 text-white text-xs py-2 mt-2">Copy Blueprint</button></div>
            <div class="bg-gray-900 p-4 rounded border border-red-600"><h3 class="font-bold text-red-400">D. Staff Tab</h3><button onclick="copyData('Staff')" class="w-full btn bg-red-800 hover:bg-red-700 text-white text-xs py-2 mt-2">Copy Blueprint</button></div>
          </div>
          <div class="bg-gray-900 p-4 rounded border border-gray-600"><h3 class="font-bold text-yellow-400">E. Admin_Help Tab (AI Prompts)</h3><button onclick="copyData('AdminHelp')" class="btn bg-yellow-600 hover:bg-yellow-500 text-white text-xs py-2 mt-2 px-6">Copy AI Guide & Prompts</button></div>
          <div class="flex justify-between"><button onclick="gotoStep(1)" class="text-gray-400">Back</button><button onclick="generateScript()" class="btn btn-primary">Next: Backend ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-8">
          
          <div class="relative">
            <div class="flex justify-between items-end mb-2">
                <label class="text-sm font-bold text-gray-400">YOUR CUSTOM BACKEND CODE</label>
                <button onclick="copyScript()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded">COPY ALL</button>
            </div>
            <pre id="codeDisplay" class="code-scroll">Generating...</pre>
          </div>

          <div class="bg-gray-900 p-5 rounded-xl border border-blue-500/30">
             <h3 class="text-blue-400 font-bold text-lg mb-3">Part A: Deploy the Web App</h3>
             <ol class="space-y-3 text-sm text-gray-300">
                <li class="flex gap-2"><span class="step-badge">1</span> Open Spreadsheet > <strong>Extensions</strong> > <strong>Apps Script</strong>.</li>
                <li class="flex gap-2"><span class="step-badge">2</span> Delete any code there. <strong>Paste</strong> your code.</li>
                <li class="flex gap-2"><span class="step-badge">3</span> Click the blue <strong>Deploy</strong> button (top right) > <strong>New Deployment</strong>.</li>
                <li class="flex gap-2"><span class="step-badge">4</span> Click the <strong>Gear Icon (‚öôÔ∏è)</strong> next to "Select type" > Choose <strong>Web App</strong>.</li>
                <li class="flex gap-2 bg-blue-900/40 p-2 rounded border border-blue-800"><span class="step-badge bg-blue-500">5</span> <strong>IMPORTANT:</strong><br>‚Ä¢ Execute as: <strong>Me</strong> (your email)<br>‚Ä¢ Who has access: <strong>Anyone</strong> (Critical for the app to connect)</li>
                <li class="flex gap-2"><span class="step-badge">6</span> Click <strong>Deploy</strong>. Copy the <strong>Web App URL</strong> provided.</li>
             </ol>
          </div>

          <div class="bg-gray-900 p-5 rounded-xl border border-yellow-500/30">
             <h3 class="text-yellow-400 font-bold text-lg mb-3">Part B: Set up the 3 Automation Triggers</h3>
             <p class="text-xs text-gray-400 mb-4">In the Apps Script window, click the <strong>Alarm Clock Icon</strong> (Left Sidebar) to open Triggers.</p>
             
             <div class="grid md:grid-cols-3 gap-4">
                 <div class="bg-black/30 p-3 rounded border border-gray-700">
                     <strong class="text-red-400 block mb-2">1. SAFETY (Critical)</strong>
                     <ul class="text-xs text-gray-300 space-y-1">
                         <li>Function: <strong>checkOverdueVisits</strong></li>
                         <li>Source: <strong>Time-driven</strong></li>
                         <li>Type: <strong>Minutes timer</strong></li>
                         <li>Interval: <strong>Every 10 minutes</strong></li>
                     </ul>
                 </div>
                 <div class="bg-black/30 p-3 rounded border border-gray-700">
                     <strong class="text-green-400 block mb-2">2. STATISTICS</strong>
                     <ul class="text-xs text-gray-300 space-y-1">
                         <li>Function: <strong>generateStatistics</strong></li>
                         <li>Source: <strong>Time-driven</strong></li>
                         <li>Type: <strong>Week timer</strong> (or Month)</li>
                         <li>Interval: <strong>Every Monday</strong></li>
                     </ul>
                 </div>
                 <div class="bg-black/30 p-3 rounded border border-gray-700">
                     <strong class="text-purple-400 block mb-2">3. MAINTENANCE</strong>
                     <ul class="text-xs text-gray-300 space-y-1">
                         <li>Function: <strong>archiveOldVisits</strong></li>
                         <li>Source: <strong>Time-driven</strong></li>
                         <li>Type: <strong>Day timer</strong></li>
                         <li>Interval: <strong>Midnight to 1am</strong></li>
                     </ul>
                 </div>
             </div>
          </div>

          <div class="pt-4 border-t border-gray-700">
              <label class="block text-green-400 font-bold text-center mb-2">Paste Web App URL to Verify</label>
              <div class="flex gap-2 max-w-xl mx-auto">
                  <input type="url" id="webAppUrl" class="input-field text-center text-yellow-300 font-mono text-sm" placeholder="https://script.google.com/macros/s/..." oninput="saveInput(this)">
                  <button onclick="testConnection()" class="btn bg-green-600 hover:bg-green-500 text-white shadow-lg whitespace-nowrap">Test üì°</button>
              </div>
              <div id="testResult" class="text-center font-bold text-sm hidden mt-3"></div>
          </div>

          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary opacity-50 cursor-not-allowed">Next: Download ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 text-left">
              <p class="text-gray-400 text-sm mb-2">Scanning assets...</p>
              <div class="space-y-1" id="fileStatusArea">
                  <div id="st_worker" class="file-status"><span>Worker App</span><span class="status-badge status-pending">...</span></div>
                  <div id="st_monitor" class="file-status"><span>Monitor App</span><span class="status-badge status-pending">...</span></div>
                  <div id="st_backend" class="file-status"><span>Backend</span><span class="status-badge status-pending">...</span></div>
                  <div id="st_guide" class="file-status"><span>Guide</span><span class="status-badge status-pending">...</span></div>
                  <div id="st_manual" class="file-status"><span>Manual</span><span class="status-badge status-pending">...</span></div>
              </div>
              <div id="manUpload" class="hidden mt-4 pt-4 border-t border-gray-600"><p class="text-red-400 text-xs font-bold">‚ö†Ô∏è Auto-load failed. Upload files manually:</p><input type="file" multiple onchange="handleFiles(this)" class="text-xs text-gray-500 mt-2"></div>
          </div>
          <button id="btnDlZip" onclick="downloadZip()" disabled class="w-full btn btn-success py-4 text-xl shadow-xl opacity-50">Download .ZIP</button>
          <div class="flex justify-between"><button onclick="gotoStep(3)" class="text-gray-400">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold text-white mb-4">üöÄ Deployment</h2>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-300">
                    <li>Extract ZIP.</li>
                    <li>Upload <strong>WorkerApp</strong> folder to Netlify/Vercel (Free).</li>
                    <li>Upload <strong>MonitorApp</strong> folder.</li>
                    <li>See <code>ADMIN_MANUAL.html</code> in ZIP for details.</li>
                </ol>
            </div>
            <div class="flex justify-start"><button onclick="gotoStep(4)" class="text-gray-400">Back</button></div>
        </div>

      </div>
    </div>
  </div>

<script>
const FILES={worker:'worker_template.html',monitor:'monitor_template.html',backend:'backend_template.js',guide:'guide_template.html',manual:'ops_manual_template.html'};
let TEMPLATES={}; const workerKey="wk_"+Math.random().toString(36).substr(2,9);

const SPACER = "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";

const BLUEPRINTS = {
    Visits: `Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4\n2024-01-01T08:00:00.000Z\t2024-01-01\tJohn Doe\t+6421123456\tJane Doe\t+6421999888\tjane@test.com\t\t\t\t"ON SITE"\t"Arrived safely"\t"Head Office"\t"123 Queen St"\t"-36.8,174.7"\t2024-01-01T08:00:00.000Z\t95%\t\t0`,
    Staff: `Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry\nJohn Doe\tDriver\tActive\t\t\t\t${SPACER}INSTRUCTIONS (Do not delete):\n1. GATEKEEPER MODE: The existence of this tab turns on High Security.\n2. AUTHORIZATION: Only names listed here (Case Sensitive) can use the app.\n3. REVOKING ACCESS: To fire a worker, delete their row or change Status to 'Inactive'.\n4. DEVICE LOCK: The system will auto-fill Col E (DeviceID) on first sync. To let a worker switch phones, clear their DeviceID cell.\n5. VEHICLE: Columns F and G are updated automatically when workers submit a Vehicle Safety Check.`,
    Sites: `Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes\nALL\tStandard Visit\tAcme Corp\tHead Office\t123 Main St\tSteve\t021123456\tsteve@acme.com\tGate Code: 4455${SPACER}SITES GUIDE (Starting Cell A20):\n1. Use this tab to assign sites to workers.\n2. Column A (Assigned To): Enter a Worker Name (Exact Match) or 'ALL'.\n3. Template Name: Must match a name from the 'Templates' tab.\n4. Address: If populated, the app will show a 'Navigate' button.\n5. Contact Info: Shows a 'Call' button in the app.`,
    Templates: `Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?\nREPORT\tVehicle Safety Check\tALL\t\t[TEXT] Registration Plate\t[YESNO] Current Rego & WOF?\t[DATE] WOF Expiry\t[GPS] Inspection Location\t[HEADING] Tyres\t[TEXT] Tread Depth (New/Good/Low)\t[PHOTO] Tread Photo\t[TEXT] Tyre Pressures (PSI)\t[HEADING] Under Hood\t[YESNO] Oil Level OK?\t[PHOTO] Oil Level\t[YESNO] Coolant/Water OK?\t[PHOTO] Coolant Level\t[YESNO] Brake Fluid OK?\t[PHOTO] Brake Fluid\nREPORT\tTravel Report\tALL\t\t[NUMBER] Distance (km)\t[TEXT] Trip Details\t[PHOTO] Odometer Photo${SPACER}TEMPLATE LEGEND & GUIDE:\n1. TYPE COLUMN (Col A):\n- 'FORM': Appears in the 'Add Notes/Form' menu during a visit (e.g. Accident Report, Vehicle Check).\n- 'REPORT': Triggered when leaving a site. Must be linked to a location in the 'Sites' tab.\n2. ASSIGNED TO (Col C - FORMS ONLY):\n- 'ALL': Every worker sees this form.\n- 'John, Sarah': Only John and Sarah see this form (Comma separated, exact name match).\n3. CODES (Use these in Question columns):\n- [TEXT] : Multi-line text box\n- [NUMBER] : Numeric keypad input\n- [YESNO] : Yes/No buttons\n- [CHECK] : Simple checkbox\n- [PHOTO] : Camera button\n- [GPS] : Button to capture current location\n- [SIGN] : Signature pad\n- [HEADING] : Section Title (Visual separator)\n- [NOTE] : Read-only instruction text`,
    AdminHelp: `Task\tAI Prompt Suggestion\nCreate PDF Report\t"I have a Google Sheet with a tab 'Visits'. Columns are: A=Timestamp, C=Worker Name, K=Status, S=Distance. Please write a Google Apps Script function to email me a PDF summary of total distance per worker for the last 7 days."\nData Clean Up\t"Write a script to archive rows from 'Visits' that are older than 30 days to a new tab called 'Archive' inside the same spreadsheet."${SPACER}AI REPORTING GUIDE...\nUse this guide to ask Gemini or ChatGPT to write custom report scripts for you.\n---------------------------------------------------\nSECTION 1: DEPLOYMENT RULE (READ FIRST)\n---------------------------------------------------\nIf you write a script that only READS the spreadsheet and creates a new Report Tab (like the examples below):\n1. You DO NOT need to update the Web App Deployment.\n2. Just paste the code into Apps Script and click "Run" (or set a Time Trigger).\n3. The script runs "locally" inside the sheet.\nOnly update the Web App Deployment if you change "doPost" or "doGet" (the core backend).\n---------------------------------------------------\nSECTION 2: DATA MAP (For the AI)\n---------------------------------------------------\nPaste this into your AI prompt so it knows your data structure:\nI have a Google Sheet named 'Visits'.\nThe columns are mapped as follows:\n- Col A: Timestamp (Start of Visit)\n- Col C: Worker Name\n- Col K: Status (e.g. 'DEPARTED', 'EMERGENCY')\n- Col M: Location Name\n- Col P: Device Timestamp (End of Visit / Last Check-in)\n- Col Q: Battery Level (e.g. '85%')\n- Col S: Distance (km)\n- Col T: Visit Report Data (JSON string containing form answers)\n- Col U: Anticipated Departure Time\n---------------------------------------------------\nSECTION 2B: LONG-TERM HISTORY (THE ARCHIVE)\n---------------------------------------------------\nPRO TIP: If you need a report covering more than 30 days (e.g., Annual Mileage), you must tell the AI to look at the Archive.\nAdd this to your prompt:\nPlease note: Older data is moved to a sheet named 'Archive'. Please modify the script to read data from BOTH the 'Visits' sheet and the 'Archive' sheet, combine them into one array, and then generate the report.\n---------------------------------------------------\nSECTION 3: PROMPT RECIPES (Copy & Paste these)\n---------------------------------------------------\nRECIPE 1: MILEAGE REPORT\nWrite a Google Apps Script function called 'generateMileageReport'.\n1. Read all data from 'Visits'.\n2. Create/Overwrite a sheet called 'Mileage Report'.\n3. Group data by Worker Name (Col C) and Location (Col M).\n4. Sum the Distance (Col S) for each group.\n5. Create a clean table: Worker | Location | Total KM.\n6. Add a Grand Total at the bottom.\nRECIPE 2: TIMESHEET (PAYROLL)\nWrite a script called 'generateTimesheet'.\n1. Read 'Visits'.\n2. Calculate duration in minutes: (Col P - Col A).\n3. Ignore rows where Status is not 'DEPARTED'.\n4. Create a sheet 'Weekly Timesheet'.\n5. List: Worker | Date | Location | Start Time | End Time | Duration (Hours).\n6. Sum Total Hours per Worker.\nRECIPE 3: SAFETY AUDIT (COMPLIANCE)\nWrite a script called 'auditSafety'.\n1. Read 'Visits'.\n2. Identify rows where Battery Level (Col Q) is < 20%.\n3. Identify rows where Status (Col K) contains 'EMERGENCY' or 'OVERDUE'.\n4. Create a sheet 'Safety Audit'.\n5. List these high-risk visits.\n6. Highlight 'EMERGENCY' rows in Red.\nRECIPE 4: SITE HISTORY (JSON EXTRACTION)\nWrite a script called 'collateSiteComments'.\n1. Read 'Visits'.\n2. Filter for Location Name = 'Main Office' (make this a variable).\n3. Parse the JSON in Col T ('Visit Report Data').\n4. Extract the field labeled 'Notes' or 'Comments' from that JSON.\n5. Create a sheet 'Site Log - Main Office'.\n6. List: Date | Worker | Extracted Notes.\nRECIPE 5: AFTER-HOURS WORK\nWrite a script to find after-hours work.\n1. Read 'Visits'.\n2. Flag rows where Start Time (Col A) is on a Saturday/Sunday OR after 6:00 PM.\n3. Output to a new sheet 'After Hours Log'.\nRECIPE 6: WORKER ACTIVITY SUMMARY\nWrite a script for an Executive Summary.\n1. Count total unique visits per Worker.\n2. Calculate average duration per visit per Worker.\n3. Count total 'EMERGENCY' statuses per Worker.\n4. Output a summary table.\nRECIPE 7: MISSING REPORTS\nWrite a script to find missing reports.\n1. Filter rows where Status is 'DEPARTED'.\n2. Check if Col T (Report Data) is empty or '{}'.\n3. List workers who departed without filing a report.\nRECIPE 8: TRAVEL VS ON-SITE\nWrite a script to compare Travel vs Work.\n1. Sum duration for rows where Location Name contains 'Travel'.\n2. Sum duration for all other rows.\n3. Calculate the ratio per worker.\nRECIPE 9: MONTHLY ARCHIVE\nWrite a script to move last month's data.\n1. Identify rows from the previous month.\n2. Move them to a sheet named 'Archive - [Month-Year]'.\n3. Delete them from 'Visits' to keep it fast.\nRECIPE 10: FORM DATA EXPORT\nWrite a script to flatten the JSON form data.\n1. Read Col T.\n2. Find all unique keys used in the JSON objects (e.g. 'Hazard?', 'Safe?').\n3. Create a new sheet with these keys as Column Headers.\n4. Populate the rows with the values from the JSON.`
};

window.onload=async()=>{
    loadPersistedData(); 
    detectTimezoneOnLoad(); 
    setupDragDrop(); 
    toggleAiInput(); 
    genKey();
    for(const[k,f]of Object.entries(FILES)){try{const r=await fetch(f);if(r.ok)TEMPLATES[k]=await r.text();}catch(e){}}
};

function saveInput(el){localStorage.setItem('otg_'+el.id,el.type==='checkbox'?el.checked:el.value);}
function loadPersistedData(){
    const ids=['orgName','secretKey','webAppUrl','geminiKey','orsKey','textbeltKey','folderId','escalationMins','vehFreq','countrySelect','statsFreq','timezoneVal'];
    ids.forEach(id=>{const v=localStorage.getItem('otg_'+id);if(v)document.getElementById(id).value=v;});
    if(localStorage.getItem('otg_chkTravelReport')!==null)document.getElementById('chkTravelReport').checked=localStorage.getItem('otg_chkTravelReport')==='true';
    if(localStorage.getItem('otg_enableAi')!==null)document.getElementById('enableAi').checked=localStorage.getItem('otg_enableAi')==='true';
}

function detectTimezoneOnLoad() {
    const saved = localStorage.getItem('otg_timezoneVal');
    if(saved) return;
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const drop = document.getElementById('timezoneVal');
    for(let i=0; i<drop.options.length; i++) {
        if(drop.options[i].value === tz) { drop.selectedIndex = i; saveInput(drop); return; }
    }
    if(tz.includes("Auckland")) drop.value = "Pacific/Auckland";
    else if(tz.includes("Sydney")) drop.value = "Australia/Sydney";
    else if(tz.includes("London")) drop.value = "Europe/London";
    else if(tz.includes("New_York")) drop.value = "America/New_York";
    saveInput(drop);
}

function toggleEnterBtn(){const b=document.getElementById('btnEnter'),c=document.getElementById('chkAccept');b.disabled=!c.checked;if(c.checked){b.classList.remove('bg-gray-700','text-gray-500');b.classList.add('bg-blue-600','text-white','hover:bg-blue-500');}else{b.classList.add('bg-gray-700','text-gray-500');b.classList.remove('bg-blue-600','text-white','hover:bg-blue-500');}}
function closeModal(id){document.getElementById(id).style.display='none';if(id==='disclaimerModal')document.getElementById('mainContent').classList.remove('blur-sm');}
function setupDragDrop(){const d=document.getElementById('dropZone');d.addEventListener('dragover',e=>{e.preventDefault();d.classList.add('border-blue-500')});d.addEventListener('dragleave',e=>{e.preventDefault();d.classList.remove('border-blue-500')});d.addEventListener('drop',e=>{e.preventDefault();d.classList.remove('border-blue-500');if(e.dataTransfer.files.length)handleLogo({files:e.dataTransfer.files})});}
function handleLogo(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{TEMPLATES.logo=e.target.result;document.getElementById('logoImg').src=e.target.result;document.getElementById('logoImg').classList.remove('hidden');document.getElementById('logoText').innerText="‚úÖ Ready";document.getElementById('logoUrl').value=e.target.result;saveInput(document.getElementById('logoUrl'));};r.readAsDataURL(i.files[0]);}}
function gotoStep(n){if(n===4)attemptAutoLoad();document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));document.getElementById('step'+n).classList.add('active');for(let i=1;i<=5;i++){const t=document.getElementById('tab'+i);if(i===n)t.classList.add('active');else t.classList.remove('active');}}
function toggleVehicle(){document.getElementById('vehOptions').style.display=document.getElementById('chkVehicle').checked?'flex':'none';}
function toggleAiInput(){const c=document.getElementById('enableAi'),i=document.getElementById('geminiKey');i.disabled=!c.checked;i.style.opacity=c.checked?'1':'0.5';}
function genKey(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<32;i++)r+=c.charAt(Math.floor(Math.random()*c.length));document.getElementById('secretKey').value=r;}
function copyData(k){navigator.clipboard.writeText(BLUEPRINTS[k]);alert(k+" Copied! Paste in A1.");}

function generateScript(){
    if(!TEMPLATES.backend){setTimeout(generateScript,500);return;}
    const code=TEMPLATES.backend.replace('%%SECRET_KEY%%',document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g,workerKey).replace('%%ORS_API_KEY%%',document.getElementById('orsKey').value).replace('%%GEMINI_API_KEY%%',document.getElementById('geminiKey').value).replace('%%TEXTBELT_API_KEY%%',document.getElementById('textbeltKey').value).replace('%%PHOTOS_FOLDER_ID%%',document.getElementById('folderId').value).replace('%%ORGANISATION_NAME%%',document.getElementById('orgName').value).replace('%%TIMEZONE%%',document.getElementById('timezoneVal').value||"Pacific/Auckland").replace('%%COUNTRY_CODE%%',document.getElementById('countrySelect').value.replace('+','')).replace('%%STATS_FREQ%%',document.getElementById('statsFreq').value).replace('%%ENABLE_AI%%',document.getElementById('enableAi').checked).replace('%%ESCALATION_MINUTES%%',document.getElementById('escalationMins').value);
    document.getElementById('codeDisplay').textContent=code;gotoStep(3);
}
function copyScript(){navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent);alert("Copied!");}
function testConnection(){
    const u=document.getElementById('webAppUrl').value,r=document.getElementById('testResult');
    if(!u.includes('/exec')){alert('Invalid URL');return;}
    r.classList.remove('hidden');r.textContent="Testing...";r.className="text-center font-bold text-yellow-400";
    fetch(u+'?action=ping').then(res=>res.json()).then(d=>{if(d.status==="success"){r.textContent="‚úÖ Success!";r.className="text-center font-bold text-green-400";document.getElementById('btnNextDownload').disabled=false;document.getElementById('btnNextDownload').classList.remove('opacity-50','cursor-not-allowed');}else throw new Error();}).catch(()=>{r.textContent="‚ùå Failed";r.className="text-center font-bold text-red-400";});
}
async function attemptAutoLoad(){
    const m=[{id:'st_worker',f:'worker_template.html'},{id:'st_monitor',f:'monitor_template.html'},{id:'st_backend',f:'backend_template.js'},{id:'st_guide',f:'guide_template.html'},{id:'st_manual',f:'ops_manual_template.html'}];
    let ok=0;for(let x of m){try{const r=await fetch(x.f);if(r.ok){TEMPLATES[x.f]=await r.text();document.querySelector(`#${x.id} .status-badge`).className="status-badge status-ok";document.querySelector(`#${x.id} .status-badge`).innerText="LOADED";ok++;}}catch(e){document.querySelector(`#${x.id} .status-badge`).className="status-badge status-err";document.querySelector(`#${x.id} .status-badge`).innerText="MISSING";}}
    checkAssets(ok===5);
}
function handleFiles(inp){Array.from(inp.files).forEach(f=>{if(TEMPLATES.hasOwnProperty(f.name)){const r=new FileReader();r.onload=e=>{TEMPLATES[f.name]=e.target.result;let id="";if(f.name.includes('worker'))id='st_worker';else if(f.name.includes('monitor'))id='st_monitor';else if(f.name.includes('backend'))id='st_backend';else if(f.name.includes('guide'))id='st_guide';else if(f.name.includes('manual'))id='st_manual';if(id){document.querySelector(`#${id} .status-badge`).className="status-badge status-ok";document.querySelector(`#${id} .status-badge`).innerText="UPLOADED";}if(Object.values(TEMPLATES).every(v=>v!==null))checkAssets(true);};r.readAsText(f);}});}
function checkAssets(r){const b=document.getElementById('btnDlZip');if(r){b.disabled=false;b.classList.remove('opacity-50');document.getElementById('manUpload').classList.add('hidden');}else{document.getElementById('manUpload').classList.remove('hidden');}}
function downloadZip(){
    const zip=new JSZip(),org=document.getElementById('orgName').value,url=document.getElementById('webAppUrl').value;
    let wHtml=TEMPLATES['worker_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%SHEET_URL%%/g,url).replace(/%%LOGO_DATA%%/g,TEMPLATES.logo||"").replace(/%%WORKER_KEY%%/g,workerKey).replace(/%%ORS_API_KEY%%/g,document.getElementById('orsKey').value).replace(/%%ESCALATION_MINUTES%%/g,document.getElementById('escalationMins').value).replace(/%%VEH_ENABLED%%/g,document.getElementById('chkVehicle').checked).replace(/%%VEH_INTERVAL%%/g,document.getElementById('vehFreq').value).replace(/%%MILEAGE_ENABLED%%/g,"true").replace(/%%COUNTRY_CODE%%/g,document.getElementById('countrySelect').value.replace('+','')).replace(/%%REQ_TRAVEL_REPORT%%/g,document.getElementById('chkTravelReport').checked);
    let mHtml=TEMPLATES['monitor_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%LOGO_URL%%/g,TEMPLATES.logo||"");
    let gHtml=TEMPLATES['guide_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%VEHICLE_INTERVAL%%/g,document.getElementById('vehFreq').value);
    zip.folder("WorkerApp").file("index.html",wHtml).file("sw.js",`const CACHE_NAME='otg-v78.19';const u=['./','./index.html','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(u)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>{return r||fetch(e.request)}))});`).file("manifest.json",JSON.stringify({name:org,short_name:"Safety",start_url:"./index.html",display:"standalone",background_color:"#111827",theme_color:"#1e40af",icons:[{src:"icon.png",sizes:"192x192",type:"image/png"}]})).file("USER_GUIDE.html",gHtml);
    if(TEMPLATES.logo)zip.folder("WorkerApp").file("icon.png",TEMPLATES.logo.split(',')[1],{base64:true});
    zip.folder("MonitorApp").file("index.html",mHtml);
    zip.file("Code.gs",document.getElementById('codeDisplay').textContent);
    zip.file("ADMIN_MANUAL.html",TEMPLATES['ops_manual_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%SECRET_KEY%%/g,document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g,workerKey));
    zip.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=org.replace(/[^a-z0-9]/gi,'_')+"_OTG_Apps.zip";a.click();});
}
</script>
</body>
</html>
