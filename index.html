<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG AppSuite Factory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; }
    details > summary { list-style: none; outline: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="min-h-screen py-8 px-4">

  <div class="max-w-6xl mx-auto">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">Lone Worker System Generator (v39.1 Fixed)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Spreadsheet</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Backend</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation"></div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Secret Key</label>
                  <input type="text" id="secretKey" class="input-field" value="ChangeMe123!">
                  <p class="text-xs text-red-400 mt-2 font-bold">‚ö†Ô∏è SECURITY WARNING: Keep this key safe. It grants access to your database.</p>
              </div>
            </div>
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Logo (Optional)</label>
              <div class="relative cursor-pointer w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto bg-gray-800 rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center overflow-hidden hover:border-blue-500 transition"><span id="logoText" class="text-gray-500 text-sm">Click to Upload<br>(or use icon.png)</span><img id="logoImg" class="hidden h-full w-full object-cover"></div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
            </div>
          </div>

          <div class="highlight-box border-blue-500/30">
             <h3 class="text-xl font-bold text-white mb-4">Essential Safety Features</h3>
             
             <div class="mb-4 ml-10">
                <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Escalation Delay (Minutes)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold">
                    <span class="text-xs text-gray-400">Time between "Overdue" (Amber) and "Emergency" (Red).</span>
                </div>
             </div>

             <label class="flex items-center gap-4 cursor-pointer mb-2 group">
               <input type="checkbox" id="chkCheckin" class="w-6 h-6 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" onchange="toggleCheckin()">
               <div><span class="block font-bold text-white group-hover:text-blue-300 transition">Enable Periodic Check-in?</span><span class="text-sm text-gray-400">Asks "Are you OK?" at set intervals.</span></div>
             </label>
             
             <div id="checkinOptions" class="hidden pl-10 ml-3 mb-4 transition-all">
                <label class="text-gray-300 text-sm font-bold mr-2">Frequency (Minutes):</label>
                <input type="number" id="checkinMins" value="60" min="5" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-24 text-center font-bold">
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600 grid md:grid-cols-2 gap-4">
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Textbelt Key <a href="https://textbelt.com/" target="_blank" class="link ml-1">(Link ‚Üó)</a></label>
                    <input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For SMS Alerts">
                 </div>
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Gemini AI Key <a href="https://aistudio.google.com/app/apikey" target="_blank" class="link ml-1">(Link ‚Üó)</a></label>
                    <input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Smart Scribe">
                 </div>
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">OpenRouteService Key <a href="https://openrouteservice.org/" target="_blank" class="link ml-1">(Link ‚Üó)</a></label>
                    <input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Road Mileage">
                 </div>
             </div>
          </div>
          
          <div class="flex justify-end"><button onclick="gotoStep(2)" class="btn btn-primary text-lg">Next: Spreadsheet ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
          <div class="text-center"><a href="https://sheets.new" target="_blank" class="btn btn-success text-xl px-10 py-4 shadow-lg transform hover:-translate-y-1">1. Click to Create New Google Sheet</a></div>
          
          <div class="grid md:grid-cols-2 gap-6">
            
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-blue-400">A. Setup 'Visits' Tab</h3>
                <p class="text-xs text-gray-400">This is where all safety data is stored.</p>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-300">
                    <li>Rename the workbook (top left) to <strong>"Safety System"</strong>.</li>
                    <li>Rename the bottom tab to <strong>Visits</strong>.</li>
                    <li>Click the button below to copy headers. Paste into cell <strong>A1</strong>.</li>
                    <li><strong>View > Freeze > 1 Row</strong>.</li>
                </ol>
                <button id="btnCopyHeaders" class="w-full btn bg-blue-700 hover:bg-blue-600 text-white py-2">Copy 'Visits' Headers</button>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-purple-400">B. Setup 'Templates' Tab</h3>
                <p class="text-xs text-gray-400">Defines your forms and reports.</p>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-300">
                    <li>Click <strong>+</strong> to add a new tab. Rename to <strong>Templates</strong>.</li>
                    <li>Click button below. Paste into cell <strong>A1</strong>.</li>
                    <li><em class="text-yellow-400">Read the legend in the pasted rows!</em></li>
                </ol>
                <button id="btnCopyTemplates" class="w-full btn bg-purple-700 hover:bg-purple-600 text-white py-2">Copy 'Templates' Setup</button>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-green-400">C. Setup 'Sites' Tab</h3>
                <p class="text-xs text-gray-400">Assigns locations to workers.</p>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-300">
                    <li>Click <strong>+</strong> to add a new tab. Rename to <strong>Sites</strong>.</li>
                    <li>Click button below. Paste into cell <strong>A1</strong>.</li>
                    <li><em class="text-yellow-400">Check the 'Assigned To' column instructions.</em></li>
                </ol>
                <button id="btnCopySites" class="w-full btn bg-green-700 hover:bg-green-600 text-white py-2">Copy 'Sites' Setup</button>
            </div>
          
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-yellow-400">D. Setup 'AI Reporting' Tab</h3>
                <p class="text-xs text-gray-400">Recipes for creating reports with AI.</p>
                <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-300">
                    <li>Create a new tab named <strong>AI Reporting</strong>.</li>
                    <li>Click button below. Paste into cell <strong>A1</strong>.</li>
                </ol>
                <button id="btnCopyReportGuide" class="w-full btn bg-yellow-600 hover:bg-yellow-500 text-white py-2">Copy Reporting Guide</button>
            </div>

          </div>

          <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="loadTemplatesAndGenerateScript()" class="btn btn-primary text-lg">Next: Backend ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="relative">
            <button id="btnCopyCode" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">COPY CODE</button>
            <pre id="codeDisplay" class="code-scroll">Loading templates...</pre>
          </div>
          
          <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 text-sm text-gray-300 space-y-4">
             <h3 class="font-bold text-green-400 text-lg">How to Deploy</h3>
             <ol class="list-decimal pl-5 space-y-3">
                <li>Go to your Google Sheet: Click <strong>Extensions > Apps Script</strong>.</li>
                <li>Delete any code there. <strong>Paste</strong> the code generated above.</li>
                <li>Click <strong>Deploy > New Deployment</strong>. Select <strong>Web App</strong>.</li>
                <li><strong>IMPORTANT:</strong> Set "Who has access" to <strong>Anyone</strong>.</li>
                <li>Click <strong>Deploy</strong> and Authorize.</li>
                <li>Copy the <strong>Web App URL</strong> and paste it below.</li>
             </ol>
          </div>
          
          <div class="bg-yellow-900/30 border border-yellow-600/50 p-4 rounded-lg mt-4">
             <details class="group">
                <summary class="flex items-center justify-between font-bold text-yellow-400 text-lg hover:text-yellow-300 cursor-pointer">
                   <span>‚ö†Ô∏è Vital Step: Set up Automation Triggers</span>
                   <span class="transform group-open:rotate-180 transition">‚ñº</span>
                </summary>
                <div class="mt-4 text-gray-300 space-y-4 text-sm">
                   <p>Without triggers, the safety system cannot detect dead phones or perform backups.</p>
                   <ol class="list-decimal pl-5 space-y-3">
                      <li>In the Apps Script editor, click the <strong>Alarm Clock icon</strong> (Triggers) on the left sidebar.</li>
                      <li>Click the blue <strong>+ Add Trigger</strong> button (bottom right).</li>
                      
                      <li class="bg-gray-800 p-3 rounded border border-gray-600">
                         <strong class="text-white block mb-1">Trigger 1: Safety Watchdog (Critical)</strong>
                         <div class="grid grid-cols-2 gap-2 text-xs">
                             <div>Function: <code>checkOverdueVisits</code></div>
                             <div>Event Source: <code>Time-driven</code></div>
                             <div>Type: <code>Minutes timer</code></div>
                             <div>Interval: <code>Every 10 minutes</code></div>
                         </div>
                      </li>

                      <li class="bg-gray-800 p-3 rounded border border-gray-600">
                         <strong class="text-white block mb-1">Trigger 2: Auto-Archiver (Maintenance)</strong>
                         <div class="grid grid-cols-2 gap-2 text-xs">
                             <div>Function: <code>archiveOldData</code></div>
                             <div>Event Source: <code>Time-driven</code></div>
                             <div>Type: <code>Week timer</code></div>
                             <div>Interval: <code>Every Sunday</code></div>
                         </div>
                      </li>
                   </ol>
                </div>
             </details>
          </div>
          
          <div>
            <label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste Web App URL:</label>
            <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="resetTest()">
          </div>
          
          <div class="flex justify-center gap-4">
              <button id="btnTest" onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">üì° Test Connection</button>
              <button id="btnGenTemplate" onclick="triggerTemplateSetup()" disabled class="hidden btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">ü™Ñ Auto-Generate PDF Template</button>
          </div>
          
          <div id="testResult" class="text-center font-bold text-lg hidden mt-4"></div>
          
          <div class="flex justify-between pt-6">
            <button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button>
            <button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download ‚Üí</button>
          </div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div><h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2><p class="text-gray-400">Files generated for: <span id="finalAppName" class="text-blue-400">App</span></p></div>
          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">Download AppSuite.zip</button>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-4">üöÄ Go Live</h2>
                <div class="space-y-4">
                    <div class="bg-gray-800 p-4 rounded">
                        <strong class="text-blue-400">1. Host the Apps</strong>
                        <p class="text-gray-400 text-sm mt-1">Upload the <strong>WorkerApp</strong> and <strong>MonitorApp</strong> folders to <a href="https://app.netlify.com/drop" target="_blank" class="underline">Netlify Drop</a>.</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded">
                        <strong class="text-blue-400">2. Install on Devices</strong>
                        <p class="text-gray-400 text-sm mt-1">Open the URL on a phone (Worker) or PC (Monitor). Click "Add to Home Screen" or "Install App".</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let logoData = "https://i.postimg.cc/dVmVg3Pn/favicon-logo-for-LWSApp.png"; 
    // Global vars to hold template strings
    let tplWorker = "", tplMonitor = "", tplBackend = "";

    window.onload = async () => {
      try {
        const resp = await fetch('icon.png');
        if(resp.ok) {
          const blob = await resp.blob();
          const reader = new FileReader();
          reader.onload = e => { 
             logoData = e.target.result;
             document.getElementById('logoImg').src = logoData;
             document.getElementById('logoImg').classList.remove('hidden');
             document.getElementById('logoText').textContent = "Loaded icon.png";
             document.getElementById('logoPreviewArea').classList.add('border-blue-500');
          };
          reader.readAsDataURL(blob);
        }
      } catch(e) { console.log("No local icon.png found."); }
    };

    // --- COPY BUTTONS ---
    function copyVisitsHeaders() {
      const h = "Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4";
      navigator.clipboard.writeText(h); alert("Copied 'Visits' Headers! Paste into Cell A1.");
    }
    function copyTemplatesSetup() {
      const header = "Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5";
      const rows = "FORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?";
      const legend = "\n\nLEGEND:\n[TEXT] Box, [NUMBER] Keypad, [YESNO] Buttons, [CHECK] Checkbox, [PHOTO] Camera, [GPS] Location, [SIGN] Signature, [HEADING] Title, [NOTE] Text";
      navigator.clipboard.writeText(header + "\n" + rows + legend); alert("Copied 'Templates' Setup!");
    }
    function copySitesSetup() {
      const header = "Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes";
      const row = "ALL\tStandard Visit\tAcme Corp\tHead Office\t123 Main St, Cityville\tSteve\t021123456\tsteve@acme.com\tGate Code: 4455";
      navigator.clipboard.writeText(header + "\n" + row); alert("Copied 'Sites' Setup!");
    }
    function copyReportGuide() {
        const guide = `AI REPORTING GUIDE\n(Full guide included in clipboard)`;
        navigator.clipboard.writeText(guide); alert("AI Guide Copied!");
    }

    // --- GENERATOR LOGIC ---
    function handleLogo(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = 192; canvas.height = 192;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, 192, 192);
            logoData = canvas.toDataURL('image/png');
            document.getElementById('logoImg').src = logoData;
            document.getElementById('logoImg').classList.remove('hidden');
          }
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
    
    async function loadTemplatesAndGenerateScript() {
      try {
        const [resW, resM, resB] = await Promise.all([
          fetch('worker_template.html'), fetch('monitor_template.html'), fetch('backend_template.js')
        ]);
        
        if(!resW.ok || !resM.ok || !resB.ok) throw new Error("Missing separate template files. Please ensure they are in the same folder.");
        
        tplWorker = await resW.text();
        tplMonitor = await resM.text();
        tplBackend = await resB.text();
        
        // Safety Check 1: Backend vs HTML
        if(tplBackend.trim().startsWith("<!DOCTYPE html>")) {
             throw new Error("SERVER ERROR: The browser loaded index.html instead of the Backend code. Please ensure the file is named 'backend_template.js'.");
        }
        
        // Safety Check 2: Worker Integrity Scanner
        if(tplWorker.includes("Security Login") || tplWorker.includes("setupPage")) {
             throw new Error("‚ùå CRITICAL ERROR: Your 'worker_template.html' contains the Monitor App code (Security Login). Please overwrite it with the correct Worker code.");
        }
        
        generateScript();
      } catch(e) { 
        alert("Error loading templates: " + e.message); 
      }
    }
    
    function generateScript() {
        const code = tplBackend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value);
            
        document.getElementById('codeDisplay').textContent = code;
        gotoStep(3);
    }
    
    async function copyScript() {
        const text = document.getElementById('codeDisplay').textContent;
        try {
            await navigator.clipboard.writeText(text);
            alert("Code copied to clipboard!");
        } catch (err) {
            alert("Error copying code: " + err);
        }
    }
    
    function resetTest() { document.getElementById('btnNextDownload').disabled = true; document.getElementById('testResult').classList.add('hidden'); }
    
    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const result = document.getElementById('testResult');
        const btnNext = document.getElementById('btnNextDownload');
        const key = document.getElementById('secretKey').value;
        const btnTemplate = document.getElementById('btnGenTemplate');
        
        if(!url.includes('/exec')) { alert('Invalid URL'); return; }
        
        result.classList.remove('hidden'); result.textContent = "Testing..."; result.className = "text-center font-bold text-lg text-yellow-400 p-3 rounded-lg bg-gray-900 inline-block";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value))
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                  result.textContent = "‚úÖ Connection Successful!"; result.className = "text-center font-bold text-lg text-green-400 p-3 rounded-lg bg-gray-900 inline-block";
                  btnNext.disabled = false; btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
                  btnTemplate.classList.remove('hidden'); btnTemplate.disabled = false;
                  document.getElementById('finalAppName').innerText = document.getElementById('orgName').value + " Safety";
                } else { throw new Error("Invalid Key"); }
            }).catch(() => {
                result.textContent = "‚ùå Connection Failed."; result.className = "text-center font-bold text-lg text-red-400 p-3 rounded-lg bg-gray-900 inline-block";
            });
    }
    
    function triggerTemplateSetup() {
        const url = document.getElementById('webAppUrl').value;
        const key = document.getElementById('secretKey').value;
        const btn = document.getElementById('btnGenTemplate');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Generating...";
        btn.disabled = true;
        
        fetch(url + '?run=setupTemplate&key=' + encodeURIComponent(key))
            .then(res => res.text())
            .then(txt => {
                alert(txt);
                btn.innerText = "‚úÖ Done";
            })
            .catch(err => {
                alert("Setup Failed: " + err);
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }
    
    function downloadZip() {
        // ROBUSTNESS CHECK: Ensure templates are loaded
        if (!tplWorker || tplWorker === "") {
             alert("‚ö†Ô∏è Templates have not been loaded. Please go back to Step 2 and click 'Next'.");
             gotoStep(2);
             return;
        }

        const zip = new JSZip();
        const org = document.getElementById('orgName').value;
        const url = document.getElementById('webAppUrl').value;
        const secret = document.getElementById('secretKey').value;
        
        // FIXED: Hardcoded 'true' for Advanced features (Managed Fleet Edition)
        let wHtml = tplWorker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%GOOGLE_SHEET_URL%%/g, url)
            .replace(/%%LOGO_DATA%%/g, logoData)
            .replace(/%%SECRET_KEY%%/g, secret)
            .replace(/%%CHECKIN_ENABLED%%/g, document.getElementById('chkCheckin').checked)
            .replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value)
            .replace(/%%ESCALATION_MINUTES%%/g, document.getElementById('escalationMins').value)
            .replace(/%%IS_ADVANCED%%/g, "true") // Managed Fleet = Advanced
            .replace(/%%ENABLE_MILEAGE%%/g, "true") // Managed Fleet = Mileage Ready
            .replace(/%%ORS_API_KEY%%/g, document.getElementById('orsKey').value);

        let mHtml = tplMonitor
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%SHEET_URL%%/g, url)
            .replace(/%%LOGO_URL%%/g, logoData);
            
        const wFolder = zip.folder("WorkerApp");
        wFolder.file("index.html", wHtml);
        wFolder.file("manifest.json", JSON.stringify({name: org, short_name: "Safety", start_url: "./index.html", display: "standalone", background_color: "#111827", theme_color: "#1e40af", icons: [{src: logoData, sizes: "192x192", type: "image/png", purpose: "any maskable"}, {src: logoData, sizes: "512x512", type: "image/png", purpose: "any maskable"}] }, null, 2));
        wFolder.file("sw.js", `const C='v${Date.now()}';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['./index.html']))));self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(k=>Promise.all(k.map(c=>c!==C?caches.delete(c):null)))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`);
        
        const mFolder = zip.folder("MonitorApp");
        mFolder.file("index.html", mHtml);
        
        zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
        zip.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=org.replace(/[^a-z0-9]/gi, '_') + "_AppSuite.zip";a.click()});
    }

    // --- NAVIGATION ---
    function gotoStep(n) { 
        document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); 
        document.getElementById('step'+n).classList.add('active'); 
        for(let i=1; i<=5; i++){
            const tab = document.getElementById('tab'+i);
            if(i===n){
                tab.classList.add('active'); 
                tab.style.color = '#60a5fa'; 
                tab.style.borderColor = '#3b82f6'; 
                tab.style.background = '#1f2937';
            } else {
                tab.classList.remove('active'); 
                tab.style.color = '#6b7280'; 
                tab.style.borderColor = 'transparent'; 
                tab.style.background = 'transparent';
            }
        }
    }
    
    function toggleCheckin() { document.getElementById('checkinOptions').style.display = document.getElementById('chkCheckin').checked ? 'block' : 'none'; }
    
    // --- ATTACH LISTENERS SAFELY ---
    document.getElementById('btnCopyHeaders').onclick = copyVisitsHeaders;
    document.getElementById('btnCopyTemplates').onclick = copyTemplatesSetup;
    document.getElementById('btnCopySites').onclick = copySitesSetup;
    document.getElementById('btnCopyReportGuide').onclick = copyReportGuide;
    document.getElementById('btnCopyCode').onclick = copyScript;
  </script>
</body>
</html>
