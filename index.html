<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v76.0 (Global)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; }
    
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .drop-zone.dragover { border-color: #3b82f6; background: #1e293b; }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps (especially iOS). Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">Beta v76.0 (Global Edition)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Spreadsheet</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Backend</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Secret Key</label>
                  <input type="text" id="secretKey" class="input-field text-yellow-400" placeholder="ChangeMe123!" oninput="saveInput(this)">
                  <p class="text-xs text-red-400 mt-2 font-bold">‚ö†Ô∏è SECURITY WARNING: This is the Admin Key. Keep it safe.</p>
              </div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Region / Country</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option>
                      <option value="+61">Australia (+61)</option>
                      <option value="+44">United Kingdom (+44)</option>
                      <option value="+1">USA / Canada (+1)</option>
                      <option value="">Other (No Auto-Format)</option>
                  </select>
                  <p id="regionInfo" class="text-xs text-gray-400 mt-2">Detected Timezone: <span id="detectedTz" class="text-blue-400 font-mono">Loading...</span></p>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">App Logo</label>
              <div id="dropZone" class="drop-zone w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto rounded-full flex items-center justify-center overflow-hidden">
                    <img id="logoImg" class="hidden h-full w-full object-cover">
                    <span id="logoText" class="text-gray-500 text-sm">Drag & Drop<br>Logo Here</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <input type="hidden" id="logoUrl" oninput="saveInput(this)">
            </div>
          </div>

          <div class="highlight-box border-blue-500/30">
             <h3 class="text-xl font-bold text-white mb-4">Safety & Fleet Options</h3>
             <div class="grid md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Escalation Delay (Minutes)</label>
                    <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)">
                    <span class="text-xs text-gray-400 block mt-1">Time allowed after "Overdue" before RED ALERT.</span>
                 </div>
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Check-in Interval</label>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="chkCheckin" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleCheckin(); saveInput(this)">
                        <span class="text-sm font-bold text-gray-300">Enable?</span>
                        <div id="checkinOptions" class="hidden flex items-center gap-2 ml-2">
                            <input type="number" id="checkinMins" value="60" min="5" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-24 text-center font-bold" oninput="saveInput(this)">
                            <span class="text-xs text-gray-400">mins</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">Nags worker to press "I'm OK" periodically. Only use for high-risk lone work.</p>
                 </div>
             </div>

             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkVehicle" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleVehicle(); saveInput(this)" checked>
                    <span class="text-white font-bold">Enable Vehicle Safety Checks?</span>
                </label>
                <div id="vehOptions" class="pl-8 mt-2 text-sm text-gray-400">
                    <div class="flex items-center gap-2 mb-2">
                        <span>Check Frequency (Days):</span>
                        <input type="number" id="vehFreq" value="120" class="bg-gray-800 border border-gray-600 rounded p-1 w-16 text-center text-white font-bold" oninput="saveInput(this)">
                    </div>
                    <p class="text-xs text-gray-500">Includes WOF Expiry Reminders (starts 14 days prior).</p>
                </div>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkTravelReport" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="saveInput(this)" checked>
                    <span class="text-white font-bold">Default: Require Form on Travel Finish?</span>
                </label>
                <p class="pl-8 mt-1 text-xs text-gray-500">Sets the default. Workers can still toggle this per-trip in the app settings.</p>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600 grid md:grid-cols-2 gap-4">
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Textbelt Key</label><a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional (Buy key for Non-US/Global)" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Gemini AI Key</label><a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a></div><input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For AI Reporting" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">ORS Key</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Road Mileage" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Drive Folder ID</label><span onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link cursor-pointer">Where is this?</span></div><input type="text" id="folderId" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Photos" oninput="saveInput(this)"></div>
             </div>
          </div>
          <div class="flex justify-end"><button onclick="gotoStep(2)" class="btn btn-primary text-lg">Next: Spreadsheet ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
          <div class="text-center">
              <a href="https://sheets.new" target="_blank" class="btn btn-success text-xl px-10 py-4 shadow-lg transform hover:-translate-y-1">1. Create New Google Sheet</a>
              <p class="text-gray-400 text-sm mt-2">Suggestion: Name it <strong>"OTG Safety DB"</strong></p>
          </div>
          <div class="bg-blue-900/20 p-4 rounded border border-blue-500/50 text-sm text-blue-200"><strong>üí° How to Setup Tabs:</strong> At the bottom of your Google Sheet, click the <strong>+</strong> icon to add a tab. Double-click a tab to rename it.</div>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-blue-400">A. Setup 'Visits' Tab</h3>
                <p class="text-xs text-gray-400">1. Rename tab to <strong>Visits</strong>.<br>2. Click Cell <strong>A1</strong>.<br>3. Click Copy button below.<br>4. Paste (Ctrl+V).</p>
                <button onclick="copyVisitsHeaders()" class="w-full btn bg-blue-700 hover:bg-blue-600 text-white py-2">Copy 'Visits' Headers</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-purple-400">B. Setup 'Templates' Tab</h3>
                <p class="text-xs text-gray-400">1. Create tab named <strong>Templates</strong>.<br>2. Click Cell <strong>A1</strong>.<br>3. Paste.</p>
                <button onclick="copyTemplatesSetup()" class="w-full btn bg-purple-700 hover:bg-purple-600 text-white py-2">Copy Setup + Guide</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-green-400">C. Setup 'Sites' Tab</h3>
                <p class="text-xs text-gray-400">1. Create tab named <strong>Sites</strong>.<br>2. Click Cell <strong>A1</strong>.<br>3. Paste.</p>
                <button onclick="copySitesSetup()" class="w-full btn bg-green-700 hover:bg-green-600 text-white py-2">Copy Setup + Guide</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border-2 border-red-600 space-y-4">
                <h3 class="font-bold text-lg text-red-400">D. Setup 'Staff' Tab</h3>
                <p class="text-xs text-gray-400">1. Create tab named <strong>Staff</strong>.<br>2. Click Cell <strong>A1</strong>.<br>3. Paste.</p>
                <button onclick="copyStaffSetup()" class="w-full btn bg-red-800 hover:bg-red-700 text-white py-2">Copy Setup + Guide</button>
            </div>
          </div>
          <div class="mt-4 bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-yellow-400">E. AI Reporting Tab</h3>
                <p class="text-xs text-gray-400">Create tab <strong>AI_Analysis</strong>. Then copy this Prompt Guide to generate custom scripts using ChatGPT.</p>
                <button onclick="copyReportGuide()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white py-2 px-6">Copy Full AI Prompt Guide</button>
          </div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="generateScript()" class="btn btn-primary text-lg">Next: Backend ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="relative">
            <button onclick="copyScript()" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">COPY CODE</button>
            <pre id="codeDisplay" class="code-scroll">Generating code...</pre>
          </div>
          <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 text-sm text-gray-300 space-y-4">
             <h3 class="font-bold text-green-400 text-lg">Deploy Backend</h3>
             <ol class="list-decimal pl-5 space-y-3">
                <li>Go to Google Sheet > <strong>Extensions > Apps Script</strong>.</li>
                <li>Delete existing code. <strong>Paste</strong> new code.</li>
                <li>Click <strong>Deploy > New Deployment</strong>. Select <strong>Web App</strong>.</li>
                <li class="p-3 border-2 border-red-500 rounded bg-red-900/20 text-white font-bold">‚ö†Ô∏è CRITICAL: Set "Who has access" to <span class="text-red-400 underline">"Anyone"</span>.</li>
                <li>Click <strong>Deploy</strong>. Copy the URL.</li>
             </ol>
          </div>
          <div class="bg-yellow-900/30 border border-yellow-600/50 p-6 rounded-lg mt-4">
             <h3 class="font-bold text-yellow-400 text-lg flex items-center gap-2">‚è∞ Set Automation Triggers</h3>
             <p class="text-xs text-gray-400">Apps Script > Alarm Clock Icon > + Add Trigger</p>
             <ul class="list-disc pl-5 space-y-2 text-sm text-gray-300">
                <li><strong>Safety Watchdog:</strong> <code>checkOverdueVisits</code> ‚Üí Time-driven ‚Üí Minutes timer ‚Üí Every 10 minutes.</li>
                <li><strong>Auto-Archive:</strong> <code>archiveOldData</code> ‚Üí Time-driven ‚Üí Month timer ‚Üí 1st of month.</li>
             </ul>
          </div>
          <div><label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste Web App URL:</label><input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)"></div>
          <div class="flex justify-center gap-4"><button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">üì° Test Connection</button></div>
          <div id="testResult" class="text-center font-bold text-lg hidden mt-4"></div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div><h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2><p class="text-gray-400">Files generated for: <span id="finalAppName" class="text-blue-400">App</span></p></div>
          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">Download Diamond.zip</button>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">üöÄ</span><div><h2 class="text-2xl font-bold text-white">1. Host with Netlify (Free)</h2></div></div>
                <div class="space-y-4 text-sm text-gray-300">
                    <p class="bg-blue-900/30 p-3 rounded border border-blue-500/50"><strong>Note:</strong> Netlify offers a generous free tier (100GB bandwidth/month). This is usually enough for hundreds of users.</p>
                    <ol class="list-decimal pl-6 space-y-4">
                        <li><strong>Account:</strong> Go to <a href="https://app.netlify.com/signup" target="_blank" class="text-blue-400 underline font-bold">app.netlify.com</a> and sign up.</li>
                        <li><strong>Deploy Worker App:</strong>
                            <ul class="list-disc pl-4 mt-2 text-xs text-gray-400">
                                <li>Navigate to "Sites".</li>
                                <li>Drag the <strong>WorkerApp</strong> folder from your Unzipped files into the "Drag and drop" box.</li>
                                <li>Wait for the green "Published" badge.</li>
                            </ul>
                        </li>
                        <li><strong>Rename Site:</strong> Click "Site Settings" > "Change site name" (e.g., <code>acme-safety.netlify.app</code>).</li>
                        <li><strong>Deploy Monitor App:</strong> Repeat with the <strong>MonitorApp</strong> folder. Name it something private.</li>
                    </ol>
                </div>
            </div>
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">üîí</span><div><h2 class="text-2xl font-bold text-white">2. Alternative: Self-Hosting</h2></div></div>
                <p class="text-sm text-gray-300">If you have a website or an IT team, you can host these files yourself. They are static HTML/JS files.</p>
                <ul class="list-disc pl-6 mt-4 text-sm text-gray-400">
                    <li>Send the ZIP file to your Web Developer.</li>
                    <li>Ask them to host the <code>WorkerApp</code> folder at a secure URL (HTTPS is required).</li>
                </ul>
            </div>
            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html' };
    let TEMPLATES = {};
    const workerKey = "wk_" + Math.random().toString(36).substr(2, 9); // CONSTANT KEY

    const AI_GUIDE_TEXT = `AI REPORTING GUIDE
==================
Use this guide to ask Gemini or ChatGPT to write custom report scripts for you.
... (Same as before) ...
`;

    window.onload = async () => { 
        loadPersistedData(); 
        updateRegionInfo(); // Detect TZ on load
        setupDragDrop(); 
        for (const [k, f] of Object.entries(FILES)) {
            try { const r = await fetch(f); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){}
        }
    };

    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.value); }
    function loadPersistedData() { const ids = ['orgName', 'secretKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'checkinMins', 'vehFreq', 'countrySelect']; ids.forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); if(localStorage.getItem('otg_chkTravelReport') !== null) document.getElementById('chkTravelReport').checked = localStorage.getItem('otg_chkTravelReport') === 'true'; }

    function updateRegionInfo() {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.getElementById('detectedTz').textContent = tz;
        document.getElementById('timezoneVal').value = tz;
        saveInput(document.getElementById('countrySelect'));
    }

    function toggleEnterBtn() { document.getElementById('btnEnter').disabled = !document.getElementById('chkAccept').checked; }
    function closeModal(id) { document.getElementById(id).style.display='none'; if(id==='disclaimerModal') document.getElementById('mainContent').classList.remove('blur-sm'); }

    function setupDragDrop() {
        const dz = document.getElementById('dropZone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('border-blue-500'); });
        dz.addEventListener('dragleave', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); });
        dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); });
    }
    function handleLogo(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const data = canvas.toDataURL('image/png');
                    document.getElementById('logoImg').src = data; document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoText').textContent = "‚úÖ Logo Ready";
                    document.getElementById('logoUrl').value = data; saveInput(document.getElementById('logoUrl'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function gotoStep(n) { 
        document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); 
        document.getElementById('step'+n).classList.add('active'); 
        for(let i=1; i<=5; i++){ 
            const tab = document.getElementById('tab'+i); 
            if(i===n){ tab.classList.add('active'); } else { tab.classList.remove('active'); } 
        } 
    }
    
    function toggleCheckin() { document.getElementById('checkinOptions').style.display = document.getElementById('chkCheckin').checked ? 'flex' : 'none'; }
    function toggleVehicle() { document.getElementById('vehOptions').style.display = document.getElementById('chkVehicle').checked ? 'block' : 'none'; }
    function copyVisitsHeaders() { navigator.clipboard.writeText("Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4"); alert("Copied!"); }
    function copyTemplatesSetup() { navigator.clipboard.writeText("Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?\nREPORT\tVehicle Safety Check\tALL\t\t[TEXT] Registration Plate\t[YESNO] Current Rego & WOF?\t[DATE] WOF Expiry\t[GPS] Inspection Location\t[HEADING] Tyres\t[TEXT] Tread Depth (New/Good/Low)\t[PHOTO] Tread Photo\t[TEXT] Tyre Pressures (PSI)\t[HEADING] Under Hood\t[YESNO] Oil Level OK?\t[PHOTO] Oil Level\t[YESNO] Coolant/Water OK?\t[PHOTO] Coolant Level\t[YESNO] Brake Fluid OK?\t[PHOTO] Brake Fluid\nREPORT\tTravel Report\tALL\t\t[NUMBER] Distance (km)\t[TEXT] Trip Details\t[PHOTO] Odometer Photo"); alert("Copied Setup + Guide!"); }
    function copySitesSetup() { navigator.clipboard.writeText("Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes\nALL\tStandard Visit\tAcme Corp\tHead Office\t123 Main St\tSteve\t021123456\tsteve@acme.com\tGate Code: 4455"); alert("Copied Setup + Guide!"); }
    function copyStaffSetup() { navigator.clipboard.writeText("Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry\nJohn Doe\tDriver\tActive\t\t\t\t"); alert("Copied Setup + Guide!"); }
    function copyReportGuide() { navigator.clipboard.writeText(AI_GUIDE_TEXT); alert("AI Guide Copied!"); }

    function generateScript() {
        if(!TEMPLATES.backend) { setTimeout(generateScript, 500); return; } 
        const code = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace(/%%WORKER_KEY%%/g, workerKey)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value || "Pacific/Auckland")
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value);
        document.getElementById('codeDisplay').textContent = code;
        gotoStep(3); 
    }
    function copyScript() { navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Backend Code Copied!"); }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        if(!url.includes('/exec')) { alert('Invalid URL'); return; }
        const r = document.getElementById('testResult'); r.classList.remove('hidden'); r.textContent = "Testing..."; r.className = "text-center font-bold text-lg text-yellow-400 p-3 bg-gray-900 inline-block";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value))
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                  r.textContent = "‚úÖ Success!"; r.className = "text-center font-bold text-lg text-green-400 p-3 bg-gray-900 inline-block";
                  document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50', 'cursor-not-allowed');
                  document.getElementById('finalAppName').innerText = document.getElementById('orgName').value;
                } else throw new Error();
            }).catch(() => { r.textContent = "‚ùå Failed."; r.className = "text-center font-bold text-lg text-red-400 p-3 bg-gray-900 inline-block"; });
    }

    function processGuideTemplate(html) {
        if(!html) return "";
        let out = html;
        const org = document.getElementById('orgName').value;
        const esc = document.getElementById('escalationMins').value;
        const chkInt = document.getElementById('checkinMins').value;
        const vehInt = document.getElementById('vehFreq').value;
        
        // Replace Vars
        out = out.replace(/%%ORG_NAME%%/g, org).replace(/%%ESCALATION_MINUTES%%/g, esc).replace(/%%CHECKIN_INTERVAL%%/g, chkInt).replace(/%%VEHICLE_INTERVAL%%/g, vehInt);
        
        // Process Conditional Blocks
        const processBlock = (tag, isActive) => {
            const regex = new RegExp(`([\\s\\S]*?)`, 'g');
            out = out.replace(regex, (match, content) => isActive ? content : "");
        };

        processBlock('VEHICLE', document.getElementById('chkVehicle').checked);
        processBlock('CHECKIN', document.getElementById('chkCheckin').checked);
        processBlock('TRAVEL_REPORT', document.getElementById('chkTravelReport').checked);
        
        return out;
    }

    function downloadZip() {
        const zip = new JSZip();
        const org = document.getElementById('orgName').value;
        const url = document.getElementById('webAppUrl').value;
        const secret = document.getElementById('secretKey').value;
        const logo = document.getElementById('logoUrl').value;
        const orsKey = document.getElementById('orsKey').value;
        const checkinEnabled = document.getElementById('chkCheckin').checked;
        const vehEnabled = document.getElementById('chkVehicle').checked;
        const escalationMins = document.getElementById('escalationMins').value;
        const countryPrefix = document.getElementById('countrySelect').value;
        const reqTravelReport = document.getElementById('chkTravelReport').checked;
        localStorage.setItem('otg_chkTravelReport', reqTravelReport);

        let wHtml = TEMPLATES.worker.replace(/%%ORG_NAME%%/g, org).replace(/%%GOOGLE_SHEET_URL%%/g, url).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_DATA%%/g, logo).replace(/%%SECRET_KEY%%/g, workerKey).replace(/%%CHECKIN_ENABLED%%/g, checkinEnabled).replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value).replace(/%%ESCALATION_MINUTES%%/g, escalationMins).replace(/%%IS_ADVANCED%%/g, "true").replace(/%%ENABLE_MILEAGE%%/g, "true").replace(/%%ORS_API_KEY%%/g, orsKey).replace(/%%VEHICLE_ENABLED%%/g, vehEnabled).replace(/%%VEHICLE_INTERVAL%%/g, document.getElementById('vehFreq').value).replace(/%%COUNTRY_PREFIX%%/g, countryPrefix).replace(/%%REQ_TRAVEL_REPORT%%/g, reqTravelReport);
        let mHtml = TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_URL%%/g, logo);
        let bCode = document.getElementById('codeDisplay').textContent;
        let gHtml = processGuideTemplate(TEMPLATES.guide);

        const swCode = `
const CACHE_NAME = 'otg-cache-v74';
const urlsToCache = [
  './',
  './index.html',
  './manifest.json'
];
self.addEventListener('install', event => { event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))); });
self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(response => { if (response) { return response; } return fetch(event.request); })); });
`;

        const manifest = { name: org, short_name: "Safety", start_url: "./index.html", display: "standalone", background_color: "#111827", theme_color: "#1e40af", icons: [ {src: logo, sizes: "192x192", type: "image/png"}, {src: logo, sizes: "512x512", type: "image/png"} ] };

        zip.folder("WorkerApp").file("index.html", wHtml).file("sw.js", swCode).file("manifest.json", JSON.stringify(manifest)).file("USER_GUIDE.html", gHtml);
        zip.folder("MonitorApp").file("index.html", mHtml);
        zip.file("Code.gs", bCode);
        
        // Operations Manual (Static but useful)
        const manualHtml = `<!DOCTYPE html><html lang="en"><head><title>Admin Manual</title><style>body{font-family:sans-serif;padding:2rem}</style></head><body><h1>Admin Manual</h1><p><strong>Master Key:</strong> ${secret}</p></body></html>`;
        zip.file("OPERATIONS_MANUAL.html", manualHtml);

        zip.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=org.replace(/[^a-z0-9]/gi, '_') + "_Diamond.zip";a.click()});
    }
  </script>
</body>
</html>
