<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v79.35 (Master Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; font-weight: 700; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #94a3b8; border-bottom: 4px solid transparent; transition: all 0.2s; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; cursor: pointer; font-weight: 700; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .preset-swatch { width: 56px; height: 56px; border-radius: 12px; cursor: pointer; border: 3px solid rgba(255,255,255,0.2); transition: all 0.1s; display: flex; overflow: hidden; }
    .preset-swatch.selected { outline: 4px solid #3b82f6; outline-offset: 3px; transform: scale(1.05); border-color: white; }
    .swatch-half { flex: 1; height: 100%; }
    .help-text { color: #ffffff !important; font-weight: 800; font-size: 11px; margin-top: 4px; line-height: 1.3; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2 uppercase tracking-tighter">‚ö†Ô∏è Safety Notice</h2>
          <div class="space-y-4 text-gray-200 text-sm mb-6 font-bold">
              <p>Tracking requires staff to keep the app active and alerts require internet and valid API keys.</p>
          </div>
          <div class="pt-4 border-t border-gray-700 font-bold">
              <label class="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-300 uppercase">I accept these technical requirements.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-4 bg-gray-700 text-gray-500 font-extrabold rounded-xl transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2 uppercase">OTG AppSuite Factory</h1>
      <p class="text-white font-extrabold tracking-widest text-sm uppercase">Lone Worker AppSuite Compiler</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Build</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid lg:grid-cols-2 gap-12 items-start">
            <div class="space-y-6">
                <div><label class="block text-blue-300 font-black mb-1 text-xs uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
                <div><label class="block text-blue-300 font-black text-xs uppercase mb-1">App Icon Label</label><input type="text" id="appName" maxlength="12" class="input-field text-center font-black text-green-400" value="Safety" oninput="saveInput(this)"></div>
                <div class="p-4 bg-gray-900 rounded-2xl border border-gray-700"><h3 class="text-white font-black mb-4 uppercase text-[10px] tracking-widest">üîê Security Keys</h3><div class="mb-4"><label class="block text-blue-300 font-bold mb-1 text-xs uppercase">Secret Admin Key</label><input type="text" id="secretKey" class="input-field py-2 text-yellow-400" oninput="saveInput(this)"></div><div><label class="block text-blue-300 font-bold mb-1 text-xs uppercase">Worker Key (App)</label><input type="text" id="workerKey" class="input-field py-2 text-green-400" oninput="saveInput(this)"></div></div>
            </div>

            <div id="paletteArea" class="space-y-6 bg-gray-900/50 p-6 rounded-3xl border border-gray-700">
                <h3 class="text-white font-black mb-4 uppercase text-[10px] tracking-widest text-center">üì± Live App Preview</h3>
                <div id="appMockup" class="mx-auto w-64 h-[400px] rounded-[2.5rem] border-[6px] border-gray-900 bg-[#111827] shadow-2xl overflow-hidden relative">
                    <div id="mockHeader" class="h-10 border-b border-gray-700 flex items-center px-4 bg-[#111827]"><span id="mockOrgName" class="text-[10px] font-bold text-white truncate">Organisation</span></div>
                    <div class="p-4 space-y-4"><div id="mockTravelCard" class="h-8 rounded-lg border border-gray-700"></div><div id="mockAccentCard" class="h-20 border-2 rounded-lg p-2"></div></div>
                    <div id="mockFooter" class="absolute bottom-0 w-full p-4 border-t border-gray-700 bg-[#111827]"><div id="mockMainBtn" class="h-10 w-full rounded-xl flex items-center justify-center font-black text-[10px] text-white uppercase shadow-lg">Start Visit</div></div>
                </div>
                <div class="flex gap-4 justify-center mt-6">
                    <div class="preset-swatch" onclick="applyPreset('#1e40af', '#3b82f6', this)"><div class="swatch-half bg-[#1e40af]"></div><div class="swatch-half bg-[#3b82f6]"></div></div>
                    <div class="preset-swatch" onclick="applyPreset('#064e3b', '#10b981', this)"><div class="swatch-half bg-[#064e3b]"></div><div class="swatch-half bg-[#10b981]"></div></div>
                </div>
            </div>
          </div>

          <div class="highlight-box border-blue-500/30 mt-8">
            <h3 class="text-xl font-black text-white uppercase mb-4">üõ°Ô∏è Safety & Fleet Options</h3>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div><label class="block text-white font-black text-xs uppercase mb-2">Alarm Grace Period (Mins)</label><input type="number" id="escalationMins" value="15" class="input-field w-24 text-center" oninput="saveInput(this)"></div>
                    <div class="flex items-center gap-3"><input type="checkbox" id="chkVehicle" onchange="saveInput(this)" checked class="w-6 h-6"><span class="text-sm font-black text-gray-200 uppercase">Daily Vehicle Check</span></div>
                </div>
                <div class="space-y-6">
                    <div><label class="text-[11px] font-black text-indigo-300 uppercase">Textbelt Key</label><input type="text" id="textbeltKey" class="input-field py-2 text-xs" oninput="saveInput(this)"></div>
                    <div><label class="text-[11px] font-black text-indigo-300 uppercase">Gemini AI Key</label><input type="text" id="geminiKey" class="input-field py-2 text-xs" oninput="saveInput(this)"></div>
                </div>
            </div>
          </div>

          <div class="flex justify-end pt-12"><button onclick="gotoStep(2)" class="btn btn-primary text-lg px-12 shadow-2xl font-black uppercase">Next: Database Setup ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section">
            <div class="highlight-box border-green-500/30 text-center py-10">
                <h2 class="text-3xl font-black text-white mb-6 uppercase">Step 2: Database Setup</h2>
                <a href="https://docs.google.com/spreadsheets/d/1vN43E8mFwQe_Mv_6h1v0C_3pX0Y6p7lE8x_v_e6r5C4/copy" target="_blank" class="btn bg-green-600 text-white font-black py-6 px-12 text-xl shadow-2xl uppercase">‚ú® Create Database Copy</a>
            </div>
            <div class="flex justify-between pt-12"><button onclick="gotoStep(1)" class="text-white font-black uppercase text-xs">Back</button><button onclick="gotoStep(3)" class="btn btn-primary font-black uppercase">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-10">
            <div class="highlight-box border-purple-500/30">
                <h2 class="text-3xl font-black text-white mb-6 uppercase">Step 3: Cloud Logic</h2>
                <div class="space-y-6">
                    <div><label class="block text-blue-300 font-black mb-1 text-xs uppercase">Paste Web App URL Here:</label><input type="url" id="webAppUrl" class="input-field font-mono text-yellow-300" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)"></div>
                </div>
            </div>
            <div class="flex justify-between pt-12"><button onclick="gotoStep(2)" class="text-white font-black uppercase text-xs">Back</button><button onclick="gotoStep(4)" class="btn btn-primary font-black uppercase">Next: Build Bundle ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center"><div class="highlight-box"><h2 class="text-3xl font-black text-white mb-4 uppercase tracking-widest">Step 4: Compiling Bundle</h2><button onclick="buildZip()" class="btn btn-primary text-xl px-16 py-6 shadow-2xl uppercase">üöÄ Build AppSuite (.ZIP)</button></div></div>

      </div>
    </div>
  </div>

<script>
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy";
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    const BLUEPRINTS = {
        Visits: `Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4`,
        Staff: `Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry`,
        Sites: `Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes`,
        Templates: `Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?`,
    };
    let TEMPLATES = {};
    const REGION_DATA = { "+64": { term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" }, "+61": { term: "Rego", locale: "en-AU", tz: "Australia/Sydney" }, "+44": { term: "Inspection", locale: "en-GB", tz: "Europe/London" }, "+1": { term: "Inspection", locale: "en-US", tz: "America/New_York" } };
    let selectedConfig = REGION_DATA["+64"];

    window.onload = async () => {
        document.getElementById('mainContent').classList.remove('blur-sm');
        document.getElementById('disclaimerModal').style.display = 'none';
        loadPersistedData();
        if(!document.getElementById('secretKey').value) generateMemorableKey('secretKey');
        if(!document.getElementById('workerKey').value) generateMemorableKey('workerKey');
        updateRegionInfo();
        setupDragDrop();
        for (const [k, f] of Object.entries(FILES)) { try { const r = await fetch(f + "?v=" + Date.now()); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){} }
    };

    function updateCharCount(el) { document.getElementById('charCount').innerText = `${el.value.length}/${el.maxLength}`; }

    function handleLogo(input) {
        if (input.files[0]) {
            const r = new FileReader(); r.onload = e => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); c.width = 192; c.height = 192;
                    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const d = c.toDataURL('image/png'); document.getElementById('logoImg').src = d; 
                    document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoUrl').value = d;
                    saveInput(document.getElementById('logoUrl')); triggerResample();
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(input.files[0]);
        }
    }

function triggerResample() {
        const img = document.getElementById('logoImg'); if (!img.src || img.src.length < 100) return;
        const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
        const data = ctx.getImageData(30, 30, 132, 132).data; const clusters = [];
        for (let i = 0; i < data.length; i += 16) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const max = Math.max(r, g, b), min = Math.min(r, g, b), sat = (max - min) / max;
            if (sat < 0.25 || max < 30 || max > 240) continue;
            const key = `${Math.round(r/30)*30},${Math.round(g/30)*30},${Math.round(b/30)*30}`;
            let existing = clusters.find(c => c.key === key);
            if(existing) existing.count++; else clusters.push({key, count: 1, rgb: [r,g,b]});
        }
        clusters.sort((a,b) => b.count - a.count);
        const distinct = clusters.slice(0, 4);
        const container = document.getElementById('logoClusterSwatches'); container.innerHTML = '';
        
        distinct.forEach((c, idx) => {
            if (idx >= 3) return;
            const primary = "#" + c.rgb.map(x => x.toString(16).padStart(2, '0')).join('');
            const next = distinct[idx+1] || distinct[0] || {rgb: [255,255,255]};
            const accent = "#" + next.rgb.map(x => x.toString(16).padStart(2, '0')).join('');
            
            const swatch = document.createElement('div'); swatch.className = "preset-swatch";
            swatch.innerHTML = `<div class="swatch-half" style="background:${primary}"></div><div class="swatch-half" style="background:${accent}"></div>`;
            swatch.onclick = () => applyPreset(primary, accent, swatch);
            container.appendChild(swatch);
            if(idx === 0) applyPreset(primary, accent, swatch);
        });

        // RESTORED: This line is required to make the branding section visible!
        document.getElementById('paletteArea').classList.remove('hidden');
    }

function applyPreset(p, a, el) {
    // 1. Update the color indicator boxes
    const pBox = document.getElementById('primaryColorBox');
    const aBox = document.getElementById('accentColorBox');
    if(pBox) pBox.style.backgroundColor = p;
    if(aBox) aBox.style.backgroundColor = a;
    
    // 2. Save to local storage for the build engine
    localStorage.setItem('otg_theme_primary', p); 
    localStorage.setItem('otg_theme_accent', a);
    
    // 3. Update Mockup UI with all branded components
    const mockup = document.getElementById('appMockup');
    if(mockup) {
        mockup.style.backgroundColor = p; // Primary background
        
        // Header & Footer primary colors
        const h = document.getElementById('mockHeader');
        const f = document.getElementById('mockFooter');
        if(h) h.style.backgroundColor = p;
        if(f) f.style.backgroundColor = p;
        
        // NEW: Main Button accent color
        const b = document.getElementById('mockMainBtn');
        if(b) b.style.backgroundColor = a;
        
        // Accent card (20% opacity)
        const card = document.getElementById('mockAccentCard');
        if(card) {
            card.style.borderColor = a;
            card.style.backgroundColor = a + '33';
        }

        // NEW: Travel card (30% border, 10% background)
        const travel = document.getElementById('mockTravelCard');
        if(travel) {
            travel.style.borderColor = a + '4d';
            travel.style.backgroundColor = a + '1a';
        }
    }
    
    // 4. Update the selection ring on the swatches
    document.querySelectorAll('.preset-swatch').forEach(s => s.classList.remove('selected'));
    if(el) el.classList.add('selected');
}
    function generateMemorableKey(id) { document.getElementById(id).value = id === 'workerKey' ? "wk_" + Math.random().toString(36).substr(2, 9) : "ADM-" + Math.floor(1000 + Math.random() * 9000); saveInput(document.getElementById(id)); if(id==='secretKey') validateKey(); }
    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value); }
    function copyData(k) { navigator.clipboard.writeText(BLUEPRINTS[k]); alert(k + " Blueprint Copied!"); }
    function validateKey() { }
    function openMagicLink() { window.open(MASTER_SHEET_URL, '_blank'); }
    function toggleCheck(el) { el.classList.toggle('checked'); el.querySelector('input').checked = el.classList.contains('checked'); }
function loadPersistedData() {
    const ids = ['orgName', 'secretKey', 'workerKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'countrySelect', 'appName', 'checkinMins', 'vehFreq'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        const val = localStorage.getItem('otg_' + id);
        // Only set the value if the element actually exists on the page
        if (el && val !== null) {
            if (el.type === 'checkbox') {
                el.checked = (val === 'true');
            } else {
                el.value = val;
            }
        }
    });
    updateMockupUI(); // Ensure the preview updates after loading
}
  function updateRegionInfo() { const sel = document.getElementById('countrySelect').value; selectedConfig = REGION_DATA[sel] || REGION_DATA["+64"]; document.getElementById('detectedTz').textContent = selectedConfig.tz; document.getElementById('vehTermDisplay').textContent = selectedConfig.term; document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale; document.getElementById('phoneFmtDisplay').textContent = sel; document.getElementById('timezoneVal').value = selectedConfig.tz; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('mainContent').classList.remove('blur-sm'); }
function toggleEnterBtn() {
    const chk = document.getElementById('chkAccept');
    const btn = document.getElementById('btnEnter');
    if (chk && btn) {
        btn.disabled = !chk.checked;
        // Visual feedback for the button state
        if (chk.checked) {
            btn.classList.replace('bg-gray-700', 'bg-blue-600');
            btn.classList.replace('text-gray-500', 'text-white');
        } else {
            btn.classList.replace('bg-blue-600', 'bg-gray-700');
            btn.classList.replace('text-white', 'text-gray-500');
        }
    }
}    
    function setupDragDrop() { const dz = document.getElementById('dropZone'); dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('border-blue-500'); }); dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); }); }
    function gotoStep(n) { document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); for(let i=1; i<=5; i++) document.getElementById('tab'+i).classList.toggle('active', i===n); if(n===3) generateScript(); }
    function toggleCheckin() { document.getElementById('checkinOptions').classList.toggle('hidden', !document.getElementById('chkCheckin').checked); }
    function toggleVehicle() { document.getElementById('vehOptions').classList.toggle('hidden', !document.getElementById('chkVehicle').checked); }
    function copyScript() { generateScript(); navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent); alert("Copied!"); }
    
    function generateScript() {
        if(!TEMPLATES.backend) return;
        document.getElementById('codeDisplay').textContent = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value).replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value).replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value).replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value)
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value).replace('%%ENABLE_REDACTION%%', document.getElementById('chkRedaction').checked)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term).replace('%%COUNTRY_PREFIX%%', document.getElementById('countrySelect').value)
            .replace('%%LOCALE%%', selectedConfig.locale);
    }

   // NEW: Logic to sync the UI Mockup with user inputs
function updateMockupUI() {
    const org = document.getElementById('orgName').value;
    const logo = document.getElementById('logoUrl').value;
    const primary = localStorage.getItem('otg_theme_primary') || "#1e40af";
    const accent = localStorage.getItem('otg_theme_accent') || "#3b82f6";

    // 1. Update Text & Logo
    document.getElementById('mockOrgName').innerText = org || "My Organisation";
    const mLogo = document.getElementById('mockLogo');
    if(logo && mLogo) {
        mLogo.src = logo;
        mLogo.classList.remove('hidden');
    }

    // 2. Update Themed Components
    const header = document.getElementById('mockHeader');
    const footer = document.getElementById('mockFooter');
    const mainBtn = document.getElementById('mockMainBtn');
    const accentCard = document.getElementById('mockAccentCard');
    const travelCard = document.getElementById('mockTravelCard');

    if(header) header.style.backgroundColor = primary;
    if(footer) footer.style.backgroundColor = primary;
    if(mainBtn) mainBtn.style.backgroundColor = accent;
    
    if(accentCard) {
        accentCard.style.borderColor = accent;
        accentCard.style.backgroundColor = accent + '33'; // 20% opacity
    }
    if(travelCard) {
        travelCard.style.borderColor = accent + '4d'; // 30% opacity
        travelCard.style.backgroundColor = accent + '1a'; // 10% opacity
    }
}

// UPDATED: Save input and refresh the mockup
function saveInput(el) { 
    localStorage.setItem('otg_' + el.id, el.type === 'checkbox' ? el.checked : el.value);
    if(el.id === 'orgName' || el.id === 'logoUrl') updateMockupUI();
}
    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const resBox = document.getElementById('testResult');
        resBox.classList.remove('hidden'); resBox.textContent = "Testing..."; resBox.className = "mt-4 p-4 rounded-xl text-center bg-gray-900 text-yellow-400 font-black uppercase";
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value)).then(r => r.json()).then(d => {
            if(d.status === "success") {
                resBox.textContent = "‚úÖ Success!"; resBox.className = "mt-4 p-4 rounded-xl text-center bg-green-900 text-white font-black block shadow-2xl uppercase";
                document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50', 'cursor-not-allowed');
            } else throw new Error();
        }).catch(() => { resBox.textContent = "‚ùå Connection Failed. Check your URL."; resBox.className = "mt-4 p-4 rounded-xl text-center bg-red-900 text-white font-black block uppercase"; });
    }

    function downloadZip() {
        const zip = new JSZip(); 
        const org = document.getElementById('orgName').value;
        const appShort = document.getElementById('appName').value || "Safety";
        const url = document.getElementById('webAppUrl').value;
        const logoData = document.getElementById('logoUrl').value;
        const primary = localStorage.getItem('otg_theme_primary') || "#1e40af";
        const accent = localStorage.getItem('otg_theme_accent') || "#3b82f6";
        
        // FIX: Re-added all 18 missing injection handlers
        let wHtml = TEMPLATES.worker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%ORGANISATION_NAME%%/g, org)
            .replace(/%%APP_NAME%%/g, appShort)
            .replace(/%%GOOGLE_SHEET_URL%%/g, url)
            .replace(/%%SECRET_KEY%%/g, document.getElementById('workerKey').value)
            .replace(/%%IS_ADVANCED%%/g, "true")
            .replace(/%%ENABLE_MILEAGE%%/g, document.getElementById('chkMileage').checked)
            .replace(/%%CHECKIN_ENABLED%%/g, document.getElementById('chkCheckin').checked)
            .replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value)
            .replace(/%%ESCALATION_MINUTES%%/g, document.getElementById('escalationMins').value)
            .replace(/%%VEHICLE_ENABLED%%/g, document.getElementById('chkVehicle').checked)
            .replace(/%%VEHICLE_INTERVAL%%/g, document.getElementById('vehFreq').value)
            .replace(/%%COUNTRY_PREFIX%%/g, document.getElementById('countrySelect').value)
            .replace(/%%REQ_TRAVEL_REPORT%%/g, "true")
            .replace(/%%VEHICLE_TERM%%/g, document.getElementById('vehTermDisplay').innerText)
            .replace(/%%VOICE_LOCALE%%/g, document.getElementById('voiceLocaleDisplay').innerText)
            .replace(/%%LOGO_DATA%%/g, logoData)
            .replace(/#111827/g, primary) // Update background
            .replace(/#1e40af/g, primary) 
            .replace(/#3b82f6/g, accent);
        

const swCode = `
const CACHE_NAME = 'otg-safety-v81.36';
const CRITICAL_ASSETS = [
  './',
  './index.html',
  './manifest.json',
  './icon.png',
  'https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js',
  'https://cdn.tailwindcss.com'
];

//1. Robust Install: Handles redirects for Tailwind/ToneJS
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(async (cache) => {
      console.log('Finalizing Offline Safety Cache...');
      for (const url of CRITICAL_ASSETS) {
        try {
          // Use 'no-cors' for external CDNs to ensure they can be cached
          const response = await fetch(url, { 
            mode: url.includes('http') ? 'no-cors' : 'cors', 
            redirect: 'follow' 
          });
          await cache.put(url, response);
        } catch (err) {
          console.warn('Could not cache offline asset:', url);
        }
      }
    }).then(() => self.skipWaiting())
  );
});

//2. Robust Fetch: Handles Opaque Responses (Tailwind/ToneJS) and Offline Fallbacks
self.addEventListener('fetch', (event) => {
  if (event.request.method !== 'GET') return;
  event.respondWith(
    caches.match(event.request).then((response) => {
      if (response) return response;
      return fetch(event.request).then((networkResponse) => {
        if (!networkResponse || (networkResponse.status !== 200 && networkResponse.status !== 0)) return networkResponse;
        const responseToCache = networkResponse.clone();
        caches.open(CACHE_NAME).then((cache) => { cache.put(event.request, responseToCache); });
        return networkResponse;
      }).catch(() => {
        if (event.request.mode === 'navigate') return caches.match('./index.html');
      });
    })
  );
});

// 3. ACTIVATE: Clear old versions when you release a new Factory build
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(key => key !== CACHE_NAME).map(key => caches.delete(key))
    )).then(() => self.clients.claim())
  );
});`;
     
        const manifest = { 
            name: org, 
            short_name: appShort, 
            start_url: "./index.html", 
            display: "standalone", 
            theme_color: primary, 
            icons: [
                { src: "icon.png", sizes: "192x192", type: "image/png" },
                { src: "icon.png", sizes: "512x512", type: "image/png" }
            ] 
        };

        const workerFolder = zip.folder("WorkerApp");
        workerFolder.file("index.html", wHtml);
        workerFolder.file("sw.js", swCode);
        workerFolder.file("manifest.json", JSON.stringify(manifest, null, 2));
        workerFolder.file("icon.png", logoData.split(',')[1], {base64:true});
        workerFolder.file("USER_GUIDE.html", TEMPLATES.guide.replace(/%%ORG_NAME%%/g, org));
        
        zip.folder("MonitorApp").file("index.html", TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_URL%%/g, logoData));
        zip.file("Code.gs", document.getElementById('codeDisplay').textContent);
        zip.file("OPERATIONS_MANUAL.html", TEMPLATES.manual.replace(/%%ORG_NAME%%/g, org).replace(/%%SECRET_KEY%%/g, document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g, document.getElementById('workerKey').value));
        
        zip.generateAsync({type:"blob"}).then(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = org.replace(/ /g,'_') + "_AppSuite.zip"; a.click();
        });
    }

   // NEW: Logic to sync the UI Mockup with user inputs

    function generateLaunchPack() {
        const urlInput = document.getElementById('workerAppUrl');
        const url = urlInput.value.trim();
        const org = document.getElementById('orgName').value;
        
        if(url.length > 10 && url.startsWith('http')) {
            document.getElementById('launchPack').classList.remove('hidden');
            
// Use single quotes and (+) to build the string. This prevents internal quotes from crashing the script.
const emailBody = 'Hello Team,\n\n' +
    'We are launching our new Lone-Worker Safety System for ' + (typeof org !== 'undefined' ? org : 'the organisation') + '.\n\n' +
    'Please install your personal safety app by following these steps on your phone:\n\n' +
    '1. Open this link: ' + (typeof url !== 'undefined' ? url : '') + '\n' +
    '2. Once open, tap the \'Share\' or \'Menu\' icon and select \'Add to Home Screen\'.\n' +
    '3. Launch the app from your home screen and complete the one-time Setup Wizard.\n\n' +
    'Important: Use your full name exactly as it appears in our records to ensure your safety alerts are correctly matched.\n\n' +
    'Stay safe,\n' +
    'Management';
    
    document.getElementById('launchEmail').value = emailBody;
            
            // High-resolution QR generation with High Error Correction
            document.getElementById('qrImage').src = "https://api.qrserver.com/v1/create-qr-code/?size=250x250&ecc=H&margin=1&data=" + encodeURIComponent(url);
            
            urlInput.classList.remove('border-indigo-500/30');
            urlInput.classList.add('border-green-500/50');
        } else {
            document.getElementById('launchPack').classList.add('hidden');
            urlInput.classList.remove('border-green-500/50');
            urlInput.classList.add('border-indigo-500/30');
        }
    }
</script>
</body>
</html>

