<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v78.5 (Golden)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); max-width: 900px; width: 100%; margin: 2rem auto; overflow: hidden; border: 1px solid #e2e8f0; }
    
    .step-section { display: none; padding: 2.5rem; }
    .step-section.active { display: block; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .input-label { display: block; font-weight: 700; color: #475569; margin-bottom: 0.25rem; font-size: 0.9rem; }
    .input-desc { font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem; }
    .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 0.75rem; border-radius: 0.5rem; color: #1e293b; transition: all 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; ring: 3px solid rgba(59, 130, 246, 0.1); }
    
    .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 700; cursor: pointer; transition: all 0.2s; display: inline-block; text-align: center; }
    .btn-primary { background: #2563eb; color: white; border: none; width: 100%; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #475569; width: 100%; }
    .btn-secondary:hover { background: #f8fafc; }
    .btn-success { background: #10b981; color: white; border: none; }
    .btn-disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }

    .progress-bar { display: flex; justify-content: space-between; padding: 1rem 2.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .step-dot { width: 2rem; height: 2rem; border-radius: 50%; background: #e2e8f0; color: #94a3b8; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
    .step-dot.active { background: #2563eb; color: white; }
    .step-dot.completed { background: #10b981; color: white; }

    .code-block { background: #1e293b; color: #a5f3fc; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; white-space: pre; height: 150px; width: 100%; resize: vertical; margin-top: 0.5rem; border: 1px solid #334155; }
    .copy-btn { background: #e2e8f0; color: #475569; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: bold; cursor: pointer; border: 1px solid #cbd5e1; }
    .copy-btn:active { background: #cbd5e1; }
    
    .help-box { display: none; background: #eff6ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; border: 1px solid #dbeafe; font-size: 0.85rem; color: #1e40af; }
    .help-toggle { color: #3b82f6; font-size: 0.8rem; text-decoration: underline; cursor: pointer; margin-top: 4px; display: inline-block; }
    
    .file-status { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .status-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
    .status-pending { background: #f1f5f9; color: #94a3b8; }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-err { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>

  <div class="text-center pt-8 pb-4">
    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">OTG AppSuite Factory</h1>
    <p class="text-slate-500">v78.5 | Golden Master Edition</p>
  </div>

  <div class="card">
    <div class="progress-bar">
      <div id="dot1" class="step-dot active">1</div>
      <div id="dot2" class="step-dot">2</div>
      <div id="dot3" class="step-dot">3</div>
      <div id="dot4" class="step-dot">4</div>
      <div id="dot5" class="step-dot">5</div>
      <div id="dot6" class="step-dot">6</div>
      <div id="dot7" class="step-dot">7</div>
    </div>

    <form id="factoryForm" onsubmit="return false;">

      <div id="step1" class="step-section active">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">1. Organisation Identity</h2>
        <div class="space-y-6">
          <div>
            <label class="input-label">Organisation Name</label>
            <input type="text" id="orgName" class="input-field" placeholder="e.g. Acme Community Services" required>
          </div>
          <div>
            <label class="input-label">App Icon (Logo)</label>
            <div class="flex items-center gap-4">
               <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center border overflow-hidden">
                 <img id="logoPreview" class="w-full h-full object-cover hidden">
                 <span id="logoPlaceholder" class="text-2xl">üñºÔ∏è</span>
               </div>
               <input type="file" id="fLogo" class="text-sm text-slate-500" onchange="handleLogo(this)">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
             <div>
               <label class="input-label">Country Code</label>
               <input type="number" id="countryCode" class="input-field" value="64" placeholder="64">
               <p class="input-desc">For phone formats (e.g. 64 for NZ).</p>
             </div>
             <div>
               <label class="input-label">Timezone</label>
               <input type="text" id="timezone" class="input-field" value="Pacific/Auckland">
             </div>
          </div>
        </div>
        <div class="mt-8 text-right"><button onclick="nextStep(2)" class="btn btn-primary w-auto">Next: Safety Rules &rarr;</button></div>
      </div>

      <div id="step2" class="step-section">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">2. Safety Protocols</h2>
        <div class="space-y-6">
          
          <div class="bg-red-50 p-5 rounded-lg border border-red-100">
             <label class="input-label text-red-900">Overdue Allowance (Escalation)</label>
             <input type="number" id="escMins" class="input-field border-red-200 focus:border-red-500" value="15">
             <p class="text-xs text-red-700 mt-2"><strong>How it works:</strong> If a worker sets a timer for 60 mins, but doesn't check in, the system waits this extra "Allowance" (e.g., 15 mins) before sending SMS alarms. Total time before alarm = 75 mins.</p>
          </div>

          <div class="grid grid-cols-2 gap-6">
              <div>
                  <label class="input-label">Vehicle Checks</label>
                  <select id="vehEnabled" class="input-field" onchange="toggleVeh()">
                      <option value="true" selected>Enabled</option>
                      <option value="false">Disabled</option>
                  </select>
                  <div id="vehIntBox" class="mt-2">
                      <label class="text-xs font-bold text-slate-500">Interval (Days)</label>
                      <input type="number" id="vehInterval" class="input-field py-1" value="7">
                  </div>
                  <div onclick="toggleHelp('hVeh')" class="help-toggle">What is this?</div>
                  <div id="hVeh" class="help-box">Forces the worker to complete a vehicle check every X days. If overdue, the app blocks 'Driving' mode.</div>
              </div>
              <div>
                  <label class="input-label">Mileage Tracking</label>
                  <select id="mileageEnabled" class="input-field">
                      <option value="true" selected>Enabled</option>
                      <option value="false">Disabled</option>
                  </select>
                  <div onclick="toggleHelp('hMil')" class="help-toggle">How it works</div>
                  <div id="hMil" class="help-box">Calculates distance between GPS points. Use ORS Key for road distance, otherwise uses straight line.</div>
              </div>
          </div>

          <div>
             <label class="input-label">Statistics Frequency</label>
             <select id="statsFreq" class="input-field">
                 <option value="MONTHLY" selected>Monthly (1st)</option>
                 <option value="WEEKLY">Weekly (Monday)</option>
                 <option value="DAILY">Daily</option>
             </select>
             <div onclick="toggleHelp('hStat')" class="help-toggle">Explanation</div>
             <div id="hStat" class="help-box">The backend will automatically generate 'Activity Stats' and 'Travel Stats' tabs in the spreadsheet based on this schedule.</div>
          </div>

          <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
             <div class="flex items-center gap-3">
                 <input type="checkbox" id="enableAi" class="w-5 h-5 text-blue-600" onchange="toggleAi()">
                 <label class="input-label mb-0 text-blue-900">Enable AI "Smart Scribe"</label>
             </div>
             <div id="aiBox" class="hidden mt-3">
                 <input type="text" id="geminiKey" class="input-field" placeholder="Paste Gemini API Key...">
                 <div onclick="toggleHelp('hGem')" class="help-toggle">Get Free Key</div>
                 <div id="hGem" class="help-box">Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-bold underline">Google AI Studio</a>. Privacy redaction is applied automatically.</div>
             </div>
          </div>
        </div>
        <div class="mt-8 flex justify-between"><button onclick="nextStep(1)" class="btn btn-secondary w-auto">Back</button><button onclick="nextStep(3)" class="btn btn-primary w-auto">Next: Services &rarr;</button></div>
      </div>

      <div id="step3" class="step-section">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">3. External Services</h2>
        <div class="space-y-6">
          <div>
            <label class="input-label">Master Secret Key (Auto)</label>
            <div class="flex gap-2"><input type="text" id="secretKey" class="input-field bg-slate-100" readonly><button onclick="genKey()" class="btn btn-secondary w-auto">‚Üª</button></div>
          </div>
          <div>
            <label class="input-label">OpenRouteService Key (Maps)</label>
            <input type="text" id="orsKey" class="input-field" placeholder="5b3ce...">
            <div onclick="toggleHelp('hOrs')" class="help-toggle">Get Free Key</div>
            <div id="hOrs" class="help-box">Sign up at <a href="https://openrouteservice.org" target="_blank" class="font-bold underline">openrouteservice.org</a>.</div>
          </div>
          <div>
            <label class="input-label">TextBelt Key (SMS)</label>
            <input type="text" id="textbeltKey" class="input-field" placeholder="textbelt_...">
            <div onclick="toggleHelp('hSms')" class="help-toggle">Info</div>
            <div id="hSms" class="help-box">Leave blank for Free Mode (1 SMS/day). Buy key at TextBelt.com for reliable alerts.</div>
          </div>
          <div>
            <label class="input-label">Google Drive Folder ID (Photos)</label>
            <input type="text" id="folderId" class="input-field" placeholder="1vKz...">
            <div onclick="toggleHelp('hDrive')" class="help-toggle">How to find</div>
            <div id="hDrive" class="help-box">Open a Drive folder. Copy the ID code from the end of the URL bar.</div>
          </div>
        </div>
        <div class="mt-8 flex justify-between"><button onclick="nextStep(2)" class="btn btn-secondary w-auto">Back</button><button onclick="nextStep(4)" class="btn btn-primary w-auto">Next: Load Assets &rarr;</button></div>
      </div>

      <div id="step4" class="step-section">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">4. Load System Assets</h2>
        <div class="bg-white p-6 rounded-lg border border-slate-200 text-center">
            <p class="mb-4 text-slate-600">Scanning local directory...</p>
            <div class="space-y-2 text-left max-w-md mx-auto">
                <div id="st_worker" class="file-status"><span>Worker App</span> <span class="status-badge status-pending">...</span></div>
                <div id="st_monitor" class="file-status"><span>Monitor App</span> <span class="status-badge status-pending">...</span></div>
                <div id="st_backend" class="file-status"><span>Backend Script</span> <span class="status-badge status-pending">...</span></div>
                <div id="st_guide" class="file-status"><span>User Guide</span> <span class="status-badge status-pending">...</span></div>
                <div id="st_manual" class="file-status"><span>Admin Manual</span> <span class="status-badge status-pending">...</span></div>
            </div>
            <div id="manUpload" class="hidden mt-6 pt-6 border-t border-slate-200">
                <p class="text-red-500 text-sm font-bold mb-2">‚ö†Ô∏è Auto-load blocked. Upload files manually.</p>
                <input type="file" multiple onchange="handleFiles(this)" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-blue-50 file:text-blue-700 font-semibold">
            </div>
        </div>
        <div class="mt-8 flex justify-between"><button onclick="nextStep(3)" class="btn btn-secondary w-auto">Back</button><button id="btnGotoDb" onclick="nextStep(5)" class="btn btn-disabled w-auto" disabled>Next: Database Setup &rarr;</button></div>
      </div>

      <div id="step5" class="step-section">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">5. Database Setup</h2>
        <p class="text-slate-600 mb-6">Create a <a href="https://sheets.new" target="_blank" class="text-blue-600 font-bold underline">New Google Sheet</a>. Create these 5 tabs and copy the exact data below.</p>
        
        <div class="space-y-6">
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-700">Tab 1: 'Visits'</span>
                    <button onclick="copyContent('dataVisits')" class="copy-btn">Copy Data</button>
                </div>
                <textarea id="dataVisits" class="code-block" readonly>Timestamp,Date,Worker Name,Worker Phone,Emerg Name,Emerg Phone,Emerg Email,Escal Name,Escal Phone,Escal Email,Alarm Status,Notes,Location Name,Location Address,GPS Coords,GPS Timestamp,Battery Level,Photo,Trip Distance
2024-01-01T08:00:00.000Z,2024-01-01,John Doe,+6421123456,Jane Doe,+6421999888,jane@test.com,,,,"ON SITE","Arrived safely","Head Office","123 Queen St","-36.8,174.7",2024-01-01T08:00:00.000Z,95%,,0</textarea>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-700">Tab 2: 'Staff'</span>
                    <button onclick="copyContent('dataStaff')" class="copy-btn">Copy Data</button>
                </div>
                <textarea id="dataStaff" class="code-block" readonly>Worker Name,Phone,Email,PIN,Role,Emg Name,Emg Phone,DeviceID
John Doe,+6421123456,john@test.com,1234,Worker,Jane Doe,+6421999888,</textarea>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-700">Tab 3: 'Sites'</span>
                    <button onclick="copyContent('dataSites')" class="copy-btn">Copy Data</button>
                </div>
                <textarea id="dataSites" class="code-block" readonly>SiteID,Site Name,Latitude,Longitude,Address,Contact Name,Contact Phone,Contact Email,Notes,Template Name
site_hq,Head Office,-36.8485,174.7633,123 Queen St,Reception,093000000,reception@hq.com,Parking at rear,Standard Visit Note</textarea>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-700">Tab 4: 'Templates'</span>
                    <button onclick="copyContent('dataTemp')" class="copy-btn">Copy Data</button>
                </div>
                <textarea id="dataTemp" class="code-block" readonly>Template Name,Description,JSON Fields
Vehicle Safety Check,Standard vehicle inspection,"[{""label"":""Rego Valid?"",""type"":""yesno""},{""label"":""Tyres OK?"",""type"":""yesno""},{""label"":""Fuel Level"",""type"":""select"",""options"":[""Full"",""3/4"",""1/2"",""1/4"",""Empty""]},{""label"":""Damage Report"",""type"":""text""},{""label"":""Photo of Odometer"",""type"":""photo""}]"</textarea>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-purple-700">Tab 5: 'Admin_Help' (AI Prompts)</span>
                    <button onclick="copyContent('dataAI')" class="copy-btn">Copy Data</button>
                </div>
                <textarea id="dataAI" class="code-block" readonly>Task,AI Prompt Suggestion
Create PDF Report,"I have a Google Sheet with a tab 'Visits'. Columns are: A=Timestamp, C=Worker Name, K=Status, S=Distance. Please write a Google Apps Script function to email me a PDF summary of total distance per worker for the last 7 days."
Data Clean Up,"Write a script to archive rows from 'Visits' that are older than 30 days to a new tab called 'Archive'."</textarea>
                <p class="text-xs text-slate-500 mt-1">Use these prompts with ChatGPT/Gemini to build custom reports later.</p>
            </div>
        </div>

        <div class="mt-8 flex justify-between"><button onclick="nextStep(4)" class="btn btn-secondary w-auto">Back</button><button onclick="nextStep(6)" class="btn btn-primary w-auto">Next: Backend Code &rarr;</button></div>
      </div>

      <div id="step6" class="step-section">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">6. Deploy Backend</h2>
        <div class="space-y-6">
            <div>
                <label class="input-label">1. Copy Backend Code</label>
                <div class="relative">
                    <textarea id="codeDisplay" class="code-block" style="height:250px" readonly></textarea>
                    <button onclick="copyCode()" class="absolute top-2 right-2 copy-btn bg-slate-700 text-white border-none">COPY ALL</button>
                </div>
            </div>
            <div class="bg-blue-50 p-4 rounded text-sm text-blue-900 border border-blue-200">
                <strong>2. Deployment Instructions:</strong>
                <ol class="list-decimal pl-5 mt-2 space-y-1">
                    <li>In your Google Sheet, go to <strong>Extensions > Apps Script</strong>.</li>
                    <li>Paste the code into the editor.</li>
                    <li>Click <strong>Deploy > New Deployment</strong>.</li>
                    <li>Select: <strong>Web App</strong>. Execute as: <strong>Me</strong>. Access: <strong>Anyone</strong>.</li>
                    <li>Click Deploy. Copy the <strong>Web App URL</strong>.</li>
                </ol>
            </div>
            <div>
                <label class="input-label">3. Paste Web App URL & Test</label>
                <div class="flex gap-2">
                    <input type="url" id="webAppUrl" class="input-field" placeholder="https://script.google.com/macros/s/...">
                    <button onclick="testConnection()" id="btnTest" class="btn btn-primary w-32">Test üì°</button>
                </div>
                <p id="testResult" class="text-xs font-bold mt-2 hidden"></p>
            </div>
        </div>
        <div class="mt-8 flex justify-between"><button onclick="nextStep(5)" class="btn btn-secondary w-auto">Back</button><button id="btnFinal" onclick="nextStep(7)" class="btn btn-disabled w-auto" disabled>Next: Download &rarr;</button></div>
      </div>

      <div id="step7" class="step-section text-center py-12">
        <div class="text-6xl mb-4">üöÄ</div>
        <h2 class="text-3xl font-bold text-slate-800">Ready to Launch</h2>
        <p class="text-slate-500 mb-8">Infrastructure verified. Download your apps.</p>
        <button onclick="generateZip()" class="btn btn-primary text-lg py-4 shadow-lg w-full max-w-sm mx-auto">DOWNLOAD .ZIP</button>
        <div class="mt-8 text-sm text-slate-400">
            <p>1. Extract ZIP.</p>
            <p>2. Upload 'WorkerApp' to secure host (Netlify).</p>
            <p>3. Send URL to staff.</p>
        </div>
        <button onclick="location.reload()" class="mt-8 text-slate-400 underline">Start Over</button>
      </div>

    </form>
  </div>

<script>
let TEMPLATES = {'worker_template.html':null,'monitor_template.html':null,'backend_template.js':null,'guide_template.html':null,'ops_manual_template.html':null};
let GENERATED_BACKEND = "";
window.onload=()=>{genKey();};
function genKey(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<32;i++)r+=c.charAt(Math.floor(Math.random()*c.length));document.getElementById('secretKey').value=r;}
function toggleHelp(id){const e=document.getElementById(id);e.style.display=e.style.display==='block'?'none':'block';}
function toggleAi(){document.getElementById('aiBox').classList.toggle('hidden',!document.getElementById('enableAi').checked);}
function toggleVeh(){document.getElementById('vehIntBox').classList.toggle('hidden',document.getElementById('vehEnabled').value==='false');}
function handleLogo(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{TEMPLATES.logo=e.target.result;document.getElementById('logoPreview').src=e.target.result;document.getElementById('logoPreview').classList.remove('hidden');document.getElementById('logoPlaceholder').classList.add('hidden');};r.readAsDataURL(i.files[0]);}}
function nextStep(n){if(n===4)attemptAutoLoad();if(n===6)prepareBackend();document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));document.getElementById('step'+n).classList.add('active');document.querySelectorAll('.step-dot').forEach((d,i)=>{d.className='step-dot '+(i+1===n?'active':i+1<n?'completed':'');});}
async function attemptAutoLoad(){const map=[{id:'st_worker',f:'worker_template.html'},{id:'st_monitor',f:'monitor_template.html'},{id:'st_backend',f:'backend_template.js'},{id:'st_guide',f:'guide_template.html'},{id:'st_manual',f:'ops_manual_template.html'}];let ok=0;for(let m of map){const b=document.querySelector(`#${m.id} .status-badge`);try{const r=await fetch('./'+m.f);if(!r.ok)throw new Error();TEMPLATES[m.f]=await r.text();b.className="status-badge status-ok";b.innerText="LOADED";ok++;}catch(e){b.className="status-badge status-err";b.innerText="MISSING";}}checkAssets(ok===5);}
function handleFiles(inp){Array.from(inp.files).forEach(f=>{if(TEMPLATES.hasOwnProperty(f.name)){const r=new FileReader();r.onload=e=>{TEMPLATES[f.name]=e.target.result;let id="";if(f.name.includes('worker'))id='st_worker';else if(f.name.includes('monitor'))id='st_monitor';else if(f.name.includes('backend'))id='st_backend';else if(f.name.includes('guide'))id='st_guide';else if(f.name.includes('manual'))id='st_manual';if(id){document.querySelector(`#${id} .status-badge`).className="status-badge status-ok";document.querySelector(`#${id} .status-badge`).innerText="UPLOADED";}if(Object.values(TEMPLATES).every(v=>v!==null))checkAssets(true);};r.readAsText(f);}});}
function checkAssets(ready){if(ready){document.getElementById('btnGotoDb').disabled=false;document.getElementById('btnGotoDb').classList.remove('btn-disabled');document.getElementById('btnGotoDb').classList.add('btn-primary');document.getElementById('manUpload').classList.add('hidden');}else{document.getElementById('manUpload').classList.remove('hidden');}}
function prepareBackend(){
    const C={ORG:document.getElementById('orgName').value,SECRET:document.getElementById('secretKey').value,WORKER_KEY:"W_"+Math.random().toString(36).substr(2,9),ORS:document.getElementById('orsKey').value||"",GEMINI:document.getElementById('geminiKey').value||"",TEXTBELT:document.getElementById('textbeltKey').value||"",FOLDER:document.getElementById('folderId').value||"",ENABLE_AI:document.getElementById('enableAi').checked?"true":"false",COUNTRY:document.getElementById('countryCode').value||"64",TIMEZONE:document.getElementById('timezone').value||"Pacific/Auckland",STATS_FREQ:document.getElementById('statsFreq').value||"MONTHLY",ESCALATION:document.getElementById('escMins').value||"15"};
    TEMPLATES.config=C;
    let code=TEMPLATES['backend_template.js'].replace(/%%ESCALATION_MINUTES%%/g,C.ESCALATION).replace(/%%ENABLE_AI%%/g,C.ENABLE_AI).replace(/%%SECRET_KEY%%/g,C.SECRET).replace(/%%ORS_API_KEY%%/g,C.ORS).replace(/%%GEMINI_API_KEY%%/g,C.GEMINI).replace(/%%TEXTBELT_API_KEY%%/g,C.TEXTBELT).replace(/%%PHOTOS_FOLDER_ID%%/g,C.FOLDER).replace(/%%ORGANISATION_NAME%%/g,C.ORG).replace(/%%TIMEZONE%%/g,C.TIMEZONE).replace(/%%COUNTRY_CODE%%/g,C.COUNTRY).replace(/%%STATS_FREQ%%/g,C.STATS_FREQ).replace(/%%WORKER_KEY%%/g,C.WORKER_KEY);
    GENERATED_BACKEND=code;document.getElementById('codeDisplay').value=code;
}
function copyCode(){const c=document.getElementById('codeDisplay');c.select();document.execCommand('copy');alert("Code Copied!");}
function copyContent(id){const t=document.getElementById(id).value;navigator.clipboard.writeText(t).then(()=>alert("Data Copied!"));}
function testConnection(){const url=document.getElementById('webAppUrl').value.trim();const res=document.getElementById('testResult');if(url.length<10){alert("Invalid URL");return;}res.classList.remove('hidden');res.className="text-xs font-bold mt-2 text-blue-600";res.innerText="Testing...";fetch(url+"?action=ping").then(r=>r.json()).then(d=>{if(d.status==="success"){res.className="text-xs font-bold mt-2 text-green-600";res.innerText="‚úÖ Success: "+d.message;document.getElementById('btnFinal').disabled=false;document.getElementById('btnFinal').classList.remove('btn-disabled');document.getElementById('btnFinal').classList.add('btn-success');}else{throw new Error(d.message);}}).catch(e=>{res.className="text-xs font-bold mt-2 text-red-600";res.innerText="‚ùå Connection Failed: "+e.message;});}
function generateZip(){
    const zip=new JSZip();const C=TEMPLATES.config;
    zip.file("backend.js",GENERATED_BACKEND);
    let worker=TEMPLATES['worker_template.html'].replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%COUNTRY_CODE%%/g,C.COUNTRY).replace(/%%LOGO_DATA%%/g,TEMPLATES.logo||"").replace(/%%WORKER_KEY%%/g,C.WORKER_KEY).replace(/%%ORS_API_KEY%%/g,C.ORS).replace(/%%ESCALATION_MINUTES%%/g,C.ESCALATION).replace(/%%VEH_ENABLED%%/g,document.getElementById('vehEnabled').value).replace(/%%VEH_INTERVAL%%/g,document.getElementById('vehInterval').value).replace(/%%MILEAGE_ENABLED%%/g,document.getElementById('mileageEnabled').value);
    const wf=zip.folder("WorkerApp");
    wf.file("index.html",worker);
    wf.file("sw.js",`const CACHE_NAME='otg-v78.5';const u=['./','./index.html','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(u)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>{return r||fetch(e.request)}))});`);
    wf.file("manifest.json",JSON.stringify({name:C.ORG,short_name:"Safety",start_url:"./index.html",display:"standalone",background_color:"#111827",theme_color:"#1e40af",icons:[{src:"icon.png",sizes:"192x192",type:"image/png"},{src:"icon.png",sizes:"512x512",type:"image/png"}]}));
    wf.file("USER_GUIDE.html",TEMPLATES['guide_template.html'].replace(/%%ORG_NAME%%/g,C.ORG));
    if(TEMPLATES.logo)wf.file("icon.png",TEMPLATES.logo.split(',')[1],{base64:true});
    zip.folder("MonitorApp").file("index.html",TEMPLATES['monitor_template.html'].replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%LOGO_URL%%/g,TEMPLATES.logo||""));
    zip.file("ADMIN_MANUAL.html",TEMPLATES['ops_manual_template.html'].replace(/%%ORG_NAME%%/g,C.ORG).replace(/%%SECRET_KEY%%/g,C.SECRET).replace(/%%WORKER_KEY%%/g,C.WORKER_KEY));
    zip.generateAsync({type:"blob"}).then(c=>{const l=document.createElement("a");l.href=URL.createObjectURL(c);l.download=`OTG_AppSuite_${C.ORG.replace(/\s+/g,'_')}.zip`;l.click();});
}
</script>
</body>
</html>
