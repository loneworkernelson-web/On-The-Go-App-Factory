<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTG Factory: Gold Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #1a202c; color: #edf2f7; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { font-size: 2.5rem; color: #63b3ed; font-weight: 700; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #a0aec0; margin-bottom: 40px; font-size: 1.1rem; }
        
        .card { background-color: #2d3748; border-radius: 8px; padding: 30px; margin-bottom: 30px; border-left: 5px solid #4a5568; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; color: #e2e8f0; display: flex; align-items: center; }
        .card-step { background: #4a5568; color: white; border-radius: 50%; width: 35px; height: 35px; display: inline-flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2rem; }
        
        label { display: block; font-weight: 700; color: #cbd5e0; margin-bottom: 8px; margin-top: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; }
        input, select { width: 100%; padding: 12px; border-radius: 4px; border: 1px solid #4a5568; background-color: #1a202c; color: white; font-family: monospace; font-size: 1rem; }
        input:focus, select:focus { border-color: #63b3ed; outline: none; }
        
        .btn { display: block; width: 100%; padding: 15px; text-align: center; font-weight: 700; border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-top: 10px; border: none; font-size: 1rem; }
        .btn-blue { background-color: #3182ce; color: white; }
        .btn-blue:hover { background-color: #2b6cb0; }
        .btn-green { background-color: #38a169; color: white; font-size: 1.2rem; padding: 20px; }
        .btn-green:hover { background-color: #2f855a; }
        .btn-copy { background-color: #4a5568; color: #e2e8f0; text-align: left; display: flex; justify-content: space-between; }
        .btn-copy:hover { background-color: #718096; }

        .note { background-color: #2c5282; padding: 15px; border-radius: 4px; font-size: 0.9rem; color: #bee3f8; margin-top: 15px; line-height: 1.5; }
        .warning { color: #fc8181; font-size: 0.85rem; margin-top: 5px; display: none; }
        
        .drop-zone { border: 2px dashed #4a5568; padding: 20px; text-align: center; border-radius: 4px; cursor: pointer; background: #232d3d; transition: 0.2s; }
        .drop-zone:hover { border-color: #63b3ed; }
        
        .code-preview { background: #111; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #68d391; max-height: 200px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #4a5568; }
    </style>
</head>
<body>

<div class="container">
    <h1>OTG Factory</h1>
    <p class="subtitle">System Builder v72.0 (Classic Gold)</p>

    <div class="card" style="border-left-color: #63b3ed;">
        <div class="card-title"><span class="card-step">1</span> Identity & Configuration</div>
        <p class="text-gray-400 mb-4">Start by defining the identity of the organisation. The Master Key is your administrator password. The Worker Key is generated automatically.</p>
        
        <label>Organisation Name</label>
        <input id="orgName" placeholder="e.g. Acme Church Safety" oninput="saveInput(this)">
        
        <label>App Logo (Drag & Drop)</label>
        <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
            <p id="dropText">‚òÅÔ∏è Drag logo file here (or click to upload)</p>
        </div>
        <input id="logoUrl" type="hidden" oninput="saveInput(this)">

        <label>Master Secret Key</label>
        <input id="masterKey" type="text" placeholder="Create a strong password..." oninput="validateKey(); saveInput(this)">
        <div id="keyWarning" class="warning">‚ö†Ô∏è Key is too short (minimum 8 characters)</div>
    </div>

    <div class="card" style="border-left-color: #9f7aea;">
        <div class="card-title"><span class="card-step">2</span> Database Setup</div>
        <p class="text-gray-400 mb-4">The system requires a Google Sheet with 5 specific tabs. Create a new Sheet, then use the buttons below to copy the exact headers required for each tab. Paste them into <strong>Row 1, Cell A1</strong> of the respective tab.</p>
        
        <div class="grid grid-cols-1 gap-3">
            <button onclick="copyHeaders('Visits')" class="btn btn-copy">
                <div><strong>1. Visits Tab</strong> <span class="text-xs block text-gray-400">Stores logs & GPS data</span></div>
                <span>üìã Copy Headers</span>
            </button>
            <button onclick="copyHeaders('Staff')" class="btn btn-copy">
                <div><strong>2. Staff Tab</strong> <span class="text-xs block text-gray-400">Manage users & WOF dates</span></div>
                <span>üìã Copy Headers</span>
            </button>
            <button onclick="copyHeaders('Sites')" class="btn btn-copy">
                <div><strong>3. Sites Tab</strong> <span class="text-xs block text-gray-400">Locations & Hazards</span></div>
                <span>üìã Copy Headers</span>
            </button>
            <button onclick="copyHeaders('Templates')" class="btn btn-copy">
                <div><strong>4. Templates Tab</strong> <span class="text-xs block text-gray-400">Define forms & questions</span></div>
                <span>üìã Copy Headers</span>
            </button>
            <button onclick="copyHeaders('AI_Analysis')" class="btn btn-copy" style="border:1px solid #9f7aea;">
                <div><strong>5. AI_Analysis Tab</strong> <span class="text-xs block text-gray-400">Target for AI Reports</span></div>
                <span>ü§ñ Copy Headers</span>
            </button>
        </div>
    </div>

    <div class="card" style="border-left-color: #f6ad55;">
        <div class="card-title"><span class="card-step">3</span> System Settings</div>
        <p class="text-gray-400 mb-4">Fine-tune the behavior of the safety timers and optional API integrations.</p>
        
        <div class="grid grid-cols-2 gap-4">
            <div><label>Escalation (Mins)</label><input id="valEsc" type="number" value="15" oninput="saveInput(this)"></div>
            <div><label>Check-in (Mins)</label><input id="valCheckin" type="number" value="120" oninput="saveInput(this)"></div>
        </div>

        <label>Enable Mileage Calculation?</label>
        <select id="featMileage" onchange="saveInput(this)"><option value="true">Yes</option><option value="false">No</option></select>

        <label>Enable Vehicle WOF Checks?</label>
        <select id="featVeh" onchange="saveInput(this)"><option value="true">Yes</option><option value="false">No</option></select>

        <details class="mt-4">
            <summary class="cursor-pointer text-blue-400 font-bold">Advanced API Settings (Optional)</summary>
            <div class="mt-2 pl-4 border-l-2 border-gray-600">
                <label>OpenRouteService API (Better Mileage)</label><input id="apiOrs" placeholder="..." oninput="saveInput(this)">
                <label>Gemini API (AI Reports)</label><input id="apiGemini" placeholder="..." oninput="saveInput(this)">
                <label>TextBelt API (SMS Alerts)</label><input id="apiText" placeholder="..." oninput="saveInput(this)">
                <label>Google Drive Folder ID (Photos)</label><input id="idFolder" placeholder="..." oninput="saveInput(this)">
            </div>
        </details>
    </div>

    <div class="card" style="border-left-color: #63b3ed;">
        <div class="card-title"><span class="card-step">4</span> Deployment</div>
        <div class="note mb-4">
            1. Click 'Copy Backend Code' below.<br>
            2. Go to <strong>Extensions > Apps Script</strong> in your Google Sheet.<br>
            3. Paste the code into <code>Code.gs</code>.<br>
            4. <strong>Deploy as Web App</strong> > Execute as Me > Access: Anyone.
        </div>
        
        <button id="btnCopyBackend" onclick="copyBackendCode()" class="btn btn-blue">üìÑ Copy Backend Code (Keys Injected)</button>
        
        <label>Web App URL (Ends in /exec)</label>
        <div class="flex gap-2">
            <input id="sheetUrl" placeholder="https://script.google.com/macros/s/..." oninput="saveInput(this)">
            <button onclick="testConnection()" class="btn btn-blue" style="width: auto; margin-top:0;">Test</button>
        </div>
        <p id="connStatus" class="font-bold mt-2 text-sm"></p>
    </div>

    <div class="card" style="border-left-color: #9f7aea;">
        <div class="card-title"><span class="card-step">5</span> AI Reporting Guide</div>
        <p class="text-gray-400 mb-4">This section helps you generate custom reports. Copy the guide below and paste it into ChatGPT or Gemini to have it write custom Apps Script functions for your sheet.</p>
        
        <div id="aiGuidePreview" class="code-preview mb-4"></div>
        <button onclick="copyFullAIGuide()" class="btn btn-copy" style="justify-content:center;">üìã Copy AI Prompt Guide to Clipboard</button>
        
        <div class="mt-6 pt-4 border-t border-gray-600">
            <label style="margin-top:0;">Automated Weekly Analyst</label>
            <p class="text-sm text-gray-400 mb-2">Requires Gemini API Key in Step 3.</p>
            <button onclick="copyAICode()" class="btn btn-blue" style="background:#553c9a;">ü§ñ Copy AI.gs Script</button>
        </div>
    </div>

    <div class="card" style="border-left-color: #48bb78;">
        <div class="card-title"><span class="card-step bg-green-600">6</span> Build System</div>
        <p class="text-gray-400 mb-4">This will generate a ZIP file containing the Worker App, Monitor App, and the Administrator Manual with your keys.</p>
        <button onclick="generateZip()" class="btn btn-green">üì¶ DOWNLOAD SYSTEM ZIP</button>
    </div>

</div>

<script>
    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js' };
    let TEMPLATES = {};

    const AI_GUIDE_TEXT = `AI REPORTING GUIDE
==================
Use this guide to ask Gemini or ChatGPT to write custom report scripts for you.

SECTION 1: DEPLOYMENT RULE (READ FIRST)
---------------------------------------
If you write a script that only READS the spreadsheet and creates a new Report Tab (like the examples below):
1. You DO NOT need to update the Web App Deployment.
2. Just paste the code into Apps Script and click "Run" (or set a Time Trigger).
3. The script runs "locally" inside the sheet.
Only update the Web App Deployment if you change "doPost" or "doGet" (the core backend).

SECTION 2: DATA MAP (For the AI)
--------------------------------
Paste this into your AI prompt so it knows your data structure:
I have a Google Sheet named 'Visits'.
The columns are mapped as follows:
- Col A: Timestamp (Start of Visit)
- Col C: Worker Name
- Col K: Status (e.g. 'DEPARTED', 'EMERGENCY')
- Col M: Location Name
- Col P: Device Timestamp (End of Visit / Last Check-in)
- Col Q: Battery Level (e.g. '85%')
- Col S: Distance (km)
- Col T: Visit Report Data (JSON string containing form answers)
- Col U: Anticipated Departure Time

SECTION 2B: LONG-TERM HISTORY (THE ARCHIVE)
-------------------------------------------
PRO TIP: If you need a report covering more than 30 days (e.g., Annual Mileage), you must tell the AI to look at the Archive.
Add this to your prompt:
"Please note: Older data is moved to a sheet named 'Archive'. Please modify the script to read data from BOTH the 'Visits' sheet and the 'Archive' sheet, combine them into one array, and then generate the report."

SECTION 3: PROMPT RECIPES (Copy & Paste these)
----------------------------------------------
RECIPE 1: MILEAGE REPORT
"Write a Google Apps Script function called 'generateMileageReport'.
1. Read all data from 'Visits'.
2. Create/Overwrite a sheet called 'Mileage Report'.
3. Group data by Worker Name (Col C) and Location (Col M).
4. Sum the Distance (Col S) for each group.
5. Create a clean table: Worker | Location | Total KM.
6. Add a Grand Total at the bottom."

RECIPE 2: TIMESHEET (PAYROLL)
"Write a script called 'generateTimesheet'.
1. Read 'Visits'.
2. Calculate duration in minutes: (Col P - Col A).
3. Ignore rows where Status is not 'DEPARTED'.
4. Create a sheet 'Weekly Timesheet'.
5. List: Worker | Date | Location | Start Time | End Time | Duration (Hours).
6. Sum Total Hours per Worker."

RECIPE 3: SAFETY AUDIT (COMPLIANCE)
"Write a script called 'auditSafety'.
1. Read 'Visits'.
2. Identify rows where Battery Level (Col Q) is < 20%.
3. Identify rows where Status (Col K) contains 'EMERGENCY' or 'OVERDUE'.
4. Create a sheet 'Safety Audit'.
5. List these high-risk visits.
6. Highlight 'EMERGENCY' rows in Red."

RECIPE 4: SITE HISTORY (JSON EXTRACTION)
"Write a script called 'collateSiteComments'.
1. Read 'Visits'.
2. Filter for Location Name = 'Main Office' (make this a variable).
3. Parse the JSON in Col T ('Visit Report Data').
4. Extract the field labeled 'Notes' or 'Comments' from that JSON.
5. Create a sheet 'Site Log - Main Office'.
6. List: Date | Worker | Extracted Notes."

RECIPE 5: AFTER-HOURS WORK
"Write a script to find after-hours work.
1. Read 'Visits'.
2. Flag rows where Start Time (Col A) is on a Saturday/Sunday OR after 6:00 PM.
3. Output to a new sheet 'After Hours Log'."

RECIPE 6: WORKER ACTIVITY SUMMARY
"Write a script for an Executive Summary.
1. Count total unique visits per Worker.
2. Calculate average duration per visit per Worker.
3. Count total 'EMERGENCY' statuses per Worker.
4. Output a summary table."

RECIPE 7: MISSING REPORTS
"Write a script to find missing reports.
1. Filter rows where Status is 'DEPARTED'.
2. Check if Col T (Report Data) is empty or '{}'.
3. List workers who departed without filing a report."

RECIPE 8: TRAVEL VS ON-SITE
"Write a script to compare Travel vs Work.
1. Sum duration for rows where Location Name contains 'Travel'.
2. Sum duration for all other rows.
3. Calculate the ratio per worker."

RECIPE 9: MONTHLY ARCHIVE
"Write a script to move last month's data.
1. Identify rows from the previous month.
2. Move them to a sheet named 'Archive - [Month-Year]'.
3. Delete them from 'Visits' to keep it fast."

RECIPE 10: FORM DATA EXPORT
"Write a script to flatten the JSON form data.
1. Read Col T.
2. Find all unique keys used in the JSON objects (e.g. 'Hazard?', 'Safe?').
3. Create a new sheet with these keys as Column Headers.
4. Populate the rows with the values from the JSON."`;

    window.onload = async () => { loadPersistedData(); await loadTemplates(); document.getElementById('aiGuidePreview').innerText = AI_GUIDE_TEXT; };

    function saveInput(el) { localStorage.setItem('otg_' + el.id, el.value); }
    function loadPersistedData() { const ids = ['orgName', 'logoUrl', 'masterKey', 'sheetUrl', 'apiOrs', 'apiGemini', 'apiText', 'idFolder', 'valEsc', 'valCheckin', 'featMileage', 'featVeh']; ids.forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); }
    function validateKey() { const k = document.getElementById('masterKey').value; const w = document.getElementById('keyWarning'); if(k.length > 0 && k.length < 8) w.style.display = 'block'; else w.style.display = 'none'; }

    async function loadTemplates() {
        for (const [key, file] of Object.entries(FILES)) {
            try {
                const r = await fetch(file);
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                TEMPLATES[key] = await r.text();
            } catch (e) { alert(`ERROR: Missing ${file}.`); }
        }
    }

    function handleFileSelect(input) { if (input.files.length) handleFile(input.files[0]); }
    function handleFile(file) {
        if (!file.type.startsWith('image/')) return alert("Image files only.");
        document.getElementById('dropText').innerText = "Processing...";
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX = 192;
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                document.getElementById('logoUrl').value = canvas.toDataURL('image/png');
                saveInput(document.getElementById('logoUrl'));
                document.getElementById('dropText').innerText = "‚úÖ Logo Loaded!";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function copyHeaders(type) {
        let h = "";
        if(type === 'Visits') h = "Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4";
        if(type === 'Staff') h = "Name\tEmail\tStatus\tRole\tDeviceID\tLastVehCheck\tWOFExpiry";
        if(type === 'Sites') h = "Assigned To\tTemplate Name\tCompany\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tNotes";
        if(type === 'Templates') h = "Type\tName\tAssigned To\tEmail To\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5";
        if(type === 'AI_Analysis') h = "Timestamp\tReport Date Range\tTotal Visits\tIncident Summary\tPatterns Detected\tAI Recommendations\tSafety Score";
        navigator.clipboard.writeText(h).then(() => alert(`${type} Headers Copied!`));
    }

    function getConfigs() {
        return {
            key: document.getElementById('masterKey').value,
            org: document.getElementById('orgName').value || "My Org",
            ors: document.getElementById('apiOrs').value || "",
            gemini: document.getElementById('apiGemini').value || "",
            textbelt: document.getElementById('apiText').value || "",
            folder: document.getElementById('idFolder').value || "",
            esc: document.getElementById('valEsc').value || "15",
            wk: "wk_" + Math.random().toString(36).substr(2, 9)
        };
    }

    async function copyBackendCode() {
        if (!TEMPLATES.backend) return alert("Backend template missing.");
        const c = getConfigs();
        if (c.key.length < 8) return alert("Enter Master Key first.");
        let code = TEMPLATES.backend;
        code = code.replace("%%SECRET_KEY%%", c.key).replace("%%WORKER_KEY%%", c.wk).replace("%%ORGANISATION_NAME%%", c.org).replace("%%ESCALATION_MINUTES%%", c.esc).replace("%%ORS_API_KEY%%", c.ors).replace("%%GEMINI_API_KEY%%", c.gemini).replace("%%TEXTBELT_API_KEY%%", c.textbelt).replace("%%PHOTOS_FOLDER_ID%%", c.folder);
        try { await navigator.clipboard.writeText(code); alert("Backend Code Copied!"); } catch (e) { alert("Clipboard failed."); }
    }

    async function copyAICode() {
        const c = getConfigs();
        const aiScript = `const GEMINI_API_KEY = "${c.gemini}";\nconst TARGET_SHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();\n\nfunction runSafetyAnalysis() {\n  if(!GEMINI_API_KEY) { console.log("No API Key"); return; }\n  const ss = SpreadsheetApp.openById(TARGET_SHEET_ID);\n  const visits = ss.getSheetByName('Visits');\n  const analysis = ss.getSheetByName('AI_Analysis') || ss.insertSheet('AI_Analysis');\n  const data = visits.getDataRange().getValues();\n  const now = new Date();\n  const cutoff = new Date(now.setDate(now.getDate() - 30));\n  let logs = [];\n  data.forEach(row => {\n    const d = new Date(row[1]);\n    if(d >= cutoff) logs.push(\`\${row[1]} | \${row[2]} | \${row[10]} | \${row[11]}\`);\n  });\n  if(logs.length === 0) return;\n  const prompt = "Analyze safety logs. Format JSON: {summary, patterns, recommendations, score}. Logs: " + logs.join("\\n");\n  const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + GEMINI_API_KEY;\n  const payload = { "contents": [{ "parts": [{ "text": prompt }] }] };\n  try {\n    const response = UrlFetchApp.fetch(url, { method: 'post', contentType: 'application/json', payload: JSON.stringify(payload) });\n    const json = JSON.parse(response.getContentText());\n    const txt = json.candidates[0].content.parts[0].text.replace(/\\\`\\\`\\\`json/g, "").replace(/\\\`\\\`\\\`/g, "");\n    const result = JSON.parse(txt);\n    analysis.appendRow([new Date(), "Last 30 Days", logs.length, result.summary, result.patterns, result.recommendations, result.score]);\n  } catch(e) { console.log("AI Error", e); }\n}`;
        try { await navigator.clipboard.writeText(aiScript); alert("AI Script Copied!"); } catch (e) { alert("Clipboard failed."); }
    }

    async function copyFullAIGuide() { try { await navigator.clipboard.writeText(AI_GUIDE_TEXT); alert("Guide Copied!"); } catch (e) { alert("Clipboard failed."); } }

    function testConnection() {
        const url = document.getElementById('sheetUrl').value;
        const key = document.getElementById('masterKey').value;
        const s = document.getElementById('connStatus');
        if (!url.includes('/exec')) { s.innerHTML = "‚ùå Invalid URL"; s.style.color = "red"; return; }
        s.innerHTML = "‚è≥ Connecting..."; s.style.color = "yellow";
        fetch(`${url}?test=1&key=${encodeURIComponent(key)}`).then(r => r.json()).then(d => {
            if(d.status === 'success') { s.innerHTML = `‚úÖ Connected (${d.version})`; s.style.color = "#48bb78"; } 
            else { throw new Error(d.message); }
        }).catch(e => { s.innerHTML = "‚ùå Error"; s.style.color = "red"; });
    }

    function generateZip() {
        const c = getConfigs();
        const url = document.getElementById('sheetUrl').value;
        if (!c.org || !c.key || !url) return alert("Complete Steps 1-4.");

        const zip = new JSZip();
        const mil = document.getElementById('featMileage').value;
        const veh = document.getElementById('featVeh').value;
        const chk = document.getElementById('valCheckin').value;

        let wHtml = TEMPLATES.worker.replace(/%%ORG_NAME%%/g, c.org).replace(/%%LOGO_DATA%%/g, document.getElementById('logoUrl').value).replace(/%%GOOGLE_SHEET_URL%%/g, url).replace(/%%SECRET_KEY%%/g, c.wk).replace(/%%ORS_API_KEY%%/g, c.ors).replace(/%%IS_ADVANCED%%/g, "true").replace(/%%ENABLE_MILEAGE%%/g, mil).replace(/%%CHECKIN_ENABLED%%/g, "true").replace(/%%CHECKIN_INTERVAL%%/g, chk).replace(/%%ESCALATION_MINUTES%%/g, c.esc).replace(/%%VEHICLE_ENABLED%%/g, veh).replace(/%%VEHICLE_INTERVAL%%/g, "7");
        let mHtml = TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, c.org).replace(/%%LOGO_URL%%/g, document.getElementById('logoUrl').value).replace(/%%SHEET_URL%%/g, url);
        let bJs = TEMPLATES.backend.replace("%%SECRET_KEY%%", c.key).replace("%%WORKER_KEY%%", c.wk).replace("%%ORGANISATION_NAME%%", c.org).replace("%%ESCALATION_MINUTES%%", c.esc).replace("%%ORS_API_KEY%%", c.ors).replace("%%GEMINI_API_KEY%%", c.gemini).replace("%%TEXTBELT_API_KEY%%", c.textbelt).replace("%%PHOTOS_FOLDER_ID%%", c.folder);
        
        const manifest = { "name": c.org, "short_name": c.org.substring(0,12), "start_url": "./index.html", "display": "standalone", "background_color": "#111827", "theme_color": "#111827", "icons": [{ "src": document.getElementById('logoUrl').value||"icon.png", "sizes": "192x192", "type": "image/png" }] };

        zip.file("WorkerApp/index.html", wHtml);
        zip.file("WorkerApp/manifest.json", JSON.stringify(manifest));
        zip.file("MonitorApp/index.html", mHtml);
        zip.file("Backend/Code.gs", bJs);
        zip.file("README.txt", `OTG SAFETY SYSTEM MANUAL\n======================\n\nKEYS\n----\nMaster Key: ${c.key}\nWorker Key: ${c.wk}\n\n[1] SETUP SPREADSHEET\n---------------------\n1. Create a Google Sheet.\n2. Use the Factory buttons (Step 2) to copy headers for 'Visits', 'Staff', 'Sites', 'Templates', and 'AI_Analysis'.\n3. Paste them into the sheet.\n\n[2] DEPLOY BACKEND\n------------------\n1. Tools > Extensions > Apps Script.\n2. Paste the code from Backend/Code.gs (in this zip).\n3. Deploy as Web App > Execute as Me > Access: Anyone.\n\n[3] AI REPORTING (Optional)\n---------------------------\n1. Create a new script file 'AI.gs'.\n2. Use the Factory 'Copy AI Script' button to get the code.\n3. Add a Time-Driven trigger to run 'runSafetyAnalysis' weekly.`);

        zip.generateAsync({type:"blob"}).then(c => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(c);
            a.download = `${c.org.replace(/\s/g,'_')}_OTG_v72.zip`;
            a.click();
        });
    }
</script>
</body>
</html>
