<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v78.0 (Guided)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
    .step-section { display: none; animation: fadeIn 0.4s ease-out; }
    .step-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .input-label { display: block; font-weight: 600; color: #475569; margin-bottom: 0.25rem; font-size: 0.95rem; }
    .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 0.6rem 1rem; border-radius: 0.5rem; color: #1e293b; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; ring: 2px solid rgba(59, 130, 246, 0.2); }
    
    .btn-primary { background: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; width: 100%; transition: background 0.2s; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #475569; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; width: 100%; transition: background 0.1s; }
    .btn-secondary:hover { background: #f1f5f9; }

    .help-link { color: #3b82f6; font-size: 0.85rem; text-decoration: underline; cursor: pointer; margin-top: 0.25rem; display: inline-block; }
    .help-box { display: none; background: #eff6ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; border: 1px solid #dbeafe; font-size: 0.9rem; color: #1e40af; }
    
    .progress-dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; background: #cbd5e1; transition: all 0.3s; }
    .progress-dot.active { background: #3b82f6; transform: scale(1.2); }
    
    .file-status { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .status-pending { background: #f1f5f9; color: #64748b; }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-err { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <div class="text-center mb-8">
    <h1 class="text-3xl font-extrabold text-slate-800">OTG AppSuite Factory</h1>
    <p class="text-slate-500">v78.0 | Zero-Config Deployment</p>
  </div>

  <div class="card max-w-3xl w-full p-8 relative">
    
    <div class="flex justify-center gap-4 mb-8">
      <div id="dot1" class="progress-dot active"></div>
      <div id="dot2" class="progress-dot"></div>
      <div id="dot3" class="progress-dot"></div>
      <div id="dot4" class="progress-dot"></div>
      <div id="dot5" class="progress-dot"></div>
    </div>

    <form id="factoryForm" onsubmit="return false;">

      <div id="step1" class="step-section active">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span> Organisation Setup
        </h2>

        <div class="space-y-5">
          <div>
            <label class="input-label">Organisation Name</label>
            <input type="text" id="orgName" class="input-field" placeholder="e.g. Acme Care Trust" required>
          </div>

          <div>
            <label class="input-label">App Icon / Logo</label>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center border overflow-hidden">
                <img id="logoPreview" class="w-full h-full object-cover hidden">
                <span id="logoPlaceholder" class="text-2xl">üñºÔ∏è</span>
              </div>
              <div>
                <input type="file" id="fLogo" class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="handleLogo(this)">
                <p class="text-xs text-slate-400 mt-1">Recommended: Square JPG/PNG, 512x512px.</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg">
             <div>
                <label class="input-label">Country Code</label>
                <input type="number" id="countryCode" class="input-field" value="64" placeholder="64">
                <p class="text-xs text-slate-400 mt-1">For phone formatting (e.g. 64 for NZ).</p>
             </div>
             <div>
                <label class="input-label">Timezone</label>
                <input type="text" id="timezone" class="input-field" value="Pacific/Auckland">
             </div>
          </div>

          <button onclick="nextStep(2)" class="btn-primary mt-2">Next: AI & Reporting &rarr;</button>
        </div>
      </div>

      <div id="step2" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span> Intelligence
        </h2>

        <div class="space-y-6">
          <div>
            <label class="input-label">Automated Reporting Frequency</label>
            <select id="statsFreq" class="input-field">
                <option value="MONTHLY" selected>Monthly (1st of Month)</option>
                <option value="WEEKLY">Weekly (Monday)</option>
                <option value="DAILY">Daily (Midnight)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">Determines when the 'Activity' and 'Travel' stats tabs are regenerated.</p>
          </div>

          <hr class="border-slate-100">

          <div>
            <div class="flex justify-between items-center">
              <label class="input-label">Enable "Smart Scribe" (AI Grammar)</label>
              <input type="checkbox" id="enableAi" class="w-5 h-5 text-blue-600" onchange="toggleAiUI()">
            </div>
            
            <div id="aiConfigBox" class="hidden mt-4 pl-4 border-l-2 border-blue-200">
               <label class="input-label">Google Gemini API Key</label>
               <input type="text" id="geminiKey" class="input-field mb-2" placeholder="AIzaSy...">
               
               <div onclick="toggleHelp('helpGemini')" class="help-link">Where do I get a free key?</div>
               <div id="helpGemini" class="help-box">
                  <strong>How to get a Free Gemini Key:</strong>
                  <ol class="list-decimal pl-5 mt-2 space-y-1">
                    <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline font-bold">Google AI Studio</a>.</li>
                    <li>Sign in with your Google Account.</li>
                    <li>Click <strong>"Create API Key"</strong>.</li>
                    <li>Copy the string starting with <code>AIza...</code> and paste it above.</li>
                  </ol>
                  <p class="mt-2 text-xs">Note: The free tier is sufficient for thousands of reports per day.</p>
               </div>

               <div class="bg-yellow-50 text-yellow-800 text-xs p-3 rounded mt-3 border border-yellow-100">
                 <strong>Privacy Note:</strong> We automatically redact Names, Emails, and Phone Numbers before sending notes to Google for grammar checking.
               </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="nextStep(1)" class="btn-secondary">Back</button>
            <button onclick="nextStep(3)" class="btn-primary">Next: Services &rarr;</button>
          </div>
        </div>
      </div>

      <div id="step3" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">3</span> External Services
        </h2>
        <p class="text-sm text-slate-500 mb-4">All keys are optional but recommended for full functionality.</p>

        <div class="space-y-5">
          
          <div>
            <label class="input-label">Master Secret Key (Auto-Generated)</label>
            <div class="flex gap-2">
               <input type="text" id="secretKey" class="input-field bg-slate-50" readonly>
               <button onclick="generateKey()" class="px-3 bg-slate-200 rounded hover:bg-slate-300">‚Üª</button>
            </div>
          </div>

          <div>
            <label class="input-label">OpenRouteService Key (For Maps/Mileage)</label>
            <input type="text" id="orsKey" class="input-field" placeholder="5b3ce...">
            <div onclick="toggleHelp('helpOrs')" class="help-link">How to get a Free Map Key</div>
            <div id="helpOrs" class="help-box">
                <ol class="list-decimal pl-5 space-y-1">
                    <li>Visit <a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="underline font-bold">OpenRouteService.org</a>.</li>
                    <li>Sign up (Standard Free Plan).</li>
                    <li>Go to Dashboard -> <strong>Request Token</strong>.</li>
                    <li>Select "Standard" and give it a name. Copy the long Key.</li>
                </ol>
            </div>
          </div>

          <div>
            <label class="input-label">TextBelt Key (For SMS Alerts)</label>
            <input type="text" id="textbeltKey" class="input-field" placeholder="textbelt_...">
            <div onclick="toggleHelp('helpSms')" class="help-link">SMS options</div>
            <div id="helpSms" class="help-box">
                <p><strong>Free Mode:</strong> Leave blank. The system will use the public 'textbelt' key (1 SMS per day only).</p>
                <p class="mt-2"><strong>Reliable Mode:</strong> Buy a key at <a href="https://textbelt.com/" target="_blank" class="underline font-bold">TextBelt.com</a> ($5 for ~70 texts). Recommended for live safety use.</p>
            </div>
          </div>

          <div>
            <label class="input-label">Google Drive Folder ID (For Photos)</label>
            <input type="text" id="folderId" class="input-field" placeholder="1vKz...">
            <div onclick="toggleHelp('helpDrive')" class="help-link">How to find your Folder ID</div>
            <div id="helpDrive" class="help-box">
                <ol class="list-decimal pl-5 space-y-1">
                    <li>Go to Google Drive and create a folder (e.g. "Safety Photos").</li>
                    <li><strong>Double-click</strong> to open the folder so it is empty on screen.</li>
                    <li>Look at the URL bar at the top of Chrome/Edge.</li>
                    <li>It will look like: <code>drive.google.com/drive/folders/<strong>1ABC-xyz...123</strong></code></li>
                    <li>Copy ONLY the code part after the last slash.</li>
                </ol>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button onclick="nextStep(2)" class="btn-secondary">Back</button>
            <button onclick="nextStep(4)" class="btn-primary">Next: Build &rarr;</button>
          </div>
        </div>
      </div>

      <div id="step4" class="step-section">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
          <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">4</span> System Assets
        </h2>
        
        <div id="autoLoadSection" class="text-center py-6">
            <div class="mb-4 text-slate-600">Scanning local directory for templates...</div>
            
            <div class="space-y-2 text-left max-w-md mx-auto">
                <div id="status_worker" class="file-status"><span>Worker App</span> <span class="status-badge status-pending">Searching...</span></div>
                <div id="status_monitor" class="file-status"><span>Monitor App</span> <span class="status-badge status-pending">Searching...</span></div>
                <div id="status_backend" class="file-status"><span>Backend Script</span> <span class="status-badge status-pending">Searching...</span></div>
                <div id="status_guide" class="file-status"><span>User Guide</span> <span class="status-badge status-pending">Searching...</span></div>
                <div id="status_manual" class="file-status"><span>Admin Manual</span> <span class="status-badge status-pending">Searching...</span></div>
            </div>

            <div id="manualUpload" class="hidden mt-6 pt-6 border-t border-slate-200">
                <p class="text-red-500 text-sm mb-2 font-bold">‚ö†Ô∏è Auto-load failed (Browser Security Restriction)</p>
                <p class="text-slate-500 text-xs mb-4">If running from a local file, please drag and drop the files here manually.</p>
                <div class="grid grid-cols-2 gap-2">
                    <input type="file" id="fManualUpload" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="handleManualUpload(this)">
                </div>
            </div>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="nextStep(3)" class="btn-secondary">Back</button>
            <button id="btnGenerate" onclick="generateApp()" class="btn-primary opacity-50 cursor-not-allowed" disabled>üöÄ DOWNLOAD SYSTEM</button>
        </div>
      </div>

      <div id="step5" class="step-section text-center py-10">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-slate-800">System Ready</h2>
        <p class="text-slate-500 mb-6">Your AppSuite ZIP has been generated.</p>
        
        <div class="bg-slate-800 text-slate-300 p-6 rounded text-left font-mono text-sm overflow-x-auto">
            1. Extract ZIP.<br>
            2. Create Google Sheet + Script.<br>
            3. Paste 'backend.js' code.<br>
            4. Deploy Web App (Exec: Me, Access: Anyone).<br>
            5. Copy URL -> Paste into Worker App Wizard.
        </div>
        <button onclick="location.reload()" class="mt-6 text-slate-400 underline hover:text-slate-600">Start Over</button>
      </div>

    </form>
  </div>

<script>
  let TEMPLATES = {
      'worker_template.html': null,
      'monitor_template.html': null,
      'backend_template.js': null,
      'guide_template.html': null,
      'ops_manual_template.html': null
  };
  
  window.onload = function() { generateKey(); };

  function toggleHelp(id) {
      const el = document.getElementById(id);
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
  }

  function toggleAiUI() {
      const chk = document.getElementById('enableAi');
      const box = document.getElementById('aiConfigBox');
      if(chk.checked) {
          box.classList.remove('hidden');
          document.getElementById('geminiKey').setAttribute('required','true');
      } else {
          box.classList.add('hidden');
          document.getElementById('geminiKey').removeAttribute('required');
      }
  }

  function generateKey() {
    const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let r = ''; for(let i=0;i<32;i++) r += c.charAt(Math.floor(Math.random()*c.length));
    document.getElementById('secretKey').value = r;
  }

  function nextStep(n) {
      document.querySelectorAll('.step-section').forEach(e => e.classList.remove('active'));
      document.getElementById('step'+n).classList.add('active');
      document.querySelectorAll('.progress-dot').forEach((d,i) => {
          if(i<n) d.classList.add('active'); else d.classList.remove('active');
      });
      
      if(n === 4) {
          attemptAutoLoad();
      }
  }

  function handleLogo(input) {
      if(input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
              TEMPLATES.logo = e.target.result;
              document.getElementById('logoPreview').src = e.target.result;
              document.getElementById('logoPreview').classList.remove('hidden');
              document.getElementById('logoPlaceholder').classList.add('hidden');
          }
          reader.readAsDataURL(input.files[0]);
      }
  }

  // AUTO-LOAD LOGIC
  async function attemptAutoLoad() {
      const files = [
          {id: 'worker', file: 'worker_template.html'},
          {id: 'monitor', file: 'monitor_template.html'},
          {id: 'backend', file: 'backend_template.js'},
          {id: 'guide', file: 'guide_template.html'},
          {id: 'manual', file: 'ops_manual_template.html'}
      ];

      let successCount = 0;

      for (let item of files) {
          const badge = document.querySelector(`#status_${item.id} .status-badge`);
          try {
              const response = await fetch('./' + item.file);
              if (!response.ok) throw new Error("404");
              const text = await response.text();
              TEMPLATES[item.file] = text;
              
              badge.className = "status-badge status-ok";
              badge.innerText = "LOADED";
              successCount++;
          } catch (e) {
              console.warn("Fetch failed for " + item.file, e);
              badge.className = "status-badge status-err";
              badge.innerText = "NOT FOUND";
          }
      }

      checkReady(successCount === 5);
  }

  function checkReady(isAutoSuccess) {
      const btn = document.getElementById('btnGenerate');
      if (isAutoSuccess) {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          document.getElementById('manualUpload').classList.add('hidden');
      } else {
          // Show fallback if any failed
          document.getElementById('manualUpload').classList.remove('hidden');
          
          // Check if manual upload has filled the gaps
          const allLoaded = Object.values(TEMPLATES).every(v => v !== null);
          if(allLoaded) {
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
      }
  }

  function handleManualUpload(input) {
      // Allow user to drag all files at once
      Array.from(input.files).forEach(file => {
          const name = file.name;
          if(TEMPLATES.hasOwnProperty(name)) {
              const reader = new FileReader();
              reader.onload = function(e) {
                  TEMPLATES[name] = e.target.result;
                  // Visual Update
                  let id = "";
                  if(name.includes('worker')) id = 'worker';
                  else if(name.includes('monitor')) id = 'monitor';
                  else if(name.includes('backend')) id = 'backend';
                  else if(name.includes('guide')) id = 'guide';
                  else if(name.includes('manual')) id = 'manual';
                  
                  const badge = document.querySelector(`#status_${id} .status-badge`);
                  if(badge) {
                      badge.className = "status-badge status-ok";
                      badge.innerText = "UPLOADED";
                  }
                  
                  // Re-check readiness
                  const allLoaded = Object.values(TEMPLATES).every(v => v !== null);
                  if(allLoaded) checkReady(true);
              };
              reader.readAsText(file);
          }
      });
  }

  async function generateApp() {
      const zip = new JSZip();
      const workerKey = "W_" + Math.random().toString(36).substr(2, 9);
      
      const C = {
          ORG: document.getElementById('orgName').value,
          SECRET: document.getElementById('secretKey').value,
          WORKER_KEY: workerKey,
          ORS: document.getElementById('orsKey').value || "",
          GEMINI: document.getElementById('geminiKey').value || "",
          TEXTBELT: document.getElementById('textbeltKey').value || "",
          FOLDER: document.getElementById('folderId').value || "",
          ENABLE_AI: document.getElementById('enableAi').checked ? "true" : "false",
          COUNTRY: document.getElementById('countryCode').value || "64",
          TIMEZONE: document.getElementById('timezone').value || "Pacific/Auckland",
          STATS_FREQ: document.getElementById('statsFreq').value || "MONTHLY",
          LOGO: TEMPLATES.logo || "" 
      };

      // Backend
      let backendCode = TEMPLATES['backend_template.js']
          .replace(/%%SECRET_KEY%%/g, C.SECRET)
          .replace(/%%WORKER_KEY%%/g, C.WORKER_KEY)
          .replace(/%%ORS_API_KEY%%/g, C.ORS)
          .replace(/%%GEMINI_API_KEY%%/g, C.GEMINI)
          .replace(/%%TEXTBELT_API_KEY%%/g, C.TEXTBELT)
          .replace(/%%PHOTOS_FOLDER_ID%%/g, C.FOLDER)
          .replace(/%%ORGANISATION_NAME%%/g, C.ORG)
          .replace(/%%TIMEZONE%%/g, C.TIMEZONE)
          .replace(/%%COUNTRY_CODE%%/g, C.COUNTRY)
          .replace(/%%STATS_FREQ%%/g, C.STATS_FREQ)
          .replace(/%%ESCALATION_MINUTES%%/g, "60")
          .replace(/%%ENABLE_AI%%/g, C.ENABLE_AI);
      zip.file("backend.js", backendCode);

      // Worker
      let wHtml = TEMPLATES['worker_template.html']
          .replace(/%%ORG_NAME%%/g, C.ORG)
          .replace(/%%COUNTRY_CODE%%/g, C.COUNTRY)
          .replace(/%%LOGO_DATA%%/g, C.LOGO);
          
      // Monitor
      let mHtml = TEMPLATES['monitor_template.html']
          .replace(/%%ORG_NAME%%/g, C.ORG)
          .replace(/%%LOGO_URL%%/g, C.LOGO);

      // Docs
      let gHtml = TEMPLATES['guide_template.html']
          .replace(/%%ORG_NAME%%/g, C.ORG)
          .replace(/%%CHECKIN_INTERVAL%%/g, "60");
      let opHtml = TEMPLATES['ops_manual_template.html']
          .replace(/%%ORG_NAME%%/g, C.ORG)
          .replace(/%%SECRET_KEY%%/g, C.SECRET)
          .replace(/%%WORKER_KEY%%/g, C.WORKER_KEY);

      // SW
      const swCode = `const CACHE_NAME='otg-v78';const u=['./','./index.html','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(u)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>{return r||fetch(e.request)}))});`;

      const manifest = {
          name: C.ORG, short_name: "Safety", start_url: "./index.html", display: "standalone", background_color: "#111827", theme_color: "#1e40af",
          icons: [{src: "icon.png", sizes: "192x192", type: "image/png"}, {src: "icon.png", sizes: "512x512", type: "image/png"}]
      };

      const wf = zip.folder("WorkerApp");
      wf.file("index.html", wHtml);
      wf.file("sw.js", swCode);
      wf.file("manifest.json", JSON.stringify(manifest));
      wf.file("USER_GUIDE.html", gHtml);
      if(C.LOGO) wf.file("icon.png", C.LOGO.split(',')[1], {base64: true});

      zip.folder("MonitorApp").file("index.html", mHtml);
      zip.file("ADMIN_MANUAL.html", opHtml);

      zip.generateAsync({type:"blob"}).then(c => {
          const l = document.createElement("a");
          l.href = URL.createObjectURL(c);
          l.download = `OTG_AppSuite_${C.ORG.replace(/\s+/g,'_')}.zip`;
          l.click();
          nextStep(5);
      });
  }
</script>
</body>
</html>
