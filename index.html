<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v77.4 (User Friendly)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; }
    
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .drop-zone.dragover { border-color: #3b82f6; background: #1e293b; }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    
    /* Checklist Styling */
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .checklist-item:hover { background: #475569; }
    .checklist-item.checked { background: #064e3b; border-color: #059669; }
    .checklist-checkbox { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps (especially iOS). Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="modal-backdrop">
      <div class="modal-content border-blue-500">
          <h2 class="text-xl font-bold text-white mb-4">üìÇ How to get a Drive Folder ID</h2>
          <ol class="list-decimal pl-5 space-y-3 text-gray-300 text-sm mb-6">
              <li>Open Google Drive in your browser.</li>
              <li>Create a new folder (e.g., "Safety Photos").</li>
              <li>Double-click to open the folder.</li>
              <li>Look at the URL bar at the top of your browser.</li>
              <li>Copy the random string of letters/numbers AFTER <code>folders/</code>.</li>
          </ol>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all">
              drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong>
          </div>
          <button onclick="closeModal('driveHelpModal')" class="w-full py-2 bg-blue-600 text-white font-bold rounded">Got it</button>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v77.4 (User Friendly)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Cloud System</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Secret Key (Admin Password)</label>
                  <div class="flex gap-2">
                      <input type="text" id="secretKey" class="input-field text-yellow-400 font-mono tracking-wider" placeholder="Generating..." oninput="saveInput(this); validateKey();">
                      <button onclick="generateMemorableKey()" class="btn bg-gray-700 hover:bg-gray-600 text-white" title="Generate New Key">üîÑ</button>
                  </div>
                  <p id="keyStrength" class="text-xs mt-2 font-bold text-green-400">‚úÖ Strength: Good (Memorable)</p>
                  <p class="text-[10px] text-gray-500 mt-1">Tip: You can change this to your own password (min 8 chars).</p>
              </div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Region / Country</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option>
                      <option value="+61">Australia (+61)</option>
                      <option value="+44">United Kingdom (+44)</option>
                      <option value="+1">USA / Canada (+1)</option>
                      <option value="">Other (Universal)</option>
                  </select>
                  <div class="mt-2 bg-gray-900 p-3 rounded text-xs text-gray-400 grid grid-cols-2 gap-2">
                      <p>Timezone: <span id="detectedTz" class="text-blue-400 font-mono">Loading...</span></p>
                      <p>Term: <span id="vehTermDisplay" class="text-green-400 font-mono">WOF</span></p>
                      <p>Format: <span id="phoneFmtDisplay" class="text-purple-400 font-mono">+64...</span></p>
                      <p>Voice: <span id="voiceLocaleDisplay" class="text-yellow-400 font-mono">en-NZ</span></p>
                  </div>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">App Logo</label>
              <div id="dropZone" class="drop-zone w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto rounded-full flex items-center justify-center overflow-hidden">
                    <img id="logoImg" class="hidden h-full w-full object-cover">
                    <span id="logoText" class="text-gray-500 text-sm">Drag & Drop<br>Logo Here</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <input type="hidden" id="logoUrl" oninput="saveInput(this)">
            </div>
          </div>

          <div class="highlight-box border-blue-500/30">
             <h3 class="text-xl font-bold text-white mb-4">Safety & Fleet Options</h3>
             <div class="grid md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Escalation Delay (Minutes)</label>
                    <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)">
                    <span class="text-xs text-gray-400 block mt-1">Time allowed after "Overdue" before RED ALERT.</span>
                 </div>
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Check-in Interval</label>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="chkCheckin" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleCheckin(); saveInput(this)">
                        <span class="text-sm font-bold text-gray-300">Enable?</span>
                        <div id="checkinOptions" class="hidden flex items-center gap-2 ml-2">
                            <input type="number" id="checkinMins" value="60" min="5" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-24 text-center font-bold" oninput="saveInput(this)">
                            <span class="text-xs text-gray-400">mins</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">Nags worker to press "I'm OK" periodically. Only use for high-risk lone work.</p>
                 </div>
             </div>

             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkVehicle" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleVehicle(); saveInput(this)" checked>
                    <span class="text-white font-bold">Enable Vehicle Safety Checks?</span>
                </label>
                <div id="vehOptions" class="pl-8 mt-2 text-sm text-gray-400">
                    <div class="flex items-center gap-2 mb-2">
                        <span>Check Frequency (Days):</span>
                        <input type="number" id="vehFreq" value="120" class="bg-gray-800 border border-gray-600 rounded p-1 w-16 text-center text-white font-bold" oninput="saveInput(this)">
                    </div>
                    <p class="text-xs text-gray-500">Includes Expiry Reminders (starts 14 days prior).</p>
                </div>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkTravelReport" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="saveInput(this)" checked>
                    <span class="text-white font-bold">Default: Require Form on Travel Finish?</span>
                </label>
                <p class="pl-8 mt-1 text-xs text-gray-500">Sets the default. Workers can still toggle this per-trip in the app settings.</p>
             </div>

             <div class="mt-4 pt-4 border-t border-gray-600">
                <h4 class="text-sm font-bold text-purple-400 mb-2">Privacy & AI Redaction</h4>
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="chkRedaction" class="mt-1 w-5 h-5 rounded bg-gray-700 text-purple-600" onchange="saveInput(this)" checked>
                    <div>
                        <span class="text-white font-bold">Redact Personal Info before AI Check?</span>
                        <p class="text-xs text-gray-500 mt-1">Attempts to remove Emails and Phone Numbers before sending text to Gemini.</p>
                        <p class="text-[10px] text-red-400 mt-1 font-bold">NOTE: The Free Tier of Gemini is NOT private. Data may be used for training. Always redact PII.</p>
                    </div>
                </label>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600 grid md:grid-cols-2 gap-4">
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Textbelt Key</label><a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional (Buy key for Non-US/Global)" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Gemini AI Key</label><a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a></div><input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For AI Reporting" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">ORS Key</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Road Mileage" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Drive Folder ID</label><span onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link cursor-pointer">Where is this?</span></div><input type="text" id="folderId" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Photos" oninput="saveInput(this)"></div>
             </div>
          </div>
          <div class="flex justify-end"><button onclick="gotoStep(2)" class="btn btn-primary text-lg">Next: Database ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
          
          <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-8 rounded-2xl border border-blue-500 shadow-xl text-center">
              <h2 class="text-3xl font-bold text-white mb-2">Option A: The Easy Way (Recommended)</h2>
              
              <div class="bg-yellow-900/50 border-l-4 border-yellow-500 p-4 mb-6 text-left max-w-2xl mx-auto rounded-r">
                  <p class="font-bold text-yellow-300 text-sm flex items-center gap-2">‚ö†Ô∏è BEST PRACTICE:</p>
                  <p class="text-gray-300 text-xs mt-1">We <strong>strongly recommend</strong> creating a new, dedicated Google Account (e.g. <code>safety.yourcompany@gmail.com</code>) to own this system. Do not use your personal Gmail.</p>
                  <p class="text-gray-400 text-xs mt-1">Sign into that account now before clicking the button below.</p>
              </div>

              <p class="text-blue-200 mb-6">Create your database automatically in one click.</p>
              <button onclick="openMagicLink()" class="btn btn-success text-xl px-10 py-5 shadow-lg transform hover:-translate-y-1 hover:shadow-2xl">
                  ‚ú® Create Database Copy
              </button>
              <p id="magicLinkError" class="hidden text-red-400 text-sm mt-4 font-bold bg-red-900/50 p-2 rounded">‚ö†Ô∏è Admin: Please configure MASTER_SHEET_URL in index.html</p>
          </div>

          <div class="border border-gray-700 rounded-xl p-4">
              <button onclick="document.getElementById('manualSetup').classList.toggle('hidden')" class="w-full flex justify-between items-center text-gray-400 hover:text-white font-bold">
                  <span>Option B: The Manual Way (Advanced)</span>
                  <span>‚ñº</span>
              </button>
              
              <div id="manualSetup" class="hidden mt-6 space-y-6">
                  <div class="text-center">
                      <a href="https://sheets.new" target="_blank" class="btn bg-gray-700 hover:bg-gray-600 text-white">1. Create Blank Sheet</a>
                  </div>
                  <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                        <h3 class="font-bold text-blue-400">A. Setup 'Visits' Tab</h3>
                        <button onclick="copyVisitsHeaders()" class="btn-xs bg-blue-700 text-white px-3 py-1 rounded mt-2 text-xs">Copy Headers</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                        <h3 class="font-bold text-purple-400">B. Setup 'Templates' Tab</h3>
                        <button onclick="copyTemplatesSetup()" class="btn-xs bg-purple-700 text-white px-3 py-1 rounded mt-2 text-xs">Copy Data</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                        <h3 class="font-bold text-green-400">C. Setup 'Sites' Tab</h3>
                        <button onclick="copySitesSetup()" class="btn-xs bg-green-700 text-white px-3 py-1 rounded mt-2 text-xs">Copy Data</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                        <h3 class="font-bold text-red-400">D. Setup 'Staff' Tab</h3>
                        <button onclick="copyStaffSetup()" class="btn-xs bg-red-800 text-white px-3 py-1 rounded mt-2 text-xs">Copy Data</button>
                    </div>
                  </div>
              </div>
          </div>

          <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(3)" class="btn btn-primary text-lg">Next: Cloud System ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
             <h3 class="font-bold text-green-400 text-lg">1. Install System Code</h3>
             <div class="flex items-center gap-4">
                 <button onclick="copyScript()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex-1">üìã COPY SCRIPT TO CLIPBOARD</button>
                 <button onclick="document.getElementById('codeContainer').classList.toggle('hidden')" class="text-xs text-gray-500 underline">Show Source Code (Advanced)</button>
             </div>
             <div id="codeContainer" class="hidden relative mt-2">
                <pre id="codeDisplay" class="code-scroll h-48">Generating code...</pre>
             </div>
             <div class="text-sm text-gray-300 bg-gray-800 p-4 rounded mt-4">
                 <p class="font-bold mb-2">Instructions:</p>
                 <ol class="list-decimal pl-5 space-y-1">
                    <li>Go to your Google Sheet. Click <strong>Extensions > Apps Script</strong>.</li>
                    <li>Delete any code there. <strong>Paste</strong> the code you just copied.</li>
                    <li>Click the <strong>Save</strong> (Disk) icon.</li>
                 </ol>
             </div>
          </div>

          <div class="bg-gray-900 p-6 rounded-xl border border-purple-600/50 space-y-4">
             <div class="flex items-center gap-3">
                 <span class="text-2xl">‚è∞</span>
                 <div>
                     <h3 class="font-bold text-purple-400 text-lg">2. Wake Up The System</h3>
                     <p class="text-xs text-gray-400">You must set a "Watchdog" timer, or safety alarms will not fire automatically.</p>
                 </div>
             </div>
             <div class="space-y-2">
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">In Apps Script, click the <strong>Clock Icon</strong> (Triggers) on the left.</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">Click <strong>+ Add Trigger</strong> (Blue button).</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">Set Function to: <strong>checkOverdueVisits</strong>.</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">Set Event Source: <strong>Time-driven</strong> -> <strong>Minutes timer</strong>.</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">Set Interval: <strong>Every 10 minutes</strong> -> Click Save.</span>
                 </div>
             </div>
          </div>

          <div class="bg-gray-900 p-6 rounded-xl border border-gray-600 space-y-4">
             <h3 class="font-bold text-yellow-400 text-lg">3. Publish to Web</h3>
             <p class="text-xs text-gray-400 mb-2">Tick off each task as you complete it:</p>
             <div class="space-y-2">
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">I clicked <strong>Deploy > New Deployment</strong>.</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">I selected type: <strong>Web App</strong>.</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">I selected "Execute as: <strong>Me</strong>".</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this)">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm font-bold text-yellow-300">CRITICAL: I set "Who has access" to "Anyone".</span>
                 </div>
                 <div class="checklist-item" onclick="toggleCheck(this); showUrlInput()">
                     <input type="checkbox" class="checklist-checkbox">
                     <span class="text-sm">I clicked Deploy and copied the <strong>Web App URL</strong>.</span>
                 </div>
             </div>
             
             <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded text-xs text-gray-300 mt-2">
                 <p class="font-bold text-blue-300 mb-1">‚ÑπÔ∏è Permission Help:</p>
                 <p>Google will ask for permission since you just created this script.</p>
                 <ul class="list-disc pl-4 mt-1 space-y-1">
                     <li>Click <strong>Review Permissions</strong> -> Choose Account.</li>
                     <li>If you see "Google hasn't verified this app":</li>
                     <li>Click <strong>Advanced</strong> (small text) -> <strong>Go to ... (unsafe)</strong>.</li>
                     <li>Type "Continue" if asked. This is normal for custom apps.</li>
                 </ul>
             </div>
          </div>

          <div id="urlInputSection" class="hidden opacity-0 transition-opacity duration-500">
              <label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste Web App URL:</label>
              <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)">
              
              <div class="flex justify-center gap-4 mt-6">
                  <button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">üì° Test Connection</button>
              </div>
              
              <div id="testResult" class="hidden mt-4 p-4 rounded-lg text-center"></div>
              <div id="troubleshooter" class="hidden bg-red-900/30 border border-red-500/50 p-4 rounded-lg mt-4 text-left">
                  <h4 class="font-bold text-red-400 mb-2">‚ùå Connection Failed. Check these common issues:</h4>
                  <ul class="list-disc pl-5 text-sm text-gray-300 space-y-1">
                      <li>Did you set <strong>"Who has access"</strong> to <strong>"Anyone"</strong>? (Most common error)</li>
                      <li>Did you copy the URL ending in <code>/exec</code> (not <code>/dev</code>)?</li>
                      <li>Did you click <strong>"New Deployment"</strong> (not Manage Deployments)?</li>
                  </ul>
              </div>
          </div>

          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div><h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2><p class="text-gray-400">Files generated for: <span id="finalAppName" class="text-blue-400">App</span></p></div>
          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">Download On-The-Go_Lone_Worker_Apps.zip</button>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">üöÄ</span><div><h2 class="text-2xl font-bold text-white">1. Host with Netlify (Free)</h2></div></div>
                
                <div class="bg-orange-900/50 border border-orange-500 p-4 rounded mb-6">
                    <h4 class="font-bold text-orange-400 mb-1">‚ö†Ô∏è DON'T LOSE YOUR APP!</h4>
                    <p class="text-sm text-gray-300">If you just drag-and-drop without an account, your app will <strong>delete itself after 1 hour</strong>.</p>
                    <p class="text-sm text-white font-bold mt-2">‚úÖ YOU MUST CLICK "SIGN UP TO CLAIM SITE" ON NETLIFY.</p>
                </div>

                <ol class="list-decimal pl-6 space-y-4 text-sm text-gray-300">
                    <li>Go to <a href="https://app.netlify.com/drop" target="_blank" class="text-blue-400 underline font-bold">app.netlify.com/drop</a>.</li>
                    <li>Drag the <strong>WorkerApp</strong> folder from your ZIP into the browser.</li>
                    <li><strong>IMMEDIATELY</strong> click "Sign up to claim this site". It is free (Starter plan).</li>
                    <li>Click <strong>Site Settings > Change Site Name</strong> to something friendly (e.g. <code>my-org-safety.netlify.app</code>).</li>
                    <li>Repeat for the <strong>MonitorApp</strong> folder if needed.</li>
                </ol>
            </div>

            <div class="bg-indigo-900/30 p-8 rounded-xl border border-indigo-500/50">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">‚úâÔ∏è</span><div><h2 class="text-2xl font-bold text-white">2. Launch to Workers</h2></div></div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-indigo-300 text-xs font-bold uppercase mb-1">Paste your Worker App URL (from Netlify)</label>
                        <input type="url" id="workerAppUrl" class="input-field" placeholder="https://my-safety-app.netlify.app" oninput="generateLaunchEmail()">
                    </div>
                    
                    <div id="emailDraftBox" class="hidden">
                        <label class="block text-indigo-300 text-xs font-bold uppercase mb-1">Draft Email</label>
                        <textarea id="launchEmail" class="w-full h-64 bg-gray-900 border border-indigo-500/50 rounded p-4 text-sm text-gray-300 font-mono" readonly></textarea>
                        <button onclick="navigator.clipboard.writeText(document.getElementById('launchEmail').value); alert('Email copied!');" class="mt-2 btn bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Copy Email Text</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ADMIN CONFIG: PASTE YOUR MASTER SHEET URL HERE
    // Example: "https://docs.google.com/spreadsheets/d/1abc.../copy"
    const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1QtcQVe0Ppl-mQbN4MOEp2RgncnHv1jyphKB4vCBPe4g/copy"; 

    const FILES = { worker: 'worker_template.html', monitor: 'monitor_template.html', backend: 'backend_template.js', guide: 'guide_template.html', manual: 'ops_manual_template.html' };
    let TEMPLATES = {};
    const workerKey = "wk_" + Math.random().toString(36).substr(2, 9); 

    const AI_GUIDE_TEXT = `AI REPORTING GUIDE
==================
Use this guide to ask Gemini or ChatGPT to write custom report scripts for you.
... (Same as before) ...
`;

    // REGIONAL CONFIG (v77.1 Preserved)
    const REGION_DATA = {
        "+64": { name: "New Zealand", term: "WOF", locale: "en-NZ", tz: "Pacific/Auckland" },
        "+61": { name: "Australia", term: "Rego", locale: "en-AU", tz: "Australia/Sydney" },
        "+44": { name: "United Kingdom", term: "Inspection", locale: "en-GB", tz: "Europe/London" },
        "+1":  { name: "USA / Canada", term: "Inspection", locale: "en-US", tz: "America/New_York" },
        "":    { name: "Universal", term: "Inspection", locale: "en-US", tz: "UTC" }
    };
    let selectedConfig = REGION_DATA["+64"]; 

    window.onload = async () => { 
        loadPersistedData(); 
        if(!document.getElementById('secretKey').value) generateMemorableKey();
        updateRegionInfo(); 
        setupDragDrop(); 
        for (const [k, f] of Object.entries(FILES)) {
            try { const r = await fetch(f); if (r.ok) TEMPLATES[k] = await r.text(); } catch(e){}
        }
    };

    function generateLaunchEmail() {
        const url = document.getElementById('workerAppUrl').value;
        if(url.length < 10) return;
        const org = document.getElementById('orgName').value;
        const term = selectedConfig.term;
        
        const email = `SUBJECT: IMPORTANT: New Safety App for ${org} Staff

Hi Team,

We are launching a new Lone Worker Safety System to keep you safe while on site. 
Please install the app on your phone immediately.

INSTALLATION STEPS:
1. Click this link: ${url}
2. Important: You must "Add to Home Screen" to make it work offline.
   - iPhone: Tap 'Share' (Square with arrow) > Scroll down > "Add to Home Screen".
   - Android: Tap 'Menu' (3 dots) > "Install App" or "Add to Home Screen".

HOW TO USE:
- Open the app when you arrive at a site.
- Set your estimated duration.
- Tap "HOLD TO START".
- If you go overtime, the app will alert us automatically.
- Remember to update your ${term} status via the app if prompted.

PRIVACY NOTE:
The app only tracks your GPS while a visit timer is running. It does not track you off the clock.

If you have issues, please reply to this email.

Thanks,
Management`;
        
        document.getElementById('launchEmail').value = email;
        document.getElementById('emailDraftBox').classList.remove('hidden');
    }

    function saveInput(el) { 
        if(el.type === 'checkbox') localStorage.setItem('otg_' + el.id, el.checked);
        else localStorage.setItem('otg_' + el.id, el.value); 
    }
    
    // NEW: Memorable Key Generator
    function generateMemorableKey() {
        const adjs = ['Safe','Swift','Blue','Red','Gold','Green','Bright','Firm','Iron','Steel'];
        const nouns = ['Guard','Watch','Shield','Falcon','Eagle','Hawk','Post','Base','Fort','Gate'];
        const num = Math.floor(Math.random() * 90) + 10;
        const key = `${adjs[Math.floor(Math.random()*adjs.length)]}-${nouns[Math.floor(Math.random()*nouns.length)]}-${num}`;
        document.getElementById('secretKey').value = key;
        saveInput(document.getElementById('secretKey'));
        validateKey();
    }
    
    function validateKey() {
        const k = document.getElementById('secretKey').value;
        const el = document.getElementById('keyStrength');
        if(k.length < 8) {
            el.innerText = "‚ö†Ô∏è Strength: Weak (Too Short)";
            el.className = "text-xs mt-2 font-bold text-red-400";
        } else {
            el.innerText = "‚úÖ Strength: Good";
            el.className = "text-xs mt-2 font-bold text-green-400";
        }
    }

    function openMagicLink() {
        if(MASTER_SHEET_URL && MASTER_SHEET_URL.length > 5) {
            window.open(MASTER_SHEET_URL, '_blank');
        } else {
            document.getElementById('magicLinkError').classList.remove('hidden');
        }
    }

    function toggleCheck(el) {
        el.classList.toggle('checked');
        el.querySelector('input').checked = el.classList.contains('checked');
    }
    
    function showUrlInput() {
        const inputs = document.querySelectorAll('.checklist-checkbox');
        // Check if all 5 are checked (v77.4 has 5 items now)
        if(Array.from(inputs).every(i => i.checked)) {
            const sec = document.getElementById('urlInputSection');
            sec.classList.remove('hidden');
            setTimeout(() => sec.classList.remove('opacity-0'), 100);
        }
    }

    function loadPersistedData() { 
        const ids = ['orgName', 'secretKey', 'webAppUrl', 'geminiKey', 'orsKey', 'textbeltKey', 'folderId', 'escalationMins', 'checkinMins', 'vehFreq', 'countrySelect']; 
        ids.forEach(id => { const v = localStorage.getItem('otg_' + id); if(v) document.getElementById(id).value = v; }); 
        const checks = ['chkTravelReport', 'chkRedaction', 'chkVehicle', 'chkCheckin'];
        checks.forEach(id => {
            const v = localStorage.getItem('otg_' + id);
            if(v !== null) document.getElementById(id).checked = (v === 'true');
        });
    }

    function updateRegionInfo() {
        const sel = document.getElementById('countrySelect').value;
        selectedConfig = REGION_DATA[sel] || REGION_DATA[""];
        document.getElementById('detectedTz').textContent = selectedConfig.tz;
        document.getElementById('timezoneVal').value = selectedConfig.tz;
        document.getElementById('vehTermDisplay').textContent = selectedConfig.term;
        document.getElementById('phoneFmtDisplay').textContent = sel + "...";
        document.getElementById('voiceLocaleDisplay').textContent = selectedConfig.locale;
        saveInput(document.getElementById('countrySelect'));
    }

    function toggleEnterBtn() { 
        const btn = document.getElementById('btnEnter');
        const chk = document.getElementById('chkAccept');
        btn.disabled = !chk.checked;
        if(chk.checked) {
            btn.classList.remove('bg-gray-700', 'text-gray-500');
            btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
        } else {
            btn.classList.add('bg-gray-700', 'text-gray-500');
            btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-500');
        }
    }
    
    function closeModal(id) { document.getElementById(id).style.display='none'; if(id==='disclaimerModal') document.getElementById('mainContent').classList.remove('blur-sm'); }

    function setupDragDrop() {
        const dz = document.getElementById('dropZone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('border-blue-500'); });
        dz.addEventListener('dragleave', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); });
        dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('border-blue-500'); if (e.dataTransfer.files.length) handleLogo({files:e.dataTransfer.files}); });
    }
    function handleLogo(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 192, 192);
                    const data = canvas.toDataURL('image/png');
                    document.getElementById('logoImg').src = data; document.getElementById('logoImg').classList.remove('hidden'); document.getElementById('logoText').textContent = "‚úÖ Logo Ready";
                    document.getElementById('logoUrl').value = data; saveInput(document.getElementById('logoUrl'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function gotoStep(n) { 
        document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active')); 
        document.getElementById('step'+n).classList.add('active'); 
        for(let i=1; i<=5; i++){ 
            const tab = document.getElementById('tab'+i); 
            if(i===n){ tab.classList.add('active'); 
                if(n===3) generateScript(); // Force Generation on Tab Click
            } else { tab.classList.remove('active'); } 
        } 
    }
    
    function toggleCheckin() { document.getElementById('checkinOptions').style.display = document.getElementById('chkCheckin').checked ? 'flex' : 'none'; }
    function toggleVehicle() { document.getElementById('vehOptions').style.display = document.getElementById('chkVehicle').checked ? 'block' : 'none'; }
    function copyVisitsHeaders() { navigator.clipboard.writeText("Timestamp\tDate\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tLast Known GPS\tGPS Timestamp\tBattery Level\tPhoto 1\tDistance (km)\tVisit Report Data\tAnticipated Departure Time\tSignature\tPhoto 2\tPhoto 3\tPhoto 4"); alert("Copied!"); }
    function copyTemplatesSetup() { navigator.clipboard.writeText("Type\tTemplate Name\tAssigned To (Worker Names or ALL)\tEmail Recipient\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\nFORM\tAccident Report\tALL\tsafety@org.com\t[HEADING] Incident Details\t[TEXT] What happened?\t[PHOTO] Evidence\t[SIGN] Signature\nREPORT\tStandard Visit\t\t\t[TEXT] Visit Notes\t[PHOTO] Site Photo\t[YESNO] Hazards Identified?\nREPORT\tVehicle Safety Check\tALL\t\t[TEXT] Registration Plate\t[YESNO] Current Rego & WOF?\t[DATE] WOF Expiry\t[GPS] Inspection Location\t[HEADING] Tyres\t[TEXT] Tread Depth (New/Good/Low)\t[PHOTO] Tread Photo\t[TEXT] Tyre Pressures (PSI)\t[HEADING] Under Hood\t[YESNO] Oil Level OK?\t[PHOTO] Oil Level\t[YESNO] Coolant/Water OK?\t[PHOTO] Coolant Level\t[YESNO] Brake Fluid OK?\t[PHOTO] Brake Fluid\nREPORT\tTravel Report\tALL\t\t[NUMBER] Distance (km)\t[TEXT] Trip Details\t[PHOTO] Odometer Photo"); alert("Copied Setup + Guide!"); }
    function copySitesSetup() { navigator.clipboard.writeText("Assigned To\tTemplate Name\tCompany Name\tSite Name\tAddress\tContact Name\tContact Phone\tContact Email\tSite Notes\nALL\tStandard Visit\tAcme Corp\tHead Office\t123 Main St\tSteve\t021123456\tsteve@acme.com\tGate Code: 4455"); alert("Copied Setup + Guide!"); }
    function copyStaffSetup() { navigator.clipboard.writeText("Name\tRole\tStatus\tToken\tDeviceID\tLastVehCheck\tWOFExpiry\nJohn Doe\tDriver\tActive\t\t\t\t"); alert("Copied Setup + Guide!"); }
    function copyReportGuide() { navigator.clipboard.writeText(AI_GUIDE_TEXT); alert("AI Guide Copied!"); }

    function generateScript() {
        if(!TEMPLATES.backend) { setTimeout(generateScript, 500); return; } 
        const code = TEMPLATES.backend
            .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
            .replace(/%%WORKER_KEY%%/g, workerKey)
            .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
            .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value)
            .replace('%%TEXTBELT_API_KEY%%', document.getElementById('textbeltKey').value)
            .replace('%%PHOTOS_FOLDER_ID%%', document.getElementById('folderId').value)
            .replace('%%ORGANISATION_NAME%%', document.getElementById('orgName').value)
            .replace('%%TIMEZONE%%', document.getElementById('timezoneVal').value || "Pacific/Auckland")
            .replace('%%ESCALATION_MINUTES%%', document.getElementById('escalationMins').value)
            .replace('%%ENABLE_REDACTION%%', document.getElementById('chkRedaction').checked)
            .replace('%%VEHICLE_TERM%%', selectedConfig.term);
        document.getElementById('codeDisplay').textContent = code;
        gotoStep(3); 
    }
    // FIXED COPY SCRIPT LOGIC (v77.2.3)
    function copyScript() { 
        const display = document.getElementById('codeDisplay');
        if(display.textContent === "Generating code...") generateScript();
        
        // Slight delay to allow generation
        setTimeout(() => {
            navigator.clipboard.writeText(display.textContent); 
            const btn = document.querySelector('button[onclick="copyScript()"]');
            const originalText = btn.innerText;
            btn.innerText = "‚úÖ COPIED!";
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600');
            }, 2000);
        }, 100);
    }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const resBox = document.getElementById('testResult');
        const trouble = document.getElementById('troubleshooter');
        
        resBox.classList.remove('hidden');
        resBox.textContent = "Testing...";
        resBox.className = "mt-4 p-4 rounded-lg text-center bg-gray-900 text-yellow-400 font-bold";
        trouble.classList.add('hidden');

        if(!url.includes('/exec')) { 
            resBox.textContent = "‚ùå Invalid URL. Must end in /exec"; 
            resBox.className = "mt-4 p-4 rounded-lg text-center bg-red-900 text-white font-bold";
            trouble.classList.remove('hidden');
            return; 
        }
        
        fetch(url + '?test=1&key=' + encodeURIComponent(document.getElementById('secretKey').value))
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                  resBox.textContent = "‚úÖ Success! System Online.";
                  resBox.className = "mt-4 p-4 rounded-lg text-center bg-green-900 text-white font-bold";
                  document.getElementById('btnNextDownload').disabled = false; document.getElementById('btnNextDownload').classList.remove('opacity-50', 'cursor-not-allowed');
                  document.getElementById('finalAppName').innerText = document.getElementById('orgName').value;
                } else throw new Error();
            }).catch(() => { 
                resBox.textContent = "‚ùå Connection Failed.";
                resBox.className = "mt-4 p-4 rounded-lg text-center bg-red-900 text-white font-bold";
                trouble.classList.remove('hidden');
            });
    }

    function processGuideTemplate(html) {
        if(!html) return "";
        let out = html;
        const org = document.getElementById('orgName').value;
        const esc = document.getElementById('escalationMins').value;
        const chkInt = document.getElementById('checkinMins').value;
        const vehInt = document.getElementById('vehFreq').value;
        out = out.replace(/%%ORG_NAME%%/g, org).replace(/%%ESCALATION_MINUTES%%/g, esc).replace(/%%CHECKIN_INTERVAL%%/g, chkInt).replace(/%%VEHICLE_INTERVAL%%/g, vehInt);
        const processBlock = (tag, isActive) => {
            const regex = new RegExp(`([\\s\\S]*?)`, 'g');
            out = out.replace(regex, (match, content) => isActive ? content : "");
        };
        processBlock('VEHICLE', document.getElementById('chkVehicle').checked);
        processBlock('CHECKIN', document.getElementById('chkCheckin').checked);
        processBlock('TRAVEL_REPORT', document.getElementById('chkTravelReport').checked);
        return out;
    }

    function downloadZip() {
        const zip = new JSZip();
        const org = document.getElementById('orgName').value;
        const url = document.getElementById('webAppUrl').value;
        const secret = document.getElementById('secretKey').value;
        const logo = document.getElementById('logoUrl').value;
        const orsKey = document.getElementById('orsKey').value;
        const checkinEnabled = document.getElementById('chkCheckin').checked;
        const vehEnabled = document.getElementById('chkVehicle').checked;
        const escalationMins = document.getElementById('escalationMins').value;
        const countryPrefix = document.getElementById('countrySelect').value;
        const reqTravelReport = document.getElementById('chkTravelReport').checked;
        localStorage.setItem('otg_chkTravelReport', reqTravelReport);
        localStorage.setItem('otg_chkRedaction', document.getElementById('chkRedaction').checked);

        // INJECT KEYS & CONFIGS
        let wHtml = TEMPLATES.worker
            .replace(/%%ORG_NAME%%/g, org)
            .replace(/%%GOOGLE_SHEET_URL%%/g, url)
            .replace(/%%SHEET_URL%%/g, url)
            .replace(/%%LOGO_DATA%%/g, logo)
            .replace(/%%SECRET_KEY%%/g, workerKey)
            .replace(/%%CHECKIN_ENABLED%%/g, checkinEnabled)
            .replace(/%%CHECKIN_INTERVAL%%/g, document.getElementById('checkinMins').value)
            .replace(/%%ESCALATION_MINUTES%%/g, escalationMins)
            .replace(/%%IS_ADVANCED%%/g, "true")
            .replace(/%%ENABLE_MILEAGE%%/g, "true")
            .replace(/%%ORS_API_KEY%%/g, orsKey)
            .replace(/%%VEHICLE_ENABLED%%/g, vehEnabled)
            .replace(/%%VEHICLE_INTERVAL%%/g, document.getElementById('vehFreq').value)
            .replace(/%%COUNTRY_PREFIX%%/g, countryPrefix)
            .replace(/%%REQ_TRAVEL_REPORT%%/g, reqTravelReport)
            .replace(/%%VEHICLE_TERM%%/g, selectedConfig.term)
            .replace(/%%VOICE_LOCALE%%/g, selectedConfig.locale);

        let mHtml = TEMPLATES.monitor.replace(/%%ORG_NAME%%/g, org).replace(/%%SHEET_URL%%/g, url).replace(/%%LOGO_URL%%/g, logo);
        let bCode = document.getElementById('codeDisplay').textContent;
        let gHtml = processGuideTemplate(TEMPLATES.guide);
        let opHtml = TEMPLATES.manual.replace(/%%ORG_NAME%%/g, org).replace(/%%SECRET_KEY%%/g, secret).replace(/%%WORKER_KEY%%/g, workerKey);

        const swCode = `
const CACHE_NAME = 'otg-cache-v77';
const urlsToCache = ['./','./index.html','./manifest.json'];
self.addEventListener('install', event => { event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))); });
self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(response => { if (response) { return response; } return fetch(event.request); })); });
`;
        const manifest = { name: org, short_name: "Safety", start_url: "./index.html", display: "standalone", background_color: "#111827", theme_color: "#1e40af", icons: [ {src: logo, sizes: "192x192", type: "image/png"}, {src: logo, sizes: "512x512", type: "image/png"} ] };

        zip.folder("WorkerApp").file("index.html", wHtml).file("sw.js", swCode).file("manifest.json", JSON.stringify(manifest)).file("USER_GUIDE.html", gHtml);
        zip.folder("MonitorApp").file("index.html", mHtml);
        zip.file("Code.gs", bCode);
        zip.file("OPERATIONS_MANUAL.html", opHtml);

        zip.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=org.replace(/[^a-z0-9]/gi, '_') + "_On-The-Go_Lone_Worker_Apps.zip";a.click()});
    }
  </script>
</body>
</html>
