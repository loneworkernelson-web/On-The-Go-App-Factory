<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG Factory v78.10 (Stable)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { width: 100%; background: #1e293b; border: 2px solid #475569; padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; transition: border-color 0.2s; }
    .input-field:focus { border-color: #3b82f6; outline: none; }
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; }
    .code-scroll { background: #020617; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; }
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
    .tab-btn { flex: 1; py-4; font-weight: bold; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background: #1f2937; }
    a.link { color: #60a5fa; text-decoration: underline; font-size: 0.85rem; }
    .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 20px; text-align: center; background: #0f172a; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .drop-zone:hover { border-color: #3b82f6; background: #1e293b; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; border: 2px solid #475569; max-width: 600px; width: 90%; }
    .file-status { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #1e293b; border: 1px solid #334155; border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.85rem; }
    .status-badge { padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 0.7rem; }
    .status-pending { background: #334155; color: #94a3b8; }
    .status-ok { background: #064e3b; color: #34d399; }
    .status-err { background: #450a0a; color: #fca5a5; }
  </style>
</head>
<body class="min-h-screen py-8 px-4 relative">

  <div id="disclaimerModal" class="modal-backdrop" style="display: flex;">
      <div class="modal-content border-yellow-600">
          <h2 class="text-2xl font-extrabold text-white mb-2">‚ö†Ô∏è Important Safety Notice</h2>
          <div class="space-y-4 text-gray-300 text-sm mb-6">
              <p>The <strong>OTG AppSuite</strong> is a "Do-It-Yourself" software solution.</p>
              <ul class="list-disc pl-5 space-y-2">
                  <li><strong>The "Sleep" Issue:</strong> GPS tracking may stop if the phone sleeps (especially iOS). Staff must keep the app active.</li>
                  <li><strong>Connectivity:</strong> Alerts require data. They will not send in dead zones.</li>
                  <li><strong>No SLA:</strong> This relies on free Google services. No uptime guarantees.</li>
              </ul>
          </div>
          <div class="pt-4 border-t border-gray-700">
              <label class="flex items-start gap-3 cursor-pointer select-none">
                  <input type="checkbox" id="chkAccept" class="mt-1 w-5 h-5" onchange="toggleEnterBtn()">
                  <span class="text-sm text-gray-400">I accept these limitations and risks.</span>
              </label>
              <button id="btnEnter" disabled onclick="closeModal('disclaimerModal')" class="mt-4 w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg transition-all">Enter Factory</button>
          </div>
      </div>
  </div>

  <div id="driveHelpModal" class="modal-backdrop">
      <div class="modal-content border-blue-500">
          <h2 class="text-xl font-bold text-white mb-4">üìÇ How to get a Drive Folder ID</h2>
          <ol class="list-decimal pl-5 space-y-3 text-gray-300 text-sm mb-6">
              <li>Open Google Drive in your browser.</li>
              <li>Create a new folder (e.g., "Safety Photos").</li>
              <li>Double-click to open the folder.</li>
              <li>Look at the URL bar at the top of your browser.</li>
              <li>Copy the random string of letters/numbers AFTER <code>folders/</code>.</li>
          </ol>
          <div class="bg-black p-3 rounded font-mono text-xs text-green-400 mb-4 break-all">
              drive.google.com/drive/folders/<strong>1AbCdEfGhIjKlMnOpQrStUvWxYz</strong>
          </div>
          <button onclick="closeModal('driveHelpModal')" class="w-full py-2 bg-blue-600 text-white font-bold rounded">Got it</button>
      </div>
  </div>

  <div class="max-w-6xl mx-auto blur-sm transition-all duration-500" id="mainContent">
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">v78.10 | Golden Master (Global)</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="tab-btn active">1. Config</button>
        <button onclick="gotoStep(2)" id="tab2" class="tab-btn">2. Spreadsheet</button>
        <button onclick="gotoStep(3)" id="tab3" class="tab-btn">3. Backend</button>
        <button onclick="gotoStep(4)" id="tab4" class="tab-btn">4. Download</button>
        <button onclick="gotoStep(5)" id="tab5" class="tab-btn">5. Deployment</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div><label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label><input type="text" id="orgName" class="input-field" value="My Organisation" oninput="saveInput(this)"></div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Secret Key</label>
                  <input type="text" id="secretKey" class="input-field text-yellow-400" placeholder="ChangeMe123!" oninput="saveInput(this)">
                  <p class="text-xs text-red-400 mt-2 font-bold">‚ö†Ô∏è SECURITY WARNING: This is the Admin Key. Keep it safe.</p>
              </div>
              <div>
                  <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Region / Country</label>
                  <select id="countrySelect" class="input-field cursor-pointer" onchange="updateRegionInfo()">
                      <option value="+64">New Zealand (+64)</option>
                      <option value="+61">Australia (+61)</option>
                      <option value="+44">United Kingdom (+44)</option>
                      <option value="+1">USA / Canada (+1)</option>
                      <option value="">Other (No Auto-Format)</option>
                  </select>
                  <p id="regionInfo" class="text-xs text-gray-400 mt-2">Detected Timezone: <span id="detectedTz" class="text-blue-400 font-mono">Loading...</span></p>
                  <input type="hidden" id="timezoneVal">
              </div>
            </div>
            
            <div class="highlight-box flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">App Logo</label>
              <div id="dropZone" class="drop-zone w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto rounded-full flex items-center justify-center overflow-hidden">
                    <img id="logoImg" class="hidden h-full w-full object-cover">
                    <span id="logoText" class="text-gray-500 text-sm">Drag & Drop<br>Logo Here</span>
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <input type="hidden" id="logoUrl" oninput="saveInput(this)">
            </div>
          </div>

          <div class="highlight-box border-blue-500/30">
             <h3 class="text-xl font-bold text-white mb-4">Safety & Fleet Options</h3>
             <div class="grid md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Escalation Delay (Minutes)</label>
                    <input type="number" id="escalationMins" value="15" min="1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-20 text-center font-bold" oninput="saveInput(this)">
                    <span class="text-xs text-gray-400 block mt-1">Time allowed after "Overdue" before RED ALERT.</span>
                 </div>
                 
                 <div>
                    <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Statistics Frequency</label>
                    <select id="statsFreq" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-full font-bold" onchange="saveInput(this)">
                        <option value="MONTHLY" selected>Monthly (1st of Month)</option>
                        <option value="WEEKLY">Weekly (Monday)</option>
                        <option value="DAILY">Daily (Midnight)</option>
                    </select>
                    <span class="text-xs text-gray-400 block mt-1">When to regenerate Stats tabs.</span>
                 </div>
             </div>

             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkVehicle" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="toggleVehicle(); saveInput(this)" checked>
                    <span class="text-white font-bold">Enable Vehicle Safety Checks?</span>
                </label>
                <div id="vehOptions" class="pl-8 mt-2 text-sm text-gray-400">
                    <div class="flex items-center gap-2 mb-2">
                        <span>Check Frequency (Days):</span>
                        <input type="number" id="vehFreq" value="90" class="bg-gray-800 border border-gray-600 rounded p-1 w-16 text-center text-white font-bold" oninput="saveInput(this)">
                    </div>
                    <p class="text-xs text-gray-500">Default: 90 Days. Includes WOF Expiry Reminders.</p>
                </div>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="chkTravelReport" class="w-5 h-5 rounded bg-gray-700 text-blue-600" onchange="saveInput(this)" checked>
                    <span class="text-white font-bold">Default: Require Form on Travel Finish?</span>
                </label>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-600 grid md:grid-cols-2 gap-4">
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Textbelt Key</label><a href="https://textbelt.com/#pricing" target="_blank" class="link">Get Key</a></div><input type="text" id="textbeltKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional (Buy key for Non-US/Global)" oninput="saveInput(this)"></div>
                 
                 <div>
                     <div class="flex justify-between items-end mb-1">
                         <div class="flex items-center gap-2">
                             <input type="checkbox" id="enableAi" class="w-4 h-4" onchange="saveInput(this); toggleAiInput()">
                             <label class="block text-gray-400 text-xs font-bold uppercase cursor-pointer" for="enableAi">Enable AI Grammar</label>
                         </div>
                         <a href="https://aistudio.google.com/app/apikey" target="_blank" class="link">Get Key</a>
                     </div>
                     <input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full opacity-50" placeholder="Optional: Paste Gemini API Key..." disabled oninput="saveInput(this)">
                 </div>

                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">ORS Key</label><a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="link">Get Key</a></div><input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Road Mileage" oninput="saveInput(this)"></div>
                 <div><div class="flex justify-between items-end mb-1"><label class="block text-gray-400 text-xs font-bold uppercase">Drive Folder ID</label><span onclick="document.getElementById('driveHelpModal').style.display='flex'" class="link cursor-pointer">Where is this?</span></div><input type="text" id="folderId" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Optional: For Photos" oninput="saveInput(this)"></div>
             </div>
          </div>
          <div class="flex justify-end"><button onclick="gotoStep(2)" class="btn btn-primary text-lg">Next: Spreadsheet ‚Üí</button></div>
        </div>

        <div id="step2" class="step-section space-y-8">
          <div class="text-center">
              <a href="https://sheets.new" target="_blank" class="btn btn-success text-xl px-10 py-4 shadow-lg transform hover:-translate-y-1">1. Create New Google Sheet</a>
              <p class="text-gray-400 text-sm mt-2">Suggestion: Name it <strong>"OTG Safety DB"</strong></p>
          </div>
          <div class="bg-blue-900/20 p-4 rounded border border-blue-500/50 text-sm text-blue-200"><strong>üí° Instructions:</strong> Create these 5 tabs. Click buttons to copy the data (Tab-Separated Headers + Examples), then paste into <strong>Cell A1</strong> of each tab.</div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-blue-400">A. Setup 'Visits' Tab</h3>
                <button onclick="copyData('Visits')" class="w-full btn bg-blue-700 hover:bg-blue-600 text-white py-2">Copy Blueprints (A1)</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-purple-400">B. Setup 'Templates' Tab</h3>
                <button onclick="copyData('Templates')" class="w-full btn bg-purple-700 hover:bg-purple-600 text-white py-2">Copy Blueprints (A1)</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-green-400">C. Setup 'Sites' Tab</h3>
                <button onclick="copyData('Sites')" class="w-full btn bg-green-700 hover:bg-green-600 text-white py-2">Copy Blueprints (A1)</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-lg border-2 border-red-600 space-y-4">
                <h3 class="font-bold text-lg text-red-400">D. Setup 'Staff' Tab</h3>
                <button onclick="copyData('Staff')" class="w-full btn bg-red-800 hover:bg-red-700 text-white py-2">Copy Blueprints (A1)</button>
            </div>
          </div>
          <div class="mt-4 bg-gray-900 p-6 rounded-lg border border-gray-600 space-y-4">
                <h3 class="font-bold text-lg text-yellow-400">E. AI Reporting Tab</h3>
                <p class="text-sm text-gray-400">Create a tab named <code>Admin_Help</code>. This contains prompts to help you write reports later.</p>
                <button onclick="copyData('AdminHelp')" class="btn bg-yellow-600 hover:bg-yellow-500 text-white py-2 px-6">Copy AI Prompts (A1)</button>
          </div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button><button onclick="generateScript()" class="btn btn-primary text-lg">Next: Backend ‚Üí</button></div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="relative">
            <button onclick="copyScript()" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">COPY CODE</button>
            <pre id="codeDisplay" class="code-scroll">Generating code...</pre>
          </div>
          <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 text-sm text-gray-300 space-y-4">
             <h3 class="font-bold text-green-400 text-lg">Deploy Backend</h3>
             <ol class="list-decimal pl-5 space-y-3">
                <li>Go to Google Sheet > <strong>Extensions > Apps Script</strong>.</li>
                <li>Delete existing code. <strong>Paste</strong> new code.</li>
                <li>Click <strong>Deploy > New Deployment</strong>. Select <strong>Web App</strong>.</li>
                <li class="p-3 border-2 border-red-500 rounded bg-red-900/20 text-white font-bold">‚ö†Ô∏è CRITICAL: Set "Who has access" to <span class="text-red-400 underline">"Anyone"</span>.</li>
                <li>Click <strong>Deploy</strong>. Copy the URL.</li>
             </ol>
          </div>
          <div class="bg-yellow-900/30 border border-yellow-600/50 p-6 rounded-lg mt-4">
             <h3 class="font-bold text-yellow-400 text-lg flex items-center gap-2">‚è∞ Set Automation Triggers</h3>
             <p class="text-xs text-gray-400">Apps Script > Alarm Clock Icon > + Add Trigger</p>
             <ul class="list-disc pl-5 space-y-2 text-sm text-gray-300">
                <li><strong>Safety Watchdog:</strong> <code>checkOverdueVisits</code> ‚Üí Time-driven ‚Üí Minutes timer ‚Üí Every 10 minutes.</li>
             </ul>
          </div>
          <div><label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste Web App URL:</label><input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec" oninput="saveInput(this)"></div>
          <div class="flex justify-center gap-4"><button onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">üì° Test Connection</button></div>
          <div id="testResult" class="text-center font-bold text-lg hidden mt-4"></div>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button><button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-lg opacity-50 cursor-not-allowed">Next: Download ‚Üí</button></div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div><h2 class="text-4xl font-bold text-white mb-2">Ready to Build</h2><p class="text-gray-400">Files generated for: <span id="finalAppName" class="text-blue-400">App</span></p></div>
          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">Download On-The-Go_Apps.zip</button>
          <div class="flex justify-between pt-6"><button onclick="gotoStep(3)" class="text-gray-400 font-bold">Back</button><button onclick="gotoStep(5)" class="btn btn-primary">Next: Deployment Guide ‚Üí</button></div>
        </div>

        <div id="step5" class="step-section space-y-10">
            <div class="bg-gray-900 p-8 rounded-xl border border-gray-700">
                <div class="flex items-center gap-4 mb-6"><span class="text-4xl">üöÄ</span><div><h2 class="text-2xl font-bold text-white">1. Host with Netlify (Free)</h2></div></div>
                <p class="text-sm text-gray-300 mb-4">A complete step-by-step guide is included in your ZIP file: <code>ADMIN_MANUAL.html</code></p>
                <ol class="list-decimal pl-6 space-y-4 text-sm text-gray-300">
                    <li>Sign up at <a href="https://app.netlify.com/signup" target="_blank" class="text-blue-400 underline font-bold">app.netlify.com</a>.</li>
                    <li>Drag the <strong>WorkerApp</strong> folder from your ZIP into the Netlify "Sites" tab.</li>
                    <li>Repeat for the <strong>MonitorApp</strong> folder.</li>
                </ol>
            </div>
            <div class="flex justify-start pt-6"><button onclick="gotoStep(4)" class="text-gray-400 font-bold">Back</button></div>
        </div>

      </div>
    </div>
  </div>

<script>
const FILES={worker:'worker_template.html',monitor:'monitor_template.html',backend:'backend_template.js',guide:'guide_template.html',manual:'ops_manual_template.html'};
let TEMPLATES={}; const workerKey="wk_"+Math.random().toString(36).substr(2,9);

// SYNTAX ERROR FIXED: Correctly escaped JSON strings for the JS variable
const BLUEPRINTS = {
    Visits: "Timestamp\tDate\tWorker Name\tWorker Phone\tEmerg Name\tEmerg Phone\tEmerg Email\tEscal Name\tEscal Phone\tEscal Email\tAlarm Status\tNotes\tLocation Name\tLocation Address\tGPS Coords\tGPS Timestamp\tBattery Level\tPhoto\tTrip Distance\n2024-01-01T08:00:00.000Z\t2024-01-01\tJohn Doe\t+6421123456\tJane Doe\t+6421999888\tjane@test.com\t\t\t\t\"ON SITE\"\t\"Arrived safely\"\t\"Head Office\"\t\"123 Queen St\"\t\"-36.8,174.7\"\t2024-01-01T08:00:00.000Z\t95%\t\t0",
    Staff: "Worker Name\tPhone\tEmail\tPIN\tRole\tEmg Name\tEmg Phone\tDeviceID\nJohn Doe\t+6421123456\tjohn@test.com\t1234\tWorker\tJane Doe\t+6421999888\t",
    Sites: "SiteID\tSite Name\tLatitude\tLongitude\tAddress\tContact Name\tContact Phone\tContact Email\tNotes\tTemplate Name\nsite_hq\tHead Office\t-36.8485\t174.7633\t123 Queen St\tReception\t093000000\treception@hq.com\tParking at rear\tStandard Visit Note",
    Templates: "Template Name\tDescription\tJSON Fields\nVehicle Safety Check\tStandard vehicle inspection\t[{\"label\":\"Rego Valid?\",\"type\":\"yesno\"},{\"label\":\"Tyres OK?\",\"type\":\"yesno\"},{\"label\":\"Fuel Level\",\"type\":\"select\",\"options\":[\"Full\",\"3/4\",\"1/2\",\"1/4\",\"Empty\"]},{\"label\":\"Damage Report\",\"type\":\"text\"},{\"label\":\"Photo of Odometer\",\"type\":\"photo\"}]",
    AdminHelp: "Task\tAI Prompt Suggestion\nCreate PDF Report\t\"I have a Google Sheet with a tab 'Visits'. Columns are: A=Timestamp, C=Worker Name, K=Status, S=Distance. Please write a Google Apps Script function to email me a PDF summary of total distance per worker for the last 7 days.\"\nData Clean Up\t\"Write a script to archive rows from 'Visits' that are older than 30 days to a new tab called 'Archive' inside the same spreadsheet.\""
};

window.onload=async()=>{
    loadPersistedData(); updateRegionInfo(); setupDragDrop(); toggleAiInput(); genKey();
    for(const[k,f]of Object.entries(FILES)){try{const r=await fetch(f);if(r.ok)TEMPLATES[k]=await r.text();}catch(e){}}
};

function saveInput(el){localStorage.setItem('otg_'+el.id,el.type==='checkbox'?el.checked:el.value);}
function loadPersistedData(){
    const ids=['orgName','secretKey','webAppUrl','geminiKey','orsKey','textbeltKey','folderId','escalationMins','vehFreq','countrySelect','statsFreq'];
    ids.forEach(id=>{const v=localStorage.getItem('otg_'+id);if(v)document.getElementById(id).value=v;});
    if(localStorage.getItem('otg_chkTravelReport')!==null)document.getElementById('chkTravelReport').checked=localStorage.getItem('otg_chkTravelReport')==='true';
    if(localStorage.getItem('otg_enableAi')!==null)document.getElementById('enableAi').checked=localStorage.getItem('otg_enableAi')==='true';
}
function updateRegionInfo(){const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;document.getElementById('detectedTz').textContent=tz;document.getElementById('timezoneVal').value=tz;saveInput(document.getElementById('countrySelect'));}
function toggleEnterBtn(){const b=document.getElementById('btnEnter'),c=document.getElementById('chkAccept');b.disabled=!c.checked;if(c.checked){b.classList.remove('bg-gray-700','text-gray-500');b.classList.add('bg-blue-600','text-white','hover:bg-blue-500');}else{b.classList.add('bg-gray-700','text-gray-500');b.classList.remove('bg-blue-600','text-white','hover:bg-blue-500');}}
function closeModal(id){document.getElementById(id).style.display='none';if(id==='disclaimerModal')document.getElementById('mainContent').classList.remove('blur-sm');}
function setupDragDrop(){const d=document.getElementById('dropZone');d.addEventListener('dragover',e=>{e.preventDefault();d.classList.add('border-blue-500')});d.addEventListener('dragleave',e=>{e.preventDefault();d.classList.remove('border-blue-500')});d.addEventListener('drop',e=>{e.preventDefault();d.classList.remove('border-blue-500');if(e.dataTransfer.files.length)handleLogo({files:e.dataTransfer.files})});}
function handleLogo(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{TEMPLATES.logo=e.target.result;document.getElementById('logoImg').src=e.target.result;document.getElementById('logoImg').classList.remove('hidden');document.getElementById('logoText').innerText="‚úÖ Ready";document.getElementById('logoUrl').value=e.target.result;saveInput(document.getElementById('logoUrl'));};r.readAsDataURL(i.files[0]);}}
function gotoStep(n){if(n===4)attemptAutoLoad();document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));document.getElementById('step'+n).classList.add('active');for(let i=1;i<=5;i++){const t=document.getElementById('tab'+i);if(i===n)t.classList.add('active');else t.classList.remove('active');}}
function toggleVehicle(){document.getElementById('vehOptions').style.display=document.getElementById('chkVehicle').checked?'flex':'none';}
function toggleAiInput(){const c=document.getElementById('enableAi'),i=document.getElementById('geminiKey');i.disabled=!c.checked;i.style.opacity=c.checked?'1':'0.5';}
function genKey(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<32;i++)r+=c.charAt(Math.floor(Math.random()*c.length));document.getElementById('secretKey').value=r;}
function copyData(k){navigator.clipboard.writeText(BLUEPRINTS[k]);alert(k+" Copied! Paste in A1.");}

function generateScript(){
    if(!TEMPLATES.backend){setTimeout(generateScript,500);return;}
    const code=TEMPLATES.backend.replace('%%SECRET_KEY%%',document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g,workerKey).replace('%%ORS_API_KEY%%',document.getElementById('orsKey').value).replace('%%GEMINI_API_KEY%%',document.getElementById('geminiKey').value).replace('%%TEXTBELT_API_KEY%%',document.getElementById('textbeltKey').value).replace('%%PHOTOS_FOLDER_ID%%',document.getElementById('folderId').value).replace('%%ORGANISATION_NAME%%',document.getElementById('orgName').value).replace('%%TIMEZONE%%',document.getElementById('timezoneVal').value||"Pacific/Auckland").replace('%%COUNTRY_CODE%%',document.getElementById('countrySelect').value.replace('+','')).replace('%%STATS_FREQ%%',document.getElementById('statsFreq').value).replace('%%ENABLE_AI%%',document.getElementById('enableAi').checked).replace('%%ESCALATION_MINUTES%%',document.getElementById('escalationMins').value);
    document.getElementById('codeDisplay').textContent=code;gotoStep(3);
}
function copyScript(){navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent);alert("Copied!");}
function testConnection(){
    const u=document.getElementById('webAppUrl').value,r=document.getElementById('testResult');
    if(!u.includes('/exec')){alert('Invalid URL');return;}
    r.classList.remove('hidden');r.textContent="Testing...";r.className="text-center font-bold text-yellow-400";
    fetch(u+'?action=ping').then(res=>res.json()).then(d=>{if(d.status==="success"){r.textContent="‚úÖ Success!";r.className="text-center font-bold text-green-400";document.getElementById('btnNextDownload').disabled=false;document.getElementById('btnNextDownload').classList.remove('opacity-50','cursor-not-allowed');}else throw new Error();}).catch(()=>{r.textContent="‚ùå Failed";r.className="text-center font-bold text-red-400";});
}
async function attemptAutoLoad(){
    const m=[{id:'st_worker',f:'worker_template.html'},{id:'st_monitor',f:'monitor_template.html'},{id:'st_backend',f:'backend_template.js'},{id:'st_guide',f:'guide_template.html'},{id:'st_manual',f:'ops_manual_template.html'}];
    let ok=0;for(let x of m){try{const r=await fetch(x.f);if(r.ok){TEMPLATES[x.f]=await r.text();document.querySelector(`#${x.id} .status-badge`).className="status-badge status-ok";document.querySelector(`#${x.id} .status-badge`).innerText="LOADED";ok++;}}catch(e){document.querySelector(`#${x.id} .status-badge`).className="status-badge status-err";document.querySelector(`#${x.id} .status-badge`).innerText="MISSING";}}
    checkAssets(ok===5);
}
function handleFiles(inp){Array.from(inp.files).forEach(f=>{if(TEMPLATES.hasOwnProperty(f.name)){const r=new FileReader();r.onload=e=>{TEMPLATES[f.name]=e.target.result;let id="";if(f.name.includes('worker'))id='st_worker';else if(f.name.includes('monitor'))id='st_monitor';else if(f.name.includes('backend'))id='st_backend';else if(f.name.includes('guide'))id='st_guide';else if(f.name.includes('manual'))id='st_manual';if(id){document.querySelector(`#${id} .status-badge`).className="status-badge status-ok";document.querySelector(`#${id} .status-badge`).innerText="UPLOADED";}if(Object.values(TEMPLATES).every(v=>v!==null))checkAssets(true);};r.readAsText(f);}});}
function checkAssets(r){const b=document.getElementById('btnDlZip');if(r){b.disabled=false;b.classList.remove('opacity-50');document.getElementById('manUpload').classList.add('hidden');}else{document.getElementById('manUpload').classList.remove('hidden');}}
function downloadZip(){
    const zip=new JSZip(),org=document.getElementById('orgName').value,url=document.getElementById('webAppUrl').value;
    let wHtml=TEMPLATES['worker_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%SHEET_URL%%/g,url).replace(/%%LOGO_DATA%%/g,TEMPLATES.logo||"").replace(/%%WORKER_KEY%%/g,workerKey).replace(/%%ORS_API_KEY%%/g,document.getElementById('orsKey').value).replace(/%%ESCALATION_MINUTES%%/g,document.getElementById('escalationMins').value).replace(/%%VEH_ENABLED%%/g,document.getElementById('chkVehicle').checked).replace(/%%VEH_INTERVAL%%/g,document.getElementById('vehFreq').value).replace(/%%MILEAGE_ENABLED%%/g,"true").replace(/%%COUNTRY_CODE%%/g,document.getElementById('countrySelect').value.replace('+','')).replace(/%%REQ_TRAVEL_REPORT%%/g,document.getElementById('chkTravelReport').checked);
    let mHtml=TEMPLATES['monitor_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%LOGO_URL%%/g,TEMPLATES.logo||"");
    let gHtml=TEMPLATES['guide_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%VEHICLE_INTERVAL%%/g,document.getElementById('vehFreq').value);
    zip.folder("WorkerApp").file("index.html",wHtml).file("sw.js",`const CACHE_NAME='otg-v78.10';const u=['./','./index.html','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(u)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>{return r||fetch(e.request)}))});`).file("manifest.json",JSON.stringify({name:org,short_name:"Safety",start_url:"./index.html",display:"standalone",background_color:"#111827",theme_color:"#1e40af",icons:[{src:"icon.png",sizes:"192x192",type:"image/png"}]})).file("USER_GUIDE.html",gHtml);
    if(TEMPLATES.logo)zip.folder("WorkerApp").file("icon.png",TEMPLATES.logo.split(',')[1],{base64:true});
    zip.folder("MonitorApp").file("index.html",mHtml);
    zip.file("Code.gs",document.getElementById('codeDisplay').textContent);
    zip.file("ADMIN_MANUAL.html",TEMPLATES['ops_manual_template.html'].replace(/%%ORG_NAME%%/g,org).replace(/%%SECRET_KEY%%/g,document.getElementById('secretKey').value).replace(/%%WORKER_KEY%%/g,workerKey));
    zip.generateAsync({type:"blob"}).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=org.replace(/[^a-z0-9]/gi,'_')+"_OTG_Apps.zip";a.click();});
}
</script>
</body>
</html>
