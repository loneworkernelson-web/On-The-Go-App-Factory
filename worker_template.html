<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>%%ORG_NAME%%</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
/* --- CORE STYLES --- */
body { 
    font-family: 'Inter', sans-serif; 
    -webkit-tap-highlight-color: transparent; 
    user-select: none; 
    overscroll-behavior-y: contain; 
    background-color: #111827; 
    color: white;
}
.page { display: none; height: 100%; flex-direction: column; }
.page.active { display: flex; }

/* --- UI COMPONENTS --- */
.long-press-btn { position: relative; overflow: hidden; user-select: none; }
.long-press-btn::after { 
    content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; 
    background: rgba(255, 255, 255, 0.3); 
    transition: width 1.5s linear; 
}
.long-press-btn.pressing::after { width: 100%; }

.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }

/* --- SETTINGS CARDS --- */
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.form-input-card { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.5rem; display: block; }

/* Colors */
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }
</style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

<div id="app-container" class="h-full flex flex-col">

<div id="mainPage" class="page active p-4 bg-gray-800">
    <header class="flex justify-between items-center mb-4 flex-shrink-0">
        <div class="flex items-center gap-2">
            <img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'">
            <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="showModal('info')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚ÑπÔ∏è</button>
            <button onclick="navigate('settings')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="startReminderBanner" class="hidden bg-yellow-600/20 border border-yellow-500 text-yellow-200 text-xs rounded p-2 mb-2 text-center">
        Reminder: Don't forget to start your timer when you arrive.
    </div>
    
    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 flex-shrink-0">
        <div class="spinner"></div> 
        <span>Syncing <span id="queueCount">0</span> offline reports...</span>
    </div>

    <div class="flex-1 overflow-y-auto mb-4 rounded-lg min-h-0">
        <div id="locationList" class="space-y-3"></div>
        <button onclick="openLocModal()" class="mt-4 w-full py-4 border-2 border-dashed border-gray-600 text-gray-400 rounded-xl hover:border-gray-500 hover:text-white transition font-bold">+ Add Location</button>
    </div>

    <div class="mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700 flex-shrink-0">
        <div class="flex justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase font-bold">Duration</span>
            <span id="durationDisplay" class="font-bold text-blue-400">0 min</span>
        </div>
        <input id="durationSlider" type="range" min="0" max="14" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateArrivedButtonState()">
    </div>

    <div class="flex gap-2 flex-shrink-0">
        <button id="btnQuick" onclick="quickStat()" class="hidden flex-1 py-5 bg-teal-900 text-teal-500 font-bold rounded-xl text-lg opacity-50 transition" disabled>Quick Stat</button>
        <button id="btnStart" class="long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all" disabled>Select Location</button>
    </div>
</div>

<div id="lockedPage" class="page p-6 text-center justify-between bg-gray-900">
    <div class="flex justify-end">
        <button onclick="triggerPanic()" class="w-20 h-20 bg-red-600 rounded-full font-bold text-white text-xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center">SOS</button>
    </div>
    
    <div>
        <p class="text-gray-500 text-sm uppercase tracking-widest">Currently At</p>
        <h2 id="lockedLocationName" class="text-3xl font-bold text-white mb-6 mt-1 truncate px-2"></h2>
        <div id="countdownTimer" class="text-7xl font-bold font-mono text-white tracking-tighter">00:00</div>
        <p class="text-gray-400 mt-2">Due: <span id="lockedAnticipatedTime" class="text-blue-400 font-bold"></span></p>
    </div>

    <div class="space-y-4 w-full">
        <button id="btnExtend" class="long-press-btn w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Extend 10m</button>
        <button id="btnDepart" class="long-press-btn w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl text-lg shadow-lg">DEPART</button>
        <button id="btnSafe" class="hidden long-press-btn w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">I AM SAFE</button>
    </div>
</div>

<div id="settingsPage" class="page p-4 bg-gray-800">
    <header class="flex justify-between mb-4 flex-shrink-0 items-center">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button id="btnCloseSettings" onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white">√ó</button>
    </header>
    
    <div class="flex-1 overflow-y-auto pb-4">
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4">
            <p class="text-xs text-blue-200">Please use international format for phones (e.g. +64 21...).</p>
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-blue">Your Details *</label>
            <input id="set_name" class="form-input-card" placeholder="Full Name">
            <input id="set_phone" type="tel" class="form-input-card" placeholder="Phone (+64...)">
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-green">Emergency Contact *</label>
            <input id="set_emg_name" class="form-input-card" placeholder="Name">
            <input id="set_emg_phone" type="tel" class="form-input-card" placeholder="Phone (+64...)">
            <input id="set_emg_email" type="email" class="form-input-card" placeholder="Email">
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-purple">Escalation Contact</label>
            <input id="set_esc_name" class="form-input-card" placeholder="Name">
            <input id="set_esc_phone" type="tel" class="form-input-card" placeholder="Phone (+64...)">
            <input id="set_esc_email" type="email" class="form-input-card" placeholder="Email">
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-red">Security (4 Digits) *</label>
            <div class="flex gap-2">
                <input id="set_pin" type="tel" maxlength="4" class="form-input text-center tracking-widest" placeholder="PIN">
                <input id="set_duress" type="tel" maxlength="4" class="form-input text-center tracking-widest" placeholder="Duress">
            </div>
        </div>

        <div class="setting-card border-gray-600">
            <label class="setting-label lbl-gray">System URL</label>
            <input id="set_url" disabled class="form-input-card text-xs font-mono text-gray-500" value="%%GOOGLE_SHEET_URL%%">
            <div class="flex gap-2 mt-2">
                <button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white">Force Sync</button>
                <button onclick="clearData()" class="flex-1 bg-red-900/50 text-red-400 hover:bg-red-900/70 py-2 rounded text-xs font-bold">Reset App</button>
            </div>
        </div>
    </div>
    
    <button onclick="saveSettings()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg mb-2 flex-shrink-0">Save Settings</button>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
    
    <div id="locationModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
        <h2 id="locModalTitle" class="text-xl font-bold mb-4 text-white">Edit Location</h2>
        <input type="hidden" id="locId">
        <div class="space-y-4">
            <div><label class="text-xs text-gray-400 uppercase font-bold">Name</label><input type="text" id="locName" class="form-input"></div>
            
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold">Address</label>
                <div class="flex gap-2">
                    <input type="text" id="locAddr" class="form-input mb-0 flex-1">
                    <button onclick="getGpsAddress()" id="btnGpsAddr" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-lg font-bold text-xs shrink-0 shadow-lg">üìç GPS</button>
                </div>
            </div>
            
            <div id="advLocOptions" class="pt-2 border-t border-gray-700">
               <label class="flex items-center justify-between p-2 bg-gray-900 rounded cursor-pointer mb-2">
                 <span class="text-sm text-gray-300">No Report Required</span>
                 <input type="checkbox" id="locNoRep" class="w-5 h-5 rounded bg-gray-700 border-gray-500 text-blue-600">
               </label>
               <div><label class="text-xs text-gray-400 uppercase font-bold">Template Name</label><input type="text" id="locTemplate" class="form-input text-sm" placeholder="(Standard)"><p class="text-xs text-gray-500 mt-1">Must match 'Checklists' sheet.</p></div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button id="btnDelLoc" onclick="deleteLoc()" class="bg-red-900/50 text-red-400 font-bold py-2 px-4 rounded-lg hidden">Delete</button>
            <div class="flex-1"></div>
            <button onclick="closeModal('location')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button onclick="saveLoc()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
        </div>
    </div>

    <div id="pinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6 text-center">
         <h2 class="text-xl font-bold mb-4 text-white">Enter PIN</h2>
         <input type="password" id="pinInput" maxlength="4" class="text-center text-3xl tracking-[1em] w-48 mx-auto bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-blue-500" inputmode="numeric">
         <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelPinBtn" onclick="closeModal('pin')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button id="confirmPinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
         </div>
    </div>

    <div id="infoModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold mb-4 text-blue-400">User Guide</h2>
        <div class="text-gray-300 space-y-4 text-sm">
            <h3 class="font-bold text-white">1. Starting a Visit</h3>
            <p>Select a location from the list. Adjust the duration slider. Press and hold the green <strong>START</strong> button for 1.5 seconds.</p>
            
            <h3 class="font-bold text-white">2. During the Visit</h3>
            <p>The screen will lock for safety. You can <strong>Extend</strong> time or <strong>Depart</strong> using your Normal PIN.</p>
            
            <h3 class="font-bold text-white">3. Duress (Silent Alarm)</h3>
            <p>If you are forced to unlock the app, enter your <strong>Duress PIN</strong> instead of your Normal PIN. The app will appear to unlock normally but will silently send a high-priority alarm to the dashboard.</p>
            
            <h3 class="font-bold text-white">4. Mileage / Travelling</h3>
            <p>Use the "Travelling" tile for journeys. Start when you leave, Depart when you arrive. The app will calculate the GPS distance for your report.</p>
            
            <h3 class="font-bold text-white">5. Offline Mode</h3>
            <p>The app works offline. Reports and photos are saved to your phone and will upload automatically when internet is restored.</p>
        </div>
        <div class="mt-6 flex justify-end"><button onclick="closeModal('info')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Close</button></div>
    </div>

    <div id="checkinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center border-4 border-yellow-500">
        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Are you OK?</h2>
        <p class="text-lg text-gray-300 mb-4">Scheduled safety check.</p>
        <div id="checkinCountdown" class="text-6xl font-bold text-yellow-400 mb-6 font-mono">2:00</div>
        <button onclick="confirmCheckin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">I am OK</button>
    </div>

    <div id="modal-report" class="hidden bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl">
      <h2 class="text-2xl font-bold text-white mb-6 flex-shrink-0" id="reportTitle">Visit Report</h2>
      <div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2">
        </div>
      <div class="flex gap-3 flex-shrink-0">
        <button onclick="closeModal('report')" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button>
        <button id="btnSubmitRep" class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit</button>
      </div>
    </div>

    <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="alertModalTitle" class="text-xl font-bold mb-2 text-white">Alert</h2>
        <p id="alertModalMessage" class="text-gray-300 mb-6"></p>
        <button onclick="closeModal('alert')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button>
    </div>

</div>
</div>

<script>
// ==================== CONFIGURATION ====================
const CONFIG = { 
    isAdv: %%IS_ADVANCED%%, 
    mileage: %%ENABLE_MILEAGE%%, 
    url: "%%GOOGLE_SHEET_URL%%", 
    org: "%%ORGANISATION_NAME%%", 
    checkinEnabled: %%CHECKIN_ENABLED%%,   
    checkinInterval: %%CHECKIN_INTERVAL%%  
}; 
const DURATION_STEPS = [0, 10, 15, 20, 30, 45, 60, 75, 90, 105, 120, 150, 180, 240, 300];

// ==================== STATE MANAGEMENT ====================
let state = { 
    settings: {}, 
    locations: [], 
    selectedLocationId: null, 
    visitDurationMinutes: 0, 
    activeVisit: null, 
    cachedForms: {}, 
    pendingUploads: [] 
};

// Globals
let synth, checkinIntervalId, mainScreenReminderTimer, wakeLock, timerInt;
let tempPhoto = null;
let sigPad = null;

// ==================== INITIALIZATION ====================
window.addEventListener('load', () => {
    const s = localStorage.getItem('loneWorkerState');
    if(s) { try { state = { ...state, ...JSON.parse(s) }; } catch(e){ console.error("State Error", e); } }
    
    // Force Config
    state.settings.googleSheetUrl = CONFIG.url; 
    
    // FIX: State Migration (Map old 'name' key to new 'workerName' key)
    if(state.settings.name && !state.settings.workerName) {
        state.settings.workerName = state.settings.name;
        state.settings.workerPhone = state.settings.phone;
        state.settings.emergencyName = state.settings.emgName;
        state.settings.emergencyPhone = state.settings.emgPhone;
        state.settings.emergencyEmail = state.settings.emgEmail;
    }

    // Mileage Default
    if(CONFIG.mileage) {
        if(!state.locations) state.locations = [];
        if(!state.locations.find(l => l.id === 'travel')) {
            state.locations.unshift({ 
                id: 'travel', 
                name: 'Travelling', 
                address: 'Calculates Mileage via GPS', 
                noReport: false, 
                companyName: 'Internal', 
                templateName: 'Travel Report' 
            });
        }
    } else if(state.locations) {
        state.locations = state.locations.filter(l => l.id !== 'travel');
    }

    // Feature Flags
    if(CONFIG.isAdv) {
        document.getElementById('btnQuick').classList.remove('hidden');
        document.getElementById('advLocOptions').classList.remove('hidden');
        syncForms();
    } else {
        document.getElementById('advLocOptions').classList.add('hidden');
    }

    // Route
    if(!state.settings.pinCode || !state.settings.workerName) {
        navigate('settings');
        document.getElementById('btnCloseSettings').style.display = 'none';
    } else if(state.activeVisit) {
        enterLockedScreen();
    } else {
        navigate('main');
        renderLocations();
    }
    
    updateArrivedButtonState();
    processUploadQueue();
    document.body.addEventListener('click', initAudio, { once: true });
    startReminderTimer();
});

// ==================== NAVIGATION ====================
function navigate(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page + 'Page').classList.add('active');
    
    if(page === 'main') startReminderTimer();
    else clearTimeout(mainScreenReminderTimer);

    if(page === 'settings') {
        ['name','phone','emg_name','emg_phone','emg_email','esc_name','esc_phone','esc_email','pin','duress'].forEach(k => {
            const val = state.settings[k === 'duress' ? 'duressPin' : (k === 'pin' ? 'pinCode' : k.replace('_','').replace('name','Name').replace('phone','Phone').replace('email','Email'))];
            const el = document.getElementById('set_'+k);
            if(el) el.value = val || "";
        });
        document.getElementById('set_url').value = state.settings.googleSheetUrl;
    }
}

function saveState() { 
    localStorage.setItem('loneWorkerState', JSON.stringify(state)); 
}

function startReminderTimer() {
    clearTimeout(mainScreenReminderTimer);
    document.getElementById('startReminderBanner').classList.add('hidden');
    mainScreenReminderTimer = setTimeout(() => {
        if(!state.activeVisit && document.getElementById('mainPage').classList.contains('active')) {
            document.getElementById('startReminderBanner').classList.remove('hidden');
        }
    }, 300000); // 5 Mins
}

// ==================== AUDIO ENGINE ====================
async function initAudio() {
    if(synth) return;
    try {
        await Tone.start();
        synth = new Tone.Synth().toDestination();
    } catch(e) { console.warn("Audio Init Fail", e); }
}

function playSoundAndVibrate(action) {
    initAudio().then(() => {
        const now = Tone.now();
        switch(action) {
            case 'arrive': 
                synth.triggerAttackRelease("C4", "8n", now); 
                synth.triggerAttackRelease("G4", "8n", now+0.2); 
                if(navigator.vibrate) navigator.vibrate(50); 
                break;
            case 'depart': 
                synth.triggerAttackRelease("G4", "8n", now); 
                synth.triggerAttackRelease("C4", "8n", now+0.2); 
                if(navigator.vibrate) navigator.vibrate(50); 
                break;
            case 'extend': 
                synth.triggerAttackRelease("A4", "16n", now); 
                if(navigator.vibrate) navigator.vibrate(50); 
                break;
            case 'safe': 
                synth.triggerAttackRelease("C5", "8n", now); 
                if(navigator.vibrate) navigator.vibrate([50,50,50]); 
                break;
            case 'warning': 
                synth.triggerAttackRelease("E5", "16n", now); 
                synth.triggerAttackRelease("G5", "16n", now+0.2); 
                if(navigator.vibrate) navigator.vibrate([800,200]); 
                break;
            case 'panic': 
                synth.triggerAttackRelease("G5", "16n", now); 
                synth.triggerAttackRelease("G5", "16n", now+0.1); 
                synth.triggerAttackRelease("G5", "16n", now+0.2); 
                if(navigator.vibrate) navigator.vibrate([200,100,200]); 
                break;
            case 'checkin': 
                synth.triggerAttackRelease("A4", "16n", now); 
                if(navigator.vibrate) navigator.vibrate(200); 
                break;
        }
    });
}

// ==================== LOCATION LOGIC ====================
function renderLocations() {
    const list = document.getElementById('locationList');
    list.innerHTML = '';
    if(!state.locations) state.locations = [];
    
    state.locations.forEach(l => {
        const el = document.createElement('div');
        
        // TILE STYLE LOGIC
        let bgColor = 'bg-gray-900';
        let borderColor = 'border-transparent';
        let textColor = 'text-white';
        
        if(state.selectedLocationId === l.id) {
            bgColor = 'bg-blue-900';
            borderColor = 'border-blue-500';
        }
        
        if(l.id === 'travel') textColor = 'text-purple-400';
        
        el.className = `p-4 rounded-lg border-2 ${bgColor} ${borderColor} cursor-pointer flex justify-between items-center group transition-all mb-2`;
        
        let html = `<div><div class="font-bold text-lg ${textColor}">${l.name}</div><div class="text-sm text-gray-400">${l.address}</div></div>`;
        html += `<div class="flex gap-2"><button class="text-gray-500 hover:text-white p-2 text-xl z-10" onclick="openLocModal('${l.id}', event)">‚öôÔ∏è</button></div>`;
        
        el.innerHTML = html;
        el.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') { 
                state.selectedLocationId = l.id; 
                renderLocations(); 
                updateArrivedButtonState(); 
            }
        };
        list.appendChild(el);
    });
}

function openLocModal(id=null, e=null) {
    if(e) e.stopPropagation();
    showModal('location');
    if(id) {
        const l = state.locations.find(x => x.id === id);
        document.getElementById('locModalTitle').innerText = "Edit Location";
        document.getElementById('locId').value = id;
        document.getElementById('locName').value = l.name;
        document.getElementById('locAddr').value = l.address;
        document.getElementById('locTemplate').value = l.templateName || "";
        document.getElementById('locNoRep').checked = l.noReport || false;
        
        if(id === 'travel') document.getElementById('btnDelLoc').classList.add('hidden');
        else document.getElementById('btnDelLoc').classList.remove('hidden');
    } else {
        document.getElementById('locModalTitle').innerText = "Add Location";
        document.getElementById('locId').value = "";
        document.getElementById('locName').value = "";
        document.getElementById('locAddr').value = "";
        document.getElementById('locTemplate').value = "";
        document.getElementById('locNoRep').checked = false;
        document.getElementById('btnDelLoc').classList.add('hidden');
    }
}

function saveLoc() {
    const id = document.getElementById('locId').value;
    const name = document.getElementById('locName').value;
    const addr = document.getElementById('locAddr').value;
    const tpl = document.getElementById('locTemplate').value;
    const noRep = document.getElementById('locNoRep').checked;
    
    if(!name) return alert("Name required");
    
    if(id) {
        const idx = state.locations.findIndex(l => l.id === id);
        if(idx > -1) state.locations[idx] = { ...state.locations[idx], name, address: addr, templateName: tpl, noReport: noRep };
    } else {
        state.locations.push({ id: Date.now().toString(), name, address: addr, templateName: tpl, noReport: noRep });
    }
    saveState(); renderLocations(); closeModal('location'); syncForms();
}

function deleteLoc() {
    const id = document.getElementById('locId').value;
    if(id === 'travel') return alert("Cannot delete Travelling tile.");
    if(confirm('Delete location?')) {
        state.locations = state.locations.filter(l => l.id !== id);
        if(state.selectedLocationId === id) state.selectedLocationId = null;
        saveState(); renderLocations(); closeModal('location');
    }
}

function getGpsAddress() {
    const btn = document.getElementById('btnGpsAddr');
    if(!navigator.geolocation) return alert("GPS not supported");
    
    btn.innerText = "...";
    btn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('locAddr').value = data.display_name || `${lat}, ${lon}`;
                btn.innerText = "üìç GPS";
                btn.disabled = false;
            })
            .catch(() => {
                document.getElementById('locAddr').value = `${lat}, ${lon}`;
                btn.innerText = "üìç GPS";
                btn.disabled = false;
            });
    }, () => {
        alert("GPS Error");
        btn.innerText = "üìç GPS";
        btn.disabled = false;
    }, { timeout: 10000 });
}

// ==================== VISIT LOGIC ====================
function updateArrivedButtonState() {
    const val = DURATION_STEPS[document.getElementById('durationSlider').value];
    document.getElementById('durationDisplay').innerText = val + ' min';
    state.visitDurationMinutes = val;
    
    const btn = document.getElementById('btnStart');
    const btnQ = document.getElementById('btnQuick');
    
    if(state.selectedLocationId) {
        const l = state.locations.find(x => x.id === state.selectedLocationId);
        
        // Quick Stat Logic
        if(CONFIG.isAdv && !l.noReport) {
            btnQ.disabled = false; 
            btnQ.classList.replace('opacity-50','hover:bg-teal-500');
            btnQ.classList.replace('bg-teal-900','bg-teal-600');
            btnQ.classList.replace('text-teal-500','text-white');
        } else {
            btnQ.disabled = true;
            btnQ.classList.replace('hover:bg-teal-500','opacity-50');
            btnQ.classList.replace('bg-teal-600','bg-teal-900');
            btnQ.classList.replace('text-white','text-teal-500');
        }
        
        if(val > 0) {
            btn.disabled = false; 
            btn.innerText = 'HOLD TO START';
            btn.className = 'long-press-btn flex-[2] py-5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl shadow-lg transition-all';
            setupLongPress(btn, startVisit);
        } else {
            btn.disabled = true;
            btn.innerText = 'Set Duration';
            btn.className = 'long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl transition-all';
        }
    } else {
        btn.disabled = true;
        btn.innerText = 'Select Location';
    }
}

function startVisit() {
    const sel = state.locations.find(l => l.id === state.selectedLocationId);
    const now = new Date();
    state.activeVisit = {
        locationId: sel.id,
        startTime: now,
        anticipatedDepartureTime: new Date(now.getTime() + state.visitDurationMinutes * 60000),
        arrivalTimeForSheet: now.toISOString(),
        gpsStart: null,
        nextCheckin: CONFIG.checkinEnabled ? new Date(now.getTime() + CONFIG.checkinInterval * 60000) : null
    };
    
    playSoundAndVibrate('arrive');
    saveState();
    enterLockedScreen();
    requestWakeLock();

    // Fast GPS
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            state.activeVisit.gpsStart = pos.coords.latitude + ',' + pos.coords.longitude;
            processUploadQueue({ "Alarm Status": 'ON SITE', "Notes": "Visit Started" });
            saveState();
        }, () => {
            processUploadQueue({ "Alarm Status": 'ON SITE', "Notes": "Visit Started (GPS Slow)" });
        }, { timeout: 5000, maximumAge: 60000 });
    } else {
        processUploadQueue({ "Alarm Status": 'ON SITE', "Notes": "Visit Started (No GPS)" });
    }
}

function enterLockedScreen() {
    const l = state.locations.find(l => l.id === state.activeVisit.locationId) || {name: 'Unknown'};
    document.getElementById('lockedLocationName').innerText = l.name;
    navigate('locked');
    
    setupLongPress(document.getElementById('btnDepart'), () => preDepart(false));
    setupLongPress(document.getElementById('btnExtend'), extendVisit);
    
    const alertCont = document.getElementById('btnSafe');
    const departBtn = document.getElementById('btnDepart');
    
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(tick, 1000);
}

function tick() {
    if(!state.activeVisit) { clearInterval(timerInt); return; }
    const now = new Date();
    const due = new Date(state.activeVisit.anticipatedDepartureTime);
    const rem = due - now;
    
    // UI Update
    if(rem < 0) {
        document.getElementById('countdownTimer').innerText = 'OVERDUE';
        document.getElementById('countdownTimer').classList.replace('text-white', 'text-red-500');
        alertCont.classList.remove('hidden');
        setupLongPress(alertCont, () => iAmSafe());
        departBtn.classList.add('hidden');
        if(Math.floor(rem/1000) % 15 === 0) playSoundAndVibrate('warning'); 
    } else {
        const m = Math.floor(rem/60000);
        const s = Math.floor((rem%60000)/1000);
        document.getElementById('countdownTimer').innerText = `${m}:${s<10?'0':''}${s}`;
        document.getElementById('countdownTimer').classList.replace('text-red-500', 'text-white');
        document.getElementById('lockedAnticipatedTime').innerText = due.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        alertCont.classList.add('hidden');
        departBtn.classList.remove('hidden');
    }
    
    // Periodic Check-in
    if(CONFIG.checkinEnabled && state.activeVisit.nextCheckin && now > new Date(state.activeVisit.nextCheckin)) {
        triggerCheckin();
    }
}

function triggerCheckin() {
    if(!document.getElementById('checkinModal').classList.contains('hidden')) return;
    showModal('checkin');
    let rem = 120;
    const el = document.getElementById('checkinCountdown');
    
    if(checkinIntervalId) clearInterval(checkinIntervalId);
    playSoundAndVibrate('checkin');
    
    checkinIntervalId = setInterval(() => {
        rem--;
        const m = Math.floor(rem/60); const s = rem%60;
        el.innerText = `${m}:${s<10?'0':''}${s}`;
        
        if(rem === 60 || rem === 30 || rem === 10) playSoundAndVibrate('checkin');
        
        if(rem <= 0) {
            clearInterval(checkinIntervalId);
            closeModal('checkin');
            sendToGoogleSheet({ "Alarm Status": 'MISSED_CHECKIN', "Notes": "Worker failed to respond to check-in" });
            alert('MISSED CHECK-IN ALERT SENT');
        }
    }, 1000);
    
    document.getElementById('checkinOkBtn').onclick = () => {
        clearInterval(checkinIntervalId);
        closeModal('checkin');
        state.activeVisit.nextCheckin = new Date(Date.now() + CONFIG.checkinInterval*60000); 
        saveState();
    };
}

function confirmCheckin() {
    clearInterval(checkinIntervalId); 
    closeModal('checkin'); 
    state.activeVisit.nextCheckin = new Date(Date.now() + CONFIG.checkinInterval*60000); 
    saveState();
}

function extendVisit() {
    withPinVerification(false, () => {
        state.activeVisit.anticipatedDepartureTime = new Date(new Date(state.activeVisit.anticipatedDepartureTime).getTime() + 15 * 60000);
        saveState();
        playSoundAndVibrate('extend');
        sendToGoogleSheet({ "Alarm Status": 'EXTENDED', "Notes": "Extended 15m" });
    });
}

function triggerPanic() {
    if(confirm('CONFIRM SOS ALERT?')) {
        playSoundAndVibrate('panic');
        sendToGoogleSheet({ "Alarm Status": 'EMERGENCY - PANIC BUTTON', "Notes": "Panic Button Pressed" });
        alert('PANIC ALERT SENT');
    }
}

function iamSafe() {
    withPinVerification(false, () => {
        playSoundAndVibrate('safe');
        sendToGoogleSheet({ "Alarm Status": 'SAFE - MANUALLY CLEARED', "Notes": "Worker confirmed safe" });
        preDepart(true);
    });
}

// ==================== REPORTING ENGINE ====================
function preDepart(isSafeFlow) {
    const proceed = () => {
        if(!CONFIG.isAdv) { depart(); return; }
        const l = state.locations.find(l => l.id === state.activeVisit.locationId);
        if(l && l.noReport) { depart(); return; }

        showModal('report');
        const div = document.getElementById('reportFields');
        div.innerHTML = '';
        
        // Mileage
        if(l.id === 'travel' && CONFIG.mileage) {
           navigator.geolocation.getCurrentPosition(pos => {
             const end = pos.coords.latitude+','+pos.coords.longitude;
             if(state.activeVisit.gpsStart) {
               const km = calcDist(state.activeVisit.gpsStart, end);
               setTimeout(() => { 
                   const inp = document.querySelector('input[data-key="$Distance (km)"]');
                   if(inp) inp.value = km; 
               }, 500);
             }
           });
        }
        
        buildReportForm(l.templateName, div);
        document.getElementById('btnSubmitRep').onclick = submitReport;
    };

    // FIX v28: PIN only needed if OVERDUE, unless already verified (isSafeFlow)
    const now = new Date();
    const due = new Date(state.activeVisit.anticipatedDepartureTime);
    const isOverdue = (due - now) < 0;
    
    if(isSafeFlow || !isOverdue) {
        proceed();
    } else {
        withPinVerification(false, proceed);
    }
}

function quickStat() {
    if(!state.selectedLocationId) return;
    const l = state.locations.find(x => x.id === state.selectedLocationId);
    state.activeVisit = { locationId: l.id, startTime: new Date().toISOString() };
    showModal('report');
    const div = document.getElementById('reportFields');
    div.innerHTML = '';
    buildReportForm(l.templateName, div);
    document.getElementById('btnSubmitRep').onclick = () => {
        const d = gatherFormData();
        const data = {
            "Location Name": l.name,
            "Location Address": l.address,
            "Alarm Status": "DATA_ENTRY_ONLY",
            "Notes": d.notes,
            "Visit Report Data": JSON.stringify(d.jsonPayload)
        };
        
        if(d.photo1) data["Photo 1"] = d.photo1;
        if(d.custom["$Distance (km)"]) data["Distance"] = d.custom["$Distance (km)"];
        
        sendToGoogleSheet(data);
        state.activeVisit = null; tempPhoto = null; sigPad = null;
        closeModal('report');
    };
}

function buildReportForm(templateName, container) {
    const tpl = state.cachedForms[templateName] || state.cachedForms["(Standard)"] || [];
    
    // Fallback if empty
    if(tpl.length === 0) {
        container.innerHTML = '<label class="block text-sm text-gray-400">Notes</label><textarea id="rep_notes" class="form-input h-32"></textarea>';
    } else {
        tpl.forEach(f => {
            let html = '';
            if(f.type==='header') html = `<h3 class="text-blue-400 font-bold mt-4 border-b border-gray-700 pb-1">${f.text}</h3>`;
            else if(f.type==='note') html = `<p class="text-gray-500 text-sm italic my-2">${f.text}</p>`;
            else if(f.type==='text') html = `<label class="block text-sm text-gray-300 mt-2">${f.text}</label><textarea data-key="${f.text}" class="form-input h-24"></textarea>`;
            else if(f.type==='number') html = `<label class="block text-sm text-gray-300 mt-2">${f.text}</label><input type="number" step="any" data-key="${f.text}" class="form-input">`;
            else if(f.type==='check') html = `<label class="flex items-center gap-3 mt-3 p-3 bg-gray-900 rounded"><input type="checkbox" data-key="${f.text}" class="w-5 h-5"><span class="text-gray-300">${f.text}</span></label>`;
            else if(f.type==='yesno') html = `<div class="mt-3"><span class="text-sm text-gray-300 block mb-1">${f.text}</span><div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="${f.text}" value="Yes" data-key="${f.text}"> Yes</label><label class="flex items-center gap-2"><input type="radio" name="${f.text}" value="No" data-key="${f.text}"> No</label></div></div>`;
            else if(f.type==='photo') html = `<label class="block text-sm text-gray-300 mt-4">${f.text}</label><input type="file" accept="image/*" class="w-full text-sm text-gray-500 mt-2" onchange="handlePhoto(this)">`;
            else if(f.type==='gps') html = `<button onclick="captureGPS(this, '${f.text}')" class="mt-2 text-xs bg-blue-900 text-blue-200 px-3 py-2 rounded">üìç Capture Location</button><input type="hidden" data-key="${f.text}">`;
            else if(f.type==='signature') html = `<label class="block text-sm text-gray-300 mt-4">${f.text}</label><canvas id="sig-canvas" width="300" height="150" class="border border-gray-600 bg-white touch-none"></canvas><button onclick="clearSig()" class="text-xs text-red-400 mt-1">Clear</button>`;
            container.innerHTML += html;
        });
    }
    
    const canvas = document.getElementById('sig-canvas');
    if(canvas) initSigPad(canvas);
}

// --- SIGNATURE LOGIC ---
function initSigPad(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 2; ctx.strokeStyle = "#000";
    let drawing = false;
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const {x,y} = getPos(e); ctx.moveTo(x,y); };
    const move = (e) => { if(!drawing) return; e.preventDefault(); const {x,y} = getPos(e); ctx.lineTo(x,y); ctx.stroke(); };
    const end = () => { drawing = false; };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);
    sigPad = canvas;
}
function clearSig() { if(sigPad) { const ctx = sigPad.getContext('2d'); ctx.clearRect(0,0,sigPad.width,sigPad.height); } }

function gatherFormData() {
    const data = { custom: {}, notes: '', sig: null, jsonPayload: {} };
    const stdNotes = document.getElementById('rep_notes');
    if(stdNotes) data.notes = stdNotes.value;

    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        let val = el.value;
        if(el.type === 'checkbox') val = el.checked ? 'Yes' : 'No';
        else if(el.type === 'radio') { if(!el.checked) return; val = el.value; }
        
        data.custom[key] = val;
        data.jsonPayload[key] = val;
    });
    
    if(sigPad) data.sig = sigPad.toDataURL('image/png');
    return data;
}

function submitReport() {
    const d = gatherFormData();
    depart(d);
}

function depart(reportData = {}) {
    playSoundAndVibrate('depart');
    
    let noteStr = reportData.notes || "";
    if(reportData.custom) {
        Object.keys(reportData.custom).forEach(k => {
            if(reportData.custom[k]) noteStr += `\n[${k}: ${reportData.custom[k]}]`;
        });
    }

    const data = {
        "Alarm Status": 'DEPARTED',
        "Notes": noteStr,
        "Visit Report Data": JSON.stringify(reportData.jsonPayload || {})
    };
    
    if(tempPhoto) data["Photo 1"] = tempPhoto;
    if(reportData.sig) {
        if(!data["Photo 1"]) data["Photo 1"] = reportData.sig;
        else data["Notes"] += " [Signature Included]";
    }

    sendToGoogleSheet(data);
    
    state.activeVisit = null; tempPhoto = null; sigPad = null;
    saveState();
    closeModal('report');
    navigate('main');
    updateArrivedButtonState();
}

// --- MODALS & UTILS ---
function showModal(id) {
    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
    document.getElementById(id === 'location' ? 'locationModal' : id === 'pin' ? 'pinModal' : id === 'report' ? 'modal-report' : id === 'checkin' ? 'checkinModal' : 'infoModal').classList.remove('hidden');
}
function closeModal(id) {
    document.getElementById('modalBackdrop').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.remove('flex');
    document.getElementById(id === 'location' ? 'locationModal' : id === 'pin' ? 'pinModal' : id === 'report' ? 'modal-report' : id === 'checkin' ? 'checkinModal' : 'infoModal').classList.add('hidden');
    document.getElementById('checkinModal').classList.add('hidden');
}
function withPinVerification(isDuressAction, callback) {
    showModal('pin');
    const input = document.getElementById('pinInput');
    input.value = ''; input.focus();
    
    const confirm = () => {
        const val = input.value;
        closeModal('pin');
        if(val === state.settings.pinCode) callback();
        else if(val === state.settings.duressPin) {
            sendToGoogleSheet({ "Alarm Status": "DURESS_CODE_ACTIVATED", "Notes": "Silent Alarm" });
            if(isDuressAction) callback();
            else alert("PIN Accepted");
        } else {
            alert("Incorrect PIN");
        }
        document.getElementById('confirmPinBtn').removeEventListener('click', confirm);
    };
    document.getElementById('confirmPinBtn').addEventListener('click', confirm);
    document.getElementById('cancelPinBtn').onclick = () => closeModal('pin');
}

function handlePhoto(input) {
    if(input.files[0]) {
        document.getElementById('btnSubmitRep').innerText = "Compressing...";
        document.getElementById('btnSubmitRep').disabled = true;
        compressImg(input.files[0]).then(b64 => {
            tempPhoto = b64;
            document.getElementById('btnSubmitRep').innerText = "Submit";
            document.getElementById('btnSubmitRep').disabled = false;
        });
    }
}

function captureGPS(btn, key) {
    btn.innerText = "Locating...";
    navigator.geolocation.getCurrentPosition(p => {
        const coords = p.coords.latitude + "," + p.coords.longitude;
        btn.innerText = "‚úÖ " + coords;
        btn.nextElementSibling.value = coords;
    });
}

// --- NETWORK ---
function sendToGoogleSheet(data) {
    if(!state.settings.googleSheetUrl) return;
    const payload = {
        'Worker Name': state.settings.workerName, 'Worker Phone Number': state.settings.workerPhone,
        'Emergency Contact Name': state.settings.emergencyName, 'Emergency Contact Number': state.settings.emergencyPhone, 'Emergency Contact Email': state.settings.emergencyEmail,
        'Escalation Contact Name': state.settings.escalationName, 'Escalation Contact Number': state.settings.escalationPhone, 'Escalation Contact Email': state.settings.escalationEmail,
        ...data, 'Timestamp': new Date().toISOString()
    };
    
    // v21 FIX: ADD BATTERY
    if(navigator.getBattery) {
        navigator.getBattery().then(b => {
            payload['Battery Level'] = Math.round(b.level * 100) + "%";
            finalizeSend(payload);
        });
    } else {
        finalizeSend(payload);
    }
}

function finalizeSend(payload) {
    navigator.geolocation.getCurrentPosition(pos => {
        payload['Last Known GPS'] = pos.coords.latitude + ',' + pos.coords.longitude;
        processUploadQueue(payload);
    }, () => { payload['Last Known GPS'] = 'GPS Unavailable'; processUploadQueue(payload); });
}

function processUploadQueue(newData = null) {
    if(newData) {
        state.pendingUploads.push(newData);
        saveState();
    }

    if(!navigator.onLine) {
        document.getElementById('queueCount').innerText = state.pendingUploads.length;
        document.getElementById('uploadBanner').classList.remove('hidden');
        return;
    }

    if(state.pendingUploads.length > 0) {
        document.getElementById('uploadBanner').classList.remove('hidden');
        document.getElementById('queueCount').innerText = state.pendingUploads.length;
        
        const item = state.pendingUploads[0];
        const fd = new FormData();
        for(let k in item) fd.append(k, item[k]);
        
        fetch(state.settings.googleSheetUrl, { method: 'POST', mode: 'no-cors', body: fd })
            .then(() => {
                state.pendingUploads.shift(); // Remove on success
                saveState();
                processUploadQueue(); // Recursive
            })
            .catch(() => {
                // Keep in queue on fail
                document.getElementById('uploadBanner').classList.remove('hidden');
            });
    } else {
        document.getElementById('uploadBanner').classList.add('hidden');
    }
}

function saveState() { localStorage.setItem('loneWorkerState', JSON.stringify(state)); }
function saveSettings() {
  const name = document.getElementById('set_name').value.trim();
  const phone = document.getElementById('set_phone').value.trim();
  const emgName = document.getElementById('set_emg_name').value.trim();
  const emgPhone = document.getElementById('set_emg_phone').value.trim();
  const emgEmail = document.getElementById('set_emg_email').value.trim();
  const escName = document.getElementById('set_esc_name').value.trim();
  const escPhone = document.getElementById('set_esc_phone').value.trim();
  const escEmail = document.getElementById('set_esc_email').value.trim();
  const pin = document.getElementById('set_pin').value.trim();
  const duressPin = document.getElementById('set_duress').value.trim();

  if(!name || !phone) return alert("Please enter your Name and Phone.");
  if(!emgName || !emgPhone) return alert("Emergency Contact details are required.");
  if(!pin || pin.length !== 4) return alert("Normal PIN must be 4 digits.");
  if(!duressPin || duressPin.length !== 4) return alert("Duress PIN must be 4 digits.");
  if(pin === duressPin) return alert("Normal PIN and Duress PIN cannot be the same.");

  state.settings = {
    workerName: name, workerPhone: phone,
    emergencyName: emgName, emergencyPhone: emgPhone, emergencyEmail: emgEmail,
    escalationName: escName, escalationPhone: escPhone, escalationEmail: escEmail,
    pinCode: pin, duressPin: duressPin,
    googleSheetUrl: CONFIG.url
  };
  saveState(); navigate('main'); 
  document.getElementById('btnCloseSettings').style.display = 'block';
  renderLocations(); updateArrivedButtonState();
}
function clearData() {
    if(confirm('Reset all data?')) { localStorage.clear(); location.reload(); }
}
function setupLongPress(btn, cb) {
  let t; const start = (e) => { e.preventDefault(); btn.classList.add('pressing'); t = setTimeout(() => { cb(); end(); }, 1500); };
  const end = () => { clearTimeout(t); btn.classList.remove('pressing'); };
  btn.onmousedown = btn.ontouchstart = start; btn.onmouseup = btn.ontouchend = btn.onmouseleave = end;
}
function compressImg(f) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'), s=Math.min(1024/i.width,1024/i.height,1); c.width=i.width*s; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.6)); }; i.src=e.target.result; }; rd.readAsDataURL(f); }); }
function calcDist(p1,p2) { if(!p1||!p2)return 0; const[y1,x1]=p1.split(',').map(Number),[y2,x2]=p2.split(',').map(Number),R=6371,dLat=(y2-y1)*Math.PI/180,dLon=(x2-x1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(y1*Math.PI/180)*Math.cos(y2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2); }
async function requestWakeLock() { if('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} } }
function syncForms() {
    if(!CONFIG.url) return;
    const comps = [...new Set(state.locations.map(l => l.templateName).filter(Boolean))];
    comps.push("(Standard)", "Travel Report");
    comps.forEach(c => { fetch(`${CONFIG.url}?action=getForms&companyName=${encodeURIComponent(c)}`).then(r => r.json()).then(j => { state.cachedForms[c] = j; saveState(); }); });
}
function clearFormsCache() { state.cachedForms = {}; syncForms(); alert("Forms Syncing..."); }

function getGpsAddress() {
    const btn = document.getElementById('btnGpsAddr');
    if(!navigator.geolocation) return alert("GPS not supported");
    
    btn.innerText = "...";
    btn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('locAddr').value = data.display_name || `${lat}, ${lon}`;
                btn.innerText = "üìç GPS";
                btn.disabled = false;
            })
            .catch(() => {
                document.getElementById('locAddr').value = `${lat}, ${lon}`;
                btn.innerText = "üìç GPS";
                btn.disabled = false;
            });
    }, () => {
        alert("GPS Error");
        btn.innerText = "üìç GPS";
        btn.disabled = false;
    }, { timeout: 10000 });
}
</script>
</body>
</html>
