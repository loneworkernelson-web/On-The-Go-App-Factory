<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>%%APP_NAME%%</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
/* 1. FORCE SYSTEM DIM: Toggling color-scheme is required to dim the OS navigation bar */
html.system-dim, body.system-dim { 
    background-color: #000000 !important; 
    color-scheme: dark !important; 
}

/* 2. BASE STYLES */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: #111827; color: white; height: 100%; width: 100%; overflow: hidden; }

/* FIX: This base .page class was missing, causing all pages to show at once */
.page { 
    display: none; 
    height: 100%; 
    width: 100%; 
    flex-direction: column; 
    position: absolute; 
    top: 0; 
    left: 0; 
    background-color: #111827; 
}

.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: #111827; border-bottom: 1px solid #374151; flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }

/* 3. UPDATED FOOTER: Adds safety padding for the navigation bar */
.footer-bar { 
    padding: 1rem; 
    padding-bottom: calc(1rem + env(safe-area-inset-bottom)); 
    background-color: #111827; 
    border-top: 1px solid #374151; 
    flex-shrink: 0; 
    z-index: 20; 
}
/* Optimized Long-Press SOS Styling */
.long-press-btn {
    position: relative;
    overflow: hidden;
    transition: transform 0.1s;
    user-select: none; /* Prevents text selection during the hold */
    -webkit-user-select: none;
}

.long-press-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background: rgba(255, 255, 255, 0.3);
    /* Transition for the reset (shrinks back quickly when released) */
    transition: width 0.2s ease-out; 
    z-index: 1;
}

/* When the button is held, the width expands over exactly 3 seconds */
.long-press-btn.holding::after {
    width: 100%;
    transition: width 3s linear;
}

/* Visual feedback for the initial press */
.long-press-btn:active {
    transform: scale(0.96);
}
.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.form-input-card { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.5rem; display: block; }
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }
.chip-btn { background-color: #374151; color: #e5e7eb; font-weight: 600; font-size: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #4b5563; flex: 1; transition: all 0.1s; }
.chip-btn:active { background-color: #2563eb; border-color: #3b82f6; transform: scale(0.95); }
.chip-btn.selected { background-color: #2563eb; border-color: #3b82f6; color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
.panic-mode { background-color: #7f1d1d !important; }
.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
.gps-bar.active-amber { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
.menu-icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; background: #374151; border-radius: 0.75rem; border: 1px solid #4b5563; text-align: center; padding: 0.5rem; transition: all 0.2s; }
.menu-icon-btn:active { background: #2563eb; transform: scale(0.95); }
.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
#toastMsg { z-index: 1000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-150%); }
#toastMsg.show { transform: translateY(0); }
#installBanner { animation: slideDown 0.5s ease-out; }
@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
.ios-arrow { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid #1f2937; }

</style>
</head>
<body class="bg-gray-900 text-white">

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-green-500 text-white px-4 py-3 rounded shadow-2xl flex items-center gap-3">
    <div class="text-xl">‚úÖ</div>
    <div><p class="font-bold text-sm" id="toastText">Operation Successful</p></div>
</div>

<div id="installBanner" class="hidden fixed top-0 left-0 w-full bg-blue-600 text-white p-4 z-[100] shadow-xl flex items-center justify-between">
    <div class="flex items-center gap-3">
        <span class="text-2xl">üì≤</span>
        <div><p class="font-bold text-sm">Install Safety App</p><p class="text-xs opacity-90">Add to home screen for safety monitoring.</p></div>
    </div>
    <div class="flex gap-2"><button onclick="dismissInstall('android')" class="px-3 py-1 text-xs font-bold bg-blue-700 rounded">Later</button><button onclick="triggerInstall()" class="px-4 py-1 text-xs font-black bg-white text-blue-600 rounded">Install</button></div>
</div>

<div id="app-container" class="relative h-full w-full">
<div id="offlineBanner" class="hidden absolute top-0 left-0 w-full bg-red-600 text-white text-center text-xs font-bold py-1 z-50">üì° OFFLINE MODE - Data queued for upload</div>
<div id="vehNagBar" class="hidden bg-orange-600 text-white text-center text-xs font-bold py-2 cursor-pointer z-40 border-b border-orange-400" onclick="startVehicleCheck()">‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete</div>

<div id="setupPage" class="page fixed inset-0 bg-gray-900 z-[60] flex flex-col overflow-hidden">
    <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-900 z-10">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1"><div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div><div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div><div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div></div>
    </div>
<div id="wizStep1" class="wizard-step active p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-white mb-2">Who are you?</h2>
    <p class="text-gray-400 mb-8 text-sm">Required for safety monitoring match.</p>
    
    <label for="wiz_name" class="setting-label lbl-blue">Full Name</label>
    <input type="text" id="wiz_name" class="form-input mb-4" placeholder="e.g. John Doe">
    
    <label for="wiz_phone" class="setting-label lbl-blue">Mobile Number</label>
    <input type="tel" id="wiz_phone" class="form-input mb-4" placeholder="021...">
    
    <label for="wiz_email" class="setting-label lbl-blue">Work Email</label>
    <input type="email" id="wiz_email" class="form-input mb-8" placeholder="name@org.co.nz">
    
    <div class="mt-auto">
        <button onclick="wizNext(1)" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Next: Security ‚Üí</button>
    </div>
</div>
<div id="wizStep2" class="wizard-step p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-white mb-2">Security Codes</h2>
    <p class="text-gray-400 mb-6 text-sm">These 4-digit codes are stored privately on this phone.</p>
    
    <div class="bg-gray-800 p-4 rounded-xl border border-green-500/30 mb-6">
        <label for="wiz_pin" class="block text-green-400 font-bold mb-1">1. Standard PIN</label>
        <p class="text-xs text-gray-300 mb-3">Used to declare "I AM SAFE".</p>
        <input id="wiz_pin" type="tel" maxlength="4" class="w-full bg-gray-900 border border-green-500/50 rounded p-3 text-center text-xl tracking-widest text-white outline-none focus:border-green-500" placeholder="0000">
    </div>

    <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 mb-8">
        <label for="wiz_duress" class="block text-purple-400 font-bold mb-1">2. Duress PIN (Silent)</label>
        <p class="text-xs text-gray-300 mb-3">Secretly sends a high-priority "DURESS" alert.</p>
        <input id="wiz_duress" type="tel" maxlength="4" class="w-full bg-gray-900 border border-purple-500/50 rounded p-3 text-center text-xl tracking-widest text-white outline-none focus:border-purple-500" placeholder="9999">
    </div>

    <div class="mt-auto">
        <button onclick="wizNext(2)" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Next: Contacts ‚Üí</button>
        <button onclick="wizBack(2)" class="w-full py-3 text-gray-400 font-bold mt-2">Back</button>
    </div>
</div>
    <div id="wizStep3" class="wizard-step p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-white mb-2">Emergency Contacts</h2>
    <p class="text-gray-400 mb-6 text-sm">These people will receive SMS/Email alerts.</p>
    
    <label for="wiz_emg_name" class="setting-label lbl-red">Primary Emergency Contact Name</label>
    <input id="wiz_emg_name" class="form-input-card" placeholder="Name">
    
    <label for="wiz_emg_phone" class="setting-label text-xs text-gray-500 mt-2">Primary Mobile Number</label>
    <input id="wiz_emg_phone" type="tel" class="form-input-card" placeholder="Mobile Number">
    
    <label for="wiz_emg_email" class="setting-label text-xs text-gray-500 mt-2">Primary Email Address</label>
    <input id="wiz_emg_email" type="email" class="form-input mb-6" placeholder="Email Address">

    <label for="wiz_esc_name" class="setting-label lbl-gray">Escalation Contact Name (Optional)</label>
    <input id="wiz_esc_name" class="form-input-card" placeholder="Name">
    
    <label for="wiz_esc_phone" class="setting-label text-xs text-gray-500 mt-2">Escalation Mobile Number</label>
    <input id="wiz_esc_phone" type="tel" class="form-input-card" placeholder="Mobile Number">
    
    <label for="wiz_esc_email" class="setting-label text-xs text-gray-500 mt-2">Escalation Email Address</label>
    <input id="wiz_esc_email" type="email" class="form-input mb-8" placeholder="Email Address">

    <div class="mt-auto">
        <button onclick="wizSave()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">
            ‚úÖ Save & Launch App
        </button>
        <button onclick="wizBack(3)" class="w-full py-3 text-gray-400 font-bold mt-2">Back</button>
    </div>
</div>
</div>

<div id="settingsPage" class="page bg-gray-800">
    <div class="header-bar">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    
    <div class="content-area pb-24"> 
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4">
            <p class="text-xs text-blue-200 font-bold">Restart the onboarding process?</p>
            <button onclick="startWizard()" class="mt-2 text-xs bg-blue-600 px-2 py-1 rounded font-bold">Restart Setup Wizard</button>
        </div>

        <div class="setting-card border-gray-600">
            <div class="setting-label lbl-blue">Your Identity</div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Full Name</label>
                    <input id="set_workerName" class="form-input-card text-sm font-bold" readonly placeholder="Not Set">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Mobile Number</label>
                    <input id="set_workerPhone" class="form-input-card text-sm font-bold" readonly placeholder="Not Set">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Work Email</label>
                    <input id="set_workerEmail" class="form-input-card text-sm font-bold" readonly placeholder="Not Set">
                </div>
            </div>
        </div>

        <div class="setting-card border-gray-600">
            <div class="setting-label lbl-gray">Cloud & Storage</div>
            <input id="set_url" disabled class="form-input-card text-[10px] font-mono text-gray-500 mb-2" value="%%GOOGLE_SHEET_URL%%">
            <div class="flex gap-2">
                <button onclick="forceSync(true)" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-[10px] font-black text-white uppercase shadow-lg">Force Sync</button>
                <button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-[10px] font-black text-white uppercase">Clear Cache</button>
                <button onclick="clearData()" class="flex-1 bg-red-900/50 text-red-400 hover:bg-red-900/70 py-2 rounded text-[10px] font-black uppercase">Reset App</button>
            </div>
        </div>

        <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center px-2">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest">App Version</span>
                <span id="diagApp" class="text-xs text-gray-400 font-bold">---</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest">Cloud Version</span>
                <span id="diagCloud" class="text-xs text-gray-400 font-bold">---</span>
            </div>
        </div>
    </div> 
</div>
<div id="mainPage" class="page active">
    <div class="header-bar">
        <div class="flex items-center gap-2"><img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'"> <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1></div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end gap-0.5" id="gpsContainer"><span class="text-[8px] text-gray-500 font-bold uppercase tracking-widest leading-none">GPS</span><div class="flex gap-0.5" id="gpsBars"><div id="gps1" class="gps-bar"></div><div id="gps2" class="gps-bar"></div><div id="gps3" class="gps-bar"></div></div><div id="gpsError" class="hidden text-red-500 font-bold text-xs animate-pulse">‚ùå NO SIG</div></div>
            <button onclick="navigate('settings')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="content-area">
        <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 font-bold uppercase tracking-widest"><div class="spinner"></div><span>Syncing...</span></div>
        <div class="flex gap-2 mb-4"><button onclick="forceSync(true)" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-blue-400 text-2xl shadow-lg active:scale-95 transition" title="Sync Database">‚Üª</button><button onclick="openLocModal()" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-green-400 text-2xl shadow-lg active:scale-95 transition" title="Add Destination">+</button><div id="travelRow" class="flex-1"></div></div>
        <div class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-3 ml-1">Safety Destinations</div>
        <div id="locationList" class="grid grid-cols-2 gap-3 pb-4"></div>
    </div>
<div class="footer-bar">
    <div class="flex justify-end items-center gap-2 mb-2">
        <span class="text-[10px] font-bold text-gray-500 tracking-widest" id="lblHighRisk">Critical timing mode</span>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="chkHighRisk" class="sr-only peer" onchange="toggleHighRiskUI()">
          <div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
        </label>
    </div>
    <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
        <div class="flex justify-between mb-2 font-black tracking-tighter"><span class="text-gray-400 text-[10px]">Estimated visit time</span><span id="durationDisplay" class="text-xs text-blue-400">0 mins</span></div>
        <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateArrivedButtonState()">
    </div>
    <div class="flex gap-4">
        <button id="btnQuick" onclick="openQuickMenu()" class="flex-none w-24 py-4 bg-violet-900 text-violet-300 font-bold rounded-xl border border-violet-700/50 shadow-lg active:scale-95 transition text-xs tracking-widest">Forms</button>
        <button type="button" id="btnStart" class="long-press-btn flex-1 py-4 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all tracking-tight" disabled>Start</button>
    </div>
</div>
</div>

<div id="batterySaver" class="hidden fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center pointer-events-none select-none">
    <div class="absolute inset-0 bg-white/5 opacity-0 transition-opacity duration-[1500ms]" id="saverProgress"></div>
    <div class="text-gray-800 text-sm font-bold animate-pulse uppercase tracking-[0.3em] z-10">Battery Saver Active</div>
    <div class="text-gray-900 text-[10px] uppercase font-black tracking-widest mt-4 z-10 border border-gray-900 px-4 py-2 rounded-full">Hold screen to wake</div>
</div>

<div id="lockedPage" class="page">
    <div class="flex-1 flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <button onclick="toggleBatterySaver()" class="p-2 bg-gray-800 rounded-full text-yellow-400 border border-gray-600 hover:bg-gray-700 shadow-xl" aria-label="Toggle Dark Mode">üåô</button>
            <button id="btnPanic" class="long-press-btn w-24 h-24 bg-red-600 rounded-full font-black text-white text-2xl border-4 border-red-800 shadow-2xl flex items-center justify-center select-none tracking-widest">
                SOS
            </button>
        </div>

        <div class="text-center">
            <div class="setting-label lbl-blue">Active Visit</div>
            
            <p class="text-gray-500 text-xs uppercase font-black tracking-[0.3em] mt-2">Currently Active At</p>
            <div class="flex items-center justify-center gap-2 mt-1 mb-2 cursor-pointer hover:bg-gray-800 rounded p-2 transition" onclick="showCurrentSiteInfo()">
                <h2 id="lockedLocationName" class="text-3xl font-bold text-white truncate max-w-[250px] tracking-tight"></h2>
                <span class="text-blue-400 text-xl">‚ÑπÔ∏è</span>
            </div>
            
            <div id="highRiskBadge" class="hidden text-red-500 font-black text-xs uppercase tracking-widest border border-red-500 inline-block px-3 py-1 rounded-lg mb-2">‚ö° CRITICAL TIMING MODE</div>
            <div id="overdueLabel" class="hidden text-red-500 font-black text-2xl animate-pulse my-2 tracking-[0.2em] border-2 border-red-500 inline-block px-6 py-2 rounded-xl uppercase">OVERDUE</div>
            
            <div id="countdownTimer" class="text-8xl font-bold font-mono text-white tracking-tighter">00:00</div>
            
            <div class="setting-label lbl-red mt-4">Manual SOS</div>
            
            <p class="text-gray-400 mt-2 font-bold uppercase text-[12px] tracking-widest">Scheduled Departure: <span id="lockedAnticipatedTime" class="text-blue-400"></span></p>
        </div>

        <div class="space-y-3 w-full">
            <div class="flex gap-3">
                <button id="btnExtend" class="long-press-btn flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl text-lg shadow-lg uppercase tracking-widest" onclick="showModal('extend')">Extend</button>
                <button onclick="openMidVisitMenu()" class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-black rounded-2xl text-lg shadow-lg uppercase tracking-widest">Notes</button>
            </div>
            <button id="btnDepart" class="long-press-btn w-full py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl text-xl shadow-2xl uppercase tracking-[0.2em]">Hold to END</button>
            <button id="btnSafe" class="hidden long-press-btn w-full py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl text-xl shadow-2xl animate-pulse uppercase tracking-[0.2em]">I AM SAFE</button>
        </div>
    </div>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
    <div id="infoModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto border border-gray-700">
        <h2 id="infoTitle" class="text-2xl font-black text-white mb-4 tracking-tight border-b border-gray-700 pb-2">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm space-y-3 mb-6 font-medium"></div>
        <div class="flex gap-3 mb-4">
            <a id="btnSiteCall" href="#" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest hidden shadow-lg">üìû Call</a>
            <a id="btnSiteEmail" href="#" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest hidden shadow-lg">‚úâÔ∏è Email</a>
        </div>
        <a id="btnSiteNav" href="#" target="_blank" class="block w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-black rounded-xl text-center mb-4 hidden shadow-xl uppercase tracking-widest">üó∫Ô∏è Navigate to Site</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 text-gray-300 font-black rounded-xl uppercase tracking-widest border border-gray-600">Close</button>
    </div>

    <div id="extendModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center border border-gray-700">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Extend Visit</h2>
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="confirmExtension(10)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+10</button>
            <button onclick="confirmExtension(15)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+15</button>
            <button onclick="confirmExtension(30)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+30</button>
        </div>
        <button onclick="closeModal('extend')" class="w-full py-4 bg-gray-700 hover:bg-gray-600 rounded-xl font-black text-gray-400 uppercase tracking-widest border border-gray-600">Cancel</button>
    </div>

    <div id="pinModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center border border-gray-700">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Security PIN</h2>
        <input type="password" id="pinInput" maxlength="4" class="text-center text-4xl tracking-[0.5em] w-full bg-gray-900 border-2 border-gray-700 rounded-xl py-4 text-white focus:outline-none focus:border-blue-500 font-mono shadow-inner mb-6" inputmode="numeric">
        <div class="grid grid-cols-2 gap-3">
            <button id="cancelPinBtn" onclick="closeModal('pin')" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-black py-3 rounded-xl uppercase text-xs tracking-widest border border-gray-600">Cancel</button>
            <button id="confirmPinBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-xl shadow-lg uppercase text-xs tracking-widest">Confirm</button>
        </div>
    </div>

    <div id="templateModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center border border-gray-700">
        <h2 id="modalMenuTitle" class="text-xl font-black mb-6 text-white uppercase tracking-widest">Select Form</h2>
        <div id="templateList" class="grid grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
        <button onclick="closeModal('template')" class="mt-6 w-full py-4 bg-gray-700 hover:bg-gray-600 rounded-xl font-black text-white uppercase tracking-widest border border-gray-600">Cancel</button>
    </div>

<div id="reportModal" class="hidden bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl">
    <h2 class="text-2xl font-bold text-white mb-6 flex-shrink-0" id="reportTitle">Report</h2>
    
    <div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2"></div>
    
    <div class="flex gap-3 flex-shrink-0 border-t border-gray-700 pt-4">
        <button onclick="closeModal('report')" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button>
        <button id="btnSubmitRep" class="long-press-btn flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit & END</button>
    </div>
</div>

    <div id="checkinModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center border-4 border-yellow-500">
        <h2 class="text-3xl font-black text-yellow-400 mb-2 uppercase tracking-tighter">Are you OK?</h2>
        <p class="text-lg text-gray-300 mb-6 font-bold leading-tight">Scheduled Safety Check-in Required.</p>
        <div id="checkinCountdown" class="text-7xl font-black text-yellow-400 mb-8 font-mono tracking-tighter">2:00</div>
        <button id="btnCheckinConfirm" class="long-press-btn w-full bg-green-600 hover:bg-green-500 text-white font-black py-5 px-4 rounded-2xl text-2xl shadow-2xl uppercase tracking-widest">Hold to Confirm</button>
    </div>

    <div id="locationModal" class="hidden bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-50 border border-gray-700">
        <h2 id="locModalTitle" class="text-xl font-black mb-6 text-white uppercase tracking-widest">Edit Destination</h2>
        <input type="hidden" id="locId">
        <div class="space-y-4">
            <div><label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Business Name</label><input type="text" id="locBusiness" class="form-input" placeholder="Optional"></div>
            <div><label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Site Name</label><input type="text" id="locName" class="form-input" placeholder="Required"></div>
            <div><label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Physical Address</label><div class="flex gap-2"><input type="text" id="locAddr" class="form-input mb-0 flex-1 font-medium"><button onclick="getGpsAddress()" id="btnGpsAddr" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl font-black text-xs shrink-0 shadow-lg uppercase">üìç GPS</button></div></div>
            <div id="advLocOptions" class="pt-4 border-t border-gray-700">
                <div class="mb-4 bg-gray-900 p-3 rounded-xl shadow-inner">
                    <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest block mb-3">Report Required on Departure?</label>
                    <div class="flex gap-8">
                        <label class="flex items-center gap-3 cursor-pointer"><input type="radio" name="reportReq" id="radRepYes" class="w-6 h-6 text-blue-600"> <span class="text-sm text-white font-black uppercase">Yes</span></label>
                        <label class="flex items-center gap-3 cursor-pointer"><input type="radio" name="reportReq" id="radRepNo" class="w-6 h-6 text-red-500"> <span class="text-sm text-gray-400 font-black uppercase">No</span></label>
                    </div>
                </div>
                <div><label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Specific Form Template</label><input type="text" id="locTemplate" class="form-input text-sm font-bold" placeholder="(Standard Visit)"></div>
            </div>
        </div>
        <div class="mt-8 flex justify-between gap-3">
            <button onclick="deleteLoc()" id="btnDelLoc" class="bg-red-900/50 text-red-400 font-black py-3 px-6 rounded-xl hidden uppercase text-xs tracking-widest border border-red-800/30">Delete</button>
            <div class="flex-1"></div>
            <button onclick="closeModal('location')" class="bg-gray-700 hover:bg-gray-600 text-white font-black py-3 px-6 rounded-xl uppercase text-xs tracking-widest">Cancel</button>
            <button onclick="saveLoc()" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 px-8 rounded-xl shadow-xl uppercase text-xs tracking-widest">Save</button>
        </div>
    </div>

    <div id="wofBlockModal" class="hidden bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-10 text-center border-4 border-red-600 animate-pulse">
        <div class="text-7xl mb-6">‚õî</div>
        <h2 class="text-3xl font-black text-red-500 mb-4 uppercase tracking-tighter">STOP</h2>
        <p class="text-lg text-white font-bold mb-6">This vehicle has an EXPIRED WOF or Registration. It is prohibited for work use.</p>
        <button onclick="closeWofBlocker()" class="w-full py-5 bg-red-600 text-white font-black rounded-2xl text-xl shadow-2xl">I Understand</button>
    </div>

    <div id="wofWarnModal" class="hidden bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center border-4 border-orange-500">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-black text-orange-500 mb-2 uppercase tracking-tight">VEHICLE COMPLIANCE</h2>
        <p class="text-white font-bold mb-6">Vehicle WOF or Rego is expiring soon:<br><span id="wofWarnText" class="text-2xl text-orange-400 font-black"></span></p>
        <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 text-left mb-6">
            <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="chkWofAck" class="mt-1 w-6 h-6 rounded text-blue-600" onchange="toggleWofContinue()">
                <span class="text-sm text-gray-300 font-bold">I acknowledge the vehicle is legal and safe to operate.</span>
            </label>
        </div>
        <button id="btnWofContinue" disabled onclick="closeWofWarn()" class="w-full py-4 bg-gray-700 text-gray-500 font-black rounded-2xl text-lg transition-all">Continue</button>
    </div>
 </div> 
<script>
// CONFIG & CONSTANTS
const APP_VERSION = "v79.35"; // Diagnostic constant
const CONFIG={isAdv:%%IS_ADVANCED%%,mileage:%%ENABLE_MILEAGE%%,url:"%%GOOGLE_SHEET_URL%%",org:"%%ORGANISATION_NAME%%",checkinEnabled:%%CHECKIN_ENABLED%%,checkinInterval:%%CHECKIN_INTERVAL%%,escalationMinutes:%%ESCALATION_MINUTES%%,key:"%%SECRET_KEY%%",vehEnabled:%%VEHICLE_ENABLED%%,vehInterval:%%VEHICLE_INTERVAL%%, countryPrefix:"%%COUNTRY_PREFIX%%", reqTravelReport: %%REQ_TRAVEL_REPORT%%, vehicleTerm: "%%VEHICLE_TERM%%", voiceLocale: "%%VOICE_LOCALE%%"};const DURATION_MAP=[0,10,15,20,30,45,60,75,90,105,120,150,180,210,240,270,300,360,420,480,540,600,660,720];
// CORE STATE
let state={settings:{},locations:[],selectedLocationId:null,visitDurationMinutes:0,activeVisit:null,cachedForms:{},pendingUploads:[],globalForms:[],photoStore:{},lowBatSent:false,meta:{}};
let synth,checkinIntervalId,mainScreenReminderTimer,wakeLock,timerInt,travellingInterval;
let autoDimTimer; // Tracks the 10s auto-dark-mode countdown
let tempPhoto=null,sigPad=null;
let deferredPrompt,isMidVisitUpdate=false,currentActiveTemplate="",isDrawing=false;
let calculatedDist=null,gpsWarm=false,gpsWatchId=null,lastAlertTime=0;
let currentBatteryLevel="100%";
let uploadQueue = []; // Holds data for the sheet
let travelTargetName = ""; // Tracks where you are driving to
// --- WIZARD NAVIGATION (Must be Global) ---
function wizNext(step) {
    if (step === 1) {
        const name = document.getElementById('wiz_name').value.trim();
        if (!name) { showToast("‚ö†Ô∏è Name is required."); return; }
    }
    const current = document.getElementById(`wizStep${step}`);
    const next = document.getElementById(`wizStep${step + 1}`);
    if (current && next) {
        current.classList.add('hidden');
        current.classList.remove('active');
        next.classList.remove('hidden');
        next.classList.add('active');
    }
}
function wizSave() {
    state.settings = {
        workerName: document.getElementById('wiz_name').value.trim(),
        workerPhone: document.getElementById('wiz_phone').value.trim(),
        workerEmail: document.getElementById('wiz_email').value.trim(),
        // Use the new wiz_url ID here if you need to capture it
        googleSheetUrl: CONFIG.scriptUrl, 
        pinCode: btoa(document.getElementById('wiz_pin').value.trim()),
        duressPin: btoa(document.getElementById('wiz_duress').value.trim()),
        emgName: document.getElementById('wiz_emg_name').value.trim(),
        emgPhone: document.getElementById('wiz_emg_phone').value.trim(),
        emgEmail: document.getElementById('wiz_emg_email').value.trim(),
        escName: document.getElementById('wiz_esc_name').value.trim(),
        escPhone: document.getElementById('wiz_esc_phone').value.trim(),
        escEmail: document.getElementById('wiz_esc_email').value.trim()
    };
    saveState();
    // Explicitly hide the setup overlay and show the main dashboard
    document.getElementById('setupPage').classList.add('hidden');
    navigate('main');
    forceSync(false);
    showToast("‚úÖ Setup Complete");
}
// MODAL CONTROLLERS
function showModal(id) {
    const backdrop = document.getElementById('modalBackdrop'); if (!backdrop) return;
    backdrop.classList.remove('hidden'); backdrop.classList.add('flex');
    const modals = ['locationModal','pinModal','reportModal','modal-report','checkinModal','extendModal','infoModal','templateModal','alertModal'];
    modals.forEach(m => { const el = document.getElementById(m); if(el) el.classList.add('hidden'); });
    const target = (id === 'report') ? (document.getElementById('reportModal') || document.getElementById('modal-report')) : document.getElementById(id + 'Modal');
    if (target) { target.classList.remove('hidden'); if (id === 'report') setTimeout(resizeCanvas, 300); }
}

function closeModal(id) {
    const backdrop = document.getElementById('modalBackdrop');
    if (backdrop) { backdrop.classList.add('hidden'); backdrop.classList.remove('flex'); }
    if (id) {
        const modalId = (id === 'location' || id === 'pin' || id === 'info' || id === 'template' || id === 'checkin' || id === 'extend' || id === 'alert') ? id + 'Modal' : (id === 'report' ? 'reportModal' : id);
        const el = document.getElementById(modalId); if (el) el.classList.add('hidden');
    }
}

// UI HELPERS
function showToast(msg) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.innerText = msg;
    t.classList.remove('hidden');
    // Hide after 4 seconds
    setTimeout(() => { t.classList.add('hidden'); }, 4000);
}
function toggleWofContinue(){ const chk=document.getElementById('chkWofAck'); const btn=document.getElementById('btnWofContinue'); btn.disabled=!chk.checked; if(chk.checked){ btn.classList.remove('bg-gray-700','text-gray-500'); btn.classList.add('bg-blue-600','text-white'); } else { btn.classList.add('bg-gray-700','text-gray-500'); btn.classList.remove('bg-blue-600','text-white'); } }
function closeWofBlocker(){document.getElementById('wofBlockModal').classList.add('hidden');}
function closeWofWarn(){document.getElementById('wofWarnModal').classList.add('hidden');}

// SITE MANAGEMENT
function openLocModal(){ document.getElementById('locModalTitle').innerText="Add Site"; document.getElementById('locId').value=""; document.getElementById('locBusiness').value=""; document.getElementById('locName').value=""; document.getElementById('locAddr').value=""; document.getElementById('locTemplate').value=""; document.getElementById('btnDelLoc').classList.add('hidden'); document.getElementById('radRepYes').checked=true; showModal('location'); }
function editManualLocation(id){ const l = state.locations.find(x => x.id === id); if(!l) return; document.getElementById('locModalTitle').innerText = "Edit Site"; document.getElementById('locId').value = id; document.getElementById('locBusiness').value = l.companyName || ""; document.getElementById('locName').value = l.name; document.getElementById('locAddr').value = l.address || ""; document.getElementById('locTemplate').value = l.templateName || ""; if(l.noReport) document.getElementById('radRepNo').checked = true; else document.getElementById('radRepYes').checked = true; const delBtn = document.getElementById('btnDelLoc'); if(delBtn) delBtn.classList.remove('hidden'); showModal('location'); }
function editTravelSettings(){ const l=state.locations.find(x=>x.id==='travel'); document.getElementById('locModalTitle').innerText="Travel Settings"; document.getElementById('locId').value='travel'; document.getElementById('locBusiness').parentNode.style.display='none'; document.getElementById('locName').parentNode.style.display='none'; document.getElementById('locAddr').parentNode.style.display='none'; document.getElementById('locTemplate').parentNode.style.display='none'; document.getElementById('btnDelLoc').classList.add('hidden'); if(l.noReport)document.getElementById('radRepNo').checked=true;else document.getElementById('radRepYes').checked=true; showModal('location'); }
function saveLoc(){ const id=document.getElementById('locId').value; const n=document.getElementById('locName').value; const b=document.getElementById('locBusiness').value; const a=document.getElementById('locAddr').value; const t=document.getElementById('locTemplate').value; const nr=document.getElementById('radRepNo').checked; if(id==='travel'){ const l=state.locations.find(x=>x.id==='travel'); l.noReport=nr; localStorage.setItem('otg_user_travel_pref',nr); renderLocations(); closeModal('location'); return; } if(!n) return alert("Site Name is required"); const newId = id || 'loc_' + Date.now(); const loc = {id: newId, name: n, companyName: b, address: a, templateName: t, noReport: nr}; if(id){ const i = state.locations.findIndex(x => x.id === id); if(i > -1) state.locations[i] = loc; } else { state.locations.push(loc); } saveState(); renderLocations(); closeModal('location'); showToast("Site Saved"); }
function deleteLoc(){ const id = document.getElementById('locId').value; if (!id) return; if (!confirm("Are you sure you want to delete this site?")) return; state.locations = state.locations.filter(x => x.id !== id); saveState(); renderLocations(); closeModal('location'); showToast("Site Deleted"); }
function getGpsAddress() { const btn = document.getElementById('btnGpsAddr'); const addrInput = document.getElementById('locAddr'); if (!btn || !addrInput) return; btn.innerText = "..."; btn.disabled = true; navigator.geolocation.getCurrentPosition((p) => { const lat = p.coords.latitude; const lon = p.coords.longitude; fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`).then(r => r.json()).then(d => { addrInput.value = d.display_name || `${lat}, ${lon}`; btn.innerText = "üìç GPS"; btn.disabled = false; }).catch(() => { addrInput.value = `${lat}, ${lon}`; btn.innerText = "üìç GPS"; btn.disabled = false; }); }, (err) => { btn.innerText = "üìç GPS"; btn.disabled = false; showToast("üìç GPS Error: " + err.message); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); }

// NETWORK & CORE
window.addEventListener('online',updateNetworkStatus); window.addEventListener('offline',updateNetworkStatus);
function updateNetworkStatus(){ const b=document.getElementById('offlineBanner'); if(navigator.onLine){ b.classList.add('hidden'); if(state.pendingUploads&&state.pendingUploads.length>0) processUploadQueue(); } else { b.classList.remove('hidden'); } }
function getDeviceID(){ let id=localStorage.getItem('device_uuid'); if(!id){id='dev_'+Math.random().toString(36).substr(2,9)+'_'+Date.now();localStorage.setItem('device_uuid',id);} return id; }
function navigate(p) {
    // 1. Hide all pages using your existing .page class
    document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));

    // 2. Safely locate the target page
    const targetPage = document.getElementById(p + 'Page');
    
    // 3. Safety Check: Only proceed if the page exists
    if (targetPage) {
        targetPage.classList.add('active');
    } else {
        console.warn("Navigation: '" + p + "Page' not found. Check HTML IDs.");
        return; 
    }

    // 4. PRESERVED: Your Safety Reminder Logic
    if (p === 'main') {
        if (typeof startReminderTimer === 'function') startReminderTimer();
    } else {
        // Safe check to see if the timer variable exists before clearing
        if (typeof mainScreenReminderTimer !== 'undefined') {
            clearTimeout(mainScreenReminderTimer);
        }
    }

    // 5. PRESERVED: Automatic UI Refresh
    if (p === 'settings') {
        populateSettingsForm();
    }
}
// SETUP WIZARD
function startWizard(){ 
    const wiz = document.getElementById('setupPage');
    if (wiz) {
        wiz.classList.remove('hidden');
        navigate('setup');
    }
    wizGoTo(1); 
    if(state.settings.workerName) populateWizard(); 
}
function wizGoTo(step){ document.querySelectorAll('.wizard-step').forEach(e=>e.classList.remove('active')); document.getElementById('wizStep'+step).classList.add('active'); for(let i=1;i<=3;i++){ const d=document.getElementById('dot'+i); d.classList.toggle('bg-blue-500',i===step); d.classList.toggle('bg-gray-700',i!==step); } }
function wizBack(step) {
    const current = document.getElementById(`wizStep${step}`);
    const prev = document.getElementById(`wizStep${step - 1}`);

    if (current && prev) {
        current.classList.add('hidden');
        current.classList.remove('active');
        prev.classList.remove('hidden');
        prev.classList.add('active');
    }
}
function cleanGlobalPhone(num) { if(!num) return ""; let n = num.replace(/[^0-9]/g, ''); const prefix = (CONFIG.countryPrefix || "").replace('+', ''); if(!prefix) return "+" + n; if (n.startsWith(prefix)) return '+' + n; if (n.startsWith('0')) return '+' + prefix + n.substring(1); if (prefix === '1' && n.length === 10) return '+1' + n; return '+' + prefix + n; }
function populateWizard(){ document.getElementById('wiz_name').value=state.settings.workerName||""; document.getElementById('wiz_phone').value=state.settings.workerPhone||""; document.getElementById('wiz_email').value=state.settings.workerEmail||""; document.getElementById('wiz_emg_name').value=state.settings.emergencyName||""; document.getElementById('wiz_emg_phone').value=state.settings.emergencyPhone||""; document.getElementById('wiz_emg_email').value=state.settings.emergencyEmail||""; document.getElementById('wiz_esc_name').value=state.settings.escalationName||""; document.getElementById('wiz_esc_phone').value=state.settings.escalationPhone||""; document.getElementById('wiz_esc_email').value=state.settings.escalationEmail||""; document.getElementById('wiz_pin').value=state.settings.pinCode||""; document.getElementById('wiz_duress').value=state.settings.duressPin||""; }
// FIXED: Now populates the diagnostic version text
function populateSettingsForm() {
    // 1. Sync the Standard Settings
    const urlInput = document.getElementById('set_url');
    if (urlInput) urlInput.value = state.settings.googleSheetUrl || CONFIG.url;

    const advInput = document.getElementById('set_adv');
    if (advInput) advInput.checked = state.settings.isAdvanced !== false;

    // 2. RESTORED: Sync Identity Field
    const nameInput = document.getElementById('set_workerName');
    if (nameInput) nameInput.value = state.settings.workerName || "";

    // 3. RESTORED: Sync Security PIN (Masked)
    const pinInput = document.getElementById('set_pinCode');
    if (pinInput) {
        // We show dots to indicate a PIN is set without revealing the Base64 string
        pinInput.value = state.settings.pinCode ? "‚Ä¢‚Ä¢‚Ä¢‚Ä¢" : "";
    }

    // 4. Update Diagnostic Information
const diagApp = document.getElementById('diagApp');
    const diagCloud = document.getElementById('diagCloud');
    
    if (diagApp) diagApp.innerText = APP_VERSION;
    
   // Standardize to use state.meta.backendVersion
    if (diagCloud) {
        diagCloud.innerText = state.meta.backendVersion || "Not Synced";
        if (state.meta.backendVersion) diagCloud.className = "text-green-400 font-bold text-xs";
    }
}
// KEEP THIS: It is not replaced by the population function
function toggleAdvancedMode(el) {
    state.settings.isAdvanced = el.checked;
    saveState();
    if(el.checked) {
        startGPSMonitoring();
        showToast("üìç Advanced Monitoring Active");
    } else {
        if(gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
        document.getElementById('gpsBars').classList.add('hidden');
        showToast("üîã Battery Saver: GPS Throttled");
    }
}
/**
 * Persists the current app state to local storage. 
 * Preserves Advanced Mode, branding, and Cloud Version data.
async function saveState() {
    try {
        // 1. Request persistent storage using standardized API
        if (navigator.storage && navigator.storage.persist) {
            const persisted = await navigator.storage.persist();
            if (persisted) {
                console.log("‚úÖ Offline Safety Cache Finalized: Persistent Storage Active");
            }
        }

        // 2. Persist the current state to LocalStorage
        const stateString = JSON.stringify(state);
        localStorage.setItem('otg_worker_state', stateString);
    } catch (e) {
        console.error("Critical: Failed to finalize safety cache", e);
        showToast("‚ö†Ô∏è Storage Error: Progression not saved.");
    }
}

function checkVehicleStatus() {
    // 1. Exit early if vehicle monitoring is disabled in CONFIG
    if (!CONFIG.vehEnabled) return; 

    const b = document.getElementById('vehNagBar');
    if (!b) return;

    let s = false; // Tracks if the "Check Required" state is active

    // 2. Customise banner text based on the organization's terminology
    if (CONFIG.vehicleTerm) { 
        b.innerText = `‚ö†Ô∏è ${CONFIG.vehicleTerm} Check Overdue - Tap to Complete`; 
    }

    // 3. Logic for the Periodic Safety Check (e.g., Weekly/Monthly)
    if (state.meta.lastVehCheck) { 
        const l = new Date(state.meta.lastVehCheck);
        const d = (Date.now() - l.getTime()) / (1000 * 60 * 60 * 24); 
        // Trigger banner if the days since last check exceed the interval
        if (d > CONFIG.vehInterval) { s = true; } 
    } 
    else { 
        /**
         * FIXED: "Day 1" Logic
         * Instead of triggering the banner immediately on a fresh install,
         * we set 'today' as the baseline so the first check is due only 
         * after one full interval (e.g., in 7 days).
         */
        state.meta.lastVehCheck = new Date().toISOString();
        saveState();
        s = false; 
    }

    // 4. Logic for Legal Compliance (WOF/Registration/CoF Expiry)
    if (state.meta.wofExpiry) { 
        const w = new Date(state.meta.wofExpiry);
        const du = (w.getTime() - Date.now()) / (1000 * 60 * 60 * 24); 

        if (du < 0) {
            // Case: Vehicle is legally expired
            s = true;
            b.innerText = `‚õî ${CONFIG.vehicleTerm || 'WOF'} EXPIRED - Vehicle Use Prohibited`;
            b.classList.remove('bg-orange-600');
            b.classList.add('bg-red-700'); // Visual escalation for illegal vehicle state
        } 
        else if (du < 14) { 
            // Case: Warning zone (within 14 days of expiry)
            s = true;
            b.innerText = `‚ö†Ô∏è Vehicle Check: ${CONFIG.vehicleTerm || 'WOF'} Due in ${Math.ceil(du)} Days`;
            b.classList.add('bg-orange-600');
            b.classList.remove('bg-red-700');
        } 
    }

    // 5. Final UI Update: Show or Hide the Nag Bar
    if (s) {
        b.classList.remove('hidden');
    } else {
        b.classList.add('hidden');
    }
}

// FORM HANDLING & RENDERERS
function startVehicleCheck() {
    // 1. Safety Check: Ensure the app logic is actually loaded
    if (typeof loadFormAndShow !== 'function') {
        console.error("UI Error: loadFormAndShow is not defined.");
        showToast("‚ö†Ô∏è System error - please refresh.");
        return;
    }

    // 2. Trigger the Safety Form
    // This matches the name of the template stored in your 'globalForms'
    loadFormAndShow('Vehicle Safety Check');
    
    // 3. User Feedback
    console.log("Vehicle Check Initiated: Loading Template...");
}function openQuickMenu(){isMidVisitUpdate=false;calculatedDist=null;showModal('template');renderIconGrid(state.globalForms, null);}
function openMidVisitMenu(){isMidVisitUpdate=true;calculatedDist=null;showModal('template');const cid=state.activeVisit?state.activeVisit.locationId:null;const loc=state.locations.find(x=>x.id===cid);renderIconGrid(state.globalForms, loc);}

function renderIconGrid(forms, loc) {
    const l=document.getElementById('templateList'); l.innerHTML='';
    const addBtn=(name,icon,label)=>{ 
        const b=document.createElement('button'); 
        b.className="menu-icon-btn"; 
        b.innerHTML=`<div class="text-3xl mb-1">${icon}</div><div class="text-xs font-bold leading-tight uppercase tracking-tighter">${label}</div>`; 
        b.onclick=()=>{closeModal('template');loadFormAndShow(name);}; 
        l.appendChild(b); 
    };

    // 1. Priority: Site-specific template
    if(loc&&loc.templateName) addBtn(loc.templateName,"üè¢",loc.templateName);
    else if(loc&&loc.id==='travel') addBtn("Travel Report","üõ£Ô∏è","Travel Log");
    else if(isMidVisitUpdate) addBtn("(Standard)","‚è±Ô∏è","Update Status");

    // 2. Dynamic Note to Self
    // Checks if "Note to Self" exists in your spreadsheet templates first
    const hasNoteTemplate = forms && forms.find(f => f.name.trim().toLowerCase() === 'note to self');
    if(hasNoteTemplate) {
        addBtn(hasNoteTemplate.name, "üìù", "Note to Self");
    } else {
        // Fallback to the hardcoded version if not defined in spreadsheet
        addBtn("Note to Self", "üìù", "Note to Self");
    }

    // 3. Global Forms
    if(forms){ 
        forms.forEach(f=>{ 
            const n = f.name.toLowerCase();
            // Skip if already added as a site-specific or Note to Self template
            if(loc && loc.templateName === f.name) return;
            if(n === 'note to self') return; 

            let icon="üìã"; 
            if(n.includes('vehicle')) icon="üöó"; 
            else if(n.includes('incident') || n.includes('accident')) icon="‚ö†Ô∏è"; 
            else if(n.includes('hazard')) icon="‚ò¢Ô∏è"; 
            else if(n.includes('client')) icon="üë§"; 
            addBtn(f.name, icon, f.name); 
        }); 
    }
}

function initLocations() {
    if (!state.locations) state.locations = [];
    
    // Ensure the 'travel' object exists exactly once at the top of the list
    const hasTravel = state.locations.find(l => l.id === 'travel');
    if (!hasTravel) {
        state.locations.unshift({
            id: 'travel',
            name: 'Travelling',
            noReport: localStorage.getItem('otg_user_travel_pref') === 'true'
        });
    }

    if (!state.cachedForms["Standard Visit Note"]) {
        state.cachedForms["Standard Visit Note"] = [{type:'note', text:'Standard Check-in'}];
    }
    
    if (CONFIG.mileage && !state.cachedForms['Travel Report']) {
        state.cachedForms['Travel Report'] = [
            {type:'number', text:'Distance (km)'},
            {type:'text', text:'Details'},
            {type:'photo', text:'Odometer'}
        ];
    }
    
    // Refresh UI Components
    renderLocations();
    checkVehicleStatus(); 
    populateSettingsForm(); 
}
function createDestinationTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === loc.id;
    
    d.className = `p-3 rounded-lg border-2 cursor-pointer flex flex-col justify-between h-24 shadow-sm transition-all ${isSel ? 'border-blue-500 bg-blue-900/40' : 'border-gray-700 bg-gray-800 hover:bg-gray-750'}`;
    
    let icon = "üè¢";
    if (loc.name && loc.name.includes("Home")) icon = "üè†";

    d.innerHTML = `
        <div class="flex justify-between items-start">
            <span class="text-2xl">${icon}</span>
            ${(loc.notes || loc.contactName || loc.id.startsWith('loc_')) ? 
                `<button class="text-gray-500 hover:text-white z-20" onclick="showSiteInfo('${loc.id}',event)">‚ÑπÔ∏è</button>` : ''}
        </div>
        <div>
            <div class="text-xs font-bold text-gray-400 uppercase truncate leading-none">${loc.companyName || ''}</div>
            <div class="text-[13px] font-black text-white truncate leading-tight mt-1">${loc.name}</div>
        </div>
    `;

    d.onclick = () => {
        if (state.selectedLocationId === loc.id) {
            state.selectedLocationId = null;
        } else {
            state.selectedLocationId = loc.id;
            travelTargetName = loc.name;
        }
        warmUpGps();
        renderLocations();
        updateArrivedButtonState();
    };
    return d;
}
/**
 * Creates the specialized purple 'Travel' tile.
 */
/**
 * Builds the wide purple 'Travel' tile at the top of the dashboard.
 */
function createTravelTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === 'travel';
    const isNoReport = loc.noReport || localStorage.getItem('otg_user_travel_pref') === 'true';

    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-purple-500 bg-purple-900/40 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    
    d.innerHTML = `
        <div class="text-3xl">üõ£Ô∏è</div>
        <div class="flex-1">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black text-purple-400 uppercase tracking-widest">In-Transit Mode</span>
                <button class="text-gray-500 hover:text-white" onclick="editTravelSettings(event)">‚öôÔ∏è</button>
            </div>
            <div class="text-lg font-black text-white leading-tight">Travel Safety Check</div>
            ${isNoReport ? '<span class="text-[9px] text-gray-500 uppercase font-bold">Fast-Sync (No Report)</span>' : ''}
        </div>
    `;

    d.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        state.selectedLocationId = isSel ? null : 'travel';
        travelTargetName = ""; 
        renderLocations();
        updateArrivedButtonState();
    };
    return d;
}
function handleVehicleCompliance(loc) {
    if (!state.meta || !state.meta.wofExpiry) return false;

    const w = new Date(state.meta.wofExpiry);
    const days = (w.getTime() - Date.now()) / (1000 * 60 * 60 * 24);

    if (days < 0) {
        document.getElementById('wofBlockModal')?.classList.remove('hidden');
        return true; // Stop execution
    } else if (days < 14) {
        const warnModal = document.getElementById('wofWarnModal');
        const warnText = document.getElementById('wofWarnText');
        if (warnModal && warnText) {
            warnModal.classList.remove('hidden');
            warnText.innerText = `Expires in ${Math.ceil(days)} days`;
            state.selectedLocationId = loc.id;
            warmUpGps();
            renderLocations();
            updateArrivedButtonState();
            return true; // Handled by modal
        }
    }
    return false; // All good
}

function renderLocations() {
    const l = document.getElementById('locationList');
    const tr = document.getElementById('travelRow');
    
    // 1. DOM Guard: Exit if the UI elements aren't ready
    if (!l || !tr) return;

    // 2. Clear current UI
    l.innerHTML = '';
    tr.innerHTML = '';

    // 3. State Guard: Ensure location array exists
    if (!state.locations) state.locations = [];

    // 4. Distribution Loop
    state.locations.forEach(loc => {
        // Skip null entries or entries without IDs to prevent script crashes
        if (!loc || !loc.id) return;

        if (loc.id === 'travel') {
            // Sends the travel object to its specialized purple tile builder
            tr.appendChild(createTravelTile(loc));
        } else {
            // Sends all other sites (Home, Office, Client) to the grid builder
            l.appendChild(createDestinationTile(loc));
        }
    });
}
// FIXED: Added Cache Buster to force fresh form data from Spreadsheet
function forceSync(showUi){
    if(!state.settings.workerName) return; 
    if(showUi) document.getElementById('uploadBanner').classList.remove('hidden');
    
    const dId = getDeviceID();
    // Added ?v= timestamp to bypass browser caching
    const syncUrl = `${CONFIG.url}?action=sync&worker=${encodeURIComponent(state.settings.workerName)}&key=${CONFIG.key}&deviceId=${dId}&v=${Date.now()}`;
    
    fetch(syncUrl).then(r => r.json()).then(data => {
        if(data.status === "error") { 
            if(showUi) document.getElementById('uploadBanner').classList.add('hidden'); 
            return; 
        }
        
        const existingManual = state.locations.filter(x => x && x.id && x.id.startsWith('loc_'));
        const ms = (data.sites || []).map(s => ({id:'site_'+s.siteName.replace(/\s/g,''), name:s.siteName, address:s.address, companyName:s.company, templateName:s.template, noReport:false, contactName:s.contactName, contactPhone:s.contactPhone, contactEmail:s.contactEmail, notes:s.notes}));
        
        state.locations = ms.concat(existingManual); 
        state.globalForms = data.forms || []; 
        state.cachedForms = data.cachedTemplates || {}; 
state.meta = data.meta || {};
saveState(); 
renderLocations(); 
checkVehicleStatus(); 
populateSettingsForm(); // ADD THIS LINE: Refreshes the versioning text
document.getElementById('uploadBanner').classList.add('hidden');
        if(showUi) showToast("Sync Complete!");
    });
// DIAGNOSTICS: Ensure it pulls from state.meta
const diagCloud = document.getElementById('diagCloud');
if (diagCloud) {
    diagCloud.innerText = state.meta.backendVersion || "Not Synced";
    if (state.meta.backendVersion) diagCloud.className = "text-green-400 font-bold";
}}

// FIXED: Corrected corrupted navigation string
function showSiteInfo(id, e){
    if(e) e.stopPropagation(); 
    const l = state.locations.find(x => x.id === id); if(!l) return;
    document.getElementById('infoTitle').innerText = l.name; 
    let h = "";
    if(l.companyName) h += `<p class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">${l.companyName}</p>`;
    const nav = document.getElementById('btnSiteNav');
    if(l.address && l.address.length > 3) { 
        h += `<p class="mt-2 text-white font-bold">${l.address}</p>`;
        // FIXED: Corrected syntax from '6{' to valid dollar sign
        nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.address)}`;
        nav.classList.remove('hidden'); 
    } else { nav.classList.add('hidden'); }
    document.getElementById('siteInfoContent').innerHTML = h;
    showModal('info');
}
function startReminderTimer() {
    if (mainScreenReminderTimer) clearTimeout(mainScreenReminderTimer);
    
    // Safety check: 30-minute interval
    mainScreenReminderTimer = setTimeout(() => {
        const mainPage = document.getElementById('mainPage');
        if (mainPage && mainPage.classList.contains('active')) {
            showToast("‚ö†Ô∏è Status Check: Please update your location.");
            startReminderTimer(); // Repeat cycle
        }
    }, 1800000); 
}
function showCurrentSiteInfo(){if(state.activeVisit)showSiteInfo(state.activeVisit.locationId);}
function toggleHighRiskUI(){ const chk = document.getElementById('chkHighRisk'); const lbl = document.getElementById('lblHighRisk'); if(chk.checked){ lbl.classList.remove('text-gray-500'); lbl.classList.add('text-red-500', 'animate-pulse'); } else { lbl.classList.add('text-gray-500'); lbl.classList.remove('text-red-500', 'animate-pulse'); } }

function updateArrivedButtonState() {
    const b = document.getElementById('arrivedBtn');
    if (!b) return;

    // 1. If a visit is already active, the button stays hidden (or performs a different role)
    if (state.activeVisit) {
        b.classList.add('hidden');
        return;
    }

    // 2. Determine the button text and style based on selection
    const config = getButtonConfig();

    if (config) {
        b.innerText = config.text;
        b.className = `fixed bottom-6 left-6 right-6 h-16 ${config.color} text-white rounded-2xl font-black text-lg shadow-2xl z-50 transition-all active:scale-95 flex items-center justify-center gap-3`;
        b.classList.remove('hidden');
    } else {
        b.classList.add('hidden');
    }
}
function getButtonConfig() {
    // Case A: Nothing is selected
    if (!state.selectedLocationId) return null;

    // Case B: Travelling is selected
    if (state.selectedLocationId === 'travel') {
        return {
            text: travelTargetName ? `START TRAVEL TO ${travelTargetName.toUpperCase()}` : "START TRAVELLING",
            color: "bg-gradient-to-r from-indigo-600 to-purple-600"
        };
    }

    // Case C: A specific site is selected
    const loc = state.locations.find(l => l.id === state.selectedLocationId);
    if (loc) {
        return {
            text: `ARRIVED AT ${loc.name.toUpperCase()}`,
            color: "bg-blue-600"
        };
    }

    return null;
}
// VISIT LOGIC
function startVisit() {
    const locId = state.selectedLocationId;
    if (!locId) return;

    const loc = state.locations.find(l => l.id === locId);
    if (!loc && locId !== 'travel') return;

    const visitData = {
        locationId: locId,
        locationName: locId === 'travel' ? 'Travelling' : loc.name,
        startTime: new Date().toISOString(),
        travelTarget: (locId === 'travel') ? travelTargetName : null,
        status: locId === 'travel' ? 'TRAVELLING' : 'ARRIVED'
    };

    state.activeVisit = visitData;
    state.selectedLocationId = null;
    saveState();
    renderLocations();
    updateArrivedButtonState();
    
    processUploadQueue(buildPayload({
        "Alarm Status": visitData.status,
        "Current Site": visitData.locationName,
        "Notes": visitData.travelTarget ? `Heading to: ${visitData.travelTarget}` : "Started Visit"
    }));

    startCheckinTimer();
    state.lowBatSent = false;
    enterLockedScreen();

    // Pulse Logic
    if (locId === 'travel') {
        startTravellingPulse();
    }

    showToast(`‚úÖ ${visitData.status} logged`);
}
function preDepart() {
    // Kill the auto-dim timer so the report form stays visible
    if (autoDimTimer) clearTimeout(autoDimTimer);

    isMidVisitUpdate = false; 
    const l = state.locations.find(x => x.id === state.activeVisit.locationId); 
    const sg = state.activeVisit.startGPS;

    if (l.id === 'travel') {
        if (l.noReport) { submitReport(); return; }
        document.getElementById('btnDepart').innerText = "Syncing...";
        
        navigator.geolocation.getCurrentPosition(async(pos) => { 
            const eg = `${pos.coords.latitude},${pos.coords.longitude}`; 
            if (navigator.onLine) { 
                calculatedDist = await getDistance(sg, eg); 
            } else { 
                const d = haversine(sg, eg); 
                calculatedDist = {km: d.toFixed(2), type:'crow', offline: true}; 
            } 
            document.getElementById('btnDepart').innerText = "HOLD TO END"; 
            loadFormAndShow(l.templateName || "(Standard)"); 
        }, (err) => { 
            calculatedDist = null; 
            document.getElementById('btnDepart').innerText = "HOLD TO END"; 
            loadFormAndShow(l.templateName || "(Standard)"); 
        }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    } 
    else if (l.noReport) { 
        submitReport(); 
    } 
    else { 
        calculatedDist = null;
        loadFormAndShow(l.templateName || "(Standard)");
    }
}

function warmUpGps() { if(gpsWarm) return; gpsWarm = true; navigator.geolocation.getCurrentPosition(()=>{}, (err)=>{ if(err.code === 1) showToast("üìç GPS Permission Required"); }, {enableHighAccuracy:true, timeout:10000, maximumAge:0}); setTimeout(()=> { gpsWarm = false; }, 30000); }
function startGPSMonitoring() {
    if (!('geolocation' in navigator)) return;
    let lastUpdate = 0; setInterval(() => { if(Date.now() - lastUpdate > 30000) { updateGPSUI(-1); } }, 5000);
    const updateGPSUI = (acc) => { lastUpdate = Date.now(); const bars = [document.getElementById('gps1'), document.getElementById('gps2'), document.getElementById('gps3')]; const err = document.getElementById('gpsError'); const barContainer = document.getElementById('gpsBars'); bars.forEach(b => b.className = 'gps-bar'); if (acc === -1) { barContainer.classList.add('hidden'); err.classList.remove('hidden'); } else { barContainer.classList.remove('hidden'); err.classList.add('hidden'); if(acc <= 15) { bars.forEach(b => b.classList.add('active-green')); } else if(acc <= 45) { bars[0].classList.add('active-amber'); bars[1].classList.add('active-amber'); } else { bars[0].classList.add('active-red'); } } };
    gpsWatchId = navigator.geolocation.watchPosition((pos) => { updateGPSUI(pos.coords.accuracy); }, (err) => { updateGPSUI(-1); showToast("üìç GPS Signal Lost"); }, { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 });
    if ('getBattery' in navigator) { navigator.getBattery().then(function(battery) { const updateBat = () => { currentBatteryLevel = Math.round(battery.level * 100) + "%"; if (battery.level <= 0.20 && document.getElementById('batterySaver').classList.contains('hidden')) { toggleBatterySaver(); showToast("üîã Low Battery: Auto-Dim Active"); } }; updateBat(); battery.addEventListener('levelchange', updateBat); }); }
}

function enterLockedScreen(){
    const l=state.locations.find(x=>x.id===state.activeVisit.locationId); document.getElementById('lockedLocationName').innerText=l.name; navigate('locked');
    if(state.activeVisit&&state.activeVisit.isPanic){renderPanicState();}
    else{ document.getElementById('btnDepart').classList.remove('hidden'); document.getElementById('btnSafe').classList.add('hidden'); document.getElementById('btnExtend').classList.remove('hidden'); document.getElementById('lockedPage').classList.remove('panic-mode'); }
    timerInt=setInterval(tick,1000); setupLongPress(document.getElementById('btnDepart'),()=>preDepart()); setupLongPress(document.getElementById('btnExtend'),()=>showModal('extend')); 
    if(state.activeVisit.highRisk) document.getElementById('highRiskBadge').classList.remove('hidden'); else document.getElementById('highRiskBadge').classList.add('hidden');
}

function tick(){
    if(!state.activeVisit){clearInterval(timerInt);return;}
    const now=new Date().getTime(); 
    const dueTime=new Date(state.activeVisit.anticipatedDepartureTime).getTime(); 
    const remaining=dueTime-now;
    const isCriticalMode = state.activeVisit.highRisk; 
    const escTime = isCriticalMode ? 0 : (CONFIG.escalationMinutes||15)*60000; 
    const timeUntilEscalation = remaining + escTime;
    
    // 1. ALARM ACTIVATION CHECK
    if(timeUntilEscalation <= 0) {
        document.getElementById('overdueLabel').classList.remove('hidden'); 
        document.getElementById('btnDepart').classList.add('hidden'); 
        document.getElementById('btnExtend').classList.add('hidden'); 
        document.getElementById('btnSafe').classList.remove('hidden'); 
        setupLongPress(document.getElementById('btnSafe'), iamSafe);
        document.getElementById('countdownTimer').innerText="ALARM SENT";
        if(!state.activeVisit.criticalSent){
            state.activeVisit.criticalSent=true; 
            saveState(); 
            triggerAutoAlert(isCriticalMode ? 'EMERGENCY - CRITICAL TIMING' : 'EMERGENCY - OVERDUE'); 
        } 
    } else {
        // 2. VERBAL WARNINGS
        if(timeUntilEscalation <= 300000 && !state.activeVisit.warn5minSent){ 
            state.activeVisit.warn5minSent = true; saveState(); playSound('warning'); 
        } 
        if(timeUntilEscalation <= 120000 && !state.activeVisit.warn2minSent){ 
            state.activeVisit.warn2minSent = true; saveState();
            playSound('arrive'); 
            setTimeout(() => speakWithAccent("Warning. Safety alarm will activate in two minutes."), 1000); 
        } 
        if(timeUntilEscalation <= 90000 && !state.activeVisit.warn90Sent){ 
            state.activeVisit.warn90Sent = true; saveState();
            playSound('arrive'); 
            setTimeout(() => speakWithAccent("Critical Warning. Safety alarm will activate in 90 seconds."), 1000); 
        }

        // 3. TIMER DISPLAY
        if (remaining <= 0) {
            document.getElementById('overdueLabel').classList.remove('hidden'); 
            document.getElementById('btnDepart').classList.remove('hidden'); 
            document.getElementById('btnExtend').classList.remove('hidden'); 
            document.getElementById('btnSafe').classList.add('hidden');
            const absRem = Math.abs(remaining); 
            const mTotal = Math.floor(absRem / 60000);
            const s = Math.floor((absRem % 60000) / 1000);
            document.getElementById('countdownTimer').innerHTML = mTotal >= 60 ? `-${Math.floor(mTotal/60)}h ${mTotal%60}m` : `-${mTotal}:${s<10?'0':''}${s}<span class="text-3xl ml-2 font-black">min</span>`;
            document.getElementById('countdownTimer').classList.add('text-red-500','animate-pulse');
        } else {
            const mTotal = Math.floor(remaining / 60000);
            const s = Math.floor((remaining % 60000) / 1000);
            document.getElementById('countdownTimer').innerHTML = mTotal >= 60 ? `${Math.floor(mTotal/60)}h ${mTotal%60}m` : `${mTotal}:${s<10?'0':''}${s}<span class="text-3xl ml-2 font-black">min</span>`;
            document.getElementById('countdownTimer').classList.remove('text-red-500','animate-pulse'); 
            document.getElementById('overdueLabel').classList.add('hidden'); 
        }
    }

    if(state.activeVisit.anticipatedDepartureTime) { 
        document.getElementById('lockedAnticipatedTime').innerText=new Date(state.activeVisit.anticipatedDepartureTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit', hour12:true}); 
    }
}
    
function warmUpSpeech() { if('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(" "); u.volume = 0; window.speechSynthesis.speak(u); } }
function speakWithAccent(msg){ if(!('speechSynthesis' in window)) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(msg); const v = window.speechSynthesis.getVoices(); u.voice = v.find(x => x.lang.includes(CONFIG.voiceLocale)) || v.find(x => x.lang.includes('en-NZ')); u.rate = 0.9; u.volume = 1.0; window.speechSynthesis.speak(u); }

function preDepart(){
    // Kill the timer so the screen stays bright for form filling
    if (autoDimTimer) clearTimeout(autoDimTimer);
    isMidVisitUpdate=false; const l=state.locations.find(x=>x.id===state.activeVisit.locationId); const sg=state.activeVisit.startGPS;
    if(l.id === 'travel'){
        if(l.noReport) { submitReport(); return; }
        document.getElementById('btnDepart').innerText="Syncing...";
        navigator.geolocation.getCurrentPosition(async(pos)=>{ const eg=`${pos.coords.latitude},${pos.coords.longitude}`; if(navigator.onLine) { calculatedDist=await getDistance(sg,eg); } else { const d = haversine(sg, eg); calculatedDist = {km: d.toFixed(2), type:'crow', offline: true}; } document.getElementById('btnDepart').innerText="HOLD TO END"; loadFormAndShow(l.templateName||"(Standard)"); }, (err) => { calculatedDist = null; document.getElementById('btnDepart').innerText="HOLD TO END"; loadFormAndShow(l.templateName||"(Standard)"); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    } else if(l.noReport) { submitReport(); return; } 
    else { calculatedDist=null; loadFormAndShow(l.templateName||"(Standard)"); }
}

async function getDistance(p1, p2) {
    if (!p1 || !p2) return { km: 0, type: 'none' };
    try { 
        const u = `${CONFIG.url}?action=getDistance&start=${p1}&end=${p2}&key=${CONFIG.key}`;
        const r = await fetch(u); 
        const j = await r.json(); 
        if (j.status === "success" && j.km) return { km: j.km, type: 'road' };
    } catch (e) { console.warn("Road distance failed, falling back to straight-line."); }
    
    const d = haversine(p1, p2);
    return { km: d.toFixed(2), type: 'crow' };
}
function haversine(p1, p2) {
    const [la1, lo1] = p1.split(',').map(Number);
    const [la2, lo2] = p2.split(',').map(Number);
    const R = 6371; // Earth radius in km
    const dLa = (la2 - la1) * Math.PI / 180;
    const dLo = (lo2 - lo1) * Math.PI / 180;
    const a = Math.sin(dLa / 2) * Math.sin(dLa / 2) + Math.cos(la1 * Math.PI / 180) * Math.cos(la2 * Math.PI / 180) * Math.sin(dLo / 2) * Math.sin(dLo / 2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function loadFormAndShow(t){
    clearSig(); 
    showModal('report'); 
    const displayTitle = t === "(Standard)" ? "Status Update" : t;
    document.getElementById('reportTitle').innerText = isMidVisitUpdate ? "Update: " + displayTitle : displayTitle;
    currentActiveTemplate = t; 
    buildReportForm(t, document.getElementById('reportFields'));
    if(calculatedDist){ let di = document.querySelector('[data-key*="Distance"]') || document.querySelector('[data-key*="KM"]'); if(di){ di.value = calculatedDist.km; di.style.border = "2px solid #4ade80"; di.classList.add("bg-green-900/20"); } }
    const b=document.getElementById('btnSubmitRep'); const nb=b.cloneNode(true); b.parentNode.replaceChild(nb,b);
    if(!state.activeVisit){ nb.innerText="SUBMIT REPORT"; nb.classList.remove('long-press-btn'); nb.classList.add('bg-blue-600','hover:bg-blue-500'); nb.onclick=submitReport; } 
    else if(isMidVisitUpdate){ nb.innerText="SEND UPDATE"; nb.classList.remove('long-press-btn'); nb.classList.add('bg-indigo-600','hover:bg-indigo-500'); nb.onclick=submitReport; } 
    else { nb.innerText="HOLD TO SUBMIT & END"; nb.classList.add('long-press-btn'); setupLongPress(nb,submitReport); }
}
function submitReport(){
    // Kill the auto-dim timer so the report form stays visible
    if (autoDimTimer) clearTimeout(autoDimTimer);
    const d=gatherFormData(); let photoCount = 0; const photoMap = {};
    Object.keys(state.photoStore).forEach((key, index) => { photoCount++; const token = `{{PHOTO_${photoCount}}}`; photoMap[`Photo ${photoCount}`] = state.photoStore[key]; if(d.custom[key] !== undefined) { d.custom[key] = token; d.jsonPayload[key] = token; } });
    const fd={...d.custom,"Visit Report Data":JSON.stringify(d.jsonPayload),"Template Name":currentActiveTemplate};
    if(d.custom&&d.custom["Distance (km)"])fd["Distance"]=d.custom["Distance (km)"];
    Object.entries(photoMap).forEach(([k, v]) => { fd[k] = v; }); if(d.sig)fd["Signature"]=d.sig;
    
    if(!state.activeVisit){
        processUploadQueue(buildPayload({...fd,"Alarm Status":"DATA_ENTRY_ONLY","Notes":d.notes}));
        showToast("Report Sent"); closeModal('report'); return;
    }
    
    let s = isMidVisitUpdate ? (state.activeVisit.locationId==='travel'?"TRAVELLING":"ON SITE") : "DEPARTED";
    processUploadQueue(buildPayload({...fd,"Alarm Status":s,"Notes":d.notes}));
    
    if(!isMidVisitUpdate){ 
        state.activeVisit = null; 
        state.photoStore = {}; 
        state.visitDurationMinutes = 0; 
        
        // PATCH: Reset all selection states and refresh UI
        state.selectedLocationId = null; 
        travelTargetName = ""; 
        renderLocations(); 
        updateArrivedButtonState(); 
        
        navigate('main'); 
        if(travellingInterval) clearInterval(travellingInterval); 
    }
    
    saveState(); 
    closeModal('report');
}

function gatherFormData(){const d={custom:{},notes:'',sig:null,jsonPayload:{}};const sn=document.getElementById('rep_notes');if(sn)d.notes=sn.value;document.querySelectorAll('[data-key]').forEach(el=>{const k=el.getAttribute('data-key');let v=el.value;if(el.type==='checkbox')v=el.checked?'Yes':'No';else if(el.type==='radio'){if(!el.checked)return;v=el.value;}d.custom[k]=v;d.jsonPayload[k]=v;});const c=document.querySelector('canvas[id^="sig-canvas-"]');if(c)d.sig=c.toDataURL('image/png');return d;}
function handlePhoto(i,k){if(i.files[0]){const b=document.getElementById(`lbl_${i.id.split('_')[1]}`);if(b)b.innerText="Compressing...";compressImg(i.files[0]).then(b64=>{state.photoStore[k]=b64;if(b)b.innerText="‚úÖ Saved";});}}
function compressImg(f){
    return new Promise(r=>{
        const rd=new FileReader();
        rd.onload=e=>{
            const i=new Image();
            i.onload=()=>{
                const c=document.createElement('canvas');
               // CELL LIMIT OPTIMIZATION: 600px ensures Base64 strings fit within Google Sheet cell limits
                const s = Math.min(600/i.width, 600/i.height, 1);
                c.width=i.width*s; c.height=i.height*s;
                c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                r(c.toDataURL('image/jpeg', 0.4));
            };
            i.src=e.target.result;
        };
        rd.readAsDataURL(f);
    });
}
function buildReportForm(n, c) {
    state.photoStore = {};
    const sn = n ? n.trim() : "(Standard)";
    let t = state.globalForms?.find(f => f.name.trim() === sn)?.questions || state.cachedForms[sn] || state.cachedForms["(Standard)"];
    c.innerHTML = '';
    
    if (!t) {
        c.innerHTML = '<label for="rep_notes" class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Visit Notes</label><textarea id="rep_notes" class="form-input h-32" placeholder="Write notes here..."></textarea>';
        return;
    }

    t.forEach((f, i) => {
        let y = 'text'; let x = f.text || f; let dropOptions = [];
        const upperX = x.toUpperCase();
        const fieldId = `dyn_field_${i}`;

        // 1. TAG DETECTION LOGIC
        if (upperX.includes('[HEADING]') || x.trim().startsWith('#')) { y = 'header'; x = x.replace(/\[HEADING\]/gi, '').replace('#', '').trim(); }
        else if (upperX.includes('[NOTE]')) { y = 'note'; x = x.replace(/\[NOTE\]/gi, '').trim(); }
        else if (upperX.includes('[SIGN]')) { y = 'signature'; x = x.replace(/\[SIGN\]/gi, '').trim(); }
        else if (upperX.includes('[PHOTO]')) { y = 'photo'; x = x.replace(/\[PHOTO\]/gi, '').trim(); }
        else if (upperX.includes('[GPS]')) { y = 'gps'; x = x.replace(/\[GPS\]/gi, '').trim(); if (!x) x = "Location Status"; }
        else if (upperX.includes('[YESNO]')) { y = 'yesno'; x = x.replace(/\[YESNO\]/gi, '').trim(); }
        else if (upperX.includes('[CHECK]')) { y = 'checkbox'; x = x.replace(/\[CHECK\]/gi, '').trim(); }
        else if (upperX.includes('[DATE]')) { y = 'date'; x = x.replace(/\[DATE\]/gi, '').trim(); }
        else if (upperX.includes('[NUMBER]')) { y = 'number'; x = x.replace(/\[NUMBER\]/gi, '').trim(); }
        else if (upperX.includes('[$]')) { y = 'currency'; x = x.replace(/\[\$\]/gi, '').trim(); } // Currency
        else if (upperX.includes('[1TEXT]')) { y = '1text'; x = x.replace(/\[1TEXT\]/gi, '').trim(); }
        else if (upperX.startsWith('[DROP')) { // Dropdown
            y = 'drop';
            const dropMatch = x.match(/\[DROP\s*,\s*(.*?)\s*\]/i);
            if (dropMatch) {
                dropOptions = dropMatch[1].split(',').map(o => o.trim());
                x = x.replace(dropMatch[0], '').trim();
            }
        }

        const container = document.createElement('div');
        container.className = "mb-4";

        if (y === 'header') {
            container.innerHTML = `<div class="mt-6 mb-2 border-b border-gray-700 pb-1"><h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest">${x}</h3></div>`;
        } else if (y === 'note') {
            container.innerHTML = `<div class="bg-blue-900/20 border-l-2 border-blue-500 p-3 text-xs text-blue-200 italic font-medium">${x}</div>`;
        } else {
            container.innerHTML = `<label for="${fieldId}" class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">${x}</label>`;

            // 2. ELEMENT GENERATION
            if (y === 'photo') {
                container.innerHTML += `<div class="flex items-center gap-3"><label id="lbl_${i}" for="${fieldId}" class="flex-1 py-4 bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center text-gray-400 font-bold cursor-pointer">üì∏ Tap to Take Photo</label><input type="file" id="${fieldId}" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this, '${x}')"></div>`;
            } else if (y === 'signature') {
                container.innerHTML += `<div class="bg-white rounded-xl p-1 mb-2"><canvas id="sig-canvas-${i}" class="w-full h-40 border border-gray-200"></canvas></div><button type="button" class="text-[10px] font-bold text-gray-500 uppercase sig-clear-btn" data-index="${i}">Clear Signature</button>`;
            } else if (y === 'gps') {
                container.innerHTML += `<div class="flex gap-2"><button type="button" onclick="captureGPS(this)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg text-xs uppercase">Capture GPS</button><input type="text" id="${fieldId}" class="form-input flex-1 font-mono text-xs text-gray-400" readonly data-key="${x}"></div>`;
            } else if (y === 'drop') {
                const sel = document.createElement('select'); sel.id = fieldId; sel.className = "form-input font-bold"; sel.dataset.key = x;
                const def = document.createElement('option'); def.text = `Select ${x}...`; def.value = ""; sel.appendChild(def);
                dropOptions.forEach(optText => { const opt = document.createElement('option'); opt.text = optText; opt.value = optText; sel.appendChild(opt); });
                container.appendChild(sel);
            } else if (y === 'currency') {
                container.innerHTML += `<div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span><input type="number" step="0.01" inputmode="decimal" id="${fieldId}" class="form-input pl-8 font-bold" data-key="${x}"></div>`;
            } else if (y === 'yesno') {
                container.innerHTML += `<div class="flex gap-4 p-2 bg-gray-900 rounded-xl"><label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700"><input type="radio" name="yn_${i}" value="Yes" class="w-5 h-5" data-key="${x}"> <span class="text-sm font-black text-white">YES</span></label><label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700"><input type="radio" name="yn_${i}" value="No" class="w-5 h-5" data-key="${x}"> <span class="text-sm font-black text-white">NO</span></label></div>`;
            } else if (y === 'text') {
                container.innerHTML += `<textarea id="${fieldId}" class="form-input h-24 font-medium" data-key="${x}"></textarea>`;
            } else {
                container.innerHTML += `<input type="${y === 'date' ? 'date' : (y === 'number' ? 'number' : 'text')}" id="${fieldId}" class="form-input font-bold" data-key="${x}">`;
            }
        }
        c.appendChild(container);
    });

    setTimeout(() => {
        document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => {
            resizeCanvas(canvas);
            initSigPad(canvas);
        });
    }, 500);
}
function clearSig(id){ const canvasId = id ? `sig-canvas-${id}` : 'sig-canvas'; const c = document.getElementById(canvasId); if(c) c.getContext('2d').clearRect(0,0,c.width,c.height); }
function triggerAutoAlert(s){const sel=state.locations.find(l=>l.id===state.activeVisit.locationId);const ln=sel?(sel.companyName?`${sel.companyName} - ${sel.name}`:sel.name):"Unknown";navigator.geolocation.getCurrentPosition(p=>{processUploadQueue(buildPayload({"Alarm Status":s,"Notes":"Automated System Alert","Location Name":ln,"Last Known GPS":`${p.coords.latitude},${p.coords.longitude}`}));},()=>{processUploadQueue(buildPayload({"Alarm Status":s,"Notes":"Automated System Alert (GPS Fail)","Location Name":ln}));});}
function checkIn() {
    if (!state.activeVisit) return;

    // 1. Calculate the new due time
    const interval = CONFIG.checkinInterval || 60;
    const now = new Date();
    state.activeVisit.nextCheckinDue = new Date(now.getTime() + interval * 60000).toISOString();
    
    // 2. Clear and restart the background monitor
    startCheckinTimer();
    
    // 3. Persist and notify the backend
    saveState();
    processUploadQueue(buildPayload({
        "Alarm Status": "CHECK-IN",
        "Notes": state.activeVisit.status === 'TRAVELLING' ? "Travel Check-in" : "Site Check-in"
    }));

    showToast("‚úÖ Check-in Successful");
}
    function triggerCheckin() {
    if(!document.getElementById('checkinModal').classList.contains('hidden')) return;
    showModal('checkin');
    document.getElementById('batterySaver').classList.add('hidden');
    let rem = 120;
    const el = document.getElementById('checkinCountdown');
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    playSound('checkin');
    
    // Refresh button listeners
    const btn = document.getElementById('btnCheckinConfirm');
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    setupLongPress(newBtn, confirmCheckin);
    
    checkinIntervalId = setInterval(() => {
        rem--;
        const m = Math.floor(rem/60);
        const s = rem % 60;
        el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if (rem <= 0) {
            clearInterval(checkinIntervalId);
            closeModal('checkin');
            processUploadQueue(buildPayload({
                "Alarm Status": 'MISSED_CHECKIN', 
                "Notes": "Worker failed to respond to check-in"
            }));
            showToast('MISSED CHECK-IN ALERT SENT');
        }
    }, 1000);
}
function confirmCheckin(){clearInterval(checkinIntervalId);closeModal('checkin');state.activeVisit.nextCheckin=new Date(Date.now()+CONFIG.checkinInterval*60000);saveState();}
function confirmExtension(m){const p=()=>{state.activeVisit.anticipatedDepartureTime=new Date(new Date(state.activeVisit.anticipatedDepartureTime).getTime()+m*60000);saveState();processUploadQueue(buildPayload({"Alarm Status":'EXTENDED',"Notes":"Extended "+m+"m"}));};const n=new Date(),d=new Date(state.activeVisit.anticipatedDepartureTime);closeModal('extend');if((d-n)<0||state.activeVisit.isPanic)withPinVerification(false,p);else p();}
function triggerPanic(){ 
    if (Date.now() - lastAlertTime < 60000) return; 
    lastAlertTime = Date.now(); 
    state.activeVisit = state.activeVisit || {}; 
    state.activeVisit.isPanic = true; 
    saveState(); 
    renderPanicState(); 
    // playSound('panic'); // REMOVED to ensure the alert is silent on the device
    processUploadQueue(buildPayload({"Alarm Status":'EMERGENCY - PANIC BUTTON',"Notes":"Panic Pressed"})); 
    showToast('üö® SOS SENT üö®'); 
}
function renderPanicState(){document.getElementById('lockedPage').classList.add('panic-mode');document.getElementById('btnDepart').classList.add('hidden');document.getElementById('btnExtend').classList.add('hidden');document.getElementById('btnSafe').classList.remove('hidden');setupLongPress(document.getElementById('btnSafe'),iamSafe);}
function iamSafe() {
    // 1. STOP THE GPS PULSE IMMEDIATELY
    stopTravellingPulse(); 

    if (checkinIntervalId) clearInterval(checkinIntervalId);
    state.activeVisit = null;
    saveState();
    
    // ... leave the rest of your iamSafe logic exactly as it is ...
    navigate('main');
    showToast("Safety Monitoring Ended");
}
    function toggleBatterySaver() { 
    const saver = document.getElementById('batterySaver'); 
    const prog = document.getElementById('saverProgress');
    const themeMeta = document.querySelector('meta[name="theme-color"]');
    const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
    if (!saver) return; 

    if (saver.classList.contains('hidden')) { 
        saver.classList.remove('hidden'); 
        saver.style.pointerEvents = 'auto'; 
        
        // DIM SYSTEM: Signal the OS to black out bars and use dark icons
        document.documentElement.classList.add('system-dim');
        document.body.classList.add('system-dim');
        if(themeMeta) themeMeta.setAttribute('content', '#000000');
        if(appleMeta) appleMeta.setAttribute('content', 'black');
        
        showToast("üåô Battery Saver Active"); 
        
        // POCKET PROTECTION: Require a 1.5s hold to wake the screen
        setupLongPress(saver, () => {
        // User has manually woken the screen
    if (autoDimTimer) clearTimeout(autoDimTimer); 
    
    toggleBatterySaver(); // This turns dark mode OFF
});
    } else { 
        saver.classList.add('hidden'); 
        saver.style.pointerEvents = 'none'; 
        if(prog) prog.style.opacity = "0";
        
        // RESTORE SYSTEM
        document.documentElement.classList.remove('system-dim');
        document.body.classList.remove('system-dim');
        if(themeMeta) themeMeta.setAttribute('content', '#111827');
        if(appleMeta) appleMeta.setAttribute('content', 'black-translucent');
    } 
}
// Add this CSS-like logic to your setupLongPress to handle the visual wake-up
const originalSetup = setupLongPress;
setupLongPress = function(btn, cb) {
    originalSetup(btn, cb);
    if(btn.id === 'batterySaver') {
        const prog = document.getElementById('saverProgress');
        const start = btn.ontouchstart;
        const end = btn.ontouchend;
        
        btn.ontouchstart = (e) => { start(e); if(prog) prog.style.opacity = "1"; };
        btn.ontouchend = (e) => { end(e); if(prog) prog.style.opacity = "0"; };
        btn.onmousedown = (e) => { start(e); if(prog) prog.style.opacity = "1"; };
        btn.onmouseup = (e) => { end(e); if(prog) prog.style.opacity = "0"; };
    }
};

function buildPayload(d) {
    let dt = ""; 
    let ln = "Unknown Site"; 
    let la = "No Address Provided";

    // 1. Determine Location and Departure Time
    // Priority 1: Current Active Visit data
    if (state.activeVisit) {
        if (state.activeVisit.anticipatedDepartureTime) {
            dt = new Date(state.activeVisit.anticipatedDepartureTime).toISOString();
        }
        const l = state.locations.find(x => x.id === state.activeVisit.locationId);
        if (l) { 
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name; 
            la = l.address; 
        }
    } 
    // Priority 2: Selected location (if visit hasn't officially started)
    else if (state.selectedLocationId) {
        const l = state.locations.find(x => x.id === state.selectedLocationId);
        if (l) { 
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name; 
            la = l.address; 
        }
    }
    
    // 2. Determine GPS Coordinates
    // Uses fresh coordinates from the argument 'd' or falls back to visit start coordinates
    let gps = d['Last Known GPS'] || "";
    if (!gps && state.activeVisit && state.activeVisit.startGPS) { 
        gps = state.activeVisit.startGPS; 
    }
    
    // 3. Assemble and Return the Final Payload
    return {
        'key': CONFIG.key,
        'Worker Name': state.settings.workerName,
        'Worker Phone Number': state.settings.workerPhone,
        'Worker Email': state.settings.workerEmail,
        
        // Maps the Wizard IDs (emgName/escName) to the Sheet headers
        'Emergency Contact Name': state.settings.emgName,
        'Emergency Contact Number': state.settings.emgPhone,
        'Emergency Contact Email': state.settings.emgEmail,
        'Escalation Contact Name': state.settings.escName,
        'Escalation Contact Number': state.settings.escPhone,
        'Escalation Contact Email': state.settings.escEmail,
        
        'Battery Level': currentBatteryLevel,
        'Location Name': ln,
        'Location Address': la,
        'Anticipated Departure Time': dt,
        'Timestamp': new Date().toISOString(),
        'deviceId': getDeviceID(),
        'Last Known GPS': gps,
        
        // Merges specific alert data (e.g., "Alarm Status": "PANIC")
        ...d
    };
}
let isUploading = false;
let uploadRetryDelay = 1000; 
const MAX_QUEUE_SIZE = 50;

async function processUploadQueue(payload = null) {
    if (payload) {
        uploadQueue.push(payload);
        if (uploadQueue.length > MAX_QUEUE_SIZE) uploadQueue.shift();
        saveState();
    }

    if (isUploading || uploadQueue.length === 0) return;
    isUploading = true;

    try {
        const item = uploadQueue[0];
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);

        await fetch(CONFIG.scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(item),
            signal: controller.signal
        });

        clearTimeout(timeout);
        uploadQueue.shift();
        saveState();
        uploadRetryDelay = 1000; 
        isUploading = false;
        if (uploadQueue.length > 0) processUploadQueue();
    } catch (err) {
        isUploading = false;
        // Exponentially increase wait time up to 5 minutes
        uploadRetryDelay = Math.min(uploadRetryDelay * 2, 300000);
        setTimeout(() => processUploadQueue(), uploadRetryDelay);
    }
}
function setupLongPress(btn, cb) {
    let t;
    const prog = btn.id === 'batterySaver' ? document.getElementById('saverProgress') : null;

    const start = (e) => {
        if (e.type === 'touchstart') e.preventDefault();
        btn.classList.add('pressing');
        if (prog) prog.style.opacity = "1"; // Show visual wake feedback
        
        t = setTimeout(() => {
            cb();
            btn.classList.remove('pressing');
            if (prog) prog.style.opacity = "0";
        }, 1500);
    };

    const cancel = () => {
        clearTimeout(t);
        btn.classList.remove('pressing');
        if (prog) prog.style.opacity = "0";
    };

    btn.onmousedown = btn.ontouchstart = start;
    btn.onmouseup = btn.ontouchend = btn.onmouseleave = cancel;
}
function withPinVerification(d,c){ showModal('pin'); const i=document.getElementById('pinInput'); i.value=''; i.focus(); const cf=()=>{ const v=i.value; closeModal('pin'); if(checkPin(v)){ c(); } else if(v===state.settings.duressPin){ processUploadQueue(buildPayload({"Alarm Status":"DURESS_CODE_ACTIVATED","Notes":"Silent Alarm Triggered"})); if(state.activeVisit) { state.activeVisit = null; saveState(); navigate('main'); } } document.getElementById('confirmPinBtn').removeEventListener('click',cf); }; document.getElementById('confirmPinBtn').addEventListener('click',cf); document.getElementById('cancelPinBtn').onclick=()=>closeModal('pin'); }
function clearData(){
    if(confirm('üö® WARNING: This will permanently delete your identity, PINs, and safety site list. You will need to re-run the setup. Continue?')){
        localStorage.clear();
        location.reload();
    }
}
function clearFormsCache() {
    if (confirm('Clear all synced form templates? (Requires network to re-download)')) {
        state.cachedForms = {};
        state.globalForms = [];
        saveState();
        
        // FEEDBACK: Immediate toast to confirm the cache is gone
        showToast("‚úÖ Cache Cleared. Downloading fresh templates...");
        
        // Restart sync with UI enabled
        forceSync(true);
    }
}
function syncForms(){if(!CONFIG.url)return;fetch(`${CONFIG.url}?action=getGlobalForms`).then(r=>r.json()).then(j=>{if(Array.isArray(j)){state.globalForms=j;saveState();}});}
async function initAudio(){if(!synth){await Tone.start();synth=new Tone.Synth().toDestination();}}
function playSound(t){initAudio().then(()=>{const n=Tone.now();if(t==='arrive')synth.triggerAttackRelease("C4","8n",n);if(t==='depart')synth.triggerAttackRelease("G4","8n",n);if(t==='warning')synth.triggerAttackRelease("E5","16n",n);if(t==='panic')synth.triggerAttackRelease("G5","16n",n);});}
function captureGPS(btn){
    btn.innerText="Locating...";
    btn.disabled = true; // Prevent double-taps
    
    const options = { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 };
    
    const success = (p) => {
        const coords = `${p.coords.latitude.toFixed(5)},${p.coords.longitude.toFixed(5)}`;
        btn.innerText="‚úÖ " + coords;
        btn.disabled = false;
        if(btn.nextElementSibling) btn.nextElementSibling.value = coords;
    };
    
    const error = (err) => {
        if (err.code === 3) {
            // INDOOR FALLBACK: If high-accuracy times out, try standard signal
            btn.innerText = "Retrying (Wide)...";
            navigator.geolocation.getCurrentPosition(success, (err2) => {
                btn.innerText = "‚ùå GPS Error";
                btn.disabled = false;
                showToast("üìç Could not lock GPS signal indoors.");
            }, { enableHighAccuracy: false, timeout: 5000 });
        } else {
            btn.innerText = "‚ùå GPS Error";
            btn.disabled = false;
            showToast("üìç GPS: " + (err.code === 1 ? "Permission Denied" : "Signal Unavailable"));
        }
    };
    
    navigator.geolocation.getCurrentPosition(success, error, options);
}
function initSigPad(c) {
    if (!c) return; 
    const ctx = c.getContext('2d'); 
    let lastX, lastY; 
    
    // PATCH: Simplified coordinate logic to prevent double-scaling
    const getPos = (e) => { 
        const rect = c.getBoundingClientRect(); 
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0); 
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0); 
        return { 
            x: clientX - rect.left, 
            y: clientY - rect.top 
        }; 
    };

    c.addEventListener('pointerdown', (e) => { 
        isDrawing = true; 
        const pos = getPos(e); 
        lastX = pos.x; lastY = pos.y; 
        
        ctx.strokeStyle = "#000000"; 
        ctx.lineWidth = 3; 
        ctx.lineCap = "round";
        
        ctx.beginPath(); 
        ctx.moveTo(lastX, lastY); 
        e.preventDefault(); 
    }, {passive: false});

    c.addEventListener('pointermove', (e) => { 
        if (!isDrawing) return; 
        const pos = getPos(e); 
        const midX = (lastX + pos.x) / 2; 
        const midY = (lastY + pos.y) / 2; 
        ctx.quadraticCurveTo(lastX, lastY, midX, midY); 
        ctx.stroke(); 
        lastX = pos.x; lastY = pos.y; 
        e.preventDefault(); 
    }, {passive: false});

    window.addEventListener('pointerup', () => { isDrawing = false; });
}
async function hardRefreshUpdate() {
    // 1. User confirmation to prevent accidental reloads
    if(!confirm("Force reload and clear internal app memory?")) return;
    
    showToast("üßπ Deep cleaning system cache...");

    // 2. Unregister Service Workers
    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) { await r.unregister(); }
    }

    // 3. Delete all named caches (This is the feature missing from the lite version)
    if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) { await caches.delete(k); }
    }

    // 4. Reset diagnostic state so "Not Synced" shows on next load
    state.backendVersion = null;
    saveState();

    // 5. Force reload from server bypassing browser cache
    location.reload(true); 
}

    function loadState() {
    const saved = localStorage.getItem('otg_worker_state');
    if (saved) {
        try {
            state = JSON.parse(saved);
            
            // Ensure sub-objects exist to prevent crashes
            if (!state.settings) state.settings = {};
            if (!state.locations) state.locations = [];
            if (!state.meta) state.meta = {};

            // Update UI from the loaded data
            populateSettingsForm();
            renderLocations();
            
            // Restart Advanced GPS if it was active
            if (state.settings.isAdvanced) {
                startGPSMonitoring();
            }
            
            console.log("System State Restored");
        } catch (e) {
            console.error("Failed to parse saved state", e);
        }
    }
}
    function saveSettings() {
    // 1. Collect values from the Settings UI IDs
    const nameInput = document.getElementById('set_workerName');
    const pinInput = document.getElementById('set_pinCode');
    const urlInput = document.getElementById('set_url');

    // 2. Update the global state with trimmed values
    if (nameInput) state.settings.workerName = nameInput.value.trim();
    if (urlInput) state.settings.googleSheetUrl = urlInput.value.trim();

    // 3. Obfuscate the PIN using Base64 before saving
    if (pinInput && pinInput.value) {
        state.settings.pinCode = btoa(pinInput.value.trim());
    }

    // 4. Persist the updated state to localStorage
    saveState();

    // 5. Visual feedback and Manual Sync
    showToast("‚úÖ Settings Saved Successfully");
    
    // For manual saves, we pass 'true' so the worker sees the "Syncing" banner
    forceSync(true); 
}
    
function checkPin(input) {
    if (!state.settings.pinCode) return false;
    try {
        // Decodes the stored string for comparison
        return input === atob(state.settings.pinCode);
    } catch (e) {
        // Fallback for old plain-text pins during transition
        return input === state.settings.pinCode;
    }
}    
let panicHoldTimer;

function initPanicButton() {
    const sosBtn = document.getElementById('btnPanic');
    if (!sosBtn) return;

    const startHold = (e) => {
        // Prevent context menus on mobile long-press
        if (e.cancelable) e.preventDefault(); 
        
        sosBtn.classList.add('holding');

        // Set timer for 3 seconds
        panicHoldTimer = setTimeout(() => {
            sosBtn.classList.remove('holding');
            executePanicAction(); 
        }, 3000);
    };

    const cancelHold = () => {
        clearTimeout(panicHoldTimer);
        sosBtn.classList.remove('holding');
    };

    // Standard Desktop & Mobile Listeners
    sosBtn.addEventListener('mousedown', startHold);
    sosBtn.addEventListener('touchstart', startHold);

    sosBtn.addEventListener('mouseup', cancelHold);
    sosBtn.addEventListener('mouseleave', cancelHold);
    sosBtn.addEventListener('touchend', cancelHold);
}

/**
 * Replaces the old handlePanicTap()
 */
function executePanicAction() {
    // Kill the auto-dim timer immediately on emergency
    if (autoDimTimer) clearTimeout(autoDimTimer); 

    if (Date.now() - lastAlertTime < 60000) return; 
    lastAlertTime = Date.now();

    state.activeVisit = state.activeVisit || {};
    state.activeVisit.isPanic = true;
    saveState();

    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 500]);
    showToast("üö® SOS ACTIVATED");

    processUploadQueue(buildPayload({
        "Alarm Status": "PANIC_BUTTON_HELD",
        "Notes": "Emergency SOS triggered by 3-second hold."
    }));
}

function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    const frequency = 300000; // 5 Minutes

    travellingInterval = setInterval(() => {
        if (!state.activeVisit || state.activeVisit.status !== 'TRAVELLING') {
            stopTravellingPulse();
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            processUploadQueue(buildPayload({
                "Alarm Status": "TRAVELLING",
                "Last Known GPS": `${pos.coords.latitude},${pos.coords.longitude}`,
                "Notes": state.activeVisit.travelTarget ? `En route to: ${state.activeVisit.travelTarget}` : "Transit"
            }));
        }, null, { enableHighAccuracy: true });
    }, frequency);
}
function updateTimerDisplay(now, due) {
    const timerEl = document.getElementById('checkinTimerDisplay');
    if (!timerEl) return;
    
    const diff = due - now;
    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function stopTravellingPulse() {
    if (travellingInterval) {
        clearInterval(travellingInterval);
        travellingInterval = null;
        console.log("üõë Travel Tracking Stopped");
    }
}
function resizeCanvas(canvasEl) { 
    // 1. Selector flexibility: Uses parameter or searches for a signature canvas
    const c = canvasEl || document.getElementById('sigPad') || document.querySelector('canvas[id^="sig-canvas-"]'); 
    if (!c) return; 
    
    const ctx = c.getContext('2d'); 
    
    // 2. Data Persistence: Capture existing drawing before the canvas clears
    const tempImg = c.toDataURL();
    
    // 3. High-DPI Scaling: Calculate ratio for retina/high-resolution displays
    const ratio = Math.max(window.devicePixelRatio || 1, 1); 
    
    // 4. RESET coordinates before applying new scale
    ctx.setTransform(1, 0, 0, 1, 0, 0); 
    
    // 5. Apply new dimensions (Note: This action clears the canvas)
    c.width = c.offsetWidth * ratio; 
    c.height = c.offsetHeight * ratio; 
    
    // 6. Apply scale and restore pen styling (Resizing resets context state)
    ctx.scale(ratio, ratio); 
    ctx.strokeStyle = "#000000"; 
    ctx.lineWidth = 3; 
    ctx.lineCap = "round";

    // 7. Restore the signature from the temporary image
    const img = new Image();
    img.onload = () => {
        // Draw back at the original display size; the scale(ratio) handles the rest
        ctx.drawImage(img, 0, 0, c.offsetWidth, c.offsetHeight);
    };
    img.src = tempImg;
}
window.addEventListener('load', () => {
    try { const saved = localStorage.getItem('loneWorkerState'); if(saved) { state = JSON.parse(saved); if(state.locations) renderLocations(); if(state.meta) checkVehicleStatus(); } } catch(e) {}
    initLocations(); if(!state.settings || !state.settings.workerName) { startWizard(); } else { if(state.activeVisit) enterLockedScreen(); else navigate('main'); if(navigator.onLine) forceSync(false); }
    startGPSMonitoring(); startReminderTimer(); checkIosInstall();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    window.addEventListener('resize', () => { document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => resizeCanvas(canvas)); });
});

window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(!localStorage.getItem('otg_install_dismissed')) document.getElementById('installBanner').classList.remove('hidden'); });
function triggerInstall() { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; }); document.getElementById('installBanner').classList.add('hidden'); } }
function dismissInstall(type) { if(type==='android') document.getElementById('installBanner').classList.add('hidden'); if(type==='ios') document.getElementById('iosInstallModal').classList.add('hidden'); localStorage.setItem('otg_install_dismissed', 'true'); }
function checkIosInstall() { const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase()); const isStandalone = window.navigator.standalone === true; if (isIos && !isStandalone && !localStorage.getItem('otg_install_dismissed')) { document.getElementById('iosInstallModal').classList.remove('hidden'); } }
window.onload = () => {
    // 1. Standardized data restoration
    try {
        loadState(); 
    } catch (e) {
        console.error("Critical: Initialization aborted - ", e);
    }

    // 2. Initialize UI components
    initPanicButton();

    // 3. Robust Routing
    if (!state.settings || !state.settings.workerName) {
        // Force show setup if identity is missing
        navigate('setup'); 
        const setupContainer = document.getElementById('setupPage'); 
        if (setupContainer) setupContainer.classList.remove('hidden');
    } 
    else if (state.activeVisit) {
        // Resume active session
        const activePage = state.activeVisit.status === 'TRAVELLING' ? 'locked' : 'locked';
        navigate(activePage); 
        startCheckinTimer();
        if (state.activeVisit.status === 'TRAVELLING') {
            startTravellingPulse();
        }
        forceSync(false);
    } 
    else {
        navigate('main');
        forceSync(false); 
    }

    console.log("üöÄ System Initialised: All libraries synced.");
};
</script>
 <div id="iosInstallModal" class="hidden fixed bottom-6 left-4 right-4 bg-gray-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl z-[100]">
    <div class="flex items-start gap-4">
        <div class="text-4xl">üì≤</div>
        <div class="flex-1">
            <h3 class="text-lg font-extrabold text-white mb-1">Add to Home Screen</h3>
            <p class="text-gray-300 text-xs mb-4 font-bold">Required for safety background tracking.</p>
            <div class="bg-gray-900 rounded-lg p-3 text-xs text-blue-300 flex items-center gap-2 font-bold uppercase tracking-tighter">
                <span>1. Tap Share</span><span class="text-xl">‚éã</span><span>2. 'Add to Home Screen'</span><span class="text-xl">‚äï</span>
            </div>
        </div>
    </div>
    <button onclick="dismissInstall('ios')" class="w-full mt-4 py-3 bg-blue-600 text-white font-black rounded-xl shadow-lg">Got it</button>
    <div class="ios-arrow"></div>
</div>   
</body>
</html>




























