<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>%%ORG_NAME%% Safety</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1e40af">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
/* 1. FACTORY DYNAMIC THEME */
:root {
    --primary: #1e40af;
    --accent: #3b82f6;
}

/* 2. FORCE SYSTEM DIM: Required to dim the OS navigation bar for Battery Saver */
html.system-dim, body.system-dim { 
    background-color: #000000 !important; 
    color-scheme: dark !important; 
}

/* 3. SOPHISTICATED UI BASE */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: var(--primary); color: white; height: 100%; width: 100%; overflow: hidden; }

.page { 
    display: none; 
    height: 100%; 
    width: 100%; 
    flex-direction: column; 
    position: absolute; 
    top: 0; 
    left: 0; 
    background-color: var(--primary);
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}
.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }
.footer-bar { padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); background-color: var(--primary); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 20; }

/* 4. LONG-PRESS INTERACTION STYLES */
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width 0.2s ease-out; }
.long-press-btn.pressing::after { width: 100%; transition: width 1.5s linear; }

/* 5. GPS SIGNAL BARS */
.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
.gps-bar.active-amber { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }

/* 6. UTILITY CLASSES */
.form-input { width: 100%; background-color: var(--primary); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* 7. POCKET PROTECTION/BATTERY SAVER VISUALS */
#batterySaver { 
    background-color: #000;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
}
#saverProgress { background: rgba(255, 255, 255, 0.2); transition: opacity 1.5s linear; }

/* 8. INSTALL OVERLAYS */
#toastMsg { z-index: 1000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-150%); }
#toastMsg.show { transform: translateY(0); }

/* 9. PHASE 1 ADDITIONS */
#offlineBanner { background: #dc2626; color: white; text-align: center; font-size: 0.75rem; font-weight: 700; padding: 0.25rem; z-index: 50; }
#vehNagBar { background: #ea580c; color: white; text-align: center; font-size: 0.75rem; font-weight: 700; padding: 0.5rem; cursor: pointer; z-index: 40; border-bottom: 1px solid rgba(255,255,255,0.2); }
.form-input-card { width: 100%; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 0.9rem; outline: none; margin-bottom: 0.5rem; display: block; }
.setting-label { display: block; font-size: 0.625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; margin-left: 0.25rem; }
.lbl-blue { color: #60a5fa; }
.lbl-red { color: #f87171; }
.lbl-gray { color: #9ca3af; }

/* Duration slider styling */
.slider-thumb::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--accent);
    cursor: pointer;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-thumb::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--accent);
    cursor: pointer;
    border-radius: 50%;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-thumb::-webkit-slider-thumb:hover {
    background: var(--primary);
    transform: scale(1.1);
}

.slider-thumb::-moz-range-thumb:hover {
    background: var(--primary);
    transform: scale(1.1);
}

/* Panic mode styling */
.panic-mode {
    background: #991b1b !important;
    animation: panic-pulse 2s infinite;
}

@keyframes panic-pulse {
    0%, 100% { background: #991b1b; }
    50% { background: #dc2626; }
}

</style>
</head>
<body class="h-full overflow-hidden select-none">

<!-- Offline Banner -->
<div id="offlineBanner" class="hidden fixed top-0 left-0 w-full">
    üì° OFFLINE MODE - Data queued for upload
</div>

<!-- Vehicle Nag Bar -->
<div id="vehNagBar" class="hidden fixed top-0 left-0 w-full" onclick="startVehicleCheck()">
    ‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete
</div>

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-md transform -translate-y-full transition-transform duration-300" aria-live="polite">
  <p id="toastText"></p>
</div>

<div id="batterySaver" class="hidden fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
    <!-- Timer at top -->
    <div class="absolute top-8 left-0 right-0 text-center">
        <div class="text-4xl font-mono text-white/50" id="dimmedTimer">--:--</div>
        <p class="text-gray-600 text-xs mt-1">Visit in progress</p>
    </div>
    
    <!-- Status display -->
    <div class="flex flex-col items-center gap-6 mb-16">
        <div class="relative">
            <div class="w-24 h-24 rounded-full border-2 border-white/10 flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-white/5 animate-pulse"></div>
            </div>
            <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">
                <span class="text-green-400 text-xs font-bold">üîã <span id="dimmedBattery">--</span>%</span>
            </div>
        </div>
        
        <div class="text-center">
            <h3 class="text-white font-bold text-2xl mb-1">Battery Saver</h3>
            <p class="text-gray-400 text-sm">Slide to wake screen</p>
        </div>
    </div>
    
    <!-- Slide to unlock -->
    <div class="w-80 mx-auto px-6">
        <div id="slideTrack" class="relative h-16 bg-gray-800/50 rounded-full border-2 border-gray-700/50 backdrop-blur-sm overflow-hidden shadow-2xl touch-none">
            <div class="absolute inset-0 bg-blue-500/5 animate-pulse"></div>
            <div id="slideProgress" class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-100 pointer-events-none" style="width: 0%; opacity: 0.4;"></div>
            
            <div id="slideButton" class="absolute left-1 top-1 bottom-1 w-14 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-2xl transition-transform touch-none">
                <svg class="w-6 h-6 text-white animate-pulse pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
            
            <div id="slideText" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <span class="text-gray-500 font-bold text-sm tracking-widest transition-opacity duration-200">SLIDE TO WAKE ‚Üí</span>
            </div>
        </div>
        
        <p class="text-gray-600 text-xs text-center mt-3">Tap screen to peek at timer</p>
    </div>
    
    <!-- Emergency access reminder -->
    <div class="absolute bottom-8 left-0 right-0 text-center">
        <div class="inline-flex items-center gap-2 bg-red-900/20 border border-red-800/30 rounded-full px-4 py-2">
            <span class="text-red-400 text-2xl">üÜò</span>
            <span class="text-red-400 text-xs font-bold">SOS accessible anytime</span>
        </div>
    </div>
</div>

<div id="setupPage" class="page">
    <div class="header-bar">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1">
            <div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div>
            <div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div>
            <div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div>
        </div>
    </div>
    <div class="content-area flex flex-col">
        <div id="wizStep1" class="wizard-step active">
            <h2 class="text-lg font-bold mb-4">Your Identity</h2>
            <input id="wizName" type="text" placeholder="Full Name" class="form-input">
            <input id="wizPhone" type="tel" placeholder="Phone Number" class="form-input">
            <input id="wizEmail" type="email" placeholder="Email Address" class="form-input">
        </div>
        <div id="wizStep2" class="wizard-step">
<form id="wizPinForm" onsubmit="return false;">
    <input type="text" name="username" autocomplete="username" value="Worker" class="hidden" style="display:none !important;">
    <h2 class="text-lg font-bold mb-4">Security PINs</h2>
    <input id="wizPin" type="password" autocomplete="new-password" placeholder="Standard PIN (4-6 digits)" class="form-input" inputmode="numeric" maxlength="6">
    <input id="wizDuress" type="password" autocomplete="new-password" placeholder="Duress PIN (silent alert)" class="form-input" inputmode="numeric" maxlength="6">
</form>
        </div>
        <div id="wizStep3" class="wizard-step">
            <h2 class="text-lg font-bold mb-4">Emergency Contacts</h2>
            <label class="setting-label lbl-red">Primary Emergency Contact</label>
            <input id="wizContactName" type="text" placeholder="Contact Name" class="form-input-card">
            <input id="wizContactPhone" type="tel" placeholder="Contact Phone" class="form-input-card">
            <input id="wizContactEmail" type="email" placeholder="Contact Email" class="form-input mb-4">
            <label class="setting-label lbl-gray">Escalation Contact (Optional)</label>
            <input id="wizEscName" type="text" placeholder="Name" class="form-input-card">
            <input id="wizEscPhone" type="tel" placeholder="Phone" class="form-input-card">
            <input id="wizEscEmail" type="email" placeholder="Email" class="form-input">
        </div>
    </div>
    <div class="footer-bar flex justify-between">
        <button id="btnWizPrev" onclick="prevWiz()" class="hidden px-6 py-3 bg-gray-600 rounded-xl font-bold">Back</button>
        <button id="btnWizNext" onclick="nextWiz()" class="px-6 py-3 bg-blue-600 rounded-xl font-bold">Next Step</button>
    </div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <h1 id="headerWorkerName" class="text-xl font-bold">Welcome</h1>
        <div class="flex gap-2 items-center">
            <div id="gpsIndicator" class="flex gap-1">
                <div class="gps-bar"></div>
                <div class="gps-bar"></div>
                <div class="gps-bar"></div>
            </div>
            <button onclick="navigate('settings')" class="text-2xl text-gray-400 hover:text-white px-2" aria-label="Settings">‚öôÔ∏è</button>
        </div>
    </div>
    
    <!-- Sync Banner -->
    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 font-bold uppercase tracking-widest mx-4 mt-4">
        <div class="spinner"></div>
        <span>Syncing...</span>
    </div>
    
    <div class="content-area">
        <!-- Sync and Add buttons row with travel tile -->
        <div class="flex gap-2 mb-4">
            <button onclick="forceSync(true)" id="btnSync" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-blue-400 text-2xl shadow-lg active:scale-95 transition" title="Sync Database">
                ‚Üª
            </button>
            <button onclick="openAddLocationModal()" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-green-400 text-2xl shadow-lg active:scale-95 transition" title="Add Destination">
                +
            </button>
            <!-- Travel location (flexible width) -->
            <div id="travelRow" class="flex-1"></div>
        </div>
        
        <!-- Regular locations (grid) -->
        <div id="locationList" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div class="footer-bar">
        <!-- Critical Timing Mode Toggle -->
        <div class="flex justify-end items-center gap-2 mb-2">
            <span class="text-[10px] font-bold text-gray-500 tracking-widest" id="lblHighRisk">Critical timing mode</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="chkHighRisk" class="sr-only peer" onchange="toggleHighRiskUI()">
                <div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
            </label>
        </div>
        
        <!-- Duration Slider -->
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2 font-black tracking-tighter">
                <span class="text-gray-400 text-[10px]">TIME</span>
                <span id="durationDisplay" class="text-xs text-blue-400">0 mins</span>
            </div>
            <input id="durationSlider" type="range" min="0" max="31" value="0" 
                   class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb" 
                   oninput="updateDurationDisplay()">
        </div>
        
        <!-- Forms Button + Hold to Start Button -->
        <div class="flex gap-4">
            <button id="btnForms" onclick="openFormsLibrary()" 
                    class="flex-none w-24 py-4 bg-violet-900 text-violet-300 font-bold rounded-xl border border-violet-700/50 shadow-lg active:scale-95 transition text-xs tracking-widest">
                Forms
            </button>
            <button type="button" id="btnStart" 
                    class="long-press-btn flex-1 py-4 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all tracking-tight" 
                    disabled>
                Hold to Start
            </button>
        </div>
    </div>
</div>

<div id="lockedPage" class="page">
    <div class="flex-1 flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <button onclick="toggleBatterySaver()" class="p-2 bg-gray-800 rounded-full text-yellow-400 border border-gray-600 hover:bg-gray-700 shadow-xl" aria-label="Toggle battery saver">
                üåô
            </button>
            <button id="btnPanic" class="w-24 h-24 bg-red-600 rounded-full font-black text-white text-2xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center" aria-label="Emergency panic button">
                SOS
            </button>
        </div>
        <div class="text-center">
            <p class="text-gray-500 text-xs uppercase font-black tracking-[0.3em]">Currently Active At</p>
            <div class="flex items-center justify-center gap-2 mt-1 mb-2 cursor-pointer hover:bg-gray-800 rounded p-2 transition" onclick="showCurrentSiteInfo()">
                <h2 id="lockedLocationName" class="text-3xl font-bold text-white truncate max-w-[250px]"></h2>
                <span class="text-blue-400 text-xl">‚ÑπÔ∏è</span>
            </div>
            <div id="highRiskBadge" class="hidden text-red-500 font-black text-xs uppercase tracking-widest border border-red-500 inline-block px-3 py-1 rounded-lg mb-2">
                ‚ö° CRITICAL TIMING MODE
            </div>
            <div id="overdueLabel" class="hidden text-red-500 font-black text-2xl animate-pulse my-2 tracking-[0.2em] border-2 border-red-500 inline-block px-6 py-2 rounded-xl uppercase">
                OVERDUE
            </div>
            <div id="countdownTimer" class="text-8xl font-bold font-mono text-white tracking-tighter">00:00</div>
            <p class="text-gray-400 mt-2 font-bold uppercase text-[12px] tracking-widest">
                Scheduled Departure: <span id="lockedAnticipatedTime" class="text-blue-400"></span>
            </p>
        </div>
        <div class="space-y-3 w-full">
            <div class="flex gap-3">
                <button id="btnExtend" onclick="showModal('extend')" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl text-lg shadow-lg uppercase tracking-widest">
                    Extend
                </button>
                <button onclick="openFormsLibrary()" class="flex flex-col items-center gap-1 opacity-60 hover:opacity-100 transition-opacity">
    <span class="text-xl">üìã</span>
    <span class="text-[10px] font-bold uppercase tracking-tighter">Forms</span>
</button>
            </div>
            <button id="btnDepart" class="long-press-btn w-full py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl text-xl shadow-2xl uppercase tracking-[0.2em]">
                Hold to END
            </button>
            <button id="btnSafe" class="hidden long-press-btn w-full py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl text-xl shadow-2xl animate-pulse uppercase tracking-[0.2em]">
                I AM SAFE
            </button>
        </div>
    </div>
</div>

<div id="reportPage" class="page">
    <div class="header-bar">
        <h1 id="reportTitle" class="text-xl font-bold">Visit Report</h1>
        <button onclick="closeModal('report')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    <div class="content-area">
        <div id="reportFields"></div>
    </div>
    <div class="footer-bar">
        <button id="btnSubmitRep" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold shadow-lg">Submit Report</button>
    </div>
</div>

<!-- Settings Page -->
<div id="settingsPage" class="page bg-gray-800">
    <div class="header-bar">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    <div class="content-area pb-24">
        <!-- Restart Wizard Prompt -->
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4">
            <p class="text-xs text-blue-200 font-bold">Re-run the setup wizard to change details?</p>
            <button onclick="startWizard()" class="mt-2 text-xs bg-blue-600 px-2 py-1 rounded font-bold">Restart Wizard</button>
        </div>
        
        <div class="mb-6">
            <h2 class="text-xl font-bold text-blue-400 mb-4">Worker Profile</h2>
            <label class="setting-label lbl-blue">Full Name</label>
            <input id="setName" type="text" class="form-input">
            <label class="setting-label lbl-blue">Mobile Number</label>
            <input id="setPhone" type="tel" class="form-input">
            <label class="setting-label lbl-blue">Work Email</label>
            <input id="setEmail" type="email" class="form-input">
        </div>
        <div class="mb-6">
            <h2 class="text-xl font-bold text-red-400 mb-4">Emergency Contacts</h2>
            <label class="setting-label lbl-red">Primary Emergency Contact</label>
            <input id="setEmgName" type="text" class="form-input-card">
            <input id="setEmgPhone" type="tel" class="form-input-card">
            <input id="setEmgEmail" type="email" class="form-input mb-4">
            <label class="setting-label lbl-gray">Escalation Contact</label>
            <input id="setEscName" type="text" class="form-input-card">
            <input id="setEscPhone" type="tel" class="form-input-card">
            <input id="setEscEmail" type="email" class="form-input">
        </div>
        <div class="mb-6">
            <h2 class="text-xl font-bold text-purple-400 mb-4">Advanced</h2>
            <div class="bg-gray-900 p-4 rounded-xl mb-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="setAdvanced" onchange="toggleAdvancedGPS(this.checked)" class="w-6 h-6 rounded text-blue-600">
                    <div>
                        <div class="text-white font-bold">Advanced GPS Monitoring</div>
                        <div class="text-xs text-gray-400">Continuous tracking (higher battery use)</div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- System Info Section -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-400 mb-4">System Info</h2>
            <div class="setting-card border-gray-600">
                <label class="setting-label lbl-gray">Backend Connection</label>
                <input id="setBackendUrl" disabled class="form-input-card text-xs font-mono text-gray-400 mb-2" value="">
                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">App Version</div>
                        <div id="appVersion" class="text-sm font-mono text-blue-400">v1.0.0</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Backend Version</div>
                        <div id="backendVersion" class="text-sm font-mono text-green-400">...</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Sync Status</div>
                        <div id="syncStatus" class="text-sm font-mono text-gray-400">Checking...</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="forceSync(true)" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white uppercase">Force Sync</button>
                    <button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white uppercase">Clear Cache</button>
                </div>
            </div>
        </div>
        
        <div class="space-y-3">
            <button onclick="saveSettings()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg">
                üíæ Save Settings
            </button>
            <button onclick="clearData()" class="w-full py-4 bg-red-900/50 text-red-400 hover:bg-red-900/70 font-bold rounded-xl shadow-lg uppercase">
                Reset App Data
            </button>
        </div>
    </div>
</div>

<!-- Extend Modal -->
<div id="extendModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center border border-gray-700">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Extend Visit</h2>
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="confirmExtension(10)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+10</button>
            <button onclick="confirmExtension(15)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+15</button>
            <button onclick="confirmExtension(30)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+30</button>
        </div>
        <button onclick="closeModal('extend')" class="w-full py-4 bg-gray-700 rounded-xl font-black text-gray-400 uppercase">Cancel</button>
    </div>
</div>

<!-- Vehicle WOF Block Modal -->
<div id="wofBlockModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-10 text-center border-4 border-red-600">
        <div class="text-7xl mb-6">‚õî</div>
        <h2 class="text-3xl font-black text-red-500 mb-4 uppercase">STOP</h2>
        <p class="text-lg text-white font-bold mb-6">This vehicle has an EXPIRED WOF or Registration. It is prohibited for work use.</p>
        <button onclick="closeWofBlocker()" class="w-full py-5 bg-red-600 text-white font-black rounded-2xl text-xl shadow-2xl">I Understand</button>
    </div>
</div>

<!-- Vehicle WOF Warning Modal -->
<div id="wofWarnModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center border-4 border-orange-500">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-black text-orange-500 mb-2 uppercase">VEHICLE COMPLIANCE</h2>
        <p class="text-white font-bold mb-6">Vehicle WOF or Rego is expiring soon:<br><span id="wofWarnText" class="text-2xl text-orange-400 font-black"></span></p>
        <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 text-left mb-6">
            <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="chkWofAck" class="mt-1 w-6 h-6 rounded text-blue-600" onchange="toggleWofContinue()">
                <span class="text-sm text-gray-300 font-bold">I acknowledge the vehicle is legal and safe to operate.</span>
            </label>
        </div>
        <button id="btnWofContinue" disabled onclick="closeWofWarn()" class="w-full py-4 bg-gray-700 text-gray-500 font-black rounded-2xl text-lg transition-all">Continue</button>
    </div>
</div>

<!-- Site Info Modal (Phase 2, Feature 9) -->
<div id="infoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto border border-gray-700">
        <h2 class="text-2xl font-black text-white mb-4">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm space-y-3 mb-6"></div>
        <div class="flex gap-3 mb-4">
            <a id="btnSiteCall" href="#" class="hidden flex-1 bg-green-600 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest">üìû Call</a>
            <a id="btnSiteEmail" href="#" class="hidden flex-1 bg-blue-600 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest">‚úâÔ∏è Email</a>
        </div>
        <a id="btnSiteNav" href="#" target="_blank" class="hidden block w-full py-4 bg-purple-600 text-white font-black rounded-xl text-center mb-4 uppercase tracking-widest">üó∫Ô∏è Navigate</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 text-gray-300 font-black rounded-xl uppercase tracking-widest">Close</button>
    </div>
</div>

<!-- Location Management Modal (Phase 2, Feature 13) -->
<div id="locationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-gray-700 max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Edit Location</h2>
        <input type="hidden" id="locId">
        <div class="space-y-4">
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Business Name</label>
                <input type="text" id="locBusiness" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Site Name</label>
                <input type="text" id="locName" class="form-input" placeholder="Required">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Physical Address</label>
                <div class="flex gap-2">
                    <input type="text" id="locAddr" class="form-input mb-0 flex-1">
                    <button onclick="getGpsAddress()" class="bg-blue-600 text-white p-3 rounded-xl font-black text-xs shrink-0">üìç GPS</button>
                </div>
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Name</label>
                <input type="text" id="locContactName" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Phone</label>
                <input type="tel" id="locContactPhone" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Email</label>
                <input type="email" id="locContactEmail" class="form-input" placeholder="Optional">
            </div>
            <div class="bg-gray-900 p-3 rounded-xl">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="locCritical" class="w-5 h-5 rounded text-red-600">
                    <span class="text-sm text-white font-bold">‚ö° Critical Timing Mode (High-Risk Site)</span>
                </label>
            </div>
        </div>
        <div class="mt-8 flex gap-3">
            <button onclick="deleteLoc()" id="btnDelLoc" class="hidden bg-red-900/50 text-red-400 font-black py-3 px-6 rounded-xl uppercase text-xs tracking-widest border border-red-800/30">Delete</button>
            <div class="flex-1"></div>
            <button onclick="closeModal('location')" class="bg-gray-700 text-white font-black py-3 px-6 rounded-xl uppercase text-xs tracking-widest">Cancel</button>
            <button onclick="saveLoc()" class="bg-blue-600 text-white font-black py-3 px-8 rounded-xl shadow-xl uppercase text-xs tracking-widest">Save</button>
        </div>
    </div>
</div>

<div id="pinModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <form id="pinEntryForm" onsubmit="return false;">
    <input type="text" name="username" autocomplete="username" value="Worker" class="hidden" style="display:none !important;">
    <h3 class="text-lg font-bold mb-4">Enter PIN</h3>
    <input id="pinInput" type="password" autocomplete="current-password" class="form-input mb-4" inputmode="numeric" maxlength="6">
    <button id="btnPinConfirm" type="button" class="w-full py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
        </form>
    </div>
</div>

<div id="groundedModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <h3 class="text-lg font-bold mb-4">Vehicle Grounded</h3>
        <p class="text-gray-300 mb-4">WOF or Rego expired. Cannot proceed.</p>
        <button onclick="closeModal('grounded')" class="w-full py-3 bg-red-600 rounded-xl font-bold">OK</button>
    </div>
</div>

<div id="iosInstallModal" class="hidden fixed bottom-6 left-4 right-4 bg-gray-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl z-[100]">
    <div class="flex items-start gap-4">
        <div class="text-4xl">üì≤</div>
        <div class="flex-1">
            <h3 class="text-lg font-extrabold text-white mb-1">Add to Home Screen</h3>
            <p class="text-gray-300 text-xs mb-4 font-bold">Required for safety background tracking.</p>
            <div class="bg-gray-900 rounded-lg p-3 text-xs text-blue-300 flex items-center gap-2 font-bold uppercase tracking-tighter">
                <span>1. Tap Share</span><span class="text-xl">‚éã</span><span>2. 'Add to Home Screen'</span><span class="text-xl">‚äï</span>
            </div>
        </div>
        <button onclick="dismissInstall('ios')" class="text-gray-500 font-black p-2">‚úï</button>
    </div>
</div>

<!-- Android Install Banner (Phase 3, Feature 17) -->
<div id="installBanner" class="hidden fixed top-0 left-0 w-full bg-blue-600 text-white p-4 z-[100] shadow-xl flex items-center justify-between">
    <div class="flex items-center gap-3">
        <span class="text-2xl">üì≤</span>
        <div>
            <p class="font-bold text-sm">Install Safety App</p>
            <p class="text-xs opacity-90">Add to home screen for safety monitoring.</p>
        </div>
    </div>
    <div class="flex gap-2">
        <button onclick="dismissInstall('android')" class="px-3 py-1 text-xs font-bold bg-blue-700 rounded">Later</button>
        <button onclick="triggerInstall()" class="px-4 py-1 text-xs font-black bg-white text-blue-600 rounded">Install</button>
    </div>
</div>

<!-- Shake-to-Alert Confirmation Modal -->
<div id="shakeConfirmModal" class="hidden fixed inset-0 z-[120] bg-red-900/90 flex items-center justify-center">
    <div class="text-center text-white animate-pulse">
        <div class="text-8xl mb-4">‚ö†Ô∏è</div>
        <h1 class="text-4xl font-black mb-4">SHAKE DETECTED</h1>
        <p class="text-yellow-400 text-lg font-bold mb-6">Shake again to confirm panic alert</p>
        <div class="text-6xl font-mono" id="shakeCountdown">3</div>
        <p class="text-xs mt-4 text-gray-400">Covert alert activation</p>
    </div>
</div>

<!-- Volume Panic Confirmation Modal -->
<div id="volumeConfirmModal" class="hidden fixed inset-0 z-[120] bg-orange-900/90 flex items-center justify-center">
    <div class="text-center text-white">
        <div class="text-8xl mb-4">üîä</div>
        <h1 class="text-4xl font-black mb-4">VOLUME PANIC</h1>
        <p class="text-yellow-400 text-lg font-bold mb-6">Press volume buttons again to confirm</p>
        <div class="text-6xl font-mono" id="volumeCountdown">3</div>
        <p class="text-xs mt-4 text-gray-400">Emergency alert activation</p>
    </div>
</div>

<script>
// ============================================================================
// CONFIGURATION SYSTEM (Phase 2, Feature 11)
// ============================================================================
// Duration mapping: 32 steps from 0 to 8 hours (480 minutes)
// Slider positions 0-31 map to these durations in minutes
const DURATION_MAP = [
    0, 10, 15, 20, 30, 45,     // 0-5: Quick visits (0-45 min)
    60, 75, 90, 105, 120,       // 6-10: Short visits (1-2 hours)
    135, 150, 165, 180,         // 11-14: Medium visits (2-3 hours)
    195, 210, 225, 240,         // 15-18: Long visits (3-4 hours)
    255, 270, 285, 300,         // 19-22: Extended visits (4-5 hours)
    315, 330, 345, 360,         // 23-26: Very long visits (5-6 hours)
    390, 420, 450, 480          // 27-31: Maximum visits (6-8 hours)
];

const CONFIG = {
    // Backend
    url: "%%GOOGLE_SHEET_URL%%",
    org: "%%ORG_NAME%%",
    key: "%%WORKER_KEY%%",  // Factory injects worker-specific key (wk_xxxxx)
    
    // Features
    isAdvanced: true,
    mileageEnabled: true,
    vehEnabled: true,
    checkinEnabled: false,
    
    // Timing
    vehInterval: 120, // days
    escalationMinutes: 15,
    checkinInterval: 60, // minutes
    
    // Localization (Phase 2, Feature 10 & Phase 3, Feature 19)
    countryPrefix: "%%COUNTRY_PREFIX%%",
    vehicleTerm: "%%VEHICLE_TERM%%",
    voiceLocale: "%%VOICE_LOCALE%%",
    
    // Requirements
    reqTravelReport: true
};

// ============================================================================
// GLOBALS AND STATE INITIALIZATION
// ============================================================================
let state; // Declared but not initialized until onload
let dimTimer;
let isDimmed = false;
const DIM_DELAY = 10000; // 10 seconds
let checkinIntervalId;
let travellingInterval;
let timerInt;
let deferredPrompt;
let lastAlertTime = 0;
let lastGPS = null;
let synth; // Tone.js synth - initialized after user interaction
let audioReady = false;
let gpsWatchId = null; // Track GPS watch for cleanup

// PHASE 1 ADDITIONS
let isMidVisitUpdate = false; // Track if we're updating mid-visit vs ending
let currentBatteryLevel = "100%";

// PHASE 2+ ADDITIONS: Covert panic activation methods
let shakeBuffer = [];
let lastShakeTime = 0;
let shakeConfirmationMode = false;
let shakeConfirmationTimeout = null;

let volumeBuffer = [];
let volumeConfirmationMode = false;
let volumeConfirmationTimeout = null;

let wakeLock = null;
let isSliding = false;
let slideStartX = 0;
let isSosLocked = false; // Prevent SOS immediately after wake

// ============================================================================
// AUDIO INITIALIZATION (Must be after user interaction)
// ============================================================================
// Note: Tone.js displays a banner in console - this is normal and can be ignored
// Note: Tailwind CDN warning is expected - this is a PWA, not a traditional build process

async function initAudio() {
    if (!audioReady && typeof Tone !== 'undefined') {
        try {
            // Suppress Tone.js console banner (optional)
            const originalLog = console.log;
            console.log = function() {};
            
            await Tone.start();
            synth = new Tone.Synth().toDestination();
            audioReady = true;
            
            // Restore console
            console.log = originalLog;
            console.log('‚úÖ Audio initialized successfully');
        } catch (e) {
            console.warn('Audio initialization failed:', e);
            audioReady = false;
        }
    }
}

// Initialize audio on first user interaction
document.addEventListener('click', initAudio, { once: true });
document.addEventListener('touchstart', initAudio, { once: true });

// ============================================================================
// STATE PERSISTENCE
// ============================================================================
function loadState() {
    try {
        const saved = localStorage.getItem('loneWorkerState');
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error('Load state failed:', e);
    }
    return null;
}

function saveState() {
    try {
        localStorage.setItem('loneWorkerState', JSON.stringify(state));
    } catch (e) {
        console.error('Save state failed:', e);
    }
}

// ============================================================================
// NAVIGATION
// ============================================================================
function navigate(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(page + 'Page');
    if (targetPage) {
        targetPage.classList.add('active');
        
        // PHASE 1: Populate settings page when navigating to it
        if (page === 'settings') {
            populateSettingsForm();
            updateSystemInfo(); // Update backend connection status
        }
        
        resetInactivityTimer();
    } else {
        console.error(`Page not found: ${page}Page`);
    }
}

// ============================================================================
// MODALS
// ============================================================================
function showModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ============================================================================
// TOAST NOTIFICATIONS
// ============================================================================
function showToast(text) {
    const toastText = document.getElementById('toastText');
    const toastMsg = document.getElementById('toastMsg');
    if (toastText && toastMsg) {
        toastText.innerText = text;
        toastMsg.classList.add('show');
        setTimeout(() => toastMsg.classList.remove('show'), 3000);
    }
}

// ============================================================================
// VOICE ANNOUNCE (Web Speech with fallback)
// ============================================================================
function announce(text) {
    if ('speechSynthesis' in window) {
        try {
            const utter = new SpeechSynthesisUtterance(text);
            
            // Wait for voices to load on some browsers
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    speechSynthesis.speak(utter);
                }, { once: true });
            } else {
                speechSynthesis.speak(utter);
            }
        } catch (e) {
            console.warn('Speech synthesis failed:', e);
            showToast(text);
        }
    } else {
        showToast(text);
    }
}

// ============================================================================
// UPDATED: MISSION-CRITICAL SAFETY LOGGING
// ============================================================================
async function logSafety(type, message) {
    console.log(`[${type}] ${message}`);
    
    // Construct the precise payload required by the Google Script backend
    const data = {
        'Alarm Status': type,
        'Notes': message,
        'Last Known GPS': lastGPS || "0,0",
        'GPS Timestamp': new Date().toLocaleString(),
        'Battery Level': await getBatteryPercent(),
        'App Version': 'v81.36'
    };

    // Pass this through buildPayload to add worker credentials and action keys
    const fullPayload = buildPayload(data);
    fullPayload['action'] = 'logVisit'; // Ensure action is explicit for ingestion

    processUploadQueue(fullPayload);
}

async function getBatteryPercent() {
    try {
        if ('getBattery' in navigator) {
            const battery = await navigator.getBattery();
            return Math.floor(battery.level * 100) + '%';
        }
    } catch (e) {
        console.info('Battery API not available:', e);
    }
    return 'Unknown';
}

// Placeholder for report submission
function submitReport() {
    const d = gatherFormData();
    let photoCount = 0;
    const photoMap = {};
    
    // Process photos
    Object.keys(state.photoStore || {}).forEach((key, index) => {
        photoCount++;
        const token = `{{PHOTO_${photoCount}}}`;
        photoMap[`Photo ${photoCount}`] = state.photoStore[key];
        
        if (d.custom[key] !== undefined) {
            d.custom[key] = token;
            d.jsonPayload[key] = token;
        }
    });
    
    // Build form data object
    const fd = {
        ...d.custom,
        "Visit Report Data": JSON.stringify(d.jsonPayload),
        "Template Name": currentActiveTemplate
    };
    
    // Add distance if available
    if (d.custom && d.custom["Distance (km)"]) {
        fd["Distance"] = d.custom["Distance (km)"];
    }
    
    // Add photos
    Object.entries(photoMap).forEach(([k, v]) => {
        fd[k] = v;
    });
    
    // Add signature
    if (d.sig) fd["Signature"] = d.sig;
    
    // Determine alarm status
    let alarmStatus;
    if (!state.activeVisit) {
        alarmStatus = "DATA_ENTRY_ONLY";
    } else if (isMidVisitUpdate) {
        alarmStatus = state.activeVisit.locationId === 'travel' ? "TRAVELLING" : "ON SITE";
    } else {
        alarmStatus = "DEPARTED";
    }
    
    // Send to backend
    processUploadQueue(buildPayload({
        ...fd,
        "Alarm Status": alarmStatus,
        "Notes": d.notes || ""
    }));
    
    // Handle UI
    if (!isMidVisitUpdate) {
        // End visit
        state.activeVisit = null;
        state.selectedLocationId = null;
        state.visitDurationMinutes = 0;
        
        // Clear photos
        state.photoStore = {};
        
        // Stop timer
        if (timerInt) {
            clearInterval(timerInt);
            timerInt = null;
        }
        
        saveState();
        closeModal('report');
        navigate('main');
        renderLocations();
        showToast('‚úÖ Visit completed');
    } else {
        // Mid-visit update
        closeModal('report');
        showToast('‚úÖ Update sent');
    }
}

// ============================================================================
// LONG-PRESS INTERACTION
// ============================================================================
/**
 * Unified Long-Press Utility with Safety Lock
 * Handles visual progress and prevents accidental triggers on wake.
 */
function setupLongPress(elementId, duration, callback) {
    const btn = document.getElementById(elementId);
    if (!btn) return;
    
    let timer;
    
    btn.addEventListener('touchstart', (e) => {
        // SAFETY GUARD: Prevent accidental SOS if the screen just woke up
        if (elementId === 'btnPanic' && typeof isSosLocked !== 'undefined' && isSosLocked) {
            showToast('‚è≥ Wait... screen just woke');
            return;
        }

        // Visual feedback
        btn.classList.add(duration === 1500 ? 'pressing' : 'holding');
        
        timer = setTimeout(() => {
            btn.classList.remove('pressing', 'holding');
            callback();
        }, duration);
    }, { passive: true });

    ['touchend', 'touchcancel', 'touchmove'].forEach(ev => {
        btn.addEventListener(ev, () => {
            clearTimeout(timer);
            btn.classList.remove('pressing', 'holding');
        });
    });
}

// ============================================================================
// INACTIVITY DIM MODE
// ============================================================================
function resetInactivityTimer() {
    clearTimeout(dimTimer);
    if (state && state.activeVisit) {
        dimTimer = setTimeout(activateDimMode, DIM_DELAY);
    }
    deactivateDimMode();
}

function activateDimMode() {
    if (!state || !state.activeVisit) return;
    document.documentElement.classList.add('system-dim');
    document.body.classList.add('system-dim');
    isDimmed = true;
    const batterySaver = document.getElementById('batterySaver');
    const saverProgress = document.getElementById('saverProgress');
    if (batterySaver) batterySaver.classList.remove('hidden');
    if (saverProgress) saverProgress.style.width = '100%';
}

function deactivateDimMode() {
    document.documentElement.classList.remove('system-dim');
    document.body.classList.remove('system-dim');
    isDimmed = false;
    const batterySaver = document.getElementById('batterySaver');
    const saverProgress = document.getElementById('saverProgress');
    if (batterySaver) batterySaver.classList.add('hidden');
    if (saverProgress) saverProgress.style.width = '0%';
}

// Battery saver wake button
const wakeButton = document.getElementById('wakeButton');
if (wakeButton) {
    wakeButton.addEventListener('touchstart', e => {
        e.preventDefault();
        let wakeTimer = setTimeout(() => {
            deactivateDimMode();
            resetInactivityTimer();
        }, 1500);
        ['touchend', 'touchcancel'].forEach(ev => {
            document.addEventListener(ev, () => clearTimeout(wakeTimer), { once: true });
        });
    });
}

// ============================================================================
// GPS MONITORING
// ============================================================================
function startGPSMonitoring() {
    // Stop any existing watch
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    
    if (navigator.geolocation) {
        gpsWatchId = navigator.geolocation.watchPosition(
            pos => {
                lastGPS = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                updateGPSBars(pos);
            },
            err => {
                console.error('GPS error:', err);
                // Update UI to show GPS unavailable
                const bars = document.querySelectorAll('.gps-bar');
                bars.forEach(b => {
                    b.classList.remove('active-red', 'active-amber', 'active-green');
                    b.style.backgroundColor = '#374151';
                });
            },
            { 
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
            }
        );
    }
}

function stopGPSMonitoring() {
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
}

function updateGPSBars(pos) {
    const accuracy = pos.coords.accuracy;
    const bars = document.querySelectorAll('.gps-bar');
    bars.forEach(b => b.classList.remove('active-red', 'active-amber', 'active-green'));
    if (accuracy > 50) {
        bars.forEach(b => b.classList.add('active-red'));
    } else if (accuracy > 20) {
        bars.forEach(b => b.classList.add('active-amber'));
    } else {
        bars.forEach(b => b.classList.add('active-green'));
    }
}

// Capture GPS for forms
function captureGPS(btn) {
    if (!navigator.geolocation) return showToast("GPS Not Supported");
    btn.innerText = "‚åõ...";
    navigator.geolocation.getCurrentPosition(
        pos => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) input.value = coords;
            showToast("Location Captured");
            btn.innerText = "GPS";
        },
        err => {
            showToast("GPS Error: Enable location");
            btn.innerText = "GPS";
            console.error('GPS capture error:', err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// ============================================================================
// CHECK-IN TIMER
// ============================================================================
function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state && state.activeVisit) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

// ============================================================================
// TRAVELLING PULSE
// ============================================================================
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        if (state && state.activeVisit && state.activeVisit.status === 'TRAVELLING') {
            // Send periodic location pulse
            logSafety('TRAVELLING', 'Location pulse');
        }
    }, 120000); // 2 minutes
}

// ============================================================================
// REPORT FORM BUILDING
// ============================================================================
function buildReportForm(templateName, fieldArea) {
    if (!fieldArea) return;
    fieldArea.innerHTML = ''; // Clear
    const template = state.globalForms.find(f => f.name === templateName) || { 
        fields: '[TEXT|Notes] [GPS|Location] [PHOTO|Photo1] [SIGN|Signature] [NUMBER|Quantity]' 
    };
    const tags = template.fields.match(/\[[\w$]+\|.*?\]/g) || [];
    
    tags.forEach(tag => {
        // Parse field: [TYPE|Label] or [DROP|Label|Option1,Option2,Option3]
        const parts = tag.slice(1, -1).split('|');
        const type = parts[0];
        const label = parts[1];
        const options = parts[2] ? parts[2].split(',').map(o => o.trim()) : [];
        
        const fieldId = `field_${label.replace(/\s/g, '_')}`;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-4';
        
        const labelEl = document.createElement('label');
        labelEl.className = 'block text-sm font-bold mb-2';
        labelEl.innerText = label;
        labelEl.htmlFor = fieldId;
        wrapper.appendChild(labelEl);
        
        if (type === 'TEXT') {
            const input = document.createElement('textarea');
            input.id = fieldId;
            input.className = 'form-input';
            input.rows = 3;
            wrapper.appendChild(input);
            
        } else if (type === '1TEXT') {
            // Single-line text input
            const input = document.createElement('input');
            input.type = 'text';
            input.id = fieldId;
            input.className = 'form-input';
            wrapper.appendChild(input);
            
        } else if (type === 'DROP') {
            // Dropdown select
            const select = document.createElement('select');
            select.id = fieldId;
            select.className = 'form-input';
            
            // Add placeholder option
            const placeholderOpt = document.createElement('option');
            placeholderOpt.value = '';
            placeholderOpt.text = '-- Select --';
            select.appendChild(placeholderOpt);
            
            // Add options
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.text = opt;
                select.appendChild(option);
            });
            
            wrapper.appendChild(select);
            
        } else if (type === '$' || type === 'CURRENCY') {
            // Currency input with symbol
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'flex items-center';
            
            const symbol = document.createElement('span');
            symbol.className = 'px-3 py-2 bg-gray-700 border border-r-0 border-gray-600 rounded-l text-sm';
            symbol.innerText = '$'; // Can be regionalized via CONFIG
            
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.id = fieldId;
            input.className = 'form-input rounded-l-none';
            input.placeholder = '0.00';
            
            inputWrapper.appendChild(symbol);
            inputWrapper.appendChild(input);
            wrapper.appendChild(inputWrapper);
            
        } else if (type === 'GPS') {
            const btnGPS = document.createElement('button');
            btnGPS.innerText = 'Capture GPS';
            btnGPS.className = 'px-4 py-2 bg-blue-600 rounded mb-2';
            btnGPS.onclick = () => captureGPS(btnGPS);
            const input = document.createElement('input');
            input.id = fieldId;
            input.className = 'form-input';
            input.readOnly = true;
            wrapper.appendChild(btnGPS);
            wrapper.appendChild(input);
            
        } else if (type === 'PHOTO') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.id = fieldId;
            input.className = 'form-input';
            input.onchange = () => handlePhoto(input, label);
            wrapper.appendChild(input);
            
        } else if (type === 'NUMBER') {
            const input = document.createElement('input');
            input.type = 'number';
            input.id = fieldId;
            input.className = 'form-input';
            wrapper.appendChild(input);
            
        } else if (type === 'SIGN') {
            const canvas = document.createElement('canvas');
            canvas.id = `sig-canvas-${label.replace(/\s/g, '_')}`;
            canvas.width = 300;
            canvas.height = 150;
            canvas.className = 'border-2 border-gray-600 rounded bg-white';
            canvas.style.touchAction = 'none';
            
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'mt-2 px-3 py-1 bg-gray-600 text-white rounded text-sm';
            clearBtn.innerText = 'Clear';
            clearBtn.onclick = () => clearSig(label.replace(/\s/g, '_'));
            
            wrapper.appendChild(canvas);
            wrapper.appendChild(clearBtn);
            
            // Initialize signature pad after adding to DOM
            setTimeout(() => {
                const canvasEl = document.getElementById(`sig-canvas-${label.replace(/\s/g, '_')}`);
                if (canvasEl) {
                    resizeCanvas(canvasEl);
                    initSigPad(canvasEl);
                }
            }, 100);
        }
        
        fieldArea.appendChild(wrapper);
    });
}

// ============================================================================
// PIN VERIFICATION
// ============================================================================
function withPinVerification(allowDuress, callback) {
    showModal('pin');
    const pinInput = document.getElementById('pinInput');
    const btnConfirm = document.getElementById('btnPinConfirm');
    
    if (!pinInput || !btnConfirm) return;
    
    pinInput.value = '';
    pinInput.focus();
    
    btnConfirm.onclick = () => {
        const value = pinInput.value;
        closeModal('pin');
        if (value === state.pins.std) {
            callback();
        } else if (allowDuress && value === state.pins.duress) {
            triggerPanic(true); // Silent duress
        } else {
            showToast("Incorrect PIN");
        }
    };
}

// ============================================================================
// PRE-DEPART
// ============================================================================
// Load form modal and show it
function loadFormAndShow(templateName) {
    // Clear signature canvas
    const sigCanvas = document.querySelector('canvas[id^="sig-canvas-"]');
    if (sigCanvas) {
        clearSig(sigCanvas.id.replace('sig-canvas-', ''));
    }
    
    // Show report modal
    showModal('report');
    
    // Set title
    const title = templateName === '(Standard)' ? 'Status Update' : templateName;
    const titleEl = document.getElementById('reportTitle');
    if (titleEl) {
        titleEl.textContent = isMidVisitUpdate ? `Update: ${title}` : title;
    }
    
    currentActiveTemplate = templateName;
    
    // Build form fields
    const fieldsContainer = document.getElementById('reportFields');
    if (fieldsContainer) {
        buildReportForm(templateName, fieldsContainer);
    }
    
    // Initialize signature pads after form is built
    setTimeout(() => {
        document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => {
            resizeCanvas(canvas);
            initSigPad(canvas);
        });
    }, 100);
    
    // Pre-fill distance if available
    if (calculatedDist) {
        const distInput = document.querySelector('[data-key*="Distance"]') || 
                         document.querySelector('[data-key*="KM"]') ||
                         document.querySelector('[data-key*="distance"]');
        if (distInput) {
            distInput.value = calculatedDist.km;
            distInput.style.border = '2px solid #4ade80';
            distInput.classList.add('bg-green-900/20');
        }
    }
    
    // Setup submit button
    const btn = document.getElementById('btnSubmitRep');
    if (btn) {
        // Clone to remove old listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        if (!state.activeVisit) {
            // Data entry only
            newBtn.textContent = 'SUBMIT REPORT';
            newBtn.classList.remove('long-press-btn');
            newBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            newBtn.onclick = submitReport;
        } else if (isMidVisitUpdate) {
            // Mid-visit update
            newBtn.textContent = 'SEND UPDATE';
            newBtn.classList.remove('long-press-btn');
            newBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            newBtn.onclick = submitReport;
        } else {
            // End visit
            newBtn.textContent = 'HOLD TO SUBMIT & END';
            newBtn.classList.add('long-press-btn');
            setupLongPress(newBtn, 2000, submitReport);
        }
    }
}

function preDepart() {
    if (!state || !state.activeVisit) return;
    
    isMidVisitUpdate = false;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    
    if (!location) {
        showToast('‚ö†Ô∏è Location not found');
        return;
    }
    
    // For travel locations - calculate distance
    if (location.id === 'travel' || location.isTravel) {
        // Check if report is required
        if (location.noReport) {
            submitReport();
            return;
        }
        
        const btnDepart = document.getElementById('btnDepart');
        if (btnDepart) btnDepart.textContent = 'Getting GPS...';
        
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                const endGPS = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
                const startGPS = state.activeVisit.startGPS;
                
                if (startGPS && endGPS) {
                    try {
                        calculatedDist = await getDistance(startGPS, endGPS);
                        console.log('Distance calculated:', calculatedDist);
                    } catch (err) {
                        console.error('Distance calc error:', err);
                        const dist = haversine(startGPS, endGPS);
                        calculatedDist = { km: dist.toFixed(2), type: 'crow', offline: true };
                    }
                }
                
                if (btnDepart) btnDepart.textContent = 'HOLD TO END';
                loadFormAndShow(location.templateName || '(Standard)');
            },
            (err) => {
                console.error('GPS error:', err);
                if (btnDepart) btnDepart.textContent = 'HOLD TO END';
                calculatedDist = null;
                loadFormAndShow(location.templateName || '(Standard)');
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    } else if (location.noReport) {
        // Regular location with no report required
        submitReport();
    } else {
        // Regular location with report required
        calculatedDist = null;
        loadFormAndShow(location.templateName || '(Standard)');
    }
}


// ============================================================================
// ENTER LOCKED SCREEN
// ============================================================================
function enterLockedScreen() {
    navigate('locked');
    
    // PHASE 1: Initialize warning flags and anticipated departure time
    if (state && state.activeVisit) {
        // anticipatedDepartureTime should already be set by startVisit()
        // but fallback just in case
        if (!state.activeVisit.anticipatedDepartureTime) {
            const durationMs = (state.activeVisit.duration || 3600) * 1000;
            state.activeVisit.anticipatedDepartureTime = state.activeVisit.startTime + durationMs;
        }
        
        // Initialize all warning flags
        if (state.activeVisit.warn5minSent === undefined) state.activeVisit.warn5minSent = false;
        if (state.activeVisit.warn2minSent === undefined) state.activeVisit.warn2minSent = false;
        if (state.activeVisit.warn90Sent === undefined) state.activeVisit.warn90Sent = false;
        if (state.activeVisit.warningSent === undefined) state.activeVisit.warningSent = false;
        if (state.activeVisit.criticalSent === undefined) state.activeVisit.criticalSent = false;
        
        // Set location name in header
        const locNameEl = document.getElementById('lockedLocationName');
        if (locNameEl) {
            locNameEl.innerText = state.activeVisit.locationName || 'Unknown';
        }
        
        saveState();
    }
    
    // Setup long-press handlers for buttons
    const btnDepart = document.getElementById('btnDepart');
    if (btnDepart) setupLongPress(btnDepart, 2000, preDepart);
    
    const btnExtend = document.getElementById('btnExtend');
    if (btnExtend) setupLongPress(btnExtend, 1500, () => showModal('extend'));
    
    const btnSafe = document.getElementById('btnSafe');
    if (btnSafe) setupLongPress(btnSafe, 2000, iamSafe);
    
    // Start the countdown timer
    if (!timerInt) {
        timerInt = setInterval(tick, 1000);
    }
    
    startCheckinTimer();
}

// ============================================================================
// TRIGGER PANIC
// ============================================================================
async function triggerPanic(duress = false) {
    document.body.classList.add('bg-red-900');
    announce(duress ? "Duress activated silently." : "Panic alarm activated.");
    
    // Play audible alarm if audio is ready
    await initAudio();
    if (audioReady && synth) {
        try {
            synth.triggerAttackRelease('C4', '8n');
        } catch (e) {
            console.warn('Audio playback failed:', e);
        }
    }
    
    await logSafety(duress ? "DURESS" : "PANIC", "Alert triggered.");
    
    // Mark panic in state
    if (state && state.activeVisit) {
        state.activeVisit.isPanic = true;
        if (duress) state.activeVisit.isDuress = true;
        saveState();
    }
}

// PHASE 1: I AM SAFE function (after alarm triggered)
function iamSafe() {
    if (!state || !state.activeVisit) return;
    
    // Require PIN to declare safe
    withPinVerification(false, () => {
        announce("Safety confirmed. Resetting alarm.");
        logSafety("USER_SAFE", "Worker entered PIN to cancel alarm state.");
        
        // Reset panic UI
        const lockedPage = document.getElementById('lockedPage');
        if (lockedPage) lockedPage.classList.remove('panic-mode');
        document.body.classList.remove('bg-red-900');
        
        // Clear alarm state
        state.activeVisit.isPanic = false;
        state.activeVisit.criticalSent = false;
        
        // Hide "I AM SAFE" button, show normal buttons
        const btnSafe = document.getElementById('btnSafe');
        const btnDepart = document.getElementById('btnDepart');
        const btnExtend = document.getElementById('btnExtend');
        if (btnSafe) btnSafe.classList.add('hidden');
        if (btnDepart) btnDepart.classList.remove('hidden');
        if (btnExtend) btnExtend.classList.remove('hidden');
        
        saveState();
        showToast("‚úÖ Safety status confirmed");
    });
}

// ============================================================================
// SAFETY HEARTBEAT (tick)
// ============================================================================
function tick() {
    if (state && state.activeVisit) {
        const remaining = state.activeVisit.duration - (Date.now() - state.activeVisit.startTime) / 1000;
        const remainingMs = remaining * 1000;
        
        // PHASE 1: Multiple warning levels
        // 5-minute warning (300 seconds)
        if (remaining <= 300 && remaining > 299 && !state.activeVisit.warn5minSent) {
            playWarningSound('warning');
            state.activeVisit.warn5minSent = true;
            saveState();
        }
        
        // 2-minute warning with voice (120 seconds)
        if (remaining <= 120 && remaining > 119 && !state.activeVisit.warn2minSent) {
            playWarningSound('warning');
            speakWarning("Warning. Safety alarm will activate in two minutes.");
            state.activeVisit.warn2minSent = true;
            saveState();
        }
        
        // 90-second critical warning with voice
        if (remaining <= 90 && remaining > 89 && !state.activeVisit.warn90Sent) {
            playWarningSound('critical');
            speakWarning("Critical Warning. Safety alarm will activate in 90 seconds.");
            state.activeVisit.warn90Sent = true;
            saveState();
        }
        
        // Update timer display
        const timerEl = document.getElementById('countdownTimer');
        const overdueLabel = document.getElementById('overdueLabel');
        const anticipatedTimeEl = document.getElementById('lockedAnticipatedTime');
        
        if (remaining <= 0) {
            // OVERDUE
            if (overdueLabel) overdueLabel.classList.remove('hidden');
            const absRemaining = Math.abs(remaining);
            const mins = Math.floor(absRemaining / 60);
            const secs = Math.floor(absRemaining % 60);
            if (timerEl) {
                if (mins >= 60) {
                    const hours = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    timerEl.innerHTML = `-${hours}h ${remainMins}m`;
                } else {
                    timerEl.innerHTML = `-${mins}:${secs.toString().padStart(2, '0')}<span class="text-3xl ml-2 font-black">min</span>`;
                }
                timerEl.classList.add('text-red-500', 'animate-pulse');
            }
            
            // Show "I AM SAFE" button instead of depart/extend
            const btnSafe = document.getElementById('btnSafe');
            const btnDepart = document.getElementById('btnDepart');
            const btnExtend = document.getElementById('btnExtend');
            if (btnSafe) btnSafe.classList.remove('hidden');
            if (btnDepart) btnDepart.classList.add('hidden');
            if (btnExtend) btnExtend.classList.add('hidden');
            
            // Trigger critical alarm if not sent
            if (!state.activeVisit.criticalSent) {
                triggerPanic(false);
                state.activeVisit.criticalSent = true;
                saveState();
            }
        } else {
            // COUNTDOWN
            if (overdueLabel) overdueLabel.classList.add('hidden');
            const mins = Math.floor(remaining / 60);
            const secs = Math.floor(remaining % 60);
            if (timerEl) {
                if (mins >= 60) {
                    const hours = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    timerEl.innerHTML = `${hours}h ${remainMins}m`;
                } else {
                    timerEl.innerHTML = `${mins}:${secs.toString().padStart(2, '0')}<span class="text-3xl ml-2 font-black">min</span>`;
                }
                timerEl.classList.remove('text-red-500', 'animate-pulse');
            }
        }
        
        // Display anticipated departure time
        if (state.activeVisit.anticipatedDepartureTime && anticipatedTimeEl) {
            const antTime = new Date(state.activeVisit.anticipatedDepartureTime);
            anticipatedTimeEl.innerText = antTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: true});
        }
    }
}

// ============================================================================
// ENHANCED RENDER LOCATIONS (Layout Corrected)
// ============================================================================
function renderLocations() {
    const list = document.getElementById('locationList');
    const travelRow = document.getElementById('travelRow');
    
    if (!list || !travelRow) {
        console.error('UI Error: Location containers missing.');
        return;
    }
    
    list.innerHTML = '';
    travelRow.innerHTML = '';
    
    // 1. Render Travel Tile (Only if enabled in Factory)
    if (CONFIG.mileageEnabled) {
        const travelTile = createTravelTile();
        travelRow.appendChild(travelTile);
    } else {
        // If mileage is disabled, you might want to hide the row entirely
        travelRow.classList.add('hidden');
    }
    
    // 2. Render Regular Locations
    const sites = state.locations.filter(loc => loc && loc.id !== 'travel');
    
    if (sites.length === 0) {
        // Show "Empty State" message instead of a blank screen
        const empty = document.createElement('div');
        empty.className = 'p-10 text-center opacity-30 text-[10px] font-black uppercase tracking-[0.2em] leading-relaxed';
        empty.innerHTML = 'No sites found<br>Pull to sync';
        list.appendChild(empty);
    } else {
        sites.forEach(loc => {
            const tile = createLocationTile(loc);
            list.appendChild(tile);
        });
    }
    
    // 3. Sync Button State
    updateArrivedButtonState();
}
// ============================================================================
// WIZARD NAVIGATION
// ============================================================================
function startWizard() {
    // Show setup page
    const setupPage = document.getElementById('setupPage');
    if (setupPage) setupPage.classList.add('active');
    
    // Hide all other pages
    document.querySelectorAll('.page').forEach(p => {
        if (p.id !== 'setupPage') p.classList.remove('active');
    });
    
    // Reset to step 1
    state.currentWizStep = 1;
    
    // Hide all wizard steps
    document.querySelectorAll('[id^="wizStep"]').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show step 1
    const step1 = document.getElementById('wizStep1');
    if (step1) step1.classList.add('active');
    
    // Reset buttons
    const btnPrev = document.getElementById('btnWizPrev');
    const btnNext = document.getElementById('btnWizNext');
    if (btnPrev) btnPrev.classList.add('hidden');
    if (btnNext) btnNext.classList.remove('hidden');
    
    console.log('Wizard started');
}

function prevWiz() {
    if (!state || state.currentWizStep <= 1) return;
    
    document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
    state.currentWizStep--;
    document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
    
    const btnPrev = document.getElementById('btnWizPrev');
    const btnNext = document.getElementById('btnWizNext');
    
    if (state.currentWizStep === 1 && btnPrev) btnPrev.classList.add('hidden');
    if (btnNext) btnNext.innerText = "Next Step";
    
    saveState();
}

function nextWiz() {
    if (!state) return;
    
    if (state.currentWizStep < 3) {
        document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
        state.currentWizStep++;
        document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
        
        const btnPrev = document.getElementById('btnWizPrev');
        const btnNext = document.getElementById('btnWizNext');
        
        if (state.currentWizStep === 2 && btnPrev) btnPrev.classList.remove('hidden');
        if (state.currentWizStep === 3 && btnNext) btnNext.innerText = "Finish Setup";
        
        saveState();
    } else {
        saveWizard();
    }
}

function saveWizard() {
    const workerData = {
        name: document.getElementById('wizName').value.trim(),
        phone: document.getElementById('wizPhone').value.trim(),
        email: document.getElementById('wizEmail').value.trim(),
        pin: document.getElementById('wizPin').value,
        duress: document.getElementById('wizDuress').value,
        emgName: document.getElementById('wizContactName').value.trim(),
        emgPhone: document.getElementById('wizContactPhone').value.trim(),
        emgEmail: document.getElementById('wizContactEmail').value.trim(),
        escName: document.getElementById('wizEscName').value.trim(),
        escPhone: document.getElementById('wizEscPhone').value.trim(),
        escEmail: document.getElementById('wizEscEmail').value.trim()
    };
    
    // Validation: Only Name and Security are strictly required to proceed locally
    if (!workerData.name || !workerData.pin || !workerData.duress) {
        return alert("Please complete Name and Security PINs to proceed.");
    }
    
    // Store EVERYTHING locally for use in future site visits
    state.worker = workerData;
    state.pins.std = workerData.pin;
    state.pins.duress = workerData.duress;
    
    if (!state.deviceId) {
        state.deviceId = getDeviceID();
    }
    
    saveState();
    
    // UI Transitions
    const setupPage = document.getElementById('setupPage');
    if (setupPage) setupPage.classList.remove('active');
    const headerName = document.getElementById('headerWorkerName');
    if (headerName) headerName.innerText = workerData.name;
    
    announce(`Welcome ${workerData.name}. Device registered.`);
    navigate('main');
    
    // Streamlined Registration: Send only Name and ID to the backend
    console.log('Registering Device ID with Backend...');
    const regPayload = {
        'action': 'registerDevice',
        'key': CONFIG.key,
        'Worker Name': workerData.name,
        'deviceId': state.deviceId,
        'Timestamp': new Date().toISOString()
    };
    
    processUploadQueue(regPayload);
// NEW: Immediately fetch sites and forms so the app is ready to use
    setTimeout(() => {
        syncLibrary();
    }, 1000); 
}

// ============================================================================
// INSTALL PROMPTS
// ============================================================================
function checkIosInstall() {
    const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
    
    // Use standard display-mode check with iOS fallback
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
    
    if (isIos && !isStandalone && !localStorage.getItem('otg_install_dismissed')) {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.remove('hidden');
    }
}

// ============================================================================
// PWA SETUP
// ============================================================================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(registration => {
            console.log('Service Worker registered:', registration.scope);
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        if (confirm('New version available. Update now?')) {
                            window.location.reload();
                        }
                    }
                });
            });
        })
        .catch(err => {
            console.error('Service Worker registration failed:', err);
        });
}

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    // Can show custom install button here
});

// ============================================================================
// CLEANUP ON UNLOAD
// ============================================================================
window.addEventListener('beforeunload', () => {
    stopGPSMonitoring();
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    if (travellingInterval) clearInterval(travellingInterval);
    if (timerInt) clearInterval(timerInt);
});

// ============================================================================
// QUICK WINS: DURATION SLIDER, FORMS BUTTON, HOLD TO START, TRAVEL TILE
// ============================================================================

// Update duration display when slider moves
function updateDurationDisplay() {
    const slider = document.getElementById('durationSlider');
    if (!slider) return;
    
    const sliderValue = parseInt(slider.value);
    const minutes = DURATION_MAP[sliderValue];
    
    const display = document.getElementById('durationDisplay');
    if (display) {
        if (minutes >= 60) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            display.textContent = mins > 0 ? `${hours} hr ${mins} min` : `${hours} hr`;
        } else {
            display.textContent = `${minutes} min`;
        }
    }
    
    // Store selected duration
    if (!state) state = {};
    state.visitDurationMinutes = minutes;
    
    // Update button state
    updateArrivedButtonState();
}

// Update "Hold to Start" button state
// ============================================================================
// UPDATED: BUTTON LOGIC (Restores "Hold to Start")
// ============================================================================
function updateArrivedButtonState() {
    const btn = document.getElementById('btnStart');
    if (!btn) return;
    
    const hasLocation = state && state.selectedLocationId;
    const hasDuration = state && state.visitDurationMinutes > 0;
    
    if (hasLocation && hasDuration) {
        btn.disabled = false;
        btn.classList.remove('bg-gray-700', 'text-gray-500');
        btn.classList.add('bg-blue-600', 'text-white');
        btn.innerText = state.selectedLocationId === 'travel' ? 'HOLD TO TRAVEL' : 'HOLD TO START';
    } else {
        btn.disabled = true;
        btn.classList.add('bg-gray-700', 'text-gray-500');
        btn.innerText = 'HOLD TO START';
    }
}

/**
 * Renders the dynamic library of forms from the spreadsheet.
 */
/**
 * UI Controller: Opens the Forms Library Modal
 */
function openFormsLibrary() {
    const list = document.getElementById('formsLibraryList');
    if (!list) return;

    // 1. Clear the list
    list.innerHTML = '';
    const forms = state.globalForms || [];

    // 2. If no forms exist, trigger a sync instead of showing an empty list
    if (forms.length === 0) {
        const confirmSync = confirm("Forms library is empty. Would you like to sync with the server now?");
        if (confirmSync) {
            syncLibrary();
        }
        return;
    }

    // 3. Populate the list with available templates
    forms.forEach(form => {
        const div = document.createElement('div');
        div.className = 'p-5 mb-3 bg-white/5 border border-white/10 rounded-2xl flex justify-between items-center active:scale-95 transition-all';
        div.innerHTML = `
            <div class="flex flex-col">
                <span class="text-xs font-black uppercase tracking-tight">${form.name}</span>
                <span class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">${form.questions.length} Fields</span>
            </div>
            <div class="text-lg">üìÑ</div>
        `;
        div.onclick = () => {
            closeModal('formsLibrary');
            buildReportForm(form.name, document.getElementById('reportFields'));
            navigate('report');
        };
        list.appendChild(div);
    });

    showModal('formsLibrary');
}
// Toggle high-risk/critical timing mode
function toggleHighRiskUI() {
    const checkbox = document.getElementById('chkHighRisk');
    if (!checkbox) return;
    
    if (checkbox.checked) {
        showToast('‚ö° Critical timing mode ON - Zero grace period');
    } else {
        showToast('‚úÖ Critical timing mode OFF');
    }
    
    // Store preference
    if (state) {
        state.highRiskMode = checkbox.checked;
        saveState();
    }
}

// Create travel tile (always present)
function createTravelTile() {
    const isSel = state && state.selectedLocationId === 'travel';
    const noReport = localStorage.getItem('otg_user_travel_pref') === 'true';
    
    const tile = document.createElement('div');
    tile.className = `w-full h-14 rounded-xl shadow-lg flex items-center justify-between px-4 cursor-pointer transition-all border-2 ${
        isSel 
            ? 'border-white scale-[1.02] ring-2 ring-purple-400' 
            : 'border-gray-700 hover:border-white/20'
    } bg-gradient-to-r from-indigo-600 to-purple-700`;
    
    tile.innerHTML = `
        <div class="flex items-center gap-2">
            <div class="text-xl">üöó</div>
            <div>
                <div class="text-sm font-bold text-white tracking-tight leading-none">Travelling</div>
                <div class="text-[8px] text-indigo-200 font-medium uppercase mt-0.5">
                    ${noReport ? 'Report optional' : 'Report required'}
                </div>
            </div>
        </div>
        <button class="text-white/40 hover:text-white text-xs p-1" 
                onclick="event.stopPropagation(); editTravelSettings();">
            ‚öôÔ∏è
        </button>
    `;
    
    tile.onclick = () => {
        if (state.selectedLocationId === 'travel') {
            state.selectedLocationId = null;
        } else {
            state.selectedLocationId = 'travel';
        }
        renderLocations();
        updateArrivedButtonState();
    };
    
    return tile;
}

// Edit travel settings (report required toggle)
function editTravelSettings() {
    const noReport = localStorage.getItem('otg_user_travel_pref') === 'true';
    
    const confirmed = confirm(
        noReport 
            ? 'Currently: Report OPTIONAL\n\nChange to require report after travel?' 
            : 'Currently: Report REQUIRED\n\nChange to make report optional?'
    );
    
    if (confirmed) {
        localStorage.setItem('otg_user_travel_pref', (!noReport).toString());
        renderLocations();
        showToast('‚úÖ Travel settings updated');
    }
}

    
// Create regular location tile
function createLocationTile(loc) {
    const isSel = state && state.selectedLocationId === loc.id;
    
    const tile = document.createElement('div');
    tile.className = `p-3 rounded-lg border-2 cursor-pointer flex flex-col justify-between h-24 shadow-sm transition-all ${
        isSel 
            ? 'border-blue-500 bg-blue-900/40' 
            : 'border-gray-700 bg-gray-800 hover:bg-gray-750'
    }`;
    
    let icon = "üè¢";
    if (loc.name && loc.name.toLowerCase().includes("home")) icon = "üè†";
    
    tile.innerHTML = `
        <div class="flex justify-between items-start">
            <span class="text-2xl">${icon}</span>
            ${(loc.notes || loc.contactName || loc.id.startsWith('loc_')) 
                ? `<button class="text-gray-500 hover:text-white z-20" onclick="showSiteInfo('${loc.id}', event)">‚ÑπÔ∏è</button>` 
                : ''}
        </div>
        <div>
            ${loc.companyName ? `<div class="text-xs font-bold text-gray-400 uppercase truncate leading-none">${loc.companyName}</div>` : ''}
            <div class="text-[13px] font-black text-white truncate leading-tight mt-1">${loc.name}</div>
        </div>
    `;
    
    tile.onclick = () => {
        if (state.selectedLocationId === loc.id) {
            state.selectedLocationId = null;
        } else {
            state.selectedLocationId = loc.id;
        }
        renderLocations();
        updateArrivedButtonState();
    };
    
    return tile;
}
// ============================================================================
// UPDATED: SYSTEM DIAGNOSTICS
// ============================================================================
async function updateSystemInfo() {
    const backendVersion = document.getElementById('backendVersion');
    const syncStatus = document.getElementById('syncStatus');
    
    if (CONFIG.url && navigator.onLine) {
        try {
            // Force a ping to get the true version from the spreadsheet engine
            const r = await fetch(`${CONFIG.url}?action=ping&key=${CONFIG.key}`);
            const data = await r.json();
            if (backendVersion) backendVersion.innerText = data.version || "v81.36";
            if (syncStatus) syncStatus.innerText = "Connected ‚úì";
        } catch (e) {
            if (syncStatus) syncStatus.innerText = "Connected (no-cors)"; // Common with GAS
        }
    }
}
    
/**
 * Modular "Hold to Start" Logic
 * Connects the UI to the Safety Engine using the Long-Press Utility.
 */
function setupHoldToStart() {
    // Uses the utility function to handle timing and CSS classes
    setupLongPress('btnStart', 1500, () => {
        const btn = document.getElementById('btnStart');
        
        // Safety Check: Ensure the button isn't disabled (e.g., missing location)
        if (btn && !btn.disabled) {
            startVisit();
        }
    });
}

// Start visit (called after long-press)
/**
 * Safety Engine: Initialize the Visit
 * Consolidates safety object creation and ensures consistent logging.
 */
async function startVisit() {
    // 1. CRITICAL: Unlocks audio for background alarms
    await Tone.start();
    console.log("üîä Audio context active");

    if (!state.selectedLocationId || state.visitDurationMinutes <= 0) return;
    }
    if (!state.visitDurationMinutes || state.visitDurationMinutes === 0) {
        showToast('‚ö†Ô∏è Set visit duration first');
        return;
    }

    const loc = state.locations.find(l => l.id === state.selectedLocationId) || 
                (state.selectedLocationId === 'travel' ? { id: 'travel', name: 'üöó Travelling', isTravel: true } : null);

    if (!loc) {
        showToast('‚ö†Ô∏è Location not found');
        return;
    }

    // 2. Prepare Safety Data
    const startTime = Date.now();
    const durationSec = state.visitDurationMinutes * 60;
    const dueOut = startTime + (durationSec * 1000);

    // Initialize the safety object with all necessary flags
    const activeVisit = {
        locationId: loc.id,
        locationName: loc.name,
        startTime: startTime,
        duration: durationSec,
        dueOut: dueOut,
        anticipatedDepartureTime: new Date(dueOut).toISOString(),
        startGPS: lastGPS || "0,0",
        highRisk: state.highRiskMode || false,
        isPanic: false,
        criticalSent: false,
        warningSent: false,
        warn90Sent: false,
        warn2minSent: false,
        warn5minSent: false
    };

    // 3. Handle GPS for Travel
    if (loc.id === 'travel' || loc.isTravel) {
        showToast('üìç Updating travel coordinates...');
        // We use the last known high-accuracy position from the watchPosition engine
        activeVisit.startGPS = lastGPS || "0,0";
    }

    // 4. Update State and Transition
    state.activeVisit = activeVisit;
    saveState();

    // 5. Audit Trail & Announcements
    const activityType = loc.id === 'travel' ? "Travel" : "Visit";
    announce(`${activityType} to ${loc.name} started.`);
    logSafety("ARRIVED", `${activityType} started at ${loc.name}`);
    
    // Warm up audio and start timers
    if (typeof initAudio === 'function') await initAudio();
    enterLockedScreen();
    announce("Safety timer active.");
    logSafety("ARRIVED", `Monitoring started for ${state.activeVisit.locationName}`);
}

// ============================================================================
// CRITICAL FUNCTIONS EXTRACTED FROM WS_SAFETY (MISSING IN ORIGINAL BUILD)
// ============================================================================

// Critical variables needed by these functions (new ones only, avoid duplicates)
let calculatedDist = null;
let gpsWarm = false;
let travelTargetName = "";
let panicTapCount = 0;
let panicTapTimer;

// Note: currentBatteryLevel, currentActiveTemplate and isMidVisitUpdate already declared earlier in file

// 1. BUILD PAYLOAD - Constructs proper data structure for backend
function buildPayload(d) {
    let dt = "";
    let ln = "Unknown Site";
    let la = "No Address Provided";
    
    if (state.activeVisit) {
        if (state.activeVisit.anticipatedDepartureTime) {
            dt = new Date(state.activeVisit.anticipatedDepartureTime).toISOString();
        }
        const l = state.locations.find(x => x.id === state.activeVisit.locationId);
        if (l) {
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name;
            la = l.address || "No Address";
        }
    } else if (state.selectedLocationId) {
        const l = state.locations.find(x => x.id === state.selectedLocationId);
        if (l) {
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name;
            la = l.address || "No Address";
        }
    }
    
    let gps = d['Last Known GPS'] || "";
    if (!gps && state.activeVisit && state.activeVisit.startGPS) {
        gps = state.activeVisit.startGPS;
    }
    
    return {
        'key': CONFIG.key,
        'Worker Name': state.worker?.name || "",
        'Worker Phone Number': state.worker?.phone || "",
        'Worker Email': state.worker?.email || "",
        'Emergency Contact Name': state.worker?.emgName || "",
        'Emergency Contact Number': state.worker?.emgPhone || "",
        'Emergency Contact Email': state.worker?.emgEmail || "",
        'Escalation Contact Name': state.worker?.escName || "",
        'Escalation Contact Number': state.worker?.escPhone || "",
        'Escalation Contact Email': state.worker?.escEmail || "",
        'Battery Level': currentBatteryLevel,
        'Location Name': ln,
        'Location Address': la,
        'Anticipated Departure Time': dt,
        'Timestamp': new Date().toISOString(),
        'deviceId': state.deviceId || "",
        'Last Known GPS': gps,
        ...d
    };
}

/**
 * ROBUST SYNC ENGINE - GAS COMPATIBLE
 * Handles the 'opaque' responses required by Google Apps Script.
 */
function processUploadQueue(d) {
    if (d) {
        state.pendingUploads.push(d);
        saveState();
    }
    if (!navigator.onLine || state.pendingUploads.length === 0) return;

    const currentUpload = state.pendingUploads[0];
    const fd = new FormData();
    for (let k in currentUpload) { fd.append(k, currentUpload[k]); }

    // Use 'no-cors' to allow the POST to reach Google without a pre-flight failure
    fetch(CONFIG.url, { 
        method: 'POST', 
        body: fd, 
        mode: 'no-cors' 
    }).then(() => {
        // Since we can't read the response in no-cors, we assume success 
        // if the fetch doesn't throw.
        state.pendingUploads.shift();
        saveState();
        if (state.pendingUploads.length > 0) {
            setTimeout(processUploadQueue, 500);
        } else {
            console.log("‚úÖ Sync Queue Cleared");
            // Optional: Re-ping to update sites after registration
            if (currentUpload.action === 'registerDevice') forceSync(false);
        }
    }).catch(e => console.warn("Network deferred:", e));
}

// 3. GATHER FORM DATA - Collects all form field values
function gatherFormData() {
    const d = { custom: {}, notes: '', sig: null, jsonPayload: {} };
    
    const sn = document.getElementById('rep_notes');
    if (sn) d.notes = sn.value;
    
    document.querySelectorAll('[data-key]').forEach(el => {
        const k = el.getAttribute('data-key');
        let v = el.value;
        
        if (el.type === 'checkbox') {
            v = el.checked ? 'Yes' : 'No';
        } else if (el.type === 'radio') {
            if (!el.checked) return;
            v = el.value;
        }
        
        d.custom[k] = v;
        d.jsonPayload[k] = v;
    });
    
    const c = document.querySelector('canvas[id^="sig-canvas-"]');
    if (c) d.sig = c.toDataURL('image/png');
    
    return d;
}

// 4. RENDER PANIC STATE - Changes UI to panic mode
function renderPanicState() {
    const lockedPage = document.getElementById('lockedPage');
    if (lockedPage) lockedPage.classList.add('panic-mode');
    
    const btnDepart = document.getElementById('btnDepart');
    if (btnDepart) btnDepart.classList.add('hidden');
    
    const btnExtend = document.getElementById('btnExtend');
    if (btnExtend) btnExtend.classList.add('hidden');
    
    const btnSafe = document.getElementById('btnSafe');
    if (btnSafe) {
        btnSafe.classList.remove('hidden');
        setupLongPress(btnSafe, 2000, iamSafe);
    }
}

// 5. WARM UP GPS - Pre-warms GPS for faster first capture
function warmUpGps() {
    if (gpsWarm) return;
    gpsWarm = true;
    
    navigator.geolocation.getCurrentPosition(
        () => {},
        (err) => {
            if (err.code === 1) showToast("üìç GPS Permission Required");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
    
    setTimeout(() => {
        gpsWarm = false;
    }, 30000);
}

// 6. PLAY SOUND - Audio feedback for events
function playSound(t) {
    initAudio().then(() => {
        const n = Tone.now();
        if (t === 'arrive') synth.triggerAttackRelease("C4", "8n", n);
        if (t === 'depart') synth.triggerAttackRelease("G4", "8n", n);
        if (t === 'warning') synth.triggerAttackRelease("E5", "16n", n);
        if (t === 'panic') synth.triggerAttackRelease("G5", "16n", n);
    });
}

// ============================================================================
// CRITICAL MISSING FUNCTIONS FROM WS_SAFETY
// ============================================================================

// 1. TRIGGER AUTO ALERT - Sends alarm when timer expires
function triggerAutoAlert(status) {
    if (!state || !state.activeVisit) return;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    const locationName = location ? 
        (location.companyName ? `${location.companyName} - ${location.name}` : location.name) : 
        "Unknown Location";
    
    console.log(`Triggering auto alert: ${status} for ${locationName}`);
    
    // Try to get current GPS
    navigator.geolocation.getCurrentPosition(
        position => {
            const gps = `${position.coords.latitude},${position.coords.longitude}`;
            console.log(`Auto alert with GPS: ${gps}`);
            
            processUploadQueue(buildPayload({
                "Alarm Status": status,
                "Notes": "Automated System Alert",
                "Location Name": locationName,
                "Last Known GPS": gps
            }));
            
            showToast("üö® Emergency alert sent");
        },
        error => {
            console.warn('GPS failed for auto alert:', error);
            
            processUploadQueue(buildPayload({
                "Alarm Status": status,
                "Notes": "Automated System Alert (GPS unavailable)",
                "Location Name": locationName,
                "Last Known GPS": lastGPS || "Not available"
            }));
            
            showToast("üö® Emergency alert sent (no GPS)");
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
    );
}

// 2. COMPRESS IMAGE - Reduces photo size before upload
function compressImg(file) {
    return new Promise(resolve => {
        const reader = new FileReader();
        
        reader.onload = e => {
            const img = new Image();
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1200;
                const MAX_HEIGHT = 1200;
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width = width * (MAX_HEIGHT / height);
                        height = MAX_HEIGHT;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to JPEG with 80% quality
                const compressed = canvas.toDataURL('image/jpeg', 0.8);
                
                console.log(`Image compressed: ${file.size} bytes -> ${compressed.length} chars`);
                resolve(compressed);
            };
            
            img.src = e.target.result;
        };
        
        reader.readAsDataURL(file);
    });
}

// 3. HANDLE PHOTO - Processes photo uploads with compression
function handlePhoto(input, key) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const labelId = `lbl_${input.id.split('_')[1]}`;
    const label = document.getElementById(labelId);
    
    if (label) label.innerText = "Compressing...";
    
    compressImg(file).then(base64 => {
        if (!state.photoStore) state.photoStore = {};
        state.photoStore[key] = base64;
        saveState();
        
        if (label) label.innerText = "‚úÖ Saved";
        
        console.log(`Photo saved: ${key}`);
    }).catch(err => {
        console.error('Photo compression failed:', err);
        if (label) label.innerText = "‚ùå Error";
    });
}

// 4. INIT SIGNATURE PAD - Sets up touch/mouse drawing on canvas
function initSigPad(canvas) {
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    // Get position accounting for canvas scaling
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
            x: (touch.clientX - rect.left) * (canvas.width / rect.width),
            y: (touch.clientY - rect.top) * (canvas.height / rect.height)
        };
    };
    
    const startDrawing = (e) => {
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        e.preventDefault();
    };
    
    const draw = (e) => {
        if (!isDrawing) return;
        
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
        e.preventDefault();
    };
    
    const stopDrawing = () => {
        isDrawing = false;
    };
    
    // Touch events
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);
    
    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    console.log('Signature pad initialized:', canvas.id);
}

// 5. RESIZE CANVAS - Adjusts canvas for high DPI displays
function resizeCanvas(canvasEl) {
    if (!canvasEl) return;
    
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvasEl.getBoundingClientRect();
    
    canvasEl.width = rect.width * ratio;
    canvasEl.height = rect.height * ratio;
    
    const ctx = canvasEl.getContext('2d');
    ctx.scale(ratio, ratio);
    
    console.log(`Canvas resized: ${canvasEl.width}x${canvasEl.height} (ratio: ${ratio})`);
}

// 6. CLEAR SIGNATURE - Clears signature canvas
function clearSig(id) {
    const canvasId = id ? `sig-canvas-${id}` : 'sig-canvas';
    const canvas = document.getElementById(canvasId);
    
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        console.log(`Signature cleared: ${canvasId}`);
    }
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Helper: Get Device ID
function getDeviceID() {
    let id = localStorage.getItem('otg_device_id');
    if (!id) {
        id = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        localStorage.setItem('otg_device_id', id);
        console.log('New device ID generated:', id);
    }
    return id;
}

// Fetch locations from backend
async function fetchLocationsFromBackend() {
    if (!CONFIG.url || !state || !state.worker || !state.worker.name) {
        console.warn('Cannot fetch locations: missing config or worker data');
        renderLocations(); // Render with empty list
        return;
    }
    
    try {
        showToast('üì° Fetching locations...');
        
        const url = `${CONFIG.url}?action=getLocations&worker=${encodeURIComponent(state.worker.name)}&deviceId=${state.deviceId}&key=${CONFIG.key}`;
        
        console.log('Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('Location fetch response:', data);
        
        if (data.status === 'success' && data.locations && Array.isArray(data.locations)) {
            // Merge with existing locations (don't overwrite travel tile)
            const existingTravel = state.locations.find(l => l.id === 'travel');
            
            state.locations = data.locations.filter(l => l.id !== 'travel');
            
            // Re-add travel if it existed
            if (existingTravel) {
                state.locations.unshift(existingTravel);
            }
            
            saveState();
            renderLocations();
            showToast(`‚úÖ ${data.locations.length} locations loaded`);
            
            console.log('Locations updated:', state.locations.length);
        } else {
            console.warn('Invalid response format:', data);
            renderLocations(); // Render with what we have
            showToast('‚ö†Ô∏è No locations from backend');
        }
    } catch (err) {
        console.error('Location fetch failed:', err);
        renderLocations(); // Render with what we have (at least travel tile)
        showToast('‚ö†Ô∏è Offline - using cached locations');
    }
}

// ============================================================================
// HIGH-INTEGRITY INITIALIZATION (Safety-Critical Patch)
// ============================================================================
window.onload = () => {
    // 1. Establish State Integrity
    state = loadState() || {
        currentWizStep: 1,
        worker: {},
        pins: { std: '', duress: '' },
        activeVisit: null,
        pendingUploads: [],
        locations: [],
        photoStore: {},
        vehicle: { wofExpiry: '', regoExpiry: '', lastVehCheck: null }
    };

    // 2. Ensure Device Identity
    if (!state.deviceId) {
        state.deviceId = getDeviceID();
        saveState();
    }

    // 3. UI Primary Paint (Render Travel Tile Immediately)
    updateOnlineStatus();
    checkIosInstall();
    startGPSMonitoring();
    
    if (!state.worker || !state.worker.name) {
        // Force Setup Wizard if identity is missing
        const setupPage = document.getElementById('setupPage');
        if (setupPage) setupPage.classList.add('active');
    } else {
        // Standard worker startup
        navigate(state.activeVisit ? 'locked' : 'main');
        
        // CRITICAL: Always render UI before attempting network sync
        renderLocations(); 
        
        if (state.activeVisit) {
            enterLockedScreen();
            timerInt = setInterval(tick, 1000);
        }

        // 4. Managed Background Sync
        // Only sync if we have a real key; avoids backend error noise
        const isTemplate = !CONFIG.key || CONFIG.key.includes('%%');
        if (!isTemplate && navigator.onLine) {
            forceSync(false); // Silent background sync
        }
    }

    // 5. Initialize Secondary Safety Controllers
    initShakeDetection();
    initVolumeDetection();
    initSlideToWake();
    
    // Bind the standard SOS button behavior
    const btnPanic = document.getElementById('btnPanic');
    if (btnPanic) {
        btnPanic.onclick = () => {
            panicTapCount++;
            clearTimeout(panicTapTimer);
            if (panicTapCount === 3) {
                panicTapCount = 0;
                triggerPanic(false);
            } else {
                panicTapTimer = setTimeout(() => { panicTapCount = 0; }, 2000);
            }
        };
    }

    // 6. Maintenance & Queue Management
    window.addEventListener('online', () => {
        if (state.pendingUploads.length > 0) setTimeout(processUploadQueue, 1000);
    });
    
    document.addEventListener('touchstart', resetInactivityTimer, { passive: true });
    
    console.log("OTG Safety Engine: System Online.");
};
// ============================================================================
// PHASE 1: SETTINGS PAGE FUNCTIONS
// ============================================================================
function populateSettingsForm() {
    if (!state || !state.worker) return;
    const s = state.worker;
    document.getElementById('setName').value = s.name || '';
    document.getElementById('setPhone').value = s.phone || '';
    document.getElementById('setEmail').value = s.email || '';
    document.getElementById('setEmgName').value = s.emgName || '';
    document.getElementById('setEmgPhone').value = s.emgPhone || '';
    document.getElementById('setEmgEmail').value = s.emgEmail || '';
    document.getElementById('setEscName').value = s.escName || '';
    document.getElementById('setEscPhone').value = s.escPhone || '';
    document.getElementById('setEscEmail').value = s.escEmail || '';
}

function saveSettings() {
    if (!state || !state.worker) return;
    
    state.worker.name = document.getElementById('setName').value.trim();
    state.worker.phone = document.getElementById('setPhone').value.trim();
    state.worker.email = document.getElementById('setEmail').value.trim();
    state.worker.emgName = document.getElementById('setEmgName').value.trim();
    state.worker.emgPhone = document.getElementById('setEmgPhone').value.trim();
    state.worker.emgEmail = document.getElementById('setEmgEmail').value.trim();
    state.worker.escName = document.getElementById('setEscName').value.trim();
    state.worker.escPhone = document.getElementById('setEscPhone').value.trim();
    state.worker.escEmail = document.getElementById('setEscEmail').value.trim();
    
    saveState();
    
    const headerName = document.getElementById('headerWorkerName');
    if (headerName) headerName.innerText = state.worker.name;
    
    showToast('‚úÖ Settings Saved');
    navigate('main');
}

function exportUserData() {
    if (!state) return;
    
    const data = {
        exportDate: new Date().toISOString(),
        worker: state.worker,
        safetyLog: state.pendingUploads || [],
        settings: state.settings
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `worker-data-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('üì§ Data Exported');
}

// ============================================================================
// UPDATED: LOCATION MANAGEMENT
// ============================================================================
function openAddLocationModal() {
    // Reset modal fields for a fresh entry
    document.getElementById('locId').value = '';
    document.getElementById('locBusiness').value = '';
    document.getElementById('locName').value = '';
    document.getElementById('locAddr').value = '';
    document.getElementById('locContactName').value = '';
    document.getElementById('locContactPhone').value = '';
    document.getElementById('locContactEmail').value = '';
    document.getElementById('locCritical').checked = false;
    
    const btnDel = document.getElementById('btnDelLoc');
    if (btnDel) btnDel.classList.add('hidden');
    
    showModal('location');
}

// Edit manual location - opens modal pre-filled
function editManualLocation(id) {
    const location = state.locations.find(x => x.id === id);
    if (!location) return;
    
    const titleEl = document.querySelector('#locationModal h2');
    if (titleEl) titleEl.textContent = 'Edit Location';
    
    document.getElementById('locId').value = id;
    document.getElementById('locBusiness').value = location.companyName || '';
    document.getElementById('locName').value = location.name || '';
    document.getElementById('locAddr').value = location.address || '';
    
    const contactName = document.getElementById('locContactName');
    const contactPhone = document.getElementById('locContactPhone');
    const contactEmail = document.getElementById('locContactEmail');
    if (contactName) contactName.value = location.contactName || '';
    if (contactPhone) contactPhone.value = location.contactPhone || '';
    if (contactEmail) contactEmail.value = location.contactEmail || '';
    
    const criticalCheckbox = document.getElementById('locCritical');
    if (criticalCheckbox) criticalCheckbox.checked = location.isCritical || false;
    
    const btnDel = document.getElementById('btnDelLoc');
    if (btnDel) btnDel.classList.remove('hidden');
    
    showModal('location');
}

// Clear forms cache and resync
function clearFormsCache() {
    if (!state) return;
    state.cachedForms = {};
    state.globalForms = [];
    saveState();
    showToast('üîÑ Clearing cache and resyncing...');
    setTimeout(() => forceSync(true), 500);
}

// Clear all app data
function clearData() {
    if (confirm('‚ö†Ô∏è WARNING: This will erase ALL app data including settings, locations, and queued uploads.\n\nAre you absolutely sure?')) {
        if (confirm('‚ö†Ô∏è FINAL WARNING: There is NO UNDO. All data will be permanently deleted.\n\nContinue?')) {
            localStorage.clear();
            showToast('üóëÔ∏è All data cleared - Reloading...');
            setTimeout(() => location.reload(), 1000);
        }
    }
}

// Update system info on settings page  
function updateSystemInfo() {
    const backendUrl = document.getElementById('setBackendUrl');
    if (backendUrl) {
        backendUrl.value = CONFIG.url || 'Not configured';
    }
    
    const backendVersion = document.getElementById('backendVersion');
    const syncStatus = document.getElementById('syncStatus');
    
    // Skip ping if key hasn't been injected by factory yet
    if (!CONFIG.key || CONFIG.key.includes('%%')) {
        if (backendVersion) {
            backendVersion.textContent = 'Pending factory injection';
            backendVersion.className = 'text-sm font-mono text-yellow-400';
        }
        if (syncStatus) {
            syncStatus.textContent = 'Template mode (needs deployment)';
            syncStatus.className = 'text-sm font-mono text-yellow-400';
        }
        return;
    }
    
    // Try to ping backend for version
    if (CONFIG.url && navigator.onLine) {
        fetch(`${CONFIG.url}?action=ping&key=${CONFIG.key}`, { 
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                if (backendVersion) {
                    backendVersion.textContent = data.version || 'v1.0';
                    backendVersion.className = 'text-sm font-mono text-green-400';
                }
                if (syncStatus) {
                    syncStatus.textContent = 'Connected ‚úì';
                    syncStatus.className = 'text-sm font-mono text-green-400';
                }
            })
            .catch(e => {
                if (backendVersion) {
                    backendVersion.textContent = 'Unknown';
                    backendVersion.className = 'text-sm font-mono text-yellow-400';
                }
                if (syncStatus) {
                    syncStatus.textContent = 'Offline';
                    syncStatus.className = 'text-sm font-mono text-red-400';
                }
            });
    } else {
        if (syncStatus) {
            syncStatus.textContent = 'No network';
            syncStatus.className = 'text-sm font-mono text-gray-400';
        }
    }
}

// ============================================================================
// PHASE 1: VEHICLE WOF COMPLIANCE SYSTEM
// ============================================================================
function checkVehicleStatus() {
    if (!state || !state.meta) return;
    
    const nagBar = document.getElementById('vehNagBar');
    if (!nagBar) return;
    
    let showNag = false;
    
    // Check last vehicle check date
    if (state.meta.lastVehCheck) {
        const lastCheck = new Date(state.meta.lastVehCheck);
        const daysSince = (Date.now() - lastCheck.getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince > 120) { // 120 days
            showNag = true;
            nagBar.innerText = '‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete';
        }
    } else {
        showNag = true;
        nagBar.innerText = '‚ö†Ô∏è Vehicle Check Required';
    }
    
    // Check WOF expiry
    if (state.meta.wofExpiry) {
        const wofDate = new Date(state.meta.wofExpiry);
        const daysUntil = (wofDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24);
        
        if (daysUntil < 0) {
            // EXPIRED - block usage
            showNag = true;
            nagBar.innerText = '‚õî WOF EXPIRED - Vehicle Use Prohibited';
            nagBar.classList.add('animate-pulse');
        } else if (daysUntil < 14) {
            // Expiring soon - warn
            showNag = true;
            nagBar.innerText = `‚ö†Ô∏è Vehicle Check: WOF Due in ${Math.ceil(daysUntil)} Days`;
        }
    }
    
    if (showNag) {
        nagBar.classList.remove('hidden');
    } else {
        nagBar.classList.add('hidden');
    }
}

function startVehicleCheck() {
    // This would load a vehicle check form
    showToast('Vehicle check form would load here');
    // TODO: loadFormAndShow('Vehicle Safety Check');
}

function checkVehicleBeforeVisit() {
    if (!state || !state.meta) return false;
    
    // Check if WOF is expired
    if (state.meta.wofExpiry) {
        const wofDate = new Date(state.meta.wofExpiry);
        if (wofDate < new Date()) {
            showModal('wofBlock');
            return true; // Blocked
        }
        
        // Check if expiring within 14 days
        const daysUntil = (wofDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24);
        if (daysUntil > 0 && daysUntil < 14) {
            const wofWarnText = document.getElementById('wofWarnText');
            if (wofWarnText) {
                wofWarnText.innerText = `${Math.ceil(daysUntil)} days`;
            }
            showModal('wofWarn');
            return true; // Needs acknowledgment
        }
    }
    
    return false; // OK to proceed
}

function closeWofBlocker() {
    closeModal('wofBlock');
}

function toggleWofContinue() {
    const checkbox = document.getElementById('chkWofAck');
    const button = document.getElementById('btnWofContinue');
    if (checkbox && button) {
        if (checkbox.checked) {
            button.disabled = false;
            button.classList.remove('bg-gray-700', 'text-gray-500');
            button.classList.add('bg-blue-600', 'text-white');
        } else {
            button.disabled = true;
            button.classList.add('bg-gray-700', 'text-gray-500');
            button.classList.remove('bg-blue-600', 'text-white');
        }
    }
}

function closeWofWarn() {
    const checkbox = document.getElementById('chkWofAck');
    if (checkbox) checkbox.checked = false;
    closeModal('wofWarn');
    // Continue with visit start
}

// ============================================================================
// PHASE 1: TIME EXTENSION
// ============================================================================
function confirmExtension(minutes) {
    const updateTime = () => {
        // Add minutes to anticipated departure time
        const currentDue = state.activeVisit.anticipatedDepartureTime;
        const newDue = currentDue + (minutes * 60000);
        
        state.activeVisit.anticipatedDepartureTime = newDue;
        
        // Reset warning flags
        state.activeVisit.warningSent = false;
        state.activeVisit.warn90Sent = false;
        state.activeVisit.warn2minSent = false;
        state.activeVisit.warn5minSent = false;
        
        saveState();
        
        // Send update to backend
        processUploadQueue(buildPayload({
            'Alarm Status': 'EXTENDED',
            'Notes': `Extended ${minutes}m`
        }));
        
        showToast(`‚úÖ Visit extended by ${minutes} minutes`);
        closeModal('extend');
    };
    
    const now = Date.now();
    const dueTime = state.activeVisit.anticipatedDepartureTime;
    
    // If overdue or in panic, require PIN
    if (dueTime < now || state.activeVisit.isPanic) {
        withPinVerification(false, updateTime);
    } else {
        updateTime();
    }
}

// ============================================================================
// PHASE 1: MID-VISIT UPDATES
// ============================================================================
function openMidVisitMenu() {
    isMidVisitUpdate = true;
    // For now, just trigger a simple note
    if (confirm('Send a mid-visit status update?')) {
        const note = prompt('Enter status update:');
        if (note) {
            logSafety('MID_VISIT_UPDATE', note);
            showToast('üìù Update sent');
        }
    }
    // TODO: Show form selection modal like WS_Safety
}

// ============================================================================
// PHASE 1: MULTIPLE WARNING LEVELS (5min, 2min, 90sec)
// ============================================================================
function playWarningSound(type) {
    if (audioReady && synth) {
        try {
            if (type === 'warning') {
                synth.triggerAttackRelease('A4', '4n');
            } else if (type === 'critical') {
                synth.triggerAttackRelease('C5', '4n');
            }
        } catch (e) {
            console.warn('Audio playback failed:', e);
        }
    }
}

function speakWarning(message) {
    if ('speechSynthesis' in window) {
        try {
            window.speechSynthesis.cancel(); // Cancel any ongoing speech
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.rate = 0.9;
            utterance.volume = 1.0;
            window.speechSynthesis.speak(utterance);
        } catch (e) {
            console.warn('Speech failed:', e);
        }
    }
}

// ============================================================================
// PHASE 1: OFFLINE BANNER
// ============================================================================
function updateOnlineStatus() {
    const banner = document.getElementById('offlineBanner');
    if (!banner) return;
    
    if (navigator.onLine) {
        banner.classList.add('hidden');
        // Try to sync pending uploads
        if (state && state.pendingUploads && state.pendingUploads.length > 0) {
            setTimeout(() => forceSync(false), 1000);
        }
    } else {
        banner.classList.remove('hidden');
    }
}

// Enhanced forceSync with online check
function forceSync(showUI) {
    console.log('üîµ forceSync CALLED - showUI:', showUI);
    console.log('   state exists:', !!state);
    console.log('   state.worker exists:', !!state?.worker);
    console.log('   state.worker.name:', state?.worker?.name);
    console.log('   CONFIG.key:', CONFIG.key?.substring(0, 15) + '...');
    renderLocations();
    // Check if key has been injected by factory
    if (!CONFIG.key || CONFIG.key.includes('%%')) {
        console.log('‚ùå forceSync EXITING - Worker key not injected by factory yet');
        if (showUI) {
            showToast('‚ö†Ô∏è Template mode - awaiting deployment');
        }
        return;
    }
    
    // Simple check - return silently if no worker
    if (!state || !state.worker || !state.worker.name) {
        console.log('‚ùå forceSync EXITING - No worker name');
        return;
    }
    
    console.log('‚úÖ forceSync PROCEEDING with worker:', state.worker.name);
    
    // Show banner immediately
    if (showUI) {
        const banner = document.getElementById('uploadBanner');
        if (banner) banner.classList.remove('hidden');
    }
    
    const deviceId = getDeviceID();
    const workerName = state.worker.name;
    
    console.log(`üîÑ Syncing for worker: ${workerName}, device: ${deviceId}`);
    
    fetch(`${CONFIG.url}?action=sync&worker=${encodeURIComponent(workerName)}&key=${CONFIG.key}&deviceId=${deviceId}`)
        .then(r => r.json())
        .then(data => {
            console.log('Sync response:', data);
            
            // Hide banner
            const banner = document.getElementById('uploadBanner');
            if (banner) banner.classList.add('hidden');
            
            // Handle errors
            if (data.status === "error") {
                if (showUI) {
                    if (data.message && data.message.includes("ACCESS DENIED")) {
                        alert("‚õî ACCESS DENIED\n\n" + data.message);
                        // startWizard(); // Commented - we handle this differently
                    } else {
                        alert("‚ùå Sync Error: " + (data.message || 'Unknown error'));
                    }
                }
                return;
            }
            
            // Process locations
            const existingManual = state.locations.filter(x => x && x.id && x.id.startsWith('loc_'));
            
            const backendSites = (data.sites || []).map(s => ({
                id: 'site_' + s.siteName.replace(/\s/g, ''),
                name: s.siteName,
                address: s.address,
                companyName: s.company,
                templateName: s.template,
                noReport: false,
                contactName: s.contactName,
                contactPhone: s.contactPhone,
                contactEmail: s.contactEmail,
                notes: s.notes,
                isCritical: s.critical || false
            }));
            
            // Add travel tile
            if (CONFIG.mileageEnabled) {
                backendSites.unshift({
                    id: 'travel',
                    name: 'Travel',
                    address: 'Calculates Mileage via GPS',
                    noReport: !CONFIG.reqTravelReport,
                    companyName: 'Internal',
                    templateName: 'Travel Report'
                });
            }
            
            // Merge locations
            state.locations = backendSites.concat(existingManual);
            
            // Update forms and meta
            state.globalForms = data.forms || [];
            state.cachedForms = data.cachedTemplates || {};
            state.meta = data.meta || {};
            
            // Ensure standard forms exist
            if (!state.cachedForms["Standard Visit Note"] && !state.cachedForms["(Standard)"]) {
                state.cachedForms["Standard Visit Note"] = [{type: 'note', text: 'Standard Check-in'}];
            }
            
            if (CONFIG.mileageEnabled && !state.cachedForms['Travel Report']) {
                state.cachedForms['Travel Report'] = [
                    {type: 'number', text: 'Distance (km)'},
                    {type: 'text', text: 'Details'},
                    {type: 'photo', text: 'Odometer'}
                ];
            }
            
            // Handle travel preferences
            const travelLoc = state.locations.find(x => x.id === 'travel');
            const userPref = localStorage.getItem('otg_user_travel_pref');
            if (travelLoc && userPref !== null) {
                travelLoc.noReport = (userPref === 'true');
            }
            
            // Save and render
            saveState();
            renderLocations();
            checkVehicleStatus();
            
            if (showUI) showToast('‚úÖ Sync Complete!');
            
            console.log(`‚úÖ Sync complete: ${state.locations.length} locations loaded`);
        })
        .catch(e => {
            console.error('Sync failed:', e);
            renderLocations();
            const banner = document.getElementById('uploadBanner');
            if (banner) banner.classList.add('hidden');
            if (showUI) showToast('‚ùå Sync failed: ' + e.message);
        });
}


// ============================================================================
// PHASE 2 & 3: ALL REMAINING FEATURES
// ============================================================================

// Feature 15: Battery Saver Manual Toggle
function toggleBatterySaver() {
    if (isDimmed) {
        deactivateDimMode();
        showToast('üí° Battery saver off');
    } else {
        activateDimMode();
        showToast('üåô Battery saver on');
    }
}

// Feature 14: Critical Timing Mode
function updateCriticalTimingBadge() {
    const badge = document.getElementById('highRiskBadge');
    if (!badge || !state || !state.activeVisit) return;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    if (location && location.isCritical) {
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// Feature 9: Site Info Modal
function showCurrentSiteInfo() {
    if (!state || !state.activeVisit) return;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    if (!location) {
        showToast('No site information available');
        return;
    }
    
    const content = document.getElementById('siteInfoContent');
    if (content) {
        let html = '';
        if (location.companyName) html += `<p><strong>Company:</strong> ${location.companyName}</p>`;
        if (location.address) html += `<p><strong>Address:</strong> ${location.address}</p>`;
        if (location.notes) html += `<p><strong>Notes:</strong> ${location.notes}</p>`;
        if (!html) html = '<p class="text-gray-500">No additional information available</p>';
        content.innerHTML = html;
    }
    
    // Setup action buttons
    const btnCall = document.getElementById('btnSiteCall');
    const btnEmail = document.getElementById('btnSiteEmail');
    const btnNav = document.getElementById('btnSiteNav');
    
    if (location.contactPhone && btnCall) {
        const cleanedPhone = cleanGlobalPhone(location.contactPhone);
        btnCall.href = `tel:${cleanedPhone}`;
        btnCall.classList.remove('hidden');
    } else if (btnCall) {
        btnCall.classList.add('hidden');
    }
    
    if (location.contactEmail && btnEmail) {
        btnEmail.href = `mailto:${location.contactEmail}`;
        btnEmail.classList.remove('hidden');
    } else if (btnEmail) {
        btnEmail.classList.add('hidden');
    }
    
    if (location.address && btnNav) {
        const encodedAddr = encodeURIComponent(location.address);
        btnNav.href = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddr}`;
        btnNav.classList.remove('hidden');
    } else if (btnNav) {
        btnNav.classList.add('hidden');
    }
    
    showModal('info');
}

// Feature 13: Location Management (Add/Edit/Delete)
function openLocationEditor(locationId) {
    const location = state.locations.find(l => l.id === locationId);
    if (!location) return;
    
    document.getElementById('locId').value = location.id;
    document.getElementById('locBusiness').value = location.companyName || '';
    document.getElementById('locName').value = location.name || '';
    document.getElementById('locAddr').value = location.address || '';
    document.getElementById('locContactName').value = location.contactName || '';
    document.getElementById('locContactPhone').value = location.contactPhone || '';
    document.getElementById('locContactEmail').value = location.contactEmail || '';
    
    const criticalCheckbox = document.getElementById('locCritical');
    if (criticalCheckbox) {
        criticalCheckbox.checked = location.isCritical || false;
    }
    
    const btnDel = document.getElementById('btnDelLoc');
    if (location.id.startsWith('loc_')) {
        if (btnDel) btnDel.classList.remove('hidden');
    } else {
        if (btnDel) btnDel.classList.add('hidden');
    }
    
    showModal('location');
}

// Ensure the "Save" button in your locationModal calls this
function saveLoc() {
    const locId = document.getElementById('locId').value;
    const name = document.getElementById('locName').value.trim();
    if (!name) { alert('Site name is required'); return; }

    const locationData = {
        id: locId || 'loc_' + Date.now(),
        name: name,
        companyName: document.getElementById('locBusiness').value.trim(),
        address: document.getElementById('locAddr').value.trim(),
        contactName: document.getElementById('locContactName').value.trim(),
        contactPhone: document.getElementById('locContactPhone').value.trim(),
        contactEmail: document.getElementById('locContactEmail').value.trim(),
        isCritical: document.getElementById('locCritical').checked
    };

    const idx = state.locations.findIndex(l => l.id === locationData.id);
    if (idx >= 0) state.locations[idx] = locationData;
    else state.locations.push(locationData);

    saveState();
    renderLocations();
    closeModal('location');
    showToast('‚úÖ Location saved');
}

function deleteLoc() {
    const locId = document.getElementById('locId').value;
    if (!locId || !confirm('Delete this location?')) return;
    
    state.locations = state.locations.filter(l => l.id !== locId);
    saveState();
    renderLocations();
    closeModal('location');
    showToast('üóëÔ∏è Location deleted');
}

function getGpsAddress() {
    if (!navigator.geolocation) {
        return showToast('GPS not available');
    }
    
    showToast('Getting GPS location...');
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            document.getElementById('locAddr').value = `${lat}, ${lon}`;
            showToast('üìç GPS location captured');
        },
        err => {
            showToast('GPS error: ' + err.message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// Feature 10: Country Code Handling
function cleanGlobalPhone(num) {
    if (!num) return "";
    let n = num.replace(/[^0-9]/g, '');
    const prefix = (CONFIG.countryPrefix || "+64").replace('+', '');
    
    if (!prefix) return "+" + n;
    if (n.startsWith(prefix)) return '+' + n;
    if (n.startsWith('0')) return '+' + prefix + n.substring(1);
    if (prefix === '1' && n.length === 10) return '+1' + n;
    return '+' + prefix + n;
}

// Feature 12: Travel/Mileage Tracking
function haversine(p1, p2) {
    const [lat1, lon1] = p1.split(',').map(Number);
    const [lat2, lon2] = p2.split(',').map(Number);
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function getDistance(p1, p2) {
    if (!p1 || !p2) return { km: 0, type: 'none' };
    
    // Try backend API if online
    if (navigator.onLine && CONFIG.url) {
        try {
            const url = `${CONFIG.url}?action=getDistance&start=${p1}&end=${p2}&key=${CONFIG.key}`;
            const response = await fetch(url, { timeout: 5000 });
            const data = await response.json();
            if (data.status === "success" && data.km) {
                return { km: data.km, type: 'road' };
            }
        } catch (e) {
            console.warn('Distance API failed, using haversine:', e);
        }
    }
    
    // Fallback to haversine
    const dist = haversine(p1, p2);
    return { km: dist.toFixed(2), type: 'crow' };
}

// Feature 16: Advanced GPS Control
function toggleAdvancedGPS(enabled) {
    if (enabled) {
        startGPSMonitoring();
        state.settings.isAdvanced = true;
        showToast('üìç Advanced GPS enabled');
    } else {
        stopGPSMonitoring();
        state.settings.isAdvanced = false;
        const gpsIndicator = document.getElementById('gpsIndicator');
        if (gpsIndicator) gpsIndicator.classList.add('hidden');
        showToast('üîã GPS throttled');
    }
    saveState();
}

// Feature 19: Voice Accent Selection
function speakWithAccent(message) {
    if (!('speechSynthesis' in window)) return;
    
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(message);
    
    // Try to find voice matching configured locale
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => v.lang.includes(CONFIG.voiceLocale || 'en-NZ'));
    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }
    
    utterance.rate = 0.9;
    utterance.volume = 1.0;
    window.speechSynthesis.speak(utterance);
}

// Feature 18: Wizard Progress Dots
function updateWizardDots() {
    for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (dot && state) {
            if (i === state.currentWizStep) {
                dot.classList.remove('bg-gray-700');
                dot.classList.add('bg-blue-500');
            } else {
                dot.classList.remove('bg-blue-500');
                dot.classList.add('bg-gray-700');
            }
        }
    }
}

// Feature 17: Android Install Banner
function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted install');
            }
            deferredPrompt = null;
        });
        const banner = document.getElementById('installBanner');
        if (banner) banner.classList.add('hidden');
    }
}

function dismissInstall(type) {
    if (type === 'ios') {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.add('hidden');
    } else if (type === 'android') {
        const banner = document.getElementById('installBanner');
        if (banner) banner.classList.add('hidden');
    }
    localStorage.setItem('install_dismissed', 'true');
}

// Feature 8: Enhanced Form Builder with all field types

// ====== FEATURE 1: SHAKE-TO-ALERT (Covert Panic) ======

function initShakeDetection() {
    if (!window.DeviceMotionEvent) {
        console.warn('DeviceMotion not available');
        return;
    }
    
    window.addEventListener('devicemotion', handleShakeMotion, false);
}

function handleShakeMotion(event) {
    // Only active during visits
    if (!state || !state.activeVisit) return;
    if (shakeConfirmationMode) return; // Don't detect during confirmation
    
    const accel = event.accelerationIncludingGravity;
    if (!accel || !accel.x || !accel.y || !accel.z) return;
    
    const magnitude = Math.sqrt(
        accel.x * accel.x + 
        accel.y * accel.y + 
        accel.z * accel.z
    );
    
    const now = Date.now();
    
    // High threshold to avoid false positives (running, car, etc.)
    if (magnitude > 25) {
        // Add to buffer with timestamp
        shakeBuffer.push({ magnitude, time: now });
        lastShakeTime = now;
        
        // Clean old entries (older than 2 seconds)
        shakeBuffer = shakeBuffer.filter(s => now - s.time < 2000);
        
        // Check for 5 shakes in 2 seconds
        if (shakeBuffer.length >= 5) {
            // Check pattern consistency (deliberate shaking)
            const avgMagnitude = shakeBuffer.reduce((sum, s) => sum + s.magnitude, 0) / shakeBuffer.length;
            const variance = shakeBuffer.reduce((sum, s) => sum + Math.pow(s.magnitude - avgMagnitude, 2), 0) / shakeBuffer.length;
            
            // Low variance = consistent = deliberate
            if (variance < 100) {
                enterShakeConfirmation();
            }
            
            shakeBuffer = []; // Reset
        }
    }
}

function enterShakeConfirmation() {
    shakeConfirmationMode = true;
    shakeBuffer = [];
    
    const modal = document.getElementById('shakeConfirmModal');
    if (!modal) return;
    
    // Wake from dim if needed
    if (isDimmed) {
        deactivateDimMode();
    }
    
    // Show confirmation modal
    modal.classList.remove('hidden');
    
    // Haptic: LONG-SHORT-LONG pattern
    if (navigator.vibrate) {
        navigator.vibrate([500, 200, 100, 200, 500]);
    }
    
    // Countdown
    let countdown = 3;
    const countdownEl = document.getElementById('shakeCountdown');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = countdown;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Watch for confirmation shake
    const confirmListener = (event) => {
        const accel = event.accelerationIncludingGravity;
        if (!accel) return;
        
        const magnitude = Math.sqrt(
            accel.x * accel.x + 
            accel.y * accel.y + 
            accel.z * accel.z
        );
        
        if (magnitude > 25) {
            shakeBuffer.push(magnitude);
            
            // Need 3 shakes to confirm
            if (shakeBuffer.length >= 3) {
                window.removeEventListener('devicemotion', confirmListener);
                clearTimeout(shakeConfirmationTimeout);
                clearInterval(countdownInterval);
                confirmShakePanic();
            }
        }
    };
    
    window.addEventListener('devicemotion', confirmListener, false);
    
    // Timeout after 3 seconds
    shakeConfirmationTimeout = setTimeout(() => {
        window.removeEventListener('devicemotion', confirmListener);
        clearInterval(countdownInterval);
        cancelShakeConfirmation();
    }, 3000);
}

function confirmShakePanic() {
    shakeConfirmationMode = false;
    const modal = document.getElementById('shakeConfirmModal');
    if (modal) modal.classList.add('hidden');
    
    // Success feedback
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
    
    showToast('üö® Covert alert sent', 2000);
    
    // Trigger duress panic (all panic alerts go through same PIN verification)
    triggerPanic(true); // Duress mode
}

function cancelShakeConfirmation() {
    shakeConfirmationMode = false;
    shakeBuffer = [];
    
    const modal = document.getElementById('shakeConfirmModal');
    if (modal) modal.classList.add('hidden');
}

// ====== FEATURE 2: VOLUME BUTTON PANIC (Android) ======

function initVolumeDetection() {
    document.addEventListener('keydown', handleVolumePress, false);
}

function handleVolumePress(event) {
    // Only active during visits
    if (!state || !state.activeVisit) return;
    if (volumeConfirmationMode) return;
    
    // Volume up or down
    if (event.key === 'VolumeUp' || event.key === 'VolumeDown' || 
        event.keyCode === 175 || event.keyCode === 174) { // Fallback keycodes
        
        event.preventDefault(); // Try to suppress volume change
        
        const now = Date.now();
        volumeBuffer.push(now);
        
        // Keep only recent presses (within 3 seconds)
        volumeBuffer = volumeBuffer.filter(t => now - t < 3000);
        
        // Check for 5 presses
        if (volumeBuffer.length >= 5) {
            volumeBuffer = [];
            enterVolumeConfirmation();
        }
    }
}

function enterVolumeConfirmation() {
    volumeConfirmationMode = true;
    volumeBuffer = [];
    
    const modal = document.getElementById('volumeConfirmModal');
    if (!modal) return;
    
    // Wake from dim if needed
    if (isDimmed) {
        deactivateDimMode();
    }
    
    // Show confirmation modal
    modal.classList.remove('hidden');
    
    // Haptic feedback
    if (navigator.vibrate) {
        navigator.vibrate([300, 100, 300]);
    }
    
    // Countdown
    let countdown = 3;
    const countdownEl = document.getElementById('volumeCountdown');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = countdown;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Watch for confirmation
    const confirmListener = (event) => {
        if (event.key === 'VolumeUp' || event.key === 'VolumeDown' || 
            event.keyCode === 175 || event.keyCode === 174) {
            
            event.preventDefault();
            volumeBuffer.push(Date.now());
            
            // Need 3 more presses to confirm
            if (volumeBuffer.length >= 3) {
                document.removeEventListener('keydown', confirmListener);
                clearTimeout(volumeConfirmationTimeout);
                clearInterval(countdownInterval);
                confirmVolumePanic();
            }
        }
    };
    
    document.addEventListener('keydown', confirmListener, false);
    
    // Timeout after 3 seconds
    volumeConfirmationTimeout = setTimeout(() => {
        document.removeEventListener('keydown', confirmListener);
        clearInterval(countdownInterval);
        cancelVolumeConfirmation();
    }, 3000);
}

function confirmVolumePanic() {
    volumeConfirmationMode = false;
    const modal = document.getElementById('volumeConfirmModal');
    if (modal) modal.classList.add('hidden');
    
    // Success feedback
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
    
    showToast('üö® Volume panic alert sent', 2000);
    
    // Trigger panic (goes through same PIN verification)
    triggerPanic(false); // Standard panic, not duress
}

function cancelVolumeConfirmation() {
    volumeConfirmationMode = false;
    volumeBuffer = [];
    
    const modal = document.getElementById('volumeConfirmModal');
    if (modal) modal.classList.add('hidden');
}

// ====== FEATURE 3: SLIDE-TO-WAKE (Hold-to-Slide) ======

function initSlideToWake() {
    const slideButton = document.getElementById('slideButton');
    const slideTrack = document.getElementById('slideTrack');
    const slideProgress = document.getElementById('slideProgress');
    const slideText = document.getElementById('slideText');
    
    if (!slideButton || !slideTrack) return;
    
    const trackRect = slideTrack.getBoundingClientRect();
    const trackWidth = trackRect.width;
    const buttonWidth = 56; // 14 * 4 (w-14 in Tailwind)
    const maxSlide = trackWidth - buttonWidth - 8; // 8px padding
    
    let currentX = 0;
    
    // Quick peek - tap to show timer briefly
    slideTrack.addEventListener('click', (e) => {
        if (isSliding) return;
        
        const batterySaver = document.getElementById('batterySaver');
        if (batterySaver) {
            // Flash timer
            batterySaver.style.opacity = '0.3';
            setTimeout(() => {
                batterySaver.style.opacity = '1';
            }, 2000);
        }
    });
    
    // Touch start
    slideButton.addEventListener('touchstart', (e) => {
        isSliding = true;
        slideStartX = e.touches[0].clientX;
        slideButton.style.transition = 'none';
        slideProgress.style.transition = 'none';
        e.preventDefault();
    }, { passive: false });
    
    // Touch move
    document.addEventListener('touchmove', (e) => {
        if (!isSliding) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - slideStartX;
        
        // Constrain to track bounds
        currentX = Math.max(0, Math.min(deltaX, maxSlide));
        
        // Update button position
        slideButton.style.transform = `translateX(${currentX}px)`;
        
        // Update progress bar
        const progress = (currentX / maxSlide) * 100;
        slideProgress.style.width = `${progress}%`;
        
        // Fade text as sliding
        if (slideText) {
            slideText.style.opacity = Math.max(0, 1 - (progress / 50));
        }
        
        // Haptic feedback at milestones
        if (navigator.vibrate) {
            if (progress > 24 && progress < 26) navigator.vibrate(10);
            if (progress > 49 && progress < 51) navigator.vibrate(10);
            if (progress > 74 && progress < 76) navigator.vibrate(10);
        }
        
        // Check if completed (>90% of track)
        if (currentX > maxSlide * 0.9) {
            completeSlide();
        }
        
        e.preventDefault();
    }, { passive: false });
    
    // Touch end
    document.addEventListener('touchend', (e) => {
        if (!isSliding) return;
        isSliding = false;
        
        // If not completed, spring back
        if (currentX < maxSlide * 0.9) {
            slideButton.style.transition = 'transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';
            slideProgress.style.transition = 'width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';
            slideButton.style.transform = 'translateX(0)';
            slideProgress.style.width = '0%';
            if (slideText) slideText.style.opacity = '1';
            currentX = 0;
        }
    });
    
    function completeSlide() {
        isSliding = false;
        
        // Snap to end
        slideButton.style.transition = 'transform 0.2s ease-out';
        slideProgress.style.transition = 'width 0.2s ease-out, opacity 0.2s ease-out';
        slideButton.style.transform = `translateX(${maxSlide}px)`;
        slideProgress.style.width = '100%';
        slideProgress.style.opacity = '1';
        
        // Success haptic
        if (navigator.vibrate) {
            navigator.vibrate([50, 50, 50]);
        }
        
        // Wake screen after animation
        setTimeout(() => {
            deactivateDimMode();
            resetInactivityTimer();
            
            // Lock SOS for 2 seconds to prevent accidental trigger
            isSosLocked = true;
            setTimeout(() => {
                isSosLocked = false;
            }, 2000);
            
            // Reset slide for next time
            slideButton.style.transition = 'none';
            slideButton.style.transform = 'translateX(0)';
            slideProgress.style.width = '0%';
            slideProgress.style.opacity = '0.4';
            if (slideText) slideText.style.opacity = '1';
            currentX = 0;
        }, 200);
    }
}

// Update dimmed screen timer and battery
function updateDimmedDisplay() {
    if (!isDimmed || !state || !state.activeVisit) return;
    
    // Update timer
    const dimmedTimer = document.getElementById('dimmedTimer');
    if (dimmedTimer) {
        const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
        const remaining = state.activeVisit.duration - elapsed;
        const mins = Math.floor(Math.abs(remaining) / 60);
        const secs = Math.abs(remaining) % 60;
        const sign = remaining < 0 ? '-' : '';
        dimmedTimer.textContent = `${sign}${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update battery
    const dimmedBattery = document.getElementById('dimmedBattery');
    if (dimmedBattery && currentBatteryLevel) {
        dimmedBattery.textContent = currentBatteryLevel.replace('%', '');
    }
}

setInterval(updateDimmedDisplay, 1000);

// ====== FEATURE 4: WAKE LOCK API ======

async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock released');
                wakeLock = null;
            });
            
            console.log('‚úÖ Wake Lock active - phone will not auto-lock');
        } catch (err) {
            console.error('Wake Lock error:', err);
        }
    } else {
        console.warn('Wake Lock API not supported');
    }
}

function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Wake Lock released');
    }
}

// Release wake lock when visit ends
function exitLockedScreen() {
    releaseWakeLock();
}

// ====== BUG FIXES ======

// BUG FIX 1: Cap pending uploads queue
const _origLogSafety = logSafety;
logSafety = function(type, note) {
    _origLogSafety.apply(this, arguments);
    
    // Cap at 50 entries to prevent memory issues
    if (state && state.pendingUploads && state.pendingUploads.length > 50) {
        state.pendingUploads.shift(); // Remove oldest
    }
};

// BUG FIX 2: Sync with retry and exponential backoff
let syncRetryCount = 0;
const maxRetries = 3;

const _origForceSync = forceSync;
forceSync = async function(showUI) {
    if (!navigator.onLine) {
        if (showUI) showToast('üì° Offline - will sync when connected');
        return;
    }
    
    if (showUI) showToast('üîÑ Syncing...');
    
    try {
        // TODO: Implement actual backend sync with retry logic
        // const response = await fetch(CONFIG.url + '?action=sync', {
        //     method: 'POST',
        //     body: JSON.stringify(state)
        // });
        
        // Simulate success
        syncRetryCount = 0;
        
        if (showUI) {
            setTimeout(() => showToast('‚úÖ Sync complete'), 1000);
        }
    } catch (error) {
        console.error('Sync failed:', error);
        
        if (syncRetryCount < maxRetries) {
            syncRetryCount++;
            const retryDelay = Math.min(60000, Math.pow(2, syncRetryCount) * 1000); // 2s, 4s, 8s, cap at 60s
            
            if (showUI) {
                showToast(`‚ö†Ô∏è Sync failed - retry in ${retryDelay / 1000}s`);
            }
            
            setTimeout(() => forceSync(showUI), retryDelay);
        } else {
            if (showUI) {
                showToast('‚ùå Sync failed - will retry later');
            }
            syncRetryCount = 0;
        }
    }
};

// BUG FIX 3: Enhanced Tone.js initialization (iOS compatibility)
const _origInitAudio = initAudio;
initAudio = async function() {
    if (!audioReady && typeof Tone !== 'undefined') {
        try {
            await Tone.start(); // Critical for iOS
            await Tone.context.resume(); // Additional iOS fix
            synth = new Tone.Synth().toDestination();
            audioReady = true;
            console.log('‚úÖ Audio initialized (iOS compatible)');
        } catch (e) {
            console.warn('Audio initialization failed:', e);
            audioReady = false;
        }
    }
};

// Call on first user interaction
document.addEventListener('touchstart', initAudio, { once: true });
document.addEventListener('click', initAudio, { once: true });

// BUG FIX 4: Signature canvas coordinate fix
function initSigPadFix() {
    const canvas = document.getElementById('signatureCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let drawing = false;
    
    const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
            x: (touch.clientX - rect.left) * (canvas.width / rect.width),
            y: (touch.clientY - rect.top) * (canvas.height / rect.height)
        };
    };
    
    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        const coords = getCoords(e);
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        const coords = getCoords(e);
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
    });
    
    canvas.addEventListener('mouseup', () => drawing = false);
    
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        drawing = true;
        const coords = getCoords(e);
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!drawing) return;
        const coords = getCoords(e);
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
    });
    
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        drawing = false;
    });
}

// BUG FIX 5: Vehicle expiry date parsing with fallback
const _origCheckVehicleStatus = checkVehicleStatus;
checkVehicleStatus = function() {
    if (!CONFIG.vehEnabled || !state || !state.vehicle) return;
    
    const vehNagBar = document.getElementById('vehNagBar');
    if (!vehNagBar) return;
    
    const lastCheck = state.vehicle.lastVehCheck;
    const wofExpiry = state.vehicle.wofExpiry;
    const regoExpiry = state.vehicle.regoExpiry;
    
    let showNag = false;
    let nagText = '';
    
    // Check last vehicle check (default 120 days)
    if (lastCheck) {
        const daysSinceCheck = (Date.now() - new Date(lastCheck)) / (1000 * 60 * 60 * 24);
        if (daysSinceCheck > (CONFIG.vehInterval || 120)) {
            showNag = true;
            nagText = `‚ö†Ô∏è Vehicle check overdue (${Math.floor(daysSinceCheck)} days)`;
        }
    }
    
    // Check WOF expiry with safe parsing
    if (wofExpiry) {
        const wofDate = Date.parse(wofExpiry);
        if (!isNaN(wofDate)) {
            const daysUntilExpiry = (wofDate - Date.now()) / (1000 * 60 * 60 * 24);
            if (daysUntilExpiry < 14 && daysUntilExpiry > 0) {
                showNag = true;
                nagText = `‚ö†Ô∏è WOF expires in ${Math.floor(daysUntilExpiry)} days`;
            }
        }
    }
    
    // Check Rego expiry with safe parsing
    if (regoExpiry) {
        const regoDate = Date.parse(regoExpiry);
        if (!isNaN(regoDate)) {
            const daysUntilExpiry = (regoDate - Date.now()) / (1000 * 60 * 60 * 24);
            if (daysUntilExpiry < 14 && daysUntilExpiry > 0) {
                showNag = true;
                nagText = `‚ö†Ô∏è Registration expires in ${Math.floor(daysUntilExpiry)} days`;
            }
        }
    }
    
    if (showNag) {
        vehNagBar.innerHTML = `<span>${nagText}</span> <button onclick="startVehicleCheck()" class="text-xs underline">Update Now</button>`;
        vehNagBar.classList.remove('hidden');
    } else {
        vehNagBar.classList.add('hidden');
    }
};

console.log('‚úÖ All new features and bug fixes initialized!');

</script>

</body>
</html>






