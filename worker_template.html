<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>%%APP_NAME%%</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: #111827; color: white; height: 100%; width: 100%; overflow: hidden; }
.page { display: none; height: 100%; width: 100%; flex-direction: column; position: absolute; top: 0; left: 0; background-color: #111827; }
.page.active { display: flex; z-index: 10; }
.header-bar { padding: 0.75rem 1rem; background-color: #111827; border-bottom: 1px solid #374151; flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }
.footer-bar { padding: 1rem; background-color: #111827; border-top: 1px solid #374151; flex-shrink: 0; z-index: 20; }
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width 0.2s ease-out; }
.long-press-btn.pressing::after { width: 100%; transition: width 1.5s linear; }
.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.form-input-card { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.5rem; display: block; }
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }
.chip-btn { background-color: #374151; color: #e5e7eb; font-weight: 600; font-size: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #4b5563; flex: 1; transition: all 0.1s; }
.chip-btn:active { background-color: #2563eb; border-color: #3b82f6; transform: scale(0.95); }
.chip-btn.selected { background-color: #2563eb; border-color: #3b82f6; color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
.panic-mode { background-color: #7f1d1d !important; }
.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
.gps-bar.active-amber { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
.menu-icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; background: #374151; border-radius: 0.75rem; border: 1px solid #4b5563; text-align: center; padding: 0.5rem; transition: all 0.2s; }
.menu-icon-btn:active { background: #2563eb; transform: scale(0.95); }
.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* TOAST NOTIFICATION STYLE */
#toastMsg { z-index: 1000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-150%); }
#toastMsg.show { transform: translateY(0); }

/* INSTALL BANNER STYLES */
#installBanner { animation: slideDown 0.5s ease-out; }
@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
.ios-arrow { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid #1e293b; }
</style>
</head>
<body class="bg-gray-900 text-white">

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-green-500 text-white px-4 py-3 rounded shadow-2xl flex items-center gap-3">
    <div class="text-xl">‚úÖ</div>
    <div>
        <p class="font-bold text-sm" id="toastText">Operation Successful</p>
    </div>
</div>

<div id="app-container" class="relative h-full w-full">
<div id="offlineBanner" class="hidden absolute top-0 left-0 w-full bg-red-600 text-white text-center text-xs font-bold py-1 z-50">üì° OFFLINE MODE - Data queued for upload</div>
<div id="vehNagBar" class="hidden bg-orange-600 text-white text-center text-xs font-bold py-2 cursor-pointer z-40 border-b border-orange-400" onclick="startVehicleCheck()">‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete</div>

<div id="setupWizard" class="hidden fixed inset-0 bg-gray-900 z-[60] flex flex-col overflow-hidden">
    <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-900 z-10">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1"><div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div><div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div><div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div></div>
    </div>
    
    <div id="wizStep1" class="wizard-step active p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Who are you?</h2>
        <p class="text-gray-400 mb-8 text-sm">We need your details to match you with your safety profile in the database.</p>
        
        <label class="setting-label lbl-blue">Full Name</label>
        <input id="wiz_name" class="form-input mb-4" placeholder="e.g. John Doe">
        
        <label class="setting-label lbl-blue">Mobile Number</label>
        <input id="wiz_phone" type="tel" class="form-input mb-4" placeholder="021...">
        
        <label class="setting-label lbl-blue">Work Email</label>
        <input id="wiz_email" type="email" class="form-input mb-8" placeholder="name@org.co.nz">
        
        <div class="mt-auto">
            <button onclick="wizNext(1)" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Next: Security ‚Üí</button>
        </div>
    </div>

    <div id="wizStep2" class="wizard-step p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Security Codes</h2>
        <p class="text-gray-400 mb-6 text-sm">These 4-digit codes are stored privately on this phone. Only you will see them.</p>
        
        <div class="bg-gray-800 p-4 rounded-xl border border-green-500/30 mb-6">
            <h3 class="text-green-400 font-bold mb-1">1. Standard PIN</h3>
            <p class="text-xs text-gray-300 mb-3">Used to declare "I AM SAFE" or cancel an accidental alarm.</p>
            <input id="wiz_pin" type="tel" maxlength="4" class="w-full bg-gray-900 border border-green-500/50 rounded p-3 text-center text-xl tracking-widest text-white outline-none focus:border-green-500" placeholder="0000">
        </div>

        <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 mb-8">
            <h3 class="text-purple-400 font-bold mb-1">2. Duress PIN (Silent)</h3>
            <p class="text-xs text-gray-300 mb-3">Enter this if you are forced to cancel an alarm under threat. It <strong>looks</strong> like it cancelled the alarm, but secretly sends a high-priority "DURESS" alert to HQ.</p>
            <input id="wiz_duress" type="tel" maxlength="4" class="w-full bg-gray-900 border border-purple-500/50 rounded p-3 text-center text-xl tracking-widest text-white outline-none focus:border-purple-500" placeholder="9999">
        </div>
        
        <div class="mt-auto">
            <button onclick="wizNext(2)" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Next: Contacts ‚Üí</button>
            <button onclick="wizBack(2)" class="w-full py-3 text-gray-400 font-bold mt-2">Back</button>
        </div>
    </div>

    <div id="wizStep3" class="wizard-step p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Emergency Contacts</h2>
        <p class="text-gray-400 mb-6 text-sm">These people will receive SMS/Email alerts. <br><strong class="text-yellow-400">Important:</strong> If HQ is not live monitoring, these are the only people who will know you need help.</p>
        
        <label class="setting-label lbl-red">Primary Emergency Contact</label>
        <input id="wiz_emg_name" class="form-input-card" placeholder="Name (e.g. Spouse/Manager)">
        <input id="wiz_emg_phone" type="tel" class="form-input-card" placeholder="Mobile Number (021...)">
        <input id="wiz_emg_email" type="email" class="form-input mb-6" placeholder="Email Address">
        
        <label class="setting-label lbl-gray">Escalation Contact (Optional)</label>
        <input id="wiz_esc_name" class="form-input-card" placeholder="Name">
        <input id="wiz_esc_phone" type="tel" class="form-input-card" placeholder="Mobile Number">
        <input id="wiz_esc_email" type="email" class="form-input mb-8" placeholder="Email Address">

        <div class="mt-auto">
            <button onclick="wizSave()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">‚úÖ Save & Launch App</button>
            <button onclick="wizBack(3)" class="w-full py-3 text-gray-400 font-bold mt-2">Back</button>
        </div>
    </div>
</div>

<div id="wofBlockModal" class="hidden fixed inset-0 bg-gray-900 z-[100] flex flex-col p-6 items-center justify-center text-center">
    <div class="text-6xl mb-4">üõë</div>
    <h1 class="text-2xl font-bold text-red-500 mb-2"><span class="dynamic-wof">WOF</span> EXPIRED</h1>
    <p class="text-gray-300 mb-6 text-sm">Your vehicle <span class="dynamic-wof">Warrant of Fitness</span> is overdue.</p>
    <div class="bg-gray-800 p-4 rounded-lg border border-red-900/50 mb-6 w-full">
        <label class="flex items-start gap-3 text-left">
            <input type="checkbox" id="chkWofAck" class="mt-1 w-6 h-6 rounded bg-gray-700 border-gray-500 text-blue-600" onchange="toggleWofContinue()">
            <span class="text-sm text-gray-400 font-bold">I acknowledge that I must NOT use this overdue vehicle for work purposes.</span>
        </label>
    </div>
    <button id="btnWofContinue" disabled onclick="closeWofBlocker()" class="w-full py-4 bg-gray-700 text-gray-500 font-bold rounded-xl mb-4 transition-colors">Continue (Non-Vehicle Work)</button>
    <button onclick="closeWofBlocker(); startVehicleCheck();" class="text-blue-400 text-sm font-bold underline p-2">I have a new <span class="dynamic-wof">WOF</span> (Update Now)</button>
</div>

<div id="wofWarnModal" class="hidden fixed inset-0 bg-gray-900 z-[100] flex flex-col p-6 items-center justify-center text-center">
    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
    <h1 class="text-2xl font-bold text-amber-500 mb-2"><span class="dynamic-wof">WOF</span> Due Soon</h1>
    <p id="wofWarnText" class="text-white font-bold text-lg mb-4">Expires in X days</p>
    <p class="text-gray-400 mb-8 text-sm">Please arrange a vehicle check soon to ensure your <span class="dynamic-wof">WOF</span> remains current.</p>
    <button onclick="closeWofWarn();" class="w-full py-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl mb-4">Continue</button>
    <button onclick="closeWofWarn(); startVehicleCheck();" class="text-blue-400 text-sm font-bold underline p-2">I have a new <span class="dynamic-wof">WOF</span> (Update Now)</button>
</div>

<div id="iosInstallModal" class="hidden fixed inset-x-0 bottom-4 z-[200] px-4">
    <div class="bg-gray-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl relative">
        <button onclick="dismissInstall('ios')" class="absolute top-2 right-3 text-gray-400 hover:text-white font-bold">√ó</button>
        <div class="flex flex-col items-center text-center">
            <h3 class="text-lg font-bold text-white mb-2">Install App</h3>
            <p class="text-sm text-gray-300 mb-4">Install this app to your Home Screen for quick access and offline safety.</p>
            <div class="flex items-center gap-2 text-blue-400 font-bold text-sm animate-pulse">
                <span>üëá Tap Share</span>
                <span>‚Üí</span>
                <span>‚äû Add to Home Screen</span>
            </div>
        </div>
        <div class="ios-arrow absolute bottom-[-10px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-gray-800 border-t-blue-500"></div>
    </div>
</div>

<div id="settingsPage" class="page z-50 bg-gray-800">
    <div class="header-bar"><h1 class="text-2xl font-bold text-white">Settings</h1><button onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button></div>
    <div class="content-area pb-24">
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4"><p class="text-xs text-blue-200">Re-run the setup wizard to change details?</p><button onclick="startWizard()" class="mt-2 text-xs bg-blue-600 px-2 py-1 rounded font-bold">Restart Wizard</button></div>
        
        <div id="installAppContainer" class="hidden mb-4">
            <button id="btnInstallApp" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2">
                <span class="text-xl">üì≤</span> Install App to Home Screen
            </button>
        </div>

        <div class="setting-card border-gray-600"><label class="setting-label lbl-gray">System Actions</label><input id="set_url" disabled class="form-input-card text-xs font-mono text-gray-500 mb-2" value="%%GOOGLE_SHEET_URL%%"><div class="flex gap-2"><button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white">Force Sync</button><button onclick="clearData()" class="flex-1 bg-red-900/50 text-red-400 hover:bg-red-900/70 py-2 rounded text-xs font-bold">Reset App</button></div></div>
    </div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <div class="flex items-center gap-2"><img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'"> <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1></div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end gap-0.5" id="gpsContainer">
                <span class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">GPS</span>
                <div class="flex gap-0.5" id="gpsBars">
                    <div id="gps1" class="gps-bar"></div><div id="gps2" class="gps-bar"></div><div id="gps3" class="gps-bar"></div>
                </div>
                <div id="gpsError" class="hidden text-red-500 font-bold text-xs animate-pulse">‚ùå NO SIG</div>
            </div>
            <button onclick="showModal('info')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚ÑπÔ∏è</button>
            <button onclick="navigate('settings')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="content-area">
        <div id="installBanner" class="hidden bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-lg mb-4 flex justify-between items-center shadow-lg">
            <div onclick="triggerInstall()" class="flex-1 flex items-center gap-3 cursor-pointer">
                <div class="text-2xl">üì≤</div>
                <div>
                    <p class="font-bold text-sm">Install App</p>
                    <p class="text-xs text-blue-200">Add to Home Screen for Offline use.</p>
                </div>
            </div>
            <button onclick="dismissInstall('android')" class="p-2 text-blue-200 hover:text-white font-bold">‚úï</button>
        </div>

        <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2"><div class="spinner"></div><span>Syncing...</span></div>
        
        <div id="locationList" class="grid grid-cols-2 gap-3 pb-4"></div>
        
        <div class="flex gap-3 mt-4"><button onclick="forceSync()" class="flex-1 py-4 bg-gray-700 text-blue-300 font-bold rounded-xl shadow-lg border border-gray-600 text-sm">‚Üª Sync</button><button onclick="openLocModal()" class="flex-[2] py-4 border-2 border-dashed border-gray-600 text-gray-400 rounded-xl hover:border-gray-500 hover:text-white transition font-bold text-sm">+ Add Manual Location</button></div>
    </div>
    <div class="footer-bar">
        <div class="flex justify-end items-center gap-2 mb-2">
            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest" id="lblHighRisk">Zero Tolerance Mode</span>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="chkHighRisk" class="sr-only peer" onchange="toggleHighRiskUI()">
              <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
            </label>
        </div>
        
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2"><span class="text-gray-400 text-sm font-bold">Duration</span><span id="durationDisplay" class="font-bold text-blue-400">0 mins</span></div>
            <div class="flex gap-2 mb-3">
                <button id="btnDur15" onclick="quickSetTime(15)" class="chip-btn">15m</button>
                <button id="btnDur30" onclick="quickSetTime(30)" class="chip-btn">30m</button>
                <button id="btnDur60" onclick="quickSetTime(60)" class="chip-btn">1h</button>
                <button id="btnDur120" onclick="quickSetTime(120)" class="chip-btn">2h</button>
            </div>
            <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateArrivedButtonState()">
        </div>
        <div class="flex gap-2"><button id="btnQuick" onclick="openQuickMenu()" class="flex-1 py-4 bg-teal-900 text-teal-400 font-bold rounded-xl border border-teal-700/50 shadow-lg active:scale-95 transition">Quick Notes</button><button type="button" id="btnStart" class="long-press-btn flex-[2] py-4 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all" disabled>Select Location</button></div>
    </div>
</div>
<div id="lockedPage" class="page">
    <div id="fiveMinBanner" class="hidden absolute top-0 left-0 w-full bg-yellow-600 text-white font-bold py-3 animate-pulse z-50 shadow-xl border-b-4 border-yellow-400 text-center">‚ö†Ô∏è 5 MINUTES REMAINING - EXTEND NOW</div>
    <div class="flex-1 flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <button onclick="toggleBatterySaver()" class="p-2 bg-gray-800 rounded-full text-yellow-400 border border-gray-600 hover:bg-gray-700">üåô</button>
            <button onclick="handlePanicTap()" id="btnPanic" class="w-24 h-24 bg-red-600 rounded-full font-bold text-white text-2xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center select-none">SOS</button>
        </div>
        <div class="text-center">
            <p class="text-gray-500 text-sm uppercase tracking-widest">Currently At</p>
            <div class="flex items-center justify-center gap-2 mt-1 mb-2 cursor-pointer hover:bg-gray-800 rounded p-2 transition" onclick="showCurrentSiteInfo()">
                <h2 id="lockedLocationName" class="text-3xl font-bold text-white truncate max-w-[250px]"></h2><span class="text-blue-400 text-xl">‚ÑπÔ∏è</span>
            </div>
            <div id="highRiskBadge" class="hidden text-red-500 font-black text-sm uppercase tracking-widest border border-red-500 inline-block px-2 py-0.5 rounded mb-2">‚ö° ZERO TOLERANCE MODE</div>
            <div id="overdueLabel" class="hidden text-red-500 font-black text-2xl animate-pulse my-2 tracking-widest border-2 border-red-500 inline-block px-4 py-1 rounded uppercase">OVERDUE</div>
            <div id="countdownTimer" class="text-7xl font-bold font-mono text-white tracking-tighter">00:00</div>
            <p class="text-gray-400 mt-2">Due: <span id="lockedAnticipatedTime" class="text-blue-400 font-bold"></span></p>
        </div>
        <div class="space-y-3 w-full">
            <div class="flex gap-3"><button id="btnExtend" class="long-press-btn flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg" onclick="showModal('extend')">Extend</button><button onclick="openMidVisitMenu()" class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl text-lg shadow-lg">Notes</button></div>
            <button id="btnDepart" class="long-press-btn w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl text-lg shadow-lg">HOLD TO END</button>
            <button id="btnSafe" class="hidden long-press-btn w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg animate-pulse">I AM SAFE</button>
        </div>
    </div>
    <div id="batterySaver" class="hidden absolute inset-0 bg-black z-50 flex items-center justify-center flex-col cursor-pointer" onclick="toggleBatterySaver()"><div class="text-gray-600 text-sm mb-4">Tap to wake</div><div class="text-gray-800 font-mono text-xl animate-pulse" id="saverClock">00:00</div></div>
</div>
<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
    <div id="infoModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto"><h2 id="infoTitle" class="text-xl font-bold text-white mb-2">Site Info</h2><div id="siteInfoContent" class="text-gray-300 text-sm space-y-2 mb-4"></div><div class="flex gap-2 mb-4"><a id="btnSiteCall" href="#" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded text-center font-bold hidden">üìû Call</a><a id="btnSiteEmail" href="#" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded text-center font-bold hidden">‚úâÔ∏è Email</a></div><a id="btnSiteNav" href="#" target="_blank" class="block w-full py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded text-center mb-2 hidden shadow-lg transform active:scale-95 transition">üó∫Ô∏è Navigate to Site</a><button onclick="closeModal('info')" class="w-full py-3 bg-gray-600 text-white font-bold rounded">Close</button></div>
    <div id="extendModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 class="text-xl font-bold mb-6 text-white">Extend Visit</h2><div class="grid grid-cols-3 gap-3 mb-6"><button onclick="confirmExtension(10)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+10m</button><button onclick="confirmExtension(15)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+15m</button><button onclick="confirmExtension(30)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+30m</button></div><button onclick="closeModal('extend')" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-gray-300">Cancel</button></div>
    <div id="pinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6 text-center"><h2 class="text-xl font-bold mb-4 text-white">Enter PIN</h2><input type="password" id="pinInput" maxlength="4" class="text-center text-3xl tracking-[1em] w-48 mx-auto bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-blue-500" inputmode="numeric"><div class="mt-6 flex justify-end space-x-3"><button id="cancelPinBtn" onclick="closeModal('pin')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="confirmPinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button></div></div>
    <div id="templateModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 id="modalMenuTitle" class="text-xl font-bold mb-4 text-white">Select Report Type</h2><div id="templateList" class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto"></div><button onclick="closeModal('template')" class="mt-4 w-full py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold text-white">Cancel</button></div>
    <div id="checkinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center border-4 border-yellow-500"><h2 class="text-2xl font-bold text-yellow-400 mb-4">Are you OK?</h2><p class="text-lg text-gray-300 mb-4">Scheduled safety check.</p><div id="checkinCountdown" class="text-6xl font-bold text-yellow-400 mb-6 font-mono">2:00</div><button id="btnCheckinConfirm" class="long-press-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">HOLD TO CONFIRM OK</button></div>
    <div id="modal-report" class="hidden bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl"><h2 class="text-2xl font-bold text-white mb-6 flex-shrink-0" id="reportTitle">Visit Report</h2><div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2"></div><div class="flex gap-3 flex-shrink-0"><button onclick="closeModal('report')" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button><button id="btnSubmitRep" class="long-press-btn flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit & END</button></div></div>
    <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 id="alertModalTitle" class="text-xl font-bold mb-2 text-white">Alert</h2><p id="alertModalMessage" class="text-gray-300 mb-6"></p><button onclick="closeModal('alert')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button></div>
</div>
<div id="locationModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50"><h2 id="locModalTitle" class="text-xl font-bold mb-4 text-white">Edit Location</h2><input type="hidden" id="locId"><div class="space-y-4"><div><label class="text-xs text-gray-400 uppercase font-bold">Business Name</label><input type="text" id="locBusiness" class="form-input" placeholder="e.g. Acme Corp"></div><div><label class="text-xs text-gray-400 uppercase font-bold">Site Name</label><input type="text" id="locName" class="form-input" placeholder="e.g. Head Office"></div><div><label class="text-xs text-gray-400 uppercase font-bold">Address</label><div class="flex gap-2"><input type="text" id="locAddr" class="form-input mb-0 flex-1"><button onclick="getGpsAddress()" id="btnGpsAddr" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-lg font-bold text-xs shrink-0 shadow-lg">üìç GPS</button></div></div><div id="advLocOptions" class="pt-2 border-t border-gray-700"><div class="mb-3 bg-gray-900 p-2 rounded"><label class="text-xs text-gray-400 uppercase font-bold block mb-2">Report Required on Departure?</label><div class="flex gap-6"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="reportReq" id="radRepYes" class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-500 focus:ring-blue-500"><span class="text-sm text-white font-bold">Yes</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="reportReq" id="radRepNo" class="w-5 h-5 text-red-500 bg-gray-700 border-gray-500 focus:ring-red-500"><span class="text-sm text-gray-300">No</span></label></div></div><div><label class="text-xs text-gray-400 uppercase font-bold">Template Name</label><input type="text" id="locTemplate" class="form-input text-sm" placeholder="(Standard)"><p class="text-xs text-gray-500 mt-1">Must match 'Templates' sheet.</p></div></div></div><div class="mt-6 flex justify-end space-x-3"><button onclick="deleteLoc()" id="btnDelLoc" class="bg-red-900/50 text-red-400 font-bold py-2 px-4 rounded-lg hidden">Delete</button><div class="flex-1"></div><button onclick="closeModal('location')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveLoc()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div></div></div>
<script>
const CONFIG={isAdv:%%IS_ADVANCED%%,mileage:%%ENABLE_MILEAGE%%,url:"%%GOOGLE_SHEET_URL%%",org:"%%ORGANISATION_NAME%%",checkinEnabled:%%CHECKIN_ENABLED%%,checkinInterval:%%CHECKIN_INTERVAL%%,escalationMinutes:%%ESCALATION_MINUTES%%,key:"%%SECRET_KEY%%",orsKey:"%%ORS_API_KEY%%",vehEnabled:%%VEHICLE_ENABLED%%,vehInterval:%%VEHICLE_INTERVAL%%, countryPrefix:"%%COUNTRY_PREFIX%%", reqTravelReport: %%REQ_TRAVEL_REPORT%%, vehicleTerm: "%%VEHICLE_TERM%%", voiceLocale: "%%VOICE_LOCALE%%"};const DURATION_MAP=[0,10,15,20,30,45,60,75,90,105,120,150,180,210,240,270,300,360,420,480,540,600,660,720];let state={settings:{},locations:[],selectedLocationId:null,visitDurationMinutes:0,activeVisit:null,cachedForms:{},pendingUploads:[],globalForms:[],photoStore:{},lowBatSent:false,meta:{}};let synth,checkinIntervalId,mainScreenReminderTimer,wakeLock,timerInt,travellingInterval;let tempPhoto=null,sigPad=null,panicTapCount=0,panicTapTimer;let deferredPrompt,isMidVisitUpdate=false,currentActiveTemplate="",currentBatteryLevel="100%";let calculatedDist=null;let gpsWarm=false;let gpsWatchId=null;

function showModal(id) {
    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
    const modals = ['locationModal','pinModal','modal-report','checkinModal','extendModal','infoModal','templateModal','alertModal'];
    modals.forEach(m => {
        const el = document.getElementById(m);
        if(el) el.classList.add('hidden');
    });
    
    if(id==='location') document.getElementById('locationModal').classList.remove('hidden');
    else if(id==='pin') document.getElementById('pinModal').classList.remove('hidden');
    else if(id==='report') document.getElementById('modal-report').classList.remove('hidden');
    else if(id==='checkin') document.getElementById('checkinModal').classList.remove('hidden');
    else if(id==='extend') document.getElementById('extendModal').classList.remove('hidden');
    else if(id==='template') document.getElementById('templateModal').classList.remove('hidden');
    else if(id==='alert') document.getElementById('alertModal').classList.remove('hidden');
    else document.getElementById('infoModal').classList.remove('hidden');
}

function closeModal(id) {
    document.getElementById('modalBackdrop').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.remove('flex');
    document.querySelectorAll('#modalBackdrop > div').forEach(d=>d.classList.add('hidden'));
    document.getElementById('locationModal').classList.add('hidden');
}

function showToast(msg) {
    const t = document.getElementById('toastMsg');
    document.getElementById('toastText').innerText = msg;
    t.classList.add('show');
    setTimeout(() => { t.classList.remove('show'); }, 3000);
}

function toggleWofContinue(){
    const chk=document.getElementById('chkWofAck');
    const btn=document.getElementById('btnWofContinue');
    btn.disabled=!chk.checked;
    if(chk.checked){
        btn.classList.remove('bg-gray-700','text-gray-500');
        btn.classList.add('bg-blue-600','text-white');
    }else{
        btn.classList.add('bg-gray-700','text-gray-500');
        btn.classList.remove('bg-blue-600','text-white');
    }
}

function closeWofBlocker(){document.getElementById('wofBlockModal').classList.add('hidden');}
function closeWofWarn(){document.getElementById('wofWarnModal').classList.add('hidden');}

function openLocModal(){
    document.getElementById('locModalTitle').innerText="Add Manual Location";
    document.getElementById('locId').value="";
    document.getElementById('locBusiness').value="";
    document.getElementById('locName').value="";
    document.getElementById('locAddr').value="";
    document.getElementById('locTemplate').value="";
    document.getElementById('btnDelLoc').classList.add('hidden');
    document.getElementById('radRepYes').checked=true;
    showModal('location');
}

function editManualLocation(id){
    const l=state.locations.find(x=>x.id===id);
    if(!l)return;
    document.getElementById('locModalTitle').innerText="Edit Location";
    document.getElementById('locId').value=id;
    document.getElementById('locBusiness').value=l.companyName||"";
    document.getElementById('locName').value=l.name;
    document.getElementById('locAddr').value=l.address||"";
    document.getElementById('locTemplate').value=l.templateName||"";
    if(l.noReport)document.getElementById('radRepNo').checked=true;else document.getElementById('radRepYes').checked=true;
    document.getElementById('btnDelLoc').classList.remove('hidden');
    showModal('location');
}

function editTravelSettings(){
    const l=state.locations.find(x=>x.id==='travel');
    document.getElementById('locModalTitle').innerText="Travel Settings";
    document.getElementById('locId').value='travel';
    document.getElementById('locBusiness').parentNode.style.display='none';
    document.getElementById('locName').parentNode.style.display='none';
    document.getElementById('locAddr').parentNode.style.display='none';
    document.getElementById('locTemplate').parentNode.style.display='none';
    document.getElementById('btnDelLoc').classList.add('hidden');
    if(l.noReport)document.getElementById('radRepNo').checked=true;else document.getElementById('radRepYes').checked=true;
    showModal('location');
}

function saveLoc(){
    const id=document.getElementById('locId').value;
    const n=document.getElementById('locName').value;
    const b=document.getElementById('locBusiness').value;
    const a=document.getElementById('locAddr').value;
    const t=document.getElementById('locTemplate').value;
    const nr=document.getElementById('radRepNo').checked;
    
    if(id==='travel'){
        const l=state.locations.find(x=>x.id==='travel');
        l.noReport=nr;
        localStorage.setItem('otg_user_travel_pref',nr);
        renderLocations();
        closeModal('location');
        return;
    }
    if(!n)return alert("Site Name is required");
    const newId=id||'loc_'+Date.now();
    const loc={id:newId,name:n,companyName:b,address:a,templateName:t,noReport:nr};
    if(id){
        const i=state.locations.findIndex(x=>x.id===id);
        state.locations[i]=loc;
    }else{
        state.locations.push(loc);
    }
    saveState();
    renderLocations();
    closeModal('location');
}

function deleteLoc(){
    const id=document.getElementById('locId').value;
    if(!confirm("Delete this location?"))return;
    state.locations=state.locations.filter(x=>x.id!==id);
    saveState();
    renderLocations();
    closeModal('location');
}

function getGpsAddress(){
    const b=document.getElementById('btnGpsAddr');
    b.innerText="...";
    navigator.geolocation.getCurrentPosition(p=>{
        const lat=p.coords.latitude,lon=p.coords.longitude;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(r=>r.json())
        .then(d=>{document.getElementById('locAddr').value=d.display_name;b.innerText="üìç GPS";})
        .catch(()=>{document.getElementById('locAddr').value=`${lat}, ${lon}`;b.innerText="üìç GPS";});
    });
}

window.addEventListener('online',updateNetworkStatus);
window.addEventListener('offline',updateNetworkStatus);
function updateNetworkStatus(){
    const b=document.getElementById('offlineBanner');
    if(navigator.onLine){
        b.classList.add('hidden');
        if(state.pendingUploads&&state.pendingUploads.length>0) processUploadQueue();
    }else{
        b.classList.remove('hidden');
    }
}

function getDeviceID(){
    let id=localStorage.getItem('device_uuid');
    if(!id){id='dev_'+Math.random().toString(36).substr(2,9)+'_'+Date.now();localStorage.setItem('device_uuid',id);}
    return id;
}

function navigate(p){
    document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
    document.getElementById(p+'Page').classList.add('active');
    if(p==='main')startReminderTimer(); else clearTimeout(mainScreenReminderTimer);
    if(p==='settings'){populateSettingsForm();}
}

function startWizard(){
    document.getElementById('setupWizard').classList.remove('hidden');
    wizGoTo(1);
    if(state.settings.workerName)populateWizard();
}

function wizGoTo(step){
    document.querySelectorAll('.wizard-step').forEach(e=>e.classList.remove('active'));
    document.getElementById('wizStep'+step).classList.add('active');
    for(let i=1;i<=3;i++){
        const d=document.getElementById('dot'+i);
        d.classList.toggle('bg-blue-500',i===step);
        d.classList.toggle('bg-gray-700',i!==step);
    }
}

function wizNext(current){
    if(current===1){
        if(!document.getElementById('wiz_name').value)return alert("Please enter your Full Name.");
        wizGoTo(2);
    }else if(current===2){
        if(document.getElementById('wiz_pin').value.length<4)return alert("Please set a 4-digit Standard PIN.");
        if(document.getElementById('wiz_duress').value.length<4)return alert("Please set a 4-digit Duress PIN.");
        if(document.getElementById('wiz_pin').value===document.getElementById('wiz_duress').value)return alert("Codes must be different.");
        wizGoTo(3);
    }
}

function wizBack(current){wizGoTo(current-1);}

function wizSave(){
    state.settings.workerName=document.getElementById('wiz_name').value;
    state.settings.workerPhone=cleanGlobalPhone(document.getElementById('wiz_phone').value);
    state.settings.workerEmail=document.getElementById('wiz_email').value;
    state.settings.emergencyName=document.getElementById('wiz_emg_name').value;
    state.settings.emergencyPhone=cleanGlobalPhone(document.getElementById('wiz_emg_phone').value);
    state.settings.emergencyEmail=document.getElementById('wiz_emg_email').value;
    state.settings.escalationName=document.getElementById('wiz_esc_name').value;
    state.settings.escalationPhone=cleanGlobalPhone(document.getElementById('wiz_esc_phone').value);
    state.settings.escalationEmail=document.getElementById('wiz_esc_email').value;
    state.settings.pinCode=document.getElementById('wiz_pin').value;
    state.settings.duressPin=document.getElementById('wiz_duress').value;
    state.settings.googleSheetUrl=CONFIG.url;
    saveState();
    document.getElementById('setupWizard').classList.add('hidden');
    navigate('main');
    forceSync();
}

function cleanGlobalPhone(num) {
    if(!num) return "";
    let n = num.replace(/[^0-9]/g, ''); 
    const prefix = (CONFIG.countryPrefix || "").replace('+', ''); 
    if(!prefix) return "+" + n; 
    if (n.startsWith(prefix)) return '+' + n;
    if (n.startsWith('0')) return '+' + prefix + n.substring(1);
    if (prefix === '1' && n.length === 10) return '+1' + n;
    return '+' + prefix + n;
}

function populateWizard(){
    document.getElementById('wiz_name').value=state.settings.workerName||"";
    document.getElementById('wiz_phone').value=state.settings.workerPhone||"";
    document.getElementById('wiz_email').value=state.settings.workerEmail||"";
    document.getElementById('wiz_emg_name').value=state.settings.emergencyName||"";
    document.getElementById('wiz_emg_phone').value=state.settings.emergencyPhone||"";
    document.getElementById('wiz_emg_email').value=state.settings.emergencyEmail||"";
    document.getElementById('wiz_esc_name').value=state.settings.escalationName||"";
    document.getElementById('wiz_esc_phone').value=state.settings.escalationPhone||"";
    document.getElementById('wiz_esc_email').value=state.settings.escalationEmail||"";
    document.getElementById('wiz_pin').value=state.settings.pinCode||"";
    document.getElementById('wiz_duress').value=state.settings.duressPin||"";
}

function populateSettingsForm(){document.getElementById('set_url').value=state.settings.googleSheetUrl||CONFIG.url;}
function saveState(){localStorage.setItem('loneWorkerState',JSON.stringify(state));}

function forceSync(){
    if(!state.settings.workerName)return alert("Please enter your name in Settings first.");
    document.getElementById('uploadBanner').classList.remove('hidden');
    const dId=getDeviceID();
    fetch(`${CONFIG.url}?action=sync&worker=${encodeURIComponent(state.settings.workerName)}&key=${CONFIG.key}&deviceId=${dId}`)
    .then(r=>r.text())
    .then(txt=>{
        if(txt.includes("OTG Online")||!txt.startsWith("{"))throw new Error("SERVER UPDATE REQUIRED.");
        return JSON.parse(txt);
    })
    .then(data=>{
        if(data.status==="error"){
            document.getElementById('uploadBanner').classList.add('hidden');
            if(data.message.includes("ACCESS DENIED")){
                alert("‚õî ACCESS DENIED\n\n"+data.message);
                startWizard();
            } else {
                alert("‚ùå Sync Error: " + data.message);
            }
            return;
        }
        const existingManual=state.locations.filter(x=>x.id.startsWith('loc_'));
        
        const safeSites = data.sites || [];
        const ms = safeSites.map(s=>({
            id:'site_'+s.siteName.replace(/\s/g,''),
            name:s.siteName,
            address:s.address,
            companyName:s.company,
            templateName:s.template,
            noReport:false,
            contactName:s.contactName,
            contactPhone:s.contactPhone,
            contactEmail:s.contactEmail,
            notes:s.notes
        }));
        
        if(CONFIG.mileage) ms.unshift({id:'travel',name:'Travelling',address:'Calculates Mileage via GPS',noReport:!CONFIG.reqTravelReport,companyName:'Internal',templateName:'Travel Report'});
        state.locations=ms.concat(existingManual);
        state.globalForms=data.forms||[];
        state.cachedForms=data.cachedTemplates||{};
        state.meta=data.meta||{};
        if(!state.cachedForms["Standard Visit Note"]&&!state.cachedForms["(Standard)"]) state.cachedForms["Standard Visit Note"]=[{type:'note',text:'Standard Check-in'}];
        state.cachedForms["Note to Self"]=[{type:'text',text:'Note'},{type:'photo',text:'Attachment'}];
        if(CONFIG.mileage&&!state.cachedForms['Travel Report']) state.cachedForms['Travel Report']=[{type:'number',text:'Distance (km)'},{type:'text',text:'Details'},{type:'photo',text:'Odometer'}];
        
        const tLoc = state.locations.find(x => x.id === 'travel');
        const userPref = localStorage.getItem('otg_user_travel_pref');
        if (tLoc && userPref !== null) { tLoc.noReport = (userPref === 'true'); }
        
        saveState();
        renderLocations();
        checkVehicleStatus();
        document.getElementById('uploadBanner').classList.add('hidden');
        showToast("Sync Complete!");
    })
    .catch(e=>{
        document.getElementById('uploadBanner').classList.add('hidden');
        alert("Sync Failed: "+e.message);
    });
}

function checkVehicleStatus(){
    if(!CONFIG.vehEnabled)return;
    const b=document.getElementById('vehNagBar');let s=false;
    if(CONFIG.vehicleTerm) {
        document.getElementById('vehNagBar').innerText = `‚ö†Ô∏è ${CONFIG.vehicleTerm} Check Overdue - Tap to Complete`;
    }
    
    if(state.meta.lastVehCheck){
        const l=new Date(state.meta.lastVehCheck);const d=(Date.now()-l.getTime())/(1000*60*60*24);
        if(d>CONFIG.vehInterval){s=true;}
    }else{
        s=true; document.getElementById('vehNagBar').innerText=`‚ö†Ô∏è ${CONFIG.vehicleTerm} Check Required`;
    }
    
    if(state.meta.wofExpiry){
        const w=new Date(state.meta.wofExpiry);const du=(w.getTime()-Date.now())/(1000*60*60*24);
        if(du<0){s=true;b.innerText=`‚õî ${CONFIG.vehicleTerm} EXPIRED - Vehicle Use Prohibited`;}
        else if(du<14){s=true;b.innerText=`‚ö†Ô∏è Vehicle Check: ${CONFIG.vehicleTerm} Due in ${Math.ceil(du)} Days`;}
    }
    if(s)b.classList.remove('hidden');else b.classList.add('hidden');
}

function startVehicleCheck(){loadFormAndShow('Vehicle Safety Check');}
function openQuickMenu(){isMidVisitUpdate=false;calculatedDist=null;showModal('template');renderIconGrid(state.globalForms, null);}
function openMidVisitMenu(){isMidVisitUpdate=true;calculatedDist=null;showModal('template');const cid=state.activeVisit?state.activeVisit.locationId:null;const loc=state.locations.find(x=>x.id===cid);renderIconGrid(state.globalForms, loc);}

function renderIconGrid(forms, loc) {
    const l=document.getElementById('templateList');
    l.innerHTML='';
    const addBtn=(name,icon,label)=>{
        const b=document.createElement('button');
        b.className="menu-icon-btn";
        b.innerHTML=`<div class="text-3xl mb-1">${icon}</div><div class="text-xs font-bold leading-tight">${label}</div>`;
        b.onclick=()=>{closeModal('template');loadFormAndShow(name);};
        l.appendChild(b);
    };
    if(loc&&loc.templateName)addBtn(loc.templateName,"üè¢",loc.templateName);
    else if(loc&&loc.id==='travel')addBtn("Travel Report","üõ£Ô∏è","Travel Log");
    else if(isMidVisitUpdate)addBtn("(Standard)","‚è±Ô∏è","Update Status");
    addBtn("Note to Self","üìù","Note to Self");
    if(forms){
        forms.forEach(f=>{
            if(loc&&loc.templateName===f.name)return;
            let icon="üìã";
            const n=f.name.toLowerCase();
            if(n.includes('vehicle'))icon="üöó";
            else if(n.includes('incident')||n.includes('accident'))icon="‚ö†Ô∏è";
            else if(n.includes('hazard'))icon="‚ò¢Ô∏è";
            else if(n.includes('client'))icon="üë§";
            addBtn(f.name,icon,f.name);
        });
    }
}

function createTemplateBtn(l,v){return null;}
function initLocations(){if(!state.locations)state.locations=[];if(!state.cachedForms["Standard Visit Note"])state.cachedForms["Standard Visit Note"]=[{type:'note',text:'Standard Check-in'}];if(CONFIG.mileage&&!state.cachedForms['Travel Report'])state.cachedForms['Travel Report']=[{type:'number',text:'Distance (km)'},{type:'text',text:'Details'},{type:'photo',text:'Odometer'}];}

// UPDATED: Grid Layout for Locations + Distinct Travel Tile
function renderLocations(){
    const l=document.getElementById('locationList');
    l.innerHTML='';
    if (!state.locations) state.locations = [];
    
    state.locations.forEach(loc=>{
        if (!loc || !loc.id) return;
        
        // --- Special Handling for Travel Tile ---
        if(loc.id === 'travel') {
            const isSel = state.selectedLocationId === 'travel';
            const d = document.createElement('div');
            // Full width (col-span-2) + Gradient Background
            d.className = `col-span-2 p-4 rounded-xl shadow-lg flex items-center justify-between cursor-pointer transition-all border-2 ${isSel ? 'border-white scale-[1.02] ring-2 ring-purple-400' : 'border-transparent hover:border-white/20'} bg-gradient-to-r from-indigo-600 to-purple-700`;
            
            d.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="bg-white/20 p-3 rounded-full text-2xl">üöó</div>
                    <div>
                        <div class="text-lg font-bold text-white tracking-tight">Travelling</div>
                        <div class="text-xs text-indigo-200 font-medium">GPS Mileage Tracking</div>
                    </div>
                </div>
                <div class="text-white/50 text-xl">‚Üí</div>
            `;
            d.onclick = () => {
               if(state.meta.wofExpiry){
                   const w=new Date(state.meta.wofExpiry);
                   const days = (w.getTime()-Date.now())/(1000*60*60*24);
                   if(days < 0) { document.getElementById('wofBlockModal').classList.remove('hidden'); return; } 
                   else if (days < 14) {
                       document.getElementById('wofWarnModal').classList.remove('hidden');
                       document.getElementById('wofWarnText').innerText = `Expires in ${Math.ceil(days)} days (${w.toLocaleDateString()})`;
                       state.selectedLocationId=loc.id; 
                       warmUpGps(); renderLocations(); updateArrivedButtonState(); return;
                   }
               }
               state.selectedLocationId = 'travel';
               warmUpGps(); renderLocations(); updateArrivedButtonState();
            };
            
            // Add Info Button for Travel Settings
            const infoBtn = document.createElement('button');
            infoBtn.innerHTML = '‚öôÔ∏è';
            infoBtn.className = "absolute top-2 right-2 text-white/40 hover:text-white text-xs p-2";
            infoBtn.onclick = (e) => { e.stopPropagation(); editTravelSettings(); };
            d.style.position = 'relative';
            d.appendChild(infoBtn);
            
            l.appendChild(d);
            return;
        }

        // --- Standard Site Tiles (Grid Items) ---
        const d = document.createElement('div');
        const isSel = state.selectedLocationId === loc.id;
        // Compact card style
        d.className = `p-3 rounded-lg border-2 cursor-pointer flex flex-col justify-between h-24 shadow-sm transition-all ${isSel ? 'border-blue-500 bg-blue-900/40' : 'border-gray-700 bg-gray-800 hover:bg-gray-750'}`;
        
        let icon = "üè¢";
        if(loc.name.includes("Home")) icon = "üè†";
        
        d.innerHTML = `
            <div class="flex justify-between items-start">
                <span class="text-2xl">${icon}</span>
                ${(loc.notes || loc.contactName || loc.id.startsWith('loc_')) ? `<button class="text-gray-500 hover:text-white z-20" onclick="showSiteInfo('${loc.id}',event)">‚ÑπÔ∏è</button>` : ''}
            </div>
            <div>
                <div class="text-xs font-bold text-gray-400 uppercase truncate">${loc.companyName||''}</div>
                <div class="text-sm font-bold text-white truncate leading-tight">${loc.name}</div>
            </div>
        `;
        d.onclick = () => { state.selectedLocationId = loc.id; warmUpGps(); renderLocations(); updateArrivedButtonState(); };
        l.appendChild(d);
    });
}

function showSiteInfo(id,e){
    if(e)e.stopPropagation();
    if(id.startsWith('loc_')) { editManualLocation(id); return; }
    if(id === 'travel') { editTravelSettings(); return; }
    document.getElementById('infoTitle').innerText="";document.getElementById('siteInfoContent').innerHTML="";document.getElementById('btnSiteCall').classList.add('hidden');document.getElementById('btnSiteEmail').classList.add('hidden');document.getElementById('btnSiteNav').classList.add('hidden');const l=state.locations.find(x=>x.id===id);showModal('info');if(!l){document.getElementById('infoTitle').innerText="Unknown Location";return;}document.getElementById('infoTitle').innerText=l.name;let h="";if(l.address){h+=`<p><strong>Address:</strong><br>${l.address}</p>`;const n=document.getElementById('btnSiteNav');n.href=`https://maps.google.com/?q=${encodeURIComponent(l.address)}`;n.classList.remove('hidden');}if(l.contactName)h+=`<p class="mt-2"><strong>Contact:</strong> ${l.contactName}</p>`;if(l.notes)h+=`<div class="mt-3 bg-gray-700 p-2 rounded text-xs border-l-2 border-yellow-500">${l.notes}</div>`;document.getElementById('siteInfoContent').innerHTML=h;const bc=document.getElementById('btnSiteCall');const be=document.getElementById('btnSiteEmail');if(l.contactPhone){bc.href=`tel:${l.contactPhone}`;bc.classList.remove('hidden');}if(l.contactEmail){be.href=`mailto:${l.contactEmail}`;be.classList.remove('hidden');}
}

function showCurrentSiteInfo(){if(state.activeVisit)showSiteInfo(state.activeVisit.locationId);}

function toggleHighRiskUI(){
    // Visual feedback for toggle
    const chk = document.getElementById('chkHighRisk');
    const lbl = document.getElementById('lblHighRisk');
    if(chk.checked){
        lbl.classList.remove('text-gray-500');
        lbl.classList.add('text-red-500', 'animate-pulse');
    } else {
        lbl.classList.add('text-gray-500');
        lbl.classList.remove('text-red-500', 'animate-pulse');
    }
}

function updateArrivedButtonState(){
    const v=DURATION_MAP[document.getElementById('durationSlider').value];
    document.getElementById('durationDisplay').innerText=v>=60?(Math.floor(v/60)+' hr '+(v%60)+' min'):v+' min';
    state.visitDurationMinutes=v;
    
    [15,30,60,120].forEach(m => {
        const btn = document.getElementById('btnDur'+m); 
        if(btn){
            if(v===m) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }
    });
    
    const b=document.getElementById('btnStart');
    if(state.selectedLocationId&&v>0){
        b.disabled=false;
        b.innerText="HOLD TO START";
        b.className="long-press-btn flex-[2] py-4 bg-green-600 text-white font-bold rounded-xl text-xl shadow-lg transition-all";
        setupLongPress(b,startVisit);
    }else{
        b.disabled=true;
        b.innerText=state.selectedLocationId?"Set Time":"Select Location";
        b.className="long-press-btn flex-[2] py-4 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl transition-all";
    }
}

function quickSetTime(m){document.getElementById('durationSlider').value=DURATION_MAP.findIndex(x=>x===m);updateArrivedButtonState();}

function startVisit(){
    warmUpSpeech(); // NEW: Force voice warmup
    const s=state.locations.find(x=>x.id===state.selectedLocationId);
    if(s.id==='travel')startTravellingPulse();
    const n=new Date();
    const isHighRisk = document.getElementById('chkHighRisk').checked;
    state.activeVisit={locationId:s.id, startTime:n, anticipatedDepartureTime:new Date(n.getTime()+state.visitDurationMinutes*60000), fiveMinWarned:false, startGPS: "", highRisk: isHighRisk};
    state.lowBatSent=false; saveState(); enterLockedScreen(); 
    navigator.geolocation.getCurrentPosition((pos) => {if(state.activeVisit) {state.activeVisit.startGPS = `${pos.coords.latitude},${pos.coords.longitude}`;saveState();let notes = "Started";if(isHighRisk) notes += " [ZERO_TOLERANCE]";const payload = {"Alarm Status":s.id==='travel'?"TRAVELLING":"ON SITE","Notes":notes, "Last Known GPS": state.activeVisit.startGPS};processUploadQueue(buildPayload(payload));}}, (err) => { if(state.activeVisit) {let notes = "Started (GPS Timeout)";if(isHighRisk) notes += " [ZERO_TOLERANCE]";const payload = {"Alarm Status":s.id==='travel'?"TRAVELLING":"ON SITE","Notes":notes};processUploadQueue(buildPayload(payload));}}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
}

function warmUpGps() {if(gpsWarm) return; gpsWarm = true; navigator.geolocation.getCurrentPosition(()=>{},()=>{},{enableHighAccuracy:true, timeout:10000, maximumAge:0}); setTimeout(()=> { gpsWarm = false; }, 30000);}

// UPDATED: GPS Logic with Red X and Watchdog
function startGPSMonitoring() {
    if (!('geolocation' in navigator)) return;
    let lastUpdate = 0;
    
    // Watchdog: If no GPS update for 30s, show error
    setInterval(() => {
        if(Date.now() - lastUpdate > 30000) {
            updateGPSUI(-1); // Force error state
        }
    }, 5000);

    const updateGPSUI = (acc) => {
        lastUpdate = Date.now();
        const bars = [document.getElementById('gps1'), document.getElementById('gps2'), document.getElementById('gps3')];
        const err = document.getElementById('gpsError');
        const barContainer = document.getElementById('gpsBars');
        
        bars.forEach(b => b.className = 'gps-bar'); // Reset

        if (acc === -1) {
            // Signal Lost / Error
            barContainer.classList.add('hidden');
            err.classList.remove('hidden');
        } else {
            barContainer.classList.remove('hidden');
            err.classList.add('hidden');
            if(acc <= 20) { bars.forEach(b => b.classList.add('active-green')); }
            else if(acc <= 50) { bars[0].classList.add('active-amber'); bars[1].classList.add('active-amber'); }
            else { bars[0].classList.add('active-red'); }
        }
    };

    gpsWatchId = navigator.geolocation.watchPosition(
        (pos) => { updateGPSUI(pos.coords.accuracy); },
        (err) => { console.warn("GPS Watch Error", err); updateGPSUI(-1); },
        { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
    );
    
    // RESTORED: Battery Watchdog
    if ('getBattery' in navigator) {
        navigator.getBattery().then(function(battery) {
            const updateBat = () => { currentBatteryLevel = Math.round(battery.level * 100) + "%"; };
            updateBat();
            battery.addEventListener('levelchange', updateBat);
        });
    }
}

function enterLockedScreen(){
    const l=state.locations.find(x=>x.id===state.activeVisit.locationId);
    document.getElementById('lockedLocationName').innerText=l.name;
    navigate('locked');
    if(state.activeVisit&&state.activeVisit.isPanic){renderPanicState();}
    else{
        document.getElementById('btnDepart').classList.remove('hidden');
        document.getElementById('btnSafe').classList.add('hidden');
        document.getElementById('btnExtend').classList.remove('hidden');
        document.getElementById('lockedPage').classList.remove('panic-mode');
    }
    timerInt=setInterval(tick,1000);
    setupLongPress(document.getElementById('btnDepart'),()=>preDepart(false));
    setupLongPress(document.getElementById('btnExtend'),()=>showModal('extend')); 
    if(state.activeVisit.highRisk) document.getElementById('highRiskBadge').classList.remove('hidden'); 
    else document.getElementById('highRiskBadge').classList.add('hidden');
}

function tick(){
    if(!state.activeVisit){clearInterval(timerInt);return;}
    const now=new Date().getTime(); const dueTime=new Date(state.activeVisit.anticipatedDepartureTime).getTime(); const remaining=dueTime-now;
    const isZeroTolerance = state.activeVisit.highRisk; const escTime = isZeroTolerance ? 0 : (CONFIG.escalationMinutes||15)*60000; const timeUntilEscalation = remaining + escTime;
    if(timeUntilEscalation <= 0) {
        document.getElementById('overdueLabel').classList.remove('hidden'); document.getElementById('btnDepart').classList.add('hidden'); document.getElementById('btnExtend').classList.add('hidden'); document.getElementById('btnSafe').classList.remove('hidden'); setupLongPress(document.getElementById('btnSafe'), iamSafe);
        document.getElementById('countdownTimer').innerText="ALARM SENT";
        if(!state.activeVisit.criticalSent){state.activeVisit.criticalSent=true; saveState(); const alertMsg = isZeroTolerance ? 'EMERGENCY - ZERO TOLERANCE' : 'EMERGENCY - OVERDUE'; triggerAutoAlert(alertMsg);}
    } else if (remaining <= 0) {
        document.getElementById('overdueLabel').classList.remove('hidden'); document.getElementById('btnDepart').classList.remove('hidden'); document.getElementById('btnExtend').classList.remove('hidden'); document.getElementById('btnSafe').classList.add('hidden');
        const absRem=Math.abs(remaining); const m=Math.floor(absRem/60000),s=Math.floor((absRem%60000)/1000);
        document.getElementById('countdownTimer').innerText=`-${m}:${s<10?'0':''}${s}`; document.getElementById('countdownTimer').classList.add('text-red-500','animate-pulse');
        if(timeUntilEscalation<=300000&&timeUntilEscalation>298000){playSound('warning');navigator.vibrate([500,200,500]);}
        
        // FIXED AUDIO SEQUENCING
        if(timeUntilEscalation<=120000&&timeUntilEscalation>118000){
            playSound('warning');
            navigator.vibrate([1000,500,1000]);
            setTimeout(() => {
                speakWithAccent("Warning. Safety alarm will activate in two minutes.");
            }, 1000); // 1s delay prevents audio overlap
        }
    } else {
        const m=Math.floor(remaining/60000),s=Math.floor((remaining%60000)/1000);
        document.getElementById('countdownTimer').innerText=`${m}:${s<10?'0':''}${s}`; document.getElementById('countdownTimer').classList.remove('text-red-500','animate-pulse'); document.getElementById('overdueLabel').classList.add('hidden');
        if(!state.activeVisit.isPanic) { document.getElementById('btnDepart').classList.remove('hidden'); document.getElementById('btnExtend').classList.remove('hidden'); document.getElementById('btnSafe').classList.add('hidden'); }
        const mRem=Math.floor(remaining/60000);
        if(mRem===5&&!state.activeVisit.fiveMinWarned){state.activeVisit.fiveMinWarned=true; playSound('pre_alert'); document.getElementById('fiveMinBanner').classList.remove('hidden'); setTimeout(()=>document.getElementById('fiveMinBanner').classList.add('hidden'),10000);}
    }
    if(state.activeVisit.anticipatedDepartureTime)document.getElementById('lockedAnticipatedTime').innerText=new Date(state.activeVisit.anticipatedDepartureTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit', hour12:true});
    if(CONFIG.checkinEnabled&&state.activeVisit.nextCheckin&&new Date()>new Date(state.activeVisit.nextCheckin))triggerCheckin();
}

function warmUpSpeech() {
    // Force a silent utterance to unlock the audio context for later
    if('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(" ");
        u.volume = 0;
        window.speechSynthesis.speak(u);
    }
}

function speakWithAccent(msg){
    if(!'speechSynthesis' in window)return;
    window.speechSynthesis.cancel(); // Clear queue first
    const u=new SpeechSynthesisUtterance(msg);
    const v=window.speechSynthesis.getVoices();
    u.voice = v.find(x=>x.lang.includes(CONFIG.voiceLocale)) || v.find(x=>x.lang.includes('en-GB')) || v.find(x=>x.lang.includes('en-US'));
    u.rate = 1.0;
    u.volume = 1.0;
    window.speechSynthesis.speak(u);
}

async function requestWakeLock(){try{wakeLock=await navigator.wakeLock.request('screen');wakeLock.addEventListener('release',()=>{console.log('Lock Released');});}catch(e){console.warn('Wake Lock Error',e);}}

function preDepart(){
    isMidVisitUpdate=false; const l=state.locations.find(x=>x.id===state.activeVisit.locationId); const sg=state.activeVisit.startGPS;
    
    // NEW: Robust Travel Logic
    if(l.id === 'travel'){
        if(l.noReport) { submitReport(); return; }
        document.getElementById('btnDepart').innerText="Calculating...";
        
        // Try Internet-based Distance
        navigator.geolocation.getCurrentPosition(async(pos)=>{ 
            const eg=`${pos.coords.latitude},${pos.coords.longitude}`; 
            
            // Check internet
            if(navigator.onLine) {
                 calculatedDist=await getDistance(sg,eg); 
            } else {
                 // Offline Fallback
                 const d = haversine(sg, eg);
                 calculatedDist = {km: d.toFixed(2), type:'crow', offline: true};
            }
            
            document.getElementById('btnDepart').innerText="HOLD TO END"; 
            loadFormAndShow(l.templateName||"(Standard)"); 
        }, 
        (err) => { 
            // GPS Failed entirely
            alert("GPS Location Failed. Distance cannot be calculated."); 
            calculatedDist = null; 
            document.getElementById('btnDepart').innerText="HOLD TO END"; 
            loadFormAndShow(l.templateName||"(Standard)"); 
        }, 
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    } else if(l.noReport) { 
        submitReport(); 
        return; 
    } else { 
        calculatedDist=null; 
        loadFormAndShow(l.templateName||"(Standard)"); 
    }
}

async function getDistance(p1,p2){if(!p1||!p2)return{km:0,type:'none'};if(CONFIG.orsKey&&CONFIG.orsKey.length>5){try{const u=`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${CONFIG.orsKey}&start=${p1.split(',').reverse().join(',')}&end=${p2.split(',').reverse().join(',')}`;const r=await fetch(u);const j=await r.json();const m=j.features[0].properties.segments[0].distance;return{km:(m/1000).toFixed(2),type:'road'};}catch(e){console.warn("ORS Fail",e);}}const d=haversine(p1,p2);return{km:d.toFixed(2),type:'crow'};}
function haversine(p1,p2){const[la1,lo1]=p1.split(',').map(Number);const[la2,lo2]=p2.split(',').map(Number);const R=6371;const dLa=(la2-la1)*Math.PI/180;const dLo=(lo2-lo1)*Math.PI/180;const a=Math.sin(dLa/2)*Math.sin(dLa/2)+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)*Math.sin(dLo/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}

function loadFormAndShow(t){
    showModal('report'); 
    document.getElementById('reportTitle').innerText=isMidVisitUpdate?"Update: "+t:"Visit Report"; 
    currentActiveTemplate=t; 
    buildReportForm(t,document.getElementById('reportFields'));
    
    if(t === 'Note to Self' && !state.settings.workerEmail) { const warning = document.createElement('div'); warning.className = "bg-red-900 border border-red-500 text-red-200 p-3 rounded mb-4 text-xs"; warning.innerText = "‚ö†Ô∏è WARNING: You have not saved a 'Work Email' in Settings. This note will be saved to the database but cannot be emailed to you."; const fields = document.getElementById('reportFields'); fields.insertBefore(warning, fields.firstChild); }
    
    // UPDATED: Smarter auto-fill logic for Travel
    if(calculatedDist){
        // Try to find ANY distance-like field
        let di = document.querySelector('[data-key*="Distance"]');
        if(!di) di = document.querySelector('[data-key*="KM"]');
        if(!di) di = document.querySelector('[data-key*="Mileage"]');
        
        if(di){
            di.value = calculatedDist.km;
            di.style.border = "2px solid #4ade80"; // Visual cue
            di.classList.add("bg-green-900/20");
        }
        
        // Append warning to notes if offline/crow-flies
        if(calculatedDist.type==='crow' || calculatedDist.offline){
            const ni = document.getElementById('rep_notes') || document.querySelector('[data-key="Notes"]');
            if(ni){
                ni.value = (ni.value + " [‚ö†Ô∏è Distance calculated 'as the crow flies' due to connection issues]").trim();
            }
        }
    }
    
    const b=document.getElementById('btnSubmitRep');
    const nb=b.cloneNode(true);
    b.parentNode.replaceChild(nb,b);
    if(!state.activeVisit){nb.innerText="SUBMIT REPORT";nb.classList.remove('long-press-btn');nb.classList.add('bg-blue-600','hover:bg-blue-500');nb.onclick=submitReport;}else if(isMidVisitUpdate){nb.innerText="Send Update";nb.classList.remove('long-press-btn');nb.onclick=submitReport;}else{nb.innerText="HOLD TO SUBMIT & END";nb.classList.add('long-press-btn');setupLongPress(nb,submitReport);}
}

// UPDATED: Photo Token Logic
function submitReport(){
    if(currentActiveTemplate === 'Note to Self' && !state.settings.workerEmail) { if(!confirm("‚ö†Ô∏è NO EMAIL ADDRESS FOUND\n\nYou have not entered a 'Work Email' in settings. This note will be saved to the database, but you will NOT receive a copy.\n\nContinue anyway?")) { return; } }
    
    const d=gatherFormData();
    
    // Inject Photo Tokens into the JSON payload
    // If we have state.photoStore['Photo for Q1'], we find the key "Q1" in custom and replace it with "{{PHOTO_1}}"
    let photoCount = 0;
    const photoMap = {};
    
    Object.keys(state.photoStore).forEach((key, index) => {
        photoCount++;
        const token = `{{PHOTO_${photoCount}}}`;
        photoMap[`Photo ${photoCount}`] = state.photoStore[key]; // Store blob for upload
        
        // Update the textual answer to be the token
        if(d.custom[key] !== undefined) {
             d.custom[key] = token;
             d.jsonPayload[key] = token;
        }
    });

    const fd={...d.custom,"Visit Report Data":JSON.stringify(d.jsonPayload),"Template Name":currentActiveTemplate};
    if(d.custom&&d.custom["Distance (km)"])fd["Distance"]=d.custom["Distance (km)"];
    
    // Add photos to payload
    Object.entries(photoMap).forEach(([k, v]) => {
        fd[k] = v;
    });

    if(d.sig)fd["Signature"]=d.sig;
    
    if(!state.activeVisit){processUploadQueue(buildPayload({...fd,"Alarm Status":"DATA_ENTRY_ONLY","Notes":d.notes,"Worker Email":state.settings.workerEmail}));showToast("Report Sent Successfully");closeModal('report');return;}if(isMidVisitUpdate){let s="ON SITE";if(state.activeVisit.locationId==='travel')s="TRAVELLING";processUploadQueue(buildPayload({...fd,"Alarm Status":s,"Notes":d.notes,"Worker Email":state.settings.workerEmail}));showToast("Update Sent");isMidVisitUpdate=false;closeModal('report');return;}processUploadQueue(buildPayload({...fd,"Alarm Status":"DEPARTED","Notes":d.notes,"Worker Email":state.settings.workerEmail}));if(navigator.onLine)showToast("‚úÖ Sent");else showToast("üíæ Saved to Outbox");state.activeVisit=null;state.photoStore={};state.visitDurationMinutes=0;isMidVisitUpdate=false;
    document.getElementById('chkHighRisk').checked = false; document.getElementById('highRiskBadge').classList.add('hidden');
    saveState();closeModal('report');navigate('main');playSound('depart');if(travellingInterval)clearInterval(travellingInterval);checkVehicleStatus();
}

function gatherFormData(){const d={custom:{},notes:'',sig:null,jsonPayload:{}};const sn=document.getElementById('rep_notes');if(sn)d.notes=sn.value;document.querySelectorAll('[data-key]').forEach(el=>{const k=el.getAttribute('data-key');let v=el.value;if(el.type==='checkbox')v=el.checked?'Yes':'No';else if(el.type==='radio'){if(!el.checked)return;v=el.value;}d.custom[k]=v;d.jsonPayload[k]=v;});const c=document.getElementById('sig-canvas');if(c)d.sig=c.toDataURL('image/png');return d;}
function handlePhoto(i,k){if(i.files[0]){const b=i.nextElementSibling;if(b)b.innerText="Compressing...";compressImg(i.files[0]).then(b64=>{state.photoStore[k]=b64;if(b)b.innerText="Photo Saved ‚úÖ";});}}
function compressImg(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');const s=Math.min(600/i.width,600/i.height,1);c.width=i.width*s;c.height=i.height*s;c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.4));};i.src=e.target.result;};rd.readAsDataURL(f);});}
function initSigPad(c){const ctx=c.getContext('2d');ctx.lineWidth=2;ctx.strokeStyle="#000";let d=false;const g=e=>{const r=c.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};};const s=e=>{d=true;ctx.beginPath();const{x,y}=g(e);ctx.moveTo(x,y);};const m=e=>{if(!d)return;e.preventDefault();const{x,y}=g(e);ctx.lineTo(x,y);ctx.stroke();};const n=()=>{d=false;};c.addEventListener('mousedown',s);c.addEventListener('mousemove',m);c.addEventListener('mouseup',n);c.addEventListener('touchstart',s);c.addEventListener('touchmove',m);c.addEventListener('touchend',n);}
function clearSig(){const c=document.getElementById('sig-canvas');if(c)c.getContext('2d').clearRect(0,0,c.width,c.height);}
function triggerAutoAlert(s){const sel=state.locations.find(l=>l.id===state.activeVisit.locationId);const ln=sel?(sel.companyName?`${sel.companyName} - ${sel.name}`:sel.name):"Unknown";navigator.geolocation.getCurrentPosition(p=>{processUploadQueue(buildPayload({"Alarm Status":s,"Notes":"Automated System Alert","Location Name":ln,"Last Known GPS":`${p.coords.latitude},${p.coords.longitude}`}));},()=>{processUploadQueue(buildPayload({"Alarm Status":s,"Notes":"Automated System Alert (GPS Fail)","Location Name":ln}));});}
function startReminderTimer(){clearTimeout(mainScreenReminderTimer);document.getElementById('startReminderBanner').classList.add('hidden');mainScreenReminderTimer=setTimeout(()=>{if(!state.activeVisit&&document.getElementById('mainPage').classList.contains('active')){document.getElementById('startReminderBanner').classList.remove('hidden');}},300000);}
function triggerCheckin(){if(!document.getElementById('checkinModal').classList.contains('hidden'))return;showModal('checkin');document.getElementById('batterySaver').classList.add('hidden');let rem=120;const el=document.getElementById('checkinCountdown');if(checkinIntervalId)clearInterval(checkinIntervalId);playSound('checkin');const btn=document.getElementById('btnCheckinConfirm');const newBtn=btn.cloneNode(true);btn.parentNode.replaceChild(newBtn,btn);setupLongPress(newBtn,confirmCheckin);checkinIntervalId=setInterval(()=>{rem--;const m=Math.floor(rem/60);const s=rem%60;el.innerText=`${m}:${s<10?'0':''}${s}`;if(rem===60||rem===30||rem===10)playSound('checkin');if(rem<=0){clearInterval(checkinIntervalId);closeModal('checkin');processUploadQueue(buildPayload({"Alarm Status":'MISSED_CHECKIN',"Notes":"Worker failed to respond to check-in"}));showToast('MISSED CHECK-IN ALERT SENT');}},1000);}
function confirmCheckin(){clearInterval(checkinIntervalId);closeModal('checkin');state.activeVisit.nextCheckin=new Date(Date.now()+CONFIG.checkinInterval*60000);saveState();}
function confirmExtension(m){const p=()=>{state.activeVisit.anticipatedDepartureTime=new Date(new Date(state.activeVisit.anticipatedDepartureTime).getTime()+m*60000);saveState();playSound('extend');processUploadQueue(buildPayload({"Alarm Status":'EXTENDED',"Notes":"Extended "+m+"m"}));};const n=new Date(),d=new Date(state.activeVisit.anticipatedDepartureTime);closeModal('extend');if((d-n)<0||state.activeVisit.isPanic)withPinVerification(false,p);else p();}
function handlePanicTap(){const n=Date.now();if(n-panicTapTimer>2000)panicTapCount=0;panicTapCount++;panicTapTimer=n;if(panicTapCount>=3){triggerPanic();panicTapCount=0;}}
function triggerPanic(){state.activeVisit=state.activeVisit||{};state.activeVisit.isPanic=true;saveState();renderPanicState();playSound('panic');processUploadQueue(buildPayload({"Alarm Status":'EMERGENCY - PANIC BUTTON',"Notes":"Panic Button Pressed"}));setTimeout(()=>showToast('üö® SOS SENT üö®'),100);}
function renderPanicState(){document.getElementById('lockedPage').classList.add('panic-mode');document.getElementById('btnDepart').classList.add('hidden');document.getElementById('btnExtend').classList.add('hidden');document.getElementById('btnSafe').classList.remove('hidden');setupLongPress(document.getElementById('btnSafe'),iamSafe);}
function iamSafe(){withPinVerification(false,()=>{playSound('safe');processUploadQueue(buildPayload({"Alarm Status":'SAFE - MANUALLY CLEARED',"Notes":"Worker confirmed safe"}));state.activeVisit.isPanic=false;document.getElementById('lockedPage').classList.remove('panic-mode');document.getElementById('btnSafe').classList.add('hidden');document.getElementById('btnDepart').classList.remove('hidden');document.getElementById('btnExtend').classList.remove('hidden');preDepart(true);});}
function startTravellingPulse(){toggleBatterySaver();travellingInterval=setInterval(()=>{navigator.geolocation.getCurrentPosition(p=>{processUploadQueue(buildPayload({"Alarm Status":"TRAVELLING","Last Known GPS":`${p.coords.latitude},${p.coords.longitude}`}));})},300000);}
function toggleBatterySaver(){document.getElementById('batterySaver').classList.toggle('hidden');}
function buildPayload(d){let dt="";let ln="Unknown";let la="";if(state.activeVisit){if(state.activeVisit.anticipatedDepartureTime)dt=new Date(state.activeVisit.anticipatedDepartureTime).toISOString();const l=state.locations.find(x=>x.id===state.activeVisit.locationId);if(l){ln=l.companyName?`${l.companyName} - ${l.name}`:l.name;la=l.address;}}else if(state.selectedLocationId){const l=state.locations.find(x=>x.id===state.selectedLocationId);if(l){ln=l.companyName?`${l.companyName} - ${l.name}`:l.name;la=l.address;}}let gps=d['Last Known GPS']||"";if(!gps&&state.activeVisit&&state.activeVisit.startGPS){gps=state.activeVisit.startGPS;}return{'key':CONFIG.key,'Worker Name':state.settings.workerName,'Worker Phone Number':state.settings.workerPhone,'Emergency Contact Name':state.settings.emergencyName,'Emergency Contact Number':state.settings.emergencyPhone,'Emergency Contact Email':state.settings.emergencyEmail,'Escalation Contact Name':state.settings.escalationName,'Escalation Contact Number':state.settings.escalationPhone,'Escalation Contact Email':state.settings.escalationEmail,'Battery Level':currentBatteryLevel,'Location Name':ln,'Location Address':la,'Anticipated Departure Time':dt,'Timestamp':new Date().toISOString(),deviceId:getDeviceID(),'Worker Email':state.settings.workerEmail,'Last Known GPS':gps,...d};}
function processUploadQueue(d){if(d)state.pendingUploads.push(d);if(navigator.onLine&&state.pendingUploads.length){const fd=new FormData();for(let k in state.pendingUploads[0])fd.append(k,state.pendingUploads[0][k]);fetch(CONFIG.url,{method:'POST',mode:'no-cors',body:fd}).then(()=>{state.pendingUploads.shift();saveState();processUploadQueue();});}saveState();}
function setupLongPress(btn,cb){let t;const start=(e)=>{e.preventDefault();btn.classList.add('pressing');t=setTimeout(()=>{cb();btn.classList.remove('pressing');},1500);};const cancel=(e)=>{clearTimeout(t);btn.classList.remove('pressing');};btn.onmousedown=btn.ontouchstart=start;btn.onmouseup=btn.ontouchend=btn.onmouseleave=cancel;}
function withPinVerification(d,c){showModal('pin');const i=document.getElementById('pinInput');i.value='';i.focus();const cf=()=>{const v=i.value;closeModal('pin');if(v===state.settings.pinCode)c();else if(v===state.settings.duressPin){processUploadQueue(buildPayload({"Alarm Status":"DURESS_CODE_ACTIVATED","Notes":"Silent Alarm"}));if(d)c();else showToast("PIN Accepted");}else showToast("Incorrect PIN");document.getElementById('confirmPinBtn').removeEventListener('click',cf);};document.getElementById('confirmPinBtn').addEventListener('click',cf);document.getElementById('cancelPinBtn').onclick=()=>closeModal('pin');}
function clearData(){if(confirm('Reset all data?')){localStorage.clear();location.reload();}}
function clearFormsCache(){state.cachedForms={};state.globalForms=[];syncForms();showToast("Forms Syncing...");}
function syncForms(){if(!CONFIG.url)return;fetch(`${CONFIG.url}?action=getGlobalForms`).then(r=>r.json()).then(j=>{if(Array.isArray(j)){state.globalForms=j;saveState();}});}
async function initAudio(){if(!synth){await Tone.start();synth=new Tone.Synth().toDestination();}}
function playSound(t){initAudio().then(()=>{const n=Tone.now();if(t==='arrive')synth.triggerAttackRelease("C4","8n",n);if(t==='pre_alert'){synth.triggerAttackRelease("C6","8n",n);navigator.vibrate([1000,500,1000]);}if(t==='depart')synth.triggerAttackRelease("G4","8n",n);if(t==='warning')synth.triggerAttackRelease("E5","16n",n);if(t==='panic')synth.triggerAttackRelease("G5","16n",n);});}
function captureGPS(btn){btn.innerText="Locating...";navigator.geolocation.getCurrentPosition(p=>{btn.innerText="‚úÖ "+p.coords.latitude+","+p.coords.longitude;btn.nextElementSibling.value=p.coords.latitude+","+p.coords.longitude;});}
function buildReportForm(n,c){
    state.photoStore={};
    const sn=n?n.trim():"Standard Visit Note";
    let t=null;
    if(state.globalForms)t=state.globalForms.find(f=>f.name.trim()===sn)?.questions;
    if(!t&&state.cachedForms)t=state.cachedForms[sn];
    if(!t)t=state.cachedForms["(Standard)"];
    if(!t){console.warn("Template not found:",sn);t=[{type:'note',text:'Standard Check-in (Default)'},{type:'text',text:'Notes'}];}
    
    c.innerHTML='';
    if(t.length===0){
        c.innerHTML='<label class="block text-sm text-gray-400">Notes</label><textarea id="rep_notes" class="form-input h-32"></textarea>';
    } else {
        t.forEach((f,i)=>{
            let y='check'; 
            let x=f.text||f;
            
            // UPDATED: PARSE FORM SYNTAX (Added [CHECK])
            if(typeof f==='string'){
                if(f.trim().startsWith('#')) { y='header'; x=f.replace(/^#\s*/, '').trim(); }
                else if(f.trim().startsWith('%')) { y='text'; x=f.replace(/^%\s*/, '').trim(); }
                else if(f.trim().startsWith('$')) { y='number'; x=f.replace(/^\$\s*/, '').trim(); }
                else if(f.includes('[TEXT]')){y='text';x=f.replace('[TEXT]','').trim();}
                else if(f.includes('[PHOTO]')){y='photo';x=f.replace('[PHOTO]','').trim();}
                else if(f.includes('[YESNO]')){y='yesno';x=f.replace('[YESNO]','').trim();}
                else if(f.includes('[CHECK]')){y='checkbox';x=f.replace('[CHECK]','').trim();} // NEW
                else if(f.includes('[NUMBER]')){y='number';x=f.replace('[NUMBER]','').trim();}
                else if(f.includes('$')){y='number';x=f.replace('$','').trim();}
                else if(f.includes('[GPS]')){y='gps';x=f.replace('[GPS]','').trim();}
                else if(f.includes('[HEADING]')){y='header';x=f.replace('[HEADING]','').trim();}
                else if(f.includes('[NOTE]')){y='note';x=f.replace('[NOTE]','').trim();}
                else if(f.includes('[SIGN]')){y='signature';x=f.replace('[SIGN]','').trim();}
                else if(f.includes('[DATE]')){y='date';x=f.replace('[DATE]','').trim();}
                else { y='input'; } // Default Text Input
            }
            
            let h='';
            if(y==='header') h=`<h3 class="text-blue-400 font-bold mt-6 mb-2 border-b border-gray-700 pb-1">${x}</h3>`;
            else if(y==='note') h=`<p class="text-gray-500 text-sm italic my-2">${x}</p>`;
            else if(y!=='checkbox') h=`<div><label class="block text-xs uppercase font-bold text-gray-500 mb-1">${x}</label>`; // Standard label for inputs
            
            if(y==='text') h+=`<textarea data-key="${x}" class="form-input h-24"></textarea>`;
            else if(y==='number') h+=`<input type="number" data-key="${x}" class="form-input font-mono text-blue-400 font-bold" placeholder="0">`;
            else if(y==='date') h+=`<input type="date" data-key="${x}" class="form-input">`;
            else if(y==='yesno') h+=`<div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="${x}" value="Yes" data-key="${x}" class="w-5 h-5 text-blue-600"> Yes</label><label class="flex items-center gap-2"><input type="radio" name="${x}" value="No" data-key="${x}" class="w-5 h-5 text-blue-600"> No</label></div>`;
            else if(y==='checkbox') h+=`<div class="flex items-center gap-3 p-3 bg-gray-800 rounded border border-gray-600 mb-3 shadow-sm active:bg-gray-700 transition"><input type="checkbox" data-key="${x}" class="w-6 h-6 text-blue-600 rounded bg-gray-700 border-gray-500 focus:ring-blue-500"> <label class="text-sm font-bold text-gray-200 select-none flex-1">${x}</label></div>`;
            else if(y==='photo') h+=`<div><input type="file" accept="image/*" capture="environment" onchange="handlePhoto(this,'${x}')" class="hidden" id="cam_${i}"><button onclick="document.getElementById('cam_${i}').click()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded text-sm font-bold text-gray-300 border border-dashed border-gray-500">üì∑ Add Photo</button></div>`;
            else if(y==='signature') h+=`<div class="border border-gray-600 rounded bg-white"><canvas id="sig-canvas" width="300" height="150" class="w-full touch-none"></canvas><button onclick="clearSig()" class="w-full py-1 bg-gray-200 text-gray-600 text-xs font-bold border-t border-gray-300">Clear Signature</button></div><script>setTimeout(()=>initSigPad(document.getElementById('sig-canvas')),500);<\/script>`;
            else if(y==='gps') h+=`<div class="flex gap-2"><button onclick="captureGPS(this)" class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold shadow">üìç Capture GPS</button><input readonly data-key="${x}" class="flex-1 bg-gray-900 border border-gray-700 rounded px-2 text-xs text-gray-400"></div>`;
            else if(y==='input') h+=`<input type="text" data-key="${x}" class="form-input">`; 
            
            if(y!=='header'&&y!=='note'&&y!=='checkbox') h+='</div>';
            c.innerHTML+=h;
        });
    }
}
// INITIALIZATION
window.addEventListener('load', () => {
    initLocations();
    const labels = document.querySelectorAll('.dynamic-wof');
    if(CONFIG.vehicleTerm) labels.forEach(l => l.innerText = CONFIG.vehicleTerm);
    
    try {
        const saved = localStorage.getItem('loneWorkerState');
        if(saved) state = JSON.parse(saved);
    } catch(e) { console.error(e); }

    if(!state.settings || !state.settings.workerName) {
        startWizard();
    } else {
        if(state.activeVisit) enterLockedScreen();
        else navigate('main');
        if(navigator.onLine) forceSync();
    }
    renderLocations();
    checkVehicleStatus();
    startGPSMonitoring();
    
    // PWA & INSTALL LOGIC
    document.body.addEventListener('click',initAudio,{once:true});
    startReminderTimer();
    document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'&&state.activeVisit)requestWakeLock();});
    if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(e=>console.warn('SW Fail',e));
    checkIosInstall();
});

// PWA INSTALL LOGIC
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if(!localStorage.getItem('otg_install_dismissed')) {
      document.getElementById('installBanner').classList.remove('hidden');
  }
  document.getElementById('installAppContainer').classList.remove('hidden');
  
  // Settings Button Listener
  document.getElementById('btnInstallApp').addEventListener('click', () => {
    document.getElementById('installAppContainer').classList.add('hidden');
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((c) => { deferredPrompt = null; });
  });
});

function triggerInstall() {
    if(deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((c) => { deferredPrompt = null; });
        document.getElementById('installBanner').classList.add('hidden');
    }
}

function dismissInstall(type) {
    if(type==='android') document.getElementById('installBanner').classList.add('hidden');
    if(type==='ios') document.getElementById('iosInstallModal').classList.add('hidden');
    localStorage.setItem('otg_install_dismissed', 'true');
}

function checkIosInstall() {
  const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
  const isStandalone = window.navigator.standalone === true;
  if (isIos && !isStandalone && !localStorage.getItem('otg_install_dismissed')) {
      document.getElementById('iosInstallModal').classList.remove('hidden');
  }
}
</script>
</body>
</html>
