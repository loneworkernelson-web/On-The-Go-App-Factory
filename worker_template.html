<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>%%ORG_NAME%%</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
/* --- CORE STYLES --- */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: #111827; color: white; }
.page { display: none; height: 100%; flex-direction: column; }
.page.active { display: flex; }

/* --- INTERACTIVE ELEMENTS --- */
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width 1.5s linear; }
.long-press-btn.pressing::after { width: 100%; }

.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }

.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }

/* --- SETTINGS CARDS --- */
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.form-input-card { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.5rem; display: block; }
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }
</style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

<div id="app-container" class="h-full flex flex-col">

<div id="mainPage" class="page active p-4 bg-gray-800">
    <header class="flex justify-between items-center mb-4 flex-shrink-0">
        <div class="flex items-center gap-2">
            <img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'">
            <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="showModal('info')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚ÑπÔ∏è</button>
            <button onclick="navigate('settings')" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="startReminderBanner" class="hidden bg-yellow-600/20 border border-yellow-500 text-yellow-200 text-xs rounded p-2 mb-2 text-center">
        Reminder: Don't forget to start your timer when you arrive.
    </div>
    
    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 flex-shrink-0">
        <div class="spinner"></div> 
        <span>Syncing <span id="queueCount">0</span> offline reports...</span>
    </div>

    <div class="flex-1 overflow-y-auto mb-4 rounded-lg min-h-0">
        <div id="locationList" class="space-y-3"></div>
        <button onclick="openLocModal()" class="mt-4 w-full py-4 border-2 border-dashed border-gray-600 text-gray-400 rounded-xl hover:border-gray-500 hover:text-white transition font-bold">+ Add Location</button>
        <button onclick="forceSync()" class="mt-2 w-full py-4 bg-gray-700 text-blue-300 font-bold rounded-xl shadow-lg border border-gray-600">‚Üª Sync Assigned Sites</button>
    </div>

    <div class="mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700 flex-shrink-0">
        <div class="flex justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase font-bold">Duration</span>
            <span id="durationDisplay" class="font-bold text-blue-400">0 mins</span>
        </div>
        <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateArrivedButtonState()">
    </div>

    <div class="flex gap-2 flex-shrink-0">
        <button id="btnQuick" onclick="quickStat()" class="hidden flex-1 py-5 bg-teal-900 text-teal-500 font-bold rounded-xl text-lg opacity-50 transition" disabled>Quick Stat</button>
        <button type="button" id="btnStart" class="long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all" disabled>Select Location</button>
    </div>
</div>

<div id="lockedPage" class="page p-6 text-center justify-between bg-gray-900 relative">
    <div id="fiveMinBanner" class="hidden absolute top-0 left-0 w-full bg-yellow-600 text-white font-bold py-3 animate-pulse z-50 shadow-xl border-b-4 border-yellow-400">
        ‚ö†Ô∏è 5 MINUTES REMAINING - EXTEND NOW
    </div>

    <div class="flex justify-between items-start mt-8">
        <button onclick="toggleBatterySaver()" class="p-2 bg-gray-800 rounded-full text-yellow-400 border border-gray-600 hover:bg-gray-700">üåô</button>
        <button onclick="handlePanicTap()" id="btnPanic" class="w-24 h-24 bg-red-600 rounded-full font-bold text-white text-2xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center select-none">SOS</button>
    </div>
    
    <div>
        <p class="text-gray-500 text-sm uppercase tracking-widest">Currently At</p>
        <h2 id="lockedLocationName" class="text-3xl font-bold text-white mb-6 mt-1 truncate px-2"></h2>
        <div id="countdownTimer" class="text-7xl font-bold font-mono text-white tracking-tighter">00:00</div>
        <p class="text-gray-400 mt-2">Due: <span id="lockedAnticipatedTime" class="text-blue-400 font-bold"></span></p>
    </div>

    <div class="space-y-3 w-full">
        <button id="btnExtend" class="long-press-btn w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Extend Time</button>
        <button onclick="openMidVisitMenu()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl text-lg shadow-lg">üìù Add Notes / Checklist</button>
        <button id="btnDepart" class="long-press-btn w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl text-lg shadow-lg">HOLD TO END</button>
        <button id="btnSafe" class="hidden long-press-btn w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">I AM SAFE</button>
    </div>

    <div id="batterySaver" class="hidden absolute inset-0 bg-black z-50 flex items-center justify-center flex-col cursor-pointer" onclick="toggleBatterySaver()">
        <div class="text-gray-600 text-sm mb-4">Tap to wake</div>
        <div class="text-gray-800 font-mono text-xl animate-pulse" id="saverClock">00:00</div>
    </div>
</div>

<div id="settingsPage" class="page p-4 bg-gray-800">
    <header class="flex justify-between mb-4 flex-shrink-0 items-center">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button id="btnCloseSettings" onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white">√ó</button>
    </header>
    
    <div class="flex-1 overflow-y-auto pb-4">
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4">
            <p class="text-xs text-blue-200">Enter your name EXACTLY as shown in the system to sync your sites.</p>
        </div>

        <div id="installAppContainer" class="hidden mb-4">
            <button id="btnInstallApp" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">üì≤ Install App to Home Screen</button>
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-blue">Your Details</label>
            <input id="set_name" class="form-input-card" placeholder="Full Name (Exact Match)">
            <input id="set_phone" type="tel" class="form-input-card" placeholder="Phone (+64...)">
        </div>

        <div class="setting-card">
            <label class="setting-label lbl-red">Security (4 Digits)</label>
            <div class="flex gap-2">
                <input id="set_pin" type="tel" maxlength="4" class="form-input text-center tracking-widest" placeholder="PIN">
                <input id="set_duress" type="tel" maxlength="4" class="form-input text-center tracking-widest" placeholder="Duress">
            </div>
        </div>
        
        <div class="setting-card border-gray-600">
            <label class="setting-label lbl-gray">System Actions</label>
            <div class="flex gap-2 mt-2">
                <button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white">Reset Cache</button>
                <button onclick="clearData()" class="flex-1 bg-red-900/50 text-red-400 hover:bg-red-900/70 py-2 rounded text-xs font-bold">Reset App</button>
            </div>
        </div>
    </div>
    
    <button onclick="saveSettings()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg mb-2 flex-shrink-0">Save & Sync</button>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
    
    <div id="locationModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
        <h2 id="locModalTitle" class="text-xl font-bold mb-4 text-white">Edit Location</h2>
        <input type="hidden" id="locId">
        <div class="space-y-4">
            <div><label class="text-xs text-gray-400 uppercase font-bold">Business Name</label><input type="text" id="locBusiness" class="form-input" placeholder="e.g. Acme Corp"></div>
            <div><label class="text-xs text-gray-400 uppercase font-bold">Site Name</label><input type="text" id="locName" class="form-input" placeholder="e.g. Head Office"></div>
            
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold">Address</label>
                <div class="flex gap-2">
                    <input type="text" id="locAddr" class="form-input mb-0 flex-1">
                    <button onclick="getGpsAddress()" id="btnGpsAddr" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-lg font-bold text-xs shrink-0 shadow-lg">üìç GPS</button>
                </div>
            </div>
            
            <div id="advLocOptions" class="pt-2 border-t border-gray-700">
               <div class="mb-3 bg-gray-900 p-2 rounded">
                   <label class="text-xs text-gray-400 uppercase font-bold block mb-2">Report Required on Departure?</label>
                   <div class="flex gap-6">
                       <label class="flex items-center gap-2 cursor-pointer">
                           <input type="radio" name="reportReq" id="radRepYes" class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-500 focus:ring-blue-500">
                           <span class="text-sm text-white font-bold">Yes</span>
                       </label>
                       <label class="flex items-center gap-2 cursor-pointer">
                           <input type="radio" name="reportReq" id="radRepNo" class="w-5 h-5 text-red-500 bg-gray-700 border-gray-500 focus:ring-red-500">
                           <span class="text-sm text-gray-300">No</span>
                       </label>
                   </div>
               </div>
               <div><label class="text-xs text-gray-400 uppercase font-bold">Template Name</label><input type="text" id="locTemplate" class="form-input text-sm" placeholder="(Standard)"><p class="text-xs text-gray-500 mt-1">Must match 'Checklists' sheet.</p></div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="deleteLoc()" id="btnDelLoc" class="bg-red-900/50 text-red-400 font-bold py-2 px-4 rounded-lg hidden">Delete</button>
            <div class="flex-1"></div>
            <button onclick="closeModal('location')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button onclick="saveLoc()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
        </div>
    </div>
    
    <div id="infoModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <h2 id="infoTitle" class="text-xl font-bold text-white mb-2">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm space-y-2 mb-4"></div>
        
        <div class="flex gap-2 mb-4">
            <a id="btnSiteCall" href="#" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded text-center font-bold hidden">üìû Call</a>
            <a id="btnSiteEmail" href="#" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded text-center font-bold hidden">‚úâÔ∏è Email</a>
        </div>

        <button onclick="closeModal('info')" class="w-full py-3 bg-gray-600 text-white font-bold rounded">Close</button>
    </div>

    <div id="extendModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 class="text-xl font-bold mb-6 text-white">Extend Visit</h2>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="confirmExtension(10)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+10m</button>
            <button onclick="confirmExtension(15)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+15m</button>
            <button onclick="confirmExtension(30)" class="py-4 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow">+30m</button>
        </div>
        <button onclick="closeModal('extend')" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-gray-300">Cancel</button>
    </div>

    <div id="pinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6 text-center">
         <h2 class="text-xl font-bold mb-4 text-white">Enter PIN</h2>
         <input type="password" id="pinInput" maxlength="4" class="text-center text-3xl tracking-[1em] w-48 mx-auto bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-blue-500" inputmode="numeric">
         <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelPinBtn" onclick="closeModal('pin')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button id="confirmPinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
         </div>
    </div>

    <div id="templateModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 class="text-xl font-bold mb-4 text-white">Select Report Type</h2>
        <div id="templateList" class="space-y-3 overflow-y-auto max-h-64"></div>
        <button onclick="closeModal('template')" class="mt-4 w-full py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold text-white">Cancel</button>
    </div>

    <div id="checkinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center border-4 border-yellow-500">
        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Are you OK?</h2>
        <p class="text-lg text-gray-300 mb-4">Scheduled safety check.</p>
        <div id="checkinCountdown" class="text-6xl font-bold text-yellow-400 mb-6 font-mono">2:00</div>
        <button id="btnCheckinConfirm" class="long-press-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">HOLD TO CONFIRM OK</button>
    </div>

    <div id="modal-report" class="hidden bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl">
      <h2 class="text-2xl font-bold text-white mb-6 flex-shrink-0" id="reportTitle">Visit Report</h2>
      <div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2">
        </div>
      <div class="flex gap-3 flex-shrink-0">
        <button onclick="closeModal('report')" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button>
        <button id="btnSubmitRep" class="long-press-btn flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit & END</button>
      </div>
    </div>

    <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="alertModalTitle" class="text-xl font-bold mb-2 text-white">Alert</h2>
        <p id="alertModalMessage" class="text-gray-300 mb-6"></p>
        <button onclick="closeModal('alert')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button>
    </div>

</div>
</div>

<script>
// ==================== CONFIGURATION ====================
const CONFIG = { 
    isAdv: %%IS_ADVANCED%%, 
    mileage: %%ENABLE_MILEAGE%%, 
    url: "%%GOOGLE_SHEET_URL%%", 
    org: "%%ORGANISATION_NAME%%", 
    checkinEnabled: %%CHECKIN_ENABLED%%,   
    checkinInterval: %%CHECKIN_INTERVAL%%,
    escalationMinutes: %%ESCALATION_MINUTES%%, 
    key: "%%SECRET_KEY%%",
    orsKey: "%%ORS_API_KEY%%"
}; 
const DURATION_MAP = [0, 10, 20, 30, 45, 60, 75, 90, 105, 120, 150, 180, 210, 240, 270, 300, 360, 420, 480, 540, 600, 660, 720];

// ==================== STATE MANAGEMENT ====================
let state = { 
    settings: {}, 
    locations: [], 
    selectedLocationId: null, 
    visitDurationMinutes: 0, 
    activeVisit: null, 
    cachedForms: {}, 
    pendingUploads: [], 
    globalForms: [], 
    photoStore: {}, 
    lowBatSent: false 
};

// Globals
let synth, checkinIntervalId, mainScreenReminderTimer, wakeLock, timerInt, travellingInterval;
let tempPhoto = null, sigPad = null, panicTapCount = 0, panicTapTimer;
let deferredPrompt, isMidVisitUpdate = false, currentActiveTemplate = "", currentBatteryLevel = ""; 

// ==================== INITIALIZATION ====================
window.addEventListener('load', () => {
    // Restore State
    const s = localStorage.getItem('loneWorkerState');
    if(s) { try { state = { ...state, ...JSON.parse(s) }; } catch(e){ console.error("State Error", e); } }
    if(!state.photoStore) state.photoStore = {};
    if(!state.globalForms) state.globalForms = [];
    state.settings.googleSheetUrl = CONFIG.url; 
    
    // Resume Travelling Pulse if active
    if(state.activeVisit && state.activeVisit.locationId === 'travel') startTravellingPulse();

    // Init Battery Monitoring (Dying Breath)
    if(navigator.getBattery) {
        navigator.getBattery().then(b => {
            const upd = () => { 
                currentBatteryLevel = Math.round(b.level * 100) + "%"; 
                // Dying Breath Logic: < 10%
                if (b.level < 0.10 && !state.lowBatSent && state.activeVisit) {
                     state.lowBatSent = true; saveState();
                     processUploadQueue(buildPayload({ "Alarm Status": "BATTERY CRITICAL (10%)", "Notes": "Automated Low Battery Alert" }));
                }
            };
            upd(); b.addEventListener('levelchange', upd);
        });
    }

    initLocations();
    if(CONFIG.isAdv) { 
        document.getElementById('btnQuick').classList.remove('hidden'); 
        syncForms(); // Fetch templates
    }

    // Routing
    if(!state.settings.pinCode || !state.settings.workerName) { 
        navigate('settings'); 
        document.getElementById('btnCloseSettings').style.display = 'none'; 
    } 
    else if(state.activeVisit) { enterLockedScreen(); } 
    else { navigate('main'); renderLocations(); }
    
    updateArrivedButtonState(); 
    processUploadQueue(); 
    document.body.addEventListener('click', initAudio, { once: true }); 
    startReminderTimer();
    
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && state.activeVisit) requestWakeLock(); });
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW Fail', err));
});

// ==================== SYNC LOGIC (SMART ALLOCATION) ====================
function forceSync(){
    if(!state.settings.workerName) return alert("Please enter your name in Settings first.");
    document.getElementById('uploadBanner').classList.remove('hidden');
    
    fetch(`${CONFIG.url}?action=sync&worker=${encodeURIComponent(state.settings.workerName)}&key=${CONFIG.key}`)
    .then(r=>r.json()).then(data=>{
        // 1. Process Sites
        const managedSites = data.sites.map(s=>({
            id: 'site_' + s.siteName.replace(/\s/g,''),
            name: s.siteName,
            address: s.address,
            companyName: s.company,
            templateName: s.template,
            noReport: false,
            contactName: s.contactName,
            contactPhone: s.contactPhone,
            contactEmail: s.contactEmail,
            notes: s.notes
        }));
        
        // 2. Keep "Travel" if enabled
        if(CONFIG.mileage) {
            managedSites.unshift({id:'travel', name:'Travelling', address:'Calculates Mileage via GPS', noReport:false, companyName:'Internal', templateName:'Travel Report'});
        }
        
        state.locations = managedSites;
        
        // 3. Process Forms
        state.globalForms = data.forms || [];
        state.cachedForms = data.cachedTemplates || {};
        
        saveState(); renderLocations();
        document.getElementById('uploadBanner').classList.add('hidden'); 
        alert("Sync Complete! Loaded " + managedSites.length + " sites.");
    }).catch(e=>{ 
        document.getElementById('uploadBanner').classList.add('hidden'); 
        alert("Sync Failed: " + e); 
    });
}

// ==================== NAVIGATION & STATE ====================
function navigate(p){document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));document.getElementById(p+'Page').classList.add('active'); if(p==='main')startReminderTimer(); else clearTimeout(mainScreenReminderTimer); if(p==='settings'){document.getElementById('set_name').value=state.settings.workerName||"";document.getElementById('set_phone').value=state.settings.workerPhone||"";document.getElementById('set_pin').value=state.settings.pinCode||"";document.getElementById('set_duress').value=state.settings.duressPin||"";}}
function saveSettings(){ state.settings.workerName=document.getElementById('set_name').value; state.settings.workerPhone=document.getElementById('set_phone').value; state.settings.pinCode=document.getElementById('set_pin').value; state.settings.duressPin=document.getElementById('set_duress').value; saveState(); navigate('main'); document.getElementById('btnCloseSettings').style.display='block'; forceSync(); }
function saveState(){ localStorage.setItem('loneWorkerState',JSON.stringify(state)); }

// ==================== LOCATIONS UI ====================
function initLocations() { if(!state.locations) state.locations = []; }

function renderLocations(){
    const l=document.getElementById('locationList'); l.innerHTML='';
    state.locations.forEach(loc=>{
        const div=document.createElement('div');
        let cls = state.selectedLocationId===loc.id ? 'border-blue-500 bg-blue-900' : 'border-transparent bg-gray-900';
        if(loc.id==='travel') cls = state.selectedLocationId===loc.id ? 'border-purple-500 bg-purple-900' : 'border-purple-900/30 bg-gray-900';
        div.className = `p-4 rounded-lg border-2 ${cls} cursor-pointer flex justify-between items-center mb-2`;
        
        let infoBtn = loc.notes || loc.contactName ? `<button class="p-2 text-gray-400 hover:text-white z-20" onclick="showSiteInfo('${loc.id}',event)">‚ÑπÔ∏è</button>` : '';
        
        div.innerHTML=`<div><div class="text-xs text-gray-500 font-bold uppercase">${loc.companyName||''}</div><div class="font-bold text-lg text-white">${loc.name}</div></div><div class="flex gap-2">${infoBtn}</div>`;
        div.onclick=(e)=>{if(e.target.tagName!=='BUTTON'){state.selectedLocationId=loc.id; renderLocations(); updateArrivedButtonState();}};
        l.appendChild(div);
    });
}

function showSiteInfo(id, e) {
    if(e) e.stopPropagation();
    const l = state.locations.find(x => x.id === id);
    if(!l) return;
    
    showModal('info'); // Show the generic info modal
    document.getElementById('infoTitle').innerText = l.name;
    
    let html = "";
    if(l.address) html += `<p><strong>Address:</strong><br>${l.address}</p>`;
    if(l.contactName) html += `<p class="mt-2"><strong>Contact:</strong> ${l.contactName}</p>`;
    if(l.notes) html += `<div class="mt-3 bg-gray-700 p-2 rounded text-xs border-l-2 border-yellow-500">${l.notes}</div>`;
    
    document.getElementById('siteInfoContent').innerHTML = html;
    
    // Config buttons
    const btnCall = document.getElementById('btnSiteCall');
    const btnEmail = document.getElementById('btnSiteEmail');
    
    if(l.contactPhone) { btnCall.href = `tel:${l.contactPhone}`; btnCall.classList.remove('hidden'); } else btnCall.classList.add('hidden');
    if(l.contactEmail) { btnEmail.href = `mailto:${l.contactEmail}`; btnEmail.classList.remove('hidden'); } else btnEmail.classList.add('hidden');
}

// RESTORED: deleteLoc (Required for the Location Modal logic)
function deleteLoc() { 
    const id = document.getElementById('locId').value;
    if(id === 'travel') return alert("Cannot delete Travelling tile.");
    if(confirm('Delete location?')) {
        state.locations = state.locations.filter(l => l.id !== id);
        if(state.selectedLocationId === id) state.selectedLocationId = null;
        saveState(); renderLocations(); closeModal('location');
    }
}
function saveLoc() {
    const id = document.getElementById('locId').value;
    const name = document.getElementById('locName').value;
    const addr = document.getElementById('locAddr').value;
    const business = document.getElementById('locBusiness').value; 
    const tpl = document.getElementById('locTemplate').value;
    const noRep = document.getElementById('radRepNo').checked;
    
    if(!name) return alert("Name required");
    
    if(id) {
        const idx = state.locations.findIndex(l => l.id === id);
        if(idx > -1) {
            state.locations[idx] = { ...state.locations[idx], name, address: addr, companyName: business, templateName: tpl, noReport: noRep };
        }
    } else {
        state.locations.push({ 
            id: Date.now().toString(), 
            name, address: addr, companyName: business, templateName: tpl, noReport: noRep 
        });
    }
    saveState(); renderLocations(); closeModal('location'); syncForms();
}

// ==================== VISIT LOGIC ====================
function updateArrivedButtonState(){ const val=DURATION_MAP[document.getElementById('durationSlider').value]; document.getElementById('durationDisplay').innerText=val>=60?(Math.floor(val/60)+' hr '+(val%60)+' min'):val+' min'; state.visitDurationMinutes=val; const btn=document.getElementById('btnStart'); if(state.selectedLocationId && val>0){ btn.disabled=false; btn.innerText="HOLD TO START"; btn.className="long-press-btn flex-[2] py-5 bg-green-600 text-white font-bold rounded-xl text-xl shadow-lg transition-all"; setupLongPress(btn,startVisit); } else { btn.disabled=true; btn.innerText=state.selectedLocationId?"Set Time":"Select Location"; btn.className="long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl transition-all"; }}

function startVisit(){ 
    const sel=state.locations.find(x=>x.id===state.selectedLocationId);
    if(sel.id==='travel') startTravellingPulse();
    const now=new Date();
    state.activeVisit={ locationId:sel.id, startTime:now, anticipatedDepartureTime:new Date(now.getTime()+state.visitDurationMinutes*60000), fiveMinWarned:false };
    state.lowBatSent=false; // Reset
    saveState(); enterLockedScreen(); playSound('arrive');
    processUploadQueue(buildPayload({"Alarm Status":sel.id==='travel'?"TRAVELLING":"ON SITE", "Notes":"Started"}));
}

function enterLockedScreen(){ 
    const l=state.locations.find(x=>x.id===state.activeVisit.locationId); document.getElementById('lockedLocationName').innerText=l.name; navigate('locked'); 
    timerInt=setInterval(tick,1000); setupLongPress(document.getElementById('btnDepart'),()=>preDepart(false)); setupLongPress(document.getElementById('btnExtend'),()=>showModal('extend'));
}

function tick(){
    const rem = new Date(state.activeVisit.anticipatedDepartureTime) - new Date();
    const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000);
    document.getElementById('countdownTimer').innerText = rem<0 ? "OVERDUE" : `${m}:${s<10?'0':''}${s}`;
    
    // 5 MIN WARNING
    if(m===5 && !state.activeVisit.fiveMinWarned && rem>0){ 
        state.activeVisit.fiveMinWarned=true; 
        playSound('pre_alert'); 
        document.getElementById('fiveMinBanner').classList.remove('hidden'); 
        setTimeout(()=>document.getElementById('fiveMinBanner').classList.add('hidden'),10000); 
    }
    
    if(rem<0) { 
        document.getElementById('countdownTimer').classList.add('text-red-500'); 
        document.getElementById('btnSafe').classList.remove('hidden'); document.getElementById('btnDepart').classList.add('hidden');
        setupLongPress(document.getElementById('btnSafe'), iamSafe);
        
        // Escalation Logic
        const minsOver = Math.floor(Math.abs(rem)/60000);
        if(minsOver < CONFIG.escalationMinutes && !state.activeVisit.overdueSent) { state.activeVisit.overdueSent=true; saveState(); triggerAutoAlert('OVERDUE'); playSound('warning'); }
        else if(minsOver >= CONFIG.escalationMinutes && !state.activeVisit.criticalSent) { state.activeVisit.criticalSent=true; saveState(); triggerAutoAlert('EMERGENCY - OVERDUE'); }
    }
    
    if(CONFIG.checkinEnabled && state.activeVisit.nextCheckin && new Date() > new Date(state.activeVisit.nextCheckin)) triggerCheckin();
}

function preDepart(){ const l=state.locations.find(x=>x.id===state.activeVisit.locationId); loadFormAndShow(l.templateName||"(Standard)"); }

// ==================== FORMS & REPORTING ====================
function loadFormAndShow(tpl){ 
    showModal('report'); buildReportForm(tpl, document.getElementById('reportFields')); 
    const btn = document.getElementById('btnSubmitRep');
    const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
    
    if(isMidVisitUpdate) { newBtn.innerText="Send Update"; newBtn.classList.remove('long-press-btn'); newBtn.onclick=submitReport; }
    else { newBtn.innerText="HOLD TO SUBMIT & END"; newBtn.classList.add('long-press-btn'); setupLongPress(newBtn, submitReport); }
}

function submitReport(){ 
    const data = gatherFormData();
    if(isMidVisitUpdate) { processUploadQueue(buildPayload({...data, "Alarm Status":"ON SITE"})); alert("Update Sent"); closeModal(); return; }
    
    // Departure Logic
    processUploadQueue(buildPayload({...data, "Alarm Status":"DEPARTED"}));
    if(navigator.onLine) alert("‚úÖ Sent"); else alert("üíæ Saved to Outbox");
    state.activeVisit=null; saveState(); closeModal(); navigate('main');
    playSound('depart');
    if(travellingInterval) clearInterval(travellingInterval);
}

function gatherFormData() {
    const data = { custom: {}, notes: '', sig: null, jsonPayload: {} };
    const stdNotes = document.getElementById('rep_notes'); if(stdNotes) data.notes = stdNotes.value;
    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key'); let val = el.value;
        if(el.type === 'checkbox') val = el.checked ? 'Yes' : 'No';
        else if(el.type === 'radio') { if(!el.checked) return; val = el.value; }
        data.custom[key] = val; data.jsonPayload[key] = val;
    });
    const canvas = document.getElementById('sig-canvas'); if(canvas) data.sig = canvas.toDataURL('image/png');
    return data;
}

function buildReportForm(tplName, container) {
    state.photoStore = {}; 
    let tpl = (state.globalForms && state.globalForms.find(f => f.name === tplName))?.questions;
    if (!tpl) tpl = state.cachedForms[tplName];
    if (!tpl) tpl = state.cachedForms["(Standard)"] || [];
    
    if(tpl.length === 0) { container.innerHTML = '<label class="block text-sm text-gray-400">Notes</label><textarea id="rep_notes" class="form-input h-32"></textarea>'; } 
    else {
        tpl.forEach((f, index) => {
            let type = f.type || 'check', text = f.text || f; 
            if (typeof f === 'string') {
                if(f.includes('[TEXT]')) { type='text'; text=f.replace('[TEXT]','').trim(); }
                else if(f.includes('[PHOTO]')) { type='photo'; text=f.replace('[PHOTO]','').trim(); }
                else if(f.includes('[YESNO]')) { type='yesno'; text=f.replace('[YESNO]','').trim(); }
                else if(f.includes('[NUMBER]')) { type='number'; text=f.replace('[NUMBER]','').trim(); }
                else if(f.includes('[GPS]')) { type='gps'; text=f.replace('[GPS]','').trim(); }
                else if(f.includes('[HEADING]')) { type='header'; text=f.replace('[HEADING]','').trim(); }
                else if(f.includes('[NOTE]')) { type='note'; text=f.replace('[NOTE]','').trim(); }
                else if(f.includes('[SIGN]')) { type='signature'; text=f.replace('[SIGN]','').trim(); }
            }
            let html = '';
            if(type==='header') html = `<h3 class="text-blue-400 font-bold mt-4 border-b border-gray-700 pb-1">${text}</h3>`;
            else if(type==='note') html = `<p class="text-gray-500 text-sm italic my-2">${text}</p>`;
            else if(type==='text') html = `<label class="block text-sm text-gray-300 mt-2">${text}</label><textarea data-key="${text}" class="form-input h-24"></textarea>`;
            else if(type==='number') html = `<label class="block text-sm text-gray-300 mt-2">${text}</label><input type="number" step="any" data-key="${text}" class="form-input">`;
            else if(type==='check') html = `<label class="flex items-center gap-3 mt-3 p-3 bg-gray-900 rounded"><input type="checkbox" data-key="${text}" class="w-5 h-5"><span class="text-gray-300">${text}</span></label>`;
            else if(type==='yesno') html = `<div class="mt-3"><span class="text-sm text-gray-300 block mb-1">${text}</span><div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="${text}" value="Yes" data-key="${text}"> Yes</label><label class="flex items-center gap-2"><input type="radio" name="${text}" value="No" data-key="${text}"> No</label></div></div>`;
            else if(type==='photo') html = `<label class="block text-sm text-gray-300 mt-4">${text}</label><input type="file" accept="image/*" class="w-full text-sm text-gray-500 mt-2" onchange="handlePhoto(this, '${index}')">`;
            else if(type==='gps') html = `<div class="mt-4"><label class="block text-sm text-gray-300 mb-1">${text}</label><button type="button" onclick="captureGPS(this)" class="bg-blue-900 hover:bg-blue-800 text-blue-200 text-xs px-3 py-2 rounded flex items-center gap-2"><span>üìç Tap to Capture Location</span></button><input type="hidden" data-key="${text}"></div>`;
            else if(type==='signature') html = `<label class="block text-sm text-gray-300 mt-4">${text}</label><canvas id="sig-canvas" width="300" height="150" class="border border-gray-600 bg-white touch-none"></canvas><button onclick="clearSig()" class="text-xs text-red-400 mt-1">Clear</button>`;
            container.innerHTML += html;
        });
    }
    const canvas = document.getElementById('sig-canvas'); if(canvas) initSigPad(canvas);
}

// ... (Helper Functions: captureGPS, handlePhoto, compressImg, initSigPad, clearSig, etc.)
function captureGPS(btn){btn.innerText="Locating...";navigator.geolocation.getCurrentPosition(p=>{btn.innerText="‚úÖ "+p.coords.latitude+","+p.coords.longitude;btn.nextElementSibling.value=p.coords.latitude+","+p.coords.longitude;});}
function handlePhoto(input, key){if(input.files[0]){const btn=input.previousElementSibling;btn.innerText="Compressing...";compressImg(input.files[0]).then(b64=>{state.photoStore[key]=b64;btn.innerText="Photo Saved ‚úÖ";});}}
function compressImg(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas'),s=Math.min(1024/i.width,1024/i.height,1);c.width=i.width*s;c.height=i.height*s;c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6));};i.src=e.target.result;};rd.readAsDataURL(f);});}
function initSigPad(c){const ctx=c.getContext('2d');ctx.lineWidth=2;ctx.strokeStyle="#000";let d=false;const g=e=>{const r=c.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};};const s=e=>{d=true;ctx.beginPath();const{x,y}=g(e);ctx.moveTo(x,y);};const m=e=>{if(!d)return;e.preventDefault();const{x,y}=g(e);ctx.lineTo(x,y);ctx.stroke();};const n=()=>{d=false;};c.addEventListener('mousedown',s);c.addEventListener('mousemove',m);c.addEventListener('mouseup',n);c.addEventListener('touchstart',s);c.addEventListener('touchmove',m);c.addEventListener('touchend',n);}
function clearSig(){const c=document.getElementById('sig-canvas');if(c)c.getContext('2d').clearRect(0,0,c.width,c.height);}

// ==================== CORE UTILS ====================
function triggerAutoAlert(status) { const sel = state.locations.find(l => l.id === state.activeVisit.locationId); const locName = sel ? (sel.companyName ? `${sel.companyName} - ${sel.name}` : sel.name) : "Unknown"; navigator.geolocation.getCurrentPosition(pos => { processUploadQueue(buildPayload({ "Alarm Status": status, "Notes": "Automated System Alert", "Location Name": locName, "Last Known GPS": `${pos.coords.latitude},${pos.coords.longitude}` })); }, () => { processUploadQueue(buildPayload({ "Alarm Status": status, "Notes": "Automated System Alert (GPS Fail)", "Location Name": locName })); }); }
// RESTORED: startReminderTimer (Critical for startup crash fix)
function startReminderTimer() {
    clearTimeout(mainScreenReminderTimer);
    document.getElementById('startReminderBanner').classList.add('hidden');
    mainScreenReminderTimer = setTimeout(() => {
        if(!state.activeVisit && document.getElementById('mainPage').classList.contains('active')) {
            document.getElementById('startReminderBanner').classList.remove('hidden');
        }
    }, 300000); 
}

function triggerCheckin() { if(!document.getElementById('checkinModal').classList.contains('hidden')) return; showModal('checkin'); document.getElementById('batterySaver').classList.add('hidden'); let rem = 120; const el = document.getElementById('checkinCountdown'); if(checkinIntervalId) clearInterval(checkinIntervalId); playSound('checkin'); const btn = document.getElementById('btnCheckinConfirm'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); setupLongPress(newBtn, confirmCheckin); checkinIntervalId = setInterval(() => { rem--; const m = Math.floor(rem/60); const s = rem%60; el.innerText = `${m}:${s<10?'0':''}${s}`; if(rem === 60 || rem === 30 || rem === 10) playSound('checkin'); if(rem <= 0) { clearInterval(checkinIntervalId); closeModal('checkin'); sendToGoogleSheet(buildPayload({ "Alarm Status": 'MISSED_CHECKIN', "Notes": "Worker failed to respond to check-in" })); alert('MISSED CHECK-IN ALERT SENT'); } }, 1000); }
function confirmCheckin() { clearInterval(checkinIntervalId); closeModal('checkin'); state.activeVisit.nextCheckin = new Date(Date.now() + CONFIG.checkinInterval*60000); saveState(); }
function confirmExtension(mins) { const process = () => { state.activeVisit.anticipatedDepartureTime = new Date(new Date(state.activeVisit.anticipatedDepartureTime).getTime() + mins * 60000); saveState(); playSound('extend'); processUploadQueue(buildPayload({ "Alarm Status": 'EXTENDED', "Notes": "Extended " + mins + "m" })); }; const now = new Date(), due = new Date(state.activeVisit.anticipatedDepartureTime); closeModal('extend'); if ((due-now)<0 || state.activeVisit.isPanic) withPinVerification(false, process); else process(); }
function handlePanicTap() { const now = Date.now(); if (now - panicTapTimer > 2000) panicTapCount = 0; panicTapCount++; panicTapTimer = now; if (panicTapCount >= 3) { triggerPanic(); panicTapCount = 0; } }
function triggerPanic() { state.activeVisit = state.activeVisit || {}; state.activeVisit.isPanic = true; saveState(); playSound('panic'); processUploadQueue(buildPayload({ "Alarm Status": 'EMERGENCY - PANIC BUTTON', "Notes": "Panic Button Pressed" })); alert('PANIC ALERT SENT'); }
function iamSafe() { withPinVerification(false, () => { playSound('safe'); processUploadQueue(buildPayload({ "Alarm Status": 'SAFE - MANUALLY CLEARED', "Notes": "Worker confirmed safe" })); state.activeVisit.isPanic = false; preDepart(true); }); }
function openMidVisitMenu() { isMidVisitUpdate = true; showModal('template'); const list = document.getElementById('templateList'); list.innerHTML = ''; const l = state.locations.find(x => x.id === state.activeVisit.locationId); const defaultName = l.templateName || "Standard Visit Note"; list.appendChild(createTemplateBtn(`üìç ${defaultName}`, defaultName)); if (state.globalForms && state.globalForms.length > 0) state.globalForms.forEach(f => list.appendChild(createTemplateBtn(`üìù ${f.name}`, f.name))); else list.innerHTML += '<p class="text-xs text-gray-500 mt-2 text-center">No extra forms found.</p>'; }
function createTemplateBtn(label, value) { const btn = document.createElement('button'); btn.className = "w-full bg-gray-700 hover:bg-blue-600 text-white font-bold py-3 rounded-lg mb-2 text-left px-4"; btn.innerText = label; btn.onclick = () => { closeModal('template'); loadFormAndShow(value); }; return btn; }
function startTravellingPulse() { toggleBatterySaver(); travellingInterval=setInterval(()=>{ navigator.geolocation.getCurrentPosition(p=>{ processUploadQueue(buildPayload({"Alarm Status":"TRAVELLING", "Last Known GPS":`${p.coords.latitude},${p.coords.longitude}`})); }) }, 300000); }
function toggleBatterySaver() { document.getElementById('batterySaver').classList.toggle('hidden'); }
function processUploadQueue(d){ if(d)state.pendingUploads.push(d); if(navigator.onLine && state.pendingUploads.length){ const fd=new FormData(); for(let k in state.pendingUploads[0])fd.append(k,state.pendingUploads[0][k]); fetch(CONFIG.url,{method:'POST',mode:'no-cors',body:fd}).then(()=>{state.pendingUploads.shift();saveState();processUploadQueue()}); } saveState(); }
function setupLongPress(btn,cb){ let t; btn.onmousedown=btn.ontouchstart=(e)=>{e.preventDefault();btn.classList.add('pressing');t=setTimeout(()=>{cb();btn.classList.remove('pressing')},1500)}; btn.onmouseup=btn.ontouchend=()=>clearTimeout(t); }
function showModal(id){ document.getElementById('modalBackdrop').classList.remove('hidden'); document.getElementById(id==='report'?'modal-report':id==='location'?'locationModal':id==='pin'?'pinModal':id==='extend'?'extendModal':'infoModal').classList.remove('hidden'); if(id==='template')document.getElementById('templateModal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modalBackdrop').classList.add('hidden'); document.querySelectorAll('#modalBackdrop > div').forEach(d=>d.classList.add('hidden')); }
async function initAudio(){ if(!synth){ await Tone.start(); synth=new Tone.Synth().toDestination(); } }
function playSound(t){ initAudio().then(()=>{ const n=Tone.now(); if(t==='arrive')synth.triggerAttackRelease("C4","8n",n); if(t==='pre_alert'){synth.triggerAttackRelease("C6","8n",n); navigator.vibrate([1000,500,1000]);} if(t==='depart')synth.triggerAttackRelease("G4","8n",n); if(t==='warning')synth.triggerAttackRelease("E5","16n",n); if(t==='panic')synth.triggerAttackRelease("G5","16n",n); }); }
function syncForms() { if(!CONFIG.url) return; fetch(`${CONFIG.url}?action=getGlobalForms`).then(r => r.json()).then(j => { if(Array.isArray(j)) { state.globalForms = j; saveState(); } }); }
function clearFormsCache() { state.cachedForms = {}; state.globalForms = []; syncForms(); alert("Forms Syncing..."); }
function quickStat() { if(!state.selectedLocationId) return; const l = state.locations.find(x => x.id === state.selectedLocationId); state.activeVisit = { locationId: l.id, startTime: new Date().toISOString() }; loadFormAndShow(l.templateName || "(Standard)"); document.getElementById('btnSubmitRep').onclick = () => { const d = gatherFormData(); const locName = l.companyName ? `${l.companyName} - ${l.name}` : l.name; const data = buildPayload({ "Location Name": locName, "Location Address": l.address, "Alarm Status": "DATA_ENTRY_ONLY", "Notes": d.notes, "Visit Report Data": JSON.stringify(d.jsonPayload) }); const photoKeys = Object.keys(state.photoStore); if(photoKeys.length > 0) data["Photo 1"] = state.photoStore[photoKeys[0]]; if(d.custom["Distance (km)"]) data["Distance"] = d.custom["Distance (km)"]; processUploadQueue(data); if(navigator.onLine) alert("‚úÖ Uploaded!"); else alert("üíæ SAVED TO OUTBOX."); state.activeVisit = null; state.photoStore = {}; sigPad = null; closeModal('report'); }; }
function withPinVerification(isDuressAction, callback) { showModal('pin'); const input = document.getElementById('pinInput'); input.value = ''; input.focus(); const confirm = () => { const val = input.value; closeModal('pin'); if(val === state.settings.pinCode) callback(); else if(val === state.settings.duressPin) { processUploadQueue(buildPayload({ "Alarm Status": "DURESS_CODE_ACTIVATED", "Notes": "Silent Alarm" })); if(isDuressAction) callback(); else alert("PIN Accepted"); } else alert("Incorrect PIN"); document.getElementById('confirmPinBtn').removeEventListener('click', confirm); }; document.getElementById('confirmPinBtn').addEventListener('click', confirm); document.getElementById('cancelPinBtn').onclick = () => closeModal('pin'); }
function clearData() { if(confirm('Reset all data?')) { localStorage.clear(); location.reload(); } }

// LISTENERS
document.getElementById('btnDelLoc').onclick = deleteLoc; document.getElementById('saveLocationBtn').onclick = saveLoc; document.getElementById('cancelLocationBtn').onclick = () => closeModal('location'); document.getElementById('cancelReportBtn').onclick = () => closeModal('report'); document.getElementById('checkinOkBtn').onclick = () => { clearInterval(checkinIntervalId); closeModal('checkin'); state.activeVisit.nextCheckin = new Date(Date.now() + CONFIG.checkinInterval*60000); saveState(); }; document.getElementById('durationSlider').oninput = updateArrivedButtonState; document.getElementById('cancelPinBtn').onclick = () => closeModal('pin'); document.getElementById('alertModalOkBtn').onclick = () => closeModal('alert');
</script>
</body>
</html>
