<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>%%ORG_NAME%% Safety</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="%%PRIMARY_COLOR%%">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
/* 1. FACTORY DYNAMIC THEME */
:root {
    --primary: %%PRIMARY_COLOR%%;
    --accent: %%ACCENT_COLOR%%;
}

/* 2. FORCE SYSTEM DIM: Required to dim the OS navigation bar for Battery Saver */
html.system-dim, body.system-dim { 
    background-color: #000000 !important; 
    color-scheme: dark !important; 
}

/* 3. SOPHISTICATED UI BASE */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: var(--primary); color: white; height: 100%; width: 100%; overflow: hidden; }

.page { 
    display: none; 
    height: 100%; 
    width: 100%; 
    flex-direction: column; 
    position: absolute; 
    top: 0; 
    left: 0; 
    background-color: var(--primary);
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}
.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }
.footer-bar { padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); background-color: var(--primary); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 20; }

/* 4. LONG-PRESS INTERACTION STYLES */
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width 0.2s ease-out; }
.long-press-btn.pressing::after { width: 100%; transition: width 1.5s linear; }

/* 5. GPS SIGNAL BARS */
.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
.gps-bar.active-amber { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }

/* 6. UTILITY CLASSES */
.form-input { width: 100%; background-color: var(--primary); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* 7. POCKET PROTECTION/BATTERY SAVER VISUALS */
#batterySaver { 
    background-color: #000;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
}
#saverProgress { background: rgba(255, 255, 255, 0.2); transition: opacity 1.5s linear; }

/* 8. INSTALL OVERLAYS */
#toastMsg { z-index: 1000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-150%); }
#toastMsg.show { transform: translateY(0); }
</style>
</head>
<body class="h-full overflow-hidden select-none">

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-md transform -translate-y-full transition-transform duration-300" aria-live="polite">
  <p id="toastText"></p>
</div>

<div id="batterySaver" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center pointer-events-none transition-opacity duration-500">
    <div class="absolute top-0 left-0 h-1 bg-blue-500 opacity-50" id="saverProgress" style="width: 0%"></div>
    <div class="flex flex-col items-center gap-6">
        <div class="w-24 h-24 rounded-full border-2 border-white/10 flex items-center justify-center">
            <div class="w-16 h-16 rounded-full bg-white/5 animate-pulse"></div>
        </div>
        <div class="text-center">
            <h3 class="text-white font-bold text-xl mb-1">Battery Saver Active</h3>
            <p class="text-gray-400 text-sm">Long press to wake</p>
        </div>
    </div>
    <button id="wakeButton" class="mt-4 px-6 py-3 bg-blue-600 rounded-xl font-bold" aria-label="Wake device">Wake</button>
</div>

<div id="setupPage" class="page">
    <div class="header-bar">
        <h1 class="text-xl font-bold">Setup Wizard</h1>
    </div>
    <div class="content-area flex flex-col">
        <div id="wizStep1" class="wizard-step active">
            <h2 class="text-lg font-bold mb-4">Your Identity</h2>
            <input id="wizName" type="text" placeholder="Full Name" class="form-input">
            <input id="wizPhone" type="tel" placeholder="Phone Number" class="form-input">
            <input id="wizEmail" type="email" placeholder="Email Address" class="form-input">
        </div>
        <div id="wizStep2" class="wizard-step">
            <h2 class="text-lg font-bold mb-4">Security PINs</h2>
            <input id="wizPin" type="password" placeholder="Standard PIN (4-6 digits)" class="form-input">
            <input id="wizDuress" type="password" placeholder="Duress PIN (silent alert)" class="form-input">
        </div>
        <div id="wizStep3" class="wizard-step">
            <h2 class="text-lg font-bold mb-4">Emergency Contact</h2>
            <input id="wizContactName" type="text" placeholder="Contact Name" class="form-input">
            <input id="wizContactPhone" type="tel" placeholder="Contact Phone" class="form-input">
        </div>
    </div>
    <div class="footer-bar flex justify-between">
        <button id="btnWizPrev" onclick="prevWiz()" class="hidden px-6 py-3 bg-gray-600 rounded-xl font-bold">Back</button>
        <button id="btnWizNext" onclick="nextWiz()" class="px-6 py-3 bg-blue-600 rounded-xl font-bold">Next Step</button>
    </div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <h1 id="headerWorkerName" class="text-xl font-bold">Welcome</h1>
        <div id="gpsIndicator" class="flex gap-1">
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
        </div>
    </div>
    <div class="content-area" id="locationsList">
        <!-- Rendered tiles -->
    </div>
    <div class="footer-bar">
        <!-- Settings, etc. -->
    </div>
</div>

<div id="lockedPage" class="page">
    <div class="header-bar">
        <h1 class="text-xl font-bold">Active Visit</h1>
        <div id="visitTimer" class="text-lg font-mono">0:00</div>
    </div>
    <div class="content-area flex flex-col items-center justify-center gap-6">
        <button id="btnPanic" class="long-press-btn w-40 h-40 rounded-full bg-red-600 text-white text-3xl font-bold shadow-lg active:scale-95 transition-transform" aria-label="Emergency panic button - hold for 3 seconds">
            SOS
        </button>
        <p class="text-gray-300 text-sm text-center">Hold for 3 seconds to trigger panic alarm</p>
    </div>
    <div class="footer-bar">
        <button id="btnDepart" class="long-press-btn w-full py-4 bg-blue-600 rounded-xl font-bold text-lg active:scale-98 transition-transform" aria-label="Complete visit - hold for 1.5 seconds">
            Hold to Complete Visit
        </button>
    </div>
</div>

<div id="reportPage" class="page">
    <div class="header-bar">
        <h1 class="text-xl font-bold">Visit Report</h1>
    </div>
    <div class="content-area">
        <div id="reportFields"></div>
    </div>
</div>

<div id="pinModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <h3 class="text-lg font-bold mb-4">Enter PIN</h3>
        <input id="pinInput" type="password" class="form-input mb-4" inputmode="numeric" maxlength="6">
        <button id="btnPinConfirm" class="w-full py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
    </div>
</div>

<div id="groundedModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <h3 class="text-lg font-bold mb-4">Vehicle Grounded</h3>
        <p class="text-gray-300 mb-4">WOF or Rego expired. Cannot proceed.</p>
        <button onclick="closeModal('grounded')" class="w-full py-3 bg-red-600 rounded-xl font-bold">OK</button>
    </div>
</div>

<div id="iosInstallModal" class="hidden fixed bottom-6 left-4 right-4 bg-gray-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl z-[100]">
    <div class="flex items-start gap-4">
        <div class="text-4xl">ðŸ“²</div>
        <div class="flex-1">
            <h3 class="text-lg font-extrabold text-white mb-1">Add to Home Screen</h3>
            <p class="text-gray-300 text-xs mb-4 font-bold">Required for safety background tracking.</p>
            <div class="bg-gray-900 rounded-lg p-3 text-xs text-blue-300 flex items-center gap-2 font-bold uppercase tracking-tighter">
                <span>1. Tap Share</span><span class="text-xl">âŽ‹</span><span>2. 'Add to Home Screen'</span><span class="text-xl">âŠ•</span>
            </div>
        </div>
        <button onclick="dismissInstall('ios')" class="text-gray-500 font-black p-2">âœ•</button>
    </div>
</div>

<script>
// ============================================================================
// GLOBALS AND STATE INITIALIZATION
// ============================================================================
let state; // Declared but not initialized until onload
let dimTimer;
let isDimmed = false;
const DIM_DELAY = 10000; // 10 seconds
let checkinIntervalId;
let travellingInterval;
let timerInt;
let deferredPrompt;
let lastAlertTime = 0;
let lastGPS = null;
let synth; // Tone.js synth - initialized after user interaction
let audioReady = false;
let gpsWatchId = null; // Track GPS watch for cleanup

// ============================================================================
// AUDIO INITIALIZATION (Must be after user interaction)
// ============================================================================
async function initAudio() {
    if (!audioReady && typeof Tone !== 'undefined') {
        try {
            await Tone.start();
            synth = new Tone.Synth().toDestination();
            audioReady = true;
            console.log('Audio initialized successfully');
        } catch (e) {
            console.warn('Audio initialization failed:', e);
            audioReady = false;
        }
    }
}

// Initialize audio on first user interaction
document.addEventListener('click', initAudio, { once: true });
document.addEventListener('touchstart', initAudio, { once: true });

// ============================================================================
// STATE PERSISTENCE
// ============================================================================
function loadState() {
    try {
        const saved = localStorage.getItem('loneWorkerState');
        if (saved) {
            const parsed = JSON.parse(saved);
            // Decode PINs
            if (parsed.pins && parsed.pins.std && parsed.pins.duress) {
                try {
                    parsed.pins.std = atob(parsed.pins.std);
                    parsed.pins.duress = atob(parsed.pins.duress);
                } catch (e) {
                    console.error('PIN decode failed:', e);
                    parsed.pins = { std: '', duress: '' };
                }
            }
            return parsed;
        }
    } catch (e) {
        console.error('Load state failed:', e);
    }
    return null;
}

function saveState() {
    try {
        const toSave = { ...state };
        // Base64 PINs (only if they exist)
        if (toSave.pins && toSave.pins.std && toSave.pins.duress) {
            try {
                toSave.pins.std = btoa(toSave.pins.std);
                toSave.pins.duress = btoa(toSave.pins.duress);
            } catch (e) {
                console.error('PIN encode failed:', e);
            }
        }
        localStorage.setItem('loneWorkerState', JSON.stringify(toSave));
    } catch (e) {
        console.error('Save state failed:', e);
    }
}

// ============================================================================
// NAVIGATION
// ============================================================================
function navigate(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(page + 'Page');
    if (targetPage) {
        targetPage.classList.add('active');
        resetInactivityTimer();
    } else {
        console.error(`Page not found: ${page}Page`);
    }
}

// ============================================================================
// MODALS
// ============================================================================
function showModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ============================================================================
// TOAST NOTIFICATIONS
// ============================================================================
function showToast(text) {
    const toastText = document.getElementById('toastText');
    const toastMsg = document.getElementById('toastMsg');
    if (toastText && toastMsg) {
        toastText.innerText = text;
        toastMsg.classList.add('show');
        setTimeout(() => toastMsg.classList.remove('show'), 3000);
    }
}

// ============================================================================
// VOICE ANNOUNCE (Web Speech with fallback)
// ============================================================================
function announce(text) {
    if ('speechSynthesis' in window) {
        try {
            const utter = new SpeechSynthesisUtterance(text);
            
            // Wait for voices to load on some browsers
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    speechSynthesis.speak(utter);
                }, { once: true });
            } else {
                speechSynthesis.speak(utter);
            }
        } catch (e) {
            console.warn('Speech synthesis failed:', e);
            showToast(text);
        }
    } else {
        showToast(text);
    }
}

// ============================================================================
// SAFETY LOGGING
// ============================================================================
async function logSafety(type, message) {
    console.log(`[${type}] ${message}`);
    try {
        const payload = {
            type,
            message,
            timestamp: new Date().toISOString(),
            worker: state.worker.name || 'Unknown',
            emergencyContact: `${state.worker.emgName || 'N/A'} (${state.worker.emgPhone || 'N/A'})`,
            battery: await getBatteryPercent(),
            gps: lastGPS || 'Unknown'
        };
        state.pendingUploads.push(payload);
        if (state.pendingUploads.length > 50) state.pendingUploads.shift();
        saveState();
        forceSync();
    } catch (e) {
        console.error('Log safety failed:', e);
    }
}

async function getBatteryPercent() {
    try {
        if ('getBattery' in navigator) {
            const battery = await navigator.getBattery();
            return Math.floor(battery.level * 100) + '%';
        }
    } catch (e) {
        console.info('Battery API not available:', e);
    }
    return 'Unknown';
}

// Placeholder for backend sync
function forceSync() {
    // TODO: Implement backend synchronization
    console.log('Sync triggered - pending uploads:', state.pendingUploads.length);
}

// Placeholder for report submission
function submitReport() {
    // TODO: Implement report submission
    console.log('Report submitted');
    navigate('main');
}

// ============================================================================
// LONG-PRESS INTERACTION
// ============================================================================
function setupLongPress(elementId, duration, callback) {
    const btn = document.getElementById(elementId);
    if (!btn) {
        console.error(`Long press button not found: ${elementId}`);
        return;
    }
    
    let timer;
    
    btn.addEventListener('touchstart', e => {
        e.preventDefault();
        btn.classList.add(duration === 1500 ? 'pressing' : 'holding');
        timer = setTimeout(() => {
            callback();
            btn.classList.remove('pressing', 'holding');
        }, duration);
    }, { passive: false });
    
    ['touchend', 'touchcancel', 'touchmove'].forEach(ev => {
        btn.addEventListener(ev, () => {
            clearTimeout(timer);
            btn.classList.remove('pressing', 'holding');
        });
    });
}

// ============================================================================
// INACTIVITY DIM MODE
// ============================================================================
function resetInactivityTimer() {
    clearTimeout(dimTimer);
    if (state && state.activeVisit) {
        dimTimer = setTimeout(activateDimMode, DIM_DELAY);
    }
    deactivateDimMode();
}

function activateDimMode() {
    if (!state || !state.activeVisit) return;
    document.documentElement.classList.add('system-dim');
    document.body.classList.add('system-dim');
    isDimmed = true;
    const batterySaver = document.getElementById('batterySaver');
    const saverProgress = document.getElementById('saverProgress');
    if (batterySaver) batterySaver.classList.remove('hidden');
    if (saverProgress) saverProgress.style.width = '100%';
}

function deactivateDimMode() {
    document.documentElement.classList.remove('system-dim');
    document.body.classList.remove('system-dim');
    isDimmed = false;
    const batterySaver = document.getElementById('batterySaver');
    const saverProgress = document.getElementById('saverProgress');
    if (batterySaver) batterySaver.classList.add('hidden');
    if (saverProgress) saverProgress.style.width = '0%';
}

// Battery saver wake button
const wakeButton = document.getElementById('wakeButton');
if (wakeButton) {
    wakeButton.addEventListener('touchstart', e => {
        e.preventDefault();
        let wakeTimer = setTimeout(() => {
            deactivateDimMode();
            resetInactivityTimer();
        }, 1500);
        ['touchend', 'touchcancel'].forEach(ev => {
            document.addEventListener(ev, () => clearTimeout(wakeTimer), { once: true });
        });
    });
}

// ============================================================================
// GPS MONITORING
// ============================================================================
function startGPSMonitoring() {
    // Stop any existing watch
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    
    if (navigator.geolocation) {
        gpsWatchId = navigator.geolocation.watchPosition(
            pos => {
                lastGPS = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                updateGPSBars(pos);
            },
            err => {
                console.error('GPS error:', err);
                // Update UI to show GPS unavailable
                const bars = document.querySelectorAll('.gps-bar');
                bars.forEach(b => {
                    b.classList.remove('active-red', 'active-amber', 'active-green');
                    b.style.backgroundColor = '#374151';
                });
            },
            { 
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
            }
        );
    }
}

function stopGPSMonitoring() {
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
}

function updateGPSBars(pos) {
    const accuracy = pos.coords.accuracy;
    const bars = document.querySelectorAll('.gps-bar');
    bars.forEach(b => b.classList.remove('active-red', 'active-amber', 'active-green'));
    if (accuracy > 50) {
        bars.forEach(b => b.classList.add('active-red'));
    } else if (accuracy > 20) {
        bars.forEach(b => b.classList.add('active-amber'));
    } else {
        bars.forEach(b => b.classList.add('active-green'));
    }
}

// Capture GPS for forms
function captureGPS(btn) {
    if (!navigator.geolocation) return showToast("GPS Not Supported");
    btn.innerText = "âŒ›...";
    navigator.geolocation.getCurrentPosition(
        pos => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) input.value = coords;
            showToast("Location Captured");
            btn.innerText = "GPS";
        },
        err => {
            showToast("GPS Error: Enable location");
            btn.innerText = "GPS";
            console.error('GPS capture error:', err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// ============================================================================
// CHECK-IN TIMER
// ============================================================================
function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state && state.activeVisit) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

// ============================================================================
// TRAVELLING PULSE
// ============================================================================
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        if (state && state.activeVisit && state.activeVisit.status === 'TRAVELLING') {
            // Send periodic location pulse
            logSafety('TRAVELLING', 'Location pulse');
        }
    }, 120000); // 2 minutes
}

// ============================================================================
// REPORT FORM BUILDING
// ============================================================================
function buildReportForm(templateName, fieldArea) {
    if (!fieldArea) return;
    fieldArea.innerHTML = ''; // Clear
    const template = state.globalForms.find(f => f.name === templateName) || { 
        fields: '[TEXT|Notes] [GPS|Location] [PHOTO|Photo1] [SIGN|Signature] [NUMBER|Quantity]' 
    };
    const tags = template.fields.match(/\[\w+\|.*?\]/g) || [];
    
    tags.forEach(tag => {
        const [type, label] = tag.slice(1, -1).split('|');
        const fieldId = `field_${label.replace(/\s/g, '_')}`;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-4';
        
        const labelEl = document.createElement('label');
        labelEl.className = 'block text-sm font-bold mb-2';
        labelEl.innerText = label;
        labelEl.htmlFor = fieldId;
        wrapper.appendChild(labelEl);
        
        if (type === 'TEXT') {
            const input = document.createElement('textarea');
            input.id = fieldId;
            input.className = 'form-input';
            input.rows = 3;
            wrapper.appendChild(input);
        } else if (type === 'GPS') {
            const btnGPS = document.createElement('button');
            btnGPS.innerText = 'Capture GPS';
            btnGPS.className = 'px-4 py-2 bg-blue-600 rounded mb-2';
            btnGPS.onclick = () => captureGPS(btnGPS);
            const input = document.createElement('input');
            input.id = fieldId;
            input.className = 'form-input';
            input.readOnly = true;
            wrapper.appendChild(btnGPS);
            wrapper.appendChild(input);
        } else if (type === 'PHOTO') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.id = fieldId;
            input.className = 'form-input';
            wrapper.appendChild(input);
        } else if (type === 'NUMBER') {
            const input = document.createElement('input');
            input.type = 'number';
            input.id = fieldId;
            input.className = 'form-input';
            wrapper.appendChild(input);
        } else if (type === 'SIGN') {
            const canvas = document.createElement('canvas');
            canvas.id = fieldId;
            canvas.width = 300;
            canvas.height = 150;
            canvas.className = 'border-2 border-gray-600 rounded';
            wrapper.appendChild(canvas);
            // TODO: Add signature capture logic
        }
        
        fieldArea.appendChild(wrapper);
    });
}

// ============================================================================
// PIN VERIFICATION
// ============================================================================
function withPinVerification(allowDuress, callback) {
    showModal('pin');
    const pinInput = document.getElementById('pinInput');
    const btnConfirm = document.getElementById('btnPinConfirm');
    
    if (!pinInput || !btnConfirm) return;
    
    pinInput.value = '';
    pinInput.focus();
    
    btnConfirm.onclick = () => {
        const value = pinInput.value;
        closeModal('pin');
        if (value === state.pins.std) {
            callback();
        } else if (allowDuress && value === state.pins.duress) {
            triggerPanic(true); // Silent duress
        } else {
            showToast("Incorrect PIN");
        }
    };
}

// ============================================================================
// PRE-DEPART
// ============================================================================
function preDepart() {
    if (!state || !state.activeVisit) return;
    const alarmActive = state.activeVisit.isPanic || state.activeVisit.criticalSent;
    const proceed = () => {
        submitReport();
    };
    alarmActive ? withPinVerification(false, proceed) : proceed();
}

// ============================================================================
// ENTER LOCKED SCREEN
// ============================================================================
function enterLockedScreen() {
    navigate('locked');
    startCheckinTimer();
    setupLongPress('btnDepart', 1500, preDepart);
}

// ============================================================================
// TRIGGER PANIC
// ============================================================================
async function triggerPanic(duress = false) {
    document.body.classList.add('bg-red-900');
    announce(duress ? "Duress activated silently." : "Panic alarm activated.");
    
    // Play audible alarm if audio is ready
    await initAudio();
    if (audioReady && synth) {
        try {
            synth.triggerAttackRelease('C4', '8n');
        } catch (e) {
            console.warn('Audio playback failed:', e);
        }
    }
    
    await logSafety(duress ? "DURESS" : "PANIC", "Alert triggered.");
    
    // Mark panic in state
    if (state && state.activeVisit) {
        state.activeVisit.isPanic = true;
        if (duress) state.activeVisit.isDuress = true;
        saveState();
    }
}

// ============================================================================
// SAFETY HEARTBEAT (tick)
// ============================================================================
function tick() {
    if (state && state.activeVisit) {
        const remaining = state.activeVisit.duration - (Date.now() - state.activeVisit.startTime) / 1000;
        
        if (remaining <= 90 && !state.activeVisit.warningSent) {
            announce("Warning: 90 seconds remaining. Check out soon.");
            
            // Play warning beep if audio is ready
            if (audioReady && synth) {
                try {
                    synth.triggerAttackRelease('A4', '4n');
                } catch (e) {
                    console.warn('Audio playback failed:', e);
                }
            }
            
            state.activeVisit.warningSent = true;
            saveState();
        }
        
        if (remaining <= 0 && !state.activeVisit.criticalSent) {
            triggerPanic();
            state.activeVisit.criticalSent = true;
            saveState();
        }
    }
}

// ============================================================================
// VEHICLE CHECK
// ============================================================================
function checkVehicleStatus() {
    if (!state || !state.vehicle) return false;
    
    const now = new Date();
    const wofDate = new Date(state.vehicle.wofExpiry);
    const regoDate = new Date(state.vehicle.regoExpiry);
    
    if (wofDate < now || regoDate < now) {
        showModal('grounded');
        return true; // Grounded
    }
    return false;
}

// ============================================================================
// RENDER LOCATIONS
// ============================================================================
function renderLocations() {
    const list = document.getElementById('locationsList');
    if (!list || !state || !state.locations) return;
    
    list.innerHTML = '';
    state.locations.forEach(loc => {
        const tile = document.createElement('button');
        tile.classList.add('p-4', 'bg-gray-700', 'rounded-xl', 'w-full', 'text-left', 'mb-2', 'active:bg-gray-600', 'transition-colors');
        tile.innerText = loc.name;
        tile.onclick = () => {
            if (checkVehicleStatus()) return;
            state.activeVisit = { 
                locationName: loc.name, 
                startTime: Date.now(), 
                duration: 3600, // 1 hour
                isPanic: false,
                criticalSent: false,
                warningSent: false
            };
            saveState();
            enterLockedScreen();
        };
        list.appendChild(tile);
    });
}

// ============================================================================
// WIZARD NAVIGATION
// ============================================================================
function prevWiz() {
    if (!state || state.currentWizStep <= 1) return;
    
    document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
    state.currentWizStep--;
    document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
    
    const btnPrev = document.getElementById('btnWizPrev');
    const btnNext = document.getElementById('btnWizNext');
    
    if (state.currentWizStep === 1 && btnPrev) btnPrev.classList.add('hidden');
    if (btnNext) btnNext.innerText = "Next Step";
    
    saveState();
}

function nextWiz() {
    if (!state) return;
    
    if (state.currentWizStep < 3) {
        document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
        state.currentWizStep++;
        document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
        
        const btnPrev = document.getElementById('btnWizPrev');
        const btnNext = document.getElementById('btnWizNext');
        
        if (state.currentWizStep === 2 && btnPrev) btnPrev.classList.remove('hidden');
        if (state.currentWizStep === 3 && btnNext) btnNext.innerText = "Finish Setup";
        
        saveState();
    } else {
        saveWizard();
    }
}

function saveWizard() {
    const workerData = {
        name: document.getElementById('wizName').value.trim(),
        phone: document.getElementById('wizPhone').value.trim(),
        email: document.getElementById('wizEmail').value.trim(),
        pin: document.getElementById('wizPin').value,
        duress: document.getElementById('wizDuress').value,
        emgName: document.getElementById('wizContactName').value.trim(),
        emgPhone: document.getElementById('wizContactPhone').value.trim()
    };
    
    if (!workerData.name || !workerData.pin || !workerData.duress || 
        !workerData.phone || !workerData.email || 
        !workerData.emgName || !workerData.emgPhone) {
        return alert("Please complete all required fields.");
    }
    
    state.worker = workerData;
    state.pins.std = workerData.pin;
    state.pins.duress = workerData.duress;
    saveState();
    
    const setupPage = document.getElementById('setupPage');
    if (setupPage) setupPage.classList.remove('active');
    
    const headerName = document.getElementById('headerWorkerName');
    if (headerName) headerName.innerText = workerData.name;
    
    announce(`Welcome ${workerData.name}. System is now active.`);
    logSafety("Setup Complete", "Worker profile initialized.");
    navigate('main');
}

// ============================================================================
// INSTALL PROMPTS
// ============================================================================
function dismissInstall(type) {
    if (type === 'ios') {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.add('hidden');
    }
    localStorage.setItem('otg_install_dismissed', 'true');
}

function checkIosInstall() {
    const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
    
    // Use standard display-mode check with iOS fallback
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
    
    if (isIos && !isStandalone && !localStorage.getItem('otg_install_dismissed')) {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.remove('hidden');
    }
}

// ============================================================================
// PWA SETUP
// ============================================================================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(registration => {
            console.log('Service Worker registered:', registration.scope);
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        if (confirm('New version available. Update now?')) {
                            window.location.reload();
                        }
                    }
                });
            });
        })
        .catch(err => {
            console.error('Service Worker registration failed:', err);
        });
}

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    // Can show custom install button here
});

// ============================================================================
// CLEANUP ON UNLOAD
// ============================================================================
window.addEventListener('beforeunload', () => {
    stopGPSMonitoring();
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    if (travellingInterval) clearInterval(travellingInterval);
    if (timerInt) clearInterval(timerInt);
});

// ============================================================================
// INITIALIZATION
// ============================================================================
window.onload = () => {
    // Initialize state from storage or create new
    state = loadState() || {
        currentWizStep: 1,
        worker: {},
        pins: { std: '', duress: '' },
        activeVisit: null,
        pendingUploads: [],
        locations: [],
        globalForms: [],
        photoStore: {},
        settings: {},
        vehicle: { wofExpiry: '', regoExpiry: '' }
    };
    
    checkIosInstall();
    startGPSMonitoring();
    
    // Determine initial page
    if (!state.worker || !state.worker.name) {
        const setupPage = document.getElementById('setupPage');
        if (setupPage) setupPage.classList.add('active');
    } else {
        navigate(state.activeVisit ? 'locked' : 'main');
        if (state.activeVisit) {
            enterLockedScreen();
        }
        renderLocations();
    }
    
    // Setup touch interaction for inactivity timer
    document.addEventListener('touchstart', resetInactivityTimer, { passive: true });
    
    // Resume timers if there's an active visit
    if (state.activeVisit) {
        timerInt = setInterval(tick, 1000);
    }
    
    // Setup panic button long press
    setupLongPress('btnPanic', 3000, () => triggerPanic(false));
    
    console.log("System Initialized");
};
</script>

</body>
</html>
