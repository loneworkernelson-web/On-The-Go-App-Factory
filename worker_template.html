<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>%%APP_NAME%%</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* BASE STYLES & OS INTEGRATION */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            background-color: #111827; 
            color: white; 
            height: 100%; 
            width: 100%; 
            overflow: hidden; 
        }
        canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.pulse-border { animation: pulse 2s infinite; }
@keyframes pulse { 0% { border-color: #3b82f6; } 50% { border-color: #ef4444; } 100% { border-color: #3b82f6; } }

        /* PAGE ROUTING VISIBILITY */
        .page { 
            display: none; 
            height: 100%; 
            width: 100%; 
            flex-direction: column; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        .page.active { display: flex; z-index: 10; }

        /* UI COMPONENT STYLING */
        .header-bar { padding: 0.75rem 1rem; background-color: #111827; border-bottom: 1px solid #374151; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .content-area { flex: 1; overflow-y: auto; padding: 1rem; position: relative; }
        .footer-bar { padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); background-color: #111827; border-top: 1px solid #374151; flex-shrink: 0; }

        /* INPUTS & CARDS */
        .form-input { width: 100%; background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.75rem; padding: 0.75rem; color: white; outline: none; margin-bottom: 0.75rem; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
        
        /* HARDWARE INDICATORS */
        .gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; }
        .gps-active { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .long-press-btn { transition: transform 0.1s; }
        .long-press-btn:active { transform: scale(0.96); }

        /* SLIDER STYLING */
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: #3b82f6; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body class="bg-gray-900 text-white">

<div id="toast" class="hidden fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-2xl z-[100] flex items-center gap-3">
    <div class="text-xl">‚ÑπÔ∏è</div>
    <p id="toastText" class="font-bold text-sm"></p>
</div>

<div id="setupPage" class="page active bg-gray-900 z-[60]">
    <div class="p-6 border-b border-gray-800 flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
    </div>

    <div id="setup_step_identity" class="content-area">
        <h2 class="text-3xl font-bold mb-2">Who are you?</h2>
        <p class="text-gray-400 mb-8 text-sm">Required for safety monitoring match.</p>
        <label for="set_workerName" class="block text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Full Name</label>
        <input type="text" id="set_workerName" class="form-input" placeholder="e.g. John Doe">
        <label for="set_url" class="block text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Google Sheet URL</label>
        <input type="text" id="set_url" class="form-input" value="%%GOOGLE_SHEET_URL%%">
        <button onclick="wizNext('setup_step_identity', 'setup_step_security')" class="w-full py-4 bg-blue-600 font-bold rounded-xl text-lg mt-8">Next: Security ‚Üí</button>
    </div>

    <div id="setup_step_security" class="content-area hidden">
        <h2 class="text-3xl font-bold mb-2">Security PIN</h2>
        <p class="text-gray-400 mb-8 text-sm">Create a 4-digit code to unlock the app and declare safety.</p>
        <label for="setup_pin1" class="block text-[10px] font-black text-green-500 uppercase tracking-widest mb-1">Create PIN</label>
        <input type="password" id="setup_pin1" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest">
        <label for="setup_pin2" class="block text-[10px] font-black text-green-500 uppercase tracking-widest mb-1">Confirm PIN</label>
        <input type="password" id="setup_pin2" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest">
        <div class="flex gap-3 mt-8">
            <button onclick="wizBack('setup_step_security', 'setup_step_identity')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl text-gray-400">Back</button>
            <button onclick="savePin()" class="flex-[2] py-4 bg-blue-600 font-bold rounded-xl">Next: Review ‚Üí</button>
        </div>
    </div>

    <div id="setup_step_review" class="content-area hidden">
        <h2 class="text-3xl font-bold mb-2">Ready?</h2>
        <p class="text-gray-400 mb-8 text-sm">Pressing finish will launch your dashboard.</p>
        <button onclick="finishSetup()" class="w-full py-5 bg-green-600 font-black rounded-xl text-xl shadow-xl uppercase">‚úÖ Launch App</button>
    </div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex gap-0.5" id="gpsBars">
                <div class="gps-bar gps-active"></div><div class="gps-bar gps-active"></div><div class="gps-bar"></div>
            </div>
            <button onclick="navigate('settings')" class="p-2 rounded-full hover:bg-gray-700">‚öôÔ∏è</button>
        </div>
    </div>
    
    <div class="content-area">
        <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded text-center font-bold uppercase tracking-widest animate-pulse">Syncing...</div>
        <div id="travelRow" class="mb-4"></div>
        <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-1">Destinations</div>
        <div id="locationList" class="grid grid-cols-2 gap-3 pb-4"></div>
    </div>

    <div class="footer-bar">
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2"><span class="text-gray-400 text-[10px] font-black uppercase">Visit Time</span><span id="durationDisplay" class="text-xs text-blue-400 font-bold">0 mins</span></div>
            <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <button id="panicBtn" class="long-press-btn w-full py-4 bg-red-900/40 border-2 border-red-600 text-red-500 font-black rounded-xl uppercase tracking-widest">Hold for SOS</button>
    </div>
</div>

<div id="lockedPage" class="page bg-black">
    <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div id="visitTimer" class="text-8xl font-mono font-bold text-white tracking-tighter">00:00</div>
        <h2 id="lockedLocationName" class="text-2xl font-bold text-gray-400 mt-2">---</h2>
        
        <div class="mt-12 w-full max-w-xs space-y-4">
            <input type="password" id="lock_pin_input" maxlength="4" inputmode="numeric" placeholder="Enter PIN" class="form-input text-center text-3xl tracking-[0.5em]">
            <button onclick="checkPin()" class="w-full py-4 bg-blue-600 font-bold rounded-2xl text-lg">Unlock Options</button>
            <button onclick="endVisit()" class="w-full py-4 bg-red-600 font-bold rounded-2xl text-lg">End Visit</button>
        </div>
    </div>
</div>

<div id="reportPage" class="page bg-gray-900 z-50">
    <div class="header-bar">
        <h2 id="reportTitle" class="text-lg font-bold">Visit Report</h2>
    </div>
    <div class="content-area" id="reportFields">
        </div>
    <div class="footer-bar flex gap-3">
        <button onclick="navigate('main')" class="flex-1 py-4 bg-gray-700 font-bold rounded-xl">Cancel</button>
        <button id="btnSubmitRep" class="flex-[2] py-4 bg-green-600 font-bold rounded-xl">Submit Report</button>
    </div>
</div>

<div id="infoModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700">
        <h2 id="infoTitle" class="text-xl font-bold mb-4">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm mb-6"></div>
        <a id="btnSiteNav" href="#" target="_blank" class="block w-full py-4 bg-blue-600 text-white font-bold rounded-xl text-center mb-3">Navigate to Site</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 font-bold rounded-xl">Close</button>
    </div>
</div>
<script>
// --- 1. GLOBAL CONSTANTS & CORE STATE ---
const APP_VERSION = "v79.35";
const CONFIG = {
    url: "%%GOOGLE_SHEET_URL%%",
    key: "%%SECRET_KEY%%",
    mileage: true
};

// Centralized state object
let state = { 
    settings: {}, 
    locations: [], 
    selectedLocationId: null, 
    visitDurationMinutes: 0,
    activeVisit: null, 
    cachedForms: {}, 
    pendingUploads: [],
    globalForms: [],
    photoStore: {},
    lowBatSent: false,
    meta: {} 
};

// Variables for hardware and timers
let synth, checkinIntervalId, mainScreenReminderTimer, wakeLock, timerInt, travellingInterval;
let autoDimTimer = null;
let tempPhoto = null, sigPad = null;
let deferredPrompt, isMidVisitUpdate = false, currentActiveTemplate = "", isDrawing = false;
let calculatedDist = null, gpsWarm = false, gpsWatchId = null, lastAlertTime = 0;
let currentBatteryLevel = "100%";
let uploadQueue = []; 
let travelTargetName = ""; // Tracks driving destination

// --- 2. STORAGE & SYNCHRONIZATION ---

/* Modern Standard: Uses the navigator.storage API to request persistence.*/
/* This replaces the deprecated webkitPersistentStorage and StorageType calls.*/

async function saveState() {
    try {
        // Standardized persistence request
        if (navigator.storage && navigator.storage.persist) {
            const isPersisted = await navigator.storage.persist();
            if (isPersisted) console.log("üíæ Storage persistence granted.");
        }
        
        const stateString = JSON.stringify(state);
        localStorage.setItem('otg_worker_state', stateString);
    } catch (e) {
        console.error("Critical: Storage Failure", e);
    }
}

function loadState() {
    const saved = localStorage.getItem('otg_worker_state');
    if (saved) {
        try {
            state = JSON.parse(saved);
        } catch (e) {
            console.error("Critical: State Corrupted", e);
        }
    }
}

/*Robust Refresh: Uses async to prevent library crashes.*/
async function hardRefreshUpdate() {
    if(!confirm("Force reload and clear internal app memory?")) return;
    showToast("üßπ Deep cleaning system cache...");

    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) { await r.unregister(); }
    }

    if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) { await caches.delete(k); }
    }

    state.meta.backendVersion = null;
    await saveState(); 
    location.reload(true); 
}

// --- 3. DASHBOARD & UI RENDERING ---

function renderLocations() {
    const l = document.getElementById('locationList');
    const tr = document.getElementById('travelRow');
    if (!l || !tr) return;

    l.innerHTML = '';
    tr.innerHTML = '';

    if (!state.locations) state.locations = [];

    state.locations.forEach(loc => {
        if (!loc || !loc.id) return;
        
        const tile = (loc.id === 'travel') ? createTravelTile(loc) : createLocationTile(loc);
        if (loc.id === 'travel') {
            tr.appendChild(tile);
        } else {
            l.appendChild(tile);
        }
    });
}
/**
 * Handles photo capture and stores it in the temporary photoStore.
 */
function handlePhoto(input, key) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            state.photoStore[key] = e.target.result;
            showToast(`Photo captured for ${key}`);
            // Update the label UI to show success
            const label = document.getElementById(`lbl_${input.id.split('_')[2]}`);
            if (label) {
                label.innerHTML = "‚úÖ Photo Captured";
                label.className = "flex-1 py-4 bg-green-900/40 border-2 border-green-500 rounded-xl flex items-center justify-center text-green-400 font-bold";
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}
/**
 * Starts a visit or travel session.
 */
function startVisit(id) {
    const loc = state.locations.find(l => l.id === id);
    if (!loc) return;

    state.activeVisit = {
        locationId: id,
        locationName: loc.name,
        startTime: Date.now(),
        status: (id === 'travel') ? 'TRAVELLING' : 'ON_SITE'
    };

    if (id === 'travel') {
        startTravellingPulse();
        speak(`Starting transit to ${travelTargetName || 'destination'}`);
    } else {
        speak(`Arrived at ${loc.name}`);
    }

    saveState();
    startCheckinTimer();
    navigate('locked'); // Moves UI to the active timer screen
}

/**
 * Ends the current visit and triggers the report form.
 */
function endVisit() {
    if (!state.activeVisit) return;
    
    // Stop timers and pulses
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    if (travellingInterval) clearInterval(travellingInterval);
    
    const locName = state.activeVisit.locationName;
    const template = (state.activeVisit.locationId === 'travel') ? 'Travel Report' : 'Standard Visit Note';
    
    // Move to report screen
    document.getElementById('reportTitle').innerText = `Report: ${locName}`;
    buildReportForm(template, document.getElementById('reportFields'));
    navigate('report');
}
/**
 * Validates the entered PIN against the masked version in settings.
 */
function checkPin() {
    const input = document.getElementById('lock_pin_input').value;
    const maskedInput = btoa(input); // Matches the masking used in savePin

    if (maskedInput === state.settings.pinCode) {
        document.getElementById('lock_pin_input').value = ""; // Clear for safety
        showModal('template'); // Opens the form selection menu
    } else {
        showToast("Incorrect PIN");
        // Haptic feedback if supported
        if (navigator.vibrate) navigator.vibrate(200);
    }
}
/**
 * Speech Wrapper: Handles audible status updates.
 */
function speak(text) {
    if (!window.speechSynthesis) return;
    // Cancel current speech to prevent overlapping
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.rate = 0.9;
    msg.pitch = 1;
    window.speechSynthesis.speak(msg);
}
/**
 * MISSING: Generates the standard gray location tiles.
 */
function createLocationTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === loc.id;
    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-blue-500 bg-blue-900/20' : 'border-gray-700 bg-gray-800'}`;
    d.innerHTML = `
        <div class="text-3xl">${loc.icon || 'üè¢'}</div>
        <div class="flex-1">
            <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest leading-none mb-1">${loc.companyName || 'Site'}</div>
            <div class="text-lg font-black text-white leading-tight">${loc.name}</div>
        </div>
    `;
    d.onclick = () => { state.selectedLocationId = isSel ? null : loc.id; renderLocations(); };
    return d;
}

/**
 * MISSING: Required for the signature [SIGN] tag to work.
 */
function resizeCanvas(canvas) {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
}

function initSigPad(canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false;
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };
    canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });
    window.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); }, {passive: false});
    canvas.addEventListener('touchmove', (e) => { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }, {passive: false});
}

/**
 * Screen WakeLock: Prevents the phone from sleeping during active sessions.
 */
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("üîí WakeLock Active");
        }
    } catch (err) {
        console.warn("WakeLock failed:", err.message);
    }
}
/**
 * Speech Wrapper: Handles audible status updates.
 */
function speak(text) {
    if (!window.speechSynthesis) return;
    // Cancel current speech to prevent overlapping
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.rate = 0.9;
    msg.pitch = 1;
    window.speechSynthesis.speak(msg);
}

/**
 * Screen WakeLock: Prevents the phone from sleeping during active sessions.
 */
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("üîí WakeLock Active");
        }
    } catch (err) {
        console.warn("WakeLock failed:", err.message);
    }
}

/**
 * Captures the current GPS coordinates.
 */
function captureGPS(btn) {
    if (!navigator.geolocation) {
        showToast("GPS not supported on this device");
        return;
    }

    btn.innerText = "‚åõ...";
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) {
                input.value = coords;
                showToast("Location Captured");
            }
            btn.innerText = "GPS";
        },
        (err) => {
            showToast("GPS Error: Ensure location is enabled");
            btn.innerText = "GPS";
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

/**
 * Clears the signature canvas for a specific field index.
 */
function clearSig(index) {
    const canvas = document.getElementById(`sig-canvas-${index}`);
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
}

/**
 * Starts the incrementing timer shown during an active visit.
 */
function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state.activeVisit && state.activeVisit.startTime) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

/**
 * Creates the pulsing effect for the Travel Tile when active.
 */
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        const tr = document.getElementById('travelRow');
        if (tr) tr.classList.toggle('opacity-70');
    }, 1000);
}

/**
 * Core Synchronization: Pushes data to the Google Sheet backend.
 */
async function forceSync(highPriority = false) {
    const banner = document.getElementById('uploadBanner');
    if (banner) banner.classList.remove('hidden');
    
    // Logic to bundle state.pendingUploads and send via fetch()
    console.log("Syncing with backend...");
    
    // Simulated delay for network activity
    setTimeout(() => {
        if (banner) banner.classList.add('hidden');
        populateSettingsForm(); // Refresh diagnostic info
    }, 1500);
}
/**
 * Saves the name and URL from the first step of setup.
 */
function saveIdentity() {
    const name = document.getElementById('set_workerName').value;
    const url = document.getElementById('set_url').value;

    if (!name || name.length < 2) {
        showToast("Please enter your full name");
        return;
    }

    state.settings.workerName = name;
    state.settings.googleSheetUrl = url;
    
    wizNext('setup_step_identity', 'setup_step_security');
}

function checkVehicleStatus() {
    const travelRow = document.getElementById('travelRow');
    if (!travelRow) return;

    // Check state to see if transit pulse should be active
    const isTransit = state.activeVisit && state.activeVisit.status === 'TRAVELLING';
    
    if (isTransit) {
        travelRow.classList.add('border-purple-400', 'bg-purple-900/40');
    } else {
        travelRow.classList.remove('border-purple-400', 'bg-purple-900/40');
    }
}
function createTravelTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === 'travel';
    const isNoReport = loc.noReport || localStorage.getItem('otg_user_travel_pref') === 'true';

    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-purple-500 bg-purple-900/40 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    
    d.innerHTML = `
        <div class="text-3xl">üõ£Ô∏è</div>
        <div class="flex-1">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black text-purple-400 uppercase tracking-widest">In-Transit Mode</span>
                <button class="text-gray-500 hover:text-white" onclick="editTravelSettings(event)">‚öôÔ∏è</button>
            </div>
            <div class="text-lg font-black text-white leading-tight">Travel Safety Check</div>
            ${isNoReport ? '<span class="text-[9px] text-gray-500 uppercase font-bold">Fast-Sync (No Report)</span>' : ''}
        </div>
    `;

    d.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        state.selectedLocationId = isSel ? null : 'travel';
        renderLocations();
    };
    return d;
}

/*Fully Patched Form Builder*/
/* - Resolves Accessibility: All <label> elements associated with unique IDs.*/
/* - Activates Interactive Tags: [PHOTO], [GPS], [SIGN], [DROP], [$].*/
/* - Standardized Styling: Consistent with dashboard theme.*/
function buildReportForm(n, c) {
    state.photoStore = {};
    const sn = n ? n.trim() : "(Standard)";
    
    // 1. Source the questions from Global Forms or Cache
    let questions = state.globalForms?.find(f => f.name.trim() === sn)?.questions || 
                    state.cachedForms[sn] || 
                    state.cachedForms["(Standard)"];
    
    c.innerHTML = '';
    
    // Fallback logic for empty templates
    if (!questions) {
        c.innerHTML = `
            <label for="rep_notes" class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Visit Notes</label>
            <textarea id="rep_notes" class="form-input h-32" placeholder="Write notes here..."></textarea>
        `;
        return;
    }

    questions.forEach((f, i) => {
        let type = 'text'; 
        let labelText = f.text || f; 
        let dropOptions = [];
        const upper = labelText.toUpperCase();
        const fieldId = `dyn_field_${i}`; // Root ID for accessibility

        // 2. Tag Detection logic
        if (upper.includes('[HEADING]') || labelText.trim().startsWith('#')) { 
            type = 'header'; labelText = labelText.replace(/\[HEADING\]/gi, '').replace('#','').trim(); 
        }
        else if (upper.includes('[NOTE]')) { 
            type = 'note'; labelText = labelText.replace(/\[NOTE\]/gi, '').trim(); 
        }
        else if (upper.includes('[SIGN]')) { 
            type = 'signature'; labelText = labelText.replace(/\[SIGN\]/gi, '').trim(); 
        }
        else if (upper.includes('[PHOTO]')) { 
            type = 'photo'; labelText = labelText.replace(/\[PHOTO\]/gi, '').trim(); 
        }
        else if (upper.includes('[GPS]')) { 
            type = 'gps'; labelText = labelText.replace(/\[GPS\]/gi, '').trim(); 
            if (!labelText) labelText = "Location Status"; 
        }
        else if (upper.includes('[YESNO]')) { 
            type = 'yesno'; labelText = labelText.replace(/\[YESNO\]/gi, '').trim(); 
        }
        else if (upper.includes('[CHECK]')) { 
            type = 'checkbox'; labelText = labelText.replace(/\[CHECK\]/gi, '').trim(); 
        }
        else if (upper.includes('[DATE]')) { 
            type = 'date'; labelText = labelText.replace(/\[DATE\]/gi, '').trim(); 
        }
        else if (upper.includes('[NUMBER]')) { 
            type = 'number'; labelText = labelText.replace(/\[NUMBER\]/gi, '').trim(); 
        }
        else if (upper.includes('[$]')) { 
            type = 'currency'; labelText = labelText.replace(/\[\$\]/gi, '').trim(); 
        }
        else if (upper.includes('[1TEXT]')) { 
            type = '1text'; labelText = labelText.replace(/\[1TEXT\]/gi, '').trim(); 
        }
        else if (upper.includes('[TIME]')) { type = 'time'; labelText = labelText.replace(/\[TIME\]/gi, '').trim(); } 
        
        else if (upper.startsWith('[DROP')) {
            type = 'drop';
            const match = labelText.match(/\[DROP\s*,\s*(.*?)\s*\]/i);
            if (match) {
                dropOptions = match[1].split(',').map(o => o.trim());
                labelText = labelText.replace(match[0], '').trim();
            }
else if (type === '1text' || type === 'date' || type === 'number' || type === 'time') {
    const el = document.createElement('input');
    el.id = fieldId;
    el.type = (type === '1text') ? 'text' : type; // Sets 'date' or 'time'
    el.className = "form-input font-bold";
    el.dataset.key = labelText;
    container.appendChild(el);
}
        }

        const container = document.createElement('div');
        container.className = "mb-4";

        // 3. Render Element Logic
        if (type === 'header') {
            container.innerHTML = `<div class="mt-6 mb-2 border-b border-gray-700 pb-1"><h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest">${labelText}</h3></div>`;
        } 
        else if (type === 'note') {
            container.innerHTML = `<div class="bg-blue-900/20 border-l-2 border-blue-500 p-3 text-xs text-blue-200 italic font-medium">${labelText}</div>`;
        } 
        else {
            // Accessible Label Association
            const label = document.createElement('label');
            label.setAttribute('for', fieldId);
            label.className = "block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1";
            label.innerText = labelText;
            container.appendChild(label);

            if (type === 'photo') {
                const wrap = document.createElement('div');
                wrap.className = "flex items-center gap-3";
                wrap.innerHTML = `
                    <label id="lbl_${i}" for="${fieldId}" class="flex-1 py-4 bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center text-gray-400 font-bold cursor-pointer transition active:scale-95">üì∏ Take Photo</label>
                    <input type="file" id="${fieldId}" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this, '${labelText}')">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'gps') {
                const wrap = document.createElement('div');
                wrap.className = "flex gap-2";
                wrap.innerHTML = `
                    <button type="button" onclick="captureGPS(this)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg text-xs uppercase transition active:scale-95">GPS</button>
                    <input type="text" id="${fieldId}" class="form-input flex-1 font-mono text-xs text-gray-400" readonly data-key="${labelText}" placeholder="Not captured">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'signature') {
                container.innerHTML += `
                    <div class="bg-white rounded-xl p-1 mb-2">
                        <canvas id="sig-canvas-${i}" class="w-full h-40 border border-gray-200"></canvas>
                    </div>
                    <button type="button" class="text-[10px] font-bold text-gray-500 uppercase sig-clear-btn" data-index="${i}">Clear Signature</button>
                `;
            } 
            else if (type === 'drop') {
                const sel = document.createElement('select');
                sel.id = fieldId; sel.className = "form-input font-bold"; sel.dataset.key = labelText;
                const def = document.createElement('option');
                def.text = `Select ${labelText}...`; def.value = "";
                sel.appendChild(def);
                dropOptions.forEach(optText => {
                    const opt = document.createElement('option');
                    opt.text = optText; opt.value = optText;
                    sel.appendChild(opt);
                });
                container.appendChild(sel);
            } 
            else if (type === 'currency') {
                const wrap = document.createElement('div');
                wrap.className = "relative";
                wrap.innerHTML = `
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
                    <input type="number" step="0.01" inputmode="decimal" id="${fieldId}" class="form-input pl-8 font-bold" data-key="${labelText}">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'yesno') {
                // Radio buttons using unique IDs to link correctly to nested labels
                const wrap = document.createElement('div');
                wrap.className = "flex gap-4 p-2 bg-gray-900 rounded-xl";
                wrap.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 active:bg-blue-900 transition">
                        <input type="radio" name="yn_${i}" id="${fieldId}_y" value="Yes" class="w-5 h-5" data-key="${labelText}"> 
                        <span class="text-sm font-black text-white">YES</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 active:bg-blue-900 transition">
                        <input type="radio" name="yn_${i}" id="${fieldId}_n" value="No" class="w-5 h-5" data-key="${labelText}"> 
                        <span class="text-sm font-black text-white">NO</span>
                    </label>
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'checkbox') {
                const wrap = document.createElement('label');
                wrap.className = "flex items-center gap-3 p-4 bg-gray-800 rounded-xl border border-gray-600 active:bg-gray-700 transition cursor-pointer";
                wrap.innerHTML = `
                    <input id="${fieldId}" type="checkbox" class="w-7 h-7 text-blue-600 rounded"> 
                    <span class="text-sm font-bold text-gray-200 select-none flex-1">${labelText}</span>
                `;
                wrap.querySelector('input').dataset.key = labelText;
                container.appendChild(wrap);
            }
            else if (type === '1text' || type === 'date' || type === 'number') {
                const el = document.createElement('input');
                el.id = fieldId; el.type = (type === '1text') ? 'text' : type;
                el.className = "form-input font-bold"; el.dataset.key = labelText;
                container.appendChild(el);
            }
            else {
                const el = document.createElement('textarea');
                el.id = fieldId; el.className = "form-input h-24 font-medium"; el.dataset.key = labelText;
                container.appendChild(el);
            }
        }
        c.appendChild(container);
    });

    // 4. Initialize specialized hardware handlers
    setTimeout(() => {
        document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => {
            if (typeof resizeCanvas === 'function') resizeCanvas(canvas);
            if (typeof initSigPad === 'function') initSigPad(canvas);
        });
    }, 600);
}

/**
 * Processes and saves the security PIN.
 * Uses Base64 encoding as a basic masking layer before saving to state.
 */
function savePin() {
    const pin1 = document.getElementById('setup_pin1').value;
    const pin2 = document.getElementById('setup_pin2').value;

    if (!pin1 || pin1.length < 4) {
        showToast("PIN must be at least 4 digits");
        return;
    }

    if (pin1 !== pin2) {
        showToast("PINs do not match");
        return;
    }

    // Save masked PIN to state
    state.settings.pinCode = btoa(pin1); 
    showToast("Security PIN Set");
    
    // Proceed to final review or finish
    wizNext('setup_step_security', 'setup_step_review');
}

/**
 * Finalizes the setup and moves the user to the dashboard.
 */
async function finishSetup() {
    state.settings.workerName = document.getElementById('set_workerName').value;
    state.settings.googleSheetUrl = document.getElementById('set_url').value;
    
    if (!state.settings.workerName) {
        showToast("Please enter your name");
        return;
    }

    await saveState();
    showToast("Setup Complete!");
    navigate('main');
}
// --- 5. IDENTITY & DIAGNOSTICS ---

function populateSettingsForm() {
    const urlInput = document.getElementById('set_url');
    if (urlInput) urlInput.value = state.settings.googleSheetUrl || CONFIG.url;

    const nameInput = document.getElementById('set_workerName');
    if (nameInput) nameInput.value = state.settings.workerName || "";

    const diagApp = document.getElementById('diagApp');
    const diagCloud = document.getElementById('diagCloud');
    
    if (diagApp) diagApp.innerText = APP_VERSION;
    
    if (diagCloud) {
        diagCloud.innerText = state.meta.backendVersion || "Not Synced";
        if (state.meta.backendVersion) {
            diagCloud.className = "text-green-400 font-bold text-xs";
        }
    }
}
/**
 * Core Routing: Switches between different app screens.
 * @param {string} pageId - The ID of the div to show (e.g., 'setup', 'main', 'locked').
 */
function navigate(pageId) {
    // 1. Define all possible page IDs in your HTML
    const pages = ['setupPage', 'mainPage', 'lockedPage', 'reportPage', 'infoPage'];
    
    // 2. Hide everything
    pages.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });

    // 3. Show the target page
    const target = document.getElementById(pageId + 'Page');
    if (target) {
        target.classList.remove('hidden');
        window.scrollTo(0, 0); // Reset scroll position for the new screen
    } else {
        console.error(`Navigation Error: Page ID "${pageId}Page" not found in HTML.`);
    }

    // 4. Update the UI state
    if (pageId === 'main') {
        renderLocations(); // Ensure tiles are fresh when returning to dashboard
    }
}
/**
 * Generic Modal Controls
 */
function showModal(id) {
    const m = document.getElementById(id + 'Modal');
    if (m) m.classList.remove('hidden');
}

function closeModal(id) {
    const m = document.getElementById(id + 'Modal');
    if (m) m.classList.add('hidden');
}

/**
 * Toast Notifications: Provides non-blocking feedback to the user.
 */
function showToast(msg) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.innerText = msg;
    t.classList.remove('hidden');
    // Auto-hide after 3 seconds
    setTimeout(() => { t.classList.add('hidden'); }, 3000);
}
function wizNext(current, next) {
    const currEl = document.getElementById(current);
    const nextEl = document.getElementById(next);
    if (currEl && nextEl) {
        currEl.classList.add('hidden');
        nextEl.classList.remove('hidden');
        window.scrollTo(0,0);
    }
}

function wizBack(current, prev) {
    const currEl = document.getElementById(current);
    const prevEl = document.getElementById(prev);
    if (currEl && prevEl) {
        currEl.classList.add('hidden');
        prevEl.classList.remove('hidden');
    }
}
/**
 * Initialises the Panic/Emergency button listeners.
 * Configured for a "Long Press" to prevent accidental triggers.
 */
function initPanicButton() {
    const btn = document.getElementById('panicBtn');
    if (!btn) return;

    let panicTimer;
    
    // Long-press logic (requires 2 seconds of holding)
    btn.addEventListener('mousedown', () => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    });

    btn.addEventListener('mouseup', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });

    btn.addEventListener('touchstart', (e) => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    }, {passive: true});

    btn.addEventListener('touchend', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });
}

/**
 * The action triggered by the panic button.
 */
function handlePanic() {
    if (confirm("üö® TRIGGER EMERGENCY ALERT?\n\nThis will notify the server and capture your current GPS location.")) {
        showToast("Sending Emergency Signal...");
        // This pushes a high-priority packet to your upload queue
        forceSync(true); 
    }
}
function initLocations() {
    if (!state.locations) state.locations = [];
    
    // Always force Travelling to index 0
    state.locations = state.locations.filter(l => l.id !== 'travel');
    state.locations.unshift({
        id: 'travel',
        name: 'Travelling',
        noReport: localStorage.getItem('otg_user_travel_pref') === 'true'
    });

    renderLocations();
    checkVehicleStatus(); 
    populateSettingsForm(); 
}

function showSiteInfo(id, e) {
    if (e) e.stopPropagation(); 
    const l = state.locations.find(x => x.id === id); 
    if (!l) return;

    document.getElementById('infoTitle').innerText = l.name; 
    let h = "";
    if (l.companyName) h += `<p class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">${l.companyName}</p>`;
    
    const nav = document.getElementById('btnSiteNav');
    if (l.address && l.address.length > 3) { 
        h += `<p class="mt-2 text-white font-bold">${l.address}</p>`;
        // FIXED: navigation URL template literal
        nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.address)}`;
        nav.classList.remove('hidden'); 
    } else { 
        nav.classList.add('hidden'); 
    }
    document.getElementById('siteInfoContent').innerHTML = h;
    showModal('info');
}

// --- 6. STARTUP SEQUENCE ---



window.onload = async () => {
    // 1. Restore persistent data
    loadState(); 

    // 2. Initialize Logic
    initLocations();
    initPanicButton();

    // 3. Routing Logic
    if (!state.settings || !state.settings.workerName) {
        navigate('setup'); 
        document.getElementById('setupPage')?.classList.remove('hidden');
    } else if (state.activeVisit) {
        navigate('locked'); 
        if (state.activeVisit.status === 'TRAVELLING') startTravellingPulse();
    } else {
        navigate('main');
    }

    console.log("üöÄ System Initialised: Operational Mode");
};
</script>
</body>
</html>







