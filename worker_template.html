<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>%%ORG_NAME%%</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; }
.page { display: none; height: 100%; flex-direction: column; }
.page.active { display: flex; }
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width linear; }
.long-press-btn.pressing::after { width: 100%; }
.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.form-input { @apply w-full bg-gray-900 border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none; }
</style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

<div id="app-container" class="h-full flex flex-col">

<div id="mainPage" class="page active p-4 bg-gray-800">
    <header class="flex justify-between items-center mb-4 flex-shrink-0">
        <div class="flex items-center gap-2">
            <img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'">
            <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
        </div>
        <button type="button" id="settingsBtn" class="p-2 rounded-full hover:bg-gray-700">‚öôÔ∏è</button>
    </header>

    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 flex-shrink-0">
        <div class="spinner"></div> Syncing <span id="queueCount">0</span> offline reports...
    </div>

    <div class="flex-1 overflow-y-auto mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700 min-h-0">
        <div id="locationList" class="space-y-2"></div>
        <button type="button" id="addLocationBtn" class="mt-4 w-full py-3 border-2 border-dashed border-gray-600 text-gray-400 rounded hover:border-gray-500 hover:text-white transition">+ Add Location</button>
    </div>

    <div class="mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700 flex-shrink-0">
        <div class="flex justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase font-bold">Duration</span>
            <span id="durationDisplay" class="font-bold text-blue-400">0 min</span>
        </div>
        <input id="durationSlider" type="range" min="0" max="14" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
    </div>

    <div class="flex gap-2 flex-shrink-0">
        <button type="button" id="quickStatBtn" class="hidden flex-1 py-5 bg-teal-900 text-teal-500 font-bold rounded-xl text-lg opacity-50 transition" disabled>Quick Stat</button>
        <button type="button" id="arrivedBtn" class="long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all" disabled>Select Location</button>
    </div>
</div>

<div id="lockedPage" class="page p-6 text-center justify-between bg-gray-900">
    <div class="flex justify-end">
        <button type="button" id="panicBtn" class="w-20 h-20 bg-red-600 rounded-full font-bold text-white text-xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center">SOS</button>
    </div>
    
    <div>
        <p class="text-gray-500 text-sm uppercase tracking-widest">Currently At</p>
        <h2 id="lockedLocationName" class="text-3xl font-bold text-white mb-6 mt-1 truncate px-2"></h2>
        <div id="countdownTimer" class="text-7xl font-bold font-mono text-white tracking-tighter">00:00</div>
        <p class="text-gray-400 mt-2">Due: <span id="lockedAnticipatedTime" class="text-blue-400 font-bold"></span></p>
    </div>

    <div class="space-y-4 w-full">
        <button type="button" id="extendBtn" class="long-press-btn w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Extend 10m</button>
        <button type="button" id="departBtn" class="long-press-btn w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl text-lg shadow-lg">DEPART</button>
        <button type="button" id="iamSafeBtn" class="hidden long-press-btn w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">I AM SAFE</button>
    </div>
</div>

<div id="settingsPage" class="page p-6 bg-gray-800">
    <header class="flex justify-between mb-6 flex-shrink-0">
        <h1 class="text-3xl font-bold text-white">Settings</h1>
        <button type="button" id="closeSettingsBtn" class="text-3xl text-gray-400 hover:text-white">√ó</button>
    </header>
    
    <div class="space-y-6 flex-1 overflow-y-auto pb-4">
        <p class="text-xs text-gray-400 bg-gray-900 p-2 rounded border border-gray-700">Please use international format for phone numbers (e.g. +64 21...).</p>
        
        <div><label class="text-xs text-blue-400 uppercase font-bold">Your Details *</label><input id="workerName" class="form-input mb-2" placeholder="Full Name"><input id="workerPhone" type="tel" class="form-input" placeholder="Phone (+64...)"></div>
        <div><label class="text-xs text-green-400 uppercase font-bold">Emergency Contact *</label><input id="emergencyName" class="form-input mb-2" placeholder="Name"><input id="emergencyPhone" type="tel" class="form-input mb-2" placeholder="Phone (+64...)"><input id="emergencyEmail" type="email" class="form-input" placeholder="Email"></div>
        <div><label class="text-xs text-purple-400 uppercase font-bold">Escalation Contact</label><input id="escalationName" class="form-input mb-2" placeholder="Name"><input id="escalationPhone" type="tel" class="form-input mb-2" placeholder="Phone (+64...)"><input id="escalationEmail" type="email" class="form-input" placeholder="Email"></div>
        <div><label class="text-xs text-red-400 uppercase font-bold">Security (4 Digits) *</label><input id="pinCode" type="tel" maxlength="4" class="form-input mb-2" placeholder="Normal PIN"><input id="duressPin" type="tel" maxlength="4" class="form-input" placeholder="Duress PIN"></div>
        
        <div class="pt-6 border-t border-gray-700">
            <p class="text-xs text-gray-500 mb-2">System URL</p>
            <input id="googleSheetUrl" disabled class="form-input text-xs font-mono text-gray-500" value="%%GOOGLE_SHEET_URL%%">
            
            <div class="mt-6 pt-4 border-t border-gray-700">
                 <label class="block text-sm font-medium text-gray-400 mb-2">Troubleshooting</label>
                 <button type="button" id="clearCacheBtn" class="w-full bg-red-900/50 text-red-400 hover:bg-red-900/70 font-bold py-3 px-4 rounded-lg text-sm">Reset App Data</button>
                 <button type="button" onclick="clearFormsCache()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-sm mt-2">Force Sync Forms</button>
            </div>
        </div>
    </div>
    
    <button type="button" id="saveSettingsBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg mt-2 flex-shrink-0">Save Settings</button>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
    
    <div id="locationModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
        <h2 id="locationModalTitle" class="text-xl font-bold mb-4 text-white">Edit Location</h2>
        <input type="hidden" id="locId"> <div class="space-y-4">
            <div><label class="text-xs text-gray-400 uppercase font-bold">Name</label><input type="text" id="locationName" class="form-input"></div>
            <div><label class="text-xs text-gray-400 uppercase font-bold">Address</label><input type="text" id="locationAddress" class="form-input"></div>
            
            <div id="advLocOptions" class="pt-2 border-t border-gray-700">
               <label class="flex items-center justify-between p-2 bg-gray-900 rounded cursor-pointer mb-2">
                 <span class="text-sm text-gray-300">No Report Required</span>
                 <input type="checkbox" id="noReportRequired" class="w-5 h-5 rounded bg-gray-700 border-gray-500 text-blue-600">
               </label>
               <div><label class="text-xs text-gray-400 uppercase font-bold">Template Name</label><input type="text" id="templateName" class="form-input text-sm" placeholder="(Standard)"><p class="text-xs text-gray-500 mt-1">Must match 'Checklists' sheet.</p></div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="deleteLocationBtn" class="bg-red-900/50 text-red-400 font-bold py-2 px-4 rounded-lg hidden">Delete</button>
            <div class="flex-1"></div>
            <button type="button" id="cancelLocationBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button type="button" id="saveLocationBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
        </div>
    </div>

    <div id="pinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6 text-center">
         <h2 class="text-xl font-bold mb-4 text-white">Enter PIN</h2>
         <input type="password" id="pinInput" maxlength="4" class="text-center text-3xl tracking-[1em] w-48 mx-auto bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-blue-500" inputmode="numeric">
         <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancelPinBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button type="button" id="confirmPinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
         </div>
    </div>

    <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="alertModalTitle" class="text-xl font-bold mb-2 text-white">Alert</h2>
        <p id="alertModalMessage" class="text-gray-300 mb-6"></p>
        <button type="button" id="alertModalOkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button>
    </div>

    <div id="checkinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center border-4 border-yellow-500">
        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Are you OK?</h2>
        <p class="text-lg text-gray-300 mb-4">Scheduled safety check.</p>
        <div id="checkinCountdown" class="text-6xl font-bold text-yellow-400 mb-6 font-mono">2:00</div>
        <button type="button" id="checkinOkBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">I am OK</button>
    </div>

    <div id="reportModal" class="hidden bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl">
      <h2 class="text-2xl font-bold text-white mb-6 flex-shrink-0" id="reportTitle">Visit Report</h2>
      <div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2"></div>
      <div class="flex gap-3 flex-shrink-0">
        <button type="button" id="cancelReportBtn" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button>
        <button type="button" id="submitReportBtn" class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit</button>
      </div>
    </div>

</div>
</div>

<script>
// --- CONFIG & STATE ---
const CONFIG = { isAdv: %%IS_ADVANCED%%, mileage: %%ENABLE_MILEAGE%%, url: "%%GOOGLE_SHEET_URL%%", org: "%%ORGANISATION_NAME%%", checkinEnabled: true }; 
const DURATION_STEPS = [0, 10, 15, 20, 30, 45, 60, 75, 90, 105, 120, 150, 180, 240, 300];
let state = { settings: {}, locations: [], selectedLocationId: null, visitDurationMinutes: 0, activeVisit: null, cachedForms: {}, pendingUploads: [] };
let synth, checkinCountdownInterval, lastBatteryReportTime = 0, mainScreenReminderTimer = null, wakeLock = null, timerInt = null, tempPhoto=null, sigPad=null;

// --- INITIALIZATION ---
window.addEventListener('load', () => {
    // Load State
    const savedState = JSON.parse(localStorage.getItem('loneWorkerState'));
    const defaultState = { settings: {}, locations: [], pendingUploads: [], cachedForms: {} };
    state = { ...defaultState, ...savedState };
    
    // Config Enforcements
    state.settings.googleSheetUrl = CONFIG.url; // Force URL update
    
    if(CONFIG.mileage) {
        if(!state.locations) state.locations = [];
        if(!state.locations.find(l => l.id === 'travel')) {
            state.locations.unshift({ id: 'travel', name: 'Travelling', address: 'Calculates Mileage via GPS', noReport: false, companyName: 'Internal', templateName: 'Travel Report' });
        }
    } else if(state.locations) {
        state.locations = state.locations.filter(l => l.id !== 'travel');
    }

    // UI Toggles
    if(CONFIG.isAdv) {
        document.getElementById('btnQuick').classList.remove('hidden');
        document.getElementById('advLocOptions').classList.remove('hidden');
        syncForms();
    } else {
        document.getElementById('advLocOptions').classList.add('hidden');
    }

    // Navigation Logic
    if(!state.settings.pinCode || !state.settings.workerName) {
        navigate('settings');
        document.getElementById('closeSettingsBtn').style.display = 'none';
    } else if(state.activeVisit) {
        enterLockedScreen();
    } else {
        navigate('main');
        renderLocations();
    }
    
    // Startup Processes
    updateArrivedButtonState();
    processUploadQueue();
    document.body.addEventListener('click', initAudio, { once: true });
});

// --- CORE FUNCTIONS ---
function navigate(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page + 'Page').classList.add('active');
    
    if(page === 'settings') {
        // Populate inputs
        ['workerName','workerPhone','emergencyName','emergencyPhone','emergencyEmail','escalationName','escalationPhone','escalationEmail','pinCode','duressPin'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = state.settings[id] || "";
        });
        document.getElementById('googleSheetUrl').value = state.settings.googleSheetUrl;
    }
}

function saveState() { localStorage.setItem('loneWorkerState', JSON.stringify(state)); }

// --- AUDIO ENGINE (RESTORED) ---
async function initAudio() {
    if(synth) return;
    await Tone.start();
    synth = new Tone.Synth().toDestination();
}

function playSoundAndVibrate(action) {
    initAudio().then(() => {
        const now = Tone.now();
        switch(action) {
            case 'arrive': synth.triggerAttackRelease("C4", "8n", now); synth.triggerAttackRelease("G4", "8n", now + 0.2); if(navigator.vibrate) navigator.vibrate(50); break;
            case 'depart': synth.triggerAttackRelease("G4", "8n", now); synth.triggerAttackRelease("C4", "8n", now + 0.2); if(navigator.vibrate) navigator.vibrate(50); break;
            case 'extend': synth.triggerAttackRelease("A4", "16n", now); if(navigator.vibrate) navigator.vibrate(50); break;
            case 'safe': synth.triggerAttackRelease("C5", "8n", now); if(navigator.vibrate) navigator.vibrate([50,50,50]); break;
            case 'warning': synth.triggerAttackRelease("E5", "16n", now); synth.triggerAttackRelease("G5", "16n", now + 0.2); if(navigator.vibrate) navigator.vibrate([800,200]); break;
            case 'panic': synth.triggerAttackRelease("G5", "16n", now); synth.triggerAttackRelease("G5", "16n", now+0.1); synth.triggerAttackRelease("G5", "16n", now+0.2); if(navigator.vibrate) navigator.vibrate([200,100,200]); break;
            case 'checkin': synth.triggerAttackRelease("A4", "16n", now); break;
        }
    });
}

// --- LOCATION LOGIC ---
function renderLocations() {
    const list = document.getElementById('locationList');
    list.innerHTML = '';
    state.locations.forEach(l => {
        const el = document.createElement('div');
        el.className = 'p-4 bg-gray-800 rounded-lg border-2 border-transparent hover:border-blue-500 cursor-pointer flex justify-between items-center group transition-all';
        if(state.selectedLocationId === l.id) el.classList.add('border-blue-500', 'bg-gray-700');
        
        let html = `<div><div class="font-bold text-white text-lg">${l.name}</div><div class="text-sm text-gray-400">${l.address}</div></div>`;
        html += `<button class="text-gray-500 hover:text-white p-2 text-xl z-10" onclick="openLocModal('${l.id}', event)">‚öôÔ∏è</button>`;
        
        el.innerHTML = html;
        el.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') { state.selectedLocationId = l.id; renderLocations(); updateArrivedButtonState(); }
        };
        list.appendChild(el);
    });
}

function openLocModal(id=null, e=null) {
    if(e) e.stopPropagation();
    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
    document.getElementById('locationModal').classList.remove('hidden');
    
    if(id) {
        const l = state.locations.find(x => x.id === id);
        document.getElementById('locationModalTitle').innerText = "Edit Location";
        document.getElementById('locId').value = id;
        document.getElementById('locationName').value = l.name;
        document.getElementById('locationAddress').value = l.address;
        document.getElementById('templateName').value = l.templateName || "";
        document.getElementById('noReportRequired').checked = l.noReport || false;
        
        if(id === 'travel') document.getElementById('deleteLocationBtn').classList.add('hidden');
        else document.getElementById('deleteLocationBtn').classList.remove('hidden');
    } else {
        document.getElementById('locationModalTitle').innerText = "Add Location";
        document.getElementById('locId').value = "";
        document.getElementById('locationName').value = "";
        document.getElementById('locationAddress').value = "";
        document.getElementById('templateName').value = "";
        document.getElementById('noReportRequired').checked = false;
        document.getElementById('deleteLocationBtn').classList.add('hidden');
    }
}

function closeLocModal() { 
    document.getElementById('locationModal').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.remove('flex');
}

function saveLocation() {
    const id = document.getElementById('locId').value;
    const name = document.getElementById('locationName').value;
    const addr = document.getElementById('locationAddress').value;
    const tpl = document.getElementById('templateName').value;
    const noRep = document.getElementById('noReportRequired').checked;
    
    if(!name) return alert("Name required");
    
    if(id) {
        const idx = state.locations.findIndex(l => l.id === id);
        if(idx > -1) state.locations[idx] = { ...state.locations[idx], name, address: addr, templateName: tpl, noReport: noRep };
    } else {
        state.locations.push({ id: Date.now().toString(), name, address: addr, templateName: tpl, noReport: noRep });
    }
    saveState(); renderLocations(); closeLocModal(); syncForms();
}

function deleteLocation() {
    const id = document.getElementById('locId').value;
    if(id === 'travel') return alert("Cannot delete Travelling tile.");
    if(confirm('Delete location?')) {
        state.locations = state.locations.filter(l => l.id !== id);
        if(state.selectedLocationId === id) state.selectedLocationId = null;
        saveState(); renderLocations(); closeLocModal();
    }
}

// --- VISIT LOGIC ---
function updateArrivedButtonState() {
    const slider = document.getElementById('durationSlider');
    const val = DURATION_STEPS[slider.value];
    document.getElementById('durationDisplay').innerText = val + ' min';
    state.visitDurationMinutes = val;
    
    const btn = document.getElementById('arrivedBtn');
    const btnQ = document.getElementById('quickStatBtn');
    const sel = state.locations.find(l => l.id === state.selectedLocationId);
    
    if(sel) {
        if(CONFIG.isAdv && sel.id !== 'travel' && !sel.noReport) {
            btnQ.disabled = false; btnQ.classList.replace('opacity-50','hover:bg-teal-500'); btnQ.classList.replace('bg-teal-900','bg-teal-600'); btnQ.classList.replace('text-teal-500','text-white');
        } else {
            btnQ.disabled = true; btnQ.classList.replace('hover:bg-teal-500','opacity-50'); btnQ.classList.replace('bg-teal-600','bg-teal-900'); btnQ.classList.replace('text-white','text-teal-500');
        }
        
        if(val > 0) {
            btn.disabled = false; btn.innerText = 'HOLD TO START'; btn.className = 'long-press-btn flex-[2] py-5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl shadow-lg transition-all';
            setupLongPress(btn, startVisit);
        } else {
            btn.disabled = true; btn.innerText = 'Set Duration'; btn.className = 'long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl transition-all';
        }
    } else {
        btn.disabled = true; btn.innerText = 'Select Location';
    }
}

function startVisit() {
    const sel = state.locations.find(l => l.id === state.selectedLocationId);
    const now = new Date();
    state.activeVisit = {
        locationId: sel.id,
        startTime: now,
        anticipatedDepartureTime: new Date(now.getTime() + state.visitDurationMinutes * 60000),
        arrivalTimeForSheet: now.toISOString(),
        gpsStart: null
    };
    
    playSoundAndVibrate('arrive');
    saveState();
    enterLockedScreen();
    requestWakeLock();

    // Fast GPS
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            state.activeVisit.gpsStart = pos.coords.latitude + ',' + pos.coords.longitude;
            sendToGoogleSheet({ "Alarm Status": 'ON SITE', "Notes": "Visit Started" });
            saveState();
        }, () => {
            sendToGoogleSheet({ "Alarm Status": 'ON SITE', "Notes": "Visit Started (GPS Slow)" });
        }, { timeout: 5000, maximumAge: 60000 });
    } else {
        sendToGoogleSheet({ "Alarm Status": 'ON SITE', "Notes": "Visit Started (No GPS)" });
    }
}

function enterLockedScreen() {
    const l = state.locations.find(x => x.id === state.activeVisit.locationId) || {name: 'Unknown'};
    document.getElementById('lockedLocationName').innerText = l.name;
    navigate('locked');
    
    setupLongPress(document.getElementById('departBtn'), () => preDepart(false));
    setupLongPress(document.getElementById('extendBtn'), extendVisit);
    
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(tick, 1000);
}

function tick() {
    if(!state.activeVisit) { clearInterval(timerInt); return; }
    const now = new Date();
    const due = new Date(state.activeVisit.anticipatedDepartureTime);
    const rem = due - now;
    
    // UI Update
    if(rem < 0) {
        document.getElementById('countdownTimer').innerText = 'OVERDUE';
        document.getElementById('countdownTimer').classList.replace('text-white', 'text-red-500');
        document.getElementById('iamSafeBtn').classList.remove('hidden');
        document.getElementById('departBtn').classList.add('hidden');
        setupLongPress(document.getElementById('iamSafeBtn'), iamSafe);
        if(Math.floor(rem/1000) % 10 === 0) playSoundAndVibrate('warning'); // Periodic warning
    } else {
        const m = Math.floor(rem/60000);
        const s = Math.floor((rem%60000)/1000);
        document.getElementById('countdownTimer').innerText = `${m}:${s<10?'0':''}${s}`;
        document.getElementById('countdownTimer').classList.replace('text-red-500', 'text-white');
        document.getElementById('lockedAnticipatedTime').innerText = due.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        document.getElementById('iamSafeBtn').classList.add('hidden');
        document.getElementById('departBtn').classList.remove('hidden');
    }
    
    // Check-in Logic
    if(CONFIG.checkinEnabled && state.activeVisit.nextCheckin && now > new Date(state.activeVisit.nextCheckin)) {
        triggerCheckin();
    }
}

function extendVisit() {
    withPinVerification(false, () => {
        state.activeVisit.anticipatedDepartureTime = new Date(new Date(state.activeVisit.anticipatedDepartureTime).getTime() + 15 * 60000);
        saveState();
        playSoundAndVibrate('extend');
        sendToGoogleSheet({ "Alarm Status": 'EXTENDED', "Notes": "Extended 15m" });
    });
}

function triggerPanic() {
    if(confirm('CONFIRM SOS ALERT?')) {
        playSoundAndVibrate('panic');
        sendToGoogleSheet({ "Alarm Status": 'EMERGENCY - PANIC BUTTON', "Notes": "Panic Button Pressed" });
        alert('PANIC ALERT SENT');
    }
}

function iamSafe() {
    withPinVerification(false, () => {
        playSoundAndVibrate('safe');
        sendToGoogleSheet({ "Alarm Status": 'SAFE - MANUALLY CLEARED', "Notes": "Worker confirmed safe" });
        preDepart(true);
    });
}

// --- REPORTING ---
function preDepart(isSafeFlow) {
    const proceed = () => {
        if(!CONFIG.isAdv) { depart(); return; }
        const l = state.locations.find(x => x.id === state.activeVisit.locationId);
        if(l && l.noReport) { depart(); return; }

        showModal('report');
        const div = document.getElementById('reportFields');
        div.innerHTML = '';
        
        // Mileage
        if(l.id === 'travel' && CONFIG.mileage) {
           navigator.geolocation.getCurrentPosition(pos => {
             const end = pos.coords.latitude+','+pos.coords.longitude;
             if(state.activeVisit.gpsStart) {
               const km = calcDist(state.activeVisit.gpsStart, end);
               setTimeout(() => { 
                   const inp = document.querySelector('input[data-key="$Distance (km)"]');
                   if(inp) inp.value = km; 
               }, 500);
             }
           });
        }
        
        buildReportForm(l.templateName, div);
        document.getElementById('submitReportBtn').onclick = submitReport;
    };

    if(isSafeFlow) proceed();
    else withPinVerification(false, proceed);
}

function quickStat() {
    if(!state.selectedLocationId) return;
    const l = state.locations.find(x => x.id === state.selectedLocationId);
    state.activeVisit = { locationId: l.id, startTime: new Date().toISOString() };
    showModal('report');
    const div = document.getElementById('reportFields');
    div.innerHTML = '';
    buildReportForm(l.templateName, div);
    document.getElementById('submitReportBtn').onclick = () => {
        const d = gatherFormData();
        const data = {
            "Location Name": l.name,
            "Location Address": l.address,
            "Alarm Status": "DATA_ENTRY_ONLY",
            "Notes": d.notes,
            "Visit Report Data": JSON.stringify(d.jsonPayload)
        };
        if(d.photo1) data["Photo 1"] = d.photo1;
        sendToGoogleSheet(data);
        state.activeVisit = null; tempPhoto = null; sigPad = null;
        closeModal('report');
    };
}

function buildReportForm(templateName, container) {
    const tpl = state.cachedForms[templateName] || state.cachedForms["(Standard)"] || [];
    container.innerHTML = tpl.length ? '' : '<label class="block text-sm text-gray-400">Notes</label><textarea id="rep_notes" class="form-input h-32"></textarea>';
    
    tpl.forEach(f => {
        let html = '';
        if(f.type==='header') html = `<h3 class="text-blue-400 font-bold mt-4 border-b border-gray-700 pb-1">${f.text}</h3>`;
        else if(f.type==='note') html = `<p class="text-gray-500 text-sm italic my-2">${f.text}</p>`;
        else if(f.type==='text') html = `<label class="block text-sm text-gray-300 mt-2">${f.text}</label><textarea data-key="${f.text}" class="form-input h-24"></textarea>`;
        else if(f.type==='number') html = `<label class="block text-sm text-gray-300 mt-2">${f.text}</label><input type="number" step="any" data-key="${f.text}" class="form-input">`;
        else if(f.type==='check') html = `<label class="flex items-center gap-3 mt-3 p-3 bg-gray-900 rounded"><input type="checkbox" data-key="${f.text}" class="w-5 h-5"><span class="text-gray-300">${f.text}</span></label>`;
        else if(f.type==='yesno') html = `<div class="mt-3"><span class="text-sm text-gray-300 block mb-1">${f.text}</span><div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="${f.text}" value="Yes" data-key="${f.text}"> Yes</label><label class="flex items-center gap-2"><input type="radio" name="${f.text}" value="No" data-key="${f.text}"> No</label></div></div>`;
        else if(f.type==='photo') html = `<label class="block text-sm text-gray-300 mt-4">${f.text}</label><input type="file" accept="image/*" class="w-full text-sm text-gray-500 mt-2" onchange="handlePhoto(this)">`;
        else if(f.type==='gps') html = `<button type="button" onclick="captureGPS(this, '${f.text}')" class="mt-2 text-xs bg-blue-900 text-blue-200 px-3 py-2 rounded">üìç Capture Location</button><input type="hidden" data-key="${f.text}">`;
        else if(f.type==='signature') html = `<label class="block text-sm text-gray-300 mt-4">${f.text}</label><canvas id="sig-canvas" width="300" height="150" class="border border-gray-600 bg-white touch-none"></canvas><button type="button" onclick="clearSig()" class="text-xs text-red-400 mt-1">Clear</button>`;
        container.innerHTML += html;
    });
    
    const canvas = document.getElementById('sig-canvas');
    if(canvas) initSigPad(canvas);
}

function gatherFormData() {
    const data = { custom: {}, notes: '', sig: null, jsonPayload: {} };
    const stdNotes = document.getElementById('rep_notes');
    if(stdNotes) data.notes = stdNotes.value;

    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        let val = el.value;
        if(el.type === 'checkbox') val = el.checked ? 'Yes' : 'No';
        else if(el.type === 'radio') { if(!el.checked) return; val = el.value; }
        
        data.custom[key] = val;
        data.jsonPayload[key] = val;
    });
    
    if(sigPad) data.sig = sigPad.toDataURL('image/png');
    return data;
}

function submitReport() {
    const d = gatherFormData();
    depart(d);
}

// --- DEPART ---
function depart(reportData = {}) {
    playSoundAndVibrate('depart');
    
    // Flatten notes
    let noteStr = reportData.notes || "";
    if(reportData.custom) {
        Object.keys(reportData.custom).forEach(k => {
            if(reportData.custom[k]) noteStr += `\n[${k}: ${reportData.custom[k]}]`;
        });
    }

    const data = {
        "Alarm Status": 'DEPARTED',
        "Notes": noteStr,
        "Visit Report Data": JSON.stringify(reportData.jsonPayload || {})
    };
    
    if(tempPhoto) data["Photo 1"] = tempPhoto;
    if(reportData.sig) {
        if(!data["Photo 1"]) data["Photo 1"] = reportData.sig;
        else data["Notes"] += " [Signature Included]";
    }

    sendToGoogleSheet(data);
    
    state.activeVisit = null; tempPhoto = null; sigPad = null;
    saveState();
    closeModal('report');
    navigate('main');
    updateArrivedButtonState();
}

// --- MODALS & UTILS ---
function showModal(id) {
    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
    document.getElementById(id+'Modal').classList.remove('hidden');
}
function closeModal(id) {
    document.getElementById('modalBackdrop').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.remove('flex');
    document.getElementById(id+'Modal').classList.add('hidden');
}
function openLocModal() { showModal('location'); }
function closeReport() { closeModal('report'); }

function withPinVerification(isDuressAction, callback) {
    showModal('pin');
    const input = document.getElementById('pinInput');
    input.value = ''; input.focus();
    
    // Use one-time listener to avoid stacking
    const confirm = () => {
        const val = input.value;
        closeModal('pin');
        if(val === state.settings.pinCode) callback();
        else if(val === state.settings.duressPin) {
            sendToGoogleSheet({ "Alarm Status": "DURESS_CODE_ACTIVATED", "Notes": "Silent Alarm" });
            if(isDuressAction) callback(); // Proceed deceptively
            else alert("PIN Accepted"); // Fake acceptance
        } else {
            alert("Incorrect PIN");
        }
        document.getElementById('confirmPinBtn').removeEventListener('click', confirm);
    };
    document.getElementById('confirmPinBtn').addEventListener('click', confirm);
    document.getElementById('cancelPinBtn').onclick = () => { closeModal('pin'); };
}

function handlePhoto(input) {
    if(input.files[0]) {
        document.getElementById('btnSubmitRep').innerText = "Compressing...";
        document.getElementById('btnSubmitRep').disabled = true;
        compressImg(input.files[0]).then(b64 => {
            tempPhoto = b64;
            document.getElementById('btnSubmitRep').innerText = "Submit";
            document.getElementById('btnSubmitRep').disabled = false;
        });
    }
}

function captureGPS(btn, key) {
    btn.innerText = "Locating...";
    navigator.geolocation.getCurrentPosition(p => {
        const coords = p.coords.latitude + "," + p.coords.longitude;
        btn.innerText = "‚úÖ " + coords;
        btn.nextElementSibling.value = coords;
    });
}

// --- SIGNATURE ---
function initSigPad(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 2; ctx.strokeStyle = "#000";
    let drawing = false;
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const {x,y} = getPos(e); ctx.moveTo(x,y); };
    const move = (e) => { if(!drawing) return; e.preventDefault(); const {x,y} = getPos(e); ctx.lineTo(x,y); ctx.stroke(); };
    const end = () => { drawing = false; };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);
    sigPad = canvas;
}
function clearSig() { if(sigPad) { const ctx = sigPad.getContext('2d'); ctx.clearRect(0,0,sigPad.width,sigPad.height); } }

// --- NETWORK & SYNC ---
function sendToGoogleSheet(data) {
    if(!state.settings.googleSheetUrl) return;
    const payload = {
        'Worker Name': state.settings.workerName, 'Worker Phone Number': state.settings.workerPhone,
        'Emergency Contact Name': state.settings.emergencyName, 'Emergency Contact Number': state.settings.emergencyPhone, 'Emergency Contact Email': state.settings.emergencyEmail,
        'Escalation Contact Name': state.settings.escalationName, 'Escalation Contact Number': state.settings.escalationPhone, 'Escalation Contact Email': state.settings.escalationEmail,
        ...data, 'Timestamp': new Date().toISOString()
    };
    
    navigator.geolocation.getCurrentPosition(pos => {
        payload['Last Known GPS'] = pos.coords.latitude + ',' + pos.coords.longitude;
        post(payload);
    }, () => { payload['Last Known GPS'] = 'GPS Unavailable'; post(payload); });
}

function post(data) {
    if(!navigator.onLine) {
        state.pendingUploads.push(data); saveState();
        document.getElementById('queueCount').innerText = state.pendingUploads.length;
        document.getElementById('uploadBanner').classList.remove('hidden');
        return;
    }
    const fd = new FormData(); for(let k in data) fd.append(k, data[k]);
    fetch(state.settings.googleSheetUrl, { method: 'POST', mode: 'no-cors', body: fd }).catch(() => {
        state.pendingUploads.push(data); saveState();
    });
}

function processQueue() {
    if(navigator.onLine && state.pendingUploads.length > 0) {
        document.getElementById('uploadBanner').classList.remove('hidden');
        document.getElementById('queueCount').innerText = state.pendingUploads.length;
        const item = state.pendingUploads.shift(); saveState();
        const fd = new FormData(); for(let k in item) fd.append(k, item[k]);
        fetch(state.settings.googleSheetUrl, { method: 'POST', mode: 'no-cors', body: fd })
            .then(() => processQueue())
            .catch(() => { state.pendingUploads.push(item); saveState(); });
    } else { document.getElementById('uploadBanner').classList.add('hidden'); }
}

function syncForms() {
    if(!CONFIG.url) return;
    const comps = [...new Set(state.locations.map(l => l.templateName).filter(Boolean))];
    comps.push("(Standard)", "Travel Report");
    comps.forEach(c => {
        fetch(`${CONFIG.url}?action=getForms&companyName=${encodeURIComponent(c)}`)
        .then(r => r.json()).then(j => { state.cachedForms[c] = j; saveState(); });
    });
}
function clearFormsCache() { state.cachedForms = {}; syncForms(); alert("Forms Syncing..."); }

// --- HELPERS ---
function setupLongPress(btn, cb) {
  let t; const start = (e) => { e.preventDefault(); btn.classList.add('pressing'); t = setTimeout(() => { cb(); end(); }, 1500); };
  const end = () => { clearTimeout(t); btn.classList.remove('pressing'); };
  btn.onmousedown = btn.ontouchstart = start; btn.onmouseup = btn.ontouchend = btn.onmouseleave = end;
}
function compressImg(f) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'), s=Math.min(1024/i.width,1024/i.height,1); c.width=i.width*s; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.6)); }; i.src=e.target.result; }; rd.readAsDataURL(f); }); }
function calcDist(p1,p2) { if(!p1||!p2)return 0; const[y1,x1]=p1.split(',').map(Number),[y2,x2]=p2.split(',').map(Number),R=6371,dLat=(y2-y1)*Math.PI/180,dLon=(x2-x1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(y1*Math.PI/180)*Math.cos(y2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2); }
async function requestWakeLock() { if('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} } }

// Event Listeners
document.getElementById('saveSettingsBtn').onclick = () => {
    const s = state.settings;
    s.workerName = document.getElementById('workerName').value.trim();
    s.workerPhone = document.getElementById('workerPhone').value.trim();
    s.emergencyName = document.getElementById('emergencyName').value.trim();
    s.emergencyPhone = document.getElementById('emergencyPhone').value.trim();
    s.emergencyEmail = document.getElementById('emergencyEmail').value.trim();
    s.escalationName = document.getElementById('escalationName').value.trim();
    s.escalationPhone = document.getElementById('escalationPhone').value.trim();
    s.escalationEmail = document.getElementById('escalationEmail').value.trim();
    s.pinCode = document.getElementById('pinCode').value.trim();
    s.duressPin = document.getElementById('duressPin').value.trim();
    
    if(!s.workerName || !s.workerPhone || !s.emergencyName) return alert("Missing required fields");
    if(s.pinCode.length !== 4) return alert("PIN must be 4 digits");
    
    saveState(); nav('main'); document.getElementById('closeSettingsBtn').style.display = 'block';
    renderLocations(); updateArrivedButtonState();
};
document.getElementById('addLocationBtn').onclick = () => openLocModal();
document.getElementById('saveLocationBtn').onclick = saveLocation;
document.getElementById('deleteLocationBtn').onclick = deleteLocation;
document.getElementById('cancelLocationBtn').onclick = closeLocModal;
document.getElementById('durationSlider').oninput = updateArrivedButtonState;
document.getElementById('quickStatBtn').onclick = quickStat;
</script>
</body>
</html>
