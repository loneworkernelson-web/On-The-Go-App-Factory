<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>%%APP_NAME%%</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
/* 1. FORCE SYSTEM DIM: Required to dim the OS navigation bars */
html.system-dim, body.system-dim { 
    background-color: #000000 !important; 
    color-scheme: dark !important; 
}

/* 2. BASE STYLES */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: #111827; color: white; height: 100%; width: 100%; overflow: hidden; }

.page { 
    display: none; 
    height: 100%; 
    width: 100%; 
    flex-direction: column; 
    position: absolute; 
    top: 0; 
    left: 0; 
    background-color: #111827; 
}

.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: #111827; border-bottom: 1px solid #374151; flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }

/* 3. UPDATED FOOTER: Adds safety padding for the navigation bar */
.footer-bar { 
    padding: 1rem; 
    padding-bottom: calc(1rem + env(safe-area-inset-bottom)); 
    background-color: #111827; 
    border-top: 1px solid #374151; 
    flex-shrink: 0; 
    z-index: 20; 
}

/* Optimized Long-Press SOS Styling with Visual Progress */
.long-press-btn {
    position: relative;
    overflow: hidden;
    transition: transform 0.1s;
    user-select: none;
    -webkit-user-select: none;
}

.long-press-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background: rgba(255, 255, 255, 0.3);
    transition: width 0.2s ease-out; 
    z-index: 1;
}

/* When the button is held, the width expands over exactly 3 seconds */
.long-press-btn.holding::after {
    width: 100%;
    transition: width 3s linear;
}

.long-press-btn:active { transform: scale(0.96); }

/* UI ANIMATIONS */
.pulse-border { 
    animation: pulseGlow 2s infinite; 
    border-width: 2px;
}

@keyframes pulseGlow {
    0% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
    50% { border-color: #a855f7; box-shadow: 0 0 15px 2px rgba(168, 85, 247, 0.4); }
    100% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
}

.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.form-input-card { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.5rem; display: block; }
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }

.-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-active { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }

.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
</style>
</head>
<body class="bg-gray-900 text-white">

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-2xl flex items-center gap-3 z-[1000] translate-y-[-150%] transition-transform duration-300">
    <div class="text-xl">‚úÖ</div>
    <p class="font-bold text-sm" id="toastText">Operation Successful</p>
</div>

<div id="installBanner" class="hidden fixed top-0 left-0 w-full bg-blue-600 text-white p-4 z-[100] shadow-xl flex items-center justify-between">
    <div class="flex items-center gap-3">
        <span class="text-2xl">üì≤</span>
        <div><p class="font-bold text-sm">Install Safety App</p><p class="text-xs opacity-90">Add to home screen for safety monitoring.</p></div>
    </div>
    <div class="flex gap-2">
        <button onclick="dismissInstall()" class="px-3 py-1 text-xs font-bold bg-blue-700 rounded">Later</button>
        <button onclick="triggerInstall()" class="px-4 py-1 text-xs font-black bg-white text-blue-600 rounded">Install</button>
    </div>
</div>

<div id="offlineBanner" class="hidden absolute top-0 left-0 w-full bg-red-600 text-white text-center text-xs font-bold py-1 z-50">üì° OFFLINE MODE - Data queued for upload</div>
<div id="vehNagBar" class="hidden bg-orange-600 text-white text-center text-xs font-bold py-2 cursor-pointer z-40 border-b border-orange-400" onclick="startVehicleCheck()">‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete</div>

<div id="setupPage" class="page active bg-gray-900 z-[60] flex flex-col overflow-hidden">
    <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-900 z-10">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1">
            <div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div>
            <div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div>
            <div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div>
        </div>
    </div>

    <div id="setup_step_identity" class="wizard-step active p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-white mb-2">Who are you?</h2>
    <p class="text-gray-400 mb-8 text-sm">Required for safety monitoring match.</p>
    
    <label for="set_workerName" class="setting-label lbl-blue">Full Name</label>
    <input type="text" id="set_workerName" class="form-input mb-4" placeholder="e.g. John Doe">
    
    <label for="set_workerPhone" class="setting-label lbl-blue">Mobile Number</label>
    <input type="tel" id="set_workerPhone" class="form-input mb-4" placeholder="021...">
    
    <label for="set_workerEmail" class="setting-label lbl-blue">Work Email</label>
    <input type="email" id="set_workerEmail" class="form-input mb-8" placeholder="name@org.co.nz">
    
    <div class="mt-auto">
        <button onclick="wizNext('setup_step_identity', 'wizStep2')" class="w-full py-4 bg-blue-600 font-bold rounded-xl text-lg shadow-lg">Next: Security ‚Üí</button>    </div>
    </div>

    <div id="wizStep2" class="wizard-step p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Security Codes</h2>
        <p class="text-gray-400 mb-6 text-sm">Used for safety check-ins and duress alerts.</p>
        
        <div class="bg-gray-800 p-4 rounded-xl border border-green-500/30 mb-6">
            <label for="setup_pin1" class="block text-green-400 font-bold mb-1 uppercase text-xs">Standard PIN</label>
            <input id="setup_pin1" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest" placeholder="0000">
            <label for="setup_pin2" class="block text-green-400 font-bold mt-4 mb-1 uppercase text-xs">Confirm PIN</label>
            <input id="setup_pin2" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest" placeholder="0000">
        </div>

        <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 mb-8">
            <label for="set_duressPin" class="block text-purple-400 font-bold mb-1 uppercase text-xs">Duress PIN (Silent)</label>
            <input id="set_duressPin" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest border-purple-500/50" placeholder="9999">
        </div>

        <div class="flex gap-3 mt-auto">
            <button onclick="wizBack('wizStep2', 'wizStep1')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl text-gray-400">Back</button>
            <button onclick="savePin()" class="flex-[2] py-4 bg-blue-600 font-bold rounded-xl shadow-lg">Next: Contacts ‚Üí</button>
        </div>
    </div>

    <div id="wizStep3" class="wizard-step p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Emergency Contacts</h2>
        <label for="set_emgName" class="setting-label lbl-red">Primary Contact Name</label>
        <input id="set_emgName" class="form-input mb-4" placeholder="Name">
        <label for="set_emgPhone" class="setting-label text-xs text-gray-500">Primary Mobile</label>
        <input id="set_emgPhone" type="tel" class="form-input mb-6" placeholder="Mobile Number">

        <label for="set_escName" class="setting-label lbl-gray">Escalation Name (Optional)</label>
        <input id="set_escName" class="form-input mb-4" placeholder="Name">
        <label for="set_escPhone" class="setting-label text-xs text-gray-500">Escalation Mobile</label>
        <input id="set_escPhone" type="tel" class="form-input mb-8" placeholder="Mobile Number">

        <div class="flex gap-3 mt-auto">
            <button onclick="wizBack('wizStep3', 'wizStep2')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl text-gray-400">Back</button>
            <button onclick="finishSetup()" class="flex-[2] py-4 bg-green-600 font-bold rounded-xl shadow-lg uppercase tracking-widest">‚úÖ Launch App</button>
        </div>
    </div>
</div>

<div id="settingsPage" class="page bg-gray-800">
    <div class="header-bar">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    <div class="content-area">
        <div class="setting-card">
            <label class="setting-label lbl-blue">Your Identity</label>
            <input id="set_workerName_diag" class="form-input-card text-sm font-bold" readonly placeholder="Worker Name">
        </div>
        <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center px-2">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-black">APP VERSION</span>
                <span id="diagApp" class="text-xs text-gray-400 font-bold">---</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-500 font-black">CLOUD VERSION</span>
                <span id="diagCloud" class="text-xs text-gray-400 font-bold">---</span>
            </div>
        </div>
    </div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
        <div class="flex items-center gap-3">
            <div class="flex gap-0.5" id="gpsBars">
                <div id="gps1" class="gps-bar"></div>
                <div id="gps2" class="gps-bar"></div>
                <div id="gps3" class="gps-bar"></div>
            </div>
            <button onclick="navigate('settings')" class="p-2 text-gray-400">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="content-area">
        <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded text-center font-bold uppercase animate-pulse">Syncing...</div>
        <div id="travelRow" class="mb-4"></div>
        <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-1">Destinations</div>
        <div id="locationList" class="grid grid-cols-2 gap-3 pb-4"></div>
    </div>
    <div class="footer-bar">
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2">
                <span class="text-gray-400 text-[10px] font-black uppercase">Visit Time</span>
                <span id="durationDisplay" class="text-xs text-blue-400 font-bold">0 mins</span>
            </div>
            <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
        </div>
        <button id="panicBtn" class="long-press-btn w-full py-4 bg-red-900/40 border-2 border-red-600 text-red-500 font-black rounded-xl uppercase tracking-widest">Hold for SOS</button>
    </div>
</div>

<div id="batterySaver" class="hidden fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center select-none">
    <div id="saverProgress" class="absolute inset-0 bg-white/5 opacity-0 transition-opacity duration-[2000ms] pointer-events-none"></div>
    
    <div class="text-gray-800 text-sm font-bold animate-pulse uppercase tracking-[0.3em] z-10">Battery Saver Active</div>
    <div class="text-gray-900 text-[10px] uppercase font-black tracking-widest mt-4 z-10 border border-gray-900 px-4 py-2 rounded-full font-bold">Hold screen to wake</div>
</div>

<div id="lockedPage" class="page bg-black">
    <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div id="visitTimer" class="text-8xl font-mono font-bold text-white tracking-tighter">00:00</div>
        <h2 id="lockedLocationName" class="text-2xl font-bold text-gray-400 mt-2 tracking-tight">---</h2>
        
        <div class="mt-12 w-full max-w-xs space-y-4">
            <input type="password" id="lock_pin_input" maxlength="4" inputmode="numeric" placeholder="Enter PIN" class="form-input text-center text-3xl tracking-[0.5em]">
            <button onclick="checkPin()" class="w-full py-4 bg-blue-600 font-bold rounded-2xl text-lg">Unlock Options</button>
            <button onclick="endVisit()" class="w-full py-4 bg-red-600 font-bold rounded-2xl text-lg">End Visit</button>
        </div>
    </div>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-[150]">
    <div id="infoModal" class="hidden bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700">
        <h2 id="infoTitle" class="text-xl font-bold mb-4">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm mb-6"></div>
        <div class="flex gap-3 mb-4">
            <a id="btnSiteCall" href="#" class="hidden flex-1 bg-green-600 text-white py-4 rounded-xl text-center font-black">üìû CALL</a>
            <a id="btnSiteEmail" href="#" class="hidden flex-1 bg-blue-600 text-white py-4 rounded-xl text-center font-black">‚úâÔ∏è EMAIL</a>
        </div>
        <a id="btnSiteNav" href="#" target="_blank" class="block w-full py-4 bg-purple-600 text-white font-bold rounded-xl text-center shadow-xl mb-4">üó∫Ô∏è NAVIGATE</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 font-bold rounded-xl">CLOSE</button>
    </div>
</div>

<div id="reportPage" class="page bg-gray-900">
    <div class="header-bar"><h2 id="reportTitle" class="text-lg font-bold text-white">Report</h2></div>
    <div class="content-area" id="reportFields"></div>
    <div class="footer-bar flex gap-3">
        <button onclick="navigate('main')" class="flex-1 py-4 bg-gray-700 font-bold rounded-xl">CANCEL</button>
        <button id="btnSubmitRep" class="flex-[2] py-4 bg-green-600 font-black rounded-xl uppercase">Submit & End</button>
    </div>
</div>
<script>
// --- 1. GLOBAL CONSTANTS & CORE STATE ---
const APP_VERSION = "v79.35";
const CONFIG = {
    url: "%%GOOGLE_SHEET_URL%%",
    key: "%%SECRET_KEY%%",
    mileage: true
};

// Centralized state object
let state = { 
    settings: {}, 
    locations: [], 
    selectedLocationId: null, 
    visitDurationMinutes: 0,
    activeVisit: null, 
    cachedForms: {}, 
    pendingUploads: [],
    globalForms: [],
    photoStore: {},
    lowBatSent: false,
    meta: {} 
};

// Variables for hardware and timers
let synth, checkinIntervalId, mainScreenReminderTimer, wakeLock, timerInt, travellingInterval;
let autoDimTimer = null;
let tempPhoto = null, sigPad = null;
let deferredPrompt, isMidVisitUpdate = false, currentActiveTemplate = "", isDrawing = false;
let calculatedDist = null, gpsWarm = false, gpsWatchId = null, lastAlertTime = 0;
let currentBatteryLevel = "100%";
let uploadQueue = []; 
let travelTargetName = ""; // Tracks driving destination

// --- 2. STORAGE & SYNCHRONIZATION ---

/* Modern Standard: Uses the navigator.storage API to request persistence.*/
/* This replaces the deprecated webkitPersistentStorage and StorageType calls.*/

async function saveState() {
    try {
        // MODERN STANDARD: navigator.storage standard replaces deprecated StorageType
        if (navigator.storage && navigator.storage.persist) {
            const isPersisted = await navigator.storage.persist();
            if (isPersisted) console.log("üíæ Persistent storage granted.");
        }
        localStorage.setItem('otg_worker_state', JSON.stringify(state));
    } catch (e) { 
        console.error("Storage Error:", e); 
    }
}

function loadState() {
    const saved = localStorage.getItem('otg_worker_state');
    if (saved) {
        try {
            state = JSON.parse(saved);
        } catch (e) {
            console.error("Critical: State Corrupted", e);
        }
    }
}

/*Robust Refresh: Uses async to prevent library crashes.*/
async function hardRefreshUpdate() {
    if(!confirm("Force reload and clear internal app memory?")) return;
    showToast("üßπ Deep cleaning system cache...");

    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) { await r.unregister(); }
    }

    if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) { await caches.delete(k); }
    }

    state.meta.backendVersion = null;
    await saveState(); 
    location.reload(true); 
}

// --- 3. DASHBOARD & UI RENDERING ---

/**
 * Starts a visit or travel session.
 */
function startVisit(id) {
    const loc = state.locations.find(l => l.id === id);
    if (!loc) return;
    
    state.activeVisit = { 
        id, 
        locationName: loc.name, 
        startTime: Date.now(), 
        status: (id === 'travel' ? 'TRAVELLING' : 'ON_SITE') 
    };

    saveState();
    navigate('locked');
    startCheckinTimer();
    speak(`Visit started at ${loc.name}`);

    // GLUE: Automatically dim the screen if driving to save battery
    if (id === 'travel') {
        setTimeout(() => toggleBatterySaver(true), 2000); 
    }
}
/**
 * Ends the current visit and triggers the report form.
 */
function endVisit() {
    if (!state.activeVisit) return;
    
    // Stop timers and pulses
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    if (travellingInterval) clearInterval(travellingInterval);
    
    const locName = state.activeVisit.locationName;
    const template = (state.activeVisit.locationId === 'travel') ? 'Travel Report' : 'Standard Visit Note';
    
    // Move to report screen
    document.getElementById('reportTitle').innerText = `Report: ${locName}`;
    buildReportForm(template, document.getElementById('reportFields'));
    navigate('report');
}
/**
 * Validates the entered PIN against the masked version in settings.
 */
function checkPin() {
    const input = document.getElementById('lock_pin_input').value;
    const maskedInput = btoa(input); // Matches the masking used in savePin

    if (maskedInput === state.settings.pinCode) {
        document.getElementById('lock_pin_input').value = ""; // Clear for safety
        showModal('template'); // Opens the form selection menu
    } else {
        showToast("Incorrect PIN");
        // Haptic feedback if supported
        if (navigator.vibrate) navigator.vibrate(200);
    }
}

/**
 * Screen WakeLock: Prevents the phone from sleeping during active sessions.
 */
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("üîí WakeLock Active");
        }
    } catch (err) {
        console.warn("WakeLock failed:", err.message);
    }
}
/**
 * Clears the signature canvas for a specific field index.
 */
function clearSig(index) {
    const canvas = document.getElementById(`sig-canvas-${index}`);
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
}

/**
 * Creates the pulsing effect for the Travel Tile when active.
 */
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        const tr = document.getElementById('travelRow');
        if (tr) tr.classList.toggle('opacity-70');
    }, 1000);
}
/**
 * RESTORED: Auto-Dim Inactivity Logic
 */
/**
 * RESTORED: Unified Battery Saver & Inactivity Logic
 */
let inactivityTimer; // Single declaration to prevent SyntaxError

function resetAutoDim() {
    clearTimeout(inactivityTimer);
    if (state.activeVisit && document.getElementById('batterySaver')?.classList.contains('hidden')) {
        // Auto-dim after 5 minutes of inactivity during a visit
        inactivityTimer = setTimeout(() => toggleBatterySaver(true), 300000);
    }
}

function initAutoDimListeners() {
    ['mousedown', 'mousemove', 'keypress', 'touchstart', 'scroll'].forEach(name => {
        document.addEventListener(name, resetAutoDim, {passive: true});
    });
    resetAutoDim();
}

function toggleBatterySaver(force) {
    const saver = document.getElementById('batterySaver');
    const progress = document.getElementById('saverProgress');
    if (!saver) return;

    const isCurrentlyDim = !saver.classList.contains('hidden');
    const targetState = (force !== undefined) ? force : !isCurrentlyDim;

    if (targetState) {
        saver.classList.remove('hidden');
        document.documentElement.classList.add('system-dim'); // Triggers OS-level dimming
        if (progress) progress.style.opacity = "0"; 
        initWakeListener(); 
        clearTimeout(inactivityTimer);
    } else {
        saver.classList.add('hidden');
        document.documentElement.classList.remove('system-dim');
        resetAutoDim(); 
    }
}
/**
 * GLUE: Attaches the hold-to-wake duration to the black overlay
 */
function initWakeListener() {
    const saver = document.getElementById('batterySaver');
    let wakeTimer;
    
    const startWake = () => {
        document.getElementById('saverProgress').style.opacity = "1";
        wakeTimer = setTimeout(() => {
            toggleBatterySaver(false);
            showToast("Screen Active");
        }, 2000); // Must hold for 2 seconds to "wake"
    };

    const stopWake = () => {
        document.getElementById('saverProgress').style.opacity = "0";
        clearTimeout(wakeTimer);
    };

    saver.onmousedown = startWake; saver.onmouseup = stopWake;
    saver.ontouchstart = startWake; saver.ontouchend = stopWake;
}    
/**
 * Core Synchronization: Pushes data to the Google Sheet backend.
 */
async function forceSync(highPriority = false) {
    const banner = document.getElementById('uploadBanner');
    if (banner) banner.classList.remove('hidden');
    
    // Logic to bundle state.pendingUploads and send via fetch()
    console.log("Syncing with backend...");
    
    // Simulated delay for network activity
    setTimeout(() => {
        if (banner) banner.classList.add('hidden');
        populateSettingsForm(); // Refresh diagnostic info
    }, 1500);
}
/**
 * Saves the name and URL from the first step of setup.
 */
function saveIdentity() {
    const name = document.getElementById('set_workerName').value;
    const url = document.getElementById('set_url').value;

    if (!name || name.length < 2) {
        showToast("Please enter your full name");
        return;
    }

    state.settings.workerName = name;
    state.settings.googleSheetUrl = url;
    
    wizNext('setup_step_identity', 'setup_step_security');
}
function createTravelTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === 'travel';
    const isNoReport = loc.noReport || localStorage.getItem('otg_user_travel_pref') === 'true';

    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-purple-500 bg-purple-900/40 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    
    d.innerHTML = `
        <div class="text-3xl">üõ£Ô∏è</div>
        <div class="flex-1">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black text-purple-400 uppercase tracking-widest">In-Transit Mode</span>
                <button class="text-gray-500 hover:text-white" onclick="editTravelSettings(event)">‚öôÔ∏è</button>
            </div>
            <div class="text-lg font-black text-white leading-tight">Travel Safety Check</div>
            ${isNoReport ? '<span class="text-[9px] text-gray-500 uppercase font-bold">Fast-Sync (No Report)</span>' : ''}
        </div>
    `;

    d.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        state.selectedLocationId = isSel ? null : 'travel';
        renderLocations();
    };
    return d;
}

/*Fully Patched Form Builder*/
/* - Resolves Accessibility: All <label> elements associated with unique IDs.*/
/* - Activates Interactive Tags: [PHOTO], [GPS], [SIGN], [DROP], [$].*/
/* - Standardized Styling: Consistent with dashboard theme.*/
function buildReportForm(n, c) {
    state.photoStore = {};
    const sn = n ? n.trim() : "(Standard)";
    
    // 1. Source the questions from Global Forms or Cache
    let questions = state.globalForms?.find(f => f.name.trim() === sn)?.questions || 
                    state.cachedForms[sn] || 
                    state.cachedForms["(Standard)"];
    
    c.innerHTML = '';
    
    // Fallback logic for empty templates
    if (!questions) {
        c.innerHTML = `
            <label for="rep_notes" class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Visit Notes</label>
            <textarea id="rep_notes" class="form-input h-32" placeholder="Write notes here..."></textarea>
        `;
        return;
    }

    questions.forEach((f, i) => {
        let type = 'text'; 
        let labelText = f.text || f; 
        let dropOptions = [];
        const upper = labelText.toUpperCase();
        const fieldId = `dyn_field_${i}`; // Root ID for accessibility

        // 2. Tag Detection logic
        if (upper.includes('[HEADING]') || labelText.trim().startsWith('#')) { 
            type = 'header'; labelText = labelText.replace(/\[HEADING\]/gi, '').replace('#','').trim(); 
        }
        else if (upper.includes('[NOTE]')) { 
            type = 'note'; labelText = labelText.replace(/\[NOTE\]/gi, '').trim(); 
        }
        else if (upper.includes('[SIGN]')) { 
            type = 'signature'; labelText = labelText.replace(/\[SIGN\]/gi, '').trim(); 
        }
        else if (upper.includes('[PHOTO]')) { 
            type = 'photo'; labelText = labelText.replace(/\[PHOTO\]/gi, '').trim(); 
        }
        else if (upper.includes('[GPS]')) { 
            type = 'gps'; labelText = labelText.replace(/\[GPS\]/gi, '').trim(); 
            if (!labelText) labelText = "Location Status"; 
        }
        else if (upper.includes('[YESNO]')) { 
            type = 'yesno'; labelText = labelText.replace(/\[YESNO\]/gi, '').trim(); 
        }
        else if (upper.includes('[CHECK]')) { 
            type = 'checkbox'; labelText = labelText.replace(/\[CHECK\]/gi, '').trim(); 
        }
        else if (upper.includes('[DATE]')) { 
            type = 'date'; labelText = labelText.replace(/\[DATE\]/gi, '').trim(); 
        }
        else if (upper.includes('[NUMBER]')) { 
            type = 'number'; labelText = labelText.replace(/\[NUMBER\]/gi, '').trim(); 
        }
        else if (upper.includes('[$]')) { 
            type = 'currency'; labelText = labelText.replace(/\[\$\]/gi, '').trim(); 
        }
        else if (upper.includes('[1TEXT]')) { 
            type = '1text'; labelText = labelText.replace(/\[1TEXT\]/gi, '').trim(); 
        }
        else if (upper.includes('[TIME]')) { type = 'time'; labelText = labelText.replace(/\[TIME\]/gi, '').trim(); } 
        
        else if (upper.startsWith('[DROP')) {
            type = 'drop';
            const match = labelText.match(/\[DROP\s*,\s*(.*?)\s*\]/i);
            if (match) {
                dropOptions = match[1].split(',').map(o => o.trim());
                labelText = labelText.replace(match[0], '').trim();
            }
else if (type === '1text' || type === 'date' || type === 'number' || type === 'time') {
    const el = document.createElement('input');
    el.id = fieldId;
    el.type = (type === '1text') ? 'text' : type; // Sets 'date' or 'time'
    el.className = "form-input font-bold";
    el.dataset.key = labelText;
    container.appendChild(el);
}
        }

        const container = document.createElement('div');
        container.className = "mb-4";

        // 3. Render Element Logic
        if (type === 'header') {
            container.innerHTML = `<div class="mt-6 mb-2 border-b border-gray-700 pb-1"><h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest">${labelText}</h3></div>`;
        } 
        else if (type === 'note') {
            container.innerHTML = `<div class="bg-blue-900/20 border-l-2 border-blue-500 p-3 text-xs text-blue-200 italic font-medium">${labelText}</div>`;
        } 
        else {
            // Accessible Label Association
            const label = document.createElement('label');
            label.setAttribute('for', fieldId);
            label.className = "block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1";
            label.innerText = labelText;
            container.appendChild(label);

            if (type === 'photo') {
                const wrap = document.createElement('div');
                wrap.className = "flex items-center gap-3";
                wrap.innerHTML = `
                    <label id="lbl_${i}" for="${fieldId}" class="flex-1 py-4 bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center text-gray-400 font-bold cursor-pointer transition active:scale-95">üì∏ Take Photo</label>
                    <input type="file" id="${fieldId}" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this, '${labelText}')">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'gps') {
                const wrap = document.createElement('div');
                wrap.className = "flex gap-2";
                wrap.innerHTML = `
                    <button type="button" onclick="captureGPS(this)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg text-xs uppercase transition active:scale-95">GPS</button>
                    <input type="text" id="${fieldId}" class="form-input flex-1 font-mono text-xs text-gray-400" readonly data-key="${labelText}" placeholder="Not captured">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'signature') {
                container.innerHTML += `
                    <div class="bg-white rounded-xl p-1 mb-2">
                        <canvas id="sig-canvas-${i}" class="w-full h-40 border border-gray-200"></canvas>
                    </div>
                    <button type="button" class="text-[10px] font-bold text-gray-500 uppercase sig-clear-btn" data-index="${i}">Clear Signature</button>
                `;
            } 
            else if (type === 'drop') {
                const sel = document.createElement('select');
                sel.id = fieldId; sel.className = "form-input font-bold"; sel.dataset.key = labelText;
                const def = document.createElement('option');
                def.text = `Select ${labelText}...`; def.value = "";
                sel.appendChild(def);
                dropOptions.forEach(optText => {
                    const opt = document.createElement('option');
                    opt.text = optText; opt.value = optText;
                    sel.appendChild(opt);
                });
                container.appendChild(sel);
            } 
            else if (type === 'currency') {
                const wrap = document.createElement('div');
                wrap.className = "relative";
                wrap.innerHTML = `
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
                    <input type="number" step="0.01" inputmode="decimal" id="${fieldId}" class="form-input pl-8 font-bold" data-key="${labelText}">
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'yesno') {
                // Radio buttons using unique IDs to link correctly to nested labels
                const wrap = document.createElement('div');
                wrap.className = "flex gap-4 p-2 bg-gray-900 rounded-xl";
                wrap.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 active:bg-blue-900 transition">
                        <input type="radio" name="yn_${i}" id="${fieldId}_y" value="Yes" class="w-5 h-5" data-key="${labelText}"> 
                        <span class="text-sm font-black text-white">YES</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 active:bg-blue-900 transition">
                        <input type="radio" name="yn_${i}" id="${fieldId}_n" value="No" class="w-5 h-5" data-key="${labelText}"> 
                        <span class="text-sm font-black text-white">NO</span>
                    </label>
                `;
                container.appendChild(wrap);
            } 
            else if (type === 'checkbox') {
                const wrap = document.createElement('label');
                wrap.className = "flex items-center gap-3 p-4 bg-gray-800 rounded-xl border border-gray-600 active:bg-gray-700 transition cursor-pointer";
                wrap.innerHTML = `
                    <input id="${fieldId}" type="checkbox" class="w-7 h-7 text-blue-600 rounded"> 
                    <span class="text-sm font-bold text-gray-200 select-none flex-1">${labelText}</span>
                `;
                wrap.querySelector('input').dataset.key = labelText;
                container.appendChild(wrap);
            }
            else if (type === '1text' || type === 'date' || type === 'number') {
                const el = document.createElement('input');
                el.id = fieldId; el.type = (type === '1text') ? 'text' : type;
                el.className = "form-input font-bold"; el.dataset.key = labelText;
                container.appendChild(el);
            }
            else {
                const el = document.createElement('textarea');
                el.id = fieldId; el.className = "form-input h-24 font-medium"; el.dataset.key = labelText;
                container.appendChild(el);
            }
        }
        c.appendChild(container);
    });

    // 4. Initialize specialized hardware handlers
    setTimeout(() => {
        document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => {
            if (typeof resizeCanvas === 'function') resizeCanvas(canvas);
            if (typeof initSigPad === 'function') initSigPad(canvas);
        });
    }, 600);
}

/**
 * Processes and saves the security PIN.
 * Uses Base64 encoding as a basic masking layer before saving to state.
 */
function savePin() {
    const p1 = document.getElementById('setup_pin1').value;
    const p2 = document.getElementById('setup_pin2').value;
    const duress = document.getElementById('set_duressPin').value;

    if (p1.length === 4 && p1 === p2) {
        state.settings.pinCode = btoa(p1);
        state.settings.duressPin = btoa(duress);
        wizNext('wizStep2', 'wizStep3');
    } else {
        showToast("Standard PINs must be 4 digits and match.");
    }
    wizNext('wizStep2', 'wizStep3');
}

/**
 * Finalizes the setup and moves the user to the dashboard.
 */
async function finishSetup() {
    // 1. Capture Identity Fields
    state.settings.workerName = document.getElementById('set_workerName').value;
    state.settings.workerPhone = document.getElementById('set_workerPhone').value;
    state.settings.workerEmail = document.getElementById('set_workerEmail').value;
    
    // 2. Capture Emergency Contacts
    state.settings.emergency = {
        primary: { 
            name: document.getElementById('set_emgName')?.value || "", 
            phone: document.getElementById('set_emgPhone')?.value || "" 
        },
        escalation: {
            name: document.getElementById('set_escName')?.value || "",
            phone: document.getElementById('set_escPhone')?.value || ""
        }
    };

    if (state.settings.workerName) {
        await saveState();
        showToast("Setup Complete!");
        navigate('main');
    } else {
        showToast("Please enter your name to proceed.");
    }
}
// --- 5. IDENTITY & DIAGNOSTICS ---

function populateSettingsForm() {
    // System URL remains visible in settings but hidden from wizard
    const urlInput = document.getElementById('set_url');
    if (urlInput) urlInput.value = state.settings.googleSheetUrl || "%%GOOGLE_SHEET_URL%%";

    // Diagnostic labels
    document.getElementById('diagApp').innerText = APP_VERSION;
    document.getElementById('diagCloud').innerText = state.meta.backendVersion || "Not Synced";
}
/**
 * Core Routing: Switches between different app screens.
 * @param {string} pageId - The ID of the div to show (e.g., 'setup', 'main', 'locked').
 */
function navigate(pageId) {
    // 1. Define all possible page IDs in your HTML
    const pages = ['setupPage', 'mainPage', 'lockedPage', 'reportPage', 'infoPage'];
    
    // 2. Hide everything
    pages.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });

    // 3. Show the target page
    const target = document.getElementById(pageId + 'Page');
    if (target) {
        target.classList.remove('hidden');
        window.scrollTo(0, 0); // Reset scroll position for the new screen
    } else {
        console.error(`Navigation Error: Page ID "${pageId}Page" not found in HTML.`);
    }

    // 4. Update the UI state
    if (pageId === 'main') {
        renderLocations(); // Ensure tiles are fresh when returning to dashboard
    }
}
/**
 * Generic Modal Controls
 */
function showModal(id) {
    const backdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById(id + 'Modal');
    if (backdrop && modal) {
        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
        modal.classList.remove('hidden');
    }
}
function closeModal(id) {
    const backdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById(id + 'Modal');
    if (backdrop && modal) {
        backdrop.classList.add('hidden');
        backdrop.classList.remove('flex');
        modal.classList.add('hidden');
    }
}

/**
 * Toast Notifications: Provides non-blocking feedback to the user.
 */
function showToast(msg) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.innerText = msg;
    t.classList.remove('hidden');
    // Auto-hide after 3 seconds
    setTimeout(() => { t.classList.add('hidden'); }, 3000);
}
/**
 * RESTORED: Wizard Navigation with CSS 'active' class toggling
 */
/**
 * FIXED: Wizard Navigation (Uses 'active' class for CSS compatibility)
 */
function wizNext(currentId, nextId) {
    const curr = document.getElementById(currentId);
    const next = document.getElementById(nextId);
    
    if (curr && next) {
        // Toggle 'active' class to match your CSS visibility rules
        curr.classList.remove('active');
        next.classList.add('active');
        
        // Update Progress Dots
        const step = nextId.replace('wizStep', '');
        if (step == '2') document.getElementById('dot2')?.classList.replace('bg-gray-700', 'bg-blue-500');
        if (step == '3') document.getElementById('dot3')?.classList.replace('bg-gray-700', 'bg-blue-500');
        
        window.scrollTo(0, 0);
    }
}

function wizBack(currentId, prevId) {
    const curr = document.getElementById(currentId);
    const prev = document.getElementById(prevId);
    if (curr && prev) {
        curr.classList.remove('active');
        prev.classList.add('active');
        window.scrollTo(0, 0);
    }
}

/**
 * Initialises the Panic/Emergency button listeners.
 * Configured for a "Long Press" to prevent accidental triggers.
 */
function initPanicButton() {
    const btn = document.getElementById('panicBtn');
    if (!btn) return;

    let panicTimer;
    
    // Long-press logic (requires 2 seconds of holding)
    btn.addEventListener('mousedown', () => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    });

    btn.addEventListener('mouseup', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });

    btn.addEventListener('touchstart', (e) => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    }, {passive: true});

    btn.addEventListener('touchend', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });
    /**
 * GLUE: Global Long-Press CSS Trigger
 * Links the visual progress bar (::after) to the JavaScript timer.
 */
document.querySelectorAll('.long-press-btn').forEach(btn => {
    const startHolding = () => btn.classList.add('holding');
    const stopHolding = () => btn.classList.remove('holding');
    
    btn.addEventListener('mousedown', startHolding);
    btn.addEventListener('mouseup', stopHolding);
    btn.addEventListener('touchstart', startHolding, {passive: true});
    btn.addEventListener('touchend', stopHolding);
});
}

/**
 * The action triggered by the panic button.
 */
function handlePanic() {
    if (confirm("üö® TRIGGER EMERGENCY ALERT?\n\nThis will notify the server and capture your current GPS location.")) {
        showToast("Sending Emergency Signal...");
        // This pushes a high-priority packet to your upload queue
        forceSync(true); 
    }
}
function initLocations() {
    if (!state.locations) state.locations = [];
    
    // Always force Travelling to index 0
    state.locations = state.locations.filter(l => l.id !== 'travel');
    state.locations.unshift({
        id: 'travel',
        name: 'Travelling',
        noReport: localStorage.getItem('otg_user_travel_pref') === 'true'
    });

    renderLocations();
    checkVehicleStatus(); 
    populateSettingsForm(); 
}
/**
 * --- MASTER OPERATIONAL LOGIC ---
 * RESTORED: Advanced Smoothing, Compression, and Hardware Integration
 */

// 1. DASHBOARD ENGINE (Dynamic Site List)
function renderLocations() {
    const list = document.getElementById('locationList');
    const travel = document.getElementById('travelRow');
    if (!list || !travel) return;
    
    list.innerHTML = ''; travel.innerHTML = '';

    state.locations.forEach(loc => {
        if (!loc || !loc.id) return;
        const tile = (loc.id === 'travel') ? createTravelTile(loc) : createLocationTile(loc);
        (loc.id === 'travel') ? travel.appendChild(tile) : list.appendChild(tile);
    });
}

function createLocationTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === loc.id;
    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-blue-500 bg-blue-900/20 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    d.innerHTML = `
        <div class="text-3xl">${loc.icon || 'üè¢'}</div>
        <div class="flex-1">
            <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest leading-none mb-1">${loc.companyName || 'Site'}</div>
            <div class="text-lg font-black text-white leading-tight">${loc.name}</div>
        </div>
    `;
    d.onclick = () => { state.selectedLocationId = isSel ? null : loc.id; renderLocations(); };
    return d;
}

// 2. SIGNATURE PAD (Gaussian Smoothing & High-DPI Scaling)
function resizeCanvas(canvas) {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
}

function initSigPad(canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false, lastPoint = null;
    
    ctx.lineWidth = 2.5; 
    ctx.lineJoin = 'round'; 
    ctx.lineCap = 'round'; 
    ctx.strokeStyle = '#000000';

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };

    canvas.addEventListener('touchstart', (e) => {
        drawing = true; 
        lastPoint = getPos(e);
        ctx.beginPath(); 
        ctx.moveTo(lastPoint.x, lastPoint.y);
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (!drawing) return;
        e.preventDefault();
        const currentPoint = getPos(e);
        
        // RESTORED: Quadratic Bezier Midpoint logic for smooth curves
        const midPoint = { 
            x: lastPoint.x + (currentPoint.x - lastPoint.x) / 2, 
            y: lastPoint.y + (currentPoint.y - lastPoint.y) / 2 
        };
        
        ctx.quadraticCurveTo(lastPoint.x, lastPoint.y, midPoint.x, midPoint.y);
        ctx.stroke();
        lastPoint = currentPoint;
    }, { passive: false });

    window.addEventListener('touchend', () => { drawing = false; lastPoint = null; });
}
// 3. PHOTO ENGINE (EXIF Stripping & 0.4 Quality Compression)
function handlePhoto(input, key) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => compressImg(e.target.result, key, input.id);
        reader.readAsDataURL(input.files[0]);
    }
}

function compressImg(data, key, inputId) {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let scale = Math.min(600 / img.width, 600 / img.height, 1);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        state.photoStore[key] = canvas.toDataURL('image/jpeg', 0.4);
        
        const labelIndex = inputId.split('_')[2];
        const label = document.getElementById(`lbl_${labelIndex}`);
        if (label) {
            label.innerHTML = "‚úÖ Optimized";
            label.className = "flex-1 py-4 bg-green-900/40 border-2 border-green-500 rounded-xl text-green-400 font-bold text-center";
        }
        showToast(`Processed optimized photo for ${key}`);
    };
    img.src = data;
}

// 4. AUTOMATION & HARDWARE (GPS, Timers, Speech)
/**
 * RESTORED: High-Accuracy GPS Capture
 */
function captureGPS(btn) {
    if (!navigator.geolocation) {
        showToast("GPS Not Supported");
        return;
    }
    btn.innerText = "‚åõ...";
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) {
                input.value = coords;
                showToast("Location Captured");
            }
            btn.innerText = "GPS";
        },
        (err) => {
            showToast("GPS Error: Ensure Location is ON");
            btn.innerText = "GPS";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state.activeVisit) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

function checkVehicleStatus() {
    const isTransit = state.activeVisit && state.activeVisit.status === 'TRAVELLING';
    const tr = document.getElementById('travelRow');
    if (tr) isTransit ? tr.classList.add('border-purple-500', 'pulse-border') : tr.classList.remove('border-purple-500', 'pulse-border');
}

function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}
/**
 * RESTORED: Full Report Submission & Sync Queue
 */
async function submitReport() {
    const fields = document.querySelectorAll('#reportFields input, #reportFields textarea, #reportFields select');
    const data = {
        timestamp: new Date().toISOString(),
        location: state.activeVisit ? state.activeVisit.locationName : 'Unknown',
        worker: state.settings.workerName,
        responses: {},
        photos: { ...state.photoStore } // Includes the EXIF-stripped images
    };

    fields.forEach(f => {
        const key = f.dataset.key || f.id;
        data.responses[key] = f.type === 'checkbox' ? f.checked : f.value;
    });

    state.pendingUploads.push(data);
    await saveState();
    
    showToast("Report Saved to Sync Queue");
    state.activeVisit = null;
    state.photoStore = {}; // Clear for next visit
    navigate('main');
    forceSync();
}
function showSiteInfo(id, e) {
    if (e) e.stopPropagation(); 
    const l = state.locations.find(x => x.id === id); 
    if (!l) return;

    document.getElementById('infoTitle').innerText = l.name; 
    let h = "";
    if (l.companyName) h += `<p class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">${l.companyName}</p>`;
    
    const nav = document.getElementById('btnSiteNav');
    if (l.address && l.address.length > 3) { 
        h += `<p class="mt-2 text-white font-bold">${l.address}</p>`;
        // FIXED: navigation URL template literal
        nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.address)}`;
        nav.classList.remove('hidden'); 
    } else { 
        nav.classList.add('hidden'); 
    }
    document.getElementById('siteInfoContent').innerHTML = h;
    showModal('info');
}

// --- 6. STARTUP SEQUENCE ---



window.onload = async () => {
    // 1. Restore persistent data
    loadState(); 

    // 2. Initialize Logic
    initLocations();
    initPanicButton();

    // 3. Routing Logic
    if (!state.settings || !state.settings.workerName) {
        navigate('setup'); 
        document.getElementById('setupPage')?.classList.remove('hidden');
    } else if (state.activeVisit) {
        navigate('locked'); 
        if (state.activeVisit.status === 'TRAVELLING') startTravellingPulse();
    } else {
        navigate('main');
    }

    console.log("üöÄ System Initialised: Operational Mode");
};
</script>
</body>
</html>


























