<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>%%APP_NAME%%</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
/* 1. FORCE SYSTEM DIM: Required for OS-level dimming */
html.system-dim, body.system-dim { background-color: #000000 !important; color-scheme: dark !important; }

/* 2. BASE STYLES */
body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: contain; background-color: #111827; color: white; height: 100%; width: 100%; overflow: hidden; }

.page { display: none; height: 100%; width: 100%; flex-direction: column; position: absolute; top: 0; left: 0; background-color: #111827; }
.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: #111827; border-bottom: 1px solid #374151; flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { flex: 1; overflow-y: auto; padding: 1rem; z-index: 10; position: relative; }

.footer-bar { padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); background-color: #111827; border-top: 1px solid #374151; flex-shrink: 0; z-index: 20; }

/* 3. LONG-PRESS SOS & START LOGIC */
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; -webkit-user-select: none; }
.long-press-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: rgba(255, 255, 255, 0.3); transition: width 0.2s ease-out; z-index: 1; }
.long-press-btn.pressing::after { width: 100%; transition: width 1.5s linear; }
.long-press-btn.holding::after { width: 100%; transition: width 3s linear; }
.long-press-btn:active { transform: scale(0.96); }

/* 4. UI ANIMATIONS & PULSE */
.pulse-border { animation: pulseGlow 2s infinite; border-width: 2px; }
@keyframes pulseGlow {
    0% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
    50% { border-color: #a855f7; box-shadow: 0 0 15px 2px rgba(168, 85, 247, 0.4); }
    100% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
}

.slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* 5. FORM & INPUT COMPONENTS */
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.setting-card { background-color: #1f2937; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #374151; margin-bottom: 1rem; }
.setting-label { display: block; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.form-input { width: 100%; background-color: #111827; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.lbl-blue { color: #60a5fa; } .lbl-green { color: #4ade80; } .lbl-purple { color: #c084fc; } .lbl-red { color: #f87171; } .lbl-gray { color: #9ca3af; }

.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }

.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
</style>
</head>
<body class="bg-gray-900 text-white">

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-2xl flex items-center gap-3 z-[1000] translate-y-[-150%] transition-transform duration-300">
    <div class="text-xl">‚úÖ</div>
    <p class="font-bold text-sm" id="toastText">Ready</p>
</div>

<div id="setupPage" class="page active bg-gray-900 z-[60]">
    <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-900">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1">
            <div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div>
            <div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div>
            <div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div>
        </div>
    </div>

    <div id="wizStep1" class="wizard-step active p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Who are you?</h2>
        <label for="set_workerName" class="setting-label lbl-blue">Full Name</label>
        <input id="set_workerName" class="form-input mb-4" placeholder="e.g. John Doe">
        <label for="set_workerPhone" class="setting-label lbl-blue">Mobile Number</label>
        <input id="set_workerPhone" type="tel" class="form-input mb-4" placeholder="021...">
        <label for="set_workerEmail" class="setting-label lbl-blue">Work Email</label>
        <input id="set_workerEmail" type="email" class="form-input mb-8" placeholder="name@org.co.nz">
<div class="mt-auto"><button onclick="saveIdentity()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl text-lg shadow-lg">Next: Security ‚Üí</button></div>    </div>

    <div id="wizStep2" class="wizard-step p-6 overflow-y-auto">
        <h2 class="text-3xl font-bold text-white mb-2">Security Codes</h2>
        <div class="bg-gray-800 p-4 rounded-xl border border-green-500/30 mb-6">
            <h3 class="text-green-400 font-bold mb-1">1. Standard PIN (Local Only)</h3>
            <input id="setup_pin1" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest" placeholder="0000">
            <input id="setup_pin2" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest mt-2" placeholder="Confirm">
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 mb-8">
            <h3 class="text-purple-400 font-bold mb-1">2. Duress PIN (Local Only)</h3>
            <input id="set_duressPin" type="password" maxlength="4" inputmode="numeric" class="form-input text-center text-4xl tracking-widest border-purple-500/50" placeholder="9999">
        </div>
        <div class="flex gap-3 mt-auto">
            <button onclick="wizBack('wizStep2', 'wizStep1')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl">Back</button>
            <button onclick="savePin()" class="flex-[2] py-4 bg-blue-600 font-bold rounded-xl shadow-lg">Next: Contacts ‚Üí</button>
        </div>
    </div>

<div id="wizStep3" class="wizard-step p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-white mb-2">Contacts</h2>
    
    <label for="set_emgName" class="setting-label lbl-red">Primary Contact Name</label>
    <input id="set_emgName" class="form-input mb-2" placeholder="Full Name">
    
    <label for="set_emgPhone" class="setting-label text-[10px] text-gray-500 -mt-1 ml-1">Primary Phone</label>
    <input id="set_emgPhone" type="tel" class="form-input mb-2" placeholder="Mobile Number">
    
    <label for="set_emgEmail" class="setting-label text-[10px] text-gray-500 -mt-1 ml-1">Primary Email</label>
    <input id="set_emgEmail" type="email" class="form-input mb-6" placeholder="Email Address">

    <label for="set_escName" class="setting-label lbl-gray">Escalation Manager Name</label>
    <input id="set_escName" class="form-input mb-2" placeholder="Manager Name">
    
    <label for="set_escPhone" class="setting-label text-[10px] text-gray-500 -mt-1 ml-1">Manager Phone</label>
    <input id="set_escPhone" type="tel" class="form-input mb-2" placeholder="Mobile Number">
    
    <label for="set_escEmail" class="setting-label text-[10px] text-gray-500 -mt-1 ml-1">Manager Email</label>
    <input id="set_escEmail" type="email" class="form-input mb-8" placeholder="Work Email">
    
    <div class="flex gap-3 mt-auto">
        <button onclick="wizBack('wizStep3', 'wizStep2')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl">Back</button>
        <button onclick="finishSetup()" class="flex-[2] py-4 bg-green-600 font-bold rounded-xl shadow-lg uppercase">‚úÖ Launch App</button>
    </div>
</div>
</div>

<div id="mainPage" class="page">
    <div class="header-bar">
        <div class="flex flex-col">
            <h1 class="text-lg font-black text-blue-400 leading-none">%%ORG_NAME%%</h1>
            <span class="text-[9px] text-gray-500 font-bold tracking-widest uppercase">Safety Dashboard</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="navigate('settings')" class="p-2 text-gray-400">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="content-area">
        <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded text-center font-bold animate-pulse">Syncing...</div>
        <div class="flex gap-2 mb-4">
<button onclick="forceSync(false)" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-blue-400 text-2xl shadow-lg transition">‚Üª</button>            <button onclick="openLocModal()" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-green-400 text-2xl shadow-lg transition">+</button>
            <div id="travelRow" class="flex-1"></div>
        </div>
        <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-1">Safety Destinations</div>
        <div id="locationList" class="grid grid-cols-2 gap-3 pb-4"></div>
    </div>
    <div class="footer-bar">
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2 font-black tracking-tighter">
                <span class="text-gray-400 text-[10px] uppercase">Estimated visit time</span>
                <span id="durationDisplay" class="text-xs text-blue-400">0 mins</span>
            </div>
            <input id="durationSlider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb" oninput="updateArrivedButtonState()">
        </div>
        <div class="flex gap-4">
            <button id="btnQuick" onclick="showModal('template')" class="flex-none w-24 py-4 bg-violet-900 text-violet-300 font-bold rounded-xl text-xs tracking-widest uppercase">Forms</button>
            <button type="button" id="btnMainAction" class="long-press-btn flex-1 py-4 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all tracking-tight" disabled>Start</button>
        </div>
    </div>
</div>

<div id="batterySaver" class="hidden fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center select-none">
    <div id="saverProgress" class="absolute inset-0 bg-white/5 opacity-0 transition-opacity duration-[2000ms] pointer-events-none"></div>
    <div class="text-gray-800 text-sm font-bold animate-pulse uppercase tracking-[0.3em] z-10">Battery Saver Active</div>
    <div class="text-gray-900 text-[10px] uppercase font-black tracking-widest mt-4 z-10 border border-gray-900 px-4 py-2 rounded-full font-bold">Hold screen to wake</div>
</div>

<div id="lockedPage" class="page bg-black">
    <div class="flex-1 flex flex-col p-6">
        <div class="flex justify-end mb-8">
            <button onclick="handlePanic()" class="w-24 h-24 bg-red-600 rounded-full font-black text-white text-2xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center select-none tracking-widest">SOS</button>
        </div>
        
        <div class="text-center flex-1">
            <div id="visitTimer" class="text-8xl font-mono font-bold text-white tracking-tighter">00:00</div>
            <h2 id="lockedLocationName" class="text-2xl font-bold text-gray-400 mt-2 tracking-tight">---</h2>
            
            <div class="mt-12 w-full max-w-xs mx-auto space-y-4">
                <input type="password" id="lock_pin_input" maxlength="4" inputmode="numeric" placeholder="Enter PIN" class="form-input text-center text-3xl tracking-[0.5em]">
                <button onclick="checkPin()" class="w-full py-4 bg-blue-600 font-bold rounded-2xl text-lg">Unlock Options</button>
                <button onclick="endVisit()" class="w-full py-4 bg-red-600 font-bold rounded-2xl text-lg">End Visit</button>
            </div>
        </div>
    </div>
</div>

<div id="settingsPage" class="page bg-gray-800">
    <div class="header-bar">
        <h1 class="text-2xl font-bold text-white uppercase tracking-tighter">Edit Settings</h1>
        <button onclick="navigate('main')" class="text-3xl text-gray-400">√ó</button>
    </div>
    <div class="content-area">
        <div class="setting-card">
            <label for="set_url" class="setting-label lbl-blue">System URL</label>
            <input type="text" id="set_url" class="form-input" value="%%GOOGLE_SHEET_URL%%">
            <button onclick="hardRefreshUpdate()" class="w-full mt-2 py-2 bg-gray-700 hover:bg-gray-600 rounded text-[10px] font-black uppercase text-gray-300">Clear Cache & Reload</button>
        </div>

<div class="setting-card border-blue-500/20 bg-blue-900/10">
    <div class="setting-label lbl-blue mb-3">Handset Diagnostics</div>
    <div class="space-y-2">
        <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">Device ID:</span><span id="set_deviceId_diag" class="text-white">---</span></div>
        <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">Backend:</span><span id="diagBackend" class="text-purple-400">v79.35</span></div>
        <div class="flex justify-between text-[10px] uppercase font-black"><span id="diagCloud" class="text-green-400">Ready</span></div>
    </div>
</div>

        <div class="setting-card border-purple-500/20 bg-purple-900/10">
            <div class="setting-label lbl-purple mb-3">Diagnostic Status</div>
            <div class="space-y-2">
                <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">Device ID:</span><span id="set_deviceId_diag" class="text-white">---</span></div>
                <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">App:</span><span id="diagApp" class="text-white">---</span></div>
                <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">Backend:</span><span id="diagBackend" class="text-purple-400">v79.35</span></div>
                <div class="flex justify-between text-[10px] uppercase font-black"><span class="text-gray-500">Last Sync:</span><span id="diagCloud" class="text-green-400">Ready</span></div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="localStorage.clear(); location.reload();" class="flex-1 py-4 bg-red-900/20 text-red-500 font-bold rounded-xl text-[10px] uppercase">Reset App</button>
            <button onclick="updateSettings()" class="flex-[2] py-4 bg-blue-600 text-white font-black rounded-xl text-xs uppercase shadow-xl">Save & Sync</button>
        </div>
    </div>
</div>

<div id="reportPage" class="page bg-gray-900">
    <div class="header-bar">
        <h2 id="reportTitle" class="text-lg font-black text-blue-400 uppercase tracking-widest">Visit Report</h2>
    </div>
    <div class="content-area" id="reportFields">
        </div>
    <div class="footer-bar flex gap-3">
        <button onclick="navigate('main')" class="flex-1 py-4 bg-gray-800 font-bold rounded-xl text-gray-400">Cancel</button>
        <button id="btnSubmitRep" onclick="submitReport()" class="flex-[2] py-4 bg-green-600 font-black rounded-xl uppercase shadow-lg">Submit & End</button>
    </div>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-[150]">
    
    <div id="infoModal" class="hidden bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700">
        <h2 id="infoTitle" class="text-xl font-bold mb-4 text-white">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm mb-6"></div>
        <a id="btnSiteNav" href="#" target="_blank" class="block w-full py-4 bg-purple-600 text-white font-bold rounded-xl text-center shadow-xl mb-4 uppercase">üó∫Ô∏è Navigate</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 font-bold rounded-xl text-white">CLOSE</button>
    </div>

<div id="locationModal" class="hidden bg-gray-800 rounded-2xl p-6 w-full max-w-sm relative z-50 border border-gray-700 shadow-2xl">
    <h2 id="locModalTitle" class="text-xl font-black mb-6 text-white uppercase tracking-widest">Edit Destination</h2>
    <input type="hidden" id="locId">
<div class="space-y-4">
    <div>
        <label for="locName" class="setting-label text-gray-500">Site Name</label>
        <input type="text" id="locName" class="form-input" placeholder="Required">
    </div>
    <div>
        <label for="locBusiness" class="setting-label text-gray-500">Business / Company</label>
        <input type="text" id="locBusiness" class="form-input" placeholder="e.g. ABC Ltd">
    </div>
    <div>
        <label for="locAddr" class="setting-label text-gray-500">Physical Address</label>
        <div class="flex gap-2">
            <input type="text" id="locAddr" class="form-input mb-0 flex-1">
            <button onclick="captureGPS(this)" class="bg-blue-600 p-3 rounded-xl font-black text-xs shadow-lg">üìç GPS</button>
        </div>
    </div>
</div>
</div>

    <div id="templateModal" class="hidden bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700 text-center">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Forms Library</h2>
        <div id="templateList" class="grid grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
        <button onclick="closeModal('template')" class="mt-6 w-full py-4 bg-gray-700 rounded-xl font-black text-white uppercase tracking-widest">Close</button>
    </div>
</div>

<script>
    
// --- 1. GLOBAL CONSTANTS & CORE STATE ---
const APP_VERSION = "v79.35";
const CONFIG = {
    url: "%%GOOGLE_SHEET_URL%%",
    key: "%%SECRET_KEY%%",
    mileage: true
};

// Centralized state object
let state = { 
    settings: {}, 
    locations: [], 
    selectedLocationId: null, 
    visitDurationMinutes: 0,
    activeVisit: null, 
    cachedForms: {}, 
    pendingUploads: [],
    globalForms: [],
    photoStore: {},
    lowBatSent: false,
    meta: {} 
};

// Variables for hardware and timers
let synth, checkinIntervalId, mainScreenReminderTimer, wakeLock, timerInt, travellingInterval;
let autoDimTimer = null;
let tempPhoto = null, sigPad = null;
let deferredPrompt, isMidVisitUpdate = false, currentActiveTemplate = "", isDrawing = false;
let calculatedDist = null, gpsWarm = false, gpsWatchId = null, lastAlertTime = 0;
let currentBatteryLevel = "100%";
let uploadQueue = []; 
let travelTargetName = ""; // Tracks driving destination

// --- 2. STORAGE & SYNCHRONIZATION ---

/* Modern Standard: Uses the navigator.storage API to request persistence.*/
/* This replaces the deprecated webkitPersistentStorage and StorageType calls.*/

/**
 * FIXED: Standardized Storage Persistence
 * Uses the modern navigator.storage API to replace deprecated StorageType logic.
 */
async function saveState() {
    try {
        // MODERN STANDARD: Requests persistence from the OS
        if (navigator.storage && navigator.storage.persist) {
            const isPersisted = await navigator.storage.persist();
            if (isPersisted) {
                console.log("üíæ Data persistence confirmed by browser.");
            }
        }
        
        const stateString = JSON.stringify(state);
        localStorage.setItem('otg_worker_state', stateString);
    } catch (e) {
        console.error("Critical: Storage Failure", e);
    }
}

function loadState() {
    const saved = localStorage.getItem('otg_worker_state');
    if (saved) {
        try {
            state = JSON.parse(saved);
        } catch (e) {
            console.error("Critical: State Corrupted", e);
        }
    }
}

/*Robust Refresh: Uses async to prevent library crashes.*/
async function hardRefreshUpdate() {
    if(!confirm("Force reload and clear internal app memory?")) return;
    showToast("üßπ Deep cleaning system cache...");

    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) { await r.unregister(); }
    }

    if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) { await caches.delete(k); }
    }

    state.meta.backendVersion = null;
    await saveState(); 
    location.reload(true); 
}

// --- 3. DASHBOARD & UI RENDERING ---

/**
 * Starts a visit or travel session.
 */
function startVisit(id) {
    const loc = state.locations.find(l => l.id === id);
    if (!loc) return;
    
    state.activeVisit = { 
        id, 
        locationName: loc.name, 
        startTime: Date.now(), 
        status: (id === 'travel' ? 'TRAVELLING' : 'ON_SITE') 
    };

    saveState();
    navigate('locked');
    startCheckinTimer();
    speak(`Visit started at ${loc.name}`);

    // GLUE: Automatically dim the screen if driving to save battery
    if (id === 'travel') {
        setTimeout(() => toggleBatterySaver(true), 2000); 
    }
}
/**
 * FIXED: endVisit (No PIN required, triggers Report Screen)
 */
function endVisit() {
    if (!state.activeVisit) return;
    
    // 1. Clear active timers
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    
    const locName = state.activeVisit.locationName;
    const template = (state.activeVisit.id === 'travel') ? 'Travel Report' : 'Standard Visit Note';
    
    // 2. Populate Report Page (Fixes innerText error)
    const titleEl = document.getElementById('reportTitle');
    const fieldArea = document.getElementById('reportFields');
    
    if (titleEl) titleEl.innerText = `Report: ${locName}`;
    
    // 3. Navigate to Reporting context
    buildReportForm(template, fieldArea);
    navigate('report');
}
/**
 * Validates the entered PIN against the masked version in settings.
 */
function checkPin() {
    const input = document.getElementById('lock_pin_input').value;
    const maskedInput = btoa(input); // Matches the masking used in savePin

    if (maskedInput === state.settings.pinCode) {
        document.getElementById('lock_pin_input').value = ""; // Clear for safety
        showModal('template'); // Opens the form selection menu
    } else {
        showToast("Incorrect PIN");
        // Haptic feedback if supported
        if (navigator.vibrate) navigator.vibrate(200);
    }
}

/**
 * Screen WakeLock: Prevents the phone from sleeping during active sessions.
 */
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("üîí WakeLock Active");
        }
    } catch (err) {
        console.warn("WakeLock failed:", err.message);
    }
}
/**
 * Clears the signature canvas for a specific field index.
 */
function clearSig(index) {
    const canvas = document.getElementById(`sig-canvas-${index}`);
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
}

/**
 * Creates the pulsing effect for the Travel Tile when active.
 */
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        const tr = document.getElementById('travelRow');
        if (tr) tr.classList.toggle('opacity-70');
    }, 1000);
}
/**
 * RESTORED: Auto-Dim Inactivity Logic
 */
/**
 * RESTORED: Unified Battery Saver & Inactivity Logic
 */
let inactivityTimer; // Single declaration to prevent SyntaxError

function resetAutoDim() {
    clearTimeout(inactivityTimer);
    if (state.activeVisit && document.getElementById('batterySaver')?.classList.contains('hidden')) {
        // Auto-dim after 5 minutes of inactivity during a visit
        inactivityTimer = setTimeout(() => toggleBatterySaver(true), 300000);
    }
}

function initAutoDimListeners() {
    ['mousedown', 'mousemove', 'keypress', 'touchstart', 'scroll'].forEach(name => {
        document.addEventListener(name, resetAutoDim, {passive: true});
    });
    resetAutoDim();
}

function toggleBatterySaver(force) {
    const saver = document.getElementById('batterySaver');
    const progress = document.getElementById('saverProgress');
    if (!saver) return;

    const isCurrentlyDim = !saver.classList.contains('hidden');
    const targetState = (force !== undefined) ? force : !isCurrentlyDim;

    if (targetState) {
        saver.classList.remove('hidden');
        document.documentElement.classList.add('system-dim'); // Triggers OS-level dimming
        if (progress) progress.style.opacity = "0"; 
        initWakeListener(); 
        clearTimeout(inactivityTimer);
    } else {
        saver.classList.add('hidden');
        document.documentElement.classList.remove('system-dim');
        resetAutoDim(); 
    }
}
/**
 * GLUE: Attaches the hold-to-wake duration to the black overlay
 */
function initWakeListener() {
    const saver = document.getElementById('batterySaver');
    let wakeTimer;
    
    const startWake = () => {
        document.getElementById('saverProgress').style.opacity = "1";
        wakeTimer = setTimeout(() => {
            toggleBatterySaver(false);
            showToast("Screen Active");
        }, 2000); // Must hold for 2 seconds to "wake"
    };

    const stopWake = () => {
        document.getElementById('saverProgress').style.opacity = "0";
        clearTimeout(wakeTimer);
    };

    saver.onmousedown = startWake; saver.onmouseup = stopWake;
    saver.ontouchstart = startWake; saver.ontouchend = stopWake;
}   
/**
 * FIXED: forceSync Payload
 * Removes forced "EMERGENCY" status unless explicitly triggered by SOS.
 */
async function forceSync(highPriority = false) {
    if (!state.settings.workerName) return;
    const banner = document.getElementById('uploadBanner');
    if (banner) banner.classList.remove('hidden');

    const dId = state.settings.deviceId || getDeviceID();
    
    // Determine the true status
    let currentStatus = "SYNC";
    if (highPriority) {
        currentStatus = "EMERGENCY - PANIC";
    } else if (state.activeVisit) {
        currentStatus = state.activeVisit.status || "ON_SITE";
    }

    const payload = {
        key: CONFIG.key,
        deviceId: dId,
        "Worker Name": state.settings.workerName,
        "Alarm Status": currentStatus, // Corrected logic
        "Timestamp": new Date().toISOString()
    };

    try {
        const queryString = new URLSearchParams(payload).toString();
        await fetch(`${CONFIG.url}?${queryString}`, { method: 'POST', mode: 'no-cors' });
        
        state.meta.lastSync = new Date().toLocaleTimeString();
        await saveState(); 
        showToast(highPriority ? "üö® SOS ALERT SENT" : "‚úÖ SYNC SUCCESSFUL");
        
        if (!highPriority) pullLatestData(); 
    } catch (e) {
        showToast("üì° OFFLINE: Data Queued");
    } finally {
        if (banner) banner.classList.add('hidden');
    }
}
/**
 * RESTORED: finishSetup (Generates ID & Triggers Handshake)
 */
async function finishSetup() {
    state.settings.workerName = document.getElementById('set_workerName').value;
    state.settings.workerPhone = document.getElementById('set_workerPhone').value;
    state.settings.workerEmail = document.getElementById('set_workerEmail').value;
    
    // GENERATE ID: Mandatory for backend matching
    if (state.settings.workerName && !state.settings.deviceId) {
        state.settings.deviceId = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    if (state.settings.workerName) {
        await saveState();
        showToast("Synchronising Identity...");
        await forceSync(); // Registers name & device ID immediately
        navigate('main');
    } else {
        showToast("Please enter your name");
    }
}
    
/**
 * FIXED: buildReportForm (Restores Golden UI with [$], [TIME], and [GPS] tags)
 */
function buildReportForm(n, c) {
    state.photoStore = {};
    const sn = n ? n.trim() : "(Standard)";
    
    // 1. Template Resolution
    let questions = state.globalForms?.find(f => f.name.trim() === sn)?.questions || 
                    state.cachedForms[sn] || 
                    state.cachedForms["(Standard)"];
    
    c.innerHTML = '';
    
    if (!questions) {
        c.innerHTML = '<label class="setting-label">Visit Notes</label><textarea id="rep_notes" class="form-input h-32"></textarea>';
        return;
    }

    questions.forEach((f, i) => {
        let type = 'text', labelText = f.text || f, dropOptions = [];
        const upper = labelText.toUpperCase();
        const fieldId = `dyn_field_${i}`;

        // 2. Advanced Tag Detection
        if (upper.includes('[HEADING]')) { 
            type = 'header'; labelText = labelText.replace(/\[HEADING\]/gi, '').trim(); 
        } else if (upper.includes('[SIGN]')) { 
            type = 'signature'; labelText = labelText.replace(/\[SIGN\]/gi, '').trim(); 
        } else if (upper.includes('[PHOTO]')) { 
            type = 'photo'; labelText = labelText.replace(/\[PHOTO\]/gi, '').trim(); 
        } else if (upper.includes('[GPS]')) { 
            type = 'gps'; labelText = labelText.replace(/\[GPS\]/gi, '').trim(); 
        } else if (upper.includes('[YESNO]')) { 
            type = 'yesno'; labelText = labelText.replace(/\[YESNO\]/gi, '').trim(); 
        } else if (upper.includes('[CHECK]')) { 
            type = 'checkbox'; labelText = labelText.replace(/\[CHECK\]/gi, '').trim(); 
        } else if (upper.includes('[DATE]')) { 
            type = 'date'; labelText = labelText.replace(/\[DATE\]/gi, '').trim(); 
        } else if (upper.includes('[TIME]')) { 
            // RESTORED: [TIME] tag support
            type = 'time'; labelText = labelText.replace(/\[TIME\]/gi, '').trim(); 
        } else if (upper.includes('[NUMBER]')) { 
            type = 'number'; labelText = labelText.replace(/\[NUMBER\]/gi, '').trim(); 
        } else if (upper.includes('[$]')) { 
            // RESTORED: [$] Currency tag support
            type = 'currency'; labelText = labelText.replace(/\[\$\]/gi, '').trim(); 
        } else if (upper.includes('[1TEXT]')) { 
            type = '1text'; labelText = labelText.replace(/\[1TEXT\]/gi, '').trim(); 
        } else if (upper.startsWith('[DROP')) {
            type = 'drop';
            const match = labelText.match(/\[DROP\s*,\s*(.*?)\s*\]/i);
            if (match) { 
                dropOptions = match[1].split(',').map(o => o.trim()); 
                labelText = labelText.replace(match[0], '').trim(); 
            }
        }

        const container = document.createElement('div');
        container.className = "mb-4";

        // 3. Render Element Logic
        if (type === 'header') {
            container.innerHTML = `<h3 class="text-blue-400 font-bold uppercase text-xs border-b border-gray-700 pb-1 mb-2">${labelText}</h3>`;
        } else {
            container.innerHTML = `<label for="${fieldId}" class="setting-label lbl-gray">${labelText}</label>`;

            if (type === 'photo') {
                container.innerHTML += `<button type="button" onclick="document.getElementById('${fieldId}').click()" id="lbl_${i}" class="form-input text-center">üì∏ Take Photo</button>
                                        <input type="file" id="${fieldId}" capture="environment" class="hidden" onchange="handlePhoto(this, '${labelText}')">`;
            } else if (type === 'signature') {
                container.innerHTML += `<div class="bg-white rounded-lg p-1"><canvas id="sig-canvas-${i}" class="w-full h-40"></canvas></div>
                                        <button type="button" class="text-[10px] font-bold text-gray-500 uppercase mt-1" onclick="clearSig(${i})">Clear Signature</button>`;
            } else if (type === 'gps') {
                container.innerHTML += `<div class="flex gap-2"><button type="button" onclick="captureGPS(this)" class="bg-blue-600 p-3 rounded-lg text-xs font-bold uppercase">GPS</button>
                                        <input type="text" id="${fieldId}" class="form-input flex-1 font-mono text-xs" readonly data-key="${labelText}" placeholder="Capture GPS"></div>`;
            } else if (type === 'currency') {
                container.innerHTML += `<div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
                                        <input type="number" step="0.01" id="${fieldId}" class="form-input pl-8 font-bold" data-key="${labelText}"></div>`;
            } else if (type === 'time' || type === 'date' || type === 'number' || type === '1text') {
                const inputType = (type === '1text') ? 'text' : type;
                container.innerHTML += `<input type="${inputType}" id="${fieldId}" class="form-input font-bold" data-key="${labelText}">`;
            } else if (type === 'checkbox') {
                container.innerHTML = `<label class="flex items-center gap-3 p-4 bg-gray-800 rounded-xl border border-gray-600 active:bg-gray-700 cursor-pointer">
                                        <input id="${fieldId}" type="checkbox" class="w-7 h-7 text-blue-600 rounded" data-key="${labelText}">
                                        <span class="text-sm font-bold text-gray-200 select-none">${labelText}</span></label>`;
            } else if (type === 'drop') {
                let opts = dropOptions.map(o => `<option value="${o}">${o}</option>`).join('');
                container.innerHTML += `<select id="${fieldId}" class="form-input font-bold" data-key="${labelText}"><option value="">Select...</option>${opts}</select>`;
            } else {
                container.innerHTML += `<textarea id="${fieldId}" class="form-input h-24" data-key="${labelText}"></textarea>`;
            }
        }
        c.appendChild(container);
    });

    // 4. Hardware Re-Initialization
    setTimeout(() => {
        document.querySelectorAll('canvas[id^="sig-canvas-"]').forEach(canvas => {
            if (typeof resizeCanvas === 'function') resizeCanvas(canvas);
            if (typeof initSigPad === 'function') initSigPad(canvas);
        });
    }, 600);
}
/**
 * Processes and saves the security PIN.
 * Uses Base64 encoding as a basic masking layer before saving to state.
 */
function savePin() {
    const p1 = document.getElementById('setup_pin1').value;
    const p2 = document.getElementById('setup_pin2').value;
    const duress = document.getElementById('set_duressPin').value;

    if (p1.length === 4 && p1 === p2) {
        state.settings.pinCode = btoa(p1);
        state.settings.duressPin = btoa(duress);
        // Only advance if validation passes
        wizNext('wizStep2', 'wizStep3'); 
    } else {
        showToast("Standard PINs must be 4 digits and match.");
    }
    // REMOVED the extra wizNext from here
}


    
// --- 5. IDENTITY & DIAGNOSTICS ---

/**
 * FIXED: populateSettingsForm (Now updates all Diagnostic fields)
 */
/**
 * FIXED: Diagnostic Form updates Backend version
 */
function populateSettingsForm() {
    const urlInput = document.getElementById('set_url');
    if (urlInput) urlInput.value = state.settings.googleSheetUrl || "%%GOOGLE_SHEET_URL%%";

    const diagId = document.getElementById('set_workerName_diag');
    if (diagId) diagId.innerText = state.settings.workerName || "Not Setup";
    
    const diagDev = document.getElementById('set_deviceId_diag');
    if (diagDev) diagDev.innerText = state.settings.deviceId || "Pending";

    const diagBack = document.getElementById('diagBackend');
    if (diagBack) diagBack.innerText = state.meta.backendVersion || "v79.35"; // Identifies version

    const diagApp = document.getElementById('diagApp');
    if (diagApp) diagApp.innerText = APP_VERSION;
}
    
/**
 * RESTORED: Working Page Router
 */
function navigate(p) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(e => {
        e.classList.remove('active');
        e.classList.add('hidden');
    });

    // Show target page
    const target = document.getElementById(p + 'Page');
    if (target) {
        target.classList.add('active');
        target.classList.remove('hidden');
    }

    if (p === 'main') renderLocations();
    if (p === 'settings') populateSettingsForm();
}
    
// UPDATE: showModal to trigger renderForms
function showModal(id) {
    const backdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById(id + 'Modal');
    if (backdrop && modal) {
        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
        modal.classList.remove('hidden');
        if (id === 'template') renderForms(); // FIXED: Triggers rendering
    }
}

function closeModal(id) {
    const backdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById(id + 'Modal');
    if (backdrop && modal) {
        backdrop.classList.add('hidden');
        backdrop.classList.remove('flex');
        modal.classList.add('hidden');
    }
}

/**
 * FIXED: Toast Notifications (Matches HTML IDs)
 */
function showToast(msg) {
    const banner = document.getElementById('toastMsg');
    const text = document.getElementById('toastText');
    if (!banner || !text) return;

    text.innerText = msg;
    banner.classList.remove('translate-y-[-150%]'); // Slides into view
    
    // Auto-hide after 3 seconds
    setTimeout(() => { 
        banner.classList.add('translate-y-[-150%]'); 
    }, 3000);
}
    
/**
 * FIXED: Wizard Navigation (Uses 'active' class for CSS compatibility)
 */
function wizNext(currentId, nextId) {
    const curr = document.getElementById(currentId);
    const next = document.getElementById(nextId);
    
    if (curr && next) {
        // Toggle 'active' class to match your CSS visibility rules
        curr.classList.remove('active');
        next.classList.add('active');
        
        // Update Progress Dots
        const step = nextId.replace('wizStep', '');
        if (step == '2') document.getElementById('dot2')?.classList.replace('bg-gray-700', 'bg-blue-500');
        if (step == '3') document.getElementById('dot3')?.classList.replace('bg-gray-700', 'bg-blue-500');
        
        window.scrollTo(0, 0);
    }
}

function wizBack(currentId, prevId) {
    const curr = document.getElementById(currentId);
    const prev = document.getElementById(prevId);
    if (curr && prev) {
        curr.classList.remove('active');
        prev.classList.add('active');
        window.scrollTo(0, 0);
    }
}

/**
 * Initialises the Panic/Emergency button listeners.
 * Configured for a "Long Press" to prevent accidental triggers.
 */
function initPanicButton() {
    const btn = document.getElementById('panicBtn');
    if (!btn) return;

    let panicTimer;
    
    // Long-press logic (requires 2 seconds of holding)
    btn.addEventListener('mousedown', () => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    });

    btn.addEventListener('mouseup', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });

    btn.addEventListener('touchstart', (e) => {
        btn.classList.add('bg-red-500', 'scale-95');
        panicTimer = setTimeout(handlePanic, 2000);
    }, {passive: true});

    btn.addEventListener('touchend', () => {
        btn.classList.remove('bg-red-500', 'scale-95');
        clearTimeout(panicTimer);
    });
    /**
 * GLUE: Global Long-Press CSS Trigger
 * Links the visual progress bar (::after) to the JavaScript timer.
 */
document.querySelectorAll('.long-press-btn').forEach(btn => {
    const startHolding = () => btn.classList.add('holding');
    const stopHolding = () => btn.classList.remove('holding');
    
    btn.addEventListener('mousedown', startHolding);
    btn.addEventListener('mouseup', stopHolding);
    btn.addEventListener('touchstart', startHolding, {passive: true});
    btn.addEventListener('touchend', stopHolding);
});
}

/**
 * The action triggered by the panic button.
 */
function handlePanic() {
    if (confirm("üö® TRIGGER EMERGENCY ALERT?\n\nThis will notify the server and capture your current GPS location.")) {
        showToast("Sending Emergency Signal...");
        // This pushes a high-priority packet to your upload queue
        forceSync(true); 
    }
}
function initLocations() {
    if (!state.locations) state.locations = [];
    
    // Always force Travelling to index 0
    state.locations = state.locations.filter(l => l.id !== 'travel');
    state.locations.unshift({
        id: 'travel',
        name: 'Travelling',
        noReport: localStorage.getItem('otg_user_travel_pref') === 'true'
    });

    renderLocations();
    checkVehicleStatus(); 
    populateSettingsForm(); 
}
/**
 * --- MASTER OPERATIONAL LOGIC ---
 * RESTORED: Advanced Smoothing, Compression, and Hardware Integration
 */

/**
 * FIXED: renderLocations (Glues tiles to the footer button)
 */
function renderLocations() {
    const list = document.getElementById('locationList');
    const travel = document.getElementById('travelRow');
    if (!list || !travel) return;
    
    list.innerHTML = ''; travel.innerHTML = '';

    state.locations.forEach(loc => {
        if (!loc || !loc.id) return;
        const tile = (loc.id === 'travel') ? createTravelTile(loc) : createLocationTile(loc);
        (loc.id === 'travel') ? travel.appendChild(tile) : list.appendChild(tile);
    });

    updateArrivedButtonState(); // Ensure footer button reflects selection
}

/**
 * FIXED: Unified Travel Logic (Simply "Travel", No Pulse)
 */
function updateArrivedButtonState() {
    const btn = document.getElementById('btnMainAction');
    const val = parseInt(document.getElementById('durationSlider').value);
    const display = document.getElementById('durationDisplay');
    
    const mins = val <= 10 ? val * 5 : (val - 10) * 15 + 50;
    state.visitDurationMinutes = mins;
    if (display) display.innerText = mins + " mins";

    if (state.selectedLocationId && mins > 0) {
        btn.disabled = false;
        btn.style.backgroundColor = state.settings.themeColor || "#3b82f6";
        
        if (state.selectedLocationId === 'travel') {
            btn.innerText = "Travel"; // Renamed from "Travel Safety Check"
            btn.style.filter = "none"; // Removed hue-rotate
        } else {
            const loc = state.locations.find(l => l.id === state.selectedLocationId);
            btn.innerText = `Hold to Start: ${loc.name}`;
            btn.style.filter = "none";
        }
        btn.onclick = () => startVisit(state.selectedLocationId);
    } else {
        btn.disabled = true;
        btn.innerText = "Start";
        btn.style.backgroundColor = ""; 
        btn.classList.add('bg-gray-700', 'text-gray-500');
    }
}

    
/**
 * FIXED: createTravelTile (Now calls functional toggle)
 */
function createTravelTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === 'travel';
    const isNoReport = localStorage.getItem('otg_user_travel_pref') === 'true';

    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-purple-500 bg-purple-900/40 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    d.innerHTML = `
        <div class="text-3xl">üõ£Ô∏è</div>
        <div class="flex-1">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black text-purple-400 uppercase tracking-widest">In-Transit Mode</span>
                <button class="text-gray-500 hover:text-white" onclick="editTravelSettings(event)">‚öôÔ∏è</button>
            </div>
            <div class="text-lg font-black text-white leading-tight">Travel</div>
            ${isNoReport ? '<span class="text-[9px] text-gray-400 uppercase font-bold">Fast-Sync (No Report)</span>' : ''}
        </div>
    `;
    d.onclick = () => { state.selectedLocationId = isSel ? null : 'travel'; renderLocations(); };
    return d;
}

/**
 * FIXED: createLocationTile (Restores Golden Info Button)
 */
function createLocationTile(loc) {
    const d = document.createElement('div');
    const isSel = state.selectedLocationId === loc.id;
    d.className = `p-3 rounded-lg border-2 cursor-pointer flex items-center gap-4 transition-all ${isSel ? 'border-blue-500 bg-blue-900/20 shadow-lg' : 'border-gray-700 bg-gray-800'}`;
    
    d.innerHTML = `
        <div class="text-3xl">${loc.icon || 'üè¢'}</div>
        <div class="flex-1">
            <div class="flex justify-between items-start">
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest leading-none mb-1">${loc.companyName || 'Site'}</div>
                <button class="text-blue-400 text-sm" onclick="showSiteInfo('${loc.id}', event)">‚ÑπÔ∏è</button>
            </div>
            <div class="text-lg font-black text-white leading-tight">${loc.name}</div>
        </div>
    `;
    
    d.onclick = () => { 
        state.selectedLocationId = isSel ? null : loc.id; 
        renderLocations(); 
    };
    return d;
}

// 2. SIGNATURE PAD (Gaussian Smoothing & High-DPI Scaling)
function resizeCanvas(canvas) {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
}

function initSigPad(canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false, lastPoint = null;
    
    ctx.lineWidth = 2.5; 
    ctx.lineJoin = 'round'; 
    ctx.lineCap = 'round'; 
    ctx.strokeStyle = '#000000';

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };

    canvas.addEventListener('touchstart', (e) => {
        drawing = true; 
        lastPoint = getPos(e);
        ctx.beginPath(); 
        ctx.moveTo(lastPoint.x, lastPoint.y);
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (!drawing) return;
        e.preventDefault();
        const currentPoint = getPos(e);
        
        // RESTORED: Quadratic Bezier Midpoint logic for smooth curves
        const midPoint = { 
            x: lastPoint.x + (currentPoint.x - lastPoint.x) / 2, 
            y: lastPoint.y + (currentPoint.y - lastPoint.y) / 2 
        };
        
        ctx.quadraticCurveTo(lastPoint.x, lastPoint.y, midPoint.x, midPoint.y);
        ctx.stroke();
        lastPoint = currentPoint;
    }, { passive: false });

    window.addEventListener('touchend', () => { drawing = false; lastPoint = null; });
}
// 3. PHOTO ENGINE (EXIF Stripping & 0.4 Quality Compression)
function handlePhoto(input, key) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => compressImg(e.target.result, key, input.id);
        reader.readAsDataURL(input.files[0]);
    }
}

function compressImg(data, key, inputId) {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let scale = Math.min(600 / img.width, 600 / img.height, 1);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        state.photoStore[key] = canvas.toDataURL('image/jpeg', 0.4);
        
        const labelIndex = inputId.split('_')[2];
        const label = document.getElementById(`lbl_${labelIndex}`);
        if (label) {
            label.innerHTML = "‚úÖ Optimized";
            label.className = "flex-1 py-4 bg-green-900/40 border-2 border-green-500 rounded-xl text-green-400 font-bold text-center";
        }
        showToast(`Processed optimized photo for ${key}`);
    };
    img.src = data;
}

// 4. AUTOMATION & HARDWARE (GPS, Timers, Speech)
/**
 * RESTORED: High-Accuracy GPS Capture
 */
function captureGPS(btn) {
    if (!navigator.geolocation) {
        showToast("GPS Not Supported");
        return;
    }
    btn.innerText = "‚åõ...";
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) {
                input.value = coords;
                showToast("Location Captured");
            }
            btn.innerText = "GPS";
        },
        (err) => {
            showToast("GPS Error: Ensure Location is ON");
            btn.innerText = "GPS";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state.activeVisit) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

/**
 * FIXED: Dashboard Pulse Removal
 */
function checkVehicleStatus() {
    // PULSE REMOVED: Travel tile now looks standard but active
    const tr = document.getElementById('travelRow');
    if (tr) tr.classList.remove('pulse-border'); 
}

function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}
/**
 * RESTORED: Full Report Submission & Sync Queue
 */
async function submitReport() {
    const fields = document.querySelectorAll('#reportFields input, #reportFields textarea, #reportFields select');
    const data = {
        timestamp: new Date().toISOString(),
        location: state.activeVisit ? state.activeVisit.locationName : 'Unknown',
        worker: state.settings.workerName,
        responses: {},
        photos: { ...state.photoStore } // Includes the EXIF-stripped images
    };

    fields.forEach(f => {
        const key = f.dataset.key || f.id;
        data.responses[key] = f.type === 'checkbox' ? f.checked : f.value;
    });

    state.pendingUploads.push(data);
    await saveState();
    
    showToast("Report Saved to Sync Queue");
    state.activeVisit = null;
    state.photoStore = {}; // Clear for next visit
    navigate('main');
    forceSync();
}
function showSiteInfo(id, e) {
    if (e) e.stopPropagation(); 
    const l = state.locations.find(x => x.id === id); 
    if (!l) return;

    document.getElementById('infoTitle').innerText = l.name; 
    let h = "";
    if (l.companyName) h += `<p class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">${l.companyName}</p>`;
    
    const nav = document.getElementById('btnSiteNav');
    if (l.address && l.address.length > 3) { 
        h += `<p class="mt-2 text-white font-bold">${l.address}</p>`;
        // FIXED: navigation URL template literal
        nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.address)}`;
        nav.classList.remove('hidden'); 
    } else { 
        nav.classList.add('hidden'); 
    }
    document.getElementById('siteInfoContent').innerHTML = h;
    showModal('info');
}

/**
 * FIXED: Location Manager (Handles both New and Edit modes)
 */
function openLocModal(id = null) {
    const title = document.getElementById('locModalTitle');
    const nameInp = document.getElementById('locName');
    const busInp = document.getElementById('locBusiness');
    const addrInp = document.getElementById('locAddr');
    const idInp = document.getElementById('locId'); // Ensure this hidden input exists in HTML

    if (id) {
        // EDIT MODE: Populate fields from existing data
        const loc = state.locations.find(l => l.id === id);
        if (loc) {
            title.innerText = "Edit Site";
            if (idInp) idInp.value = id;
            nameInp.value = loc.name || "";
            busInp.value = loc.companyName || "";
            addrInp.value = loc.address || "";
        }
    } else {
        // NEW MODE: Clear all fields
        title.innerText = "New Destination";
        if (idInp) idInp.value = "";
        nameInp.value = ""; busInp.value = ""; addrInp.value = "";
    }
    showModal('location');
}

/**
 * NEW: editTravelSettings (Functional Toggle for Travel Reports)
 */
function editTravelSettings(e) {
    if (e) e.stopPropagation();
    const pref = localStorage.getItem('otg_user_travel_pref') === 'true';
    if (confirm(`Switch to ${pref ? "Detailed Mode (Full Report)" : "Fast-Sync Mode (No Report)"}?`)) {
        localStorage.setItem('otg_user_travel_pref', !pref);
        initLocations();
        showToast("Travel Preference Updated");
    }
}
    
async function saveLoc() {
    const name = document.getElementById('locName').value;
    const id = document.getElementById('locId')?.value; // Check if we are editing
    
    if (!name) return showToast("Site Name is required");

    const locData = {
        name: name,
        companyName: document.getElementById('locBusiness').value,
        address: document.getElementById('locAddr').value,
        icon: 'üè¢'
    };

    if (id) {
        // GOLDEN FIX: Update existing site instead of duplicating
        const index = state.locations.findIndex(l => l.id === id);
        if (index !== -1) {
            state.locations[index] = { ...state.locations[index], ...locData };
            showToast("Site details updated");
        }
    } else {
        // ADD MODE: Create new unique ID
        const newLoc = {
            id: 'loc_' + Date.now(),
            ...locData
        };
        state.locations.push(newLoc);
        showToast("Site added to database");
    }

    await saveState(); // Standardized navigator.storage call
    closeModal('location');
    renderLocations();
}

/**
 * GOLDEN GATEKEEPER: Validates identity before allowing navigation
 */
function saveIdentity() {
    const name = document.getElementById('set_workerName').value;
    const url = document.getElementById('set_url').value;

    // 1. Requirement Check
    if (!name || name.length < 2) {
        showToast("Please enter your full name");
        return; // Stops navigation if name is missing
    }

    // 2. Commit to State
    state.settings.workerName = name;
    state.settings.googleSheetUrl = url;
    
    // 3. Trigger Navigation
    wizNext('wizStep1', 'wizStep2');
}

/**
 * RESTORED: pullLatestData (Handshake via GET)
 */
async function pullLatestData() {
    const url = `${CONFIG.url}?action=sync&key=${CONFIG.key}&worker=${encodeURIComponent(state.settings.workerName)}&deviceId=${state.settings.deviceId}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json(); 
        
        if (data.forms) {
            state.globalForms = data.forms; // Populates Forms Library
            state.locations = (data.sites || []).map(s => ({
                id: 'site_' + s.siteName.replace(/\s/g, ''),
                name: s.siteName,
                companyName: s.company,
                address: s.address,
                templateName: s.template
            })).concat(state.locations.filter(x => x.id.startsWith('loc_')));
            
            state.meta.backendVersion = data.version; 
            await saveState();
            renderLocations();
        }
    } catch (e) { console.error("Sync Error:", e); }
}

    /**
 * NEW: renderForms (Populates the Forms Library Modal)
 */
function renderForms() {
    const list = document.getElementById('templateList');
    if (!list) return;
    list.innerHTML = '';

    // Standard Forms
    const forms = state.globalForms || [];
    forms.forEach(f => {
        const btn = document.createElement('button');
        btn.className = "p-4 bg-gray-700 hover:bg-blue-600 rounded-xl text-xs font-bold uppercase text-white transition-colors";
        btn.innerText = f.name;
        btn.onclick = () => {
            const fieldArea = document.getElementById('reportFields');
            buildReportForm(f.name, fieldArea);
            navigate('report');
            closeModal('template');
        };
        list.appendChild(btn);
    });
}
    
/**
 * NEW: updateSettings (Saves changes from Settings editor)
 */
async function updateSettings() {
    state.settings.workerName = document.getElementById('edit_workerName').value;
    state.settings.workerPhone = document.getElementById('edit_workerPhone').value;
    state.settings.workerEmail = document.getElementById('edit_workerEmail').value;
    state.settings.googleSheetUrl = document.getElementById('set_url').value;
    
    await saveState();
    showToast("Settings Updated");
    await forceSync(); // Push updates to sheet immediately
    navigate('main');
}

    /**
 * RESTORED: Icon Grid Renderer
 * Populates the 'templateList' div with buttons for each form.
 */
function renderIconGrid(forms) {
    const list = document.getElementById('templateList');
    if (!list) return;
    list.innerHTML = '';

    const addBtn = (name, icon, label) => { 
        const b = document.createElement('button'); 
        b.className = "p-4 bg-gray-700 hover:bg-blue-600 rounded-xl flex flex-col items-center justify-center gap-2 transition-all active:scale-95"; 
        b.innerHTML = `<div class="text-3xl">${icon}</div><div class="text-[10px] font-bold uppercase text-white">${label}</div>`; 
        b.onclick = () => {
            closeModal('template');
            const fieldArea = document.getElementById('reportFields');
            buildReportForm(name, fieldArea);
            navigate('report');
        }; 
        list.appendChild(b); 
    };

    if (forms) { 
        forms.forEach(f => { 
            let icon = "üìã"; 
            const n = f.name.toLowerCase();
            if (n.includes('vehicle')) icon = "üöó"; 
            else if (n.includes('incident')) icon = "‚ö†Ô∏è"; 
            addBtn(f.name, icon, f.name); 
        }); 
    }
}

// UPDATE: Modify your existing showModal('template') to trigger this:
function openQuickMenu() {
    showModal('template');
    renderIconGrid(state.globalForms); //
}
// --- 6. STARTUP SEQUENCE ---



window.onload = async () => {
    // 1. Restore persistent data
    loadState(); 

    // 2. Initialize Logic
    initLocations();
    initPanicButton();

    // 3. Routing Logic
    if (!state.settings || !state.settings.workerName) {
        navigate('setup'); 
        document.getElementById('setupPage')?.classList.remove('hidden');
    } else if (state.activeVisit) {
        navigate('locked'); 
        if (state.activeVisit.status === 'TRAVELLING') startTravellingPulse();
    } else {
        navigate('main');
    }

    console.log("üöÄ System Initialised: Operational Mode");
};
</script>
</body>
</html>





