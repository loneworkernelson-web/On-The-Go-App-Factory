<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>%%ORG_NAME%% Safety</title>
<meta name="apple-mobile-web-app-title" content="%%APP_NAME%%">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1e40af">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="%%LOGO_DATA%%">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
/* 1. FACTORY DYNAMIC THEME */
:root {
    --primary: #1e40af;
    --accent: #3b82f6;
}

/* 2. FORCE SYSTEM DIM: Required to dim the OS navigation bar for Battery Saver */
html.system-dim, body.system-dim { 
    background-color: #000000 !important; 
    color-scheme: dark !important; 
}

/* 3. SOPHISTICATED UI BASE */
body { 
    font-family: 'Inter', sans-serif; 
    -webkit-tap-highlight-color: transparent; 
    user-select: none; 
    overscroll-behavior-y: contain; 
    background-color: var(--primary); 
    color: white; 
    height: 100%; 
    width: 100%; 
    overflow: hidden; 
    display: flex; /* Added flex */
    flex-direction: column; /* Stacks banners above pages */
    padding-top: env(safe-area-inset-top); /* Handles notch globally */
}
.page { 
    display: none; 
    flex: 1; 
    width: 100%; 
    flex-direction: column; 
    background-color: var(--primary);
    overflow: hidden; /* Prevents the whole page from bouncing */
}
.page.active { display: flex; z-index: 10; }

.header-bar { padding: 0.75rem 1rem; background-color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 20; display: flex; justify-content: space-between; align-items: center; }
.content-area { 
    flex: 1; 
    padding: 1rem; 
    overflow-y: auto; /* Enables vertical scrolling */
    -webkit-overflow-scrolling: touch; /* Ensures smooth 'momentum' scrolling on iPhones */
    display: flex;
    flex-direction: column;
}
.footer-bar {
    flex-shrink: 0; /* Prevents the footer from being squashed by long forms */
}
/* 4. LONG-PRESS INTERACTION STYLES */
.long-press-btn { position: relative; overflow: hidden; transition: all 0.2s; user-select: none; }
.long-press-btn.pressing::after { width: 100%; transition: width 1.5s linear; }
.long-press-btn.holding::after { width: 100%; transition: width 2s linear; }
/* 3. ANIMATION PATCH: High-visibility blue fill */
.long-press-btn::after { 
    content: ''; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 0; 
    height: 100%; 
    background: rgba(59, 130, 246, 0.5); /* Semi-transparent blue */
    transition: width 0.2s ease-out; 
    z-index: 0;
}
/* 5. GPS SIGNAL BARS */
.gps-bar { width: 4px; height: 12px; background-color: #374151; border-radius: 1px; transition: background-color 0.3s; }
.gps-bar.active-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
.gps-bar.active-amber { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
.gps-bar.active-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }

/* BEST: Combines your custom arrow with high-contrast menu items */
select.form-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    background-color: rgba(255, 255, 255, 0.05);
}

select.form-input option {
    background-color: #ffffff !important;
    color: #000000 !important;
}
/* 6. UTILITY CLASSES */
.form-input { width: 100%; background-color: var(--primary); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 1rem; outline: none; margin-bottom: 0.75rem; display: block; }
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
canvas { touch-action: none; background: #fff; border-radius: 0.5rem; cursor: crosshair; }
.wizard-step { display: none; height: 100%; flex-direction: column; }
.wizard-step.active { display: flex; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* 7. POCKET PROTECTION/BATTERY SAVER VISUALS */
#batterySaver { 
    background-color: #000;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
}
#saverProgress { background: rgba(255, 255, 255, 0.2); transition: opacity 1.5s linear; }

/* 8. INSTALL OVERLAYS */
#toastMsg { z-index: 1000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-150%); }
#toastMsg.show { transform: translateY(0); }

/* 9. PHASE 1 ADDITIONS */
#offlineBanner { background: #dc2626; color: white; text-align: center; font-size: 0.75rem; font-weight: 700; padding: 0.25rem; z-index: 50; }
#vehNagBar { background: #ea580c; color: white; text-align: center; font-size: 0.75rem; font-weight: 700; padding: 0.5rem; cursor: pointer; z-index: 40; border-bottom: 1px solid rgba(255,255,255,0.2); }
.form-input-card { width: 100%; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.5rem; padding: 0.75rem; color: white; font-size: 0.9rem; outline: none; margin-bottom: 0.5rem; display: block; }
.setting-label { display: block; font-size: 0.625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; margin-left: 0.25rem; }
.lbl-blue { color: #60a5fa; }
.lbl-red { color: #f87171; }
.lbl-gray { color: #9ca3af; }

/* NEW: Professional Form Component Styling */
.input-group {
    display: flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    overflow: hidden;
    transition: border-color 0.2s;
}
.input-group:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }

.input-prefix {
    padding: 0 1rem;
    background: rgba(255, 255, 255, 0.05);
    color: #60a5fa;
    font-weight: 800;
    font-size: 1.1rem;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    height: 3.5rem;
    display: flex;
    align-items: center;
}

.input-group .form-input {
    border: none !important;
    margin-bottom: 0 !important;
    background: transparent !important;
    height: 3.5rem;
}

/* Toggle Switch Style for Checkboxes */
.check-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
}
    
/* Duration slider styling */
.slider-thumb::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--accent);
    cursor: pointer;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-thumb::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--accent);
    cursor: pointer;
    border-radius: 50%;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-thumb::-webkit-slider-thumb:hover {
    background: var(--primary);
    transform: scale(1.1);
}

.slider-thumb::-moz-range-thumb:hover {
    background: var(--primary);
    transform: scale(1.1);
}

/* Panic mode styling */
.panic-mode {
    background: #991b1b !important;
    animation: panic-pulse 2s infinite;
}

@keyframes panic-pulse {
    0%, 100% { background: #991b1b; }
    50% { background: #dc2626; }
}

/* Animated GPS pulse for active travel tracking */
.gps-pulse {
    animation: gps-pulse-anim 1.5s infinite ease-in-out;
}

@keyframes gps-pulse-anim {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.9); }
}

/* Emergency strobe for rescue visibility */
.strobe-active {
    animation: strobe-anim 0.4s infinite !important;
}

@keyframes strobe-anim {
    0%, 49% { background-color: #991b1b !important; }
    50%, 100% { background-color: #000000 !important; }
}
  /* HIGH-CONTRAST WIZARD OVERHAUL */
#setupPage {
    background-color: #050505 !important; /* True deep black */
}

#setupPage .form-input, 
#setupPage .form-input-card {
    background-color: #000000 !important;
    border: 2px solid #ffffff !important; /* Thick white borders for clarity */
    color: #ffffff !important;
    font-weight: 700;
}

#setupPage .form-input::placeholder {
    color: #9ca3af !important;
    opacity: 1;
}

#setupPage h2 {
    color: #60a5fa !important; /* High-visibility blue for headers */
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#setupPage .setting-label {
    color: #ffffff !important;
    font-size: 0.75rem;
    background: rgba(255,255,255,0.1);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
}  
</style>
</head>
<body class="h-full overflow-hidden select-none">

<div id="offlineBanner" class="hidden bg-red-600 text-white text-center text-[10px] font-bold py-1">
    üì° OFFLINE MODE - Data queued for upload
</div>

<div id="vehNagBar" class="hidden bg-orange-600 text-white text-center text-[10px] font-bold py-2 cursor-pointer" onclick="startVehicleCheck()">
    ‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete
</div>

<div id="toastMsg" class="fixed top-4 left-4 right-4 bg-gray-800 border-l-4 border-blue-500 text-white px-4 py-3 rounded shadow-md transform -translate-y-full transition-transform duration-300" aria-live="polite">
  <p id="toastText"></p>
</div>

<div id="batterySaver" class="hidden fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
    <!-- Timer at top -->
    <div class="absolute top-8 left-0 right-0 text-center">
        <div class="text-4xl font-mono text-white/50" id="dimmedTimer">--:--</div>
        <p class="text-gray-600 text-xs mt-1">Visit in progress</p>
    </div>
    
    <!-- Status display -->
    <div class="flex flex-col items-center gap-6 mb-16">
        <div class="relative">
            <div class="w-24 h-24 rounded-full border-2 border-white/10 flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-white/5 animate-pulse"></div>
            </div>
            <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">
                <span class="text-green-400 text-xs font-bold">üîã <span id="dimmedBattery">--</span>%</span>
            </div>
        </div>
        
        <div class="text-center">
            <h3 class="text-white font-bold text-2xl mb-1">Battery Saver</h3>
            <p class="text-gray-400 text-sm">Slide to wake screen</p>
        </div>
    </div>
    
    <!-- Slide to unlock -->
    <div class="w-80 mx-auto px-6">
        <div id="slideTrack" class="relative h-16 bg-gray-800/50 rounded-full border-2 border-gray-700/50 backdrop-blur-sm overflow-hidden shadow-2xl touch-none">
            <div class="absolute inset-0 bg-blue-500/5 animate-pulse"></div>
            <div id="slideProgress" class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-100 pointer-events-none" style="width: 0%; opacity: 0.4;"></div>
            
            <div id="slideButton" class="absolute left-1 top-1 bottom-1 w-14 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-2xl transition-transform touch-none">
                <svg class="w-6 h-6 text-white animate-pulse pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
            
            <div id="slideText" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <span class="text-gray-500 font-bold text-sm tracking-widest transition-opacity duration-200">SLIDE TO WAKE ‚Üí</span>
            </div>
        </div>
        
        <p class="text-gray-600 text-xs text-center mt-3">Tap screen to peek at timer</p>
    </div>
    
    <!-- Emergency access reminder -->
    <div class="absolute bottom-8 left-0 right-0 text-center">
        <div class="inline-flex items-center gap-2 bg-red-900/20 border border-red-800/30 rounded-full px-4 py-2">
            <span class="text-red-400 text-2xl">üÜò</span>
            <span class="text-red-400 text-xs font-bold">SOS accessible anytime</span>
        </div>
    </div>
</div>

<div id="setupPage" class="page">
    <div class="header-bar">
        <h1 class="text-xl font-bold text-blue-400">Setup Wizard</h1>
        <div class="flex gap-1">
            <div id="dot1" class="w-2 h-2 rounded-full bg-blue-500"></div>
            <div id="dot2" class="w-2 h-2 rounded-full bg-gray-700"></div>
            <div id="dot3" class="w-2 h-2 rounded-full bg-gray-700"></div>
        </div>
    </div>
   
    <div class="content-area flex flex-col">
        <div id="wizStep1" class="wizard-step active">
            <h2 class="text-lg font-bold mb-4">Your Identity</h2>
            <input id="wizName" type="text" placeholder="Full Name" class="form-input">
            <input id="wizPhone" type="tel" placeholder="Phone Number" class="form-input">
            <input id="wizEmail" type="email" placeholder="Email Address" class="form-input">
        </div>
        
        <div id="wizStep2" class="wizard-step">
            <h2 class="text-lg font-bold mb-4">Security PINs</h2>
            <div class="space-y-6">
                <form id="wizPinFormStd" onsubmit="return false;">
                    <input type="text" name="username" autocomplete="username" value="Worker" class="hidden" style="display:none !important;">
                    <label class="setting-label">Standard PIN</label>
                    <input id="wizPin" type="password" autocomplete="new-password" placeholder="Enter 4-6 digits" class="form-input mb-2" inputmode="numeric" maxlength="6" oninput="checkWizPinMatch()">
                    <input id="wizPinConfirm" type="password" autocomplete="new-password" placeholder="Confirm Standard PIN" class="form-input" inputmode="numeric" maxlength="6" oninput="checkWizPinMatch()">
                </form>
                <form id="wizPinFormDur" onsubmit="return false;">
                    <input type="text" name="username" autocomplete="username" value="Worker" class="hidden" style="display:none !important;">
                    <label class="setting-label lbl-red">Duress PIN (Silent Alert)</label>
                    <input id="wizDuress" type="password" autocomplete="new-password" placeholder="Enter 4-6 digits" class="form-input mb-2" inputmode="numeric" maxlength="6" oninput="checkWizPinMatch()">
                    <input id="wizDuressConfirm" type="password" autocomplete="new-password" placeholder="Confirm Duress PIN" class="form-input" inputmode="numeric" maxlength="6" oninput="checkWizPinMatch()">
                </form>
                <p id="pinMatchError" class="text-[10px] text-red-500 font-bold uppercase hidden">PINs do not match or are too short</p>
            </div>
        </div>

    <div id="wizStep3" class="wizard-step">
            <h2 class="text-lg font-bold mb-4">Emergency Contacts</h2>
            <label class="setting-label lbl-red">Primary Emergency Contact</label>
            <input id="wizContactName" type="text" placeholder="Contact Name" class="form-input-card">
            <input id="wizContactPhone" type="tel" placeholder="Contact Phone" class="form-input-card">
            <input id="wizContactEmail" type="email" placeholder="Contact Email" class="form-input mb-4">
            <label class="setting-label lbl-gray">Escalation Contact (Optional)</label>
            <input id="wizEscName" type="text" placeholder="Name" class="form-input-card">
            <input id="wizEscPhone" type="tel" placeholder="Phone" class="form-input-card">
            <input id="wizEscEmail" type="email" placeholder="Email" class="form-input">
        </div>
    </div> <div class="footer-bar flex justify-between">
        <button id="btnWizPrev" onclick="prevWiz()" class="hidden px-6 py-3 bg-gray-600 rounded-xl font-bold">Back</button>
        <button id="btnWizNext" onclick="nextWiz()" class="px-6 py-3 bg-blue-600 rounded-xl font-bold">Next Step</button>
    </div>
</div>
        
<div id="mainPage" class="page">
    <div class="header-bar">
    <h1 id="headerWorkerName" class="text-xl font-bold">Welcome</h1>
    <div class="flex gap-4 items-center"> <button onclick="openResourceHub()" 
                class="text-2xl opacity-60 hover:opacity-100 transition active:scale-90" 
                title="Resource Library" 
                aria-label="Resource Library">
            üìñ
        </button>

        <div id="gpsIndicator" class="flex gap-1 items-end h-5"> <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
        </div>

        <button onclick="navigate('settings')" 
                class="text-2xl text-gray-400 hover:text-white transition active:rotate-45" 
                aria-label="Settings">
            ‚öôÔ∏è
        </button>
    </div>
</div>
    
    <!-- Sync Banner -->
    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2 font-bold uppercase tracking-widest mx-4 mt-4">
        <div class="spinner"></div>
        <span>Syncing...</span>
    </div>
    
    <div class="content-area">
<div class="flex flex-col gap-1 mb-4">
    <div class="flex gap-2">
        <button onclick="forceSync(true)" id="btnSync" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-blue-400 text-2xl shadow-lg active:scale-95 transition" title="Sync Database">
            ‚Üª
        </button>
        <button onclick="openAddLocationModal()" class="w-14 h-14 bg-gray-800 border border-gray-600 rounded-xl flex items-center justify-center text-green-400 text-2xl shadow-lg active:scale-95 transition" title="Add Destination">
            +
        </button>
        <div id="travelRow" class="flex-1"></div>
    </div>
    <div id="lastSyncLabel" class="text-[8px] text-gray-500 font-bold uppercase tracking-tighter ml-1">
        Last Sync: Never
    </div>
</div>
        <!-- Regular locations (grid) -->
        <div id="locationList" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div class="footer-bar">
        <!-- Critical Timing Mode Toggle -->
        <div class="flex justify-end items-center gap-2 mb-2">
            <span class="text-[10px] font-bold text-gray-500 tracking-widest" id="lblHighRisk">Critical timing mode</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="chkHighRisk" class="sr-only peer" onchange="toggleHighRiskUI()">
                <div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
            </label>
        </div>
        
        <!-- Duration Slider -->
        <div class="mb-4 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex justify-between mb-2 font-black tracking-tighter">
                <span class="text-gray-400 text-[10px]">TIME</span>
                <span id="durationDisplay" class="text-xs text-blue-400">0 mins</span>
            </div>
            <input id="durationSlider" type="range" min="0" max="31" value="0" 
                   class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb" 
                   oninput="updateDurationDisplay()">
            <div class="flex gap-2 mt-2">
        <button onclick="setQuickDuration(15)" class="flex-1 py-1 bg-gray-700/50 rounded text-[10px] font-black uppercase text-blue-400 border border-blue-500/20">15m</button>
        <button onclick="setQuickDuration(30)" class="flex-1 py-1 bg-gray-700/50 rounded text-[10px] font-black uppercase text-blue-400 border border-blue-500/20">30m</button>
        <button onclick="setQuickDuration(60)" class="flex-1 py-1 bg-gray-700/50 rounded text-[10px] font-black uppercase text-blue-400 border border-blue-500/20">1h</button>
        <button onclick="setQuickDuration(120)" class="flex-1 py-1 bg-gray-700/50 rounded text-[10px] font-black uppercase text-blue-400 border border-blue-500/20">2h</button>
        </div>
        </div>

        
        <!-- Forms Button + Hold to Start Button -->
<div class="flex gap-3 h-16 items-stretch">
    <button id="btnForms" onclick="openFormsLibrary()" 
            class="w-1/4 bg-indigo-950 text-indigo-300 font-black rounded-2xl border border-indigo-700/50 shadow-lg active:scale-95 transition text-xs uppercase tracking-tighter leading-none">
        Forms
    </button>
    <button type="button" id="btnStart" 
            class="long-press-btn flex-1 bg-gray-700 text-gray-500 font-black rounded-2xl text-xl shadow-lg transition-all uppercase tracking-tighter" 
            disabled>
        <span class="relative z-10">Hold to Start</span>
    </button>
</div>
    </div>
</div>

<div id="lockedPage" class="page">
    <div class="flex-1 flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <button onclick="toggleBatterySaver()" class="p-2 bg-gray-800 rounded-full text-yellow-400 border border-gray-600 hover:bg-gray-700 shadow-xl" aria-label="Toggle battery saver">
                üåô
            </button>
            <button id="btnPanic" class="w-24 h-24 bg-red-600 rounded-full font-black text-white text-2xl border-4 border-red-800 shadow-2xl active:scale-95 transition flex items-center justify-center" aria-label="Emergency panic button">
                SOS
            </button>
        </div>
        <div class="text-center">
            <p class="text-gray-500 text-xs uppercase font-black tracking-[0.3em]">Currently Active At</p>
            <div class="flex items-center justify-center gap-2 mt-1 mb-2 cursor-pointer hover:bg-gray-800 rounded p-2 transition" onclick="showCurrentSiteInfo()">
                <h2 id="lockedLocationName" class="text-3xl font-bold text-white truncate max-w-[250px]"></h2>
                <span class="text-blue-400 text-xl">‚ÑπÔ∏è</span>
            </div>
            <div id="highRiskBadge" class="hidden text-red-500 font-black text-xs uppercase tracking-widest border border-red-500 inline-block px-3 py-1 rounded-lg mb-2">
                ‚ö° CRITICAL TIMING MODE
            </div>
            <div id="overdueLabel" class="hidden text-red-500 font-black text-2xl animate-pulse my-2 tracking-[0.2em] border-2 border-red-500 inline-block px-6 py-2 rounded-xl uppercase">
                OVERDUE
            </div>
            <div id="countdownTimer" class="text-8xl font-bold font-mono text-white tracking-tighter">00:00</div>
            <p class="text-gray-400 mt-2 font-bold uppercase text-[12px] tracking-widest">
                Scheduled Departure: <span id="lockedAnticipatedTime" class="text-blue-400"></span>
            </p>
        </div>
        <div class="flex gap-3 h-16">
    <button id="btnExtend" onclick="showModal('extend')" class="flex-1 bg-blue-600 text-white font-black rounded-2xl text-lg shadow-lg uppercase tracking-widest">
        Extend
    </button>
    <button onclick="openFormsLibrary()" class="w-24 bg-violet-950 text-violet-300 font-black rounded-2xl border border-violet-800/50 flex flex-col items-center justify-center">
        <span class="text-lg">üìã</span>
        <span class="text-[8px] uppercase tracking-tighter">Forms</span>
    </button>
</div>
            <button id="btnDepart" class="long-press-btn w-full py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl text-xl shadow-2xl uppercase tracking-[0.2em]">
                Hold to END
            </button>
            <button id="btnSafe" class="hidden long-press-btn w-full py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl text-xl shadow-2xl animate-pulse uppercase tracking-[0.2em]">
                I AM SAFE
            </button>
        </div>
    </div>
</div>

<div id="reportPage" class="page">
    <div class="header-bar">
        <h1 id="reportTitle" class="text-xl font-bold">Visit Report</h1>
        <button onclick="navigate(state.activeVisit ? 'locked' : 'main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    <div class="content-area">
        <div id="reportFields"></div>
    </div>
    <div class="footer-bar flex gap-3">
        <button onclick="navigate(state.activeVisit ? 'locked' : 'main')" 
                class="flex-1 py-4 bg-gray-700 text-gray-300 rounded-xl font-bold uppercase tracking-widest">
            Cancel
        </button>
        <button id="btnSubmitRep" class="flex-[2] py-4 bg-green-600 text-white rounded-xl font-bold shadow-lg">
            Submit Report
        </button>
    </div>
</div>

<!-- Settings Page -->
<div id="settingsPage" class="page bg-gray-800">
    <div class="header-bar">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button onclick="navigate('main')" class="text-3xl text-gray-400 hover:text-white px-2">√ó</button>
    </div>
    <div class="content-area pb-24">
        <!-- Restart Wizard Prompt -->
        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-4">
            <p class="text-xs text-blue-200 font-bold">Re-run the setup wizard to change details?</p>
            <button onclick="startWizard()" class="mt-2 text-xs bg-blue-600 px-2 py-1 rounded font-bold">Restart Wizard</button>
        </div>
        
        <div class="mb-6">
            <h2 class="text-xl font-bold text-blue-400 mb-4">Worker Profile</h2>
            <label class="setting-label lbl-blue">Full Name</label>
            <input id="setName" type="text" class="form-input">
            <label class="setting-label lbl-blue">Mobile Number</label>
            <input id="setPhone" type="tel" class="form-input">
            <label class="setting-label lbl-blue">Work Email</label>
            <input id="setEmail" type="email" class="form-input">
        </div>
        <div class="mb-6">
            <h2 class="text-xl font-bold text-red-400 mb-4">Emergency Contacts</h2>
            <label class="setting-label lbl-red">Primary Emergency Contact</label>
            <input id="setEmgName" type="text" class="form-input-card">
            <input id="setEmgPhone" type="tel" class="form-input-card">
            <input id="setEmgEmail" type="email" class="form-input mb-4">
            <label class="setting-label lbl-gray">Escalation Contact</label>
            <input id="setEscName" type="text" class="form-input-card">
            <input id="setEscPhone" type="tel" class="form-input-card">
            <input id="setEscEmail" type="email" class="form-input">
        </div>
        <div class="mb-6">
            <h2 class="text-xl font-bold text-purple-400 mb-4">Advanced</h2>
            <div class="bg-gray-900 p-4 rounded-xl mb-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="setAdvanced" onchange="toggleAdvancedGPS(this.checked)" class="w-6 h-6 rounded text-blue-600">
                    <div>
                        <div class="text-white font-bold">Advanced GPS Monitoring</div>
                        <div class="text-xs text-gray-400">Continuous tracking (higher battery use)</div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- System Info Section -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-400 mb-4">System Info</h2>
            <div class="setting-card border-gray-600">
                <label class="setting-label lbl-gray">Backend Connection</label>
                <input id="setBackendUrl" disabled class="form-input-card text-xs font-mono text-gray-400 mb-2" value="">
                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">App Version</div>
                        <div id="appVersion" class="text-sm font-mono text-blue-400">v1.0.0</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Backend Version</div>
                        <div id="backendVersion" class="text-sm font-mono text-green-400">...</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Sync Status</div>
                        <div id="syncStatus" class="text-sm font-mono text-gray-400">Checking...</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="forceSync(true)" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white uppercase">Force Sync</button>
                    <button onclick="clearFormsCache()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-xs font-bold text-white uppercase">Clear Cache</button>
                </div>
            </div>
        </div>
        
        <div class="space-y-3">
            <button onclick="saveSettings()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg">
                üíæ Save Settings
            </button>
            <button onclick="clearData()" class="w-full py-4 bg-red-900/50 text-red-400 hover:bg-red-900/70 font-bold rounded-xl shadow-lg uppercase">
                Reset App Data
            </button>
        </div>
    </div>
</div>

<!-- Extend Modal -->
<div id="extendModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center border border-gray-700">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Extend Visit</h2>
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="confirmExtension(10)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+10</button>
            <button onclick="confirmExtension(15)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+15</button>
            <button onclick="confirmExtension(30)" class="py-5 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white shadow-lg">+30</button>
        </div>
        <button onclick="closeModal('extend')" class="w-full py-4 bg-gray-700 rounded-xl font-black text-gray-400 uppercase">Cancel</button>
    </div>
</div>

<!-- Vehicle WOF Block Modal -->
<div id="wofBlockModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-10 text-center border-4 border-red-600">
        <div class="text-7xl mb-6">‚õî</div>
        <h2 class="text-3xl font-black text-red-500 mb-4 uppercase">STOP</h2>
        <p class="text-lg text-white font-bold mb-6">This vehicle has an EXPIRED WOF or Registration. It is prohibited for work use.</p>
        <button onclick="closeWofBlocker()" class="w-full py-5 bg-red-600 text-white font-black rounded-2xl text-xl shadow-2xl">I Understand</button>
    </div>
</div>

<!-- Vehicle WOF Warning Modal -->
<div id="wofWarnModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-900 rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center border-4 border-orange-500">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-black text-orange-500 mb-2 uppercase">VEHICLE COMPLIANCE</h2>
        <p class="text-white font-bold mb-6">Vehicle WOF or Rego is expiring soon:<br><span id="wofWarnText" class="text-2xl text-orange-400 font-black"></span></p>
        <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 text-left mb-6">
            <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="chkWofAck" class="mt-1 w-6 h-6 rounded text-blue-600" onchange="toggleWofContinue()">
                <span class="text-sm text-gray-300 font-bold">I acknowledge the vehicle is legal and safe to operate.</span>
            </label>
        </div>
        <button id="btnWofContinue" disabled onclick="closeWofWarn()" class="w-full py-4 bg-gray-700 text-gray-500 font-black rounded-2xl text-lg transition-all">Continue</button>
    </div>
</div>

<!-- Site Info Modal (Phase 2, Feature 9) -->
<div id="infoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto border border-gray-700">
        <h2 class="text-2xl font-black text-white mb-4">Site Info</h2>
        <div id="siteInfoContent" class="text-gray-300 text-sm space-y-3 mb-6"></div>
        <div class="flex gap-3 mb-4">
            <a id="btnSiteCall" href="#" class="hidden flex-1 bg-green-600 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest">üìû Call</a>
            <a id="btnSiteEmail" href="#" class="hidden flex-1 bg-blue-600 text-white py-4 rounded-xl text-center font-black uppercase tracking-widest">‚úâÔ∏è Email</a>
        </div>
        <a id="btnSiteNav" href="#" target="_blank" class="hidden block w-full py-4 bg-purple-600 text-white font-black rounded-xl text-center mb-4 uppercase tracking-widest">üó∫Ô∏è Navigate</a>
        <button onclick="closeModal('info')" class="w-full py-4 bg-gray-700 text-gray-300 font-black rounded-xl uppercase tracking-widest">Close</button>
    </div>
</div>

<!-- Location Management Modal (Phase 2, Feature 13) -->
<div id="locationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-gray-700 max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-black mb-6 text-white uppercase tracking-widest">Edit Location</h2>
        <input type="hidden" id="locId">
        <div class="space-y-4">
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Business Name</label>
                <input type="text" id="locBusiness" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Site Name</label>
                <input type="text" id="locName" class="form-input" placeholder="Required">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Physical Address</label>
                <div class="flex gap-2">
                    <input type="text" id="locAddr" class="form-input mb-0 flex-1">
                    <button onclick="getGpsAddress()" class="bg-blue-600 text-white p-3 rounded-xl font-black text-xs shrink-0">üìç GPS</button>
                </div>
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Name</label>
                <input type="text" id="locContactName" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Phone</label>
                <input type="tel" id="locContactPhone" class="form-input" placeholder="Optional">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest ml-1">Contact Email</label>
                <input type="email" id="locContactEmail" class="form-input" placeholder="Optional">
            </div>
            <div class="bg-gray-900 p-3 rounded-xl">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="locCritical" class="w-5 h-5 rounded text-red-600">
                    <span class="text-sm text-white font-bold">‚ö° Critical Timing Mode (High-Risk Site)</span>
                </label>
            </div>
        </div>
        <div class="mt-8 flex gap-3">
            <button onclick="deleteLoc()" id="btnDelLoc" class="hidden bg-red-900/50 text-red-400 font-black py-3 px-6 rounded-xl uppercase text-xs tracking-widest border border-red-800/30">Delete</button>
            <div class="flex-1"></div>
            <button onclick="closeModal('location')" class="bg-gray-700 text-white font-black py-3 px-6 rounded-xl uppercase text-xs tracking-widest">Cancel</button>
            <button onclick="saveLoc()" class="bg-blue-600 text-white font-black py-3 px-8 rounded-xl shadow-xl uppercase text-xs tracking-widest">Save</button>
        </div>
    </div>
</div>

<div id="noticeModal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" role="dialog">
    <div id="noticeCard" class="bg-gray-900 rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 text-center border-t-[12px] border-blue-600">
        <div id="noticeIcon" class="text-6xl mb-6">üì¢</div>
        <h2 id="noticeTitle" class="text-2xl font-black text-white mb-3 uppercase tracking-tight leading-tight"></h2>
        <div id="noticeContent" class="text-gray-400 text-sm mb-10 leading-relaxed text-left max-h-56 overflow-y-auto pr-3 scrollbar-hide"></div>
        
        <button id="btnAckNotice" onclick="acknowledgeNotice()" class="w-full py-6 bg-blue-600 text-white font-black rounded-2xl text-lg shadow-xl uppercase tracking-widest active:scale-95 transition-all">
            I have read and understood
        </button>
    </div>
</div>
    
<div id="pinModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <form id="pinEntryForm" onsubmit="return false;">
    <input type="text" name="username" autocomplete="username" value="Worker" class="hidden" style="display:none !important;">
    <h3 class="text-lg font-bold mb-4">Enter PIN</h3>
    <input id="pinInput" type="password" autocomplete="current-password" class="form-input mb-4" inputmode="numeric" maxlength="6">
    <button id="btnPinConfirm" type="button" class="w-full py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
        </form>
    </div>
</div>

<div id="groundedModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <h3 class="text-lg font-bold mb-4">Vehicle Grounded</h3>
        <p class="text-gray-300 mb-4">WOF or Rego expired. Cannot proceed.</p>
        <button onclick="closeModal('grounded')" class="w-full py-3 bg-red-600 rounded-xl font-bold">OK</button>
    </div>
</div>

<div id="iosInstallModal" class="hidden fixed bottom-6 left-4 right-4 bg-gray-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl z-[100]">
    <div class="flex items-start gap-4">
        <div class="text-4xl">üì≤</div>
        <div class="flex-1">
            <h3 class="text-lg font-extrabold text-white mb-1">Add to Home Screen</h3>
            <p class="text-gray-300 text-xs mb-4 font-bold">Required for safety background tracking.</p>
            <div class="bg-gray-900 rounded-lg p-3 text-xs text-blue-300 flex items-center gap-2 font-bold uppercase tracking-tighter">
                <span>1. Tap Share</span><span class="text-xl">‚éã</span><span>2. 'Add to Home Screen'</span><span class="text-xl">‚äï</span>
            </div>
        </div>
        <button onclick="dismissInstall('ios')" class="text-gray-500 font-black p-2">‚úï</button>
    </div>
</div>

<!-- Android Install Banner (Phase 3, Feature 17) -->
<div id="installBanner" class="hidden fixed top-0 left-0 w-full bg-blue-600 text-white p-4 z-[100] shadow-xl flex items-center justify-between">
    <div class="flex items-center gap-3">
        <span class="text-2xl">üì≤</span>
        <div>
            <p class="font-bold text-sm">Install Safety App</p>
            <p class="text-xs opacity-90">Add to home screen for safety monitoring.</p>
        </div>
    </div>
    <div class="flex gap-2">
        <button onclick="dismissInstall('android')" class="px-3 py-1 text-xs font-bold bg-blue-700 rounded">Later</button>
        <button onclick="triggerInstall()" class="px-4 py-1 text-xs font-black bg-white text-blue-600 rounded">Install</button>
    </div>
</div>

<!-- Shake-to-Alert Confirmation Modal -->
<div id="shakeConfirmModal" class="hidden fixed inset-0 z-[120] bg-red-900/90 flex items-center justify-center">
    <div class="text-center text-white animate-pulse">
        <div class="text-8xl mb-4">‚ö†Ô∏è</div>
        <h1 class="text-4xl font-black mb-4">SHAKE DETECTED</h1>
        <p class="text-yellow-400 text-lg font-bold mb-6">Shake again to confirm panic alert</p>
        <div class="text-6xl font-mono" id="shakeCountdown">3</div>
        <p class="text-xs mt-4 text-gray-400">Covert alert activation</p>
    </div>
</div>

<!-- Volume Panic Confirmation Modal -->
<div id="volumeConfirmModal" class="hidden fixed inset-0 z-[120] bg-orange-900/90 flex items-center justify-center">
    <div class="text-center text-white">
        <div class="text-8xl mb-4">üîä</div>
        <h1 class="text-4xl font-black mb-4">VOLUME PANIC</h1>
        <p class="text-yellow-400 text-lg font-bold mb-6">Press volume buttons again to confirm</p>
        <div class="text-6xl font-mono" id="volumeCountdown">3</div>
        <p class="text-xs mt-4 text-gray-400">Emergency alert activation</p>
    </div>
</div>

<div id="formsLibraryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-gray-700 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black text-white uppercase tracking-widest text-blue-400">Safety Forms</h2>
            <button onclick="closeModal('formsLibrary')" class="text-2xl text-gray-400">√ó</button>
        </div>
        <div id="formsLibraryList" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
        <button onclick="closeModal('formsLibrary')" class="mt-6 w-full py-4 bg-gray-700 rounded-xl font-black text-gray-400 uppercase tracking-widest">Close</button>
    </div>
</div>

<div id="resourceHubModal" class="hidden fixed inset-0 z-[350] flex items-center justify-center bg-black/90 backdrop-blur-md p-4" role="dialog">
    <div class="bg-gray-900 rounded-[2.5rem] shadow-2xl w-full max-w-sm h-[80vh] flex flex-col border border-white/10">
        <div class="p-8 pb-4">
            <h2 class="text-2xl font-black text-white uppercase tracking-tight">Safety Hub</h2>
            <div class="flex gap-4 mt-4 border-b border-white/10">
                <button onclick="switchHubTab('res')" id="tabRes" class="pb-2 text-xs font-black uppercase tracking-widest text-blue-500 border-b-2 border-blue-500">Resources</button>
                <button onclick="switchHubTab('not')" id="tabNot" class="pb-2 text-xs font-black uppercase tracking-widest text-gray-500">Notice Archive</button>
            </div>
        </div>
        
        <div id="hubContent" class="flex-1 overflow-y-auto p-8 pt-2 space-y-4 scrollbar-hide"></div>
        
        <div class="p-8 pt-0">
            <button onclick="closeModal('resourceHub')" class="w-full py-4 bg-gray-800 text-gray-400 font-black rounded-2xl uppercase tracking-widest">Close</button>
        </div>
    </div>
</div>

<script data-cfasync="false">
// ============================================================================
// CONFIGURATION SYSTEM (Phase 2, Feature 11)
// ============================================================================
// Duration mapping: 32 steps from 0 to 8 hours (480 minutes)
// Slider positions 0-31 map to these durations in minutes
const DURATION_MAP = [
    0, 10, 15, 20, 30, 45,     // 0-5: Quick visits (0-45 min)
    60, 75, 90, 105, 120,       // 6-10: Short visits (1-2 hours)
    135, 150, 165, 180,         // 11-14: Medium visits (2-3 hours)
    195, 210, 225, 240,         // 15-18: Long visits (3-4 hours)
    255, 270, 285, 300,         // 19-22: Extended visits (4-5 hours)
    315, 330, 345, 360,         // 23-26: Very long visits (5-6 hours)
    390, 420, 450, 480          // 27-31: Maximum visits (6-8 hours)
];

const CONFIG = {
    // Backend
    url: "%%GOOGLE_SHEET_URL%%",
    org: "%%ORG_NAME%%",
    key: "%%WORKER_KEY%%",  // Factory injects worker-specific key (wk_xxxxx)
    
    // Features
    isAdvanced: true,
    mileageEnabled: true,
    vehEnabled: true,
    checkinEnabled: false,
    
    // Timing
    vehInterval: 120, // days
    escalationMinutes: 15,
    checkinInterval: 60, // minutes
    
    // Localization (Phase 2, Feature 10 & Phase 3, Feature 19)
    countryPrefix: "%%COUNTRY_PREFIX%%",
    vehicleTerm: "%%VEHICLE_TERM%%",
    voiceLocale: "%%VOICE_LOCALE%%",
    
    // Requirements
    reqTravelReport: true
};

// ============================================================================
// GLOBALS AND STATE INITIALIZATION
// ============================================================================
let state; // Declared but not initialized until onload
let formExecutionContext = null;
let dimTimer;
let isDimmed = false;
const DIM_DELAY = 10000; // 10 seconds
let checkinIntervalId;
let travellingInterval;
let timerInt;
let deferredPrompt;
let lastAlertTime = 0;
let lastGPS = null;
let synth; // Tone.js synth - initialized after user interaction
let audioReady = false;
let gpsWatchId = null; // Track GPS watch for cleanup

// PHASE 1 ADDITIONS
let isMidVisitUpdate = false; // Track if we're updating mid-visit vs ending
let currentBatteryLevel = "100%";

// PHASE 2+ ADDITIONS: Covert panic activation methods
let shakeBuffer = [];
let lastShakeTime = 0;
let shakeConfirmationMode = false;
let shakeConfirmationTimeout = null;

let volumeBuffer = [];
let volumeConfirmationMode = false;
let volumeConfirmationTimeout = null;

let wakeLock = null;
let isSliding = false;
let slideStartX = 0;
let isSosLocked = false; // Prevent SOS immediately after wake

// ============================================================================
// AUDIO INITIALIZATION (Must be after user interaction)
// ============================================================================
// Note: Tone.js displays a banner in console - this is normal and can be ignored
// Note: Tailwind CDN warning is expected - this is a PWA, not a traditional build process

async function initAudio() {
    if (!audioReady && typeof Tone !== 'undefined') {
        try {
            // Suppress Tone.js console banner (optional)
            const originalLog = console.log;
            console.log = function() {};
            
            await Tone.start();
            synth = new Tone.Synth().toDestination();
            audioReady = true;
            
            // Restore console
            console.log = originalLog;
            console.log('‚úÖ Audio initialized successfully');
        } catch (e) {
            console.warn('Audio initialization failed:', e);
            audioReady = false;
        }
    }
}

// Initialize audio on first user interaction
document.addEventListener('click', initAudio, { once: true });
document.addEventListener('touchstart', initAudio, { once: true });

// ============================================================================
// STATE PERSISTENCE
// ============================================================================
function loadState() {
    try {
        const saved = localStorage.getItem('loneWorkerState');
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error('Load state failed:', e);
    }
    return null;
}

function saveState() {
    try {
        localStorage.setItem('loneWorkerState', JSON.stringify(state));
    } catch (e) {
        console.error('Save state failed:', e);
    }
}

// ============================================================================
// NAVIGATION
// ============================================================================
function navigate(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(page + 'Page');
    if (targetPage) {
        targetPage.classList.add('active');
        
        // PHASE 1: Populate settings page when navigating to it
        if (page === 'settings') {
            populateSettingsForm();
            updateSystemInfo(); // Update backend connection status
        }
        
        resetInactivityTimer();
    } else {
        console.error(`Page not found: ${page}Page`);
    }
}

// ============================================================================
// MODALS
// ============================================================================
function showModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeModal(id) {
    const modal = document.getElementById(id + 'Modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ============================================================================
// TOAST NOTIFICATIONS
// ============================================================================
function showToast(text) {
    const toastText = document.getElementById('toastText');
    const toastMsg = document.getElementById('toastMsg');
    if (toastText && toastMsg) {
        toastText.innerText = text;
        toastMsg.classList.add('show');
        setTimeout(() => toastMsg.classList.remove('show'), 3000);
    }
}

// ============================================================================
// VOICE ANNOUNCE (Web Speech with fallback)
// ============================================================================
function announce(text) {
    if ('speechSynthesis' in window) {
        try {
            const utter = new SpeechSynthesisUtterance(text);
            
            // Wait for voices to load on some browsers
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    speechSynthesis.speak(utter);
                }, { once: true });
            } else {
                speechSynthesis.speak(utter);
            }
        } catch (e) {
            console.warn('Speech synthesis failed:', e);
            showToast(text);
        }
    } else {
        showToast(text);
    }
}

// ============================================================================
// UPDATED: MISSION-CRITICAL SAFETY LOGGING
// ============================================================================
async function logSafety(type, message) {
    console.log(`[${type}] ${message}`);
    
    // Construct the precise payload required by the Google Script backend
    const data = {
        'Alarm Status': type,
        'Notes': message,
        'Last Known GPS': lastGPS || "0,0",
        'GPS Timestamp': new Date().toLocaleString(),
        'Battery Level': await getBatteryPercent(),
        'App Version': 'v81.36'
    };

    // Pass this through buildPayload to add worker credentials and action keys
    const fullPayload = buildPayload(data);
    fullPayload['action'] = 'logVisit'; // Ensure action is explicit for ingestion

    processUploadQueue(fullPayload);
}

async function getBatteryPercent() {
    try {
        if ('getBattery' in navigator) {
            const battery = await navigator.getBattery();
            return Math.floor(battery.level * 100) + '%';
        }
    } catch (e) {
        console.info('Battery API not available:', e);
    }
    return 'Unknown';
}

/**
 * FULL MISSION-CRITICAL SUBMIT REPORT
 * Includes: Action Routing for Notes, Vehicle Nag clearing, Canvas Cleanup,
 * and NEW: Site Emergency Procedures Integration.
 */
/**
 * FULL MISSION-CRITICAL SUBMIT REPORT
 * Fixed: Site/Company handshake and media transmission for Emergency Procedures.
 */
/**
 * PATCHED: High-Integrity Report Submission
 * Ensures media, signatures, and site context are correctly transmitted.
 */
function submitReport() {
    showToast('üì§ Processing report...');
    
    // 1. GATHER DATA: Includes the recently patched signature and auto-filled fields
    const d = gatherFormData();
    let photoCount = 0;
    const photoMap = {};
    
    // 2. PROCESS PHOTOS: Maps photoStore to indexed Photo keys for the spreadsheet
    Object.keys(state.photoStore || {}).forEach((key) => {
        photoCount++;
        const token = `{{PHOTO_${photoCount}}}`;
        // Store actual base64 data for transmission
        photoMap[`Photo ${photoCount}`] = state.photoStore[key];
        
        if (d.custom[key] !== undefined) {
            d.custom[key] = token;
            d.jsonPayload[key] = token;
        }
    });
    
    // 3. BUILD PAYLOAD
    const fd = {
        ...d.custom,
        "Visit Report Data": JSON.stringify(d.jsonPayload),
        "Template Name": currentActiveTemplate
    };
    
    // 4. EXTRACT DISTANCE (For travel logs)
    for (let key in d.custom) {
        if (/km|odo|dist/i.test(key)) {
            const val = parseFloat(d.custom[key]);
            if (!isNaN(val)) fd["Distance"] = val;
        }
    }
    
    // 5. ATTACH MEDIA: Explicitly adds photos and signature to the flat payload
    Object.entries(photoMap).forEach(([k, v]) => { fd[k] = v; });
    if (d.sig) fd["Signature"] = d.sig; 
    
    // 6. ROUTING LOGIC: Determine Backend Action and Status
    let alarmStatus;
    let backendAction = 'logVisit'; 

    // NEW: SPECIAL ROUTING FOR EMERGENCY PROCEDURES
    if (currentActiveTemplate === "Update Site Procedures") {
        backendAction = 'uploadEmergencyProcedures';
        
        // FIXED: Explicit handshake for backend row matching
        fd["siteName"] = d.custom["Site Name"] || d.custom["Site"] || (state.activeVisit ? state.activeVisit.locationName : "");
        fd["companyName"] = d.custom["Company Name"] || d.custom["Company"] || (state.activeVisit ? state.activeVisit.companyName : "");
        
        // Pass the raw array of photos for the Google Drive handler
        fd["photos"] = Object.values(state.photoStore || {});
        alarmStatus = "PROCEDURES_UPDATED";
    } 
    // ROUTING: Note to Self
    else if (currentActiveTemplate === "Note to Self") {
        backendAction = 'logNote'; 
        alarmStatus = "NOTE_LOGGED";
    } 
    else if (!state.activeVisit) {
        alarmStatus = "REPORT_SUBMITTED"; 
    } 
    else if (isMidVisitUpdate) {
        alarmStatus = state.activeVisit.locationId === 'travel' ? "TRAVELLING" : "ON SITE";
    } 
    else {
        alarmStatus = "DEPARTED";
    }
    
    // 7. HANDSHAKE: Send to spreadsheet with the correct action key
    processUploadQueue(buildPayload({
        ...fd,
        "action": backendAction, 
        "Alarm Status": alarmStatus,
        "Notes": d.notes || ""
    }));

    // 8. NAG BAR CLEANUP
    if (currentActiveTemplate && currentActiveTemplate.toLowerCase().includes('vehicle')) {
        state.meta.lastVehCheck = new Date().toISOString();
        if (typeof checkVehicleStatus === 'function') checkVehicleStatus(); 
    }
    
    // 9. VISUAL & LOGIC RESET
    if (!isMidVisitUpdate) {
        if (typeof stopGPSMonitoring === 'function') stopGPSMonitoring();

        state.activeVisit = null;
        state.selectedLocationId = null;
        state.visitDurationMinutes = 0;
        state.photoStore = {}; // CRITICAL: Clear store after successful submission
        
        if (typeof travelTargetName !== 'undefined') travelTargetName = ""; 
        if (timerInt) { clearInterval(timerInt); timerInt = null; }
        if (travellingInterval) { clearInterval(travellingInterval); travellingInterval = null; }
        if (typeof exitLockedScreen === 'function') exitLockedScreen(); 
        
        saveState();
        navigate('main'); 
        
        // FIXED: Trigger forceSync for procedure updates to refresh map UI markers
        if (currentActiveTemplate === "Update Site Procedures") {
            setTimeout(() => {
                if (typeof forceSync === 'function') forceSync(false);
            }, 1500);
        } else {
            renderLocations(); 
        }

        if (typeof updateArrivedButtonState === 'function') updateArrivedButtonState();
        showToast('‚úÖ Safety Session Completed');
    } else {
        navigate(state.activeVisit ? 'locked' : 'main'); 
        showToast('‚úÖ Update Logged');
        isMidVisitUpdate = false; 
        if (typeof resetInactivityTimer === 'function') resetInactivityTimer();
    }

    // 10. CANVAS PURGE: Physically clear the drawing board
    const sigCanvas = document.querySelector('canvas[id^="sig-canvas-"]');
    if (sigCanvas) clearSig(sigCanvas.id.replace('sig-canvas-', ''));
    
    // FINAL CLEANUP: Clear global context for the next session
    formExecutionContext = null;
}

// ============================================================================
// LONG-PRESS INTERACTION
// ============================================================================
/**
 * Unified Long-Press Utility with Safety Lock
 * Handles visual progress and prevents accidental triggers on wake.
 */
function setupLongPress(target, duration, callback) {
    const btn = (typeof target === 'string') ? document.getElementById(target) : target;
    if (!btn) return;
    
    let timer;
    
    const start = (e) => {
        // Re-integrated Safety Lock for SOS
        if ((target === 'btnPanic' || btn.id === 'btnPanic') && isSosLocked) {
            showToast('‚è≥ Wait... screen just woke');
            return;
        }
        
        // FIXED: preventDefault allows the PC mouse to click without dragging
        if (e.type === 'mousedown') e.preventDefault(); 
        
        btn.classList.add(duration === 1500 ? 'pressing' : 'holding');
        timer = setTimeout(() => {
            btn.classList.remove('pressing', 'holding');
            callback();
        }, duration);
    };

    btn.addEventListener('touchstart', start, { passive: true });
    btn.addEventListener('mousedown', start);

    ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(ev => {
        btn.addEventListener(ev, () => {
            clearTimeout(timer);
            btn.classList.remove('pressing', 'holding');
        });
    });
}
    
// ============================================================================
// INACTIVITY DIM MODE
// ============================================================================
function resetInactivityTimer() {
    clearTimeout(dimTimer);
    if (state && state.activeVisit) {
        dimTimer = setTimeout(activateDimMode, DIM_DELAY);
    }
    deactivateDimMode();
}

/**
 * REWRITTEN: High-Integrity Auto-Dim
 * Fixed: Removed non-existent modalBackdrop check.
 */
function activateDimMode() {
    if (!state || !state.activeVisit) return;
    
    // 1. SAFETY GATE: Do not dim if the user is filling out a report
    const isReportActive = document.getElementById('reportPage')?.classList.contains('active');
    
    // 2. MODAL GATE: Check if ANY modal is physically visible
    const activeModal = document.querySelector('[id$="Modal"]:not(.hidden)');
    
    if (isReportActive || activeModal) return;

    // 3. OVERDUE GATE: Do not dim if time has run out or in panic mode
    const remaining = state.activeVisit.duration - (Date.now() - state.activeVisit.startTime) / 1000;
    if (remaining <= 0 || state.activeVisit.isPanic) return;

    // 4. ACTIVATE DIMMING
    document.documentElement.classList.add('system-dim');
    document.body.classList.add('system-dim');
    isDimmed = true;
    
    const batterySaver = document.getElementById('batterySaver');
    if (batterySaver) batterySaver.classList.remove('hidden');
}
    
function deactivateDimMode() {
    document.documentElement.classList.remove('system-dim');
    document.body.classList.remove('system-dim');
    isDimmed = false;
    const batterySaver = document.getElementById('batterySaver');
    const saverProgress = document.getElementById('saverProgress');
    if (batterySaver) batterySaver.classList.add('hidden');
    if (saverProgress) saverProgress.style.width = '0%';
}

// Battery saver wake button
const wakeButton = document.getElementById('wakeButton');
if (wakeButton) {
    wakeButton.addEventListener('touchstart', e => {
        e.preventDefault();
        let wakeTimer = setTimeout(() => {
            deactivateDimMode();
            resetInactivityTimer();
        }, 1500);
        ['touchend', 'touchcancel'].forEach(ev => {
            document.addEventListener(ev, () => clearTimeout(wakeTimer), { once: true });
        });
    });
}

// ============================================================================
// GPS MONITORING
// ============================================================================
function startGPSMonitoring() {
    // Stop any existing watch
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    
    if (navigator.geolocation) {
        gpsWatchId = navigator.geolocation.watchPosition(
            pos => {
                lastGPS = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                updateGPSBars(pos);
            },
            err => {
                console.error('GPS error:', err);
                // Update UI to show GPS unavailable
                const bars = document.querySelectorAll('.gps-bar');
                bars.forEach(b => {
                    b.classList.remove('active-red', 'active-amber', 'active-green');
                    b.style.backgroundColor = '#374151';
                });
            },
            { 
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
            }
        );
    }
}

function stopGPSMonitoring() {
    if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
}

function updateGPSBars(pos) {
    const accuracy = pos.coords.accuracy;
    const bars = document.querySelectorAll('.gps-bar');
    bars.forEach(b => b.classList.remove('active-red', 'active-amber', 'active-green'));
    if (accuracy > 50) {
        bars.forEach(b => b.classList.add('active-red'));
    } else if (accuracy > 20) {
        bars.forEach(b => b.classList.add('active-amber'));
    } else {
        bars.forEach(b => b.classList.add('active-green'));
    }
}

// Capture GPS for forms
function captureGPS(btn) {
    if (!navigator.geolocation) return showToast("GPS Not Supported");
    btn.innerText = "‚åõ...";
    navigator.geolocation.getCurrentPosition(
        pos => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            const input = btn.nextElementSibling;
            if (input) input.value = coords;
            showToast("Location Captured");
            btn.innerText = "GPS";
        },
        err => {
            showToast("GPS Error: Enable location");
            btn.innerText = "GPS";
            console.error('GPS capture error:', err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// ============================================================================
// CHECK-IN TIMER
// ============================================================================
function startCheckinTimer() {
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    checkinIntervalId = setInterval(() => {
        if (state && state.activeVisit) {
            const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
            const timerEl = document.getElementById('visitTimer');
            if (timerEl) {
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timerEl.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }, 1000);
}

// ============================================================================
// TRAVELLING PULSE
// ============================================================================
function startTravellingPulse() {
    if (travellingInterval) clearInterval(travellingInterval);
    travellingInterval = setInterval(() => {
        if (state && state.activeVisit && state.activeVisit.status === 'TRAVELLING') {
            // Send periodic location pulse
            logSafety('TRAVELLING', 'Location pulse');
        }
    }, 120000); // 2 minutes
}

/**
 * FULL INTEGRATED PATCH: buildReportForm
 * Resolves: [NOTE] parsing, Windows Photo Dialogue, and Signature UI alignment.
 */
function buildReportForm(templateName, fieldArea) {
    if (!fieldArea) return;
    fieldArea.innerHTML = ''; 

    // Logic: Fallback for unsynced or standard forms
    const template = state.globalForms.find(f => f.name === templateName) || 
                     { name: templateName, questions: ["[NOTE] Site Information", "[TEXT] Notes", "[SIGN] Signature"] };
    
    const questions = template.questions || [];

    questions.forEach((label, index) => {
        // Tag Scrutiny: Extract [TAG] and Label
        const tagMatch = label.match(/^\[(.*?)\]\s*(.*)$/i);
        const rawTag = tagMatch ? tagMatch[1].toUpperCase().trim() : "TEXT";
        let cleanLabel = tagMatch ? tagMatch[2] : label;
        
        let baseType = rawTag;
        let options = [];
        
        // Logic: Support comma-separated dropdown options
        if (rawTag.includes(',')) {
            const parts = rawTag.split(',');
            baseType = parts[0].trim();
            options = parts.slice(1).map(o => o.trim());
        }
        
        const fieldId = `field_${index}_${cleanLabel.replace(/\s/g, '_')}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-6'; 

        // Visibility Scrutiny: Headings/Notes don't need small labels
        const isInfoOnly = (baseType === 'HEADING' || baseType === 'HEAD' || baseType === 'NOTE');
        
        if (!isInfoOnly) {
            const labelEl = document.createElement('label');
            labelEl.className = 'block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2 ml-1';
            labelEl.innerText = cleanLabel;
            wrapper.appendChild(labelEl);
        }

        let input;
        switch(baseType) {
            case 'HEADING':
            case 'HEAD':
                const h = document.createElement('h3');
                h.className = 'text-blue-400 font-black text-[10px] uppercase tracking-[0.25em] mb-4 border-b border-blue-500/20 pb-2 mt-6';
                h.innerText = cleanLabel;
                wrapper.appendChild(h);
                fieldArea.appendChild(wrapper);
                return; // FIXED: Prevents creating a default field below

            case 'NOTE':
                const n = document.createElement('div');
                n.className = 'p-4 bg-blue-900/20 border-l-4 border-blue-500 rounded-r-xl text-xs text-blue-100 font-medium italic leading-relaxed';
                n.innerText = cleanLabel;
                wrapper.appendChild(n);
                fieldArea.appendChild(wrapper);
                return; // FIXED: Prevents creating a default field below

            case 'PHOTO': 
                const photoBtn = document.createElement('label');
                photoBtn.setAttribute('for', fieldId); // REQUIRED for Windows dialogue trigger
                photoBtn.className = 'flex flex-col items-center justify-center gap-2 w-full py-6 bg-gray-800 border-2 border-dashed border-gray-600 rounded-2xl text-gray-400 font-bold text-sm cursor-pointer active:bg-gray-700 transition-colors';
                photoBtn.innerHTML = `<span class="text-xl">üì∑</span><span>Take or Attach Photo</span>`;
                
                input = document.createElement('input');
                input.type = 'file'; 
                input.id = fieldId;
                input.accept = 'image/*'; 
                input.setAttribute('capture', 'environment'); 
                // FIXED: Opacity-0 instead of .hidden ensures browser triggers dialogue
                input.className = 'absolute opacity-0 w-0 h-0 pointer-events-none';
                input.onchange = () => handlePhoto(input, cleanLabel);
                
                photoBtn.appendChild(input);
                wrapper.appendChild(photoBtn);
                
                const status = document.createElement('div');
                status.id = `lbl_${fieldId}`; 
                status.className = 'text-[9px] text-blue-400 font-bold mt-2 uppercase text-center';
                wrapper.appendChild(status);
                fieldArea.appendChild(wrapper);
                return; // FIXED: Photo handling is self-contained

            case 'SIGN':
            case 'SIGNATURE':
                const canvas = document.createElement('canvas');
                canvas.id = `sig-canvas-${index}`;
                canvas.className = 'border-2 border-gray-600 rounded-2xl bg-white w-full h-32 shadow-inner';
                wrapper.appendChild(canvas);
                const clearBtn = document.createElement('button');
                clearBtn.className = 'text-[10px] text-gray-500 font-bold uppercase mt-2 ml-1';
                clearBtn.innerText = 'Clear Signature';
                clearBtn.onclick = (e) => { e.preventDefault(); clearSig(index); };
                wrapper.appendChild(clearBtn);
                input = document.createElement('input');
                input.type = 'hidden';
                input.setAttribute('data-signature-id', index);
                break;

            case 'CHECK':
            case 'CHECKBOX':
                const checkWrap = document.createElement('label');
                checkWrap.className = 'flex items-center gap-3 bg-gray-800/40 p-4 rounded-xl border border-white/5 cursor-pointer active:bg-blue-900/20 transition';
                input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'w-6 h-6 rounded accent-blue-500';
                const checkText = document.createElement('span');
                checkText.className = 'text-sm font-bold text-gray-300';
                checkText.innerText = 'I confirm';
                checkWrap.appendChild(input);
                checkWrap.appendChild(checkText);
                wrapper.appendChild(checkWrap);
                break;

            case '1TEXT':
                input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Type here...';
                break;

            case 'TEXT':
                input = document.createElement('textarea');
                input.rows = 4;
                input.placeholder = 'Type extended notes...';
                break;

            case 'DATE':
                input = document.createElement('input'); 
                input.type = 'date';
                break;

            case 'NUMBER':
                input = document.createElement('input'); 
                input.type = 'number';
                input.inputMode = 'numeric';
                break;

            case 'GPS':
                const gpsBtn = document.createElement('button');
                gpsBtn.className = 'w-full py-4 bg-blue-900/30 border border-blue-500/50 rounded-2xl text-blue-400 font-black text-[10px] uppercase tracking-widest mb-2';
                gpsBtn.innerText = 'üìç Capture GPS';
                gpsBtn.onclick = (e) => { e.preventDefault(); captureGPS(gpsBtn); };
                wrapper.appendChild(gpsBtn);
                input = document.createElement('input'); 
                input.readOnly = true; 
                input.className = 'opacity-40';
                break;

            case 'YESNO':
            case 'YES/NO':
                const radioWrap = document.createElement('div');
                radioWrap.className = 'flex gap-4 mt-2';
                ["Yes", "No"].forEach(val => {
                    const optWrap = document.createElement('label');
                    optWrap.className = 'flex-1 flex items-center justify-center gap-3 bg-gray-800 border-2 border-gray-700 rounded-xl py-4 cursor-pointer active:bg-blue-600 transition-colors';
                    const rad = document.createElement('input');
                    rad.type = 'radio';
                    rad.name = fieldId;
                    rad.value = val;
                    rad.className = 'w-5 h-5 accent-blue-500';
                    rad.setAttribute('data-key', cleanLabel);
                    optWrap.appendChild(rad);
                    const span = document.createElement('span');
                    span.className = 'text-sm font-bold text-white uppercase tracking-widest';
                    span.innerText = val;
                    optWrap.appendChild(span);
                    radioWrap.appendChild(optWrap);
                });
                wrapper.appendChild(radioWrap);
                input = null; 
                break;

            case 'DROP':
                input = document.createElement('select');
                ["-- Select --", ...options].forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = (o === "-- Select --") ? "" : o;
                    opt.text = o;
                    input.appendChild(opt);
                });
                break;

            default:
                input = document.createElement('textarea'); 
                input.rows = 2;
                input.placeholder = 'Type here...';
        }

        // Logic: Standardize all actual input fields
        if (input) {
            input.id = fieldId;
            if (input.type !== 'checkbox' && input.type !== 'hidden') {
                input.className = (input.className || '') + ' form-input';
            }
            input.setAttribute('data-key', cleanLabel);
            wrapper.appendChild(input);
        }
        fieldArea.appendChild(wrapper);
    });
}
    
/**
 * PATCHED: Universal Context-Aware Form Display
 * Ensures auto-population works from both Site Info AND during active visits.
 */
function loadFormAndShow(templateName, context = null) {
    if (typeof dimTimer !== 'undefined') clearTimeout(dimTimer);
    if (typeof deactivateDimMode === 'function') deactivateDimMode();

    // 1. DYNAMIC CONTEXT CAPTURE
    // Priority: 1. Passed context (Map) -> 2. Active Session (Visit) -> 3. Reset
    formExecutionContext = context || (state.activeVisit ? { 
        siteName: state.activeVisit.locationName, 
        companyName: state.activeVisit.companyName || "" 
    } : null);

    const sigCanvas = document.querySelector('canvas[id^="sig-canvas-"]');
    if (sigCanvas) {
        clearSig(sigCanvas.id.replace('sig-canvas-', ''));
    }
    
    navigate('report'); 
    
    const title = templateName === '(Standard)' ? 'Status Update' : templateName;
    const titleEl = document.getElementById('reportTitle');
    if (titleEl) {
        titleEl.textContent = isMidVisitUpdate ? `Update: ${title}` : title;
    }
    
    currentActiveTemplate = templateName;
    
    const fieldsContainer = document.getElementById('reportFields');
    if (fieldsContainer) {
        buildReportForm(templateName, fieldsContainer);
    }
    
    // Signature Pad Initialization
    setTimeout(() => {
        const canvases = document.querySelectorAll('canvas[id^="sig-canvas-"]');
        canvases.forEach(canvas => {
            resizeCanvas(canvas);
            initSigPad(canvas);
        });
    }, 300); 
    
    /**
     * ROCKET-LOADER SAFE: Distance Pre-fill
     */
    if (calculatedDist) {
        const allInputs = document.querySelectorAll('input[data-key], textarea[data-key]');
        const distInput = Array.from(allInputs).find(input => {
            const key = (input.getAttribute('data-key') || '').toLowerCase();
            return key.includes('distance') || key.includes('km') || key.includes('odo');
        });

        if (distInput) {
            distInput.value = calculatedDist.km;
            distInput.style.border = '2px solid #4ade80';
            distInput.classList.add('bg-green-900/20');
            distInput.dispatchEvent(new Event('input', { bubbles: true })); 
        }
    }

    /**
     * 2. REFINED AUTO-POPULATION LOGIC
     */
    if (formExecutionContext) {
        setTimeout(() => {
            const allFormElements = document.querySelectorAll('[data-key]');
            
            allFormElements.forEach(el => {
                const key = el.getAttribute('data-key').toLowerCase();
                
                // Logic: Matches "Site Name", "Site", "Company Name", etc.
                if (key.includes('site') && formExecutionContext.siteName) {
                    el.value = formExecutionContext.siteName;
                    el.classList.add('bg-blue-900/10'); 
                }
                if (key.includes('company') && formExecutionContext.companyName) {
                    el.value = formExecutionContext.companyName;
                    el.classList.add('bg-blue-900/10');
                }
            });
        }, 500); // Increased delay to 500ms for high-reliability field targeting
    }
    
    const btn = document.getElementById('btnSubmitRep');
    if (btn) {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.classList.add('active:scale-95', 'transition-all');

        if (!state.activeVisit) {
            newBtn.textContent = 'SUBMIT REPORT';
            newBtn.classList.remove('long-press-btn');
            newBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            newBtn.onclick = submitReport;
        } else if (isMidVisitUpdate) {
            newBtn.textContent = 'SEND UPDATE';
            newBtn.classList.remove('long-press-btn');
            newBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            newBtn.onclick = submitReport;
        } else {
            newBtn.textContent = 'HOLD TO SUBMIT & END';
            newBtn.classList.add('long-press-btn');
            setupLongPress(newBtn, 1500, submitReport); 
        }
    }
}
    
/**
 * HIGH-INTEGRITY DEPARTURE GATE
 * Fixed: 'Location not found' error during travel sessions.
 */
function preDepart() {
    if (!state || !state.activeVisit) return;
    
    // SAFETY GATE: Force PIN if an alarm is active
    if (state.activeVisit.isPanic) {
        showToast("‚ö†Ô∏è Clear alarm with PIN first");
        iamSafe(); // Triggers the PIN verification
        return;
    }
    
    isMidVisitUpdate = false;
    const activeLocId = state.activeVisit.locationId;

    // 1. TRAVEL BYPASS: Handle travel sessions without requiring a list lookup
    if (activeLocId === 'travel') {
        const noReport = localStorage.getItem('otg_user_travel_pref') === 'true';
        
        if (noReport) {
            submitReport(); // End immediately if no report required
            return;
        }

        const btnDepart = document.getElementById('btnDepart');
        if (btnDepart) btnDepart.textContent = 'Getting GPS...';
        
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                const endGPS = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
                const startGPS = state.activeVisit.startGPS;
                
                if (startGPS && endGPS) {
                    try {
                        calculatedDist = await getDistance(startGPS, endGPS);
                    } catch (err) {
                        const dist = haversine(startGPS, endGPS);
                        calculatedDist = { km: dist.toFixed(2), type: 'crow', offline: true };
                    }
                }
                if (btnDepart) btnDepart.textContent = 'HOLD TO END';
                loadFormAndShow('Travel Report'); // Explicitly load the travel template
            },
            (err) => {
                if (btnDepart) btnDepart.textContent = 'HOLD TO END';
                calculatedDist = null;
                loadFormAndShow('Travel Report');
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
        return; // Exit here for travel sessions
    }

    // 2. STANDARD LOOKUP: Only for regular site visits
    const location = state.locations.find(l => l.id === activeLocId);
    
    if (!location) {
        showToast('‚ö†Ô∏è Location not found. Emergency end triggered.');
        // EMERGENCY FAILSAFE: Allow user to submit a standard note if site is missing
        loadFormAndShow('(Standard)');
        return;
    }

    if (location.noReport) {
        submitReport();
    } else {
        calculatedDist = null;
        loadFormAndShow(location.templateName || '(Standard)');
    }
}

// ============================================================================
// ENTER LOCKED SCREEN
// ============================================================================
function enterLockedScreen() {
    navigate('locked');
    
    // PHASE 1: Initialize warning flags and anticipated departure time
    if (state && state.activeVisit) {
        // anticipatedDepartureTime should already be set by startVisit()
        // but fallback just in case
        if (!state.activeVisit.anticipatedDepartureTime) {
            const durationMs = (state.activeVisit.duration || 3600) * 1000;
            state.activeVisit.anticipatedDepartureTime = state.activeVisit.startTime + durationMs;
        }
        
        // Initialize all warning flags
        if (state.activeVisit.warn5minSent === undefined) state.activeVisit.warn5minSent = false;
        if (state.activeVisit.warn2minSent === undefined) state.activeVisit.warn2minSent = false;
        if (state.activeVisit.warn90Sent === undefined) state.activeVisit.warn90Sent = false;
        if (state.activeVisit.warningSent === undefined) state.activeVisit.warningSent = false;
        if (state.activeVisit.criticalSent === undefined) state.activeVisit.criticalSent = false;
        
        // Set location name in header
        const locNameEl = document.getElementById('lockedLocationName');
        if (locNameEl) {
            locNameEl.innerText = state.activeVisit.locationName || 'Unknown';
        }
        
        saveState();
    }
    
    // Setup long-press handlers for buttons
    const btnDepart = document.getElementById('btnDepart');
    if (btnDepart) setupLongPress(btnDepart, 2000, preDepart);
    
    const btnExtend = document.getElementById('btnExtend');
    if (btnExtend) setupLongPress(btnExtend, 1500, () => showModal('extend'));
    
    const btnSafe = document.getElementById('btnSafe');
    if (btnSafe) setupLongPress(btnSafe, 2000, iamSafe);
    
    // Start the countdown timer
    if (!timerInt) {
        timerInt = setInterval(tick, 1000);
    }
    
    startCheckinTimer();
}

// ============================================================================
// TRIGGER PANIC
// ============================================================================
async function triggerPanic(duress = false) {
    if (gpsWatchId === null) startGPSMonitoring();
    
    document.body.classList.add('bg-red-900');
    announce(duress ? "Duress activated silently." : "Panic alarm activated.");

    if (!duress) {
        document.body.classList.add('strobe-active');
    }    
    
    await initAudio();
    if (audioReady && synth) {
        try { synth.triggerAttackRelease('C4', '8n'); } catch (e) {}
    }
    
    await logSafety(duress ? "DURESS" : "PANIC", "Alert triggered.");
    
    if (state && state.activeVisit) {
        state.activeVisit.isPanic = true;
        if (duress) state.activeVisit.isDuress = true;
        saveState();
    }

    // CRITICAL FIX: Physically switch the UI to Panic Mode
    renderPanicState(); 
}

// PHASE 1: I AM SAFE function (after alarm triggered)
function iamSafe() {
    if (!state || !state.activeVisit) return;
    
    // Require PIN to declare safe
    withPinVerification(false, () => {
        announce("Safety confirmed. Resetting alarm.");
        logSafety("USER_SAFE", "Worker entered PIN to cancel alarm state.");
        // Add this inside your iamSafe PIN verification success block
        state.activeVisit.isSafeConfirmed = true; 
        saveState();
        
        // Reset panic UI
        const lockedPage = document.getElementById('lockedPage');
        if (lockedPage) lockedPage.classList.remove('panic-mode');
        document.body.classList.remove('bg-red-900');

        // Update iamSafe success block to remove strobe
        document.body.classList.remove('strobe-active');
        
        // Clear alarm state
        state.activeVisit.isPanic = false;
        state.activeVisit.criticalSent = false;
        
        // Hide "I AM SAFE" button, show normal buttons
        const btnSafe = document.getElementById('btnSafe');
        const btnDepart = document.getElementById('btnDepart');
        const btnExtend = document.getElementById('btnExtend');
        if (btnSafe) btnSafe.classList.add('hidden');
        if (btnDepart) btnDepart.classList.remove('hidden');
        if (btnExtend) btnExtend.classList.remove('hidden');
        
        saveState();
        showToast("‚úÖ Safety status confirmed");
    });
}

// ============================================================================
// SAFETY HEARTBEAT (tick) - PATCHED
// ============================================================================
function tick() {
    const gpsIndicator = document.getElementById('gpsIndicator');
    if (gpsIndicator && state.activeVisit) {
        if (state.activeVisit.locationId === 'travel') {
            gpsIndicator.classList.add('gps-pulse');
        } else {
            gpsIndicator.classList.remove('gps-pulse');
        }
    }
    if (state && state.activeVisit) {
        const remaining = state.activeVisit.duration - (Date.now() - state.activeVisit.startTime) / 1000;
        
        // NEW: Escalating Haptic Heartbeat (vibrate every 10s)
        if (remaining <= 120 && remaining > 0 && navigator.vibrate) {
            if (Math.floor(remaining) % 10 === 0) {
                if (remaining <= 30) {
                    // URGENT: Triple pulse (Final 30 seconds)
                    navigator.vibrate([100, 50, 100, 50, 100]);
                } else if (remaining <= 60) {
                    // WARNING: Double pulse (Final minute)
                    navigator.vibrate([100, 50, 100]);
                } else {
                    // ALERT: Single pulse (2-minute mark)
                    navigator.vibrate([100]);
                }
            }
        }
        // 1. GPS TRIGGER: Only if overdue and NOT already watching
        if (remaining <= 0 && gpsWatchId === null) {
            startGPSMonitoring();
        }
        
        // 2. PHASE 1: Multiple warning levels (Only fire if time is still remaining)
        if (remaining > 0) {
            if (remaining <= 300 && remaining > 299 && !state.activeVisit.warn5minSent) {
                playWarningSound('warning');
                state.activeVisit.warn5minSent = true;
                saveState();
            }
            if (remaining <= 120 && remaining > 119 && !state.activeVisit.warn2minSent) {
                playWarningSound('warning');
                speakWarning("Warning. Safety alarm will activate in two minutes.");
                state.activeVisit.warn2minSent = true;
                saveState();
            }
            if (remaining <= 90 && remaining > 89 && !state.activeVisit.warn90Sent) {
                playWarningSound('critical');
                speakWarning("Critical Warning. Safety alarm will activate in 90 seconds.");
                state.activeVisit.warn90Sent = true;
                saveState();
            }
        }
        
        const timerEl = document.getElementById('countdownTimer');
        const overdueLabel = document.getElementById('overdueLabel');
        const anticipatedTimeEl = document.getElementById('lockedAnticipatedTime');
        
        if (remaining <= 0) {
            // Automatically wake screen if dimmed
            if (typeof isDimmed !== 'undefined' && isDimmed) deactivateDimMode(); 

            // 3. OVERDUE UI Update (Digital Display)
            if (overdueLabel) overdueLabel.classList.remove('hidden');
            const absRemaining = Math.abs(remaining);
            const mins = Math.floor(absRemaining / 60);
            const secs = Math.floor(absRemaining % 60);
            if (timerEl) {
                if (mins >= 60) {
                    const hours = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    timerEl.innerHTML = `-${hours}h ${remainMins}m`;
                } else {
                    timerEl.innerHTML = `-${mins}:${secs.toString().padStart(2, '0')}<span class="text-3xl ml-2 font-black">min</span>`;
                }
                timerEl.classList.add('text-red-500', 'animate-pulse');
            }
            
            // 4. BREAK THE LOOP: Only update buttons and trigger panic if NOT already confirmed safe
            if (!state.activeVisit.isSafeConfirmed) {
                const btnSafe = document.getElementById('btnSafe');
                const btnDepart = document.getElementById('btnDepart');
                const btnExtend = document.getElementById('btnExtend');
                if (btnSafe) btnSafe.classList.remove('hidden');
                if (btnDepart) btnDepart.classList.add('hidden');
                if (btnExtend) btnExtend.classList.add('hidden');
                
                // Trigger critical alarm once
                if (!state.activeVisit.criticalSent) {
                    triggerPanic(false);
                    state.activeVisit.criticalSent = true;
                    saveState();
                }
            }
        } else {
            // COUNTDOWN (Normal countdown UI)
            if (overdueLabel) overdueLabel.classList.add('hidden');
            const mins = Math.floor(remaining / 60);
            const secs = Math.floor(remaining % 60);
            if (timerEl) {
                if (mins >= 60) {
                    const hours = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    timerEl.innerHTML = `${hours}h ${remainMins}m`;
                } else {
                    timerEl.innerHTML = `${mins}:${secs.toString().padStart(2, '0')}<span class="text-3xl ml-2 font-black">min</span>`;
                }
                timerEl.classList.remove('text-red-500', 'animate-pulse');
            }
        }
        
        if (state.activeVisit.anticipatedDepartureTime && anticipatedTimeEl) {
            const antTime = new Date(state.activeVisit.anticipatedDepartureTime);
            anticipatedTimeEl.innerText = antTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: true});
        }
    }
}

// ============================================================================
// ENHANCED RENDER LOCATIONS (Layout Corrected)
// ============================================================================
function renderLocations() {
    const list = document.getElementById('locationList');
    const travelRow = document.getElementById('travelRow');
    
    if (!list || !travelRow) {
        console.error('UI Error: Location containers missing.');
        return;
    }
    
    list.innerHTML = '';
    travelRow.innerHTML = '';
    
    // 1. Render Travel Tile (Only if enabled in Factory)
    if (CONFIG.mileageEnabled) {
        const travelTile = createTravelTile();
        travelRow.appendChild(travelTile);
    } else {
        // If mileage is disabled, you might want to hide the row entirely
        travelRow.classList.add('hidden');
    }
    
    // 2. Render Regular Locations
    const sites = state.locations.filter(loc => loc && loc.id !== 'travel');
    
    if (sites.length === 0) {
        // FIXED: Provides a clear action instead of a blank screen
        const empty = document.createElement('div');
        empty.className = 'col-span-2 p-12 text-center';
        empty.innerHTML = `
            <div class="text-4xl mb-4 opacity-20">üì°</div>
            <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-4">No Sites Synced</p>
            <button onclick="forceSync(true)" class="px-6 py-3 bg-blue-600 rounded-xl font-bold text-sm shadow-lg">
                Download Sites Now
            </button>
        `;
        list.appendChild(empty);
    }
    else {
        sites.forEach(loc => {
            const tile = createLocationTile(loc);
            list.appendChild(tile);
        });
    }
    
    // 3. Sync Button State
    updateArrivedButtonState();
}
// ============================================================================
// WIZARD NAVIGATION
// ============================================================================
function startWizard() {
    // Show setup page
    const setupPage = document.getElementById('setupPage');
    if (setupPage) setupPage.classList.add('active');
    
    // Hide all other pages
    document.querySelectorAll('.page').forEach(p => {
        if (p.id !== 'setupPage') p.classList.remove('active');
    });
    
    // Reset to step 1
    state.currentWizStep = 1;
    
    // Hide all wizard steps
    document.querySelectorAll('[id^="wizStep"]').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show step 1
    const step1 = document.getElementById('wizStep1');
    if (step1) step1.classList.add('active');
    
    // Reset buttons
    const btnPrev = document.getElementById('btnWizPrev');
    const btnNext = document.getElementById('btnWizNext');
    if (btnPrev) btnPrev.classList.add('hidden');
    if (btnNext) btnNext.classList.remove('hidden');
    
    console.log('Wizard started');
}

function prevWiz() {
    if (!state || state.currentWizStep <= 1) return;
    
    document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
    state.currentWizStep--;
    document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
    
    const btnPrev = document.getElementById('btnWizPrev');
    const btnNext = document.getElementById('btnWizNext');
    
    if (state.currentWizStep === 1 && btnPrev) btnPrev.classList.add('hidden');
    if (btnNext) btnNext.innerText = "Next Step";
    
    saveState();
}

function nextWiz() {
    if (!state) return;
    
    if (state.currentWizStep < 3) {
        document.getElementById(`wizStep${state.currentWizStep}`).classList.remove('active');
        state.currentWizStep++;
        document.getElementById(`wizStep${state.currentWizStep}`).classList.add('active');
        
        const btnPrev = document.getElementById('btnWizPrev');
        const btnNext = document.getElementById('btnWizNext');
        
        if (state.currentWizStep === 2 && btnPrev) btnPrev.classList.remove('hidden');
        if (state.currentWizStep === 3 && btnNext) btnNext.innerText = "Finish Setup";
        
        saveState();
    } else {
        saveWizard();
    }
}

/**
 * FULL INTEGRATION: Identity Save + UI Initialization + Backend Registration
 */
function saveWizard() {
    const workerData = {
        name: document.getElementById('wizName').value.trim(),
        phone: document.getElementById('wizPhone').value.trim(),
        email: document.getElementById('wizEmail').value.trim(),
        pin: document.getElementById('wizPin').value,
        duress: document.getElementById('wizDuress').value,
        emgName: document.getElementById('wizContactName').value.trim(),
        emgPhone: document.getElementById('wizContactPhone').value.trim(),
        emgEmail: document.getElementById('wizContactEmail').value.trim(),
        escName: document.getElementById('wizEscName').value.trim(),
        escPhone: document.getElementById('wizEscPhone').value.trim(),
        escEmail: document.getElementById('wizEscEmail').value.trim()
    };
    
    if (!workerData.name || !workerData.pin || !workerData.duress) {
        return alert("Please complete Name and Security PINs to proceed.");
    }
    
    // 1. Persist State
    state.worker = workerData;
    state.pins.std = workerData.pin;
    state.pins.duress = workerData.duress;
    if (!state.deviceId) state.deviceId = getDeviceID();
    saveState();
    
    const headerName = document.getElementById('headerWorkerName');
    if (headerName) headerName.innerText = workerData.name;
    
    announce(`Welcome ${workerData.name}. Device registered.`);

    // 2. RETAINED CHUNK: Construct Registration Payload
    const regPayload = {
        'action': 'registerDevice',
        'key': CONFIG.key,
        'Worker Name': workerData.name,
        'Worker Phone Number': workerData.phone,
        'Worker Email': workerData.email,
        'Emergency Contact Name': workerData.emgName,
        'Emergency Contact Phone': workerData.emgPhone,
        'Emergency Contact Email': workerData.emgEmail,
        'Escalation Contact Name': workerData.escName,
        'Escalation Contact Phone': workerData.escPhone,
        'Escalation Contact Email': workerData.escEmail,
        'deviceId': state.deviceId,
        'Timestamp': new Date().toISOString()
    };
    
    // 3. CRITICAL UI INITIALIZATION: Wakes up the buttons and tiles
    renderLocations(); 
    setupHoldToStart(); 
    updateArrivedButtonState();
    
    navigate('main');
    
    // 4. Trigger Backend Sync
    processUploadQueue(regPayload);
    setTimeout(() => { forceSync(false); }, 1000);
}

// ============================================================================
// INSTALL PROMPTS
// ============================================================================
function checkIosInstall() {
    const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
    
    // Use standard display-mode check with iOS fallback
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
    
    if (isIos && !isStandalone && !localStorage.getItem('otg_install_dismissed')) {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.remove('hidden');
    }
}

// ============================================================================
// PWA SETUP
// ============================================================================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(registration => {
            console.log('Service Worker registered:', registration.scope);
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        if (confirm('New version available. Update now?')) {
                            window.location.reload();
                        }
                    }
                });
            });
        })
        .catch(err => {
            console.error('Service Worker registration failed:', err);
        });
}

// ============================================================================
// INSTALL PROMPTS (PC & Android)
// ============================================================================
window.addEventListener('beforeinstallprompt', e => {
    // 1. Prevent the default mini-infobar from appearing
    e.preventDefault();
    
    // 2. Stash the event so it can be triggered by your button
    deferredPrompt = e;
    
    // 3. Show your custom banner if the user hasn't dismissed it previously
    if (!localStorage.getItem('install_dismissed')) {
        const banner = document.getElementById('installBanner');
        if (banner) banner.classList.remove('hidden');
    }
});
// ============================================================================
// CLEANUP ON UNLOAD
// ============================================================================
window.addEventListener('beforeunload', () => {
    stopGPSMonitoring();
    if (checkinIntervalId) clearInterval(checkinIntervalId);
    if (travellingInterval) clearInterval(travellingInterval);
    if (timerInt) clearInterval(timerInt);
});

// ============================================================================
// QUICK WINS: DURATION SLIDER, FORMS BUTTON, HOLD TO START, TRAVEL TILE
// ============================================================================

// Update duration display when slider moves
function updateDurationDisplay() {
    const slider = document.getElementById('durationSlider');
    if (!slider) return;
    
    const minutes = DURATION_MAP[parseInt(slider.value)];
    const display = document.getElementById('durationDisplay');
    
    if (display) {
        // Calculate dynamic arrival/due time
        const dueTime = new Date(Date.now() + minutes * 60000);
        const timeStr = dueTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let durStr = minutes >= 60 ? `${Math.floor(minutes/60)}h ${minutes%60}m` : `${minutes}m`;
        display.innerHTML = `<span class="text-blue-400 font-bold">${durStr}</span> <span class="mx-2 opacity-20">|</span> <span class="text-gray-400">Due: ${timeStr}</span>`;
    }
    
    state.visitDurationMinutes = minutes;
    updateArrivedButtonState();
}

// Add this helper function to the script section
function setQuickDuration(mins) {
    const slider = document.getElementById('durationSlider');
    if (!slider) return;
    const idx = DURATION_MAP.indexOf(mins);
    if (idx !== -1) {
        slider.value = idx;
        updateDurationDisplay(); 
        // Force the Start button to re-check its enabled/disabled status
        updateArrivedButtonState(); 
        if (navigator.vibrate) navigator.vibrate(15);
    }
}
    
/**
 * Renders the Forms Library in a Two-Column Grid.
 */
function openFormsLibrary() {
    // 1. Correctly set the update flag based on visit state
    isMidVisitUpdate = (state.activeVisit !== null); 
    
    const list = document.getElementById('formsLibraryList');
    if (!list) return;

    list.innerHTML = '';
    const forms = state.globalForms || [];

    if (forms.length === 0) {
        list.innerHTML = '<div class="p-8 text-center opacity-40 text-xs font-bold uppercase tracking-widest">No templates available.</div>';
    } else {
        list.className = "grid grid-cols-2 gap-3 overflow-y-auto pr-2";
        forms.forEach(form => {
            const row = document.createElement('div');
            row.className = 'p-4 bg-white/5 border border-white/10 rounded-2xl flex flex-col items-center justify-center text-center active:scale-95 transition-all aspect-square';
            
            let icon = "üìã";
            if (form.name.toLowerCase().includes('vehicle')) icon = "üöó";
            if (form.name.toLowerCase().includes('audit')) icon = "üîç";
            if (form.name.toLowerCase().includes('incident')) icon = "‚ö†Ô∏è";

            row.innerHTML = `
                <div class="text-3xl mb-2">${icon}</div>
                <div class="text-[11px] font-extrabold tracking-tight text-white leading-tight">${form.name}</div>
                <div class="text-[8px] text-blue-400 font-bold uppercase mt-1">${form.questions.length} Checks</div>
            `;
            
            // FIXED: Now calls loadFormAndShow to ensure the Submit button is active
            row.onclick = () => {
                closeModal('formsLibrary');
                loadFormAndShow(form.name);
            };
            list.appendChild(row);
        });
    }
    showModal('formsLibrary');
}
// Toggle high-risk/critical timing mode
function toggleHighRiskUI() {
    const checkbox = document.getElementById('chkHighRisk');
    if (!checkbox) return;
    
    if (checkbox.checked) {
        showToast('‚ö° Critical timing mode ON - Zero grace period');
    } else {
        showToast('‚úÖ Critical timing mode OFF');
    }
    
    // Store preference
    if (state) {
        state.highRiskMode = checkbox.checked;
        saveState();
    }
}

/**
 * 1A. Travel Tile: Toggles Travel Mode
 */
function createTravelTile() {
    const isActive = state && state.isTravelActive; // Changed from ID check
    const noReport = localStorage.getItem('otg_user_travel_pref') === 'true';
    
    const tile = document.createElement('div');
    tile.className = `w-full h-14 rounded-xl shadow-lg flex items-center justify-between px-4 cursor-pointer transition-all border-2 ${
        isActive 
            ? 'border-white scale-[1.02] ring-2 ring-purple-400' 
            : 'border-gray-700 hover:border-white/20'
    } bg-gradient-to-r from-indigo-600 to-purple-700`;
    
    tile.innerHTML = `
        <div class="flex items-center gap-2">
            <div class="text-xl">üöó</div>
            <div>
                <div class="text-sm font-bold text-white tracking-tight leading-none">Travel Mode</div>
                <div class="text-[8px] text-indigo-200 font-medium uppercase mt-0.5">${noReport ? 'Report optional' : 'Report required'}</div>
            </div>
        </div>
    `;
    
    tile.onclick = () => {
        state.isTravelActive = !state.isTravelActive;
        renderLocations();
        updateArrivedButtonState();
    };
    return tile;
}

/**
 * UPDATED: Location Tile with Information Button
 */
function createLocationTile(loc) {
    const isSel = state && state.selectedLocationId === loc.id;
    const isCritical = loc.isCritical || false;
    
    const tile = document.createElement('div');
    tile.className = `p-3 rounded-lg border-2 cursor-pointer flex flex-col justify-between h-24 transition-all ${
        isSel ? 'border-blue-500 bg-blue-900/40' : (isCritical ? 'border-red-900/50 bg-red-950/20' : 'border-gray-700 bg-gray-800 hover:bg-gray-750')
    }`;
    
    let icon = "üè¢";
    if (loc.name && loc.name.toLowerCase().includes("home")) icon = "üè†";
    
    // Check if there is any information to show
    const hasInfo = !!(loc.address || loc.notes || loc.contactName || loc.contactPhone || loc.contactEmail);
    
    tile.innerHTML = `
        <div class="flex justify-between items-start">
            <span class="text-2xl">${icon}</span>
            ${hasInfo ? `<button class="text-gray-500 hover:text-white p-1 -mt-1 -mr-1 z-20 text-xl" onclick="showSiteInfo('${loc.id}', event)">‚ÑπÔ∏è</button>` : ''}
        </div>
        <div>
            ${loc.companyName ? `<div class="text-[10px] font-bold text-gray-400 uppercase truncate leading-none mb-1">${loc.companyName}</div>` : ''}
            <div class="text-[13px] font-black text-white truncate leading-tight">${loc.name}</div>
        </div>
    `;
    
    tile.onclick = () => {
        state.selectedLocationId = (state.selectedLocationId === loc.id) ? null : loc.id;
        renderLocations();
        updateArrivedButtonState();
    };
    return tile;
}


// Edit travel settings (report required toggle)
function editTravelSettings() {
    const noReport = localStorage.getItem('otg_user_travel_pref') === 'true';
    
    const confirmed = confirm(
        noReport 
            ? 'Currently: Report OPTIONAL\n\nChange to require report after travel?' 
            : 'Currently: Report REQUIRED\n\nChange to make report optional?'
    );
    
    if (confirmed) {
        localStorage.setItem('otg_user_travel_pref', (!noReport).toString());
        renderLocations();
        showToast('‚úÖ Travel settings updated');
    }
}
 
function updateArrivedButtonState() {
    const btn = document.getElementById('btnStart');
    const slider = document.getElementById('durationSlider');
    if (!btn || !slider) return;
    
    const hasLocation = !!state.selectedLocationId;
    const durationMins = DURATION_MAP[parseInt(slider.value)];
    const hasDuration = durationMins > 0;

    btn.disabled = false; 
    
    // CRITICAL: Clear all mode colors first to prevent conflicts
    btn.classList.remove('bg-blue-600', 'bg-purple-600', 'bg-gray-700', 'text-white', 'text-gray-500', 'opacity-50');

    if (state.isTravelActive) {
        const loc = state.locations.find(l => l.id === state.selectedLocationId);
        const destName = loc ? loc.name : null;
        
        if (destName) {
            btn.innerText = `HOLD TO TRAVEL TO ${destName.toUpperCase()}`;
            btn.classList.add('bg-purple-600', 'text-white');
        } else {
            // PROMPT: Guides the user to pick a site
            btn.innerText = 'SELECT DESTINATION';
            btn.classList.add('bg-purple-600', 'text-white', 'opacity-50');
        }
    } else if (hasLocation && hasDuration) {
        btn.innerText = 'HOLD TO START';
        btn.classList.add('bg-blue-600', 'text-white');
    } else {
        btn.innerText = !hasLocation ? 'SELECT SITE' : 'SELECT TIME';
        btn.classList.add('bg-gray-700', 'text-gray-500', 'opacity-50');
    }
}
   
/**
 * Modular "Hold to Start" Logic
 * Connects the UI to the Safety Engine using the Long-Press Utility.
 */
function setupHoldToStart() {
    const btn = document.getElementById('btnStart');
    if (!btn) return;
    
    setupLongPress('btnStart', 1500, () => {
        if (!state.selectedLocationId) return showToast('üìç Select a site first');
        
        // AUTO-DURATION: Apply a default if the worker forgot the slider (Universal Fix)
        if (!state.visitDurationMinutes || state.visitDurationMinutes === 0) {
            state.visitDurationMinutes = 30;
            const slider = document.getElementById('durationSlider');
            if (slider) slider.value = 4; // Visual update for 30m
            updateDurationDisplay();
        }

        startVisit();
    });
}
/**
 * REWRITTEN: Targeted Travel & Visit Safety Engine
 * Permits selecting a Site as a travel destination.
 */
async function startVisit() {
    isMidVisitUpdate = false; 

    // 1. Audio Unlock
    try {
        await Promise.race([Tone.start(), new Promise(r => setTimeout(r, 500))]);
    } catch (e) { console.warn("Audio skipped"); }

    const locId = state.selectedLocationId;
    const isTravelMode = !!state.isTravelActive; // Toggle state from Travel Mode tile
    
    // Safety check: require a destination if in travel mode
    if (!locId && !isTravelMode) return showToast('‚ö†Ô∏è Select a destination first');

    // Identify the target location object
    const loc = state.locations.find(l => l.id === locId) || 
                { id: 'travel', name: 'General Travel' };
    
    const slider = document.getElementById('durationSlider');
    const durationMins = DURATION_MAP[parseInt(slider.value)];
    const isHighRisk = document.getElementById('chkHighRisk')?.checked || false;

    // 2. GPS PRE-FLIGHT: Fresh lock for mileage accuracy
    let verifiedStartGPS = lastGPS || "0,0";
    if (isTravelMode || locId === 'travel') {
        showToast('üìç Locking GPS signal...');
        try {
            const freshPos = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { 
                    enableHighAccuracy: true, timeout: 3000 
                });
            });
            verifiedStartGPS = `${freshPos.coords.latitude.toFixed(6)},${freshPos.coords.longitude.toFixed(6)}`;
            lastGPS = verifiedStartGPS;
        } catch (e) {
            console.warn('GPS signal lock deferred.');
        }
        startGPSMonitoring(); // Engage continuous tracking
    }

    const startTime = Date.now();
    const durationSec = durationMins * 60;

    // 3. Initialize Active Safety Session
    state.activeVisit = {
        locationId: locId || 'travel',
        locationName: loc.name,
        companyName: loc.companyName || "",
        isTravel: isTravelMode, // Stores Targeted Travel mode for reporting logic
        startTime: startTime,
        duration: durationSec,
        anticipatedDepartureTime: startTime + (durationSec * 1000),
        startGPS: verifiedStartGPS,
        highRisk: isHighRisk,
        isPanic: false,
        criticalSent: false,
        warn5minSent: false,
        warn2minSent: false,
        warn90Sent: false
    };

    // Reset targeted travel toggle for next session
    state.isTravelActive = false; 
    saveState();

    // 4. BACKEND LOGGING: Destination written to spreadsheet
    const alarmStatus = isTravelMode ? "TRAVELLING" : "ARRIVED";
    const logNote = isTravelMode ? `Travel to ${loc.name} started.` : `${loc.name} visit started.`;

    processUploadQueue(buildPayload({
        'action': 'logVisit',
        'Alarm Status': alarmStatus,
        'Location Name': loc.name, // Written as destination to the sheet
        'Notes': `${logNote} Duration: ${durationMins}m`,
        'Last Known GPS': verifiedStartGPS
    }));

    announce(isTravelMode ? `Travelling to ${loc.name}.` : `${loc.name} started.`);
    
    if (typeof requestWakeLock === 'function') requestWakeLock();
    if (isTravelMode || locId === 'travel') startTravellingPulse();

    resetInactivityTimer(); 
    renderLocations();
    updateArrivedButtonState(); // Resets button label for locked screen state
    enterLockedScreen();
}
    
// ============================================================================
// CRITICAL FUNCTIONS EXTRACTED FROM WS_SAFETY (MISSING IN ORIGINAL BUILD)
// ============================================================================

// Critical variables needed by these functions (new ones only, avoid duplicates)
let calculatedDist = null;
let gpsWarm = false;
let travelTargetName = "";
let panicTapCount = 0;
let panicTapTimer;

// Note: currentBatteryLevel, currentActiveTemplate and isMidVisitUpdate already declared earlier in file

// 1. BUILD PAYLOAD - Constructs proper data structure for backend
/**
/**
 * HIGH-INTEGRITY PAYLOAD BUILDER
 * Fixes: "Number" to "Phone" header alignment.
 * Fixes: Missing 'action' key for spreadsheet ingestion.
 */
function buildPayload(d) {
    let dt = "";
    let ln = "Unknown Site";
    let la = "No Address Provided";
    
    if (state.activeVisit) {
        if (state.activeVisit.anticipatedDepartureTime) {
            dt = new Date(state.activeVisit.anticipatedDepartureTime).toISOString();
        }
        const l = state.locations.find(x => x.id === state.activeVisit.locationId);
        if (l) {
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name;
            la = l.address || "No Address";
        }
    } else if (state.selectedLocationId) {
        const l = state.locations.find(x => x.id === state.selectedLocationId);
        if (l) {
            ln = l.companyName ? `${l.companyName} - ${l.name}` : l.name;
            la = l.address || "No Address";
        }
    }
    
    let gps = d['Last Known GPS'] || "";
    if (!gps && state.activeVisit && state.activeVisit.startGPS) {
        gps = state.activeVisit.startGPS;
    }
    
    return {
        'action': d.action || 'logVisit', 
        'key': CONFIG.key,
        'Worker Name': state.worker?.name || "",
        'Worker Phone Number': state.worker?.phone || "",
        'Worker Email': state.worker?.email || "",
        'Emergency Contact Name': state.worker?.emgName || "",
        'Emergency Contact Phone': state.worker?.emgPhone || "", 
        'Emergency Contact Email': state.worker?.emgEmail || "",
        'Escalation Contact Name': state.worker?.escName || "",
        'Escalation Contact Phone': state.worker?.escPhone || "",
        'Escalation Contact Email': state.worker?.escEmail || "",
        'Battery Level': currentBatteryLevel || "100%",
        'Location Name': ln,
        'Location Address': la,
        'Anticipated Departure Time': dt,
        'Timestamp': new Date().toISOString(),
        'deviceId': state.deviceId || "",
        'Last Known GPS': gps || "0,0",
        ...d
    };
}

/**
 * ROBUST SYNC ENGINE - GAS COMPATIBLE
 * Handles the 'opaque' responses required by Google Apps Script.
 */
let retryDelay = 2000; // Start with 2s backoff

function processUploadQueue(d) {
    if (d) {
        // LIMIT QUEUE: Keep the 100 most recent items to prevent memory exhaustion
        if (state.pendingUploads.length > 100) {
            state.pendingUploads.shift(); 
        }
        state.pendingUploads.push(d);
        saveState();
    }
    
    if (!navigator.onLine || state.pendingUploads.length === 0) return;

    const currentUpload = state.pendingUploads[0];
    const fd = new FormData();
    for (let k in currentUpload) { fd.append(k, currentUpload[k]); }

    fetch(CONFIG.url, { 
        method: 'POST', 
        body: fd, 
        mode: 'no-cors' 
    }).then(() => {
        // SUCCESS: Reset backoff and clear queue item
        state.pendingUploads.shift();
        saveState();
        retryDelay = 2000; 
        
        if (state.pendingUploads.length > 0) {
            setTimeout(processUploadQueue, 500);
        }
    }).catch(e => {
        // FAILURE: Exponential Backoff (Retries: 2s, 4s, 8s... up to 1m)
        console.warn(`Sync deferred. Retrying in ${retryDelay/1000}s...`);
        setTimeout(processUploadQueue, retryDelay);
        retryDelay = Math.min(retryDelay * 2, 60000); 
    });
}

/**
/**
 * PATCHED: High-Integrity Data Gathering Engine
 * Ensures signatures and auto-filled site data are correctly captured for the backend.
 */
function gatherFormData() {
    const d = { custom: {}, notes: '', sig: null, jsonPayload: {} };
    
    // 1. Capture legacy notes (Standard template)
    const sn = document.getElementById('rep_notes');
    if (sn) d.notes = sn.value;
    
    // 2. Iterate through all dynamic form elements
    document.querySelectorAll('[data-key]').forEach(el => {
        const k = el.getAttribute('data-key');
        let v = el.value;
        let isMedia = false;
        
        // Logic: Handle specific input types
        if (el.type === 'checkbox') {
            v = el.checked ? 'Yes' : 'No';
        } else if (el.type === 'radio') {
            if (!el.checked) return; // Skip non-selected options
            v = el.value;
        } else if (el.type === 'hidden' && el.hasAttribute('data-signature-id')) {
            // FIXED: Signature extraction
            const sigId = el.getAttribute('data-signature-id');
            const canvas = document.getElementById(`sig-canvas-${sigId}`);
            if (canvas) {
                v = canvas.toDataURL('image/png');
                d.sig = v; // Assigned to dedicated property for backend
                isMedia = true; 
            }
        }
        
        // 3. Populate Payload Objects
        d.custom[k] = v;
        
        // OPTIMISATION: Replace large media with tokens in the JSON blob to prevent cell overflows
        if (isMedia) {
            d.jsonPayload[k] = "{{SIGNATURE}}"; 
        } else {
            d.jsonPayload[k] = v;
        }
    });
    
    return d;
}
    
// 4. RENDER PANIC STATE - Changes UI to panic mode
function renderPanicState() {
    const lockedPage = document.getElementById('lockedPage');
    if (lockedPage) lockedPage.classList.add('panic-mode');
    
    const btnDepart = document.getElementById('btnDepart');
    if (btnDepart) btnDepart.classList.add('hidden');
    
    const btnExtend = document.getElementById('btnExtend');
    if (btnExtend) btnExtend.classList.add('hidden');
    
    const btnSafe = document.getElementById('btnSafe');
    if (btnSafe) {
        btnSafe.classList.remove('hidden');
        setupLongPress(btnSafe, 2000, iamSafe);
    }
}

// 5. WARM UP GPS - Pre-warms GPS for faster first capture
function warmUpGps() {
    if (gpsWarm) return;
    gpsWarm = true;
    
    navigator.geolocation.getCurrentPosition(
        () => {},
        (err) => {
            if (err.code === 1) showToast("üìç GPS Permission Required");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
    
    setTimeout(() => {
        gpsWarm = false;
    }, 30000);
}

// 6. PLAY SOUND - Audio feedback for events
function playSound(t) {
    initAudio().then(() => {
        const n = Tone.now();
        if (t === 'arrive') synth.triggerAttackRelease("C4", "8n", n);
        if (t === 'depart') synth.triggerAttackRelease("G4", "8n", n);
        if (t === 'warning') synth.triggerAttackRelease("E5", "16n", n);
        if (t === 'panic') synth.triggerAttackRelease("G5", "16n", n);
    });
}

// ============================================================================
// CRITICAL MISSING FUNCTIONS FROM WS_SAFETY
// ============================================================================

// 1. TRIGGER AUTO ALERT - Sends alarm when timer expires
function triggerAutoAlert(status) {
    if (!state || !state.activeVisit) return;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    const locationName = location ? 
        (location.companyName ? `${location.companyName} - ${location.name}` : location.name) : 
        "Unknown Location";
    
    console.log(`Triggering auto alert: ${status} for ${locationName}`);
    
    // Try to get current GPS
    navigator.geolocation.getCurrentPosition(
        position => {
            const gps = `${position.coords.latitude},${position.coords.longitude}`;
            console.log(`Auto alert with GPS: ${gps}`);
            
            processUploadQueue(buildPayload({
                "Alarm Status": status,
                "Notes": "Automated System Alert",
                "Location Name": locationName,
                "Last Known GPS": gps
            }));
            
            showToast("üö® Emergency alert sent");
        },
        error => {
            console.warn('GPS failed for auto alert:', error);
            
            processUploadQueue(buildPayload({
                "Alarm Status": status,
                "Notes": "Automated System Alert (GPS unavailable)",
                "Location Name": locationName,
                "Last Known GPS": lastGPS || "Not available"
            }));
            
            showToast("üö® Emergency alert sent (no GPS)");
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
    );
}

// 2. COMPRESS IMAGE - Reduces photo size before upload
/**
 * PATCHED: High-Integrity Photo Compression
 * Optimised for Google Sheets 50,000 character cell limit.
 */
function compressImg(file) {
    return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // FIXED: Reduced from 1200 to 800 to fit cell character limits
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width = width * (MAX_HEIGHT / height);
                        height = MAX_HEIGHT;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // FIXED: Quality reduced to 0.6 for optimal Base64 string length
                const compressed = canvas.toDataURL('image/jpeg', 0.6);
                
                console.log(`Image optimised for Sheets: ${compressed.length} chars`);
                resolve(compressed);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}
    
/**
 * PATCHED: Photo Handler with UI Status Feedback
 */
function handlePhoto(input, key) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const labelId = `lbl_${input.id}`; 
    const statusLabel = document.getElementById(labelId);
    
    if (statusLabel) {
        statusLabel.innerText = "‚è≥ Compressing...";
        statusLabel.classList.remove('text-blue-400', 'text-red-400');
        statusLabel.classList.add('text-blue-400');
    }
    
    compressImg(file).then(base64 => {
        if (!state.photoStore) state.photoStore = {};
        state.photoStore[key] = base64;
        saveState();
        
        if (statusLabel) {
            statusLabel.innerText = "‚úÖ Photo Saved";
            statusLabel.classList.add('text-green-400');
        }
        console.log(`Photo processed: ${key}`);
    }).catch(err => {
        console.error('Compression Error:', err);
        if (statusLabel) {
            statusLabel.innerText = "‚ùå Compression Failed";
            statusLabel.classList.add('text-red-400');
        }
    });
}

/**
 * CONFIRMED BEST: Attachment Handler
 */
function handleAttachment(input, key) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    const labelId = `lbl_${input.id}`;
    const label = document.getElementById(labelId);
    
    if (label) label.innerText = "Attaching...";
    
    const reader = new FileReader();
    reader.onload = (e) => {
        if (!state.photoStore) state.photoStore = {};
        state.photoStore[key] = e.target.result; 
        saveState();
        if (label) label.innerText = "üìé Attachment Saved";
    };
    // Added safety error handler
    reader.onerror = () => { if (label) label.innerText = "‚ùå Error"; };
    reader.readAsDataURL(file);
}
    
// 4. BEST-IN-CLASS: High-DPI Signature Engine
// Includes edge-case safety (touchcancel/mouseout) and coordinate precision.

function initSigPad(canvas) {
    if (!canvas) return;
    resizeCanvas(canvas); 
    
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    // SCOPED: Prevents drawing jumps if multiple pads exist
    let lastX = 0;
    let lastY = 0;
    
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        // Rely on context scaling for DPI mapping
        return {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };
    };
    
    const startDrawing = (e) => {
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        if (e.cancelable) e.preventDefault();
    };
    
    const draw = (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
        if (e.cancelable) e.preventDefault();
    };
    
    const stopDrawing = () => { isDrawing = false; };
    
    // EDGE-CASE SAFETY: Stops drawing if the user leaves the canvas area
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing); // Handles interruptions
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing); // Handles mouse leaving area
}

// 5. RESIZE CANVAS    
function resizeCanvas(canvasEl) {
    const ratio = window.devicePixelRatio || 1;
    const rect = canvasEl.getBoundingClientRect();
    // Buffer scaling for Retina/High-DPI crispness
    canvasEl.width = rect.width * ratio;
    canvasEl.height = rect.height * ratio;
    const ctx = canvasEl.getContext('2d');
    ctx.scale(ratio, ratio);
}


// 6. CLEAR SIGNATURE - Clears signature canvas
function clearSig(id) {
    const canvasId = id ? `sig-canvas-${id}` : 'sig-canvas';
    const canvas = document.getElementById(canvasId);
    
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        console.log(`Signature cleared: ${canvasId}`);
    }
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Helper: Get Device ID
function getDeviceID() {
    let id = localStorage.getItem('otg_device_id');
    if (!id) {
        id = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        localStorage.setItem('otg_device_id', id);
        console.log('New device ID generated:', id);
    }
    return id;
}

// Fetch locations from backend
async function fetchLocationsFromBackend() {
    if (!CONFIG.url || !state || !state.worker || !state.worker.name) {
        console.warn('Cannot fetch locations: missing config or worker data');
        renderLocations(); // Render with empty list
        return;
    }
    
    try {
        showToast('üì° Fetching locations...');
        
        const url = `${CONFIG.url}?action=getLocations&worker=${encodeURIComponent(state.worker.name)}&deviceId=${state.deviceId}&key=${CONFIG.key}`;
        
        console.log('Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('Location fetch response:', data);
        
        if (data.status === 'success' && data.locations && Array.isArray(data.locations)) {
            // Merge with existing locations (don't overwrite travel tile)
            const existingTravel = state.locations.find(l => l.id === 'travel');
            
            state.locations = data.locations.filter(l => l.id !== 'travel');
            
            // Re-add travel if it existed
            if (existingTravel) {
                state.locations.unshift(existingTravel);
            }
            
            saveState();
            renderLocations();
            showToast(`‚úÖ ${data.locations.length} locations loaded`);
            
            console.log('Locations updated:', state.locations.length);
        } else {
            console.warn('Invalid response format:', data);
            renderLocations(); // Render with what we have
            showToast('‚ö†Ô∏è No locations from backend');
        }
    } catch (err) {
        console.error('Location fetch failed:', err);
        renderLocations(); // Render with what we have (at least travel tile)
        showToast('‚ö†Ô∏è Offline - using cached locations');
    }
}

// ============================================================================
// HIGH-INTEGRITY INITIALIZATION (Safety-Critical Patch)
// ============================================================================
window.onload = () => {
    // 1. Establish State Integrity with all required sub-objects
    state = loadState() || {
        currentWizStep: 1,
        worker: {},
        settings: { isAdvanced: false },
        pins: { std: '', duress: '' },
        activeVisit: null,
        pendingUploads: [],
        locations: [],
        photoStore: {},
        meta: { lastVehCheck: null, wofExpiry: null },
        vehicle: { wofExpiry: '', regoExpiry: '', lastVehCheck: null },
        visitDurationMinutes: 0 
    };

    // 2. Ensure nested objects exist in case of partial load
    if (!state.meta) state.meta = {};
    if (!state.settings) state.settings = {};
    if (!state.worker) state.worker = {};

    if (!state.deviceId) {
        state.deviceId = getDeviceID();
        saveState();
    }

    // 3. System Initialization
    updateOnlineStatus();
    checkIosInstall();
    
    if (!state.worker || !state.worker.name) {
        navigate('setup');
    } else {
        navigate(state.activeVisit ? 'locked' : 'main');
        
        // 4. UI Readiness & Button Binding
        renderLocations(); 
        setupHoldToStart(); 
        checkVehicleStatus(); 
        checkActiveNotice();
        
        if (state.activeVisit) {
            enterLockedScreen();
            if (!timerInt) timerInt = setInterval(tick, 1000);
        }

        // ====== THE CRITICAL SYNC BLOCK ======
        // Ensures registered devices pull fresh sites/templates on every launch
        const isTemplate = !CONFIG.key || CONFIG.key.includes('%%');
        if (!isTemplate && navigator.onLine) {
            forceSync(false); 
        }
    }

    // 5. Covert Safety & Interface Init
    initShakeDetection();
    initVolumeDetection();
    initSlideToWake();
    
    // 6. Panic Button Triple-Tap Security
    const btnPanic = document.getElementById('btnPanic');
    if (btnPanic) {
        btnPanic.onclick = () => {
            panicTapCount++;
            clearTimeout(panicTapTimer);
            if (panicTapCount === 3) {
                panicTapCount = 0;
                triggerPanic(false);
            } else {
                panicTapTimer = setTimeout(() => { panicTapCount = 0; }, 2000);
            }
        };
    }
    console.log("OTG Safety Engine: Robust Initialization Complete.");
    updateLastSyncUI();
    // Add to the end of window.onload
    ['mousedown', 'touchstart', 'mousemove', 'keydown'].forEach(evt => {
    window.addEventListener(evt, resetInactivityTimer, { passive: true });
});
};

// ============================================================================
// PHASE 1: SETTINGS PAGE FUNCTIONS
// ============================================================================
function populateSettingsForm() {
    if (!state || !state.worker) return;
    const s = state.worker;
    document.getElementById('setName').value = s.name || '';
    document.getElementById('setPhone').value = s.phone || '';
    document.getElementById('setEmail').value = s.email || '';
    document.getElementById('setEmgName').value = s.emgName || '';
    document.getElementById('setEmgPhone').value = s.emgPhone || '';
    document.getElementById('setEmgEmail').value = s.emgEmail || '';
    document.getElementById('setEscName').value = s.escName || '';
    document.getElementById('setEscPhone').value = s.escPhone || '';
    document.getElementById('setEscEmail').value = s.escEmail || '';
}

function saveSettings() {
    if (!state || !state.worker) return;
    
    state.worker.name = document.getElementById('setName').value.trim();
    state.worker.phone = document.getElementById('setPhone').value.trim();
    state.worker.email = document.getElementById('setEmail').value.trim();
    state.worker.emgName = document.getElementById('setEmgName').value.trim();
    state.worker.emgPhone = document.getElementById('setEmgPhone').value.trim();
    state.worker.emgEmail = document.getElementById('setEmgEmail').value.trim();
    state.worker.escName = document.getElementById('setEscName').value.trim();
    state.worker.escPhone = document.getElementById('setEscPhone').value.trim();
    state.worker.escEmail = document.getElementById('setEscEmail').value.trim();
    
    saveState();
    
    const headerName = document.getElementById('headerWorkerName');
    if (headerName) headerName.innerText = state.worker.name;
    
    showToast('‚úÖ Settings Saved');
    navigate('main');
}

function exportUserData() {
    if (!state) return;
    
    const data = {
        exportDate: new Date().toISOString(),
        worker: state.worker,
        safetyLog: state.pendingUploads || [],
        settings: state.settings
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `worker-data-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('üì§ Data Exported');
}

// ============================================================================
// UPDATED: LOCATION MANAGEMENT
// ============================================================================
function openAddLocationModal() {
    // Reset modal fields for a fresh entry
    document.getElementById('locId').value = '';
    document.getElementById('locBusiness').value = '';
    document.getElementById('locName').value = '';
    document.getElementById('locAddr').value = '';
    document.getElementById('locContactName').value = '';
    document.getElementById('locContactPhone').value = '';
    document.getElementById('locContactEmail').value = '';
    document.getElementById('locCritical').checked = false;
    
    const btnDel = document.getElementById('btnDelLoc');
    if (btnDel) btnDel.classList.add('hidden');
    
    showModal('location');
}

// Edit manual location - opens modal pre-filled
function editManualLocation(id) {
    const location = state.locations.find(x => x.id === id);
    if (!location) return;
    
    const titleEl = document.querySelector('#locationModal h2');
    if (titleEl) titleEl.textContent = 'Edit Location';
    
    document.getElementById('locId').value = id;
    document.getElementById('locBusiness').value = location.companyName || '';
    document.getElementById('locName').value = location.name || '';
    document.getElementById('locAddr').value = location.address || '';
    
    const contactName = document.getElementById('locContactName');
    const contactPhone = document.getElementById('locContactPhone');
    const contactEmail = document.getElementById('locContactEmail');
    if (contactName) contactName.value = location.contactName || '';
    if (contactPhone) contactPhone.value = location.contactPhone || '';
    if (contactEmail) contactEmail.value = location.contactEmail || '';
    
    const criticalCheckbox = document.getElementById('locCritical');
    if (criticalCheckbox) criticalCheckbox.checked = location.isCritical || false;
    
    const btnDel = document.getElementById('btnDelLoc');
    if (btnDel) btnDel.classList.remove('hidden');
    
    showModal('location');
}

// Clear forms cache and resync
function clearFormsCache() {
    if (!state) return;
    state.cachedForms = {};
    state.globalForms = [];
    saveState();
    showToast('üîÑ Clearing cache and resyncing...');
    setTimeout(() => forceSync(true), 500);
}

// Clear all app data
function clearData() {
    if (confirm('‚ö†Ô∏è WARNING: This will erase ALL app data including settings, locations, and queued uploads.\n\nAre you absolutely sure?')) {
        if (confirm('‚ö†Ô∏è FINAL WARNING: There is NO UNDO. All data will be permanently deleted.\n\nContinue?')) {
            localStorage.clear();
            showToast('üóëÔ∏è All data cleared - Reloading...');
            setTimeout(() => location.reload(), 1000);
        }
    }
}

// Update system info on settings page  
function updateSystemInfo() {
    const backendUrl = document.getElementById('setBackendUrl');
    if (backendUrl) {
        backendUrl.value = CONFIG.url || 'Not configured';
    }
    
    const backendVersion = document.getElementById('backendVersion');
    const syncStatus = document.getElementById('syncStatus');
    
    // Skip ping if key hasn't been injected by factory yet
    if (!CONFIG.key || CONFIG.key.includes('%%')) {
        if (backendVersion) {
            backendVersion.textContent = 'Pending factory injection';
            backendVersion.className = 'text-sm font-mono text-yellow-400';
        }
        if (syncStatus) {
            syncStatus.textContent = 'Template mode (needs deployment)';
            syncStatus.className = 'text-sm font-mono text-yellow-400';
        }
        return;
    }
    
    // Try to ping backend for version
    if (CONFIG.url && navigator.onLine) {
        fetch(`${CONFIG.url}?action=ping&key=${CONFIG.key}`, { 
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                if (backendVersion) {
                    backendVersion.textContent = data.version || 'v1.0';
                    backendVersion.className = 'text-sm font-mono text-green-400';
                }
                if (syncStatus) {
                    syncStatus.textContent = 'Connected ‚úì';
                    syncStatus.className = 'text-sm font-mono text-green-400';
                }
            })
            .catch(e => {
                if (backendVersion) {
                    backendVersion.textContent = 'Unknown';
                    backendVersion.className = 'text-sm font-mono text-yellow-400';
                }
                if (syncStatus) {
                    syncStatus.textContent = 'Offline';
                    syncStatus.className = 'text-sm font-mono text-red-400';
                }
            });
    } else {
        if (syncStatus) {
            syncStatus.textContent = 'No network';
            syncStatus.className = 'text-sm font-mono text-gray-400';
        }
    }
}

// ============================================================================
// PHASE 1: VEHICLE WOF COMPLIANCE SYSTEM
// ============================================================================
function checkVehicleStatus() {
    if (!state || !state.meta) return;
    
    const nagBar = document.getElementById('vehNagBar');
    if (!nagBar) return;
    
    let showNag = false;
    
    // Check last vehicle check date
    if (state.meta.lastVehCheck) {
        const lastCheck = new Date(state.meta.lastVehCheck);
        const daysSince = (Date.now() - lastCheck.getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince > 120) { // 120 days
            showNag = true;
            nagBar.innerText = '‚ö†Ô∏è Vehicle Check Overdue - Tap to Complete';
        }
    } else {
        showNag = true;
        nagBar.innerText = '‚ö†Ô∏è Vehicle Check Required';
    }
    
    // Check WOF expiry
    if (state.meta.wofExpiry) {
        const wofDate = new Date(state.meta.wofExpiry);
        const daysUntil = (wofDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24);
        
        if (daysUntil < 0) {
            // EXPIRED - block usage
            showNag = true;
            nagBar.innerText = '‚õî WOF EXPIRED - Vehicle Use Prohibited';
            nagBar.classList.add('animate-pulse');
        } else if (daysUntil < 14) {
            // Expiring soon - warn
            showNag = true;
            nagBar.innerText = `‚ö†Ô∏è Vehicle Check: WOF Due in ${Math.ceil(daysUntil)} Days`;
        }
    }
    
    if (showNag) {
        nagBar.classList.remove('hidden');
    } else {
        nagBar.classList.add('hidden');
    }
}

function startVehicleCheck() {
    isMidVisitUpdate = true; // Prevents the form from ending a visit session
    // Ensure this matches the EXACT name in your spreadsheet 'Templates' tab
    loadFormAndShow('Vehicle Safety Check'); 
}
function checkVehicleBeforeVisit() {
    if (!state || !state.meta) return false;
    
    // Check if WOF is expired
    if (state.meta.wofExpiry) {
        const wofDate = new Date(state.meta.wofExpiry);
        if (wofDate < new Date()) {
            showModal('wofBlock');
            return true; // Blocked
        }
        
        // Check if expiring within 14 days
        const daysUntil = (wofDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24);
        if (daysUntil > 0 && daysUntil < 14) {
            const wofWarnText = document.getElementById('wofWarnText');
            if (wofWarnText) {
                wofWarnText.innerText = `${Math.ceil(daysUntil)} days`;
            }
            showModal('wofWarn');
            return true; // Needs acknowledgment
        }
    }
    
    return false; // OK to proceed
}

function closeWofBlocker() {
    closeModal('wofBlock');
}

function toggleWofContinue() {
    const checkbox = document.getElementById('chkWofAck');
    const button = document.getElementById('btnWofContinue');
    if (checkbox && button) {
        if (checkbox.checked) {
            button.disabled = false;
            button.classList.remove('bg-gray-700', 'text-gray-500');
            button.classList.add('bg-blue-600', 'text-white');
        } else {
            button.disabled = true;
            button.classList.add('bg-gray-700', 'text-gray-500');
            button.classList.remove('bg-blue-600', 'text-white');
        }
    }
}

function closeWofWarn() {
    const checkbox = document.getElementById('chkWofAck');
    if (checkbox) checkbox.checked = false;
    closeModal('wofWarn');
    // Continue with visit start
}

// ============================================================================
// PHASE 1: TIME EXTENSION - PATCHED
// ============================================================================
function confirmExtension(minutes) {
    const updateTime = () => {
        // 1. Calculate new anticipated departure time
        const currentDue = state.activeVisit.anticipatedDepartureTime;
        const newDue = currentDue + (minutes * 60000);
        
        state.activeVisit.anticipatedDepartureTime = newDue;
        
        // 2. CRITICAL RESET: Re-enable safety triggers for the new duration
        state.activeVisit.isSafeConfirmed = false; 
        state.activeVisit.isPanic = false;
        state.activeVisit.criticalSent = false;
        
        // 3. Reset all warning flags so they can fire again
        state.activeVisit.warn5minSent = false;
        state.activeVisit.warn2minSent = false;
        state.activeVisit.warn90Sent = false;
        
        // 4. Update UI: Clear red alerts and pulse animations
        document.body.classList.remove('bg-red-900');
        const lockedPage = document.getElementById('lockedPage');
        if (lockedPage) lockedPage.classList.remove('panic-mode');
        
        const timerEl = document.getElementById('countdownTimer');
        if (timerEl) timerEl.classList.remove('text-red-500', 'animate-pulse');
        
        const overdueLabel = document.getElementById('overdueLabel');
        if (overdueLabel) overdueLabel.classList.add('hidden');

        saveState();
        
        // 5. Handshake: Log extension to the backend
        processUploadQueue(buildPayload({
            'Alarm Status': 'EXTENDED',
            'Notes': `Extended ${minutes}m`
        }));
        
        showToast(`‚úÖ Visit extended by ${minutes} minutes`);
        closeModal('extend');
    };
    
    const now = Date.now();
    const dueTime = state.activeVisit.anticipatedDepartureTime;
    
    // 6. Security: If already overdue or in panic, require PIN to extend
    if (dueTime < now || state.activeVisit.isPanic) {
        withPinVerification(false, updateTime);
    } else {
        updateTime();
    }
}

// ============================================================================
// PHASE 1: MID-VISIT UPDATES
// ============================================================================
function openMidVisitMenu() {
    isMidVisitUpdate = true;
    // For now, just trigger a simple note
    if (confirm('Send a mid-visit status update?')) {
        const note = prompt('Enter status update:');
        if (note) {
            logSafety('MID_VISIT_UPDATE', note);
            showToast('üìù Update sent');
        }
    }
    // TODO: Show form selection modal like WS_Safety
}

// ============================================================================
// PHASE 1: MULTIPLE WARNING LEVELS (5min, 2min, 90sec)
// ============================================================================
function playWarningSound(type) {
    if (audioReady && synth) {
        try {
            if (type === 'warning') {
                synth.triggerAttackRelease('A4', '4n');
            } else if (type === 'critical') {
                synth.triggerAttackRelease('C5', '4n');
            }
        } catch (e) {
            console.warn('Audio playback failed:', e);
        }
    }
}

function speakWarning(message) {
    if ('speechSynthesis' in window) {
        try {
            window.speechSynthesis.cancel(); // Cancel any ongoing speech
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.rate = 0.9;
            utterance.volume = 1.0;
            window.speechSynthesis.speak(utterance);
        } catch (e) {
            console.warn('Speech failed:', e);
        }
    }
}

// ============================================================================
// PHASE 1: OFFLINE BANNER
// ============================================================================
function updateOnlineStatus() {
    const banner = document.getElementById('offlineBanner');
    if (!banner) return;
    
    if (navigator.onLine) {
        banner.classList.add('hidden');
        // Try to sync pending uploads
        if (state && state.pendingUploads && state.pendingUploads.length > 0) {
            setTimeout(() => forceSync(false), 1000);
        }
    } else {
        banner.classList.remove('hidden');
    }
}

// Enhanced forceSync with online check
function forceSync(showUI) {
    // 1. GATEKEEPER: Prevent sync in template mode or if identity is missing
    if (!CONFIG.key || CONFIG.key.includes('%%')) {
        if (showUI) showToast('‚ö†Ô∏è Template mode - awaiting deployment');
        return;
    }
    
    if (!state || !state.worker || !state.worker.name) return;
    
    if (showUI) {
        const banner = document.getElementById('uploadBanner');
        if (banner) banner.classList.remove('hidden');
    }
    
    const deviceId = getDeviceID();
    const workerName = state.worker.name;
    
    fetch(`${CONFIG.url}?action=sync&worker=${encodeURIComponent(workerName)}&key=${CONFIG.key}&deviceId=${deviceId}`)
        .then(r => r.json())
        .then(data => {
            const banner = document.getElementById('uploadBanner');
            if (banner) banner.classList.add('hidden');
            
            if (data.status === "error") {
                if (showUI) alert("‚ùå Sync Error: " + (data.message || 'Unknown error'));
                return;
            }
            
            // 2. DATA MERGE: Sites, Forms, and Metadata
            const existingManual = state.locations.filter(x => x && x.id && x.id.startsWith('loc_'));
            const backendSites = (data.sites || []).map(s => ({
                id: 'site_' + s.siteName.replace(/\s/g, ''),
                name: s.siteName,
                address: s.address,
                companyName: s.company,
                templateName: s.template,
                noReport: false,
                contactName: s.contactName,
                contactPhone: s.contactPhone,
                contactEmail: s.contactEmail,
                notes: s.notes,
                isCritical: s.critical || false,
                // NEW: Capture the emergency info from the spreadsheet
                'Emergency Procedures': s.emergencyProcedures || s['Emergency Procedures'] || ''
            }));
            
            state.locations = backendSites.concat(existingManual);
            state.globalForms = data.forms || [];
            state.cachedForms = data.cachedTemplates || {};
            state.meta = data.meta || {};

            // 3. INTEGRITY: Update timestamp ONLY on verified success
            state.lastSyncTime = new Date().toISOString();
            saveState();
            renderLocations();
            checkActiveNotice();
            checkVehicleStatus();
            updateLastSyncUI(); 
            
            if (showUI) showToast('‚úÖ Sync Complete');
        })
        .catch(e => {
            // Log actual network failures for troubleshooting
            console.error('OTG Sync Failure:', e);
            const banner = document.getElementById('uploadBanner');
            if (banner) banner.classList.add('hidden');
            if (showUI) showToast('‚ùå Sync failed (Offline)');
        });
}

// Add to your scripts section
function updateLastSyncUI() {
    const label = document.getElementById('lastSyncLabel');
    if (!label || !state.lastSyncTime) return;

    const lastSync = new Date(state.lastSyncTime);
    const diffMs = Date.now() - lastSync.getTime();
    const minsOld = diffMs / (1000 * 60);
    const hoursOld = minsOld / 60;
    
    // Clear old colors
    label.classList.remove('text-green-500', 'text-gray-500', 'text-yellow-500', 'text-red-500');

    // Color code by age
    if (minsOld < 1) {
        label.classList.add('text-green-500');
        label.innerText = 'Last Sync: Just now';
    } else if (hoursOld < 24) {
        label.classList.add('text-gray-500');
        label.innerText = `Last Sync: ${Math.floor(minsOld)}m ago`;
    } else if (hoursOld < 72) {
        label.classList.add('text-yellow-500');
        label.innerText = `Last Sync: > 1 day ago`;
    } else {
        label.classList.add('text-red-500');
        label.innerText = `Last Sync: STALE (SYNC REQUIRED)`;
    }
}
    
// ============================================================================
// PHASE 2 & 3: ALL REMAINING FEATURES
// ============================================================================

// Feature 15: Battery Saver Manual Toggle
function toggleBatterySaver() {
    if (isDimmed) {
        deactivateDimMode();
        showToast('üí° Battery saver off');
    } else {
        activateDimMode();
        showToast('üåô Battery saver on');
    }
}

// Feature 14: Critical Timing Mode
function updateCriticalTimingBadge() {
    const badge = document.getElementById('highRiskBadge');
    if (!badge || !state || !state.activeVisit) return;
    
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    if (location && location.isCritical) {
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// Feature 9: Site Info Modal

// Feature 13: Location Management (Add/Edit/Delete)
function openLocationEditor(locationId) {
    const location = state.locations.find(l => l.id === locationId);
    if (!location) return;
    
    document.getElementById('locId').value = location.id;
    document.getElementById('locBusiness').value = location.companyName || '';
    document.getElementById('locName').value = location.name || '';
    document.getElementById('locAddr').value = location.address || '';
    document.getElementById('locContactName').value = location.contactName || '';
    document.getElementById('locContactPhone').value = location.contactPhone || '';
    document.getElementById('locContactEmail').value = location.contactEmail || '';
    
    const criticalCheckbox = document.getElementById('locCritical');
    if (criticalCheckbox) {
        criticalCheckbox.checked = location.isCritical || false;
    }
    
    const btnDel = document.getElementById('btnDelLoc');
    if (location.id.startsWith('loc_')) {
        if (btnDel) btnDel.classList.remove('hidden');
    } else {
        if (btnDel) btnDel.classList.add('hidden');
    }
    
    showModal('location');
}

// Ensure the "Save" button in your locationModal calls this
function saveLoc() {
    const locId = document.getElementById('locId').value;
    const name = document.getElementById('locName').value.trim();
    if (!name) { alert('Site name is required'); return; }

    const locationData = {
        id: locId || 'loc_' + Date.now(),
        name: name,
        companyName: document.getElementById('locBusiness').value.trim(),
        address: document.getElementById('locAddr').value.trim(),
        contactName: document.getElementById('locContactName').value.trim(),
        contactPhone: document.getElementById('locContactPhone').value.trim(),
        contactEmail: document.getElementById('locContactEmail').value.trim(),
        isCritical: document.getElementById('locCritical').checked
    };

    const idx = state.locations.findIndex(l => l.id === locationData.id);
    if (idx >= 0) state.locations[idx] = locationData;
    else state.locations.push(locationData);

    saveState();
    renderLocations();
    closeModal('location');
    showToast('‚úÖ Location saved');
}

function deleteLoc() {
    const locId = document.getElementById('locId').value;
    if (!locId || !confirm('Delete this location?')) return;
    
    state.locations = state.locations.filter(l => l.id !== locId);
    saveState();
    renderLocations();
    closeModal('location');
    showToast('üóëÔ∏è Location deleted');
}

function getGpsAddress() {
    if (!navigator.geolocation) {
        return showToast('GPS not available');
    }
    
    showToast('Getting GPS location...');
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            document.getElementById('locAddr').value = `${lat}, ${lon}`;
            showToast('üìç GPS location captured');
        },
        err => {
            showToast('GPS error: ' + err.message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// Feature 10: Country Code Handling
function cleanGlobalPhone(num) {
    if (!num) return "";
    let n = num.replace(/[^0-9]/g, '');
    const prefix = (CONFIG.countryPrefix || "+64").replace('+', '');
    
    if (!prefix) return "+" + n;
    if (n.startsWith(prefix)) return '+' + n;
    if (n.startsWith('0')) return '+' + prefix + n.substring(1);
    if (prefix === '1' && n.length === 10) return '+1' + n;
    return '+' + prefix + n;
}

// Feature 12: Travel/Mileage Tracking
function haversine(p1, p2) {
    const [lat1, lon1] = p1.split(',').map(Number);
    const [lat2, lon2] = p2.split(',').map(Number);
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function getDistance(p1, p2) {
    if (!p1 || !p2) return { km: 0, type: 'none' };
    
    // Try backend API if online
    if (navigator.onLine && CONFIG.url) {
        try {
            const url = `${CONFIG.url}?action=getDistance&start=${p1}&end=${p2}&key=${CONFIG.key}`;
            const response = await fetch(url, { timeout: 5000 });
            const data = await response.json();
            if (data.status === "success" && data.km) {
                return { km: data.km, type: 'road' };
            }
        } catch (e) {
            console.warn('Distance API failed, using haversine:', e);
        }
    }
    
    // Fallback to haversine
    const dist = haversine(p1, p2);
    return { km: dist.toFixed(2), type: 'crow' };
}

// Feature 16: Advanced GPS Control
function toggleAdvancedGPS(enabled) {
    if (enabled) {
        startGPSMonitoring();
        state.settings.isAdvanced = true;
        showToast('üìç Advanced GPS enabled');
    } else {
        stopGPSMonitoring();
        state.settings.isAdvanced = false;
        const gpsIndicator = document.getElementById('gpsIndicator');
        if (gpsIndicator) gpsIndicator.classList.add('hidden');
        showToast('üîã GPS throttled');
    }
    saveState();
}

// Feature 19: Voice Accent Selection
function speakWithAccent(message) {
    if (!('speechSynthesis' in window)) return;
    
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(message);
    
    // Try to find voice matching configured locale
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => v.lang.includes(CONFIG.voiceLocale || 'en-NZ'));
    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }
    
    utterance.rate = 0.9;
    utterance.volume = 1.0;
    window.speechSynthesis.speak(utterance);
}

// Feature 18: Wizard Progress Dots
function updateWizardDots() {
    for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (dot && state) {
            if (i === state.currentWizStep) {
                dot.classList.remove('bg-gray-700');
                dot.classList.add('bg-blue-500');
            } else {
                dot.classList.remove('bg-blue-500');
                dot.classList.add('bg-gray-700');
            }
        }
    }
}

// Feature 17: Android Install Banner
function triggerInstall() {
    if (deferredPrompt) {
        // Show the browser's native install dialog
        deferredPrompt.prompt();
        
        deferredPrompt.userChoice.then(choiceResult => {
            if (choiceResult.outcome === 'accepted') {
                console.log('‚úÖ User installed the app');
            }
            // Clear the prompt so it can't be used again
            deferredPrompt = null;
        });
        
        // Hide your custom banner immediately
        const banner = document.getElementById('installBanner');
        if (banner) banner.classList.add('hidden');
    }
}

function dismissInstall(type) {
    if (type === 'ios') {
        const modal = document.getElementById('iosInstallModal');
        if (modal) modal.classList.add('hidden');
    } else if (type === 'android') {
        const banner = document.getElementById('installBanner');
        if (banner) banner.classList.add('hidden');
    }
    localStorage.setItem('install_dismissed', 'true');
}

// Feature 8: Enhanced Form Builder with all field types

// ====== FEATURE 1: SHAKE-TO-ALERT (Covert Panic) ======

function initShakeDetection() {
    if (!window.DeviceMotionEvent) {
        console.warn('DeviceMotion not available');
        return;
    }
    
    window.addEventListener('devicemotion', handleShakeMotion, false);
}

function handleShakeMotion(event) {
    // Only active during visits
    if (!state || !state.activeVisit) return;
    if (shakeConfirmationMode) return; // Don't detect during confirmation
    
    const accel = event.accelerationIncludingGravity;
    if (!accel || !accel.x || !accel.y || !accel.z) return;
    
    const magnitude = Math.sqrt(
        accel.x * accel.x + 
        accel.y * accel.y + 
        accel.z * accel.z
    );
    
    const now = Date.now();
    
    // High threshold to avoid false positives (running, car, etc.)
    if (magnitude > 25) {
        // Add to buffer with timestamp
        shakeBuffer.push({ magnitude, time: now });
        lastShakeTime = now;
        
        // Clean old entries (older than 2 seconds)
        shakeBuffer = shakeBuffer.filter(s => now - s.time < 2000);
        
        // Check for 5 shakes in 2 seconds
        if (shakeBuffer.length >= 5) {
            // Check pattern consistency (deliberate shaking)
            const avgMagnitude = shakeBuffer.reduce((sum, s) => sum + s.magnitude, 0) / shakeBuffer.length;
            const variance = shakeBuffer.reduce((sum, s) => sum + Math.pow(s.magnitude - avgMagnitude, 2), 0) / shakeBuffer.length;
            
            // Low variance = consistent = deliberate
            if (variance < 100) {
                enterShakeConfirmation();
            }
            
            shakeBuffer = []; // Reset
        }
    }
}

function enterShakeConfirmation() {
    shakeConfirmationMode = true;
    shakeBuffer = [];
    
    const modal = document.getElementById('shakeConfirmModal');
    if (!modal) return;
    
    // Wake from dim if needed
    if (isDimmed) {
        deactivateDimMode();
    }
    
    // Show confirmation modal
    modal.classList.remove('hidden');
    
    // Haptic: LONG-SHORT-LONG pattern
    if (navigator.vibrate) {
        navigator.vibrate([500, 200, 100, 200, 500]);
    }
    
    // Countdown
    let countdown = 3;
    const countdownEl = document.getElementById('shakeCountdown');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = countdown;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Watch for confirmation shake
    const confirmListener = (event) => {
        const accel = event.accelerationIncludingGravity;
        if (!accel) return;
        
        const magnitude = Math.sqrt(
            accel.x * accel.x + 
            accel.y * accel.y + 
            accel.z * accel.z
        );
        
        if (magnitude > 25) {
            shakeBuffer.push(magnitude);
            
            // Need 3 shakes to confirm
            if (shakeBuffer.length >= 3) {
                window.removeEventListener('devicemotion', confirmListener);
                clearTimeout(shakeConfirmationTimeout);
                clearInterval(countdownInterval);
                confirmShakePanic();
            }
        }
    };
    
    window.addEventListener('devicemotion', confirmListener, false);
    
    // Timeout after 3 seconds
    shakeConfirmationTimeout = setTimeout(() => {
        window.removeEventListener('devicemotion', confirmListener);
        clearInterval(countdownInterval);
        cancelShakeConfirmation();
    }, 3000);
}

function confirmShakePanic() {
    shakeConfirmationMode = false;
    const modal = document.getElementById('shakeConfirmModal');
    if (modal) modal.classList.add('hidden');
    
    // Success feedback
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
    
    showToast('üö® Covert alert sent', 2000);
    
    // Trigger duress panic (all panic alerts go through same PIN verification)
    triggerPanic(true); // Duress mode
}

function cancelShakeConfirmation() {
    shakeConfirmationMode = false;
    shakeBuffer = [];
    
    const modal = document.getElementById('shakeConfirmModal');
    if (modal) modal.classList.add('hidden');
}

// ====== FEATURE 2: VOLUME BUTTON PANIC (Android) ======

function initVolumeDetection() {
    document.addEventListener('keydown', handleVolumePress, false);
}

function handleVolumePress(event) {
    // Only active during visits
    if (!state || !state.activeVisit) return;
    if (volumeConfirmationMode) return;
    
    // Volume up or down
    if (event.key === 'VolumeUp' || event.key === 'VolumeDown' || 
        event.keyCode === 175 || event.keyCode === 174) { // Fallback keycodes
        
        event.preventDefault(); // Try to suppress volume change
        
        const now = Date.now();
        volumeBuffer.push(now);
        
        // Keep only recent presses (within 3 seconds)
        volumeBuffer = volumeBuffer.filter(t => now - t < 3000);
        
        // Check for 5 presses
        if (volumeBuffer.length >= 5) {
            volumeBuffer = [];
            enterVolumeConfirmation();
        }
    }
}

function enterVolumeConfirmation() {
    volumeConfirmationMode = true;
    volumeBuffer = [];
    
    const modal = document.getElementById('volumeConfirmModal');
    if (!modal) return;
    
    // Wake from dim if needed
    if (isDimmed) {
        deactivateDimMode();
    }
    
    // Show confirmation modal
    modal.classList.remove('hidden');
    
    // Haptic feedback
    if (navigator.vibrate) {
        navigator.vibrate([300, 100, 300]);
    }
    
    // Countdown
    let countdown = 3;
    const countdownEl = document.getElementById('volumeCountdown');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = countdown;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Watch for confirmation
    const confirmListener = (event) => {
        if (event.key === 'VolumeUp' || event.key === 'VolumeDown' || 
            event.keyCode === 175 || event.keyCode === 174) {
            
            event.preventDefault();
            volumeBuffer.push(Date.now());
            
            // Need 3 more presses to confirm
            if (volumeBuffer.length >= 3) {
                document.removeEventListener('keydown', confirmListener);
                clearTimeout(volumeConfirmationTimeout);
                clearInterval(countdownInterval);
                confirmVolumePanic();
            }
        }
    };
    
    document.addEventListener('keydown', confirmListener, false);
    
    // Timeout after 3 seconds
    volumeConfirmationTimeout = setTimeout(() => {
        document.removeEventListener('keydown', confirmListener);
        clearInterval(countdownInterval);
        cancelVolumeConfirmation();
    }, 3000);
}

function confirmVolumePanic() {
    volumeConfirmationMode = false;
    const modal = document.getElementById('volumeConfirmModal');
    if (modal) modal.classList.add('hidden');
    
    // Success feedback
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
    
    showToast('üö® Volume panic alert sent', 2000);
    
    // Trigger panic (goes through same PIN verification)
    triggerPanic(false); // Standard panic, not duress
}

function cancelVolumeConfirmation() {
    volumeConfirmationMode = false;
    volumeBuffer = [];
    
    const modal = document.getElementById('volumeConfirmModal');
    if (modal) modal.classList.add('hidden');
}

// ====== FEATURE 3: SLIDE-TO-WAKE (Hold-to-Slide) ======

function initSlideToWake() {
    const slideButton = document.getElementById('slideButton');
    const slideTrack = document.getElementById('slideTrack');
    const slideProgress = document.getElementById('slideProgress');
    const slideText = document.getElementById('slideText');
    if (!slideButton || !slideTrack) return;

    let maxSlide = 0; 
    let currentX = 0; 

    const getX = (e) => e.touches ? e.touches[0].clientX : e.clientX;

    const start = (e) => {
        isSliding = true;
        slideStartX = getX(e);
        slideButton.style.transition = 'none';
        slideProgress.style.transition = 'none';
        if (!e.touches) e.preventDefault();
    };

    const move = (e) => {
        if (!isSliding) return;
        const trackWidth = slideTrack.offsetWidth;
        const buttonWidth = slideButton.offsetWidth;
        maxSlide = trackWidth - buttonWidth - 8;
        
        const deltaX = getX(e) - slideStartX;
        currentX = Math.max(0, Math.min(deltaX, maxSlide));

        slideButton.style.transform = `translateX(${currentX}px)`;
        const progress = (currentX / maxSlide) * 100;
        slideProgress.style.width = `${progress}%`;
        
        if (progress > 90) completeSlide();
    };

    const end = () => {
        if (!isSliding) return;
        isSliding = false;
        slideButton.style.transition = 'transform 0.3s ease';
        slideButton.style.transform = 'translateX(0)';
        slideProgress.style.width = '0%';
        if (slideText) slideText.style.opacity = '1';
    };

    slideButton.addEventListener('touchstart', start, { passive: false });
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', end);
    slideButton.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    // NESTED: completeSlide must be inside to access maxSlide
    function completeSlide() {
        isSliding = false;
        slideButton.style.transition = 'transform 0.2s ease-out';
        slideProgress.style.transition = 'width 0.2s ease-out, opacity 0.2s ease-out';
        slideButton.style.transform = `translateX(${maxSlide}px)`;
        slideProgress.style.width = '100%';
        slideProgress.style.opacity = '1';
        
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        
        setTimeout(() => {
            deactivateDimMode();
            resetInactivityTimer();
            isSosLocked = true;
            setTimeout(() => { isSosLocked = false; }, 2000);
            
            slideButton.style.transition = 'none';
            slideButton.style.transform = 'translateX(0)';
            slideProgress.style.width = '0%';
            slideProgress.style.opacity = '0.4';
            if (slideText) slideText.style.opacity = '1';
            currentX = 0;
        }, 200);
    }
} // FIXED: Removed extra orphaned brace
    
// Update dimmed screen timer and battery
function updateDimmedDisplay() {
    if (!isDimmed || !state || !state.activeVisit) return;
    
    // Update timer
    const dimmedTimer = document.getElementById('dimmedTimer');
    if (dimmedTimer) {
        const elapsed = Math.floor((Date.now() - state.activeVisit.startTime) / 1000);
        const remaining = state.activeVisit.duration - elapsed;
        const mins = Math.floor(Math.abs(remaining) / 60);
        const secs = Math.abs(remaining) % 60;
        const sign = remaining < 0 ? '-' : '';
        dimmedTimer.textContent = `${sign}${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update battery
    const dimmedBattery = document.getElementById('dimmedBattery');
    if (dimmedBattery && currentBatteryLevel) {
        dimmedBattery.textContent = currentBatteryLevel.replace('%', '');
    }
}

setInterval(updateDimmedDisplay, 1000);

// ====== FEATURE 4: WAKE LOCK API ======

async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock released');
                wakeLock = null;
            });
            
            console.log('‚úÖ Wake Lock active - phone will not auto-lock');
        } catch (err) {
            console.error('Wake Lock error:', err);
        }
    } else {
        console.warn('Wake Lock API not supported');
    }
}

function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Wake Lock released');
    }
}

// Release wake lock when visit ends
function exitLockedScreen() {
    releaseWakeLock();
}

    function checkWizPinMatch() {
    const pin = document.getElementById('wizPin').value;
    const pinConf = document.getElementById('wizPinConfirm').value;
    const dur = document.getElementById('wizDuress').value;
    const durConf = document.getElementById('wizDuressConfirm').value;
    const btnNext = document.getElementById('btnWizNext');
    const err = document.getElementById('pinMatchError');

    const pinsMatch = (pin === pinConf && pin !== '') && (dur === durConf && dur !== '');
    
    if (pinsMatch) {
        btnNext.disabled = false;
        btnNext.classList.remove('opacity-50');
        err.classList.add('hidden');
    } else {
        btnNext.disabled = true;
        btnNext.classList.add('opacity-50');
        if (pinConf !== '' || durConf !== '') err.classList.remove('hidden');
    }
}

/**
 * FULL INTEGRATED PATCH: Site Info & Emergency Procedure Routing
 * Ensures workers can either view existing data or immediately update missing info.
 */
/**
 * FULL INTEGRATED PATCH: Site Info & Context-Aware Procedure Submission
 * Ensures workers can view existing info or submit new info linked to this specific site.
 */
function populateSiteInfoModal(location) {
    const content = document.getElementById('siteInfoContent');
    if (!content) return;

    // 1. Build Header & Basic Site Details
    let html = `<div class="space-y-4">
        <div>
            <label class="text-[10px] text-blue-400 font-black uppercase tracking-widest">Site Name</label>
            <div class="text-lg font-bold text-white">${location.name}</div>
        </div>`;

    if (location.companyName) html += `<div><label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Company</label><div class="text-white">${location.companyName}</div></div>`;
    if (location.address) html += `<div><label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Address</label><div class="text-white">${location.address}</div></div>`;
    
    // 2. EMERGENCY INFO LOGIC: View existing or trigger context-aware submission
    if (location['Emergency Procedures']) {
        html += `<div class="pt-2">
            <button onclick="viewEmergencyProcedures('${location['Emergency Procedures']}')" 
                    class="w-full py-4 bg-red-600 text-white font-black rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                üö® VIEW EMERGENCY PROCEDURES
            </button>
        </div>`;
    } else {
        // Logic: Redirect to submission form and pass site identity as context for backend matching
        const contextObj = JSON.stringify({ siteName: location.name, companyName: location.companyName || "" }).replace(/"/g, '&quot;');        
        html += `<div class="pt-2">
            <button onclick="closeModal('info'); loadFormAndShow('Update Site Procedures', ${contextObj})" 
                    class="w-full py-4 bg-gray-800 border-2 border-dashed border-gray-600 text-gray-400 font-bold rounded-2xl flex flex-col items-center justify-center gap-1 active:bg-gray-700 active:scale-95 transition-all">
                <span class="text-[9px] uppercase tracking-widest opacity-60">No Emergency Info Found</span>
                <span class="text-[10px] text-blue-400 font-black uppercase">Click to Submit Procedures</span>
            </button>
        </div>`;
    }

    if (location.contactName || location.contactPhone) {
        html += `<div class="pt-2 border-t border-gray-700">
            <label class="text-[10px] text-red-400 font-black uppercase tracking-widest">Contact</label>
            <div class="text-white font-bold">${location.contactName || 'Primary Contact'}</div>
            ${location.contactPhone ? `<div class="text-gray-400 text-xs">${location.contactPhone}</div>` : ''}
        </div>`;
    }

    if (location.notes) {
        html += `<div class="p-3 bg-blue-900/10 rounded-xl border border-blue-500/20 mt-2">
            <label class="text-[10px] text-blue-400 font-black uppercase tracking-widest mb-1 block">Notes</label>
            <div class="text-xs text-gray-300 italic">${location.notes}</div>
        </div>`;
    }

    html += `</div>`;
    content.innerHTML = html;

    // 3. Configure Action Buttons (Call, Email, Navigation)
    const btnCall = document.getElementById('btnSiteCall');
    const btnEmail = document.getElementById('btnSiteEmail');
    const btnNav = document.getElementById('btnSiteNav');

    if (location.contactPhone && btnCall) {
        btnCall.href = `tel:${cleanGlobalPhone(location.contactPhone)}`;
        btnCall.classList.remove('hidden');
    } else if (btnCall) btnCall.classList.add('hidden');

    if (location.contactEmail && btnEmail) {
        btnEmail.href = `mailto:${location.contactEmail}`;
        btnEmail.classList.remove('hidden');
    } else if (btnEmail) btnEmail.classList.add('hidden');

    if (location.address && btnNav) {
        const encodedAddr = encodeURIComponent(location.address);
        // FIXED: Corrected template literal syntax for navigation
        btnNav.href = `https://www.google.com/maps/search/?api=1&query=${encodedAddr}`;
        btnNav.classList.remove('hidden');
    } else if (btnNav) {
        btnNav.classList.add('hidden');
    }
}

// Global function to trigger info from a tile
function showSiteInfo(locationId, event) {
    if (event) event.stopPropagation(); // Prevents selecting the tile
    const location = state.locations.find(l => l.id === locationId);
    if (location) {
        populateSiteInfoModal(location);
        showModal('info');
    }
}

// Fixed existing Locked Screen info trigger
function showCurrentSiteInfo() {
    if (!state || !state.activeVisit) return;
    const location = state.locations.find(l => l.id === state.activeVisit.locationId);
    if (location) {
        populateSiteInfoModal(location);
        showModal('info');
    }
}

/**
 * MISSING SECURITY COMPONENT: PIN Verification Engine
 */
function withPinVerification(isDuress, successCallback) {
    showModal('pin');
    const input = document.getElementById('pinInput');
    const confirmBtn = document.getElementById('btnPinConfirm');
    input.value = '';
    input.focus();

    confirmBtn.onclick = () => {
        const entered = input.value;
        const correctStd = state.pins.std;
        const correctDur = state.pins.duress;

        if (entered === correctStd) {
            closeModal('pin');
            successCallback();
        } else if (entered === correctDur) {
            closeModal('pin');
            triggerPanic(true); // Silent Duress
            successCallback();
        } else {
            showToast('‚ùå Incorrect PIN');
            input.value = '';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }
    };
}

    /**
 * REFINED NOTICE ENGINE
 */
function checkActiveNotice() {
    if (!state.meta || !state.meta.activeNotice) return;
    
    const notice = state.meta.activeNotice;
    const ackList = JSON.parse(localStorage.getItem('otg_acknowledged_notices') || '[]');
    
    if (ackList.includes(notice.id)) return;

    const modal = document.getElementById('noticeModal');
    const title = document.getElementById('noticeTitle');
    const content = document.getElementById('noticeContent');
    const card = document.getElementById('noticeCard');
    const icon = document.getElementById('noticeIcon');

    title.innerText = notice.title;
    content.innerText = notice.content;

    // Apply priority styling
    card.classList.remove('border-blue-600', 'border-orange-500', 'border-red-600');
    if (notice.priority === 'Critical') {
        card.classList.add('border-red-600');
        icon.innerText = 'üö®';
    } else if (notice.priority === 'Urgent') {
        card.classList.add('border-orange-500');
        icon.innerText = '‚ö†Ô∏è';
    } else {
        card.classList.add('border-blue-600');
        icon.innerText = 'üì¢';
    }

    modal.classList.remove('hidden');
}

/**
 * UPDATED: acknowledgeNotice
 * Logic: Logs the ID to the backend for recording in Column I.
 */
function acknowledgeNotice() {
    const notice = state.meta.activeNotice;
    if (!notice) return;

    const ackList = JSON.parse(localStorage.getItem('otg_acknowledged_notices') || '[]');
    ackList.push(notice.id);
    localStorage.setItem('otg_acknowledged_notices', JSON.stringify(ackList));

    // LOG TO BACKEND: Updates Column I in the Notices Tab
    const payload = buildPayload({
        "action": "acknowledgeNotice",
        "noticeId": notice.id,
        "Alarm Status": "NOTICE_ACKNOWLEDGED",
        "Notes": `Confirmed: ${notice.title}`
    });
    processUploadQueue(payload);

    closeModal('notice');
    showToast('‚úÖ Acknowledgment Saved');
}
    
/**
 * PATCHED: Procedure Viewer
 * Handles multiple comma-separated Drive links with mobile-safe opening.
 */
function viewEmergencyProcedures(linksString) {
    if (!linksString) {
        showToast("‚ö†Ô∏è No procedures linked to this site");
        return;
    }

    // 1. Split the comma-separated string from index 9
    const links = linksString.split(',').map(l => l.trim()).filter(l => l !== "");
    
    if (links.length === 0) return;

    // 2. Mobile-Safe Multi-Link Handling
    if (links.length === 1) {
        window.open(links[0], '_blank');
    } else {
        // Provide feedback if opening multiple tabs
        showToast(`Opening ${links.length} procedure pages...`);
        
        links.forEach((url, index) => {
            // Logic: Stagger the opens to prevent browser 'spam' blockers
            setTimeout(() => {
                window.open(url, '_blank');
            }, index * 600); 
        });
    }
}

/**
 * HUB NAVIGATION & RENDERING
 */
function openResourceHub() {
    renderResources();
    showModal('resourceHub');
}

function switchHubTab(tab) {
    const isRes = tab === 'res';
    document.getElementById('tabRes').className = isRes ? 'pb-2 text-xs font-black uppercase tracking-widest text-blue-500 border-b-2 border-blue-500' : 'pb-2 text-xs font-black uppercase tracking-widest text-gray-500';
    document.getElementById('tabNot').className = !isRes ? 'pb-2 text-xs font-black uppercase tracking-widest text-blue-500 border-b-2 border-blue-500' : 'pb-2 text-xs font-black uppercase tracking-widest text-gray-500';
    
    if (isRes) renderResources();
    else renderNoticeArchive();
}

function renderResources() {
    const container = document.getElementById('hubContent');
    const items = state.meta.resources || [];
    container.innerHTML = items.length ? items.map(r => `
        <div class="p-4 bg-white/5 border border-white/5 rounded-2xl active:scale-95 transition" onclick="window.open('${r.url}', '_blank')">
            <div class="text-[10px] text-blue-400 font-black uppercase tracking-widest mb-1">${r.category}</div>
            <div class="text-sm font-bold text-white">${r.title}</div>
            <div class="text-[9px] text-gray-500 mt-2 uppercase font-black">Open ${r.type} ‚Üó</div>
        </div>
    `).join('') : '<p class="text-center text-xs opacity-40 py-10">No resources assigned.</p>';
}

function renderNoticeArchive() {
    const container = document.getElementById('hubContent');
    const items = state.meta.noticeHistory || [];
    container.innerHTML = items.length ? items.map(n => `
        <div class="p-4 bg-white/5 border border-white/5 rounded-2xl opacity-60">
            <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest mb-1">${new Date(n.date).toLocaleDateString()}</div>
            <div class="text-sm font-bold text-white mb-1">${n.title}</div>
            <div class="text-xs text-gray-400 leading-snug">${n.content}</div>
        </div>
    `).join('') : '<p class="text-center text-xs opacity-40 py-10">Archive empty.</p>';
}
    
</script>

</body>
</html>


