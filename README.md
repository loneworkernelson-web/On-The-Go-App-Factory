# OTG AppSuite: Serverless Lone Worker Safety System
### Version 35.4 (Pulse, Map & Smart Scribe Edition)

**OTG AppSuite** is a professional-grade, privacy-focused safety system designed for Non-Profits, NGOs, and community organizations. It provides robust lone worker monitoring, automated safety escalation, and digital reporting without monthly subscription fees.

---

## üöÄ Key Features

### For the Worker (PWA)
* **Simple "Two-Tap" Start:** Select a location, set a duration, and go.
* **Smart Safety:** Triple-tap Panic button, "Smart PIN" (Duress vs. Safe), and battery level monitoring.
* **Travelling Pulse:** While in "Travelling" mode, the app keeps the screen awake (dimmed) and sends a background GPS heartbeat every 5 minutes.
* **Smart Mileage:** Automatic road distance calculation (via OpenRouteService) with a graceful "Crow Flies" fallback if offline (auto-noted in report).
* **Flexible Extensions:** Long-press "Extend Time" to choose +10m, +15m, or +30m. No PIN required unless the worker is already Overdue.
* **Offline Honesty:** Clearly distinguishes between "Sent" (Online) and "Saved to Outbox" (Offline).

### For the Office (Monitor Dashboard)
* **Command Center:** Live dashboard with "Grid View" and "Map View" (Leaflet.js) with auto-removing pins upon departure.
* **Server-Side Watchdog:** If a worker's phone is destroyed or loses battery, the *server* triggers the alarm when they are overdue.
* **Visual & Audio Alarms:** Flashing red tiles and siren audio for emergencies.
* **Connection Watchdog:** Detects if the internet drops or the browser "sleeps" the audio engine, alerting the operator immediately.

### For Administration (Backend)
* **Zero Cost:** Runs entirely on Google Sheets & Google Apps Script (Free Tier).
* **Smart Scribe:** AI-powered grammar and spelling correction for reports (using Gemini), applied only to the PDF output to preserve the raw data audit trail.
* **One-Click Setup:** Auto-generates the Google Doc Report Template and links it to the system.

---

## üõ†Ô∏è Deployment Guide (No Coding Required)

**Prerequisites:**
* A Google Account (Gmail or Workspace).
* A computer (PC or Mac).
* ~15 minutes.

### Phase 1: Use the "Factory"
We do not ask you to write code. We provide a **Factory Tool** (`index.html`) that writes the code for you.

1.  **Open the Factory:** Double-click the `index.html` file provided in this repository.
2.  **Step 1 - Configuration:**
    * **Org Name:** Enter your organization's name.
    * **Secret Key:** Create a password. **Write this down.** It protects your database.
    * **API Keys (Optional):** OpenRouteService (Mileage), Gemini (Grammar), Textbelt (SMS).
3.  **Step 2 - The Spreadsheet:**
    * Click to create a **New Google Sheet**. Rename it **"Safety System"**.
    * Rename the tab to **"Visits"**. Copy/Paste the headers from the Factory.
    * Create a **"Checklists"** tab and Copy/Paste the template structure.
    * *(Optional)* Create an **"AI Reporting"** tab and Copy/Paste the generated Prompt Guide for custom analytics.
4.  **Step 3 - The Backend:**
    * Open **Extensions > Apps Script** in your Sheet.
    * Paste the code generated by the Factory.
    * **Deploy:** New Deployment -> Web App -> Execute as "Me" -> Access "Anyone".
    * **Run Setup:** Copy the Web App URL into the Factory. Click **"ü™Ñ Auto-Generate PDF Template"** to create your report format automatically.
5.  **Step 4 - Automation:**
    * Add Triggers in Apps Script:
        * `checkOverdueVisits` (Every 10 mins).
        * `archiveOldData` (Weekly).
6.  **Step 5 - Download:**
    * Click **Download AppSuite.zip**. This contains your custom Worker App and Monitor Dashboard.

### Phase 2: Going Live
1.  **Hosting:** Drag and drop the `WorkerApp` folder into [Netlify Drop](https://app.netlify.com/drop) to get a secure link.
2.  **Monitor:** Repeat for the `MonitorApp` folder.

---

## ü§ñ Master Technical Specification
*For AI Agents or Developers recreating/modifying the system.*

### 1. Architecture
* **Pattern:** Serverless PWA with Google Apps Script Backend.
* **Write Protocol:** `POST` (mode: `no-cors`). Frontend "fire-and-forgets" data to Google Sheets.
* **Read Protocol:** `JSONP`. Monitor polls backend via callback function to bypass CORS on GET requests.
* **Caching:** Factory generates a `sw.js` with a unique timestamp to force "Cache Busting" on every new build, preventing "Sticky Version" issues.

### 2. Backend Logic (`backend_template.js`)
* **Smart De-duplication:** On `doPost`, scan last 50 rows. If `Worker Name` matches an active row (Status != DEPARTED), **UPDATE** that row. Else, **APPEND**.
* **Smart Scribe:** Use `UrlFetchApp` to call Gemini API. Prompt: *"Correct grammar/spelling to NZ English."* Apply only to Report Output (PDF/Email), never to raw DB data.
* **Auto-Setup:** `setupReportTemplate()` function creates a Google Doc, injects placeholders (`{{Notes}}`), and saves the ID to Script Properties.

### 3. Worker App Logic (`worker_template.html`)
* **Smart Mileage:** On `preDepart`, call OpenRouteService. If fail/offline, fallback to Haversine. If fallback used, inject note: *"‚ö†Ô∏è As-the-crow-flies calculation only."*
* **Travelling Pulse:** If Location ID is `travel`, requesting `wakeLock` and starting a 5-minute interval timer to send silent GPS updates to the backend.
* **Extend Logic:** "Extend Time" button requires **Long Press**. Opens Modal (+10m, +15m, +30m). PIN required *only* if status is `OVERDUE` or `PANIC`.
* **Check-in Logic:** "I am OK" button requires **Long Press** to prevent accidental confirmation.
* **Departure:** Button labeled **"HOLD TO END"**. Submitting report requires **"Submit & END"** (Long Press).
* **Feedback:** Explicitly differentiate between "Sent" (Online) and "Saved to Outbox" (Offline).

### 4. Monitor App Logic (`monitor_template.html`)
* **Connection Watchdog:** If JSONP poll fails 3 times (30s), show "CONNECTION LOST" banner and play distinct Fault Sound.
* **Audio Heartbeat:** Check `Tone.context.state` every 2s. If `suspended`, show Red Banner overlay.
* **Local Escalation:** If `Current Time - Due Time > 15 mins`, force Status to `EMERGENCY` visually/audibly, even if Server Watchdog hasn't updated the sheet yet.
* **Map Garbage Collection:** If Status becomes `DEPARTED` or `SAFE`, immediately remove the Leaflet Pin from the map.
* **Acknowledge:** "HOLD TO ACKNOWLEDGE" button silences audio but keeps Tile/Pin Red & Flashing.
* **Resolution:** Operator must type Worker Name exactly to clear the alarm.

### 5. Data Dictionary
The system relies on a specific 25-column structure in the 'Visits' tab.

| Col | Header | Description |
| :-- | :--- | :--- |
| **A** | Timestamp | Server-side receipt time. |
| **C** | Worker Name | **Primary Key**. |
| **K** | **Alarm Status** | The State Machine. |
| **M** | Location Name | Site visited. |
| **O** | Last Known GPS | `Lat,Lon`. |
| **Q** | **Battery Level** | e.g. "84%". |
| **S** | Distance (km) | ORS or Haversine result. |
| **T** | Visit Report Data | JSON string of form answers. |
| **U** | **Anticipated Departure**| ISO String. Watchdog target. |

---

## üìù Reporting (AI Prompt Recipes)
To generate custom reports (e.g., Mileage, Timesheets), create a new tab in your sheet named **"AI Reporting"** and paste the guide generated by the Factory tool.

**Crucial Note for Long-Term Reports:**
Data older than 30 days is moved to the **'Archive'** tab. When asking an AI for annual reports, you must explicitly instruct it to: *"Read data from BOTH the 'Visits' tab and the 'Archive' tab."*

---

## ‚ö†Ô∏è Security Warning
The **Secret Key** set in the Factory is the only barrier between the internet and your database. **Do not share it.** If compromised, regenerate the backend script and redeploy.
