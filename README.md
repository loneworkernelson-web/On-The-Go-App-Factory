Here are the updated, comprehensive specifications for the **On-The-Go (OTG) AppSuite v68.19**. This document reflects the final, stable state of the system, including all security patches, logic fixes (GPS, Photos, Mileage), and architectural changes (Server-side Geocoding, Two-Key Authentication).

---

# ðŸ’Ž On-The-Go (OTG) AppSuite: Technical Specifications

**Version:** 68.19 (Diamond Edition)
**Date:** December 18, 2025
**Philosophy:** "High Safety, Zero Cost" â€” Serverless, Privacy-First, Offline-Capable.

---

## 1. System Architecture

The OTG AppSuite is a serverless distributed system that uses **Google Sheets** as a database and **Google Apps Script** as an API Gateway. It consists of three decoupled frontend applications and one backend "Brain."

### Core Components

1. **Factory App (The Builder):** A local HTML tool that generates the deployed apps. It injects configuration data and cryptographic keys into the templates.
2. **Worker App (The Field Tool):** A Progressive Web App (PWA) installed on staff phones. It handles GPS tracking, safety timers, check-ins, and report submission.
3. **Monitor App (The Dashboard):** A secure dashboard for HQ. It polls the backend for real-time status, visualizes worker locations, and handles emergency acknowledgments.
4. **Backend (The Brain):** A Google Apps Script deployment that validates requests, manages the Google Sheet database, sends email/SMS alerts, and performs geocoding.

### Security Model (Dual-Key System)

* **Master Key (High Privilege):** Used by the Monitor App and Admin. Allows reading all data and resolving alerts.
* **Worker Key (Low Privilege):** Auto-generated by the Factory. Hardcoded into Worker Apps. Allows writing data (check-ins) but restricts reading to only the worker's own configuration.
* **Device Fingerprinting:** The system locks a worker account to a specific browser/device UUID upon first login. Admin reset required to change devices.

---

## 2. Component Specifications

### A. The Factory App (`index.html`)

* **Version:** v68.9.3
* **Role:** Configuration Wizard & Build Engine.
* **Input:** Organization Name, Secret Key, Logo URL, Google Web App URL.
* **Key Feature:** **Split Injection Logic**.
* Generates a random `WORKER_KEY` during the build process.
* Injects `WORKER_KEY` into the Worker App template.
* Injects `MASTER_KEY` into the Monitor App template.
* Injects **BOTH** keys into the Backend code so it can validate everyone.


* **Output:** A `Diamond.zip` file containing the configured apps ready for Netlify/GitHub hosting.

### B. The Worker App (`WorkerApp/index.html`)

* **Version:** v68.18
* **Type:** Progressive Web App (PWA) with Offline Support.
* **Core Features:**
* **GPS Tracking:** Captures GPS on "Start Visit," "Update," "Panic," and "End Visit."
* **Safety Timers:** Local countdown timer. Triggers "Overdue" alert if not extended or ended.
* **Mileage Calculator:** Auto-calculates distance between "Start GPS" and "End GPS" using Haversine (Crow flies) or OpenRouteService (Road) if configured.
* **Smart Forms:** Dynamic form renderer (Text, Photo, Yes/No, Signature).
* *Fix v68.17:* Calculated distance is only auto-filled into fields explicitly named "Distance", "KM", or "Mileage".


* **Photo Engine:** Client-side compression (max 600px width) before upload to save bandwidth/storage.
* **Geocoding:** Uses `action=geocode` to ask the Backend to convert GPS coords to a street address.
* **Offline Mode:** Queues all requests (`localStorage`) and attempts to sync when connectivity returns.



### C. The Monitor App (`MonitorApp/index.html`)

* **Version:** v68.15
* **Type:** Single Page Application (SPA) Dashboard.
* **Core Features:**
* **Real-Time Polling:** Fetches status every 10 seconds.
* **Audio Alerts:** Looping siren sound for "EMERGENCY" or "PANIC" states. Distinct sound for "DURESS" (Silent Alarm).
* **Visual Modes:**
* **Grid View:** Cards sorted by urgency (Emergency > Overdue > Active > Safe).
* **Map View:** Leaflet.js map showing worker locations. Color-coded markers.


* **Manual Resolution:** Allows HQ to clear an alarm with a logged note if the worker cannot do it themselves.
* **Security:** Requires `MASTER_KEY` to load data.



### D. The Backend (`Backend/Code.gs`)

* **Version:** v68.19
* **Type:** Google Apps Script Web App.
* **Core Capabilities:**
* **API Gateway:** Handles `doGet` and `doPost` requests.
* **Smart Routing:**
* `action=sync`: Validates Worker Key, returns Site List & Forms.
* `action=geocode`: Proxies Google Maps Geocoding API (Server-side) to bypass client CORS.
* `callback=...`: JSONP response for the Monitor App.


* **Database Management:** Writes to 'Visits' sheet. Handles row updates (updating an existing visit rather than creating duplicates).
* *Fix v68.16:* Explicitly writes `Photo 1-4` and `Signature` columns during updates.


* **Watchdog (Time-Triggered):** Runs every 10-15 minutes. Scans active visits. If `Current Time > Due Time + Escalation Buffer`, it auto-escalates status to "EMERGENCY - OVERDUE" and emails/SMS the contacts.
* **Reporting Engine:** "Smart Linking" detects GPS coordinates in report text and converts them to clickable Google Maps links in email notifications.



---

## 3. Data Dictionary (Google Sheets)

### Tab 1: `Visits` (Transactional Data)

| Col | Header | Description |
| --- | --- | --- |
| A | Timestamp | Server time of entry. |
| B | Date | Formatted Date (YYYY-MM-DD). |
| C | Worker Name | Unique ID for the worker. |
| K | Alarm Status | `ON SITE`, `DEPARTED`, `OVERDUE`, `EMERGENCY`, `PANIC`, `TRAVELLING`. |
| L | Notes | Running log of notes/updates. |
| M | Location Name | Site Name or "Travelling". |
| O | Last Known GPS | Lat,Lon coordinates. |
| P | GPS Timestamp | Time the GPS fix was taken. |
| Q | Battery Level | Phone battery % (e.g., "85%"). |
| T | Visit Report Data | JSON string of form answers. |
| U | Anticipated Departure | ISO timestamp of when the visit *should* end. |
| V-Y | Photos/Signature | Google Drive Links to uploaded assets. |

### Tab 2: `Staff` (Access Control)

* **Name:** Must match Worker App input exactly.
* **Status:** "Active" or "Inactive".
* **DeviceID:** Auto-filled on first login. Locks the account. Clear this cell to reset access.
* **WOFExpiry:** Date of Warrant of Fitness expiry (auto-updated by Vehicle Checks).

### Tab 3: `Sites` (Configuration)

* **Assigned To:** Worker Name or "ALL".
* **Template Name:** Which form to load for this site.
* **Address/GPS:** Used for navigation buttons in the app.

### Tab 4: `Templates` (Form Builder)

* **Type:** `REPORT` (Standard) or `FORM` (Ad-hoc).
* **Questions:** Columns E-Z define the form fields using tags:
* `[TEXT]`, `[NUMBER]`, `[YESNO]`, `[PHOTO]`, `[GPS]`, `[SIGN]`.



---

## 4. Workflows

### 1. The "Start Visit" Flow

1. Worker selects a location.
2. Worker sets duration (e.g., 60 mins).
3. App captures GPS (including `action=geocode` lookup).
4. App sends payload to Backend: `Status: ON SITE`, `Due: Now + 60m`.
5. Backend creates a new row in `Visits`.

### 2. The "Safety Check" Flow

1. Backend Watchdog runs every 10 mins.
2. Checks `Visits` rows where status is NOT `DEPARTED`.
3. If `Now > Anticipated Departure + 15 mins`:
* Update Status to `EMERGENCY - OVERDUE`.
* Send Email to Manager & Emergency Contact.
* Send SMS (via TextBelt) if configured.



### 3. The "Panic" Flow

1. Worker taps "SOS" 3 times.
2. App overrides screen to Red.
3. App captures GPS immediately.
4. App sends payload: `Status: EMERGENCY - PANIC BUTTON`.
5. Monitor App flashes Red and plays Siren.
6. Backend sends immediate high-priority alerts.

### 4. The "Report & Depart" Flow

1. Worker taps "Hold to End".
2. App calculates distance (Start GPS vs Current GPS).
3. App loads the assigned Form Template.
4. App pre-fills "Distance" field if present.
5. Worker fills form, takes photos, signs.
6. App uploads data.
7. Backend **updates the existing row** with Report Data, Photos, and changes Status to `DEPARTED`.
8. Backend converts GPS text in report to Map Links.
9. Backend emails the PDF report to the configured recipient.
