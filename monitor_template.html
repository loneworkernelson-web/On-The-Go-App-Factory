<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>%%ORG_NAME%% Monitor</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
body{font-family:'Inter',sans-serif}
@keyframes flash-red{0%,100%{background:#7f1d1d}50%{background:#ef4444}}
@keyframes flash-purple{0%,100%{background:#581c87}50%{background:#a855f7}}
.flashing-alert{animation:flash-red 1s infinite}
.flashing-duress{animation:flash-purple 1s infinite}
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #1f2937; }
::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
</style>
</head>
<body class="bg-gray-900 text-white h-full flex flex-col overflow-hidden">

<div id="setupPage" class="h-full flex items-center justify-center p-4 z-50 bg-gray-900 absolute inset-0">
  <div class="text-center space-y-6 max-w-md w-full bg-gray-800 p-10 rounded-2xl shadow-2xl border border-gray-700">
    <div>
        <img src="%%LOGO_URL%%" class="h-20 mx-auto mb-4 object-contain">
        <h1 class="text-3xl font-extrabold text-blue-400 tracking-tight">Security Login</h1>
        <p class="text-gray-500 text-sm mt-2">%%ORG_NAME%% Safety Dashboard</p>
    </div>
    <input type="password" id="secretKeyInput" class="w-full bg-gray-900 p-4 rounded-xl text-white border border-gray-600 focus:border-blue-500 outline-none text-center tracking-widest text-xl transition-all focus:ring-2 focus:ring-blue-500/50" placeholder="Enter Key">
    <button onclick="login()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 p-4 rounded-xl font-bold hover:from-blue-500 hover:to-blue-400 transition shadow-lg text-lg uppercase tracking-wide">Connect</button>
  </div>
</div>

<div id="dashboardPage" class="hidden h-full flex flex-col">
  
  <header class="bg-gray-800 p-4 shadow-xl flex justify-between items-center z-20 border-b border-gray-700">
    <div class="flex items-center gap-3">
      <img src="%%LOGO_URL%%" class="w-10 h-10 rounded bg-white object-contain" onerror="this.style.display='none'">
      <div>
          <h1 class="text-xl font-bold text-white leading-none">%%ORG_NAME%%</h1>
          <span class="text-xs text-blue-400 font-mono">LIVE MONITOR</span>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <button onclick="toggleNotifications()" id="btnNotify" class="text-gray-500 hover:text-white text-xs uppercase font-bold border border-gray-600 px-2 py-1 rounded">Enable Desktop Alerts</button>
      <div class="text-right hidden md:block">
          <div id="clock" class="text-lg font-bold font-mono">00:00:00</div>
          <div id="lastUpd" class="text-xs text-gray-500">Connecting...</div>
      </div>
      <div class="h-8 w-px bg-gray-700 mx-2"></div>
      <button onclick="logout()" class="text-gray-400 hover:text-white text-sm font-bold uppercase tracking-wider">Logout</button>
    </div>
  </header>
  
  <div id="dbWarning" class="hidden bg-yellow-600 text-white px-4 py-2 text-center text-sm font-bold cursor-pointer hover:bg-yellow-500" onclick="alert('The Google Sheet has over 2500 rows. This slows down the app. Please run the Archive function in the Backend Script.')">
    ‚ö†Ô∏è Database Large (>2500 Rows). Click for info.
  </div>
  
  <div class="bg-gray-900 border-b border-gray-800">
    <details class="group" open>
      <summary class="p-2 text-xs text-gray-500 cursor-pointer hover:text-gray-300 bg-gray-800/50 select-none flex justify-between px-4">
          <span>EVENT LOG</span>
          <span class="group-open:rotate-180 transition">‚ñº</span>
      </summary>
      <div id="logPanel" class="h-32 overflow-y-auto p-2 font-mono text-xs space-y-1 bg-black/20"></div>
    </details>
  </div>

  <main id="workerList" class="flex-1 p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 overflow-y-auto pb-32"></main>
</div>

<div id="alertOverlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-8 bg-red-900/95 backdrop-blur-sm text-white transition-all duration-300">
  <div class="bg-red-950 p-12 rounded-3xl shadow-2xl text-center max-w-2xl w-full border-4 border-red-500 animate-pulse">
      <h2 class="text-9xl mb-4">üö®</h2>
      <h2 class="text-6xl font-black uppercase tracking-tighter mb-8">EMERGENCY</h2>
      <div id="alertDetails" class="text-2xl font-mono text-red-200 mb-12 space-y-2"></div>
      <button onclick="silenceAlarm()" class="w-full bg-white text-red-900 font-black py-6 px-12 rounded-xl text-2xl shadow-2xl hover:scale-105 transition transform active:scale-95">SILENCE & ACKNOWLEDGE</button>
      <p class="mt-4 text-red-300 text-sm">Use dashboard to resolve.</p>
  </div>
</div>

<div id="resolveModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full border border-gray-600">
        <h2 class="text-2xl font-bold text-white mb-2">Resolve Incident</h2>
        <p class="text-gray-400 text-sm mb-6">To verify this is not an accidental dismissal, please type the worker's name exactly as shown below:</p>
        <div id="resolveNameTarget" class="bg-gray-900 p-4 rounded border border-gray-700 text-center text-xl font-mono font-bold text-blue-400 mb-4 select-all"></div>
        <input id="resolveInput" class="w-full bg-gray-700 p-3 rounded text-white border border-gray-500 mb-4 text-center font-bold" placeholder="Type Name Here">
        <div class="flex gap-3">
            <button onclick="closeResolve()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 rounded text-white font-bold">Cancel</button>
            <button onclick="confirmResolve()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded text-white font-bold shadow-lg">DECLARE SAFE</button>
        </div>
    </div>
</div>

<script>
const URL = "%%SHEET_URL%%";
let SECRET = ""; 
let pollInt, alarm;
let lastState = {}; 
let acknowledgedList = new Set();
let activeWorkerToResolve = null;

function login() {
  const k = document.getElementById('secretKeyInput').value;
  if(k){ 
    SECRET=k; 
    localStorage.setItem('otg_monitor_key', k);
    startSession();
  }
}

function startSession() {
    document.getElementById('setupPage').classList.add('hidden'); 
    document.getElementById('dashboardPage').classList.remove('hidden'); 
    document.getElementById('dashboardPage').classList.add('flex'); 
    Tone.start();
    // Add initial log
    addLogEntry("Monitor Session Started");
    fetchData(); 
    pollInt=setInterval(fetchData, 10000); 
    setInterval(updateClock, 1000);
    if(Notification.permission === "granted") document.getElementById('btnNotify').innerText = "Alerts Active ‚úÖ";
}

window.onload = () => {
    const saved = localStorage.getItem('otg_monitor_key');
    if(saved) {
        document.getElementById('secretKeyInput').value = saved;
    }
};

function logout(){ 
    clearInterval(pollInt); 
    localStorage.removeItem('otg_monitor_key');
    location.reload(); 
}

function addLogEntry(msg, type="info") {
  const p = document.createElement('div');
  let color = "text-gray-400";
  if(type==="alert") color = "text-red-400 font-bold";
  if(type==="success") color = "text-green-400";
  p.className = `border-b border-gray-800 pb-1 ${color}`;
  p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
  const panel = document.getElementById('logPanel');
  if(panel) {
      panel.prepend(p);
      if(panel.children.length > 50) panel.lastChild.remove();
  }
}

function fetchData() {
  const s = document.createElement('script');
  const cb = 'cb_'+Date.now();
  window[cb] = (data) => {
    delete window[cb]; document.body.removeChild(s);
    if(data.status==='error') { alert('Access Denied.'); logout(); return; }
    
    if(data.length > 2500) document.getElementById('dbWarning').classList.remove('hidden');
    else document.getElementById('dbWarning').classList.add('hidden');

    processAndRender(data); 
    document.getElementById('lastUpd').innerText = "Updated: " + new Date().toLocaleTimeString();
    document.getElementById('lastUpd').className = "text-xs text-green-500 font-bold";
  };
  s.src = URL + '?callback='+cb+'&key='+encodeURIComponent(SECRET);
  s.onerror = () => { 
    document.getElementById('lastUpd').innerText = "Connection Failed";
    document.getElementById('lastUpd').className = "text-xs text-red-500 font-bold";
  };
  document.body.appendChild(s);
}

function processAndRender(data) {
  const list = document.getElementById('workerList'); 
  const workers = {};
  
  data.forEach(row => {
    if(!row['Worker Name']) return;
    if (!workers[row['Worker Name']] || row['Timestamp'] > workers[row['Worker Name']]['Timestamp']) {
        workers[row['Worker Name']] = row;
    }
  });

  let activeAlertFound = false;
  let anyCritical = false;
  
  Object.values(workers).forEach(w => {
      const name = w['Worker Name'];
      const status = w['Alarm Status'];
      const location = w['Location Name'] || 'Unknown';
      
      // FIX: Log State Changes
      if(lastState[name] && lastState[name] !== status) {
          let type = "info";
          if(status.match(/EMERGENCY|DURESS|PANIC/)) type = "alert";
          if(status === "DEPARTED" || status.includes("SAFE")) type = "success";
          
          addLogEntry(`${name}: ${status} @ ${location}`, type);
          
          if (status.match(/EMERGENCY|DURESS|MISSED|ESCALATION|ALERT|OVERDUE/)) {
             acknowledgedList.delete(name); // Reset silence if new alarm
          }
      } 
      else if(!lastState[name]) {
          // New worker appeared
          addLogEntry(`${name} connected: ${status}`, "info");
      }
      lastState[name] = status;
      
      if(status.match(/EMERGENCY|DURESS|MISSED|ESCALATION|ALERT|OVERDUE/)) {
          anyCritical = true;
          if (!acknowledgedList.has(name)) {
              activeAlertFound = true;
              playAlarm(w);
          }
      }
  });
  
  if(!anyCritical) {
      stopAlarm();
      acknowledgedList.clear();
  }

  list.innerHTML = '';
  const sortedWorkers = Object.values(workers).filter(w => {
      const s = w['Alarm Status'];
      return s !== 'DEPARTED' && s !== 'COMPLETED';
  }).sort((a,b) => {
      const aBad = a['Alarm Status'].match(/EMERGENCY|DURESS|OVERDUE/) ? 1 : 0;
      const bBad = b['Alarm Status'].match(/EMERGENCY|DURESS|OVERDUE/) ? 1 : 0;
      return bBad - aBad;
  });

  if(sortedWorkers.length === 0) {
      list.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center h-64 text-gray-600"><div class="text-6xl mb-4">‚òï</div><div class="text-xl">No Active Visits</div></div>`;
      return;
  }

  sortedWorkers.forEach(w => {
    const status = w['Alarm Status'];
    const isAlert = status.match(/EMERGENCY|DURESS|MISSED|ESCALATION|ALERT|OVERDUE/);
    
    let cardClass = "bg-gray-800 border-l-4 border-blue-500";
    let statusClass = "text-blue-400";
    let resolveBtn = "";
    
    if(isAlert) {
        cardClass = status.includes('DURESS') ? "bg-purple-900 border-l-8 border-purple-500 animate-pulse" : "bg-red-900 border-l-8 border-red-500 animate-pulse";
        statusClass = "text-white font-black bg-red-600 px-2 rounded";
        resolveBtn = `<button onclick="initiateResolve('${w['Worker Name'].replace(/'/g, "\\'")}')" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg animate-none cursor-pointer pointer-events-auto relative z-10">‚úÖ RESOLVE INCIDENT</button>`;
    
    } else if(w['Location Name'] && w['Location Name'].includes('Travelling')) {
        cardClass = "bg-indigo-900/40 border-l-4 border-indigo-500";
        statusClass = "text-indigo-300";
    }

    const start = new Date(w['Timestamp']);
    const mins = Math.floor((new Date() - start)/60000);
    
    const div = document.createElement('div');
    div.className = `rounded-xl shadow-lg p-5 flex flex-col justify-between ${cardClass} transition-all hover:scale-[1.02] relative`;
    
    div.innerHTML = `
      <div>
        <div class="flex justify-between items-start mb-2">
            <h3 class="text-2xl font-bold text-white truncate">${w['Worker Name']}</h3>
            <span class="text-xs font-mono opacity-50 bg-black/30 px-2 py-1 rounded">${mins}m ago</span>
        </div>
        <div class="text-gray-300 text-sm mb-1 truncate">üìç ${w['Location Name'] || 'Unknown'}</div>
        <div class="text-xs text-gray-500 mb-4 truncate">${w['Location Address'] || ''}</div>
        
        <div class="flex items-center justify-between bg-black/20 p-3 rounded-lg">
            <span class="${statusClass} uppercase text-sm font-bold tracking-wider">${status}</span>
            <span class="text-xs font-mono ${getBatColor(w['Battery Level'])}">üîã ${w['Battery Level'] || '?'}</span>
        </div>
        ${w['Notes'] ? `<div class="mt-3 text-xs text-gray-400 italic border-l-2 border-gray-600 pl-2 line-clamp-2">"${w['Notes']}"</div>` : ''}
        
        <div class="mt-2 pointer-events-auto">
            ${resolveBtn}
        </div>
      </div>
      
      <div class="mt-6 pt-4 border-t border-white/10 grid grid-cols-3 gap-2">
         <a href="tel:${w['Worker Phone Number']}" class="col-span-1 bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold">üìû Call</a>
         <a href="tel:${w['Emergency Contact Number']}" class="col-span-1 bg-gray-700 hover:bg-gray-600 text-red-300 text-center py-2 rounded text-xs font-bold">üöë ICE</a>
         <a href="https://www.google.com/maps/search/?api=1&query=${w['Last Known GPS']}" target="_blank" class="col-span-1 bg-blue-700 hover:bg-blue-600 text-white text-center py-2 rounded text-xs font-bold">üó∫ Map</a>
      </div>
    `;
    list.appendChild(div);
  });
}

function getBatColor(bat) {
    if(!bat) return "text-gray-600";
    const n = parseInt(bat);
    if(n < 20) return "text-red-500 animate-pulse";
    if(n < 50) return "text-yellow-500";
    return "text-green-500";
}

async function playAlarm(w) {
  if(Notification.permission === "granted") {
      new Notification(`üö® ${w['Alarm Status']}: ${w['Worker Name']}`, { body: `Location: ${w['Location Name']}`, icon: '%%LOGO_URL%%' });
  }

  const ov = document.getElementById('alertOverlay');
  if(ov.classList.contains('hidden')){
    ov.classList.remove('hidden');
    const isDuress = w['Alarm Status'].includes('DURESS');
    ov.className = isDuress ? 
       'fixed inset-0 z-50 flex flex-col items-center justify-center p-8 flashing-duress text-white' : 
       'fixed inset-0 z-50 flex flex-col items-center justify-center p-8 flashing-alert text-white';
    
    document.getElementById('alertDetails').innerHTML = `
      <div class="text-4xl font-bold">${w['Worker Name']}</div>
      <div class="text-xl opacity-75 mt-2">${w['Location Name']}</div>
      <div class="mt-6 bg-black/40 px-6 py-2 rounded-full inline-block">${w['Alarm Status']}</div>
    `;
    
    // Store name on button for silence logic if needed
    document.getElementById('btnSilence').dataset.worker = w['Worker Name'];

    if(Tone.context.state !== 'running') await Tone.start();
    alarm = new Tone.Oscillator(440, "square").toDestination().start();
    const lfo = new Tone.LFO("2n", 400, 800).start();
    lfo.connect(alarm.frequency);
  }
}

function silenceAlarm() {
    // Add current alerting worker to acknowledged list
    const workerName = document.getElementById('btnSilence').dataset.worker;
    if(workerName) acknowledgedList.add(workerName);
    
    document.getElementById('alertOverlay').classList.add('hidden');
    stopAlarmSound();
}

function stopAlarm() {
    document.getElementById('alertOverlay').classList.add('hidden');
    stopAlarmSound();
}

function stopAlarmSound() {
    if(alarm) { alarm.stop(); alarm.dispose(); alarm = null; }
}

function initiateResolve(workerName) {
    activeWorkerToResolve = workerName;
    document.getElementById('resolveNameTarget').innerText = workerName;
    document.getElementById('resolveInput').value = "";
    document.getElementById('resolveModal').classList.remove('hidden');
}

function closeResolve() { document.getElementById('resolveModal').classList.add('hidden'); activeWorkerToResolve = null; }

function confirmResolve() {
    const input = document.getElementById('resolveInput').value.trim();
    if (input === activeWorkerToResolve) {
        const formData = new FormData();
        formData.append('Worker Name', activeWorkerToResolve);
        formData.append('Alarm Status', 'SAFE - MONITOR CLEARED');
        formData.append('Notes', 'Incident resolved by Monitor Dashboard');
        formData.append('key', SECRET);

        fetch(URL, { method: 'POST', body: formData, mode: 'no-cors' })
            .then(() => {
                alert("Resolution Sent. Dashboard will update shortly.");
                closeResolve();
                silenceAlarm();
                lastState[activeWorkerToResolve] = 'SAFE - MONITOR CLEARED';
                acknowledgedList.add(activeWorkerToResolve);
            })
            .catch(e => alert("Connection Failed: " + e));
    } else {
        alert("Name does not match. Please type exactly: " + activeWorkerToResolve);
    }
}

function toggleNotifications() {
    if(Notification.permission !== 'granted') {
        Notification.requestPermission().then(p => {
            if(p === 'granted') document.getElementById('btnNotify').innerText = "Alerts Active ‚úÖ";
        });
    }
}

function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }

// Ensure Silence Button has ID
document.addEventListener('DOMContentLoaded', () => {
   const btn = document.querySelector('#alertOverlay button');
   if(btn) btn.id = "btnSilence";
});
</script>
</body>
</html>
