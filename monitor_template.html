<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>%%ORG_NAME%% Monitor</title>
<link rel="icon" href="%%LOGO_URL%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<style>
  body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  .main-layout { display: flex; flex: 1; overflow: hidden; }
  .grid-area { flex: 3; overflow-y: auto; padding: 1.5rem; position: relative; }
  .log-area { flex: 1; background-color: #1e293b; border-left: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
  .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; position: relative; overflow: hidden; }
  .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
  .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
  .blink { animation: blinker 1.5s linear infinite; }
  @keyframes blinker { 50% { opacity: 0; } }
  .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; } 
  .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; } 
  .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.5s linear infinite; } 
  .st-grey { background-color: #64748b; } 
  .bd-green { border-color: #059669; border-width: 2px; }
  .bd-amber { border-color: #d97706; border-width: 2px; }
  .bd-red { border-color: #dc2626; border-width: 4px; }
  .bd-grey { border-color: #475569; opacity: 0.7; }
  
  /* Full Screen Alert */
  #fullScreenAlert { animation: pulseRed 1s infinite; z-index: 50; }
  @keyframes pulseRed { 0% { background-color: rgba(220, 38, 38, 0.9); } 50% { background-color: rgba(153, 27, 27, 0.95); } 100% { background-color: rgba(220, 38, 38, 0.9); } }
  
  /* Map Styles */
  #mapView { background: #020617; z-index: 1; }
  .map-icon { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
  .map-icon.red { background: #ef4444; animation: blinker 0.8s linear infinite; box-shadow: 0 0 20px #ef4444; }
  .map-icon.green { background: #10b981; }
  .map-icon.amber { background: #f59e0b; }
  .map-icon.grey { background: #64748b; }
</style>
</head>
<body>
  <div id="authModal" class="hidden fixed inset-0 z-[100] bg-gray-900 flex items-center justify-center p-4">
      <div class="bg-gray-800 border-2 border-blue-600 rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
          <div class="text-6xl mb-4">üîê</div>
          <h1 class="text-2xl font-bold text-white mb-2">Security Access</h1>
          <p class="text-gray-400 text-sm mb-6">Enter your Organisation Secret Key to authorize this Monitor Station.</p>
          <input type="password" id="authKeyInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-4 text-white text-center text-lg tracking-widest mb-6 focus:border-blue-500 outline-none" placeholder="Enter Secret Key">
          <button onclick="saveAuthKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg text-lg">Unlock Monitor</button>
      </div>
  </div>

  <div id="fullScreenAlert" class="hidden fixed inset-0 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
      <div class="text-9xl mb-4">üö®</div>
      <h1 class="text-6xl font-black text-white mb-4 drop-shadow-md">EMERGENCY ALERT</h1>
      <h2 id="alertNames" class="text-4xl font-bold text-white bg-black/30 px-6 py-2 rounded mb-8">Worker Name</h2>
      <button onclick="acknowledgeAlert()" class="bg-white text-red-700 font-black text-2xl py-6 px-12 rounded-full shadow-2xl hover:scale-105 transition border-4 border-red-900">ACKNOWLEDGE ALARM</button>
      <p class="text-white mt-6 font-bold opacity-80">Clicking this silences the alarm but DOES NOT clear the emergency.</p>
  </div>

  <div id="resolveModal" class="hidden fixed inset-0 z-40 bg-black/90 flex items-center justify-center p-4">
      <div class="bg-gray-800 border-2 border-green-600 rounded-xl shadow-2xl max-w-md w-full p-6">
          <h2 class="text-2xl font-bold text-white mb-2">Resolve Emergency</h2>
          <p class="text-gray-400 text-sm mb-4">You are manually clearing <span id="resWorkerNameDisplay" class="font-bold text-white"></span>.</p>
          
          <div class="space-y-4">
              <div>
                  <label class="block text-xs uppercase font-bold text-gray-500 mb-1">1. Confirm Worker Name</label>
                  <input type="text" id="resNameInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white" placeholder="Type name exactly...">
              </div>
              <div>
                  <label class="block text-xs uppercase font-bold text-gray-500 mb-1">2. Resolution Note (Log)</label>
                  <textarea id="resNoteInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white h-24" placeholder="e.g. Spoke to worker, false alarm."></textarea>
              </div>
          </div>
          
          <div class="flex gap-3 mt-6">
              <button onclick="closeResolve()" class="flex-1 bg-gray-700 text-white font-bold py-3 rounded">Cancel</button>
              <button onclick="submitResolution()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg">‚úÖ MARK SAFE</button>
          </div>
      </div>
  </div>

  <header class="bg-gray-900 border-b border-gray-800 p-4 shrink-0 z-20 shadow-lg">
    <div class="flex justify-between items-center mb-2">
        <div class="flex items-center gap-4">
          <img src="%%LOGO_URL%%" class="w-10 h-10 rounded bg-white object-contain p-1">
          <div>
            <h1 class="text-xl font-bold tracking-tight text-white">%%ORG_NAME%% <span class="text-gray-500 font-normal text-sm ml-2">Monitor v68.8</span></h1>
            <div class="flex items-center gap-2 text-xs text-gray-400">
               <span id="serverStatus" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Connecting...</span>
               <span>‚Ä¢ Updated: <span id="lastUpdate" class="text-gray-300 font-mono">--:--:--</span></span>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="resetKey()" class="text-xs text-gray-600 hover:text-gray-400 underline">üîë Reset Key</button>
            <button id="btnAudio" onclick="enableAudio()" class="px-3 py-1 rounded text-sm font-bold bg-gray-700 text-gray-400 border border-gray-600 hover:bg-gray-600 transition">üîá Enable Sound</button>
            
            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600 ml-4">
                <button onclick="setFilter('ACTIVE')" id="btnFilterActive" class="px-3 py-1 rounded text-xs font-bold bg-blue-600 text-white shadow transition">üü¢ Active</button>
                <button onclick="setFilter('ALL')" id="btnFilterAll" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition">üìã All</button>
            </div>

            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600">
                <button onclick="toggleView('GRID')" id="btnGrid" class="px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white shadow">‚äû Grid</button>
                <button onclick="toggleView('MAP')" id="btnMap" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition">üó∫Ô∏è Map</button>
            </div>
            
            <div class="relative">
                <input type="text" id="searchBox" placeholder="Filter..." class="bg-gray-800 text-white text-sm border border-gray-600 rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:border-blue-500 w-32" onkeyup="renderGrid()">
            </div>
        </div>
        <div class="flex gap-6 border-l border-gray-700 pl-6">
            <div class="text-center"><div class="text-2xl font-bold text-green-400 leading-none" id="activeCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Active</div></div>
            <div class="text-center"><div class="text-2xl font-bold text-red-500 leading-none" id="alertCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Alerts</div></div>
        </div>
    </div>
    <div id="loadWarning" class="hidden rounded px-3 py-2 text-xs font-bold flex items-center justify-between"><span id="loadMsg"></span><span class="opacity-80 font-normal">System bottleneck likely. Please stagger shifts.</span></div>
  </header>

  <div class="main-layout">
      <div class="grid-area">
          <div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4"></div>
          <div id="mapView" class="hidden h-full w-full rounded-xl overflow-hidden shadow-inner border border-gray-700 bg-gray-900 relative"></div>
          <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-gray-600"><div class="text-4xl mb-2">üò¥</div><p>No active workers.</p></div>
      </div>
      <div class="log-area">
          <div class="p-3 bg-gray-800 border-b border-gray-700 font-bold text-xs text-gray-400 uppercase tracking-wider sticky top-0">Live Activity Log</div>
          <div id="eventLogList" class="flex-1 overflow-y-auto"></div>
      </div>
  </div>

<script>
const SCRIPT_URL = "%%SHEET_URL%%";
let API_KEY = localStorage.getItem('otg_monitor_key'); 
let workerData = [];
let allRows = [];
let escalationLimit = 15;
let mapInstance = null, markersLayer = null, currentView = 'GRID'; 
let currentFilter = 'ACTIVE'; // DEFAULT FILTER
let audioEnabled = true, synth = null;
let acknowledgedAlerts = new Set(); 
let alertLoopInterval = null;

// INIT
window.onload = () => { 
    if(!API_KEY) {
        document.getElementById('authModal').classList.remove('hidden');
    } else {
        fetchData(); 
        setInterval(fetchData, 10000); 
        setInterval(renderGrid, 1000); 
    }
    document.body.addEventListener('click', async () => { if(audioEnabled && !synth) { await Tone.start(); synth = new Tone.Synth().toDestination(); } }, { once: true });
};

function saveAuthKey() {
    const k = document.getElementById('authKeyInput').value.trim();
    if(k.length < 3) return alert("Invalid Key");
    localStorage.setItem('otg_monitor_key', k);
    API_KEY = k;
    document.getElementById('authModal').classList.add('hidden');
    fetchData(); 
    setInterval(fetchData, 10000); 
    setInterval(renderGrid, 1000);
}

function resetKey() {
    if(confirm("Reset the Security Key for this station?")) {
        localStorage.removeItem('otg_monitor_key');
        location.reload();
    }
}

async function enableAudio() {
    if(!synth) { await Tone.start(); synth = new Tone.Synth().toDestination(); }
    audioEnabled = !audioEnabled;
    const btn = document.getElementById('btnAudio');
    if(audioEnabled) {
        btn.innerText = "üîä Sound On";
        btn.classList.replace('bg-gray-700', 'bg-green-600');
        btn.classList.replace('text-gray-400', 'text-white');
        synth.triggerAttackRelease("C5", "8n");
    } else {
        btn.innerText = "üîá Sound Off";
        btn.classList.replace('bg-green-600', 'bg-gray-700');
        btn.classList.replace('text-white', 'text-gray-400');
    }
}

function startAlertLoop() {
    if(alertLoopInterval) return; 
    alertLoopInterval = setInterval(() => {
        if(audioEnabled && synth) {
            const now = Tone.now();
            synth.triggerAttackRelease("C6", "0.1", now);
            synth.triggerAttackRelease("G5", "0.1", now + 0.15);
        }
    }, 1000);
}

function stopAlertLoop() {
    if(alertLoopInterval) { clearInterval(alertLoopInterval); alertLoopInterval = null; }
}

function acknowledgeAlert() {
    workerData.forEach(w => {
        if(w.status.includes("EMERGENCY") || w.status.includes("PANIC") || w.status.includes("OVERDUE")) {
            acknowledgedAlerts.add(w.name);
        }
    });
    document.getElementById('fullScreenAlert').classList.add('hidden');
    stopAlertLoop();
    renderGrid(); 
}

function openResolve(name) {
    document.getElementById('resolveModal').classList.remove('hidden');
    document.getElementById('resWorkerNameDisplay').innerText = name;
    document.getElementById('resNameInput').value = "";
    document.getElementById('resNoteInput').value = "";
}

function closeResolve() {
    document.getElementById('resolveModal').classList.add('hidden');
}

function submitResolution() {
    const targetName = document.getElementById('resWorkerNameDisplay').innerText;
    const typedName = document.getElementById('resNameInput').value.trim();
    const note = document.getElementById('resNoteInput').value.trim();
    
    if(targetName !== typedName) { alert("Error: Name does not match exactly."); return; }
    if(note.length < 5) { alert("Error: Please enter a resolution note."); return; }
    
    const formData = new FormData();
    formData.append('action', 'resolve');
    formData.append('key', API_KEY);
    formData.append('Worker Name', targetName);
    formData.append('Alarm Status', 'SAFE - MANUALLY CLEARED');
    formData.append('Notes', `[HQ RESOLVED]: ${note}`);
    formData.append('Battery Level', 'N/A');
    formData.append('Location Name', 'HQ Manual Resolution');
    
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData })
    .then(() => {
        alert("Resolution Sent. Update may take 10s.");
        closeResolve();
        acknowledgedAlerts.add(targetName);
        renderGrid();
    })
    .catch(e => alert("Connection Error: " + e));
}

function setFilter(f) {
    currentFilter = f;
    const btnAct = document.getElementById('btnFilterActive');
    const btnAll = document.getElementById('btnFilterAll');
    
    if(f === 'ACTIVE') {
        btnAct.classList.replace('text-gray-400', 'bg-blue-600');
        btnAct.classList.replace('hover:text-white', 'text-white');
        btnAll.classList.replace('bg-blue-600', 'text-gray-400');
        btnAll.classList.replace('text-white', 'hover:text-white');
        btnAll.classList.remove('shadow');
        btnAct.classList.add('shadow');
    } else {
        btnAll.classList.replace('text-gray-400', 'bg-blue-600');
        btnAll.classList.replace('hover:text-white', 'text-white');
        btnAct.classList.replace('bg-blue-600', 'text-gray-400');
        btnAct.classList.replace('text-white', 'hover:text-white');
        btnAct.classList.remove('shadow');
        btnAll.classList.add('shadow');
    }
    renderGrid();
    if(currentView === 'MAP') renderMap();
}

function toggleView(view) {
    currentView = view;
    document.getElementById('workerGrid').classList.toggle('hidden', view === 'MAP');
    document.getElementById('mapView').classList.toggle('hidden', view === 'GRID');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('btnGrid').classList.toggle('bg-gray-600', view === 'GRID');
    document.getElementById('btnMap').classList.toggle('bg-gray-600', view === 'MAP');
    if(view === 'MAP') { initMap(); renderMap(); } else { renderGrid(); }
}

function fetchData() {
    const script = document.createElement('script');
    const cbName = 'cb_' + Date.now();
    window[cbName] = function(data) {
        if(data.escalation_limit) escalationLimit = parseInt(data.escalation_limit);
        handleData(data);
        document.body.removeChild(script);
        delete window[cbName];
    };
    script.src = `${SCRIPT_URL}?callback=${cbName}&t=${Date.now()}`;
    document.body.appendChild(script);
}

function handleData(response) {
    if (response && (response.workers || response.status === 'online')) {
        document.getElementById('serverStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
    }
    if (response.workers) {
        allRows = response.workers; 
        workerData = processWorkers(response.workers);
        document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
        
        const alertWorkers = workerData.filter(w => (w.status.includes("EMERGENCY") || w.status.includes("PANIC") || w.status.includes("OVERDUE")) && !w.status.includes("SAFE"));
        const unacked = alertWorkers.filter(w => !acknowledgedAlerts.has(w.name));
        
        if(unacked.length > 0) {
            document.getElementById('fullScreenAlert').classList.remove('hidden');
            document.getElementById('alertNames').innerText = unacked.map(w => w.name).join(", ");
            startAlertLoop();
        } else {
            document.getElementById('fullScreenAlert').classList.add('hidden');
            stopAlertLoop();
        }

        if(currentView === 'GRID') renderGrid(); else renderMap();
        renderLog();
    }
}

function processWorkers(rows) {
    const workers = {};
    rows.forEach(r => {
        const name = r['Worker Name']; if (!name) return;
        const timestamp = new Date(r['Timestamp']).getTime();
        if (!workers[name] || timestamp > workers[name].timestamp) {
            workers[name] = { name: name, status: r['Alarm Status'], phone: r['Worker Phone Number'], iceName: r['Emergency Contact Name'], icePhone: r['Emergency Contact Number'], notes: r['Notes'], location: r['Location Name'] || r['Location Address'] || "Unknown", gps: r['Last Known GPS'], battery: r['Battery Level'], dueTime: r['Anticipated Departure Time'], wofExpiry: r['WOFExpiry'], timestamp: timestamp };
        }
    });
    return Object.values(workers);
}

// --- GRID LOGIC ---
function renderGrid() {
    const grid = document.getElementById('workerGrid');
    const search = document.getElementById('searchBox').value.toLowerCase();
    const now = Date.now();
    grid.innerHTML = '';
    let activeC = 0; let alertC = 0; let visibleCount = 0;
    workerData.sort((a,b) => getUrgencyScore(b, now) - getUrgencyScore(a, now));
    const totalActive = workerData.filter(w => w.status !== 'DEPARTED' && w.status !== 'COMPLETED').length;
    
    const loadEl = document.getElementById('loadWarning');
    if (totalActive > 40) { loadEl.className = "bg-red-900 border-red-500 rounded px-3 py-2 text-xs font-bold flex justify-between animate-pulse"; loadEl.classList.remove('hidden'); document.getElementById('loadMsg').innerText = `‚ö†Ô∏è CRITICAL LOAD (${totalActive})`; }
    else if (totalActive > 20) { loadEl.className = "bg-yellow-900 border-yellow-500 rounded px-3 py-2 text-xs font-bold flex justify-between"; loadEl.classList.remove('hidden'); document.getElementById('loadMsg').innerText = `‚ö†Ô∏è HIGH TRAFFIC (${totalActive})`; }
    else { loadEl.classList.add('hidden'); }

    workerData.forEach(w => {
        // STRICT FILTER LOGIC
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE') || w.status === 'DATA_ENTRY_ONLY';
        const isAlert = w.status.includes('EMERGENCY') || w.status.includes('PANIC') || w.status.includes('OVERDUE');
        
        if(!isSafe) activeC++; 
        if(isAlert) alertC++;
        
        if (search && !w.name.toLowerCase().includes(search)) return;
        
        // FILTER SWITCH
        if (currentFilter === 'ACTIVE' && isSafe && !isAlert) return;

        visibleCount++;
        
        if(currentView === 'MAP') return; 

        let borderClass = 'bd-grey', dotClass = 'st-grey', statusText = w.status, timeClass = 'text-gray-500';
        let resolveBtn = '';

        if (isAlert) { 
            borderClass = 'bd-red'; dotClass = 'st-red'; timeClass = 'text-red-400 font-bold'; 
            resolveBtn = `<button onclick="openResolve('${w.name}')" class="mt-2 w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded text-xs animate-pulse">‚úÖ RESOLVE ALERT</button>`;
        } 
        else if (!isSafe) {
            const due = new Date(w.dueTime).getTime();
            if (!isNaN(due)) {
                if (due > now) { borderClass = 'bd-green'; dotClass = 'st-ok'; } 
                else {
                    const minsOver = (now - due) / 60000;
                    if (minsOver < escalationLimit) { borderClass = 'bd-amber'; dotClass = 'st-amber'; statusText = `OVERDUE (${Math.floor(minsOver)}m)`; } 
                    else { borderClass = 'bd-red'; dotClass = 'st-red'; statusText = "CRITICAL OVERDUE"; }
                }
            } else { borderClass = 'bd-green'; dotClass = 'st-ok'; }
        }
        
        const card = document.createElement('div');
        card.className = `card p-4 ${borderClass}`;
        let batClass = parseInt(w.battery) < 20 ? 'text-red-500 font-bold blink' : 'text-green-500';
        
        card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-white truncate w-full">${w.name}</h3><div class="${dotClass} status-dot mt-1.5 shrink-0 ml-2"></div></div>
        <div class="space-y-1.5 text-xs text-gray-300">
            <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Status</span><span class="font-bold">${statusText}</span></div>
            <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Location</span><span class="truncate w-24 text-right" title="${w.location}">${w.location}</span></div>
            <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Due</span><span class="${timeClass}">${formatTime(w.dueTime)}</span></div>
            <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Battery</span><span class="${batClass}">${w.battery||'--'}</span></div>
            ${w.iceName ? `<div class="mt-2 pt-2 border-t border-gray-700 flex justify-between items-center"><span class="text-[10px] text-red-400 font-bold uppercase">ICE: ${w.iceName}</span><a href="tel:${w.icePhone}" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-2 py-1 rounded text-[10px] font-bold">üìû</a></div>` : ''}
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2"><a href="https://www.google.com/maps/search/?api=1&query=${w.gps}" target="_blank" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 text-center py-2 rounded text-xs font-bold">üìç Map</a><a href="tel:${w.phone}" class="bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold">üìû Worker</a></div>
        ${resolveBtn}`;
        grid.appendChild(card);
    });
    
    document.getElementById('activeCount').innerText = activeC;
    document.getElementById('alertCount').innerText = alertC;
    if(currentView === 'GRID') document.getElementById('emptyState').classList.toggle('hidden', visibleCount > 0);
}

// --- MAP LOGIC ---
function initMap() {
    if(mapInstance) { mapInstance.invalidateSize(); return; }
    mapInstance = L.map('mapView').setView([-40.9006, 174.8860], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapInstance);
    markersLayer = L.layerGroup().addTo(mapInstance);
}
function renderMap() {
    if(!mapInstance) return;
    markersLayer.clearLayers();
    const bounds = L.latLngBounds();
    let hasMarkers = false;
    const now = Date.now();
    workerData.forEach(w => {
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE') || w.status === 'DATA_ENTRY_ONLY';
        const isAlert = w.status.includes('EMERGENCY') || w.status.includes('PANIC') || w.status.includes('OVERDUE');
        if (currentFilter === 'ACTIVE' && isSafe && !isAlert) return;
        
        if(!w.gps || w.gps.length < 5) return;
        const [lat, lng] = w.gps.split(',').map(Number);
        if(isNaN(lat)) return;
        let colorClass = 'grey';
        const urgency = getUrgencyScore(w, now);
        if(urgency >= 1000) colorClass = 'red'; else if(urgency >= 500) colorClass = 'amber'; else if(urgency >= 100) colorClass = 'green';
        const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-icon ${colorClass}"></div>`, iconSize: [20, 20] });
        L.marker([lat, lng], {icon: icon}).bindPopup(`<b>${w.name}</b><br>${w.status}<br>${w.location}`).addTo(markersLayer);
        bounds.extend([lat, lng]); hasMarkers = true;
    });
    if(hasMarkers) mapInstance.fitBounds(bounds, {padding:[50,50], maxZoom:15});
}

function renderLog() {
    const list = document.getElementById('eventLogList');
    const sorted = [...allRows].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp));
    const top = sorted.slice(0, 50);
    let html = '';
    top.forEach(r => {
        const time = new Date(r['Timestamp']).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        let color = "text-gray-300";
        if(r['Alarm Status'].includes("EMERGENCY")) color = "text-red-400 font-bold";
        else if(r['Alarm Status'].includes("RESOLVED")) color = "text-green-400 font-bold";
        html += `<div class="log-item"><span class="log-time">${time}</span><div class="flex justify-between"><span class="log-user">${r['Worker Name']}</span><span class="${color}">${r['Alarm Status']}</span></div><div class="log-action truncate text-gray-500 text-[10px]">${r['Location Name']||"Unknown"}</div></div>`;
    });
    list.innerHTML = html;
}
function getUrgencyScore(w, now) { if (w.status.includes('EMERGENCY')) return 1000; const due = new Date(w.dueTime).getTime(); if (!isNaN(due) && due < now && w.status !== 'DEPARTED') return 500 + (now - due); if (w.status === 'ON SITE' || w.status === 'TRAVELLING') return 100; return 0; }
function formatTime(t) { if(!t) return "--:--"; const d = new Date(t); return isNaN(d) ? "--:--" : d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
</script>
</body>
</html>
