<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%%ORG_NAME%% Monitor</title>
    <link rel="icon" href="%%LOGO_DATA%%">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            /* 1. FACTORY DYNAMIC THEME */
            --brand-primary: %%PRIMARY_COLOR%%;
            --brand-accent: %%ACCENT_COLOR%%;
        }
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .grid-area { flex: 1; overflow-y: auto; padding: 1.5rem; position: relative; }
        .log-area { flex: 0 0 320px; background-color: #1e293b; border-left: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
        .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        /* Dynamic Urgency Classes */
        .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; } 
        .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; } 
        .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.5s linear infinite; } 
        .st-purple { background-color: #d946ef; box-shadow: 0 0 15px #d946ef; animation: blinker 0.3s linear infinite; }
        .st-grey { background-color: #64748b; } 
        .bd-green { border-color: #059669; border-width: 2px; }
        .bd-amber { border-color: #d97706; border-width: 2px; }
        .bd-red { border-color: #dc2626; border-width: 4px; }
        .bd-purple { border-color: #c026d3; border-width: 5px; }
        .bd-grey { border-color: #475569; opacity: 0.7; }
        
        .btn-brand { background-color: var(--brand-primary); }
        .btn-brand:hover { filter: brightness(1.2); }
        .border-brand { border-color: var(--brand-primary); }
        .text-brand { color: var(--brand-accent); }
        
        /* Map and Alert Styles */
        #fullScreenAlert { z-index: 500; }
        .alert-red { animation: pulseRed 1s infinite; }
        .alert-purple { animation: pulsePurple 1s infinite; }
        @keyframes pulseRed { 0% { background-color: rgba(220, 38, 38, 0.9); } 50% { background-color: rgba(153, 27, 27, 0.95); } 100% { background-color: rgba(220, 38, 38, 0.9); } }
        @keyframes pulsePurple { 0% { background-color: rgba(147, 51, 234, 0.9); } 50% { background-color: rgba(107, 33, 168, 0.95); } 100% { background-color: rgba(147, 51, 234, 0.9); } }
        #mapView { background: #020617; z-index: 1; width: 100%; height: 100%; }
        .custom-div-icon { background: transparent; border: none; } 
        .map-icon { width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); display: block; }
        .map-icon.red { background: #ef4444; animation: blinker 0.8s linear infinite; box-shadow: 0 0 20px #ef4444; }
        .map-icon.purple { background: #d946ef; animation: blinker 0.3s linear infinite; box-shadow: 0 0 25px #d946ef; }
        .map-icon.green { background: #10b981; }
        .map-icon.amber { background: #f59e0b; }
        .map-icon.grey { background: #64748b; }

        #audioGate { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; p-4; }
    </style>
</head>
<body>

<div id="audioGate">
    <div class="bg-gray-800 border-2 border-brand rounded-[2.5rem] shadow-2xl max-w-md w-full p-10 text-center">
        <div class="text-7xl mb-6">üõ°Ô∏è</div>
        <h1 class="text-3xl font-black text-white mb-2 uppercase tracking-tight">%%ORG_NAME%%</h1>
        <p class="text-gray-400 text-sm mb-8">Enter the Master Security Key to unlock audio alerts and live GPS monitoring.</p>
        
        <form onsubmit="unlockMonitor(event)" class="space-y-4">
            <input type="password" id="masterKeyInput" 
                   class="w-full bg-gray-900 border-2 border-gray-700 rounded-2xl p-4 text-center text-xl font-mono tracking-[0.4em] text-blue-400 focus:border-blue-500 outline-none transition-all"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <button type="submit" class="w-full btn-brand text-white font-black py-5 rounded-2xl shadow-2xl text-xl transition transform active:scale-95 uppercase tracking-widest">
                Unlock Dashboard
            </button>
        </form>
        <p id="loginError" class="text-red-500 text-xs font-bold mt-4 uppercase hidden">Invalid Security Key</p>
        
        <div class="mt-8 text-left border-t border-gray-700 pt-6">
            <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">üîß Sound Reliability</p>
            <p class="text-[10px] text-gray-500 leading-relaxed italic">To ensure alarms sound in the background, set browser sound permissions to 'Allow' for this URL.</p>
        </div>
    </div>
</div>

<div id="connectionOverlay" class="hidden fixed inset-0 z-[95] bg-gray-900/90 flex items-center justify-center backdrop-blur-md">
    <div class="bg-gray-800 border-2 border-red-600 p-8 rounded-xl shadow-2xl text-center max-w-sm">
        <div class="text-5xl mb-6 animate-pulse">üì°</div>
        <h2 class="text-3xl font-bold text-white mb-2">Connection Lost</h2>
        <p class="text-red-400 font-mono text-sm mb-4">SYSTEM OFFLINE</p>
    </div>
</div>

<div id="fullScreenAlert" class="hidden fixed inset-0 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
    <div class="text-9xl mb-4" id="alertIcon">üö®</div>
    <h1 class="text-6xl font-black text-white mb-4 drop-shadow-md" id="alertTitle">EMERGENCY ALERT</h1>
    <h2 id="alertNames" class="text-4xl font-bold text-white bg-black/30 px-6 py-2 rounded mb-8">Worker Name</h2>
    <button onclick="acknowledgeAlert()" class="bg-white text-gray-900 font-black text-2xl py-6 px-12 rounded-full shadow-2xl hover:scale-105 transition border-4 border-gray-900">ACKNOWLEDGE ALARM</button>
</div>

<div id="resolveModal" class="hidden fixed inset-0 z-40 bg-black/90 flex items-center justify-center p-4">
    <div class="bg-gray-800 border-2 border-green-600 rounded-xl shadow-2xl max-w-md w-full p-6">
        <h2 class="text-2xl font-bold text-white mb-2">Resolve Emergency</h2>
        <p class="text-gray-400 text-sm mb-4">Manual clear for: <span id="resWorkerNameDisplay" class="font-bold text-white"></span></p>
        <div class="space-y-4">
            <div><label class="block text-xs uppercase font-bold text-gray-500 mb-1">1. Confirm Worker Name</label><input type="text" id="resNameInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white"></div>
            <div><label class="block text-xs uppercase font-bold text-gray-500 mb-1">2. Resolution Note</label><textarea id="resNoteInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white h-24"></textarea></div>
        </div>
        <div class="flex gap-3 mt-6"><button onclick="closeResolve()" class="flex-1 bg-gray-700 text-white font-bold py-3 rounded">Cancel</button><button onclick="submitResolution()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg">‚úÖ MARK SAFE</button></div>
    </div>
</div>

<header class="bg-gray-900 border-b border-gray-800 p-4 shrink-0 z-20 shadow-lg">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <img id="orgLogo" src="%%LOGO_DATA%%" class="w-10 h-10 rounded bg-white object-contain p-1">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white">%%ORG_NAME%% <span class="text-gray-500 font-normal text-sm ml-2">Monitor Dashboard</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <span id="serverStatus" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Connecting...</span>
                    <span>‚Ä¢ Updated: <span id="lastUpdate" class="text-gray-300 font-mono">--:--:--</span></span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="resetKey()" class="text-xs text-gray-600 hover:text-gray-400 underline">üîë Sign Out</button>
            <button onclick="exportSystemLog()" class="text-xs text-blue-400 hover:text-blue-300 underline">üìä Export Log</button>
            <button id="btnAudio" onclick="toggleAudio()" class="px-3 py-1 rounded text-sm font-bold bg-green-600 text-white border border-green-500">üîä Sound On</button>
            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600"><button onclick="setFilter('ACTIVE')" id="btnFilterActive" class="px-3 py-1 rounded text-xs font-bold btn-brand text-white shadow">üü¢ Active</button><button onclick="setFilter('ALL')" id="btnFilterAll" class="px-3 py-1 rounded text-xs font-bold text-gray-400">üìã All</button></div>
            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600"><button onclick="toggleView('GRID')" id="btnGrid" class="px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white shadow">‚äû Grid</button><button onclick="toggleView('MAP')" id="btnMap" class="px-3 py-1 rounded text-xs font-bold text-gray-400">üó∫Ô∏è Map</button></div>
            <input type="text" id="searchBox" placeholder="Filter..." class="bg-gray-800 text-white text-sm border border-gray-600 rounded-lg pl-3 pr-2 py-2 w-32" onkeyup="renderGrid()">
        </div>
        <div class="flex gap-6 border-l border-gray-700 pl-6">
            <div class="text-center"><div class="text-2xl font-bold text-green-400" id="activeCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold">Active</div></div>
            <div class="text-center"><div class="text-2xl font-bold text-red-500" id="alertCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold">Alerts</div></div>
        </div>
    </div>
</header>

<div class="main-layout">
    <div class="grid-area">
        <div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        <div id="mapView" class="hidden h-full w-full rounded-xl overflow-hidden shadow-inner border border-gray-700 bg-gray-900"></div>
        <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-gray-600"><div class="text-4xl mb-2">üò¥</div><p>No active workers.</p></div>
    </div>
    <div class="log-area"><div class="p-2 bg-gray-800 border-b border-gray-700 font-bold text-[10px] text-gray-400 uppercase tracking-wider sticky top-0">Activity Log</div><div id="eventLogList" class="flex-1 overflow-y-auto px-2 py-2 space-y-1"></div></div>
</div>

<script>
const SCRIPT_URL = "%%GOOGLE_SHEET_URL%%";
const VEHICLE_TERM = "%%VEHICLE_TERM%%"; 
let API_KEY = localStorage.getItem('monitor_master_key'); 
let workerData = []; let allRows = []; let escalationLimit = 15; let mapInstance = null, markersLayer = null, currentView = 'GRID'; let currentFilter = 'ACTIVE'; let audioEnabled = true, synth = null; let acknowledgedAlerts = new Set(); let alertLoopInterval = null; let lastHeartbeat = Date.now(); 

// 6. INITIALIZATION & SECURITY Handshake
window.onload = () => {
    if (API_KEY) unlockMonitor();
};

async function unlockMonitor(e) {
    if (e) e.preventDefault();
    const activeKey = API_KEY || document.getElementById('masterKeyInput')?.value;
    if (!activeKey) return;

    try {
        const resp = await fetch(`${SCRIPT_URL}?key=${encodeURIComponent(activeKey)}&test=true`);
        const data = await resp.json();
        
        if (data.status === "success") {
            API_KEY = activeKey;
            localStorage.setItem('monitor_master_key', activeKey);
            if(typeof Tone !== 'undefined') {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
            }
            document.getElementById('audioGate').classList.add('hidden');
            startPolling();
        } else { throw new Error(); }
    } catch (err) {
        localStorage.removeItem('monitor_master_key');
        API_KEY = null;
        document.getElementById('loginError')?.classList.remove('hidden');
    }
}

function startPolling() {
    fetchData(); 
    setInterval(fetchData, 10000); 
    setInterval(renderGrid, 1000);
    
    // Audio Keep-Alive for Background Operation
    setInterval(() => {
        if (audioEnabled && synth) {
            try { synth.triggerAttackRelease("C1", "1n", Tone.now(), 0.001); } catch(e) {}
        }
    }, 25000);

    // Watchdog for Connection Resilience
    setInterval(() => {
        const ol = document.getElementById('connectionOverlay');
        if (Date.now() - lastHeartbeat > 60000) {
            ol.classList.remove('hidden');
            if(audioEnabled && synth) playSound('offline');
        } else { ol.classList.add('hidden'); }
    }, 10000); 
}

function resetKey() { if(confirm("Sign out of the dashboard?")) { localStorage.removeItem('monitor_master_key'); location.reload(); } }

async function toggleAudio() { 
    if (Tone.context.state !== 'running') await Tone.context.resume();
    audioEnabled = !audioEnabled; 
    const btn = document.getElementById('btnAudio'); 
    if(audioEnabled) { 
        btn.innerText = "üîä Sound On"; 
        btn.className = "px-3 py-1 rounded text-sm font-bold bg-green-600 text-white border border-green-500"; 
        synth.triggerAttackRelease("C5", "8n"); 
    } else { 
        btn.innerText = "üîá Sound Off"; 
        btn.className = "px-3 py-1 rounded text-sm font-bold bg-gray-700 text-gray-400 border border-gray-600"; 
    } 
}

function startAlertLoop() { 
    if(alertLoopInterval) return; 
    alertLoopInterval = setInterval(() => { 
        if(audioEnabled && synth) { 
            const now = Tone.now(); 
            synth.triggerAttackRelease("A5", "0.2", now); 
            synth.triggerAttackRelease("E6", "0.2", now + 0.3); 
        } 
        document.title = (document.title.includes("üö®")) ? "!! EMERGENCY !!" : "üö® ALERT";
    }, 1000); 
}

function stopAlertLoop() { if(alertLoopInterval) { clearInterval(alertLoopInterval); alertLoopInterval = null; } }

function acknowledgeAlert() { 
    workerData.forEach(w => { if(w.status.includes("EMERGENCY") || w.status.includes("PANIC") || w.status.includes("DURESS")) { acknowledgedAlerts.add(w.name); } }); 
    document.getElementById('fullScreenAlert').classList.add('hidden'); 
    stopAlertLoop(); renderGrid(); 
}

async function fetchData() { 
    if(!API_KEY) return;
    try {
        const resp = await fetch(`${SCRIPT_URL}?key=${encodeURIComponent(API_KEY)}&_cb=${Date.now()}`);
        const data = await resp.json();
        lastHeartbeat = Date.now();
        if(data.error) { if(data.error.includes("Key")) resetKey(); return; } 
        if(data.escalation_limit) escalationLimit = parseInt(data.escalation_limit); 
        handleData(data); 
    } catch (e) { console.error("Fetch Error:", e); }
}

function handleData(response) { 
    if (response.workers) { 
        allRows = response.workers; 
        workerData = processWorkers(response.workers); 
        document.getElementById('serverStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
        document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true}); 
        
        const unackedDuress = workerData.filter(w => w.status.includes("DURESS") && !acknowledgedAlerts.has(w.name)); 
        const unackedAlert = workerData.filter(w => (w.status.includes("EMERGENCY") || w.status.includes("PANIC")) && !acknowledgedAlerts.has(w.name)); 
        
        const alertBox = document.getElementById('fullScreenAlert'); 
        if(unackedDuress.length > 0) { 
            alertBox.classList.remove('hidden', 'alert-red'); alertBox.classList.add('alert-purple'); 
            document.getElementById('alertTitle').innerText = "DURESS ALARM (SILENT)"; 
            document.getElementById('alertIcon').innerText = "ü•∑"; 
            document.getElementById('alertNames').innerText = unackedDuress.map(w => w.name).join(", "); startAlertLoop(); 
        } else if(unackedAlert.length > 0) { 
            alertBox.classList.remove('hidden', 'alert-purple'); alertBox.classList.add('alert-red'); 
            document.getElementById('alertTitle').innerText = "EMERGENCY ALERT"; 
            document.getElementById('alertIcon').innerText = "üö®"; 
            document.getElementById('alertNames').innerText = unackedAlert.map(w => w.name).join(", "); startAlertLoop(); 
        } else { alertBox.classList.add('hidden'); stopAlertLoop(); } 
        
        if(currentView === 'MAP') { if(mapInstance) renderMap(); } else { renderGrid(); }
        renderLog(); 
    } 
}

function processWorkers(rows) { 
    const workers = {}; const history = {};
    rows.sort((a,b) => new Date(a.Timestamp) - new Date(b.Timestamp));
    rows.forEach(r => { 
        const name = r['Worker Name']; if (!name) return; 
        const timestamp = new Date(r['Timestamp']).getTime(); 
        if(!history[name]) history[name] = [];
        if(r['Last Known GPS']?.includes(',')) history[name].push(r['Last Known GPS']);
        
        let travelTarget = "";
        const status = r['Alarm Status'] || "";
        const notes = r['Notes'] || "";
        if (status.includes("TRAVELLING") && notes.toLowerCase().includes("travelling to:")) {
            travelTarget = notes.split(/travelling to:/i)[1]?.trim() || "unknown";
        }

        if (!workers[name] || timestamp > workers[name].timestamp) { 
            workers[name] = { 
                name, status, phone: r['Worker Phone Number'], 
                iceName: r['Emergency Contact Name'], icePhone: r['Emergency Contact Number'], 
                notes, location: r['Location Name'] || r['Location Address'] || "Unknown", 
                travelTarget, gps: r['Last Known GPS'], battery: r['Battery Level'], 
                dueTime: r['Anticipated Departure Time'], timestamp, wofExpiry: r['WOFExpiry'] 
            }; 
        } 
    }); 
    Object.values(workers).forEach(w => { w.history = history[w.name] ? history[w.name].slice(-10) : []; });
    return Object.values(workers); 
}

function renderGrid() { 
    const grid = document.getElementById('workerGrid'); const search = document.getElementById('searchBox').value.toLowerCase(); const now = Date.now(); grid.innerHTML = ''; let activeC = 0; let alertC = 0;
    
    workerData.sort((a,b) => getUrgencyScore(b, now) - getUrgencyScore(a, now));
    
    workerData.forEach(w => { 
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE') || w.status === 'DATA_ENTRY_ONLY'; 
        const isAlert = w.status.includes('EMERGENCY') || w.status.includes('PANIC'); 
        const isDuress = w.status.includes('DURESS'); 
        const isOverdue = w.status.includes('OVERDUE'); 
        if(!isSafe) activeC++; if(isAlert || isOverdue || isDuress) alertC++; 
        if (search && !w.name.toLowerCase().includes(search)) return; 
        if (currentFilter === 'ACTIVE' && isSafe && !isAlert && !isOverdue && !isDuress) return; 
        
        if(currentView === 'MAP') return; 

        let borderClass = 'bd-grey', dotClass = 'st-grey', statusText = w.status, timeClass = 'text-gray-500'; 
        let resolveBtn = ''; 
        let locLabel = w.status.includes("TRAVELLING") && w.travelTarget ? "Destination" : "Location";
        let locValue = locLabel === "Destination" ? w.travelTarget : w.location;

        if (isDuress) { 
            borderClass = 'bd-purple'; dotClass = 'st-purple'; resolveBtn = `<button onclick="openResolve('${escapeHtml(w.name)}')" class="mt-2 w-full bg-purple-700 text-white font-bold py-2 rounded text-xs">‚úÖ RESOLVE DURESS</button>`; 
        } else if (isAlert) { 
            borderClass = 'bd-red'; dotClass = 'st-red'; resolveBtn = `<button onclick="openResolve('${escapeHtml(w.name)}')" class="mt-2 w-full bg-green-700 text-white font-bold py-2 rounded text-xs">‚úÖ RESOLVE ALERT</button>`; 
        } else if (!isSafe) { 
            const due = new Date(w.dueTime).getTime(); 
            if (due > now || isNaN(due)) { borderClass = 'bd-green'; dotClass = 'st-ok'; } 
            else { 
                borderClass = 'bd-amber'; dotClass = 'st-amber'; timeClass = 'text-amber-500 font-bold'; 
                if(Math.floor((now - due)/60000) >= escalationLimit) { borderClass = 'bd-red'; dotClass = 'st-red'; } 
            } 
        } 
        
        const card = document.createElement('div'); card.className = `card p-4 ${borderClass}`; 
        card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 onclick="focusWorker('${w.gps}')" class="font-bold text-lg text-white truncate cursor-pointer hover:text-brand transition">${escapeHtml(w.name)}</h3><div class="${dotClass} status-dot mt-1.5 shrink-0 ml-2"></div></div><div class="space-y-1.5 text-xs text-gray-300"><div class="flex justify-between"><span>Status</span><span class="font-bold">${escapeHtml(statusText)}</span></div><div class="flex justify-between"><span>${locLabel}</span><span class="truncate w-24 text-right">${escapeHtml(locValue)}</span></div><div class="flex justify-between"><span>Due</span><span class="${timeClass}">${formatTime(w.dueTime)}</span></div></div><div class="mt-3 grid grid-cols-2 gap-2"><button onclick="focusWorker('${w.gps}')" class="text-brand bg-brand/20 py-2 rounded text-xs font-bold">üìç Map</button><a href="tel:${w.phone}" class="bg-gray-700 text-white text-center py-2 rounded text-xs font-bold">üìû Call</a></div>${resolveBtn}`; grid.appendChild(card); 
    }); 
    document.getElementById('activeCount').innerText = activeC; document.getElementById('alertCount').innerText = alertC; 
}

function escapeHtml(text) { return text ? String(text).replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "&quot;") : ""; }

function initMap() { 
    if(mapInstance) { mapInstance.invalidateSize(); return; } 
    mapInstance = L.map('mapView').setView([-41.2865, 174.7762], 13); 
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapInstance); 
    markersLayer = L.layerGroup().addTo(mapInstance); 
}

function renderMap() { 
    if(!mapInstance) return; markersLayer.clearLayers(); const bounds = L.latLngBounds(); let hasMarkers = false; 
    workerData.forEach(w => { 
        if(!w.gps || w.gps.length < 5) return; 
        const [lat, lng] = w.gps.replace(/[^0-9.,-]/g, '').split(',').map(Number);
        if(isNaN(lat)) return;
        const color = w.status.includes('EMERGENCY') ? 'red' : 'green';
        const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-icon ${color}"></div>`, iconSize: [24, 24] }); 
        L.marker([lat, lng], {icon}).bindPopup(`<b>${escapeHtml(w.name)}</b>`).addTo(markersLayer); 
        bounds.extend([lat, lng]); hasMarkers = true; 
    }); 
    if(hasMarkers && !mapInstance._isFocused) mapInstance.fitBounds(bounds, {padding:[50,50]}); 
}

function focusWorker(gps) { if(!gps) return; document.getElementById('btnMap').click(); setTimeout(() => { const [lat, lng] = gps.split(',').map(Number); mapInstance.flyTo([lat, lng], 17); }, 200); }
function toggleView(view) { currentView = view; document.getElementById('workerGrid').classList.toggle('hidden', view === 'MAP'); document.getElementById('mapView').classList.toggle('hidden', view === 'GRID'); if(view === 'MAP') { initMap(); renderMap(); } }
function renderLog() { 
    const list = document.getElementById('eventLogList'); 
    list.innerHTML = [...allRows].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp)).slice(0, 100).map(r => `<div class="text-[10px] mb-1"><span class="text-gray-500">${new Date(r['Timestamp']).toLocaleTimeString()}</span> <span class="text-white">${escapeHtml(r['Worker Name'])}: ${escapeHtml(r['Alarm Status'])}</span></div>`).join('');
}
function getUrgencyScore(w, now) { if (w.status.includes('DURESS')) return 2000; if (w.status.includes('EMERGENCY')) return 1000; return 0; }
function setFilter(f) { currentFilter = f; renderGrid(); }
function openResolve(name) { document.getElementById('resolveModal').classList.remove('hidden'); document.getElementById('resWorkerNameDisplay').innerText = name; }
function closeResolve() { document.getElementById('resolveModal').classList.add('hidden'); }
function submitResolution() { 
    const target = document.getElementById('resWorkerNameDisplay').innerText; 
    const note = document.getElementById('resNoteInput').value.trim(); 
    if(document.getElementById('resNameInput').value !== target) return alert("Name mismatch");
    const formData = new FormData(); 
    formData.append('action', 'resolve'); formData.append('key', API_KEY); formData.append('Worker Name', target); formData.append('Alarm Status', 'SAFE - HQ CLEARED'); formData.append('Notes', `[HQ]: ${note}`);
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData }).then(() => { closeResolve(); fetchData(); });
}
function exportSystemLog() {
    const csv = "Timestamp,Worker,Status,Location\n" + allRows.map(r => `"${r['Timestamp']}","${r['Worker Name']}","${r['Alarm Status']}","${r['Location Name']}"`).join("\n");
    const link = document.createElement("a"); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = "Safety_Log.csv"; link.click();
}
function formatTime(t) { const d = new Date(t); return isNaN(d) ? "--:--" : d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
function playSound(type) { if(audioEnabled && synth) { synth.triggerAttackRelease(type === 'offline' ? "A2" : "C5", "4n"); } }
</script>
</body>
</html>
