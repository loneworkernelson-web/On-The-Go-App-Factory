<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>%%ORG_NAME%% Monitor</title>
<link rel="icon" href="%%LOGO_URL%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  .main-layout { display: flex; flex: 1; overflow: hidden; }
  .grid-area { flex: 3; overflow-y: auto; padding: 1.5rem; }
  .log-area { flex: 1; background-color: #1e293b; border-left: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
  .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; position: relative; overflow: hidden; }
  .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
  .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
  .blink { animation: blinker 1.5s linear infinite; }
  @keyframes blinker { 50% { opacity: 0; } }
  .log-item { padding: 0.75rem; border-bottom: 1px solid #334155; font-size: 0.85rem; }
  .log-item:hover { background-color: #334155; }
  .log-time { color: #94a3b8; font-size: 0.75rem; font-family: monospace; display: block; margin-bottom: 2px; }
  .log-user { font-weight: bold; color: #fff; }
  .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; } 
  .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; } 
  .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.8s linear infinite; } 
  .st-grey { background-color: #64748b; } 
  .bd-green { border-color: #059669; border-width: 2px; }
  .bd-amber { border-color: #d97706; border-width: 2px; }
  .bd-red { border-color: #dc2626; border-width: 4px; }
  .bd-grey { border-color: #475569; opacity: 0.7; }
</style>
</head>
<body>
  <header class="bg-gray-900 border-b border-gray-800 p-4 shrink-0 z-20 shadow-lg">
    <div class="flex justify-between items-center mb-2">
        <div class="flex items-center gap-4">
          <img src="%%LOGO_URL%%" class="w-10 h-10 rounded bg-white object-contain p-1">
          <div>
            <h1 class="text-xl font-bold tracking-tight text-white">%%ORG_NAME%% <span class="text-gray-500 font-normal text-sm ml-2">Monitor v68.1</span></h1>
            <div class="flex items-center gap-2 text-xs text-gray-400">
               <span id="serverStatus" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Connecting...</span>
               <span>‚Ä¢ Updated: <span id="lastUpdate" class="text-gray-300 font-mono">--:--:--</span></span>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative">
                <input type="text" id="searchBox" placeholder="Filter Names..." class="bg-gray-800 text-white text-sm border border-gray-600 rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:border-blue-500 w-48" onkeyup="renderGrid()">
                <div class="absolute right-3 top-2.5 text-gray-500">üîç</div>
            </div>
            <select id="viewSelector" class="bg-gray-800 text-white text-sm border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-bold" onchange="renderGrid()">
                <option value="ACTIVE">üü¢ Active Workers</option>
                <option value="ALL">üìã All History</option>
                <option value="ALERTS">üö® Alerts Only</option>
            </select>
        </div>
        <div class="flex gap-6 border-l border-gray-700 pl-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-400 leading-none" id="activeCount">0</div>
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Active</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-500 leading-none" id="alertCount">0</div>
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Alerts</div>
            </div>
        </div>
    </div>
    
    <div id="loadWarning" class="hidden rounded px-3 py-2 text-xs font-bold flex items-center justify-between">
        <span id="loadMsg"></span>
        <span class="opacity-80 font-normal">System bottleneck likely. Please stagger shifts.</span>
    </div>

  </header>
  <div class="main-layout">
      <div class="grid-area">
          <div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4"></div>
          <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-gray-600"><div class="text-4xl mb-2">üò¥</div><p>No active workers.</p></div>
      </div>
      <div class="log-area">
          <div class="p-3 bg-gray-800 border-b border-gray-700 font-bold text-xs text-gray-400 uppercase tracking-wider sticky top-0">Live Activity Log</div>
          <div id="eventLogList" class="flex-1 overflow-y-auto"></div>
      </div>
  </div>
<script>
const SCRIPT_URL = "%%SHEET_URL%%";
let workerData = [];
let allRows = [];
let escalationLimit = 15;
// THRESHOLDS: Adjust here if needed
const LOAD_WARN = 20;
const LOAD_CRIT = 40;

window.onload = () => { fetchData(); setInterval(fetchData, 10000); setInterval(renderGrid, 1000); };
function fetchData() {
    const script = document.createElement('script');
    const cbName = 'cb_' + Date.now();
    window[cbName] = function(data) {
        if(data.escalation_limit) escalationLimit = parseInt(data.escalation_limit);
        handleData(data);
        document.body.removeChild(script);
        delete window[cbName];
    };
    script.src = `${SCRIPT_URL}?callback=${cbName}&t=${Date.now()}`;
    document.body.appendChild(script);
}
function handleData(response) {
    const statusEl = document.getElementById('serverStatus');
    if (response && (response.workers || response.status === 'online')) {
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
        statusEl.classList.replace('text-red-400', 'text-green-400');
    } else {
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Error';
        statusEl.classList.add('text-red-400');
    }
    if (response.workers) {
        allRows = response.workers; 
        workerData = processWorkers(response.workers);
        document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
        renderGrid();
        renderLog();
    }
}
function processWorkers(rows) {
    const workers = {};
    rows.forEach(r => {
        const name = r['Worker Name']; if (!name) return;
        const timestamp = new Date(r['Timestamp']).getTime();
        if (!workers[name] || timestamp > workers[name].timestamp) {
            workers[name] = { name: name, status: r['Alarm Status'], phone: r['Worker Phone Number'], iceName: r['Emergency Contact Name'], icePhone: r['Emergency Contact Number'], notes: r['Notes'], location: r['Location Name'] || r['Location Address'] || "Unknown", gps: r['Last Known GPS'], battery: r['Battery Level'], dueTime: r['Anticipated Departure Time'], wofExpiry: r['WOFExpiry'], timestamp: timestamp };
        }
    });
    return Object.values(workers);
}
function renderGrid() {
    const grid = document.getElementById('workerGrid');
    const search = document.getElementById('searchBox').value.toLowerCase();
    const filter = document.getElementById('viewSelector').value;
    const now = Date.now();
    grid.innerHTML = '';
    let activeC = 0; let alertC = 0; let visibleCount = 0;
    workerData.sort((a,b) => getUrgencyScore(b, now) - getUrgencyScore(a, now));
    
    // Count Active for Load Warning
    const totalActive = workerData.filter(w => w.status !== 'DEPARTED' && w.status !== 'COMPLETED').length;
    updateLoadWarning(totalActive);

    workerData.forEach(w => {
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE');
        const isAlert = w.status.includes('EMERGENCY') || w.status.includes('PANIC') || w.status.includes('OVERDUE');
        if(!isSafe) activeC++; if(isAlert) alertC++;
        if (search && !w.name.toLowerCase().includes(search)) return;
        if (filter === 'ACTIVE' && isSafe) return;
        if (filter === 'ALERTS' && !isAlert) return;
        visibleCount++;
        let borderClass = 'bd-grey', dotClass = 'st-grey', statusText = w.status, timeClass = 'text-gray-500';
        if (isAlert) { borderClass = 'bd-red'; dotClass = 'st-red'; timeClass = 'text-red-400 font-bold'; } 
        else if (!isSafe) {
            const due = new Date(w.dueTime).getTime();
            if (!isNaN(due)) {
                if (due > now) { borderClass = 'bd-green'; dotClass = 'st-ok'; } 
                else {
                    const minsOver = (now - due) / 60000;
                    if (minsOver < escalationLimit) { borderClass = 'bd-amber'; dotClass = 'st-amber'; statusText = `OVERDUE (${Math.floor(minsOver)}m)`; } 
                    else { borderClass = 'bd-red'; dotClass = 'st-red'; statusText = "CRITICAL OVERDUE"; }
                }
            } else { borderClass = 'bd-green'; dotClass = 'st-ok'; }
        }
        
        const card = document.createElement('div');
        card.className = `card p-4 ${borderClass}`;
        
        let batDisplay = w.battery || '--';
        let batClass = getBatColor(batDisplay);
        
        // v67.3: WOF Badge Logic
        if(w.wofExpiry) {
            const wofDate = new Date(w.wofExpiry);
            const daysUntil = (wofDate.getTime() - now) / 86400000;
            if(daysUntil < 0) { batClass = 'text-red-500 font-bold blink'; batDisplay = '‚ö†Ô∏è WOF EXPIRED'; }
            else if(daysUntil < 14) { batClass = 'text-orange-500 font-bold'; batDisplay = '‚ö†Ô∏è WOF DUE'; }
        }

        card.innerHTML = `
            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-white truncate w-full">${w.name}</h3><div class="${dotClass} status-dot mt-1.5 shrink-0 ml-2"></div></div>
            <div class="space-y-1.5 text-xs text-gray-300">
                <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Status</span><span class="font-bold">${statusText}</span></div>
                <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Location</span><span class="truncate w-24 text-right" title="${w.location}">${w.location}</span></div>
                <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Due</span><span class="${timeClass}">${formatTime(w.dueTime)}</span></div>
                <div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Battery</span><span class="${batClass}">${batDisplay}</span></div>
                ${w.iceName ? `<div class="mt-2 pt-2 border-t border-gray-700"><div class="flex justify-between items-center"><span class="text-[10px] text-red-400 font-bold uppercase">ICE: ${w.iceName}</span><a href="tel:${w.icePhone}" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-2 py-1 rounded text-[10px] font-bold">üìû Call</a></div></div>` : ''}
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2"><a href="https://www.google.com/maps/search/?api=1&query=${w.gps}" target="_blank" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 text-center py-2 rounded text-xs font-bold transition">üìç Map</a><a href="tel:${w.phone}" class="bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold transition">üìû Worker</a></div>`;
        grid.appendChild(card);
    });
    document.getElementById('activeCount').innerText = activeC;
    document.getElementById('alertCount').innerText = alertC;
    document.getElementById('emptyState').classList.toggle('hidden', visibleCount > 0);
}

function updateLoadWarning(count) {
    const el = document.getElementById('loadWarning');
    const msg = document.getElementById('loadMsg');
    
    if (count > LOAD_CRIT) {
        el.className = "rounded px-3 py-2 text-xs font-bold flex items-center justify-between mt-2 bg-red-900 text-red-200 border border-red-500 animate-pulse";
        msg.innerText = `‚ö†Ô∏è CRITICAL LOAD (${count} Users)`;
        el.classList.remove('hidden');
    } else if (count > LOAD_WARN) {
        el.className = "rounded px-3 py-2 text-xs font-bold flex items-center justify-between mt-2 bg-yellow-900 text-yellow-200 border border-yellow-500";
        msg.innerText = `‚ö†Ô∏è HIGH TRAFFIC (${count} Users)`;
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

function renderLog() {
    const list = document.getElementById('eventLogList');
    const sorted = [...allRows].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp));
    const top = sorted.slice(0, 50);
    let html = '';
    top.forEach(r => {
        const time = new Date(r['Timestamp']).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        let color = "text-gray-300";
        if(r['Alarm Status'].includes("EMERGENCY")) color = "text-red-400 font-bold";
        else if(r['Alarm Status'] === 'ON SITE') color = "text-yellow-400";
        else if(r['Alarm Status'] === 'DEPARTED') color = "text-green-400";
        html += `<div class="log-item"><span class="log-time">${time}</span><div class="flex justify-between"><span class="log-user">${r['Worker Name']}</span><span class="${color}">${r['Alarm Status']}</span></div><div class="log-action truncate text-gray-500 text-[10px]">${r['Location Name']||"Unknown"}</div></div>`;
    });
    list.innerHTML = html;
}
function getUrgencyScore(w, now) {
    if (w.status.includes('EMERGENCY')) return 1000;
    const due = new Date(w.dueTime).getTime();
    if (!isNaN(due) && due < now && w.status !== 'DEPARTED') return 500 + (now - due); 
    if (w.status === 'ON SITE' || w.status === 'TRAVELLING') return 100;
    return 0;
}
function getBatColor(b) { const val = parseInt(b); if(val < 20) return 'text-red-500 font-bold blink'; return val < 50 ? 'text-yellow-500' : 'text-green-500'; }
function formatTime(t) { if(!t) return "--:--"; const d = new Date(t); return isNaN(d) ? "--:--" : d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
</script>
</body>
</html>
