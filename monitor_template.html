<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>%%ORG_NAME%% Monitor</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
body{font-family:'Inter',sans-serif}
@keyframes flash-red{0%,100%{background:#991b1b}50%{background:#ef4444}}
@keyframes flash-purple{0%,100%{background:#5b21b6}50%{background:#a78bfa}}
.flashing-alert{animation:flash-red 1s infinite}
.flashing-duress{animation:flash-purple 1s infinite}
</style>
</head>
<body class="bg-gray-900 text-white h-full flex flex-col overflow-hidden">

<div id="setupPage" class="h-full flex items-center justify-center p-4">
  <div class="text-center space-y-4 max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-2xl">
    <h1 class="text-3xl font-bold text-blue-400">Security Login</h1>
    <p class="text-gray-400 mb-4">Enter Secret Key to monitor %%ORG_NAME%%</p>
    <input type="password" id="secretKeyInput" class="w-full bg-gray-900 p-4 rounded text-white border border-gray-600 focus:border-blue-500 outline-none" placeholder="Enter Secret Key">
    <button onclick="login()" class="w-full bg-blue-600 p-4 rounded font-bold hover:bg-blue-500 transition shadow-lg">Connect Securely</button>
  </div>
</div>

<div id="dashboardPage" class="hidden h-full flex flex-col">
  <header class="bg-gray-800 p-4 shadow-lg flex justify-between items-center z-10">
    <div class="flex items-center gap-2">
      <img src="%%LOGO_URL%%" class="w-8 h-8 rounded bg-white object-contain" onerror="this.style.display='none'">
      <h1 class="text-2xl font-bold text-blue-400">%%ORG_NAME%% Monitor</h1>
    </div>
    <div class="flex items-center gap-3">
      <span id="status" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></span>
      <span id="lastUpd" class="text-xs text-gray-400">Connecting...</span>
      <button onclick="logout()" class="p-2 text-gray-400 hover:text-white border border-gray-600 rounded">Logout</button>
    </div>
  </header>
  
  <div class="bg-gray-800 border-t border-gray-700 p-2">
    <details>
      <summary class="text-xs text-gray-400 cursor-pointer hover:text-white">Event Log</summary>
      <div id="logPanel" class="text-xs text-gray-500 h-24 overflow-y-auto mt-2 p-2 bg-black rounded font-mono"></div>
    </details>
  </div>

  <main id="workerList" class="flex-1 p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pb-20"></main>
</div>

<div id="alertOverlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-8 bg-red-900 text-white">
  <h2 class="text-9xl font-bold animate-pulse mb-4">ALERT</h2>
  <div id="alertDetails" class="text-3xl mt-8 font-mono text-center"></div>
  <button onclick="ackAlert()" class="mt-12 bg-white text-black font-bold py-6 px-12 rounded-xl text-2xl shadow-2xl hover:scale-105 transition">ACKNOWLEDGE ALERT</button>
</div>

<script>
const URL = "%%SHEET_URL%%";
let SECRET = "";
let pollInt, alarm;

function login() {
  const k = document.getElementById('secretKeyInput').value;
  if(k){ 
    SECRET=k; 
    document.getElementById('setupPage').classList.add('hidden'); 
    document.getElementById('dashboardPage').classList.remove('hidden'); 
    document.getElementById('dashboardPage').classList.add('flex'); 
    fetchData(); 
    pollInt=setInterval(fetchData,15000); 
  }
}

function logout(){ 
  clearInterval(pollInt); 
  location.reload(); 
}

function log(msg) {
  const p = document.createElement('div');
  p.innerText = new Date().toLocaleTimeString() + ": " + msg;
  document.getElementById('logPanel').prepend(p);
}

function fetchData() {
  const s = document.createElement('script');
  const cb = 'cb_'+Date.now();
  
  window[cb] = (data) => {
    delete window[cb]; 
    document.body.removeChild(s);
    
    if(data.status==='error') { 
      alert('Access Denied. Check Key.'); 
      logout(); 
      return; 
    }
    
    render(data); 
    document.getElementById('status').className='w-3 h-3 rounded-full bg-green-500'; 
    document.getElementById('lastUpd').innerText=new Date().toLocaleTimeString();
  };
  
  s.src = URL + '?callback='+cb+'&token='+encodeURIComponent(SECRET);
  s.onerror = () => { 
    document.getElementById('status').className='w-3 h-3 rounded-full bg-red-500'; 
    log("Connection Failed");
  };
  document.body.appendChild(s);
}

function render(data) {
  const list = document.getElementById('workerList'); 
  list.innerHTML='';
  
  // Filter active workers
  const active = data.filter(w=>w['Alarm Status']!=='DEPARTED' && w['Alarm Status']!=='SAFE - MANUALLY CLEARED' && w['Alarm Status']!=='DATA_ENTRY_ONLY');
  
  if(active.length === 0) {
    list.innerHTML = "<div class='col-span-full text-center text-gray-600 mt-20 text-xl'>No Active Workers</div>";
    return;
  }

  active.forEach(w=>{
    const div = document.createElement('div');
    const isAlert = w['Alarm Status'].match(/EMERGENCY|DURESS|MISSED|ESCALATION|ALERT/);
    
    if(isAlert) playAlarm(w);
    
    // Style card based on status
    let bgClass = 'bg-gray-700 border-blue-500 text-gray-200';
    if(isAlert) bgClass = 'bg-red-900 border-red-500 text-white animate-pulse';
    
    div.className = `p-6 rounded-xl shadow-lg border-l-8 ${bgClass} flex flex-col justify-between`;
    
    div.innerHTML = `
      <div>
        <div class="flex justify-between items-start">
          <div class="font-bold text-2xl">${w['Worker Name']}</div>
          <div class="text-xs font-mono opacity-50">${w['Timestamp'].split('T')[1]?.substring(0,5) || ''}</div>
        </div>
        <div class="text-lg opacity-75 mb-4">${w['Location Name']}</div>
        <div class="mt-2 font-mono font-bold bg-black/20 p-2 rounded text-center">${w['Alarm Status']}</div>
      </div>
      <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center text-sm">
        <a href="tel:${w['Worker Phone']}" class="hover:text-blue-300">üìû Call</a>
        <a target="_blank" href="http://maps.google.com/?q=${w['Last Known GPS']}" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500 text-white">üìç Map</a>
      </div>
    `;
    list.appendChild(div);
  });
}

async function playAlarm(w) {
  const ov = document.getElementById('alertOverlay');
  if(ov.classList.contains('hidden')){
    ov.classList.remove('hidden');
    ov.className = w['Alarm Status'].includes('DURESS') ? 'fixed inset-0 z-50 flex flex-col items-center justify-center p-8 flashing-duress text-white' : 'fixed inset-0 z-50 flex flex-col items-center justify-center p-8 flashing-alert text-white';
    
    document.getElementById('alertDetails').innerHTML = `
      <p>${w['Worker Name']}</p>
      <p class="mt-4 text-xl">${w['Location Name']}</p>
      <p class="mt-8 font-mono bg-black/30 p-4 rounded">${w['Alarm Status']}</p>
    `;
    
    await Tone.start();
    alarm = new Tone.Oscillator(440, "square").toDestination().start();
  }
}

function ackAlert(){
  document.getElementById('alertOverlay').classList.add('hidden');
  if(alarm) alarm.stop();
}
</script>
</body>
</html>
