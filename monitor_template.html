<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%%ORG_NAME%% Monitor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --brand-primary: #1e40af;
            --brand-accent: #3b82f6;
        }
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .grid-area { flex: 1; overflow-y: auto; padding: 1.5rem; position: relative; }
        .log-area { flex: 0 0 300px; background-color: #1e293b; border-left: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
        .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; } 
        .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; } 
        .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.5s linear infinite; } 
        .st-purple { background-color: #d946ef; box-shadow: 0 0 15px #d946ef; animation: blinker 0.3s linear infinite; }
        .st-grey { background-color: #64748b; } 
        .bd-green { border-color: #059669; border-width: 2px; }
        .bd-amber { border-color: #d97706; border-width: 2px; }
        .bd-red { border-color: #dc2626; border-width: 4px; }
        .bd-purple { border-color: #c026d3; border-width: 5px; }
        .bd-grey { border-color: #475569; opacity: 0.7; }
        
        /* BRAND THEME CLASSES */
        .btn-brand { background-color: var(--brand-primary); }
        .btn-brand:hover { filter: brightness(1.2); }
        .border-brand { border-color: var(--brand-primary); }
        .text-brand { color: var(--brand-accent); }
        
        #fullScreenAlert { z-index: 50; }
        .alert-red { animation: pulseRed 1s infinite; }
        .alert-purple { animation: pulsePurple 1s infinite; }
        @keyframes pulseRed { 0% { background-color: rgba(220, 38, 38, 0.9); } 50% { background-color: rgba(153, 27, 27, 0.95); } 100% { background-color: rgba(220, 38, 38, 0.9); } }
        @keyframes pulsePurple { 0% { background-color: rgba(147, 51, 234, 0.9); } 50% { background-color: rgba(107, 33, 168, 0.95); } 100% { background-color: rgba(147, 51, 234, 0.9); } }
        #mapView { background: #020617; z-index: 1; width: 100%; height: 100%; }
        .custom-div-icon { background: transparent; border: none; } 
        .map-icon { width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); display: block; }
        .map-icon.red { background: #ef4444; animation: blinker 0.8s linear infinite; box-shadow: 0 0 20px #ef4444; }
        .map-icon.purple { background: #d946ef; animation: blinker 0.3s linear infinite; box-shadow: 0 0 25px #d946ef; }
        .map-icon.green { background: #10b981; }
        .map-icon.amber { background: #f59e0b; }
        .map-icon.grey { background: #64748b; }
#audioGate {
    position: fixed; inset: 0; background: #111827; z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; font-family: sans-serif; text-align: center; padding: 20px;
}
.gate-card { background: #1f2937; padding: 40px; border-radius: 16px; border: 1px solid #374151; max-width: 400px; }
.btn-unlock { background: #2563eb; color: white; padding: 15px 30px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; font-size: 1.1rem; }
.btn-unlock:hover { background: #1d4ed8; }
.audio-tip { margin-top: 30px; font-size: 0.8rem; color: #9ca3af; text-align: left; line-height: 1.4; border-top: 1px solid #374151; pt-4; }
    </style>
</head>
<body>
    <div id="audioGate" class="fixed inset-0 z-[100] bg-gray-900 flex items-center justify-center p-4">
    <div class="gate-card bg-gray-800 border-2 border-brand rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
        <h1 class="text-3xl font-bold text-white mb-4 text-brand">%%ORG_NAME%% Monitor</h1>
        <p class="text-gray-400 mb-6">Interaction is required to enable emergency audio alerts.</p>
        
        <button onclick="unlockAudio()" class="w-full btn-brand text-white font-black py-4 rounded-xl shadow-2xl text-xl transition transform hover:scale-105">
            üîä ACTIVATE AUDIO & START
        </button>

        <div class="audio-tip mt-8 text-left border-t border-gray-700 pt-6">
            <p class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-3">üîß Reliability Tip</p>
            <p class="text-xs text-gray-400 leading-relaxed mb-3">To ensure alarms sound even if the dashboard is left untouched, allow sound permissions in your browser:</p>
            <ol class="text-[11px] text-gray-500 space-y-2 list-decimal ml-4">
                <li>Click the <strong>Lock Icon</strong> üîí (left of the URL).</li>
                <li>Select <strong>Site Settings</strong>.</li>
                <li>Find <strong>Sound</strong> and set it to <strong>Allow</strong>.</li>
            </ol>
        </div>
    </div>
</div>

    <div id="connectionOverlay" class="hidden fixed inset-0 z-[95] bg-gray-900/90 flex items-center justify-center backdrop-blur-md transition-opacity duration-500">
        <div class="bg-gray-800 border-2 border-red-600 p-8 rounded-xl shadow-2xl text-center max-w-sm mx-4">
            <div class="text-5xl mb-6 animate-pulse">üì°</div>
            <h2 class="text-3xl font-bold text-white mb-2">Connection Lost</h2>
            <p class="text-red-400 font-mono text-sm mb-4">SYSTEM OFFLINE</p>
            <p class="text-gray-400 text-xs">The dashboard is not receiving updates. Check internet connection.</p>
        </div>
    </div>

    <div id="authModal" class="hidden fixed inset-0 z-[90] bg-gray-900/95 flex items-center justify-center p-4">
        <div class="bg-gray-800 border-2 border-brand rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
            <div class="text-6xl mb-4">üîê</div>
            <h1 class="text-2xl font-bold text-white mb-2">Security Access</h1>
            <p class="text-gray-400 text-sm mb-6">Enter your Organisation Secret Key.</p>
            <input type="password" id="authKeyInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-4 text-white text-center text-lg tracking-widest mb-6 focus:border-brand outline-none" placeholder="Enter Secret Key">
            <button onclick="saveAuthKey()" class="w-full btn-brand text-white font-bold py-4 rounded-lg shadow-lg text-lg">Unlock Monitor</button>
        </div>
    </div>

    <div id="fullScreenAlert" class="hidden fixed inset-0 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
        <div class="text-9xl mb-4" id="alertIcon">üö®</div>
        <h1 class="text-6xl font-black text-white mb-4 drop-shadow-md" id="alertTitle">EMERGENCY ALERT</h1>
        <h2 id="alertNames" class="text-4xl font-bold text-white bg-black/30 px-6 py-2 rounded mb-8">Worker Name</h2>
        <button onclick="acknowledgeAlert()" class="bg-white text-gray-900 font-black text-2xl py-6 px-12 rounded-full shadow-2xl hover:scale-105 transition border-4 border-gray-900">ACKNOWLEDGE ALARM</button>
        <p class="text-white mt-6 font-bold opacity-80">Clicking this silences the alarm but DOES NOT clear the emergency.</p>
    </div>

    <div id="resolveModal" class="hidden fixed inset-0 z-40 bg-black/90 flex items-center justify-center p-4">
        <div class="bg-gray-800 border-2 border-green-600 rounded-xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-white mb-2">Resolve Emergency</h2>
            <p class="text-gray-400 text-sm mb-4">You are manually clearing <span id="resWorkerNameDisplay" class="font-bold text-white"></span>.</p>
            <div class="space-y-4">
                <div><label for="resNameInput" class="block text-xs uppercase font-bold text-gray-500 mb-1">1. Confirm Worker Name</label><input type="text" id="resNameInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white" placeholder="Type name exactly..."></div>
                <div><label for="resNoteInput" class="block text-xs uppercase font-bold text-gray-500 mb-1">2. Resolution Note (Log)</label><textarea id="resNoteInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white h-24" placeholder="e.g. Spoke to worker, false alarm."></textarea></div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="closeResolve()" class="flex-1 bg-gray-700 text-white font-bold py-3 rounded">Cancel</button><button onclick="submitResolution()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg">‚úÖ MARK SAFE</button></div>
        </div>
    </div>

    <header class="bg-gray-900 border-b border-gray-800 p-4 shrink-0 z-20 shadow-lg">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-4">
                <img id="orgLogo" src="%%LOGO_URL%%" class="w-10 h-10 rounded bg-white object-contain p-1" onerror="this.style.display='none'">
                <div><h1 class="text-xl font-bold tracking-tight text-white">%%ORG_NAME%% <span class="text-gray-500 font-normal text-sm ml-2">Monitor v79.4</span></h1><div class="flex items-center gap-2 text-xs text-gray-400"><span id="serverStatus" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Connecting...</span><span>‚Ä¢ Updated: <span id="lastUpdate" class="text-gray-300 font-mono">--:--:--</span></span></div></div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="resetKey()" class="text-xs text-gray-600 hover:text-gray-400 underline">üîë Reset Key</button>
                <button onclick="exportSystemLog()" class="text-xs text-blue-400 hover:text-blue-300 underline">üìä Export Daily Log</button>
                <button id="btnAudio" onclick="toggleAudio()" class="px-3 py-1 rounded text-sm font-bold bg-green-600 text-white border border-green-500 hover:bg-green-500 transition">üîä Sound On</button>
                <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600 ml-4"><button onclick="setFilter('ACTIVE')" id="btnFilterActive" class="px-3 py-1 rounded text-xs font-bold btn-brand text-white shadow transition">üü¢ Active</button><button onclick="setFilter('ALL')" id="btnFilterAll" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition">üìã All</button></div>
                <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600"><button onclick="toggleView('GRID')" id="btnGrid" class="px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white shadow">‚äû Grid</button><button onclick="toggleView('MAP')" id="btnMap" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition">üó∫Ô∏è Map</button></div>
                <div class="relative"><input type="text" id="searchBox" placeholder="Filter..." class="bg-gray-800 text-white text-sm border border-gray-600 rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:border-brand w-32" onkeyup="renderGrid()"></div>
            </div>
            <div class="flex gap-6 border-l border-gray-700 pl-6"><div class="text-center"><div class="text-2xl font-bold text-green-400 leading-none" id="activeCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Active</div></div><div class="text-center"><div class="text-2xl font-bold text-red-500 leading-none" id="alertCount">0</div><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Alerts</div></div></div>
        </div>
        <div id="loadWarning" class="hidden rounded px-3 py-2 text-xs font-bold flex items-center justify-between"><span id="loadMsg"></span><span class="opacity-80 font-normal">System bottleneck likely. Please stagger shifts.</span></div>
    </header>
    <div class="main-layout">
        <div class="grid-area"><div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4"></div><div id="mapView" class="hidden h-full w-full rounded-xl overflow-hidden shadow-inner border border-gray-700 bg-gray-900 relative"></div><div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-gray-600"><div class="text-4xl mb-2">üò¥</div><p>No active workers.</p></div></div>
        <div class="log-area"><div class="p-2 bg-gray-800 border-b border-gray-700 font-bold text-[10px] text-gray-400 uppercase tracking-wider sticky top-0">Activity Log</div><div id="eventLogList" class="flex-1 overflow-y-auto px-2 py-2 space-y-1"></div></div>
    </div>
<script>
const SCRIPT_URL = "%%SHEET_URL%%";
const VEHICLE_TERM = "%%VEHICLE_TERM%%"; 
let API_KEY = localStorage.getItem('otg_monitor_key'); 
let workerData = []; let allRows = []; let escalationLimit = 15; let mapInstance = null, markersLayer = null, currentView = 'GRID'; let currentFilter = 'ACTIVE'; let audioEnabled = true, synth = null; let acknowledgedAlerts = new Set(); let alertLoopInterval = null;
let lastHeartbeat = Date.now(); 

// NEW: SMART BRANDING SYNC
function applyBrandColors() {
    const primary = localStorage.getItem('otg_theme_primary');
    const accent = localStorage.getItem('otg_theme_accent');
    if (primary) document.documentElement.style.setProperty('--brand-primary', primary);
    if (accent) document.documentElement.style.setProperty('--brand-accent', accent);
}

function startApp() {
    applyBrandColors(); 
    if(!API_KEY) { 
        document.getElementById('authModal').classList.remove('hidden'); 
    }
}

function startPolling() {
    // Initial fetch
    fetchData(); 
    
    // 10-second data refresh
    setInterval(fetchData, 10000); 
    
    // 1-second UI refresh (for timers/urgency)
    setInterval(renderGrid, 1000);

    // Audio Keep-Alive: Browsers often suspend audio contexts on inactive tabs.
    // This "silent oscillation" keeps the hardware channel open.
    setInterval(() => {
        if (audioEnabled && synth) {
            try { 
                // Play a sub-audible frequency to keep the context "Running"
                synth.triggerAttackRelease("C1", "1n", Tone.now(), 0.001); 
            } catch(e) { console.warn("Audio keep-alive failed", e); }
        }
    }, 25000);

    // Connection Watchdog
    setInterval(() => {
        const timeSince = Date.now() - lastHeartbeat;
        const ol = document.getElementById('connectionOverlay');
        if (timeSince > 60000) { // Reduced to 60s for tighter admin awareness
            ol.classList.remove('hidden');
            if(audioEnabled && synth) playSound('offline');
        } else {
            ol.classList.add('hidden');
        }
    }, 10000); 
}

function saveAuthKey() { 
    const k = document.getElementById('authKeyInput').value.trim(); 
    if(k.length < 3) return alert("Invalid Key"); 
    localStorage.setItem('otg_monitor_key', k); API_KEY = k; 
    document.getElementById('authModal').classList.add('hidden'); 
    startPolling();
}

function resetKey() { if(confirm("Reset the Security Key?")) { localStorage.removeItem('otg_monitor_key'); location.reload(); } }

async function toggleAudio() { 
    if(!synth) { 
        await Tone.start(); 
        synth = new Tone.Synth().toDestination(); 
    } 
    
    // Ensure the context is 'running' (PC Browser requirement)
    if (Tone.context.state !== 'running') {
        await Tone.context.resume();
    }

    audioEnabled = !audioEnabled; 
    const btn = document.getElementById('btnAudio'); 
    if(audioEnabled) { 
        btn.innerText = "üîä Sound On"; 
        btn.className = "px-3 py-1 rounded text-sm font-bold bg-green-600 text-white border border-green-500 hover:bg-green-500 transition"; 
        synth.triggerAttackRelease("C5", "8n"); 
    } else { 
        btn.innerText = "üîá Sound Off"; 
        btn.className = "px-3 py-1 rounded text-sm font-bold bg-gray-700 text-gray-400 border border-gray-600 hover:bg-gray-600 transition"; 
    } 
}

function startAlertLoop() { 
    if(alertLoopInterval) return; 
    
    // Safety check: Ensure audio is enabled and engine is running
    if(audioEnabled && synth) {
        if (Tone.context.state !== 'running') Tone.context.resume();
    }

    alertLoopInterval = setInterval(() => { 
        if(audioEnabled && synth) { 
            const now = Tone.now(); 
            // IMPROVED: High-visibility dual-tone siren
            synth.triggerAttackRelease("A5", "0.2", now); 
            synth.triggerAttackRelease("E6", "0.2", now + 0.3); 
        } 
        document.title = (document.title.includes("üö®")) ? "!! EMERGENCY !!" : "üö® %%ORG_NAME%% ALERT";
    }, 1000); 
}

function stopAlertLoop() { if(alertLoopInterval) { clearInterval(alertLoopInterval); alertLoopInterval = null; } }

function acknowledgeAlert() { 
    workerData.forEach(w => { if(w.status.includes("EMERGENCY") || w.status.includes("PANIC") || w.status.includes("DURESS")) { acknowledgedAlerts.add(w.name); } }); 
    document.getElementById('fullScreenAlert').classList.add('hidden'); 
    stopAlertLoop(); renderGrid(); 
}

function fetchData() { 
    if(SCRIPT_URL.includes("%%")) return console.error("Configuration Missing.");

    const script = document.createElement('script'); 
    const cbName = 'cb_' + Date.now(); 
    
    // INCREASED TIMEOUT: 15 seconds to allow for slow Google Script wake-ups
    const timeout = setTimeout(() => {
        if (window[cbName]) {
            console.warn("Fetch Timeout: Checking Connection...");
            // We DON'T delete the callback here; we let it stay in case it arrives late
            try { document.body.removeChild(script); } catch(e) {}
        }
    }, 15000);

    window[cbName] = function(data) { 
        clearTimeout(timeout);
        lastHeartbeat = Date.now(); 
        
        if(data.error) { 
            if(data.error.includes("Key")) resetKey();
            return; 
        } 
        
        if(data.escalation_limit) escalationLimit = parseInt(data.escalation_limit); 
        handleData(data); 
        
        // CLEANUP: Only delete once the data has actually been handled
        try { document.body.removeChild(script); } catch(e) {}
        setTimeout(() => { delete window[cbName]; }, 1000); 
    }; 

    script.onerror = () => {
        clearTimeout(timeout);
        console.error("Network Error: Failed to reach Google Backend.");
        try { document.body.removeChild(script); } catch(e) {}
        delete window[cbName];
    };

    script.src = `${SCRIPT_URL}?callback=${cbName}&key=${encodeURIComponent(API_KEY)}&_cb=${Date.now()}`; 
    document.body.appendChild(script); 
}

function handleData(response) { 
    if (response && (response.workers || response.status === 'online')) { document.getElementById('serverStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online'; } 
    if (response.workers) { 
        allRows = response.workers; 
        workerData = processWorkers(response.workers); 
        document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true}); 
        
        // FIXED: Priority logic - Duress (Silent) always takes visual precedence
        const duressWorkers = workerData.filter(w => w.status.includes("DURESS") && !w.status.includes("SAFE")); 
        const alertWorkers = workerData.filter(w => (w.status.includes("EMERGENCY") || w.status.includes("PANIC")) && !w.status.includes("SAFE")); 
        
        const unackedDuress = duressWorkers.filter(w => !acknowledgedAlerts.has(w.name)); 
        const unackedAlert = alertWorkers.filter(w => !acknowledgedAlerts.has(w.name)); 
        
        const alertBox = document.getElementById('fullScreenAlert'); 
        if(unackedDuress.length > 0) { 
            alertBox.classList.remove('hidden'); alertBox.classList.remove('alert-red'); alertBox.classList.add('alert-purple'); 
            document.getElementById('alertTitle').innerText = "DURESS ALARM (SILENT)"; 
            document.getElementById('alertIcon').innerText = "ü•∑"; 
            document.getElementById('alertNames').innerText = unackedDuress.map(w => w.name).join(", "); startAlertLoop(); 
        } else if(unackedAlert.length > 0) { 
            alertBox.classList.remove('hidden'); alertBox.classList.remove('alert-purple'); alertBox.classList.add('alert-red'); 
            document.getElementById('alertTitle').innerText = "EMERGENCY ALERT"; 
            document.getElementById('alertIcon').innerText = "üö®"; 
            document.getElementById('alertNames').innerText = unackedAlert.map(w => w.name).join(", "); startAlertLoop(); 
        } else { alertBox.classList.add('hidden'); stopAlertLoop(); } 
        
        if(currentView === 'MAP') { if(mapInstance) renderMap(); } else { renderGrid(); }
        renderLog(); 
    } 
}

function processWorkers(rows) { 
    const workers = {}; 
    const history = {};
    rows.sort((a,b) => new Date(a.Timestamp) - new Date(b.Timestamp));
    rows.forEach(r => { 
        const name = r['Worker Name']; if (!name) return; 
        const timestamp = new Date(r['Timestamp']).getTime(); 
        if(!history[name]) history[name] = [];
        if(r['Last Known GPS'] && r['Last Known GPS'].includes(',')) {
            history[name].push(r['Last Known GPS']);
        }
        
        // FEATURE: Extract destination from notes for travel sessions
        let travelTarget = "";
        const status = r['Alarm Status'] || "";
        const notes = r['Notes'] || "";
        if (status.includes("TRAVELLING") && notes.toLowerCase().includes("travelling to:")) {
            travelTarget = notes.split(/travelling to:/i)[1]?.trim() || "unknown";
        }

        if (!workers[name] || timestamp > workers[name].timestamp) { 
            workers[name] = { 
                name: name, status: status, phone: r['Worker Phone Number'], 
                iceName: r['Emergency Contact Name'], icePhone: r['Emergency Contact Number'], 
                notes: notes, 
                location: r['Location Name'] || r['Location Address'] || "Unknown", 
                travelTarget: travelTarget, // Saved for UI display
                gps: r['Last Known GPS'], battery: r['Battery Level'], dueTime: r['Anticipated Departure Time'], 
                timestamp: timestamp, wofExpiry: r['WOFExpiry'] 
            }; 
        } 
    }); 
    Object.keys(workers).forEach(k => { workers[k].history = history[k] ? history[k].slice(-10) : []; });
    return Object.values(workers); 
}

function renderGrid() { 
    const grid = document.getElementById('workerGrid'); const search = document.getElementById('searchBox').value.toLowerCase(); const now = Date.now(); grid.innerHTML = ''; let activeC = 0; let alertC = 0; let visibleCount = 0; workerData.sort((a,b) => getUrgencyScore(b, now) - getUrgencyScore(a, now)); const totalActive = workerData.filter(w => w.status !== 'DEPARTED' && w.status !== 'COMPLETED').length; const loadEl = document.getElementById('loadWarning'); if (totalActive > 40) { loadEl.className = "bg-red-900 border-red-500 rounded px-3 py-2 text-xs font-bold flex justify-between animate-pulse"; loadEl.classList.remove('hidden'); document.getElementById('loadMsg').innerText = `‚ö†Ô∏è CRITICAL LOAD (${totalActive})`; } else if (totalActive > 20) { loadEl.className = "bg-yellow-900 border-yellow-500 rounded px-3 py-2 text-xs font-bold flex justify-between"; loadEl.classList.remove('hidden'); document.getElementById('loadMsg').innerText = `‚ö†Ô∏è HIGH TRAFFIC (${totalActive})`; } else { loadEl.classList.add('hidden'); } 
    
    workerData.forEach(w => { 
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE') || w.status === 'DATA_ENTRY_ONLY'; 
        const isAlert = w.status.includes('EMERGENCY') || w.status.includes('PANIC'); 
        const isDuress = w.status.includes('DURESS'); 
        const isOverdue = w.status.includes('OVERDUE'); 
        if(!isSafe) activeC++; 
        if(isAlert || isOverdue || isDuress) alertC++; 
        if (search && !w.name.toLowerCase().includes(search)) return; 
        if (currentFilter === 'ACTIVE' && isSafe && !isAlert && !isOverdue && !isDuress) return; 
        
        visibleCount++; 
        if(currentView === 'MAP') return; 
        
        let borderClass = 'bd-grey', dotClass = 'st-grey', statusText = w.status, timeClass = 'text-gray-500'; 
        let resolveBtn = ''; 
        
        // FEATURE: Logic for destination display
        let locLabel = "Location";
        let locValue = w.location;
        if (w.status.includes("TRAVELLING") && w.travelTarget) {
            locLabel = "Destination";
            locValue = w.travelTarget;
        }

        let isWofExpired = false;
        if(w.wofExpiry) {
            const exp = new Date(w.wofExpiry).getTime();
            if(!isNaN(exp) && (exp - now) < 0) isWofExpired = true;
        }

        if (isDuress) { 
            borderClass = 'bd-purple'; dotClass = 'st-purple'; timeClass = 'text-purple-400 font-bold'; 
            resolveBtn = `<button onclick="openResolve('${escapeHtml(w.name)}')" class="mt-2 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 rounded text-xs animate-pulse">‚úÖ RESOLVE DURESS</button>`; 
        } else if (isAlert) { 
            borderClass = 'bd-red'; dotClass = 'st-red'; timeClass = 'text-red-400 font-bold'; 
            resolveBtn = `<button onclick="openResolve('${escapeHtml(w.name)}')" class="mt-2 w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded text-xs animate-pulse">‚úÖ RESOLVE ALERT</button>`; 
        } else if (!isSafe) { 
            const due = new Date(w.dueTime).getTime(); 
            if (!isNaN(due)) { 
                if (due > now) { borderClass = 'bd-green'; dotClass = 'st-ok'; } 
                else { 
                    borderClass = 'bd-amber'; dotClass = 'st-amber'; timeClass = 'text-amber-500 font-bold'; 
                    const minsOver = Math.floor((now - due) / 60000); 
                    if(minsOver >= escalationLimit) { borderClass = 'bd-red'; dotClass = 'st-red'; } 
                } 
            } else { borderClass = 'bd-green'; dotClass = 'st-ok'; } 
        } 
        
        if(isWofExpired && !isAlert && !isDuress && !isOverdue) {
            borderClass = 'bd-amber'; 
            statusText += ` [‚ö†Ô∏è ${VEHICLE_TERM} EXP]`; 
        }

        const card = document.createElement('div'); card.className = `card p-4 ${borderClass}`; 
        let batClass = parseInt(w.battery) < 20 ? 'text-red-500 font-bold blink' : 'text-green-500'; 
        let contactHtml = `<div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Mobile</span><span class="text-gray-300 font-mono">${escapeHtml(w.phone||'--')}</span></div>`; 
        if ((isAlert || isDuress) && w.iceName) { contactHtml += `<div class="mt-2 pt-2 border-t border-gray-700 bg-red-900/30 -mx-4 px-4 py-2"><div class="flex justify-between items-center"><span class="text-[10px] text-red-400 font-bold uppercase">ICE: ${escapeHtml(w.iceName)}</span><a href="tel:${w.icePhone}" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs font-bold shadow">üìû Call ICE</a></div></div>`; } 
        const callIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>`; 
        
        // UPDATED: Dynamic locLabel and bold locValue for travel destinations
        card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 onclick="focusWorker('${w.gps}')" class="font-bold text-lg text-white truncate w-full cursor-pointer hover:text-brand transition" title="Click to locate">${escapeHtml(w.name)}</h3><div class="${dotClass} status-dot mt-1.5 shrink-0 ml-2"></div></div><div class="space-y-1.5 text-xs text-gray-300"><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Status</span><span class="font-bold">${escapeHtml(statusText)}</span></div><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">${locLabel}</span><span class="truncate w-24 text-right ${locLabel === 'Destination' ? 'text-brand font-bold' : ''}" title="${escapeHtml(locValue)}">${escapeHtml(locValue)}</span></div><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Due</span><span class="${timeClass}">${formatTime(w.dueTime)}</span></div><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Battery</span><span class="${batClass}">${escapeHtml(w.battery||'--')}</span></div>${contactHtml}</div><div class="mt-3 grid grid-cols-2 gap-2"><button onclick="focusWorker('${w.gps}')" class="text-brand bg-brand/20 hover:bg-brand/40 text-center py-2 rounded text-xs font-bold">üìç Map</button><a href="tel:${w.phone}" class="bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold flex items-center justify-center">${callIcon} Call</a></div>${resolveBtn}`; grid.appendChild(card); 
    }); 
    document.getElementById('activeCount').innerText = activeC; document.getElementById('alertCount').innerText = alertC; 
    if(currentView === 'GRID') document.getElementById('emptyState').classList.toggle('hidden', visibleCount > 0); 
}

function escapeHtml(text) { 
    if (!text) return ""; 
    return String(text).replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); 
}

function initMap() { 
    if(mapInstance) { mapInstance.invalidateSize(); return; } 
    mapInstance = L.map('mapView').setView([-40.9006, 174.8860], 5); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapInstance); 
    markersLayer = L.layerGroup().addTo(mapInstance); 
}

function renderMap() { 
    if(!mapInstance) return; 
    if (!markersLayer) markersLayer = L.layerGroup().addTo(mapInstance);
    
    markersLayer.clearLayers(); 
    const bounds = L.latLngBounds(); 
    let hasMarkers = false; 
    const now = Date.now(); 
    
    workerData.forEach(w => { 
        const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE') || w.status === 'DATA_ENTRY_ONLY'; 
        if (currentFilter === 'ACTIVE' && isSafe && !w.status.includes('EMERGENCY')) return; 
        
        if(!w.gps || w.gps.length < 5) return; 
        const cleanGps = w.gps.replace(/[^0-9.,-]/g, ''); 
        const parts = cleanGps.split(',');
        if(parts.length !== 2) return;
        
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);
        if(isNaN(lat) || isNaN(lng)) return; 
        
        let colorClass = 'grey'; 
        const urgency = getUrgencyScore(w, now); 
        if(urgency >= 2000) colorClass = 'purple'; else if(urgency >= 1000) colorClass = 'red'; else if(urgency >= 500) colorClass = 'amber'; else if(urgency >= 100) colorClass = 'green'; 
        
        if(w.history && w.history.length > 1) {
            const path = w.history.map(h => {
                const c = h.replace(/[^0-9.,-]/g, '').split(',');
                return [parseFloat(c[0]), parseFloat(c[1])];
            }).filter(p => !isNaN(p[0]));
            if(path.length > 0) L.polyline(path, {color: getComputedStyle(document.documentElement).getPropertyValue('--brand-accent'), weight: 3, opacity: 0.5, dashArray: '5, 10'}).addTo(markersLayer);
        }

        const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-icon ${colorClass}"></div>`, iconSize: [24, 24] }); 
        L.marker([lat, lng], {icon: icon, zIndexOffset: 1000}).bindPopup(`<b>${escapeHtml(w.name)}</b><br>${escapeHtml(w.status)}<br>${escapeHtml(w.location)}`).addTo(markersLayer); 
        bounds.extend([lat, lng]); hasMarkers = true; 
    }); 
    if(hasMarkers && !mapInstance._isFocused) mapInstance.fitBounds(bounds, {padding:[50,50], maxZoom:15}); 
}

function focusWorker(gps) { if(!gps || gps.length < 5) return alert("No GPS data available."); document.getElementById('btnMap').click(); setTimeout(() => { if(!mapInstance) initMap(); const clean = gps.replace(/[^0-9.,-]/g, '').split(','); const lat = parseFloat(clean[0]); const lng = parseFloat(clean[1]); mapInstance._isFocused = true; mapInstance.invalidateSize(); mapInstance.flyTo([lat, lng], 17, {animate: true, duration: 1.5}); setTimeout(() => { mapInstance._isFocused = false; }, 5000); }, 200); }
function toggleView(view) { currentView = view; const grid = document.getElementById('workerGrid'); const map = document.getElementById('mapView'); const btnG = document.getElementById('btnGrid'); const btnM = document.getElementById('btnMap'); grid.classList.toggle('hidden', view === 'MAP'); map.classList.toggle('hidden', view === 'GRID'); document.getElementById('emptyState').classList.add('hidden'); btnG.classList.toggle('bg-gray-600', view === 'GRID'); btnG.classList.toggle('text-white', view === 'GRID'); btnG.classList.toggle('text-gray-400', view !== 'GRID'); btnM.classList.toggle('bg-gray-600', view === 'MAP'); btnM.classList.toggle('text-white', view === 'MAP'); btnM.classList.toggle('text-gray-400', view !== 'MAP'); if(view === 'MAP') { setTimeout(() => { initMap(); renderMap(); }, 150); } else { renderGrid(); } }
function renderLog() { 
    const list = document.getElementById('eventLogList'); 
    // FIXED: Strictly limit history to the last 100 rows to prevent memory crashes
    const sorted = [...allRows].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp)).reverse(); 
    const top = sorted.slice(0, 100); 
    
    let html = ''; 
    top.forEach(r => { 
        const time = new Date(r['Timestamp']).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12:true}); 
        let color = "text-gray-300"; 
        const s = r['Alarm Status'];
        if(s.includes("DURESS")) color = "text-purple-400 font-bold"; 
        else if(s.includes("EMERGENCY") || s.includes("PANIC")) color = "text-red-400 font-bold"; 
        else if(s.includes("SAFE")) color = "text-green-400 font-bold"; 
        
        html += `<div class="log-item text-[10px] mb-1 border-b border-gray-700/30 pb-1"><span class="text-gray-500 font-mono mr-2">${time}</span><span class="${color}">${escapeHtml(r['Worker Name'])}: ${escapeHtml(s)}</span></div>`; 
    }); 
    list.innerHTML = html; 
}
function getUrgencyScore(w, now) { if (w.status.includes('DURESS')) return 2000; if (w.status.includes('EMERGENCY')) return 1000; const due = new Date(w.dueTime).getTime(); if (!isNaN(due) && due < now && w.status !== 'DEPARTED') return 500 + (now - due); if (w.status === 'ON SITE' || w.status === 'TRAVELLING') return 100; return 0; }

function setFilter(f) { 
    currentFilter = f; 
    const btnAct = document.getElementById('btnFilterActive'); 
    const btnAll = document.getElementById('btnFilterAll'); 
    if(f === 'ACTIVE') { 
        btnAct.classList.add('btn-brand', 'text-white', 'shadow');
        btnAct.classList.remove('text-gray-400');
        btnAll.classList.add('text-gray-400');
        btnAll.classList.remove('btn-brand', 'text-white', 'shadow');
    } else { 
        btnAll.classList.add('btn-brand', 'text-white', 'shadow');
        btnAll.classList.remove('text-gray-400');
        btnAct.classList.add('text-gray-400');
        btnAct.classList.remove('btn-brand', 'text-white', 'shadow');
    } 
    renderGrid(); 
    if(currentView === 'MAP') renderMap(); 
}

function openResolve(name) { document.getElementById('resolveModal').classList.remove('hidden'); document.getElementById('resWorkerNameDisplay').innerText = name; document.getElementById('resNameInput').value = ""; document.getElementById('resNoteInput').value = ""; }
function closeResolve() { document.getElementById('resolveModal').classList.add('hidden'); }

function submitResolution() { 
    const targetName = document.getElementById('resWorkerNameDisplay').innerText; 
    const typedName = document.getElementById('resNameInput').value; 
    const note = document.getElementById('resNoteInput').value.trim(); 
    
    if(targetName.trim().toLowerCase() !== typedName.trim().toLowerCase()) { 
        alert("Error: Name does not match exactly."); return; 
    } 
    
    if(note.length < 5) { alert("Error: Please enter a resolution note."); return; } 
    
    const formData = new FormData(); 
    formData.append('action', 'resolve'); 
    formData.append('key', API_KEY); 
    formData.append('Worker Name', targetName); 
    formData.append('Alarm Status', 'SAFE - MANUALLY CLEARED'); 
    formData.append('Notes', `[HQ RESOLVED]: ${note}`); 
    formData.append('Battery Level', 'N/A'); 
    formData.append('Location Name', 'HQ Manual Resolution'); 
    
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData })
    .then(() => { 
        alert("Resolution Sent."); 
        closeResolve(); 
        acknowledgedAlerts.add(targetName); 
        renderGrid(); 
    })
    .catch(e => alert("Connection Error: " + e)); 
}
function exportSystemLog() {
    if (allRows.length === 0) return alert("No data available to export.");
    
    const headers = ["Timestamp", "Worker Name", "Alarm Status", "Location", "Notes", "Battery", "GPS"];
    const csvRows = [headers.join(",")];

    allRows.slice().reverse().forEach(r => {
        const row = [
            `"${r['Timestamp']}"`,
            `"${r['Worker Name']}"`,
            `"${r['Alarm Status']}"`,
            `"${r['Location Name'] || r['Location Address']}"`,
            `"${(r['Notes'] || '').replace(/"/g, '""')}"`,
            `"${r['Battery Level']}"`,
            `"${r['Last Known GPS']}"`
        ];
        csvRows.push(row.join(","));
    });

    const csvString = csvRows.join("\n");
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    link.setAttribute("href", url);
    link.setAttribute("download", `Safety_Log_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
function formatTime(t) { if(!t) return "--:--"; const d = new Date(t); return isNaN(d) ? "--:--" : d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12:true}); }
async function unlockAudio() {
    // Satisfies browser requirement for user gesture
    await Tone.start();
    console.log("Audio Context Started");
    
    // Hide the gate and show the dashboard
    document.getElementById('audioGate').style.display = 'none';
    
    // Resume the heartbeat/sync process
    if(typeof forceSync === "function") forceSync(); 
}

    // NEW: Helper to play specific UI sounds
function playSound(type) {
    if (!audioEnabled || !synth) return;
    if (Tone.context.state !== 'running') Tone.context.resume();

    const now = Tone.now();
    if (type === 'offline') {
        // High-low-high warning for connection loss
        synth.triggerAttackRelease("A3", "4n", now);
        synth.triggerAttackRelease("E3", "4n", now + 0.5);
        synth.triggerAttackRelease("A2", "2n", now + 1.0);
    } else if (type === 'test') {
        // Simple chime for the sound-check
        synth.triggerAttackRelease("C5", "8n");
    }
}
    
async function unlockAudio() {
    try {
        if(typeof Tone !== 'undefined') {
            await Tone.start(); // This fulfills the "User Gesture" requirement
            synth = new Tone.Synth().toDestination();
            console.log("Audio Context Started");
        }
    } catch(e) {
        console.warn("Audio Context Failed:", e);
    }
    
    // Hide the gate and start the dashboard polling
    document.getElementById('audioGate').style.display = 'none';
    startPolling(); 
}
</script>
</body>
</html>
