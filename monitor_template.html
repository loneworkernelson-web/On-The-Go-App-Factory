<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>%%ORG_NAME%% Monitor</title>
<link rel="icon" href="%%LOGO_URL%%">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
  .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; }
  .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
  .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
  .blink { animation: blinker 1.5s linear infinite; }
  @keyframes blinker { 50% { opacity: 0; } }
  /* Status Colors */
  .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
  .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; }
  .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.8s linear infinite; }
  .st-offline { background-color: #64748b; }
</style>
</head>
<body class="p-6">

  <header class="flex justify-between items-center mb-8">
    <div class="flex items-center gap-4">
      <img src="%%LOGO_URL%%" class="w-12 h-12 rounded bg-white object-contain p-1">
      <div>
        <h1 class="text-3xl font-extrabold tracking-tight">%%ORG_NAME%%</h1>
        <div class="flex items-center gap-2 text-sm text-gray-400">
           <span id="serverStatus" class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Connecting...</span>
           <span class="text-gray-600">|</span>
           <span>Last Update: <span id="lastUpdate" class="text-white font-mono">--:--:--</span></span>
        </div>
      </div>
    </div>
    <div class="flex gap-4">
        <div class="text-right">
            <div class="text-2xl font-bold text-green-400" id="activeCount">0</div>
            <div class="text-xs text-gray-400 uppercase">Safe</div>
        </div>
        <div class="text-right">
            <div class="text-2xl font-bold text-red-500" id="alertCount">0</div>
            <div class="text-xs text-gray-400 uppercase">Alerts</div>
        </div>
    </div>
  </header>

  <div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  <div id="emptyState" class="hidden text-center py-20 text-gray-500">No active workers.</div>

<script>
const SCRIPT_URL = "%%SHEET_URL%%";
let workerData = [];
let escalationLimit = 15; // Default

setInterval(fetchData, 10000);
setInterval(renderGrid, 1000); // Re-render local timers
window.onload = fetchData;

function fetchData() {
    const script = document.createElement('script');
    const cbName = 'cb_' + Date.now();
    window[cbName] = function(data) {
        if(data.escalation_limit) escalationLimit = parseInt(data.escalation_limit);
        handleData(data);
        document.body.removeChild(script);
        delete window[cbName];
    };
    script.src = `${SCRIPT_URL}?callback=${cbName}&t=${Date.now()}`;
    document.body.appendChild(script);
}

function handleData(response) {
    const statusEl = document.getElementById('serverStatus');
    if (response && (response.workers || response.status === 'online')) {
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
        statusEl.classList.remove('text-red-400'); statusEl.classList.add('text-green-400');
    } else {
        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Error';
        statusEl.classList.add('text-red-400');
    }
    if (response.workers) {
        workerData = processWorkers(response.workers);
        document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
        renderGrid();
    }
}

function processWorkers(rows) {
    const workers = {};
    rows.forEach(r => {
        const name = r['Worker Name']; if (!name) return;
        const timestamp = new Date(r['Timestamp']).getTime();
        if (!workers[name] || timestamp > workers[name].timestamp) {
            workers[name] = {
                name: name,
                status: r['Alarm Status'],
                phone: r['Worker Phone Number'],
                iceName: r['Emergency Contact Name'],
                icePhone: r['Emergency Contact Number'],
                notes: r['Notes'],
                location: r['Location Name'] || r['Location Address'] || "Unknown",
                gps: r['Last Known GPS'],
                battery: r['Battery Level'],
                dueTime: r['Anticipated Departure Time'],
                timestamp: timestamp
            };
        }
    });
    return Object.values(workers);
}

function renderGrid() {
    const grid = document.getElementById('workerGrid');
    grid.innerHTML = '';
    let activeC = 0; let alertC = 0;
    const now = Date.now();

    // Sort: Red -> Amber -> Green -> Offline
    workerData.sort((a,b) => getUrgencyScore(b, now) - getUrgencyScore(a, now));

    workerData.forEach(w => {
        let state = 'offline'; 
        let cardBorder = 'border-gray-700';
        let statusDot = 'st-offline';
        let statusText = w.status;

        // --- TRAFFIC LIGHT LOGIC ---
        if (w.status === 'ON SITE' || w.status === 'TRAVELLING') {
            const due = new Date(w.dueTime).getTime();
            if (isNaN(due) || due > now) {
                // Not Overdue = GREEN
                state = 'green';
                statusDot = 'st-ok';
                cardBorder = 'border-green-600';
                activeC++;
            } else {
                const minsOver = (now - due) / 60000;
                if (minsOver < escalationLimit) {
                    // Overdue but within buffer = AMBER
                    state = 'amber';
                    statusDot = 'st-amber';
                    cardBorder = 'border-yellow-500 border-2';
                    statusText = "OVERDUE (" + Math.floor(minsOver) + "m)";
                    alertC++;
                } else {
                    // Way Overdue = RED
                    state = 'red';
                    statusDot = 'st-red';
                    cardBorder = 'border-red-600 border-4';
                    statusText = "CRITICAL OVERDUE";
                    alertC++;
                }
            }
        } else if (w.status.includes('EMERGENCY') || w.status.includes('PANIC') || w.status.includes('DURESS')) {
            // Panic = RED
            state = 'red';
            statusDot = 'st-red';
            cardBorder = 'border-red-600 border-4';
            alertC++;
        }

        const card = document.createElement('div');
        card.className = `card p-5 ${cardBorder}`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-xl text-white truncate">${w.name}</h3>
                <div class="${statusDot} status-dot mt-2"></div>
            </div>
            <div class="space-y-2 text-sm text-gray-300">
                <div class="flex justify-between"><span class="text-gray-500 font-bold uppercase">Status</span><span class="font-bold text-white">${statusText}</span></div>
                <div class="flex justify-between"><span class="text-gray-500 font-bold uppercase">Loc</span><span class="truncate w-32 text-right" title="${w.location}">${w.location}</span></div>
                <div class="flex justify-between"><span class="text-gray-500 font-bold uppercase">Batt</span><span class="${getBatColor(w.battery)}">${w.battery || '--'}</span></div>
                
                ${w.iceName ? `<div class="mt-2 pt-2 border-t border-gray-700">
                    <span class="text-xs text-red-400 font-bold uppercase">ICE Contact</span>
                    <div class="flex justify-between text-xs"><span>${w.iceName}</span><a href="tel:${w.icePhone}" class="text-blue-400 hover:underline">${w.icePhone}</a></div>
                </div>` : ''}
            </div>
            <div class="mt-4 flex gap-2">
                <a href="https://www.google.com/maps/search/?api=1&query=${w.gps}" target="_blank" class="flex-1 bg-blue-900 hover:bg-blue-800 text-blue-200 text-center py-2 rounded text-xs font-bold">üìç Map</a>
                <a href="tel:${w.phone}" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold">üìû Call</a>
            </div>`;
        grid.appendChild(card);
    });

    document.getElementById('activeCount').innerText = activeC;
    document.getElementById('alertCount').innerText = alertC;
    document.getElementById('emptyState').classList.toggle('hidden', workerData.length > 0);
}

function getUrgencyScore(w, now) {
    if (w.status.includes('EMERGENCY')) return 1000;
    const due = new Date(w.dueTime).getTime();
    if (!isNaN(due) && due < now) return 500 + (now - due); // Overdue score
    if (w.status === 'ON SITE' || w.status === 'TRAVELLING') return 100;
    return 0;
}
function getBatColor(b) {
    const val = parseInt(b);
    if(val < 20) return 'text-red-500 font-bold blink';
    return val < 50 ? 'text-yellow-500' : 'text-green-500';
}
</script>
</body>
</html>
