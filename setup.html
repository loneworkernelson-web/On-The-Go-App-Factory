<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG AppSuite Factory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; line-height: 1.6; }
    
    /* Wizard Transitions */
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Inputs */
    .input-field { 
      width: 100%; background: #1e293b; border: 2px solid #475569; 
      padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; 
      transition: all 0.2s; 
    }
    .input-field:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }

    /* Buttons */
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.5); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5); }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.5); }
    
    /* Code Viewer */
    .code-scroll { 
      background: #020617; border: 1px solid #334155; border-radius: 0.5rem; 
      padding: 1.5rem; font-family: 'Menlo', monospace; font-size: 0.85rem; 
      color: #a5b4fc; overflow-y: auto; max-height: 300px; white-space: pre-wrap; 
    }
    
    /* Highlight Box */
    .highlight-box { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; }
  </style>
</head>
<body class="min-h-screen py-8 px-4">

  <div class="max-w-5xl mx-auto">
    
    <header class="text-center mb-12">
      <h1 class="text-5xl font-extrabold text-white mb-3">OTG AppSuite Factory</h1>
      <p class="text-xl text-gray-400">The "No-Code" generator for your safety system.</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="flex-1 py-5 font-bold text-blue-400 border-b-4 border-blue-500 bg-gray-800/50">1. Setup & Branding</button>
        <button onclick="gotoStep(2)" id="tab2" class="flex-1 py-5 font-bold text-gray-500 hover:text-gray-300">2. Database</button>
        <button onclick="gotoStep(3)" id="tab3" class="flex-1 py-5 font-bold text-gray-500 hover:text-gray-300">3. Connect</button>
        <button onclick="gotoStep(4)" id="tab4" class="flex-1 py-5 font-bold text-gray-500 hover:text-gray-300">4. Download</button>
      </div>

      <div class="p-8 md:p-12">

        <div id="step1" class="step-section active space-y-10">
          
          <div class="grid md:grid-cols-2 gap-12">
            <div class="space-y-6">
              <div>
                <label class="block text-blue-300 font-bold mb-2 text-sm uppercase tracking-wider">Organisation Name</label>
                <input type="text" id="orgName" class="input-field" placeholder="e.g. Acme Safety Ltd" value="My Organisation">
                <p class="text-gray-500 text-xs mt-2">This will appear on the App header and Home Screen.</p>
              </div>
              
              <div>
                <label class="block text-blue-300 font-bold mb-2 text-sm uppercase tracking-wider">Secret Key (Password)</label>
                <input type="text" id="secretKey" class="input-field" placeholder="Create a strong password" value="ChangeMe123!">
                <p class="text-gray-500 text-xs mt-2">You will need this key to log into the Monitor Dashboard.</p>
              </div>
            </div>

            <div class="highlight-box flex flex-col items-center justify-center text-center hover:border-blue-500 transition cursor-pointer group" onclick="document.getElementById('logoInput').click()">
              <label class="block text-blue-300 font-bold mb-4 text-sm uppercase tracking-wider">App Logo (Optional)</label>
              <div id="logoPreviewArea" class="h-32 w-32 bg-gray-700 rounded-2xl border-2 border-dashed border-gray-500 flex items-center justify-center overflow-hidden group-hover:bg-gray-600 transition">
                <span class="text-gray-400 text-sm font-bold group-hover:text-white">Upload<br>Image</span>
                <img id="logoImg" class="hidden h-full w-full object-contain bg-white">
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <p class="text-xs text-gray-500 mt-4">Used for the App Icon on phones.</p>
            </div>
          </div>

          <hr class="border-gray-700">

          <div>
            <h3 class="text-2xl font-bold text-white mb-6">Select Features</h3>
            
            <label class="flex items-start gap-4 cursor-pointer mb-6 p-4 rounded-xl hover:bg-gray-700/50 transition border border-transparent hover:border-gray-600">
              <div class="relative mt-1">
                <input type="checkbox" id="chkAdvanced" class="sr-only peer" checked onchange="toggleAdv()">
                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </div>
              <div>
                <span class="block font-bold text-white text-lg">Advanced Mode (Recommended)</span>
                <span class="text-sm text-gray-400 block mt-1">Enables Photos, Digital Signatures, Checklists, and PDF Reporting capabilities.</span>
              </div>
            </label>

            <div id="advOptions" class="pl-6 ml-6 border-l-4 border-gray-700 space-y-6">
              
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="chkMileage" class="w-5 h-5 rounded bg-gray-700 text-blue-600 focus:ring-blue-500 border-gray-500">
                <span class="text-gray-300 font-medium">Enable "Travelling" Feature (Mileage Calculation)</span>
              </label>

              <div class="grid md:grid-cols-2 gap-6 bg-gray-900 p-4 rounded-lg">
                <div>
                  <label class="block text-gray-400 text-xs font-bold uppercase mb-1">OpenRouteService API Key (Optional)</label>
                  <input type="text" id="orsKey" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white placeholder-gray-600" placeholder="Paste key here...">
                  <p class="text-xs text-gray-500 mt-1">Calculates real road distance. If blank, uses straight-line distance.</p>
                </div>
                <div>
                  <label class="block text-gray-400 text-xs font-bold uppercase mb-1">Gemini API Key (Optional)</label>
                  <input type="text" id="geminiKey" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white placeholder-gray-600" placeholder="Paste key here...">
                  <p class="text-xs text-gray-500 mt-1">Uses AI to fix grammar in worker notes.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button onclick="gotoStep(2)" class="btn btn-primary text-xl px-8 py-4">Next: Set Up Database &rarr;</button>
          </div>
        </div>

        <div id="step2" class="step-section space-y-10">
          
          <div class="text-center bg-gray-900/50 p-8 rounded-2xl border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-2">1. Create Your Database</h2>
            <p class="text-gray-400 mb-6">The system runs on a free Google Sheet.</p>
            <a href="https://sheets.new" target="_blank" class="btn btn-success text-xl px-10 py-4 shadow-xl transform hover:-translate-y-1">
              Click to Open New Google Sheet
            </a>
            <p class="text-gray-500 text-sm mt-3">(Opens in a new tab. Come back here once open.)</p>
          </div>

          <div class="grid md:grid-cols-2 gap-8">
            <div class="highlight-box">
              <div class="flex items-center gap-3 mb-4">
                <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">2</div>
                <h3 class="font-bold text-xl text-blue-300">Set Up 'Visits' Tab</h3>
              </div>
              <ol class="list-decimal pl-5 space-y-2 text-gray-300 text-sm mb-6">
                <li>Rename the first tab (at the bottom) to <strong>Visits</strong>.</li>
                <li>Click cell <strong>A1</strong>.</li>
                <li>Click the button below to copy the headers.</li>
                <li>Press <strong>Ctrl+V</strong> (or Cmd+V) to paste in the sheet.</li>
              </ol>
              <button onclick="copyVisitsHeaders()" class="w-full btn bg-gray-700 hover:bg-white hover:text-black text-white py-3 transition">Copy Visits Headers</button>
            </div>

            <div id="boxChecklists" class="highlight-box border-purple-500/50 relative overflow-hidden">
              <div class="absolute top-0 right-0 bg-purple-600 text-xs font-bold px-2 py-1 rounded-bl-lg text-white">ADVANCED ONLY</div>
              <div class="flex items-center gap-3 mb-4">
                <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</div>
                <h3 class="font-bold text-xl text-purple-300">Set Up 'Checklists' Tab</h3>
              </div>
              <ol class="list-decimal pl-5 space-y-2 text-gray-300 text-sm mb-6">
                <li>Click the <strong>+</strong> icon to add a new tab.</li>
                <li>Rename it to <strong>Checklists</strong>.</li>
                <li>Click cell <strong>A1</strong>.</li>
                <li>Click the button below to copy the <strong class="text-white">Full Setup</strong>.</li>
                <li>Paste in A1. (This creates 2 sample forms for you).</li>
              </ol>
              <button onclick="copyFullChecklistSetup()" class="w-full btn bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white py-3 shadow-lg">Copy Full Checklists Setup</button>
            </div>
          </div>

          <div id="legendBox" class="bg-gray-900 rounded-xl p-6 border border-gray-700">
            <details>
              <summary class="font-bold text-gray-400 cursor-pointer hover:text-white flex items-center gap-2">
                <span>‚ÑπÔ∏è Template Code Legend (How to build custom forms)</span>
              </summary>
              <div class="mt-4 grid md:grid-cols-3 gap-4 text-sm text-gray-300">
                <div class="p-2 bg-gray-800 rounded"><strong>[YESNO]</strong><br>Yes/No radio buttons</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[CHECK]</strong><br>Single Checkbox</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[TEXT]</strong><br>Large text box</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[NUMBER]</strong><br>Numeric input</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[PHOTO]</strong><br>Camera button</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[HEADING]</strong><br>Section Title</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[NOTE]</strong><br>Instructional text</div>
                <div class="p-2 bg-gray-800 rounded"><strong>[GPS]</strong><br>Capture Location</div>
              </div>
            </details>
          </div>

          <div class="flex justify-between pt-6">
            <button onclick="gotoStep(1)" class="text-gray-400 font-bold hover:text-white transition">Back</button>
            <button onclick="loadTemplatesAndGenerateScript()" class="btn btn-primary text-xl px-8">Next: Generate Code &rarr;</button>
          </div>
        </div>

        <div id="step3" class="step-section space-y-8">
          
          <div class="bg-blue-900/30 border border-blue-500/50 p-6 rounded-xl flex gap-6 items-start">
            <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold text-xl">4</div>
            <div>
              <h3 class="font-bold text-blue-200 text-lg mb-2">Deploy the "Brain"</h3>
              <ol class="list-decimal pl-5 space-y-2 text-gray-300 text-sm">
                <li>Go to <a href="https://script.new" target="_blank" class="text-white font-bold underline hover:text-blue-300">script.new</a> (opens new tab).</li>
                <li><strong>Delete</strong> any code currently in the editor.</li>
                <li>Click the <strong>COPY ALL CODE</strong> button below.</li>
                <li>Paste the code into the script editor.</li>
                <li>Click <strong>Deploy</strong> (top right) &rarr; <strong>New Deployment</strong>.</li>
                <li>Click the Gear icon &rarr; Select <strong>Web App</strong>.</li>
                <li>Set 'Who has access' to: <strong>Anyone</strong> (Crucial!).</li>
                <li>Click Deploy, Authorize, and copy the URL ending in <code>/exec</code>.</li>
              </ol>
            </div>
          </div>

          <div class="relative group">
            <button onclick="copyScript()" class="absolute top-4 right-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded shadow-lg z-10">COPY ALL CODE</button>
            <pre id="codeDisplay" class="code-scroll border-2 border-gray-700 group-hover:border-blue-500/50 transition">Loading templates...</pre>
          </div>

          <div class="max-w-xl mx-auto text-center">
            <label class="block text-green-400 font-bold mb-3 text-lg">Paste your Web App URL here:</label>
            <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50 focus:border-green-400" placeholder="https://script.google.com/macros/s/..../exec" oninput="resetTest()">
          </div>
          
          <div class="text-center space-y-4">
             <button id="btnTest" onclick="testConnection()" class="btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg">
                üì° Test Connection
             </button>
             <div id="testResult" class="font-bold text-lg hidden p-3 rounded-lg bg-gray-900 inline-block"></div>
          </div>

          <div class="flex justify-between pt-6">
            <button onclick="gotoStep(2)" class="text-gray-400 font-bold hover:text-white transition">Back</button>
            <button id="btnNextDownload" onclick="gotoStep(4)" disabled class="btn btn-primary text-xl px-8 opacity-50 cursor-not-allowed">Next: Build App &rarr;</button>
          </div>
        </div>

        <div id="step4" class="step-section text-center space-y-12 py-10">
          
          <div>
            <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-green-500 to-emerald-700 rounded-full mb-6 shadow-lg shadow-green-500/30">
              <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-5xl font-extrabold text-white mb-4">Ready to Launch</h2>
            <p class="text-xl text-gray-400">Your custom <span id="finalAppName" class="text-blue-400 font-bold">App</span> has been compiled.</p>
          </div>

          <button onclick="downloadZip()" class="w-full max-w-lg mx-auto btn btn-success py-6 rounded-2xl text-2xl shadow-2xl shadow-green-900/50 transform hover:scale-105 transition">
            Download AppSuite.zip
          </button>

          <div class="max-w-2xl mx-auto bg-gray-900 p-8 rounded-2xl border border-gray-700 text-left">
            <p class="font-bold text-white text-lg mb-4 border-b border-gray-700 pb-2">Final Steps:</p>
            <ul class="space-y-3 text-gray-300">
              <li class="flex gap-3"><span class="bg-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">1</span> Unzip the downloaded file.</li>
              <li class="flex gap-3"><span class="bg-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">2</span> Upload the <strong>WorkerApp</strong> and <strong>MonitorApp</strong> folders to your GitHub repository.</li>
              <li class="flex gap-3"><span class="bg-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">3</span> Enable <strong>GitHub Pages</strong> in your repository settings.</li>
              <li class="flex gap-3"><span class="bg-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">4</span> Send the link to your staff!</li>
            </ul>
          </div>
          
          <button onclick="gotoStep(3)" class="text-gray-500 hover:text-white text-sm font-bold">Back to Configuration</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- STATE ---
    let logoData = "https://i.postimg.cc/dVmVg3Pn/favicon-logo-for-LWSApp.png"; 
    let tplWorker = "", tplMonitor = "", tplBackend = "";

    // --- NAVIGATION ---
    function gotoStep(n) {
      document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
      document.getElementById('step'+n).classList.add('active');
      [1,2,3,4].forEach(i => {
        document.getElementById('tab'+i).className = (i === n) 
          ? "flex-1 py-5 font-bold text-blue-400 border-b-4 border-blue-500 bg-gray-800/50" 
          : "flex-1 py-5 font-bold text-gray-500 hover:text-gray-300";
      });
      window.scrollTo(0,0);
    }

    function toggleAdv() {
      const isAdv = document.getElementById('chkAdvanced').checked;
      document.getElementById('advOptions').style.display = isAdv ? "block" : "none";
      document.getElementById('boxChecklists').style.display = isAdv ? "block" : "none";
      document.getElementById('legendBox').style.display = isAdv ? "block" : "none";
    }

    function handleLogo(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          logoData = e.target.result;
          document.getElementById('logoImg').src = logoData;
          document.getElementById('logoImg').classList.remove('hidden');
          document.getElementById('logoPreviewArea').classList.add('border-blue-500');
        };
        reader.readAsDataURL(file);
      }
    }

    // --- COPY HELPERS ---
    function copyVisitsHeaders() {
      const isAdv = document.getElementById('chkAdvanced').checked;
      const h = "Timestamp\tDate\tWorker Name\tWorker Phone\tAlarm Status\tNotes\tLocation Name\tLast Known GPS" + (isAdv ? "\tPhoto 1\tDistance" : "");
      navigator.clipboard.writeText(h);
      alert("Headers copied! \n\nGo to your Sheet -> Click Cell A1 -> Paste (Ctrl+V)");
    }

    function copyFullChecklistSetup() {
      const fullSetup = `Company Name\tTemplate Name\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5
(Standard)\t\tSafety Check Done?\tHazards Identified?\t[PHOTO] Site Photo\tNotes\t
Internal\tVehicle Check\t[HEADING] Tyres & Oil\tTyres OK?\tOil Level OK?\t[HEADING] Damage\t[PHOTO] Damage Photo`;
      navigator.clipboard.writeText(fullSetup);
      alert("Full Setup Copied! \n\nGo to 'Checklists' tab -> Click Cell A1 -> Paste (Ctrl+V)");
    }

    // --- TEMPLATE LOADING ---
    async function loadTemplatesAndGenerateScript() {
      try {
        const [resW, resM, resB] = await Promise.all([
          fetch('worker_template.html'),
          fetch('monitor_template.html'),
          fetch('backend_template.gs')
        ]);
        if(!resW.ok || !resM.ok || !resB.ok) throw new Error("Missing template files. Make sure worker_template.html, monitor_template.html, and backend_template.gs are in the same folder.");
        
        tplWorker = await resW.text();
        tplMonitor = await resM.text();
        tplBackend = await resB.text();
        
        generateScript();
      } catch(e) {
        alert("Error loading templates:\n" + e.message + "\n\nPlease ensure you are running this from a web server (like GitHub Pages) and not directly from your hard drive.");
      }
    }

    function generateScript() {
      const code = tplBackend
        .replace('%%SECRET_KEY%%', document.getElementById('secretKey').value)
        .replace('%%ORS_API_KEY%%', document.getElementById('orsKey').value)
        .replace('%%GEMINI_API_KEY%%', document.getElementById('geminiKey').value);
      document.getElementById('codeDisplay').textContent = code.trim();
      gotoStep(3);
    }

    function copyScript() {
      navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent);
      alert("Code copied to clipboard!");
    }

    // --- CONNECTION TESTING ---
    function resetTest() {
        document.getElementById('btnNextDownload').disabled = true;
        document.getElementById('testResult').classList.add('hidden');
    }

    function testConnection() {
        const url = document.getElementById('webAppUrl').value;
        const result = document.getElementById('testResult');
        const btnNext = document.getElementById('btnNextDownload');
        const key = document.getElementById('secretKey').value;
        
        if(!url.includes('/exec')) { alert('Invalid URL. It must end with /exec'); return; }
        
        result.classList.remove('hidden');
        result.textContent = "Testing Connection...";
        result.className = "text-center font-bold text-lg text-yellow-400 p-3 rounded-lg bg-gray-900 inline-block";

        fetch(url + '?test=1&key=' + encodeURIComponent(key))
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                  result.textContent = "‚úÖ Success! Connected to Database.";
                  result.className = "text-center font-bold text-lg text-green-400 p-3 rounded-lg bg-gray-900 inline-block";
                  btnNext.disabled = false;
                  btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
                  document.getElementById('finalAppName').innerText = document.getElementById('orgName').value + " Safety";
                } else { throw new Error("Invalid Key"); }
            })
            .catch((e) => {
                console.error(e);
                result.textContent = "‚ùå Connection Failed. Check URL and Secret Key.";
                result.className = "text-center font-bold text-lg text-red-400 p-3 rounded-lg bg-gray-900 inline-block";
            });
    }

    // --- BUILD ZIP ---
    function downloadZip() {
      const zip = new JSZip();
      const org = document.getElementById('orgName').value;
      const url = document.getElementById('webAppUrl').value;
      const isAdv = document.getElementById('chkAdvanced').checked;
      const mile = document.getElementById('chkMileage').checked;

      // 1. WORKER APP
      // We inject the config directly into the HTML
      let wHtml = tplWorker
        .replace(/%%ORG_NAME%%/g, org)
        .replace(/%%SHEET_URL%%/g, url)
        .replace(/%%LOGO_DATA%%/g, logoData)
        .replace('%%IS_ADVANCED%%', isAdv)
        .replace('%%ENABLE_MILEAGE%%', (isAdv && mile));
      
      const wFolder = zip.folder("WorkerApp");
      wFolder.file("index.html", wHtml);
      wFolder.file("manifest.json", JSON.stringify({
        name: org + " Safety",
        short_name: "Safety",
        start_url: "./index.html",
        display: "standalone",
        background_color: "#111827",
        theme_color: "#1e40af",
        icons: [{ src: logoData, sizes: "192x192", type: "image/png" }]
      }, null, 2));
      
      // Add Service Worker
      wFolder.file("sw.js", `
const CACHE_NAME = 'otg-v3.0';
self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(['./index.html']))));
self.addEventListener('activate', e => e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => k !== CACHE_NAME ? caches.delete(k) : null)))));
self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
      `.trim());

      // 2. MONITOR APP
      let mHtml = tplMonitor
        .replace(/%%ORG_NAME%%/g, org)
        .replace(/%%SHEET_URL%%/g, url)
        .replace(/%%LOGO_URL%%/g, logoData);
      const mFolder = zip.folder("MonitorApp");
      mFolder.file("index.html", mHtml);

      // 3. EXTRAS
      zip.file("Backend_Script_Backup.js", document.getElementById('codeDisplay').textContent);

      // GENERATE
      zip.generateAsync({type:"blob"}).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = org.replace(/[^a-z0-9]/gi, '_') + "_AppSuite.zip";
        a.click();
      });
    }
  </script>
</body>
</html>
