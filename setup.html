<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTG AppSuite Factory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    
    /* Wizard Steps */
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* High Contrast Inputs */
    .input-field { 
      width: 100%; background: #1e293b; border: 2px solid #475569; 
      padding: 1rem; border-radius: 0.75rem; color: white; font-size: 1.1rem; 
      transition: border-color 0.2s; 
    }
    .input-field:focus { border-color: #3b82f6; outline: none; }

    /* Buttons */
    .btn { padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 700; transition: transform 0.1s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.5); }
    .btn-success { background: linear-gradient(to right, #059669, #10b981); color: white; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.5); }
    
    /* Code Viewer */
    .code-scroll { 
      background: #020617; border: 1px solid #334155; border-radius: 0.5rem; 
      padding: 1rem; font-family: 'Menlo', monospace; font-size: 0.8rem; 
      color: #a5b4fc; overflow-y: auto; max-height: 250px; white-space: pre-wrap; 
    }
  </style>
</head>
<body class="min-h-screen py-8 px-4">

  <div class="max-w-5xl mx-auto">
    
    <header class="text-center mb-10">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">OTG AppSuite Factory</h1>
      <p class="text-gray-400">Customise and build your Lone Worker Safety System.</p>
    </header>

    <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden">
      
      <div class="flex bg-gray-900 border-b border-gray-700 text-sm md:text-base">
        <button onclick="gotoStep(1)" id="tab1" class="flex-1 py-4 font-bold text-blue-400 border-b-4 border-blue-500 bg-gray-800">1. Config & Branding</button>
        <button onclick="gotoStep(2)" id="tab2" class="flex-1 py-4 font-bold text-gray-500 hover:text-gray-300">2. Spreadsheet</button>
        <button onclick="gotoStep(3)" id="tab3" class="flex-1 py-4 font-bold text-gray-500 hover:text-gray-300">3. Backend Code</button>
        <button onclick="gotoStep(4)" id="tab4" class="flex-1 py-4 font-bold text-gray-500 hover:text-gray-300">4. Download</button>
      </div>

      <div class="p-6 md:p-10">

        <div id="step1" class="step-section active space-y-8">
          
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div>
                <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Organisation Name</label>
                <input type="text" id="orgName" class="input-field" placeholder="e.g. Acme Safety" value="My Organisation">
              </div>
              <div>
                <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Secret Key (Password)</label>
                <input type="text" id="secretKey" class="input-field" placeholder="Create a secure key" value="ChangeMe123!">
                <p class="text-xs text-gray-500 mt-1">Used to secure the Monitor Dashboard.</p>
              </div>
            </div>

            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 flex flex-col items-center justify-center text-center">
              <label class="block text-blue-300 font-bold mb-2 text-sm uppercase">Company Logo (Optional)</label>
              <div class="relative group cursor-pointer w-full" onclick="document.getElementById('logoInput').click()">
                <div id="logoPreviewArea" class="h-32 w-32 mx-auto bg-gray-800 rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center overflow-hidden group-hover:border-blue-500 transition">
                  <span class="text-gray-500 text-sm">Click to Upload</span>
                  <img id="logoImg" class="hidden h-full w-full object-cover">
                </div>
              </div>
              <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogo(this)">
              <p class="text-xs text-gray-500 mt-2">Used for App Icon and Headers.</p>
            </div>
          </div>

          <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">Features</h3>
            
            <label class="flex items-center gap-4 cursor-pointer mb-4">
              <input type="checkbox" id="chkAdvanced" class="w-6 h-6 rounded bg-gray-700 text-blue-600 focus:ring-blue-500" checked onchange="toggleAdv()">
              <div>
                <span class="block font-bold text-white">Advanced Mode</span>
                <span class="text-sm text-gray-400">Enable Photos, Signatures, Checklists, and PDF Reporting.</span>
              </div>
            </label>

            <div id="advOptions" class="pl-10 space-y-3 border-l-2 border-gray-700 ml-3">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="chkMileage" class="w-5 h-5 rounded bg-gray-700 text-blue-600">
                <span class="text-gray-300">Enable "Travelling" / Mileage Calculation</span>
              </label>
              <div class="grid md:grid-cols-2 gap-4 mt-2">
                <input type="text" id="geminiKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="Gemini API Key (Optional)">
                <input type="text" id="orsKey" class="bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white w-full" placeholder="OpenRouteService API Key (Optional)">
              </div>
            </div>
          </div>

          <div class="flex justify-end">
            <button onclick="gotoStep(2)" class="btn btn-primary text-lg">Next: Spreadsheet Setup &rarr;</button>
          </div>
        </div>

        <div id="step2" class="step-section space-y-8">
          <div class="text-center">
            <a href="https://sheets.new" target="_blank" class="btn btn-success text-xl px-10 py-4 shadow-lg transform hover:-translate-y-1">
              1. Click here to create a new Google Sheet
            </a>
            <p class="text-gray-400 mt-2 text-sm">Opens in a new tab. Come back here after it opens.</p>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
              <div class="flex items-center gap-3 mb-4">
                <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">2</div>
                <h3 class="font-bold text-lg">Setup 'Visits' Tab</h3>
              </div>
              <p class="text-gray-400 text-sm mb-4">Rename the first tab to <strong>Visits</strong>. Then click below to copy the headers and paste them into cell <strong>A1</strong>.</p>
              <button onclick="copyVisitsHeaders()" class="w-full btn bg-gray-700 hover:bg-gray-600 text-white py-3">Copy Visits Headers</button>
            </div>

            <div id="boxChecklists" class="bg-gray-900 p-6 rounded-xl border border-gray-700">
              <div class="flex items-center gap-3 mb-4">
                <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</div>
                <h3 class="font-bold text-lg">Setup 'Checklists' Tab</h3>
              </div>
              <p class="text-gray-400 text-sm mb-4">Create a new tab named <strong>Checklists</strong>. Click below to copy the required setup row.</p>
              <button onclick="copyChecklistSetup()" class="w-full btn bg-gray-700 hover:bg-gray-600 text-white py-3">Copy Checklist Setup</button>
            </div>
          </div>

          <div class="flex justify-between pt-6">
            <button onclick="gotoStep(1)" class="text-gray-400 font-bold">Back</button>
            <button onclick="generateScript()" class="btn btn-primary text-lg">Next: Generate Code &rarr;</button>
          </div>
        </div>

        <div id="step3" class="step-section space-y-6">
          <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg flex gap-4 items-start">
            <span class="text-2xl">üí°</span>
            <div>
              <p class="font-bold text-blue-200">Deployment Instructions:</p>
              <ol class="list-decimal pl-4 text-sm text-gray-300 space-y-1 mt-1">
                <li>Go to <a href="https://script.new" target="_blank" class="text-blue-400 underline">script.new</a>.</li>
                <li>Paste the code below into the editor.</li>
                <li>Click <strong>Deploy</strong> &rarr; <strong>New Deployment</strong>.</li>
                <li>Select type: <strong>Web App</strong>.</li>
                <li>Set 'Who has access' to: <strong>Anyone</strong>.</li>
                <li>Click Deploy, Authorize, and copy the URL ending in <code>/exec</code>.</li>
              </ol>
            </div>
          </div>

          <div class="relative">
            <button onclick="copyScript()" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">COPY CODE</button>
            <pre id="codeDisplay" class="code-scroll">Generating...</pre>
          </div>

          <div>
            <label class="block text-green-400 font-bold mb-2 text-lg text-center">Paste your Web App URL here:</label>
            <input type="url" id="webAppUrl" class="input-field text-center font-mono text-yellow-300 border-green-500/50" placeholder="https://script.google.com/.../exec">
          </div>

          <div class="flex justify-between pt-6">
            <button onclick="gotoStep(2)" class="text-gray-400 font-bold">Back</button>
            <button onclick="validateUrl()" class="btn btn-primary text-lg">Next: Build App &rarr;</button>
          </div>
        </div>

        <div id="step4" class="step-section text-center space-y-10 py-8">
          <div>
            <div class="inline-flex items-center justify-center w-20 h-20 bg-green-900/50 rounded-full mb-4 text-4xl">üöÄ</div>
            <h2 class="text-4xl font-bold text-white mb-2">Ready to Launch</h2>
            <p class="text-gray-400">Your custom <span id="finalAppName" class="text-blue-400">App</span> is ready.</p>
          </div>

          <button onclick="downloadZip()" class="w-full max-w-md mx-auto btn btn-success py-5 text-2xl shadow-xl transform hover:scale-105">
            Download AppSuite.zip
          </button>

          <div class="max-w-lg mx-auto bg-gray-900 p-6 rounded-xl border border-gray-700 text-left">
            <p class="font-bold text-gray-300 mb-2 border-b border-gray-700 pb-2">What to do next:</p>
            <ul class="space-y-2 text-sm text-gray-400">
              <li>1. Unzip the downloaded file.</li>
              <li>2. Upload the <strong>WorkerApp</strong> folder to GitHub.</li>
              <li>3. Upload the <strong>MonitorApp</strong> folder to GitHub.</li>
              <li>4. Enable GitHub Pages in settings.</li>
            </ul>
          </div>
          
          <button onclick="gotoStep(3)" class="text-gray-500 hover:text-white text-sm">Back</button>
        </div>

      </div>
    </div>
  </div>

<script id="tpl-worker" type="text/plain">
[cite: 133, 143, 160, 203] <!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>%%ORG_NAME%% Safety</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
body{font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;user-select:none}
.page{display:none}.page.active{display:flex}
.long-press-btn{position:relative;overflow:hidden;transition:all 0.2s}
.long-press-btn::after{content:'';position:absolute;top:0;left:0;width:0;height:100%;background:rgba(255,255,255,0.3);transition:width linear}
.long-press-btn.pressing::after{width:100%}
.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;width:20px;height:20px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">
<div id="app" class="h-full flex flex-col">
  <div id="page-main" class="page active h-full flex-col p-4 bg-gray-800">
    <header class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-2">
        <img src="%%LOGO_DATA%%" class="w-8 h-8 rounded bg-white object-contain">
        <h1 class="text-lg font-bold text-blue-400">%%ORG_NAME%%</h1>
      </div>
      <button onclick="nav('settings')" class="p-2 bg-gray-700 rounded-full hover:bg-gray-600">‚öôÔ∏è</button>
    </header>
    <div id="uploadBanner" class="hidden mb-2 bg-blue-900/50 text-blue-200 text-xs p-2 rounded flex items-center justify-center gap-2">
      <div class="spinner"></div> Syncing offline reports...
    </div>
    <div class="flex-1 overflow-y-auto mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700">
      <div id="locationList" class="space-y-2"></div>
      <button onclick="addLocation()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-600 text-gray-400 rounded hover:border-gray-500 hover:text-white transition">+ Add Location</button>
    </div>
    <div class="mb-4 bg-gray-900 rounded-lg p-4 border border-gray-700">
      <div class="flex justify-between mb-2"><span class="text-gray-400 text-sm uppercase font-bold">Duration</span><span id="durDisplay" class="font-bold text-blue-400">0 min</span></div>
      <input type="range" id="durSlider" min="0" max="11" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="updateDur()">
    </div>
    <div class="flex gap-2">
        <button id="btnQuick" onclick="quickStat()" class="hidden flex-1 py-5 bg-teal-900 text-teal-500 font-bold rounded-xl text-lg opacity-50" disabled>Quick Stat</button>
        <button id="btnStart" class="long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl shadow-lg transition-all" disabled>Select Location</button>
    </div>
  </div>
  <div id="page-locked" class="page h-full flex-col p-6 text-center justify-between bg-gray-900">
    <div class="flex justify-end"><button onclick="triggerPanic()" class="w-16 h-16 bg-red-600 rounded-full font-bold text-white border-4 border-red-800 shadow-lg active:scale-95 transition">SOS</button></div>
    <div>
      <p class="text-gray-500 text-sm uppercase tracking-widest">Currently At</p>
      <h2 id="lockLoc" class="text-3xl font-bold text-white mb-6 mt-1"></h2>
      <div id="timer" class="text-7xl font-bold font-mono text-white tracking-tighter">00:00</div>
      <p class="text-gray-400 mt-2">Due: <span id="lockDue" class="text-blue-400 font-bold"></span></p>
    </div>
    <div class="space-y-3 w-full">
      <button id="btnExtend" class="long-press-btn w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg">Extend 10m</button>
      <button id="btnDepart" class="long-press-btn w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl text-lg shadow-lg">DEPART</button>
      <button id="btnSafe" class="hidden long-press-btn w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg shadow-lg">I AM SAFE</button>
    </div>
  </div>
  <div id="page-settings" class="page h-full flex-col p-6 bg-gray-800">
    <header class="flex justify-between mb-8"><h1 class="text-3xl font-bold text-white">Settings</h1><button onclick="nav('main')" class="text-3xl text-gray-400 hover:text-white">√ó</button></header>
    <div class="space-y-5 flex-1 overflow-y-auto">
      <div><label class="text-xs text-gray-400">Your Name</label><input id="set_name" class="w-full p-4 bg-gray-900 rounded-lg text-white border border-gray-700"></div>
      <div><label class="text-xs text-gray-400">Your Phone</label><input id="set_phone" type="tel" class="w-full p-4 bg-gray-900 rounded-lg text-white border border-gray-700"></div>
      <div><label class="text-xs text-gray-400">Normal PIN (4 digits)</label><input id="set_pin" type="tel" maxlength="4" class="w-full p-4 bg-gray-900 rounded-lg text-white border border-gray-700"></div>
      <div><label class="text-xs text-gray-400">Duress PIN (4 digits)</label><input id="set_duress" type="tel" maxlength="4" class="w-full p-4 bg-gray-900 rounded-lg text-white border border-gray-700"></div>
      <div class="pt-6 border-t border-gray-700"><p class="text-xs text-gray-500 mb-2">System URL</p><input id="set_url" disabled class="w-full p-3 bg-gray-900/50 rounded text-gray-500 text-xs font-mono" value="%%SHEET_URL%%"></div>
      <button onclick="clearData()" class="w-full py-3 bg-red-900/50 text-red-400 rounded text-sm mt-4">Reset App Data</button>
    </div>
    <button onclick="saveSettings()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg shadow-lg mt-4">Save Settings</button>
  </div>
  <div id="modal-report" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4 animate-fade">
    <div class="bg-gray-800 w-full max-w-lg rounded-xl p-6 max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl">
      <h2 class="text-2xl font-bold text-white mb-6" id="reportTitle">Visit Report</h2>
      <div id="reportFields" class="flex-1 overflow-y-auto space-y-5 mb-6 pr-2"></div>
      <div class="flex gap-3"><button onclick="closeReport()" class="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold">Cancel</button><button onclick="submitReport()" id="btnSubmitRep" class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Submit</button></div>
    </div>
  </div>
</div>
<script>
const CONFIG={isAdv:%%IS_ADVANCED%%,mileage:%%ENABLE_MILEAGE%%,url:"%%SHEET_URL%%"};
const STEPS=[0,10,15,20,30,45,60,90,120,180,240,300];
let state={locs:[],active:null,settings:{},queue:[]},timerInt,tempPhoto=null;
window.onload=()=>{
  const s=localStorage.getItem('otg_state_v2');if(s)state={...state,...JSON.parse(s)};
  if(CONFIG.mileage){if(!state.locs.find(l=>l.id==='travel'))state.locs.unshift({id:'travel',name:'Travelling',addr:'GPS Tracking Active',noRep:false});}
  else{state.locs=state.locs.filter(l=>l.id!=='travel');}
  if(CONFIG.isAdv) document.getElementById('btnQuick').classList.remove('hidden');
  if(!state.settings.pin)nav('settings');else if(state.active)startLockScreen();else nav('main');
  renderLocs();processQueue();
};
function nav(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+id).classList.add('active');}
function renderLocs(){
  const list=document.getElementById('locationList');list.innerHTML='';
  state.locs.forEach(l=>{
    const el=document.createElement('div');el.className='p-4 bg-gray-800 rounded-lg border-2 border-transparent hover:border-blue-500 cursor-pointer flex justify-between items-center group transition-all';
    if(state.sel&&state.sel.id===l.id)el.classList.add('border-blue-500','bg-gray-700');
    let html='<div><div class="font-bold text-white text-lg">'+l.name+'</div><div class="text-sm text-gray-400">'+l.addr+'</div></div>';
    if(l.id!=='travel')html+='<button class="text-gray-600 hover:text-red-400 px-3 py-2 text-xl font-bold" onclick="delLoc(\''+l.id+'\',event)">√ó</button>';
    el.innerHTML=html;el.onclick=(e)=>{if(e.target.tagName==='BUTTON')return;state.sel=l;renderLocs();updateDur();};list.appendChild(el);
  });
}
function addLoc(){const n=prompt('Location Name:');if(!n)return;const a=prompt('Address:');state.locs.push({id:Date.now().toString(),name:n,addr:a||''});save();renderLocs();}
function delLoc(id,e){e.stopPropagation();if(confirm('Delete?')){state.locs=state.locs.filter(l=>l.id!==id);save();renderLocs();}}
function updateDur(){
  const idx=document.getElementById('durSlider').value,min=STEPS[idx];
  document.getElementById('durDisplay').innerText=min+' min';
  const btn=document.getElementById('btnStart'),btnQ=document.getElementById('btnQuick');
  if(state.sel){
    if(CONFIG.isAdv&&state.sel.id!=='travel'){btnQ.disabled=false;btnQ.classList.remove('opacity-50','bg-teal-900','text-teal-500');btnQ.classList.add('bg-teal-600','text-white','hover:bg-teal-500');}
    if(min>0){btn.disabled=false;btn.innerText='HOLD TO START';btn.className='long-press-btn flex-[2] py-5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl shadow-lg transition-all';setupLongPress(btn,startVisit);}
    else{btn.disabled=true;btn.innerText='Set Duration';btn.className='long-press-btn flex-[2] py-5 bg-gray-700 text-gray-500 font-bold rounded-xl text-xl transition-all';}
  }else{btn.disabled=true;btn.innerText='Select Location';}
}
function startVisit(){
  const min=STEPS[document.getElementById('durSlider').value];
  state.active={lid:state.sel.id,start:new Date().toISOString(),due:new Date(Date.now()+min*60000).toISOString(),gpsStart:null};
  if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{state.active.gpsStart=p.coords.latitude+','+p.coords.longitude;send('ON SITE','Visit Started');save();},()=>{send('ON SITE','Visit Started (No GPS)');save();});
  else{send('ON SITE','Visit Started (No GPS)');} save(); startLockScreen();
}
function startLockScreen(){
  const l=state.locs.find(x=>x.id===state.active.lid)||{name:'Unknown'};
  document.getElementById('lockLoc').innerText=l.name;nav('locked');
  setupLongPress(document.getElementById('btnDepart'),()=>preDepart(false));setupLongPress(document.getElementById('btnExtend'),extend);
  const ac=document.getElementById('btnSafe'),db=document.getElementById('btnDepart');
  if(timerInt)clearInterval(timerInt);
  timerInt=setInterval(()=>{
    const rem=new Date(state.active.due)-new Date();
    if(rem<0){document.getElementById('timer').innerText='OVERDUE';document.getElementById('timer').classList.replace('text-white','text-red-500');ac.classList.remove('hidden');setupLongPress(ac,()=>iAmSafe());db.classList.add('hidden');}
    else{const m=Math.floor(rem/60000),s=Math.floor((rem%60000)/1000);document.getElementById('timer').innerText=m+':'+(s<10?'0':'')+s;document.getElementById('timer').classList.replace('text-red-500','text-white');document.getElementById('lockDue').innerText=new Date(state.active.due).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});ac.classList.add('hidden');db.classList.remove('hidden');}
  },1000);
}
function extend(){checkPin('normal').then(ok=>{if(ok){state.active.due=new Date(new Date(state.active.due).getTime()+15*60000).toISOString();save();send('EXTENDED','Extended 15m');alert('Extended 15m');}});}
function triggerPanic(){if(confirm('CONFIRM SOS?')){send('EMERGENCY - PANIC BUTTON','Panic Button');alert('PANIC SENT');}}
function iAmSafe(){checkPin('normal').then(ok=>{if(ok){send('SAFE - MANUALLY CLEARED','Safe');preDepart(true);}});}
function quickStat(){
  if(!state.sel)return;
  state.active={lid:state.sel.id,start:new Date().toISOString()};
  const modal=document.getElementById('modal-report'),div=document.getElementById('reportFields');
  div.innerHTML='';modal.classList.remove('hidden');buildStandardReport(div);
  document.getElementById('btnSubmitRep').onclick=()=>{
    let d={notes:document.getElementById('rep_notes').value};
    if(tempPhoto) d.photo1=tempPhoto;
    send('DATA_ENTRY_ONLY',d.notes,d.photo1);state.active=null;tempPhoto=null;modal.classList.add('hidden');
  };
}
function preDepart(safe){checkPin('normal').then(ok=>{if(ok){if(!CONFIG.isAdv){completeDepart({});return;}const modal=document.getElementById('modal-report'),div=document.getElementById('reportFields');div.innerHTML='';modal.classList.remove('hidden');const l=state.locs.find(x=>x.id===state.active.lid);if(l.id==='travel'&&CONFIG.mileage){div.innerHTML='<h3 class="font-bold text-blue-400">Mileage</h3><input id="rep_dist" type="number" class="w-full p-4 bg-gray-900 border border-gray-600 rounded text-white text-xl mt-2">';navigator.geolocation.getCurrentPosition(p=>{if(state.active.gpsStart){const km=calcDist(state.active.gpsStart,p.coords.latitude+','+p.coords.longitude);document.getElementById('rep_dist').value=km;}});}else{buildStandardReport(div);}}});}
function buildStandardReport(div){
  div.innerHTML='<label class="block text-sm text-gray-400">Notes</label><textarea id="rep_notes" class="w-full p-4 bg-gray-900 rounded-lg border border-gray-700 h-32 text-white"></textarea><label class="block text-sm text-gray-400 mt-4">Photo</label><input id="rep_photo" type="file" accept="image/*" class="w-full text-sm text-gray-500 mt-2">';
  setTimeout(()=>{document.getElementById('rep_photo').addEventListener('change',async(e)=>{if(e.target.files[0]){try{tempPhoto=await compressImg(e.target.files[0]);alert('Photo Ready');}catch(e){alert('Error');}}});},100);
}
function closeReport(){document.getElementById('modal-report').classList.add('hidden');}
function submitReport(){const l=state.locs.find(x=>x.id===state.active.lid);let d={};if(l.id==='travel'&&CONFIG.mileage){d.notes='Distance: '+(document.getElementById('rep_dist').value||'0')+' km';}else{d.notes=document.getElementById('rep_notes').value;if(tempPhoto)d.photo1=tempPhoto;}completeDepart(d);closeReport();}
function completeDepart(d){send('DEPARTED',d.notes||'',d.photo1);state.active=null;tempPhoto=null;save();nav('main');}
function checkPin(t){return new Promise(r=>{const p=prompt('Enter PIN:');if(p===state.settings.duressPin&&state.settings.duressPin){send('DURESS_CODE_ACTIVATED','Silent Alarm');alert('Cancelled');r(false);}else if(p===state.settings.pin){r(true);}else{alert('Wrong PIN');r(false);}});}
function setupLongPress(b,c){let t;const s=(e)=>{e.preventDefault();b.classList.add('pressing');t=setTimeout(()=>{c();e()},1500);},e=()=>{clearTimeout(t);b.classList.remove('pressing');};b.onmousedown=b.ontouchstart=s;b.onmouseup=b.ontouchend=b.onmouseleave=e;}
function compressImg(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas'),s=Math.min(1024/i.width,1024/i.height,1);c.width=i.width*s;c.height=i.height*s;c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6));};i.src=e.target.result;};rd.readAsDataURL(f);});}
function calcDist(p1,p2){if(!p1||!p2)return 0;const[y1,x1]=p1.split(',').map(Number),[y2,x2]=p2.split(',').map(Number),R=6371,dLat=(y2-y1)*Math.PI/180,dLon=(x2-x1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(y1*Math.PI/180)*Math.cos(y2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2);}
function send(s,n,p){if(!CONFIG.url)return;const d={'Worker Name':state.settings.name,'Worker Phone':state.settings.phone,'Alarm Status':s,'Notes':n||'','Timestamp':new Date().toISOString()};if(p)d['Photo 1']=p;navigator.geolocation.getCurrentPosition(x=>{d['Last Known GPS']=x.coords.latitude+','+x.coords.longitude;post(d);},()=>{d['Last Known GPS']='GPS Unavailable';post(d);});}
function post(d){if(!navigator.onLine){state.queue.push(d);save();return;}const f=new FormData();for(let k in d)f.append(k,d[k]);fetch(CONFIG.url,{method:'POST',mode:'no-cors',body:f}).catch(()=>{state.queue.push(d);save();});}
function processQueue(){if(navigator.onLine&&state.queue.length>0){document.getElementById('uploadBanner').classList.remove('hidden');const i=state.queue.shift();save();const f=new FormData();for(let k in i)f.append(k,i[k]);fetch(CONFIG.url,{method:'POST',mode:'no-cors',body:f}).then(()=>processQueue()).catch(()=>{state.queue.push(i);save();});}else{document.getElementById('uploadBanner').classList.add('hidden');}}
function save(){localStorage.setItem('otg_state_v2',JSON.stringify(state));}
function saveSettings(){state.settings={name:document.getElementById('set_name').value,phone:document.getElementById('set_phone').value,pin:document.getElementById('set_pin').value,duressPin:document.getElementById('set_duress').value};save();nav('main');}
function clearData(){if(confirm('Reset all data?')){localStorage.clear();location.reload();}}
</script></body></html>
</script>

<script id="tpl-backend" type="text/plain">
[cite: 1267, 1301] /* OTG BACKEND V2 */
const CONFIG={SECRET:"%%SECRET_KEY%%",ORS:"%%ORS_API_KEY%%",GEMINI:"%%GEMINI_API_KEY%%"};
function doPost(e){
  const lock=LockService.getScriptLock(); lock.tryLock(10000);
  try{
    const p=e.parameter; const ss=SpreadsheetApp.getActiveSpreadsheet(); const sh=ss.getSheetByName('Visits')||ss.insertSheet('Visits');
    if(sh.getLastColumn()===0) sh.appendRow(["Timestamp","Date","Worker Name","Worker Phone","Alarm Status","Notes","Location Name","Last Known GPS","Photo 1","Distance"]);
    let photoUrl="";
    if(p['Photo 1'] && p['Photo 1'].includes('base64')){
      // In this unified version, we create a folder if needed or save to root if advanced logic isn't fully configured
      // For simplicity in this factory, we skip complex folder creation logic to ensure it works for novices 
      // Images will save to the script owner's root drive or a specific folder if you edit this line ID manually later.
      try{
        const data=Utilities.base64Decode(p['Photo 1'].split(',')[1]);
        const blob=Utilities.newBlob(data,'image/jpeg',p['Worker Name']+'_'+Date.now()+'.jpg');
        photoUrl=DriveApp.createFile(blob).getUrl(); 
      }catch(e){photoUrl="Err:"+e.toString();}
    }
    sh.appendRow([new Date(),Utilities.formatDate(new Date(),Session.getScriptTimeZone(),"yyyy-MM-dd"),p['Worker Name'],p['Worker Phone'],p['Alarm Status'],p['Notes'],p['Location Name']||'',p['Last Known GPS'],photoUrl,p['Distance']||'']);
    if(p['Alarm Status'].match(/EMERGENCY|DURESS|MISSED/)) MailApp.sendEmail(Session.getEffectiveUser().getEmail(),"üö® OTG ALERT: "+p['Worker Name'],"Status: "+p['Alarm Status']+"\nGPS: "+p['Last Known GPS']);
    return ContentService.createTextOutput("OK");
  }catch(e){return ContentService.createTextOutput("Error");}finally{lock.releaseLock();}
}
function doGet(e){return ContentService.createTextOutput("OTG Online");}
</script>

<script>
  // --- FACTORY LOGIC ---
  let logoData = "https://i.postimg.cc/dVmVg3Pn/favicon-logo-for-LWSApp.png"; // Default

  function gotoStep(n) {
    document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
    document.getElementById('step'+n).classList.add('active');
    [1,2,3,4].forEach(i => {
      document.getElementById('tab'+i).className = (i === n) 
        ? "flex-1 py-4 font-bold text-blue-400 border-b-4 border-blue-500 bg-gray-800" 
        : "flex-1 py-4 font-bold text-gray-500 hover:text-gray-300";
    });
  }

  function toggleAdv() {
    const isAdv = document.getElementById('chkAdvanced').checked;
    document.getElementById('advOptions').style.display = isAdv ? "block" : "none";
    document.getElementById('boxChecklists').style.display = isAdv ? "block" : "none";
  }

  function handleLogo(input) {
    const file = input.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        logoData = e.target.result;
        document.getElementById('logoImg').src = logoData;
        document.getElementById('logoImg').classList.remove('hidden');
        document.getElementById('logoPreviewArea').classList.add('border-blue-500');
      };
      reader.readAsDataURL(file);
    }
  }

  function copyVisitsHeaders() {
    const isAdv = document.getElementById('chkAdvanced').checked;
    const basic = "Timestamp\tDate\tWorker Name\tWorker Phone\tAlarm Status\tNotes\tLocation Name\tLast Known GPS";
    const adv = "\tPhoto 1\tDistance";
    navigator.clipboard.writeText(basic + (isAdv ? adv : ""));
    alert("Headers copied! Paste into cell A1 of 'Visits' tab.");
  }

  function copyChecklistSetup() {
    const text = "Company Name\tTemplate Name\tQuestion 1\tQuestion 2\tQuestion 3\n(Standard)\t\tSafety Check Done?\tHazards Identified?\tNotes";
    navigator.clipboard.writeText(text);
    alert("Setup row copied! Paste into cell A1 of 'Checklists' tab.");
  }

  function generateScript() {
    const secret = document.getElementById('secretKey').value;
    const ors = document.getElementById('orsKey').value;
    const gemini = document.getElementById('geminiKey').value;
    
    let code = document.getElementById('tpl-backend').innerHTML
      .replace('%%SECRET_KEY%%', secret)
      .replace('%%ORS_API_KEY%%', ors)
      .replace('%%GEMINI_API_KEY%%', gemini);
      
    document.getElementById('codeDisplay').textContent = code.trim();
    gotoStep(3);
  }

  function copyScript() {
    navigator.clipboard.writeText(document.getElementById('codeDisplay').textContent);
    alert("Script copied!");
  }

  function validateUrl() {
    const url = document.getElementById('webAppUrl').value;
    if(!url.includes('/exec')) { alert("Invalid URL. It must end in /exec"); return; }
    document.getElementById('finalAppName').innerText = document.getElementById('orgName').value + " Safety";
    gotoStep(4);
  }

  function downloadZip() {
    const zip = new JSZip();
    const org = document.getElementById('orgName').value;
    const url = document.getElementById('webAppUrl').value;
    const isAdv = document.getElementById('chkAdvanced').checked;
    const mile = document.getElementById('chkMileage').checked;

    // 1. WORKER APP
    let workerHtml = document.getElementById('tpl-worker').innerHTML;
    workerHtml = workerHtml
      .replace(/%%ORG_NAME%%/g, org)
      .replace(/%%SHEET_URL%%/g, url)
      .replace(/%%LOGO_DATA%%/g, logoData)
      .replace('%%IS_ADVANCED%%', isAdv)
      .replace('%%ENABLE_MILEAGE%%', (isAdv && mile));

    const wFolder = zip.folder("WorkerApp");
    wFolder.file("index.html", workerHtml);
    wFolder.file("manifest.json", JSON.stringify({
      name: org + " Safety",
      short_name: "Safety",
      start_url: "./index.html",
      display: "standalone",
      background_color: "#111827",
      theme_color: "#1e40af",
      icons: [{ src: logoData, sizes: "192x192", type: "image/png" }]
    }, null, 2));
    
    // Service Worker (Critical for PWA)
    wFolder.file("sw.js", `
      const CACHE_NAME = 'otg-v2';
      self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(['./index.html']))));
      self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
    `);

    // 2. MONITOR APP (Basic Stub - can be expanded)
    const mFolder = zip.folder("MonitorApp");
    mFolder.file("index.html", `<!DOCTYPE html><html><body style="background:#111;color:#fff;text-align:center;padding:50px;font-family:sans-serif"><h1>${org} Monitor</h1><p>Active monitoring dashboard.</p></body></html>`);

    // 3. EXTRAS
    zip.file("Backend_Script_Backup.js", document.getElementById('codeDisplay').textContent);

    zip.generateAsync({type:"blob"}).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = org.replace(/[^a-z0-9]/gi, '_') + "_AppSuite.zip";
      a.click();
    });
  }
</script>
</body>
</html>
